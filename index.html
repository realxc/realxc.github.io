<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"realxc.githut.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"搜索文章","hits_empty":"未找到相关文章: ${query}","hits_stats":"找到${hits}篇文章，用时${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="博客园-向闯">
<meta property="og:url" content="http://realxc.githut.io/index.html">
<meta property="og:site_name" content="博客园-向闯">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Xiang Chuang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://realxc.githut.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>博客园-向闯</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">博客园-向闯</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2021/09/28/hexo%E8%BF%81%E7%A7%BB%EF%BC%88%E5%8D%87%E7%BA%A7%EF%BC%89%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/28/hexo%E8%BF%81%E7%A7%BB%EF%BC%88%E5%8D%87%E7%BA%A7%EF%BC%89%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">hexo迁移（升级）常见问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-28 11:49:00 / 修改时间：12:06:42" itemprop="dateCreated datePublished" datetime="2021-09-28T11:49:00+08:00">2021-09-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo%E5%AE%89%E8%A3%85/" itemprop="url" rel="index"><span itemprop="name">hexo安装</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>244</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>hexo迁移或升级遇到的问题</p>
<p>hexo的使用问题常见于版本不兼容导致，因此，可从hexo、npm、node版本是否匹配入手分析</p>
<p>1、hexo deploy时，The “mode“ argument must be integer. Received an instance of Object<br>排查步骤参考：<br>a、hexo -v 查看hexo相关依赖的版本</p>
<p><img src="/images/pasted-107.png" alt="upload successful"><br>根据当前hexo及node版本在hexo官网核对版本是否匹配</p>
<p>hexo的升级<br>npm uninstall hexo先卸载当前版本<br>npm install hexo@</p>
<p>node版本更换</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2020/07/21/rocketmq%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/21/rocketmq%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">rocketmq异常分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-07-21 20:32:13 / 修改时间：20:43:44" itemprop="dateCreated datePublished" datetime="2020-07-21T20:32:13+08:00">2020-07-21</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>552</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>1、背景<br>公司系统中，业务系统与中台系统基于rocketmq进行异步事件交互，基本信息如下：<br>分组信息，公司rocketmq组件直接使用系统名及环境变量作为groupName<br>topic信息，目前存在两个topic，XXX及YYY<br>tag信息，每个topic存在多个tag<br>2、问题现象<br>在开发环境测试时（单机），一切运行正常，能收到mq消息<br>将分支发布到测试服务器后，出现了部分消息收不到<br>通过console查询到部分消息trackType如下<br><img src="/images/pasted-105.png" alt="upload successful"><br>说明分组A下确实存在未消费的消息<br>3、问题排查<br>通过查询rocket日志发现，默认日志路径为${user.home}/logs/rocketmqlogs/rocketmq_client.log</p>
<p><img src="/images/pasted-106.png" alt="upload successful"><br>发现该错误，疑似说明消费者没有消费指定的topic</p>
<p>后继续查询console发现同一分组存在两个两个消费者（应用系统两个分支、相同环境变量分别发布在两个服务器），由此分析到，另一个分支中并未消费相应的topic<br>4、结论<br>rocketmq按照分组划分消费者，同一分组会根据负载均衡策略消费不同broker分片的消息，如果同一分组下的消费者订阅的topic不一致，将导致部分分片下的消息无法被消费。问题规避，保证同一分组下消费者订阅的topic一致，理论上在测试环境多分支并行开发时易出现该问题</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2020/01/10/%E5%89%A5%E5%BC%80%E6%BA%90%E7%A0%81%E7%9C%8Bjava/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/10/%E5%89%A5%E5%BC%80%E6%BA%90%E7%A0%81%E7%9C%8Bjava/" class="post-title-link" itemprop="url">剥开源码看java-线程池ThreadPoolExecutor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-01-10 10:30:00 / 修改时间：16:37:23" itemprop="dateCreated datePublished" datetime="2020-01-10T10:30:00+08:00">2020-01-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BD%A0%E5%A5%BD%EF%BC%8C%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">你好，源码</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文从spring对于线程池的实现ThreadPoolTaskExecutor入手阐述，由于该实现是对java的ThreadPoolExecutor进行了一次包装（扩展线程池能力），因此文中更多涉及到的是ThreadPoolExecutor关键实现逻辑的原理分析<br><img src="/images/pasted-99.png" alt="upload successful"></p>
<p><img src="/images/pasted-103.png" alt="upload successful"><br>1、executor = new ThreadPoolTaskExecutor();主要操作：父类CustomizableThreadCreator构造函数初始化，默认threadNamePrefix为实现类名简称-<br>2、excutor参数设置并excutor.initialize();（该方法属于ExecutorConfigurationSupport），其中会调用抽象方法initializeExecutor，由ThreadPoolTaskExecutor实现。<br>该处除了下面要讨论的corePoolSize，maxPollSize，queueCapacity外，想先说一下keepAliveSeconds这个值，代表允许操作核心线程数部分的线程空闲多长时间（s）后shut down，如果初始化时设置了allowCoreThreadTimeOut（true），那么对核心线程数以内的空闲线程也会shut down，避免资源浪费。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	protected ExecutorService initializeExecutor(</span><br><span class="line">			ThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) &#123;</span><br><span class="line">		//1、创建队列：最大容量&gt;0，创建有界阻塞队列LinkedBlockingQueue；否则创建SynchronousQueue，其内部只有包含一个元素，因此，需要线程池足够大，否则，会出现大量拒绝</span><br><span class="line">		BlockingQueue&lt;Runnable&gt; queue = createQueue(this.queueCapacity);</span><br><span class="line"></span><br><span class="line">		ThreadPoolExecutor executor;</span><br><span class="line">		if (this.taskDecorator != null) &#123;</span><br><span class="line">			executor = new ThreadPoolExecutor(</span><br><span class="line">					this.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,</span><br><span class="line">					queue, threadFactory, rejectedExecutionHandler) &#123;</span><br><span class="line">				@Override</span><br><span class="line">				public void execute(Runnable command) &#123;</span><br><span class="line">					super.execute(taskDecorator.decorate(command));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			executor = new ThreadPoolExecutor(</span><br><span class="line">					this.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,</span><br><span class="line">					queue, threadFactory, rejectedExecutionHandler);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (this.allowCoreThreadTimeOut) &#123;</span><br><span class="line">			executor.allowCoreThreadTimeOut(true);</span><br><span class="line">		&#125;</span><br><span class="line">		//2、创建java线程池ThreadPoolExcutor，即，ThreadPoolTaskExetor是对java线程池的包装</span><br><span class="line">		this.threadPoolExecutor = executor;</span><br><span class="line">		return executor;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure><br>3、executor.execute(runnable);<br>通过源码分析，线程池中线程的初始化是在执行阶段根据实际情况初始化的，如果活跃线程小于核心线程则新开线程(及时由线程是空闲的)，否则尝试将任务压入队列等待执行，如果队列压满则尝试根据最大线程数控制来新开线程（小于最大线程数时可新开线程）。java也提供了预分配核心线程的方法，支持提前创建核心线程，prestartCoreThread。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public void execute(Runnable command) &#123;</span><br><span class="line">if (command == null)</span><br><span class="line">            throw new NullPointerException();</span><br><span class="line">        /*</span><br><span class="line">         * Proceed in 3 steps:</span><br><span class="line">         *</span><br><span class="line">         * 1. If fewer than corePoolSize threads are running, try to</span><br><span class="line">         * start a new thread with the given command as its first</span><br><span class="line">         * task.  The call to addWorker atomically checks runState and</span><br><span class="line">         * workerCount, and so prevents false alarms that would add</span><br><span class="line">         * threads when it shouldn&#x27;t, by returning false.</span><br><span class="line">         *</span><br><span class="line">         * 2. If a task can be successfully queued, then we still need</span><br><span class="line">         * to double-check whether we should have added a thread</span><br><span class="line">         * (because existing ones died since last checking) or that</span><br><span class="line">         * the pool shut down since entry into this method. So we</span><br><span class="line">         * recheck state and if necessary roll back the enqueuing if</span><br><span class="line">         * stopped, or start a new thread if there are none.</span><br><span class="line">         *</span><br><span class="line">         * 3. If we cannot queue task, then we try to add a new</span><br><span class="line">         * thread.  If it fails, we know we are shut down or saturated</span><br><span class="line">         * and so reject the task.</span><br><span class="line">         */</span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        if (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">            if (addWorker(command, true))</span><br><span class="line">                return;//1、如果work数量小于核心线程大小，则新增work并把该任务委派给此work</span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">        //2、如果work数量大于等于核心线程大小，同时活动中的线程小于被shutdown的线程（代表相对空闲），同时队列未满，则把该任务压入队列中</span><br><span class="line">        if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            int recheck = ctl.get();</span><br><span class="line">            if (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                reject(command);</span><br><span class="line">            else if (workerCountOf(recheck) == 0)</span><br><span class="line">                addWorker(null, false);</span><br><span class="line">        &#125;</span><br><span class="line">        //3、如果活动中的线程大于被shutdown的线程（代表相对繁忙）或者队列已满，则新增work并把该任务委派给此work，数量受maxPoolSize控制</span><br><span class="line">        else if (!addWorker(command, false))</span><br><span class="line">            reject(command);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><br> addWorker(Runnable firstTask, boolean core){};<br> 该方法用于创建work并执行初始化任务或者队列中的任务。<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line">private boolean addWorker(Runnable firstTask, boolean core) &#123;</span><br><span class="line">       retry:</span><br><span class="line">       for (;;) &#123;</span><br><span class="line">           int c = ctl.get();</span><br><span class="line">           int rs = runStateOf(c);//</span><br><span class="line"></span><br><span class="line">           // Check if queue empty only if necessary.</span><br><span class="line">           if (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">               ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">                  firstTask == null &amp;&amp;</span><br><span class="line">                  ! workQueue.isEmpty()))</span><br><span class="line">               return false;</span><br><span class="line"></span><br><span class="line">           for (;;) &#123;</span><br><span class="line">               int wc = workerCountOf(c);</span><br><span class="line">               if (wc &gt;= CAPACITY ||</span><br><span class="line">                   wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                   return false;</span><br><span class="line">               if (compareAndIncrementWorkerCount(c))</span><br><span class="line">                   break retry;</span><br><span class="line">               c = ctl.get();  // Re-read ctl</span><br><span class="line">               if (runStateOf(c) != rs)</span><br><span class="line">                   continue retry;</span><br><span class="line">               // else CAS failed due to workerCount change; retry inner loop</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       boolean workerStarted = false;</span><br><span class="line">       boolean workerAdded = false;</span><br><span class="line">       Worker w = null;</span><br><span class="line">       try &#123;</span><br><span class="line">           w = new Worker(firstTask);</span><br><span class="line">           final Thread t = w.thread;</span><br><span class="line">           if (t != null) &#123;</span><br><span class="line">               final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">               mainLock.lock();</span><br><span class="line">               try &#123;</span><br><span class="line">                   // Recheck while holding lock.</span><br><span class="line">                   // Back out on ThreadFactory failure or if</span><br><span class="line">                   // shut down before lock acquired.</span><br><span class="line">                   int rs = runStateOf(ctl.get());</span><br><span class="line"></span><br><span class="line">                   if (rs &lt; SHUTDOWN ||</span><br><span class="line">                       (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123;</span><br><span class="line">                       if (t.isAlive()) // precheck that t is startable</span><br><span class="line">                           throw new IllegalThreadStateException();</span><br><span class="line">                       workers.add(w);</span><br><span class="line">                       int s = workers.size();</span><br><span class="line">                       if (s &gt; largestPoolSize)</span><br><span class="line">                           largestPoolSize = s;</span><br><span class="line">                       workerAdded = true;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; finally &#123;</span><br><span class="line">                   mainLock.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">               if (workerAdded) &#123;</span><br><span class="line">               //使用新建的work执行任务</span><br><span class="line">                   t.start();</span><br><span class="line">                   workerStarted = true;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           if (! workerStarted)</span><br><span class="line">               addWorkerFailed(w);</span><br><span class="line">       &#125;</span><br><span class="line">       return workerStarted;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   final void runWorker(Worker w) &#123;</span><br><span class="line">       Thread wt = Thread.currentThread();</span><br><span class="line">       Runnable task = w.firstTask;</span><br><span class="line">       w.firstTask = null;</span><br><span class="line">       w.unlock(); // allow interrupts</span><br><span class="line">       boolean completedAbruptly = true;</span><br><span class="line">       try &#123;</span><br><span class="line">       //执行当前任务或者从队列中获取任务执行</span><br><span class="line">           while (task != null || (task = getTask()) != null) &#123;</span><br><span class="line">               w.lock();</span><br><span class="line">               // If pool is stopping, ensure thread is interrupted;</span><br><span class="line">               // if not, ensure thread is not interrupted.  This</span><br><span class="line">               // requires a recheck in second case to deal with</span><br><span class="line">               // shutdownNow race while clearing interrupt</span><br><span class="line">               if ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                    (Thread.interrupted() &amp;&amp;</span><br><span class="line">                     runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                   !wt.isInterrupted())</span><br><span class="line">                   wt.interrupt();</span><br><span class="line">               try &#123;</span><br><span class="line">                   beforeExecute(wt, task);</span><br><span class="line">                   Throwable thrown = null;</span><br><span class="line">                   try &#123;</span><br><span class="line">                       task.run();</span><br><span class="line">                   &#125; catch (RuntimeException x) &#123;</span><br><span class="line">                       thrown = x; throw x;</span><br><span class="line">                   &#125; catch (Error x) &#123;</span><br><span class="line">                       thrown = x; throw x;</span><br><span class="line">                   &#125; catch (Throwable x) &#123;</span><br><span class="line">                       thrown = x; throw new Error(x);</span><br><span class="line">                   &#125; finally &#123;</span><br><span class="line">                       afterExecute(task, thrown);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; finally &#123;</span><br><span class="line">                   task = null;</span><br><span class="line">                   w.completedTasks++;</span><br><span class="line">                   w.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           completedAbruptly = false;</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           processWorkerExit(w, completedAbruptly);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   /**</span><br><span class="line">    * Performs blocking or timed wait for a task, depending on</span><br><span class="line">    * current configuration settings, or returns null if this worker</span><br><span class="line">    * must exit because of any of:</span><br><span class="line">    * 1. There are more than maximumPoolSize workers (due to</span><br><span class="line">    *    a call to setMaximumPoolSize).</span><br><span class="line">    * 2. The pool is stopped.</span><br><span class="line">    * 3. The pool is shutdown and the queue is empty.</span><br><span class="line">    * 4. This worker timed out waiting for a task, and timed-out</span><br><span class="line">    *    workers are subject to termination (that is,</span><br><span class="line">    *    &#123;@code allowCoreThreadTimeOut || workerCount &gt; corePoolSize&#125;)</span><br><span class="line">    *    both before and after the timed wait, and if the queue is</span><br><span class="line">    *    non-empty, this worker is not the last thread in the pool.</span><br><span class="line">    *</span><br><span class="line">    * @return task, or null if the worker must exit, in which case</span><br><span class="line">    *         workerCount is decremented</span><br><span class="line">    */</span><br><span class="line">   private Runnable getTask() &#123;</span><br><span class="line">       boolean timedOut = false; // Did the last poll() time out?</span><br><span class="line"></span><br><span class="line">       for (;;) &#123;</span><br><span class="line">           int c = ctl.get();</span><br><span class="line">           int rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">           // Check if queue empty only if necessary.</span><br><span class="line">           if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">               decrementWorkerCount();</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           int wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">           // Are workers subject to culling?</span><br><span class="line">           boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">           if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">               &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123;</span><br><span class="line">               if (compareAndDecrementWorkerCount(c))</span><br><span class="line">                   return null;</span><br><span class="line">               continue;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           try &#123;</span><br><span class="line">           //poll()为非阻塞方法,如果当前队列为空,超时候，直接返回，超时返回时，返回的为null，此时会在runWorker后续方法中调用processWorkerExit，从而实现了对超过数量（大于核心线程，或者允许核心线程超时后回收）的线程超时后回收</span><br><span class="line">           //take()为阻塞方法,如果当前队列为空,则阻塞线程,封装线程到AQS的条件变量的条件队列中</span><br><span class="line">               Runnable r = timed ?</span><br><span class="line">                   workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                   workQueue.take();</span><br><span class="line">               if (r != null)</span><br><span class="line">                   return r;</span><br><span class="line">               timedOut = true;</span><br><span class="line">           &#125; catch (InterruptedException retry) &#123;</span><br><span class="line">               timedOut = false;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   private void processWorkerExit(Worker w, boolean completedAbruptly) &#123;</span><br><span class="line">       if (completedAbruptly) // If abrupt, then workerCount wasn&#x27;t adjusted</span><br><span class="line">           decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">       final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       try &#123;</span><br><span class="line">           completedTaskCount += w.completedTasks;</span><br><span class="line">           //当前任务及队列中的任务执行完成后，移除当前work</span><br><span class="line">           workers.remove(w);</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       tryTerminate();</span><br><span class="line"></span><br><span class="line">       int c = ctl.get();</span><br><span class="line">       if (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">           if (!completedAbruptly) &#123;</span><br><span class="line">               int min = allowCoreThreadTimeOut ? 0 : corePoolSize;</span><br><span class="line">               if (min == 0 &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                   min = 1;</span><br><span class="line">               if (workerCountOf(c) &gt;= min)</span><br><span class="line">                   return; // replacement not needed</span><br><span class="line">           &#125;</span><br><span class="line">           //如果剩余wrok数量小于核心线程大小（注意，如果设置了allowCoreThreadTimeOut，那么线程池不会保持最低核心线程数个线程），新建work</span><br><span class="line">           addWorker(null, false);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   /**</span><br><span class="line">    * Transitions to TERMINATED state if either (SHUTDOWN and pool</span><br><span class="line">    * and queue empty) or (STOP and pool empty).  If otherwise</span><br><span class="line">    * eligible to terminate but workerCount is nonzero, interrupts an</span><br><span class="line">    * idle worker to ensure that shutdown signals propagate. This</span><br><span class="line">    * method must be called following any action that might make</span><br><span class="line">    * termination possible -- reducing worker count or removing tasks</span><br><span class="line">    * from the queue during shutdown. The method is non-private to</span><br><span class="line">    * allow access from ScheduledThreadPoolExecutor.</span><br><span class="line">    */</span><br><span class="line">   final void tryTerminate() &#123;</span><br><span class="line">       for (;;) &#123;</span><br><span class="line">           int c = ctl.get();</span><br><span class="line">           if (isRunning(c) ||</span><br><span class="line">               runStateAtLeast(c, TIDYING) ||</span><br><span class="line">               (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">               return;</span><br><span class="line">           if (workerCountOf(c) != 0) &#123; // Eligible to terminate</span><br><span class="line">               interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">           mainLock.lock();</span><br><span class="line">           try &#123;</span><br><span class="line">               if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123;</span><br><span class="line">                   try &#123;</span><br><span class="line">                       terminated();</span><br><span class="line">                   &#125; finally &#123;</span><br><span class="line">                       ctl.set(ctlOf(TERMINATED, 0));</span><br><span class="line">                       termination.signalAll();</span><br><span class="line">                   &#125;</span><br><span class="line">                   return;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               mainLock.unlock();</span><br><span class="line">           &#125;</span><br><span class="line">           // else retry on failed CAS</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   /**</span><br><span class="line">    * Interrupts threads that might be waiting for tasks (as</span><br><span class="line">    * indicated by not being locked) so they can check for</span><br><span class="line">    * termination or configuration changes. Ignores</span><br><span class="line">    * SecurityExceptions (in which case some threads may remain</span><br><span class="line">    * uninterrupted).</span><br><span class="line">    *</span><br><span class="line">    * @param onlyOne If true, interrupt at most one worker. This is</span><br><span class="line">    * called only from tryTerminate when termination is otherwise</span><br><span class="line">    * enabled but there are still other workers.  In this case, at</span><br><span class="line">    * most one waiting worker is interrupted to propagate shutdown</span><br><span class="line">    * signals in case all threads are currently waiting.</span><br><span class="line">    * Interrupting any arbitrary thread ensures that newly arriving</span><br><span class="line">    * workers since shutdown began will also eventually exit.</span><br><span class="line">    * To guarantee eventual termination, it suffices to always</span><br><span class="line">    * interrupt only one idle worker, but shutdown() interrupts all</span><br><span class="line">    * idle workers so that redundant workers exit promptly, not</span><br><span class="line">    * waiting for a straggler task to finish.</span><br><span class="line">    */</span><br><span class="line">   private void interruptIdleWorkers(boolean onlyOne) &#123;</span><br><span class="line">       final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       try &#123;</span><br><span class="line">           for (Worker w : workers) &#123;</span><br><span class="line">               Thread t = w.thread;</span><br><span class="line">               //中断所有空闲线程，由于在runWorker中，活跃线程上锁了w.lock();，因此此处实现了只会终止空闲线程的效果</span><br><span class="line">               if (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                   try &#123;</span><br><span class="line">                       t.interrupt();</span><br><span class="line">                   &#125; catch (SecurityException ignore) &#123;</span><br><span class="line">                   &#125; finally &#123;</span><br><span class="line">                       w.unlock();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               if (onlyOne)</span><br><span class="line">                   break;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><br> 4、动态调整线程池大小，由于业务需要，很多场景下，需要在运行时动态调整核心线程或最大线程的大小<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Sets the core number of threads.  This overrides any value set</span><br><span class="line">    * in the constructor.  If the new value is smaller than the</span><br><span class="line">    * current value, excess existing threads will be terminated when</span><br><span class="line">    * they next become idle.  If larger, new threads will, if needed,</span><br><span class="line">    * be started to execute any queued tasks.</span><br><span class="line">    *</span><br><span class="line">    * @param corePoolSize the new core size</span><br><span class="line">    * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125;</span><br><span class="line">    * @see #getCorePoolSize</span><br><span class="line">    */</span><br><span class="line">   public void setCorePoolSize(int corePoolSize) &#123;</span><br><span class="line">       if (corePoolSize &lt; 0)</span><br><span class="line">           throw new IllegalArgumentException();</span><br><span class="line">       int delta = corePoolSize - this.corePoolSize;</span><br><span class="line">       this.corePoolSize = corePoolSize;</span><br><span class="line">       if (workerCountOf(ctl.get()) &gt; corePoolSize)</span><br><span class="line">       //中断所有空闲线程，由于在runWorker中，活跃线程上锁了，因此此处实现了只会终止空闲线程的效果</span><br><span class="line">           interruptIdleWorkers();</span><br><span class="line">       else if (delta &gt; 0) &#123;</span><br><span class="line">           // We don&#x27;t really know how many new threads are &quot;needed&quot;.</span><br><span class="line">           // As a heuristic, prestart enough new workers (up to new</span><br><span class="line">           // core size) to handle the current number of tasks in</span><br><span class="line">           // queue, but stop if queue becomes empty while doing so.</span><br><span class="line">           int k = Math.min(delta, workQueue.size());</span><br><span class="line">           while (k-- &gt; 0 &amp;&amp; addWorker(null, true)) &#123;</span><br><span class="line">               if (workQueue.isEmpty())</span><br><span class="line">                   break;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/11/25/grafana%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/25/grafana%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">grafana安装及使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-11-25 15:57:00 / 修改时间：16:18:20" itemprop="dateCreated datePublished" datetime="2019-11-25T15:57:00+08:00">2019-11-25</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>1、官网下载地址：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/download">https://grafana.com/grafana/download</a></p>
<p> centos：wget <a target="_blank" rel="noopener" href="https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm">https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm</a><br>sudo yum localinstall grafana-6.4.4-1.x86_64.rpm </p>
<p>mac：brew update<br>brew install grafana</p>
<p>2、新增用户<br>    grafana注册用户需要采用邮件服务器进行激活，如果没有邮件服务器，可更改数据库，直接新增用户，步骤如下：<br>    1、 ps -ef | grep grafana 找到数据库地址<br>    2、cfg:default.paths.data=数据库地址<br>    3、cd 数据库地址<br>    4、sqlite3 grafana.db<br>    5、select <em> from user;<br>    6、sqlite&gt; select </em> from  sqlite_master where type=”table” and name = “user”<br>   …&gt; ;<br>table|user|user|6|CREATE TABLE <code>user</code> (<br><code>id</code> INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL<br>, <code>version</code> INTEGER NOT NULL<br>, <code>login</code> TEXT NOT NULL<br>, <code>email</code> TEXT NOT NULL<br>, <code>name</code> TEXT NULL<br>, <code>password</code> TEXT NULL<br>, <code>salt</code> TEXT NULL<br>, <code>rands</code> TEXT NULL<br>, <code>company</code> TEXT NULL<br>, <code>org_id</code> INTEGER NOT NULL<br>, <code>is_admin</code> INTEGER NOT NULL<br>, <code>email_verified</code> INTEGER NULL<br>, <code>theme</code> TEXT NULL<br>, <code>created</code> DATETIME NOT NULL<br>, <code>updated</code> DATETIME NOT NULL<br>    7、复制admin用户的相关信息（login，email等），将权限is_admin改为0<br>    eg： insert into user values(2,0,’tech’,‘technology@XXXX’,’tech’,’59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6’,’F3FAxVm33R’,null,null,1,0,0,null,’2019-11-06 07:12:14’,’2019-11-06 07:12:14’,0,null,0); –此密码为admin<br>    8、访问ip:3000，使用7设置的用户名和管理员admin的密码登录，此时弹出对话框要求重置密码，进行新账户密码重置，此时该账户没有dashbord查询权限<br>    9、使用admin管理员登录，<br>    invite your team<br><img src="\images\pasted-95.png" alt="upload successful"><br>invite</p>
<p><img src="\images\pasted-96.png" alt="upload successful"></p>
<p><img src="\images\pasted-97.png" alt="upload successful"></p>
<p><img src="\images\pasted-98.png" alt="upload successful"><br>10、重新使用新账户登录即可看到dashbord</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/07/11/mysql%E6%95%B0%E6%8D%AE%E5%BA%93wait-timeout%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/11/mysql%E6%95%B0%E6%8D%AE%E5%BA%93wait-timeout%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">mysql数据库wait_timeout问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-11 14:59:00" itemprop="dateCreated datePublished" datetime="2019-07-11T14:59:00+08:00">2019-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%99%E4%BA%9B%E5%B9%B4%EF%BC%8C%E9%82%A3%E4%BA%9B%E5%9D%91/" itemprop="url" rel="index"><span itemprop="name">这些年，那些坑</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>背景：近日与猪方合作一项目，项目交付后，对方反馈测试环境老是出现数据库异常（下面给出堆栈日志），并且对方的其他应用没有问题。但交付前，此项目在我们的环境（代码、数据库等都是我们的）中测试并无问题。</p>
<p>问题现象：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure</span><br><span class="line"></span><br><span class="line">The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag</span><br><span class="line">o.</span><br><span class="line">        at sun.reflect.GeneratedConstructorAccessor47.newInstance(Unknown Source)</span><br><span class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">        at com.mysql.jdbc.Util.handleNewInstance(Util.java:404)</span><br><span class="line">        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:981)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3465)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3365)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3805)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2478)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2625)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2547)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:4874)</span><br><span class="line">        at com.alibaba.druid.pool.DruidPooledConnection.setAutoCommit(DruidPooledConnection.java:712)</span><br><span class="line">        at org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(DataSourceTransactionManager.java:225)</span><br><span class="line">        ... 45 common frames omitted</span><br><span class="line">Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2957)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3375)</span><br><span class="line">        ... 53 common frames omitted</span><br><span class="line">2019-07-11 13:41:00.311 [TxId:test_1562754979799^1562754982427^117,SpanId:2404734433174193776] [INFO ] c.z.c.p.b.a.i.w.WithdrawTransImpl:116 - 查询交易结</span><br><span class="line">束TradeQueryResult [sucAmount=0, transDate=null]</span><br><span class="line">2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:52 - realtime monitor request end, api server return message : LOOP</span><br><span class="line">2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:49 - realtime monitor request begin, url -&gt; http://api.config.zhubajie</span><br><span class="line">.la/realtime/pull</span><br><span class="line">2019-07-11 13:44:00.415 [TxId:192.168.25.11.1015^1561538402946^21456,Span</span><br></pre></td></tr></table></figure><br>看到这段日志，我注意到“Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag<br>o.”， 56397毫秒，这个数字很扎眼！！！ 因为我们使用的druid连接池，最小生存时间和需要关闭的空闲连接时间都是60s，说明了一个问题，所拿到的连接未超过60s，所以仍在连接池中，但是该连接貌似是失效了。分析到这儿，我猜测猪方mysql数据库的wait_timeout估计是进行了修改且小于56.397秒（默认是8小时，我们工时使用默认值），于是来到猪方的数据库，<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">show global variables like &#x27;%timeout&#x27;;</span><br><span class="line">connect_timeout	10</span><br><span class="line">delayed_insert_timeout	300</span><br><span class="line">have_statement_timeout	YES</span><br><span class="line">innodb_flush_log_at_timeout	1</span><br><span class="line">innodb_lock_wait_timeout	120</span><br><span class="line">innodb_rollback_on_timeout	OFF</span><br><span class="line">interactive_timeout	30</span><br><span class="line">lock_wait_timeout	31536000</span><br><span class="line">net_read_timeout	5</span><br><span class="line">net_write_timeout	5</span><br><span class="line">rpl_semi_sync_master_timeout	10000</span><br><span class="line">rpl_stop_slave_timeout	31536000</span><br><span class="line">slave_net_timeout	60</span><br><span class="line">thread_pool_idle_timeout	60</span><br><span class="line">tokudb_last_lock_timeout	</span><br><span class="line">tokudb_lock_timeout	4000</span><br><span class="line">wait_timeout	30</span><br></pre></td></tr></table></figure><br>好吧，猜想正确，他们讲wait_timeout设置成了30s。</p>
<p>同时他们自己的连接池配置是<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dataSource.setTimeBetweenEvictionRunsMillis(5000);</span><br><span class="line">dataSource.setMinEvictableIdleTimeMillis(30000);</span><br></pre></td></tr></table></figure><br>而我们的连接池配置是<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br><span class="line">dataSource.setMinEvictableIdleTimeMillis(60000);</span><br></pre></td></tr></table></figure></p>
<p>问题解决！！！</p>
<p>关于wait_timeout，这个参数到底要不要重新设置值没有固定的标准，保障数据库的可用性和性能即可，但应用层必须根据wait_timeout的实际情况进行相应的配置：<br>1、最大空闲时间不能大于wait_timeout<br>2、可以尝试在数据库连接中增加autoReconnect=true<br>3、testWhileIdle=”true” timeBetweenEvictionRunsMillis=”10000” validationQuery=”select 1”</p>
<p>猪方连接池：<br><img src="\images\pasted-92.png" alt="upload successful"><br>我方连接池：</p>
<p><img src="\images\pasted-94.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/07/08/spring-boot1-3-5%E6%94%AF%E6%8C%81jsp%E5%AF%BC%E8%87%B4%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E5%BA%94%E7%94%A8%E5%81%B6%E5%B0%94%E6%85%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/08/spring-boot1-3-5%E6%94%AF%E6%8C%81jsp%E5%AF%BC%E8%87%B4%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E5%BA%94%E7%94%A8%E5%81%B6%E5%B0%94%E6%85%A2/" class="post-title-link" itemprop="url">spring-boot1.3.5支持jsp导致浏览器访问应用偶尔慢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-08 14:42:00" itemprop="dateCreated datePublished" datetime="2019-07-08T14:42:00+08:00">2019-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%99%E4%BA%9B%E5%B9%B4%EF%BC%8C%E9%82%A3%E4%BA%9B%E5%9D%91/" itemprop="url" rel="index"><span itemprop="name">这些年，那些坑</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>18 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文将阐述在基于spring-boot1.3.5日常开发中所遇到的一个疑惑的问题，下面将按照问题处理的过程进行行文！！！</p>
<p>一、项目简介：<br>    这儿有一个业务系统，我们称之为M，架构基于springboot1.3.5，同时提供了web能力，前后端分离。线上生产环境中，外部商户的【取现业务】会跳转到本系统的页面上进行操作，实际场景中更多的是手机端进行页面跳转，但也可以PC端网页版跳转，因为M是基于spring-mvc提供的能力（这是对项目的通用认知，但某些关键的细节点并没有包含在里面，以至于在后续问题分析中走了很多弯路，耗时2天半才定位到问题）。</p>
<p>二、问题现象<br>    业务运行过程中，外部商户吐槽声来了，为什么跳转到你们的页面那么慢，耗时3-4s甚至更久，且频次比较高（后经运维部门同时查看，发现超过10%的请求出现慢的情况）。由于外部商户是移动端app，因此业务跳转耗时3-4s反馈到用户那儿便是点击确认操作后白板3-4s。这确实是一个糟糕的用户体验！另，据相关小伙伴反映，这是一个由来已久的问题，只是以前业务少，而且是自己的前端业务部门使用，有时忍忍就过去了。（这儿提到这一点，因为，如果能证实以前的慢和现在的慢问题一样，那么可以推导出并不是新的改动后其他操作带来的新问题，这对问题定位有指导性意义，但分析问题时总归是仓促的，这些信息极容易被丢掉）。</p>
<p>三、业务描述<br>    为了阐述问题的分析过程，业务场景必须清晰，下面简介一下该业务场景：</p>
<p><img src="\images\pasted-88.png" alt="upload successful"></p>
<p>四、问题排查<br>    通过前面的描述，我们知道了业务场景、系统情况及问题现象，接下来，我们开始了问题排查的过程，这过程，是痛苦的！！！<br>a、首先，我们根据商户提供的流水号进行日志查询，发现商户请求的时间和我们底层系统M实际收到的时间确实相差了3-4s，于是，我们找到了入口系统Api，因为整个业务场景，是由Api进行的页面跳转，会不会是Api做了什么事，导致页面跳转慢了？<br>b、通过查询Api的日志，发现收到请求的时间确实和商户时间一致，我们似乎找到问题根源，即Api有问题，但当进一步排查时，发现Api和M的交互只是做了简单的302重定向，并无其他逻辑，且发现Api发起重定向的时间到M“接收”到请求便耗时了3-4s，于是，我们把矛头指向了网络问题，加之跳转过程是用的域名跳转，我们更深信这3-4s花在了网络上！<br>c、我们怀疑是否是网络问题，于是找到运维的小伙伴，一通排查，回复我们网络没问题，并给了我们ng日志<br><img src="\images\pasted-89.png" alt="upload successful"><br>d、这个回复让我们不甘心，因为我们的Api正常的发起了跳转请求，我们的M系统3-4s后才接收到请求，那这耗时一定是在网络上啊，并多次反复追问信息中心域名等相关网络问题，后来，我通过PC页面直接进行测试（因为我也是该产品的用户），当我一顿操作并点击确认按钮后，咦，很快呀，但，接下来我反复的重试、刷新、重试，果不其然偶尔出现了一笔3-4s的耗时，看来这真是偶尔出现呀（偶发问题，那这不应该是应用问题呀！），紧接着我使用谷歌浏览器看了请求情况，发现如下信息：<br><img src="\images\pasted-90.png" alt="upload successful">，咦，这耗时花在了TTFB上面呀，然后百度一查，TTFB包含了tcp握手时间及服务端返回第一个字节的时间。哦，那这不正说明了网络问题嘛！同时我发现处理页面偶尔慢，某些纯后台服务或者图片也慢呀，于是又找到了运维同事，这已经大半天过去了（虽然中间处理问题断断续续）<br>e、这时，运维同事按照我们的方式测试，也确实出现了偶尔慢，他们抓包分析，发现当前网络正常呀，但有一个现象，慢的请求有三次重复ACK的现象，这是什么鬼？运维同事说这是正常的，TCP包乱序会重复发起ACK嘛，我将信将疑，但问题没说通啊，为什么慢，一小时过去了。这时更多的同事加入到问题分析，运维小伙伴为证明不是网络问题，在线上服务器直接ip访问页面，发现，也会出现慢，于是，我们也选择相信了网络没问题，但问题是什么？<br>f、这时我们测试过程中，又发现了某些图片资源404，某些图片资源即使存在但偶尔会慢，咦，是不是因为页面访问了资源而资源慢导致页面慢？这时其实问题的分析稍有偏差了，因为前面d的时候已经出现过类似问题，但没有包含资源的纯后台功能也慢啊！但花了近一天的分析，实在是太困惑，于是我们朝着这个方向去了。<br>g、我们把页面扣了出来，并扔到了ng上，既然图片资源慢，我们改动页面，以至于后面仅仅是一个纯文本页面了，确实，访问不慢了（但前面说了，这已经偏离了，因为页面位于ng中，而不是项目中，但这也是分析的必经之地，因为这儿确实也存在问题），我们尝试加上css、js资源，慢又出现了，并且发现都是图标慢，但，这不应该呀，CDN上静态资源应该很快呀，但后面我们发现这些慢的图片并不位于CDN，而是在项目M中，同时也存在访问了CDN上不存在且并不需要依赖的资源。我们把图片映射做了一下ng映射（前面说的这是在ng上的页面），再次访问，正常了。于是结论出来了，至少，前端开发中，动静分离不合规，同时copy代码，无用的资源访问也出现了。这是今天耗时一天的分析结论。但。<br>h、第二天，上班后，按照昨日的分析，前端进行了标准化的优化，上线，但问题依旧（毕竟前面图片这个问题是问题，但不是这次问题的根本问题）。这时，大家伙都很无语了，不知道为什么了！运维小伙伴又将纯文本页面扔到M项目中，启动访问，发现，也会慢呀，什么情况！同时，相同页面单独扔到tomcat中启动就正常，哎，见鬼了。似乎无下文了。<br>i、这时M系统负责人突然说到，测试环境能重现慢的问题，（我似乎看到了一丝曙光），但本地启动没问题（这个。。。），，难道还是环境问题？我来到测试环境中进行测试，看着业务日志与gc日志，发现几乎每次慢的时候就会做一次gc回收，咦，内存有问题？（实际是因为测试环境内存小，512M堆大小），但我又发现线上gc正常啊，但一点蛛丝马迹都得一试，把线上1.5G堆调成了4G堆，不过，问题依旧啊，似乎还慢的更频繁的样子（还好是基于http访问有硬件负载均衡，正常业务跑不进来）。<br>j、心有不甘，但想着能重现问题，应该就能定位到问题，于是我开始了代码分析之路，和其他小伙伴从两个方向并行去分析，都耗时一天半了，心想着，两个思路一起搞，兴许快点。既然测试环境能重现，好吧，我试试本地是不是真重现不了，我打开idea启动M，一顿尝试，好像真不可以呢。但我debug到了请求执行的环节，那，好吧，开启debug日志在测试环境看看，是哪个环节慢了？基于warn日志级别重启测试环境M，然后测试，发现，咦，真是的业务系统自己慢呢，已经收到请求了，在某个环节慢，而且，把页面扔到其他系统进行访问却没问题：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">2019-07-05 19:05:38.955 DEBUG [http-nio-8004-exec-3] InternalNioInputBuffer:180-- Received [GET /creditCard/cardBinInfo.json HTTP/1.1</span><br><span class="line">Host: 192.168.46.3:8004</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Mobile Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, sdch</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">Cookie: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line">2019-07-05 19:05:38.956 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [uriBC] has value [/creditCard/cardBinInfo.json]</span><br><span class="line">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [semicolon] has value [-1]</span><br><span class="line">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [enc] has value [utf-8]</span><br><span class="line">2019-07-05 19:05:42.640 DEBUG [http-nio-8004-exec-3] LegacyCookieProcessor:180-- Cookies: Parsing b[]: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class="line">2019-07-05 19:05:42.643 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180--  Requested cookie session id is 0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class="line">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] RemoteIpValve:180-- Incoming request /creditCard/cardBinInfo.json with originalRemoteAddr &#x27;192.168.47.152&#x27;, originalRemoteHost=&#x27;192.168.47.152&#x27;, originalSecure=&#x27;false&#x27;, originalScheme=&#x27;http&#x27; will be seen as newRemoteAddr=&#x27;192.168.47.152&#x27;, newRemoteHost=&#x27;192.168.47.152&#x27;, newScheme=&#x27;http&#x27;, newSecure=&#x27;false&#x27;</span><br><span class="line">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180-- Security checking request GET /creditCard/cardBinInfo.json</span><br><span class="line">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] RealmBase:180--   No applicable constraints defined</span><br><span class="line">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180--  Not subject to any constraint</span><br><span class="line">2019-07-05 19:05:42.653 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:114-- Bound request context to thread: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class="line">2019-07-05 19:05:42.654 DEBUG [http-nio-8004-exec-3] DispatcherServlet:863-- DispatcherServlet with name &#x27;dispatcherServlet&#x27; processing GET request for [/creditCard/cardBinInfo.json]</span><br><span class="line">2019-07-05 19:05:42.655 DEBUG [http-nio-8004-exec-3] Parameters:180-- Set encoding to UTF-8</span><br><span class="line">2019-07-05 19:05:42.660 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class="line">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:311-- Did not find handler method for [/creditCard/cardBinInfo.json]</span><br><span class="line">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class="line">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:308-- Returning handler method [public java.lang.Object com.yiji.mobilepay.web.controller.CreditCardWithdrawControler.cardBinInfo(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,javax.servlet.http.HttpSession)]</span><br><span class="line">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] DefaultListableBeanFactory:251-- Returning cached instance of singleton bean &#x27;creditCardWithdrawControler&#x27;</span><br><span class="line">2019-07-05 19:05:42.693 DEBUG [http-nio-8004-exec-3] DispatcherServlet:949-- Last-Modified value for [/creditCard/cardBinInfo.json] is: -1</span><br><span class="line">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.831 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResources(META-INF/services/com.alibaba.fastjson.serializer.AutowiredObjectSerializer)</span><br><span class="line">2019-07-05 19:05:42.841 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.842 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.847 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoBeanInfo)</span><br><span class="line">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class="line">2019-07-05 19:05:42.866 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoCustomizer)</span><br><span class="line">2019-07-05 19:05:42.867 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class="line">2019-07-05 19:05:42.869 DEBUG [dubbo-remoting-client-heartbeat-thread-1] HeartBeatTask:66--  [DUBBO] Send heartbeat to remote channel /192.168.46.3:20917, cause: The channel has no data-transmission exceeds a heartbeat period: 60000ms</span><br><span class="line">2019-07-05 19:05:42.870 DEBUG [New I/O client worker #1-3] HeartbeatHandler:82--  [DUBBO] Receive heartbeat response in thread New I/O client worker #1-3</span><br><span class="line">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(Object.class)</span><br><span class="line">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.875 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(Object.class)</span><br><span class="line">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.877 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(String.class)</span><br><span class="line">2019-07-05 19:05:42.878 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(String.class)</span><br><span class="line">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.880 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.881 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(StringBuilder.class)</span><br><span class="line">2019-07-05 19:05:42.882 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(StringBuilder.class)</span><br><span class="line">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.884 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com.class)</span><br><span class="line">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.888 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com.class)</span><br><span class="line">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.890 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(java/lang/com.class)</span><br><span class="line">2019-07-05 19:05:42.891 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(java/lang/com.class)</span><br><span class="line">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.893 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf.class)</span><br><span class="line">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.895 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf.class)</span><br><span class="line">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.897 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common.class)</span><br><span class="line">2019-07-05 19:05:42.898 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common.class)</span><br><span class="line">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.900 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common/util.class)</span><br><span class="line">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.902 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common/util.class)</span><br><span class="line">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.908 DEBUG [http-nio-8004-exec-3] ToString:550-- classloader:TomcatEmbeddedWebappClassLoader</span><br><span class="line">  context: ROOT</span><br><span class="line">  delegate: true</span><br><span class="line">----------&gt; Parent Classloader:</span><br><span class="line">org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line"></span><br><span class="line">2019-07-05 19:05:42.910 DEBUG [http-nio-8004-exec-3] RequestResponseBodyMethodProcessor:225-- Written [ViewResultInfo&#123;code=null,data=null,message=请通过网页正常步骤进行访问或者系统已超时,success=false&#125;] as &quot;application/json;charset=UTF-8&quot; using [com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter@3220bfbc]</span><br><span class="line">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:1036-- Null ModelAndView returned to DispatcherServlet with name &#x27;dispatcherServlet&#x27;: assuming HandlerAdapter completed request handling</span><br><span class="line">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:997-- Successfully completed request</span><br><span class="line">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:104-- Cleared thread-bound request context: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class="line">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br></pre></td></tr></table></figure><br>但是，这个环节去干什么了呢？源代码日志很少，看不出来呀！难道是分布式session问题，发现springboot分布式session我们内部是用redis实现的，后经一顿排查，发现上面日志中已经包含了redis的操作，但是是在慢的那个环节之后呀（不过提了个醒，以后redis要是抽风，这也是个风险点呢）。<br>k、现在知道问题就出在org.apache.catalina.connector.CoyoteAdapter这个类日志中显示的慢的那个环节了，但他究竟干了什么？貌似只是简单的一些操作啊，代码层次很深，今天也疲惫了，就没往深处看，为什么本地测试不出现问题？带着这些疑问，今天收班了。<br>l、今天本来是周六，但问题没解决，心有不甘呀，而且都能重现问题了，要是不定位到，好可惜。于是背着包来到了公司，反正今日无安排！来到公司，经过昨晚和今早放松了大脑，又准备整装待发了。本地不出问题，难道是打包环节不一样？两个私服不一致?于是我把测试环境的jar包拷了下来，java XXX -jar启动，咦，本地重现问题了！真是私服问题，包版本不一致？我又把本地项目用另一个私服打了jar包java XXX -jar启动，咦，问题也重现了，哦！原来是idea启动时候和java -jar有些区别（也许是classpath加载的区别吧），此处没深究，但很庆幸，本地重现问题，离问题定位再进一步<br>m、既然本地都重现问题了，虽然不能用idea断点测试，但我改改源码加加日志吧。ok！源码日志已加好，这下日志详细了吧，java XXX -jar启动，测试，啊！原来是这慢，还以为只是简单的map呢，被类名迷惑了：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion start............................</span><br><span class="line">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion end............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI start............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI end............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion start............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion end............................</span><br><span class="line">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts start............................&#123;&#125;false</span><br><span class="line">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts end............................&#123;&#125;localhost</span><br><span class="line">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu start............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu end............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start1............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start4............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start5............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start6............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start7............................&#123;&#125;</span><br></pre></td></tr></table></figure><br>源码<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// This will map the the latest version by default</span><br><span class="line">            connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class="line">                    version, request.getMappingData());</span><br></pre></td></tr></table></figure><br>此时内心激动，问题似乎更清晰了，打开idea，断点调试，往里面跟，发现了一个gateway页面，咦，这是我们自定义的页面，全项目搜索一下，它干啥了！<br>源码：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// Rule 1 -- Exact Match</span><br><span class="line">       MappedWrapper[] exactWrappers = contextVersion.exactWrappers;</span><br><span class="line">       internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">       // Rule 2 -- Prefix Match</span><br><span class="line">       boolean checkJspWelcomeFiles = false;</span><br><span class="line">       MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;</span><br><span class="line">       if (mappingData.wrapper == null) &#123;</span><br><span class="line">           internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,</span><br><span class="line">                                      path, mappingData);                                    </span><br></pre></td></tr></table></figure><br>包含gateway的代码：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class StargateConfigration &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public ServletRegistrationBean dispatcherRegistration(StargateDispachServlet stargateDispachServlet) &#123;</span><br><span class="line">	    ServletRegistrationBean registration = new ServletRegistrationBean(</span><br><span class="line">	    		stargateDispachServlet);</span><br><span class="line">	    registration.addUrlMappings(&quot;/gateway&quot;);</span><br><span class="line">	    return registration;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>咦，servlet，我顿时想起以前好像我们的spring-boot专门做了对jsp的支持，于是来到我们的tomcat-staters，<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Bean(name = &quot;yijiEmbeddedServletContainerCustomizer&quot;)</span><br><span class="line">public EmbeddedServletContainerCustomizer embeddedServletContainerCustomizer() &#123;</span><br><span class="line">	</span><br><span class="line">	return container -&gt; &#123;</span><br><span class="line">		//1. disable jsp if possible</span><br><span class="line">		if (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class="line">			JspServlet jspServlet = new JspServlet();</span><br><span class="line">			jspServlet.setRegistered(false);</span><br><span class="line">			container.setJspServlet(jspServlet);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure><br>难道是M系统启用了yiji.tomcat.jsp.enable=true？通过线上系统变量搜索，发现，确实，M启用了，其他系统没有，恍然大悟，这就是为什么M有问题而其他系统没问题的原因吧！于是我java -Dyiji.tomcat.jsp.enable=false -jar M，测试，果然，不慢了。。。问题终于定位到，spring-boot本身不推荐jsp，但提供了支持，这说明本身支持的方式就存在性能问题！<br>n、嗯，接下来，下掉jsp吧，本来这就是遗留问题，传统项目采用jsp，切换springboot后强行支持了jsp，但却有性能问题！还有安全漏洞！</p>
<p>下面说说spring-boot如何支持jsp吧。其实就是多注册一个JspServlet!<br>1、添加依赖<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br>2、配置文件中指定jsp文件存放路径<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#路径,在webapp文件夹下新建文件夹WEB-INF,在往下建文件夹jsp</span><br><span class="line">spring.mvc.view.prefix=/WEB-INF/jsp/</span><br><span class="line">#文件名的后缀,例如:index.jsp,放在jsp文件夹下</span><br><span class="line">spring.mvc.view.suffix=.jsp</span><br></pre></td></tr></table></figure><br><img src="\images\pasted-91.png" alt="upload successful"><br>3、作为框架，我们默认不支持jsp，因为有性能损耗<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class="line">				JspServlet jspServlet = new JspServlet();</span><br><span class="line">				jspServlet.setRegistered(false);</span><br><span class="line">				container.setJspServlet(jspServlet);</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure><br>4、业务系统根据自身情况决定是否启动jsp支持，启用，意味着接受性能损耗！</p>
<p>心得：<br>  本地问题分析历史2天半（中途很多时间在处理其他事情），心理感受颇多，分析线上类似问题一定要思路清晰，类似问题，先网路再应用，另外一定要有主线，如果能本地重现问题，那可是天大的好事，源码跟踪，源码添加日志可有效帮我们分析问题，总之，分析跨系统、跨部门、框架级问题时，协作、心态很重要！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/06/05/ava-lang-NoClassDefFoundError-Could-not-initialize-class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/05/ava-lang-NoClassDefFoundError-Could-not-initialize-class/" class="post-title-link" itemprop="url">java.lang.NoClassDefFoundError: Could not initialize class</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-05 20:42:00" itemprop="dateCreated datePublished" datetime="2019-06-05T20:42:00+08:00">2019-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>497</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>问题描述：项目启动没问题，运行也没有问题，但是当运行到某个静态工具类的时候，出问题了，且没有异常， 抛出的是NoClassDefFoundError</p>
<p>经分析：原因为静态类第一次被使用，尚未加载到虚拟机，使用时加载并编译，但static块中代码有异常，导致类加载失败，从而抛出此Error</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class LogTool &#123;</span><br><span class="line">	</span><br><span class="line">	public static boolean isPrint = true;</span><br><span class="line">	static &#123;</span><br><span class="line">		if (System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;local&quot;)</span><br><span class="line">			|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;pdev&quot;)</span><br><span class="line">			|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;sdev&quot;)) &#123;</span><br><span class="line">			isPrint = true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/05/16/HttpURLConnection-%E5%85%B3%E4%BA%8EHttpRequestMethodNotSupportedException%E5%BC%82%E5%B8%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/16/HttpURLConnection-%E5%85%B3%E4%BA%8EHttpRequestMethodNotSupportedException%E5%BC%82%E5%B8%B8/" class="post-title-link" itemprop="url">HttpURLConnection-关于HttpRequestMethodNotSupportedException异常</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-16 21:37:00" itemprop="dateCreated datePublished" datetime="2019-05-16T21:37:00+08:00">2019-05-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>背景：提供场景化业务监控能力时，需要通过捕获到的异常流水gid直接跳转到apm进行链路信息查询。</p>
<p>方案：调用apm提供的gid翻译为traceId方法，该能力是基于spring mvc提供，并且是https协议。godeye中利用HttpURLConnection封装post及get方法进行调用：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">URL realUrl = new URL(url);</span><br><span class="line">            HttpURLConnection conn = (HttpURLConnection )realUrl.openConnection();</span><br><span class="line">            conn.setRequestProperty(&quot;accept&quot;, &quot;*/*&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;);</span><br><span class="line">            conn.setRequestMethod(&quot;POST&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;Accept-Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(param.length()));</span><br><span class="line"></span><br><span class="line">            conn.setDoOutput(true);</span><br><span class="line">            conn.setDoInput(true);</span><br><span class="line">            out = new OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class="line">            out.write(param);</span><br><span class="line">            out.flush();</span><br><span class="line">            read = new BufferedReader(new InputStreamReader(conn.getInputStream(),DEFAULT_UNICODE));</span><br><span class="line">            String line;</span><br><span class="line">            while ((line = read.readLine()) != null) &#123;</span><br><span class="line">                result += line;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><br>问题：完成功能后测试时发现出现结果如下：{“timestamp”:”2019-05-16 21:36:11”,”status”:200,”error”:”OK”,”exception”:”org.springframework.web.HttpRequestMethodNotSupportedException”,”message”:”Request method ‘POST’ not supported”,”path”:”/gidQuery”}</p>
<p>百思不得其解，度娘了相关错误，指出了很多可能引起该问题的原因。</p>
<p>后发现问题出现在：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、conn.setRequestMethod(&quot;POST&quot;);及</span><br><span class="line">2、conn.setDoOutput(true);</span><br><span class="line">            conn.setDoInput(true);</span><br><span class="line">            out = new 3、OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class="line">            out.write(param);</span><br><span class="line">            out.flush();</span><br></pre></td></tr></table></figure><br>删除2、3这几行代码后，同时1改为conn.setRequestMethod(“GET”)，执行正常。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/05/06/%E5%9B%B4%E7%BB%95dubbo%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%BC%AB%E8%B0%88%E5%BE%AE%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/06/%E5%9B%B4%E7%BB%95dubbo%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%BC%AB%E8%B0%88%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">围绕dubbo底层原理漫谈微服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-06 17:56:00" itemprop="dateCreated datePublished" datetime="2019-05-06T17:56:00+08:00">2019-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%93%E9%A2%98%E7%A0%94%E8%AE%A8/" itemprop="url" rel="index"><span itemprop="name">专题研讨</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>168</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说在前面"><a href="#说在前面" class="headerlink" title="说在前面"></a>说在前面</h2><p>&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li><a href="#partI">XXX</a></li>
<li><a href="#partII">XXX</a></li>
<li><a href="#partIII">XXX</a></li>
<li><a href="#partIV">XXX</a></li>
</ul>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/28/git-%E6%9C%AC%E5%9C%B0commit%E3%80%81push%E3%80%81show%E3%80%81reset%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/28/git-%E6%9C%AC%E5%9C%B0commit%E3%80%81push%E3%80%81show%E3%80%81reset%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">git-本地commit、push、show、reset操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-28 11:06:00" itemprop="dateCreated datePublished" datetime="2019-04-28T11:06:00+08:00">2019-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>问题：<br>使用git commit代码时，git commit完成<br>后续执行git push origin master:master 提示“Everything up-to-date”<br>使用git show查询，确实能看到提交的内容</p>
<p>原因：<br>尝试提交到master，但本地对应的其实是一个分支</p>
<p>解决：<br>切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支</p>
<p>使用git reflog返回如下<br>fb3e1b1 (HEAD -&gt; master) HEAD@{0}: reset: moving to fb3e1b1<br>2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master<br>fb3e1b1 (HEAD -&gt; master) HEAD@{2}: commit: 场景化业务监控模型搭建<br>2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0<br>2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎<br>6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测<br>b28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量<br>ad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中<br>dd0138f HEAD@{10}: commit: hera配置更改<br>29764a1 HEAD@{11}: commit: README<br>75debd5 HEAD@{12}: clone: from <a target="_blank" rel="noopener" href="http://gitlab.yiji/yangxi/godeye.git">http://gitlab.yiji/yangxi/godeye.git</a></p>
<p>再次使用git reset –hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳</p>
<p>$ git reset –hard fb3e1b1<br>HEAD is now at fb3e1b1 场景化业务监控模型搭建</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xiang Chuang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/realxc/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;realxc&#x2F;" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiang Chuang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">117k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:47</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
