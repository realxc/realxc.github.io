title: fastdfs磁盘空间占满问题处理
author: Xiang Chuang
tags: []
categories:
  - 爱学爱问
date: 2021-10-08 10:32:00
---
问题描述：
	应用使用文件中台（基于fastdfs实现）上传文件时，报错：28，错误信息：没有足够的存储空间。
问题分析：
	根据错误描述，初步判断是fastdfs所在服务器磁盘空间不足所致
问题处理：
	1、进入相应服务器排查磁盘空间情况df -h
    	排查到磁盘已使用空间为86%（总大小32G），理论上当前服务仍有几个G空间可用，可继续上传文件
    2、查询fastdfs配置文件tracker.conf，找到配置reserved_storage_space，该配置默认为10%，经查看，本服务器中该配置配置为了20%，因此导致文件无法继续上传。注：配置reserved_storage_space代表预留磁盘空间大小，当服务器磁盘空间小于此大小后，不允许继续上传服务器，如果文件存储挂在到了多个目录，以小的为准【storage.conf中的store_path_count及store_path0，store_path11...支持多个存储空间】
    3、查询占用磁盘空间较多的目录，du --max-depth=1 -h 
    	经排查，发现本服务器上rocketmq日志所在存储空间较多
    4、此处直接删除了rokectmq的相关日志，但再次df -h发现磁盘并未回收，经分析，原因在于删除文件时未结束相关进程，导致磁盘控制未回收，因为在Linux系统中，通过rm或者文件管理器删除文件，系统只是将它会从文件系统的目录结构上解除链接(unlink)，即只删除了文件和系统目录结构的链接，如果文件在删除时是被打开的（如正被某进程访问）状态，那么进程将仍然可以读取该文件，所以磁盘空间也就会一直被占用。  因此，推荐1、结束进程后删除文件，  2、如果进程不能结束，则在线清空文件，1）# echo " " > /xxx/xxx.log、2）# cat /dev/null > /xxx/xxx.log、3）# > /xxx/xxx.log
    5、如果已经在未结束进程的情况的删掉了文件，可采用命令 lsof | grep deleted进行查询，找到对应的目录关联的进程，kill掉相应进程即可
    6、再次df -h查询磁盘空间，已完成释放