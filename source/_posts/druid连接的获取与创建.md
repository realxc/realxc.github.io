title: druid连接的获取与创建
author: Xiang Chuang
tags:
  - druid
  - 连接池
categories:
  - 这些年，那些坑
date: 2019-01-18 19:49:00
---
背景：服务器闪断时，druid连接池获取异常，且重试时间较长
经分析原因如下：
1、应用申请连接时，传入允许等待时间为10S
2、由于服务器闪断，瞬时出现部分线程A申请连接时，连接池中无空闲连接，因此A发出创建请求并等待（创建完成及返回连接，否则等待10s后返回失败）
3、线程A触发创建连接的线程，开始创建连接，此时可能创建失败，会30S后重新尝试创建
4、线程A同时会触发守护线程等待的信号量，守护线程接收到创建连接的信号量，也会开始创建连接，此时可能创建失败，会30S后重新尝试创建
    
影响：
如果业务量不大，创建连接慢（或者创建失败），会引起部分线程执行慢
如果业务量过大，且创建连接慢（或者创建失败），会导致线程积压从而导致内存消耗殆尽引起应用假死


![upload successful](\images\pasted-75.png)

别人画的图：

![upload successful](\images\pasted-76.png)
![upload successful](\images\pasted-77.png)