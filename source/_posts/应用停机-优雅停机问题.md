title: 应用停机-优雅停机问题
author: Xiang Chuang
tags:
  - 优雅停机
categories:
  - 这些年，那些坑
date: 2018-07-17 14:28:00
---
优雅停机问题，new对象的时候，应用classloader可能已经关闭了哦！

TomcatEmbeddedWebappClassLoader
  context: ROOT
  delegate: true
----------> Parent Classloader:
sun.misc.Launcher$AppClassLoader@14dad5dc

![upload successful](\images\pasted-19.png)

![upload successful](\images\pasted-20.png)

![upload successful](\images\pasted-21.png)

理论分析：
spring-boot启动：
1、new SpringApplication(Main.class).run(args);
     1.1、加载SpringApplicationRunListeners并执行started()
     1.2、createAndRefreshContext 
            1.2.1、Create and configure the environment
            1.2.2、Create, load, refresh and run the ApplicationContext                                        【org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext】
            1.2.3、Add boot specific singleton beans->springApplicationArguments
            1.2.4、Load the sources->Main方法
            1.2.5、SpringApplicationRunListeners执行contextLoaded
            1.2.6、Refresh the context->AbstractApplicationContext
                        1.2.6.1、Prepare this context for refreshing.
                        1.2.6.2、Tell the subclass to refresh the internal bean factory.
                        1.2.6.3、Prepare the bean factory for use in this context.
                        1.2.6.4、Allows post-processing of the bean factory in context subclasses.
                   【org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer】
                        1.2.6.5、Invoke factory processors registered as beans in the context.
                        1.2.6.6、Register bean processors that intercept bean creation.
                        1.2.6.7、Initialize message source for this context.
                        1.2.6.8、Initialize event multicaster for this context.
                        1.2.6.9、Initialize other special beans in specific context subclasses.
                        1.2.6.10、Check for listener beans and register them.
                        1.2.6.11、Instantiate all remaining (non-lazy-init) singletons.
                        1.2.6.12、Last step: publish corresponding event.
                        1.2.7、registerShutdownHook（注册jvm关闭钩子，钩子执行AbstractApplicationContext.doClose()）
        1.3、call finished listener（可以做自己的事哦，yijiboot在这里就注册系统关闭钩子）
        eg:com.yiji.boot.core.listener.YijiApplicationRunListener 
        new ShutdownThread().register();  ->shutdownApp();

spring-boot关闭： AbstractApplicationContext.doClose()
    1、Publish shutdown event.
        earlyApplicationEvents（里面对应的事件，延迟执行）
        eg：我们配置的dubbo关闭钩子就是同步执行的
    2、Stop all Lifecycle beans, to avoid delays during individual destruction.
    3、Destroy all cached singletons in the context's BeanFactory.
    4、Close the state of this context itself.
    5、Let subclasses do some final clean-up if they wish...
    【org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.doClose()】
![upload successful](\images\pasted-22.png)
18.07.12
又出问题啦
自主化发布时，直接替换项目包，项目自动重启了，且，没有消费掉dubbo

经分析：
账务系统采用的依旧是war包的方式，部署在tomcat容器的。

因此，替换war包后，项目自动重启，首先关闭tomcat容器，calssloader注销，然后注销springbean（这时候就出问题啦，因此某些bean已经不存在，不可使用）
![upload successful](\images\pasted-23.png)