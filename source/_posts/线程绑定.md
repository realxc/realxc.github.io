title: 线程绑定
author: Xiang Chuang
tags:
  - 线程绑定
  - cpu
categories:
  - 爱学爱问
date: 2021-10-08 18:06:00
---
一、场景描述
	在某些应用场景中，应用对cpu的占用率极高，我们可以考虑采用线程绑定技术，将相应的进程（线程）绑定到固定的cpu核上，以减少cpu各应用间干扰、减少cpu上下文切换并提高cpu缓存利用率

二、方案简介（linux-centos）
	1、查询cpu核心/线程情况
    	cat /proc/cpuinfo
        其中processor 0-n为cpu可用核心（超线程）对应的编码
    2、通过top， 然后1，可查看各cpu核心利用率
    3、可以通过配置进行cpu隔离，即，禁止操作系统调度指定的cpu内核
      /boot/grub2/grub.cfg中设置 isolcpus = 1,2（代表第2，3个cpu不进行自动调度）  设置后请重启系统
    4、以redis为例采用指定的cpu内核启动redis
    		taskset -c 1 ./redis-server ../redis.conf
    5、taskset -p redisPID 可查询redis是否采用的对应的内核
    
    
三、java应用案列
对于高性能并发框架，如Disruptor的等待策略BusySpinW4aitStrategy，及netty的EventLoopGroup【https://netty.io/wiki/thread-affinity.html】都推荐了采用线程绑定来充分利用cpu资源，自己的业务代码可参照使用net.openhft.affinity类库实现线程绑定
    
   依赖于类库
    
    <dependency>
    <groupId>net.openhft</groupId>
    <artifactId>affinity</artifactId>
    <version>最新版</version>
	</dependency>