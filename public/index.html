<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="博客园-向闯">
<meta property="og:url" content="http://realxc.githut.io/index.html">
<meta property="og:site_name" content="博客园-向闯">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="博客园-向闯">





  
  
  <link rel="canonical" href="http://realxc.githut.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>博客园-向闯</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">博客园-向闯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/07/08/spring-boot1-3-5支持jsp导致浏览器访问应用偶尔慢/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/08/spring-boot1-3-5支持jsp导致浏览器访问应用偶尔慢/" class="post-title-link" itemprop="url">spring-boot1.3.5支持jsp导致浏览器访问应用偶尔慢</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-08 14:42:00 / 修改时间：16:23:46" itemprop="dateCreated datePublished" datetime="2019-07-08T14:42:00+08:00">2019-07-08</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springboot/jsp/" itemprop="url" rel="index"><span itemprop="name">jsp</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文将阐述在基于spring-boot1.3.5日常开发中所遇到的一个疑惑的问题，下面将按照问题处理的过程进行行文！！！</p>
<p>一、项目简介：<br>    这儿有一个业务系统，我们称之为M，架构基于springboot1.3.5，同时提供了web能力，前后端分离。线上生产环境中，外部商户的【取现业务】会跳转到本系统的页面上进行操作，实际场景中更多的是手机端进行页面跳转，但也可以PC端网页版跳转，因为M是基于spring-mvc提供的能力（这是对项目的通用认知，但某些关键的细节点并没有包含在里面，以至于在后续问题分析中走了很多弯路，耗时2天半才定位到问题）。</p>
<p>二、问题现象<br>    业务运行过程中，外部商户吐槽声来了，为什么跳转到你们的页面那么慢，耗时3-4s甚至更久，且频次比较高（后经运维部门同时查看，发现超过10%的请求出现慢的情况）。由于外部商户是移动端app，因此业务跳转耗时3-4s反馈到用户那儿的便于点击确认操作后白板3-4s。这确实是一个糟糕的用户体验！另，据相关小伙伴反映，这是一个由来已久的问题，只是以前业务少，而且是自己的前端业务部门使用，有时忍忍就过去了。（这儿提到这一点，因为，如果能证实以前的慢和现在的慢问题一样，那么可以推导出并不是新的改动后其他操作带来的新问题，这对问题定位有指导性意义，但分析问题时总归是仓促的，这些信息极容易被丢掉）。</p>
<p>三、业务描述<br>    为了阐述问题的分析过程，业务场景必须清晰，下面简介一下该业务场景：</p>
<p><img src="\images\pasted-88.png" alt="upload successful"></p>
<p>四、问题排查<br>    通过前面的描述，我们知道了业务场景、系统情况及问题现象，接下来，我们开始了问题排查的过程，这过程，是痛苦的！！！<br>a、首先，我们跟进商户提供的流水号进行日志查询，发现商户请求的时间和我们底层系统M实际收到的时间确实相差了3-4s，于是，我们找到了入口系统Api，因为整个业务场景，是由Api进行的页面跳转，会不会是Api做了什么事，导致页面跳转慢了？<br>b、通过查询Api的日志，发现收到请求的时间确实和商户时间一致，我们似乎找到问题根源，即Api有问题，但当进一步排查时，发现Api和M的交互只是做了简单的302重定向，并无其他逻辑，且发现Api发起重定向的时间到M“接收”到请求便耗时了3-4s，于是，我们把矛头执行了网络问题，加之跳转过程是用的域名跳转，我们更深信这3-4s花在了网络上！<br>c、我们怀疑是否是网络问题，于是找到运维的小伙伴，一通排查，回复我们网络没问题，并给了我们ng日志<br><img src="\images\pasted-89.png" alt="upload successful"><br>d、这个回复让我们不甘心，因为我们的Api正常的发起了跳转请求，我们的M3-4s后才接收到请求，那这耗时一定是在网络上啊，并多次反复追问信息中心域名等相关网络问题，后来，我通过PC页面直接进行测试（因为我也是该产品的用户），当我一顿操作并点击确认按钮后，咦，很快呀，接着我反复的重试、刷新、重试，果不其然偶尔出现了一笔3-4s的耗时，看来这真是偶尔出现呀（新那这不应该是应用问题呀），紧接着我事用谷歌浏览器看了请求情况，发现如下信息：<br><img src="\images\pasted-90.png" alt="upload successful">，咦，这耗时花在了TTFB上面呀，然后百度一查，TTFB包含了tcp握手时间即服务端返回第一个字节的时间。哦，那这不正说明了网络问题嘛！同时我发现处理页面偶尔慢，某些纯后台服务或者图片也慢呀，于是又找到了运维同事，这已经大半天过去了（虽然中间处理问题断断续续）<br>e、这时，运维同事按照我们的方式测试，也确实出现了偶尔慢，他们抓包分析，发现当前网络正常呀，但有一个现象，慢的请求有三次重复ACK的现象，这是什么鬼？运维同事说这是正常的，TCP包乱序会重复发起ACK嘛，我将信将疑，但问题没说通啊，为什么慢，一小时过去了。这时更多的同事加入到问题分析，运维小伙伴为证明不是网络问题，在线上服务器直接ip访问页面，发现，也会出现慢，于是，我们也选择相信了网络没问题，但问题是什么？<br>f、这时我们测试过程中，又发现了某些图片资源404，某些图片资源即使存在但偶尔会慢，咦，是不是因为页面访问了资源而资源慢导致页面慢？这时其实问题的分析稍有偏差了，因为d的时候已经出现过类似问题，但没有包含资源的纯后台页面也慢啊！但花了近一天的分析，实在是太困惑，于是我们朝着这个方向去了。<br>g、我们把也慢扣了出来，并扔到了ng上，既然图片资源慢，我们改动页面，以至于后面仅仅是一个文本页面了，确实，访问不慢了（但前面说了，这已经偏离了，因为页面位于ng中，而不是项目中，但这也是分析的必经之地，因为这儿确实也存在问题），我们尝试加上css、js资源，慢又出现了，并且发现都是图表慢，但，这不应该了CDN上静态资源应该很快呀，但后面我们发现这些慢的图片并不位于CDN，而是在项目M中，同时也存在访问了CDN上不存在且并不需要依赖的资源。我们把图片映射做了一下ng映射（前面说的这是在ng上的页面），再次访问，正常了。于是结论出来了，至少，前端开发中，动静分离不合规，同时copy代码，无用的资源访问也出现了。这是今天耗时一天的分析结论。但。<br>h、第二天，上班后，按照昨日的分析，前端进行了标准化的优化，上线，但问题依旧（毕竟前面图片这个问题是问题，但不是这次问题的根本问题）。这时，大家伙都很无语了，不知道为什么了！运维小伙伴又将纯文本页面扔到M项目中，启动访问，发现，也会慢呀，什么情况！同时，相同页面单独扔到tomcat中启动就正常，哎，见鬼了。似乎无下文了。<br>i、这时M系统负责人突然说到，测试环境能重现慢的问题，（我似乎看到了一丝曙光），但本地启动没问题（这个。。。），，难道还是环境问题？我来到测试环境测试中，看着业务日志与gc日志，发现每次慢的时候就会做一次gc回收，咦，内存有问题？（实际是因为测试环境内存小，512M堆大小），但我又发现线上gc正常啊，但一点蛛丝马迹都得一试，把线上1.5G堆调成了4G堆，不过，问题依旧啊，似乎还慢的更频繁的样子（还是基于http访问又硬件负载均衡，正常业务跑步进来）。<br>j、心有不甘，但想着能重现问题，应该就能定位到问题，于是我开始了代码分析之路，和其他小伙伴从两个方向并行去分析，都耗时一天半了，心想着，两个思路一起搞，兴许快点。既然测试环境能重现，好吧，我试试本地是不是真重现不了，我打卡idea启动M，一顿尝试，好像真不可以呢。但我debug到了请求执行的环节，那，好吧，开启debug日志在测试环境看看，是哪个环节慢了？基于warn日志级别重启测试环境M，然后测试，发现，咦，真是的业务系统自己慢呢，已经收到请求了，在某个环节慢，而且，把页面扔到其他系统进行访问确没问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">2019-07-05 19:05:38.955 DEBUG [http-nio-8004-exec-3] InternalNioInputBuffer:180-- Received [GET /creditCard/cardBinInfo.json HTTP/1.1</span><br><span class="line">Host: 192.168.46.3:8004</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Mobile Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, sdch</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">Cookie: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line">2019-07-05 19:05:38.956 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [uriBC] has value [/creditCard/cardBinInfo.json]</span><br><span class="line">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [semicolon] has value [-1]</span><br><span class="line">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [enc] has value [utf-8]</span><br><span class="line">2019-07-05 19:05:42.640 DEBUG [http-nio-8004-exec-3] LegacyCookieProcessor:180-- Cookies: Parsing b[]: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class="line">2019-07-05 19:05:42.643 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180--  Requested cookie session id is 0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class="line">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] RemoteIpValve:180-- Incoming request /creditCard/cardBinInfo.json with originalRemoteAddr &apos;192.168.47.152&apos;, originalRemoteHost=&apos;192.168.47.152&apos;, originalSecure=&apos;false&apos;, originalScheme=&apos;http&apos; will be seen as newRemoteAddr=&apos;192.168.47.152&apos;, newRemoteHost=&apos;192.168.47.152&apos;, newScheme=&apos;http&apos;, newSecure=&apos;false&apos;</span><br><span class="line">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180-- Security checking request GET /creditCard/cardBinInfo.json</span><br><span class="line">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] RealmBase:180--   No applicable constraints defined</span><br><span class="line">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180--  Not subject to any constraint</span><br><span class="line">2019-07-05 19:05:42.653 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:114-- Bound request context to thread: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class="line">2019-07-05 19:05:42.654 DEBUG [http-nio-8004-exec-3] DispatcherServlet:863-- DispatcherServlet with name &apos;dispatcherServlet&apos; processing GET request for [/creditCard/cardBinInfo.json]</span><br><span class="line">2019-07-05 19:05:42.655 DEBUG [http-nio-8004-exec-3] Parameters:180-- Set encoding to UTF-8</span><br><span class="line">2019-07-05 19:05:42.660 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class="line">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:311-- Did not find handler method for [/creditCard/cardBinInfo.json]</span><br><span class="line">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class="line">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:308-- Returning handler method [public java.lang.Object com.yiji.mobilepay.web.controller.CreditCardWithdrawControler.cardBinInfo(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,javax.servlet.http.HttpSession)]</span><br><span class="line">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] DefaultListableBeanFactory:251-- Returning cached instance of singleton bean &apos;creditCardWithdrawControler&apos;</span><br><span class="line">2019-07-05 19:05:42.693 DEBUG [http-nio-8004-exec-3] DispatcherServlet:949-- Last-Modified value for [/creditCard/cardBinInfo.json] is: -1</span><br><span class="line">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.831 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResources(META-INF/services/com.alibaba.fastjson.serializer.AutowiredObjectSerializer)</span><br><span class="line">2019-07-05 19:05:42.841 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.842 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.847 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoBeanInfo)</span><br><span class="line">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class="line">2019-07-05 19:05:42.866 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoCustomizer)</span><br><span class="line">2019-07-05 19:05:42.867 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class="line">2019-07-05 19:05:42.869 DEBUG [dubbo-remoting-client-heartbeat-thread-1] HeartBeatTask:66--  [DUBBO] Send heartbeat to remote channel /192.168.46.3:20917, cause: The channel has no data-transmission exceeds a heartbeat period: 60000ms</span><br><span class="line">2019-07-05 19:05:42.870 DEBUG [New I/O client worker #1-3] HeartbeatHandler:82--  [DUBBO] Receive heartbeat response in thread New I/O client worker #1-3</span><br><span class="line">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(Object.class)</span><br><span class="line">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.875 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(Object.class)</span><br><span class="line">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.877 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(String.class)</span><br><span class="line">2019-07-05 19:05:42.878 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(String.class)</span><br><span class="line">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.880 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.881 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(StringBuilder.class)</span><br><span class="line">2019-07-05 19:05:42.882 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(StringBuilder.class)</span><br><span class="line">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.884 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com.class)</span><br><span class="line">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.888 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com.class)</span><br><span class="line">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.890 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(java/lang/com.class)</span><br><span class="line">2019-07-05 19:05:42.891 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(java/lang/com.class)</span><br><span class="line">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.893 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf.class)</span><br><span class="line">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.895 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf.class)</span><br><span class="line">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.897 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common.class)</span><br><span class="line">2019-07-05 19:05:42.898 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common.class)</span><br><span class="line">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.900 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common/util.class)</span><br><span class="line">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line">2019-07-05 19:05:42.902 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common/util.class)</span><br><span class="line">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class="line">2019-07-05 19:05:42.908 DEBUG [http-nio-8004-exec-3] ToString:550-- classloader:TomcatEmbeddedWebappClassLoader</span><br><span class="line">  context: ROOT</span><br><span class="line">  delegate: true</span><br><span class="line">----------&gt; Parent Classloader:</span><br><span class="line">org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class="line"></span><br><span class="line">2019-07-05 19:05:42.910 DEBUG [http-nio-8004-exec-3] RequestResponseBodyMethodProcessor:225-- Written [ViewResultInfo&#123;code=null,data=null,message=请通过网页正常步骤进行访问或者系统已超时,success=false&#125;] as &quot;application/json;charset=UTF-8&quot; using [com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter@3220bfbc]</span><br><span class="line">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:1036-- Null ModelAndView returned to DispatcherServlet with name &apos;dispatcherServlet&apos;: assuming HandlerAdapter completed request handling</span><br><span class="line">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:997-- Successfully completed request</span><br><span class="line">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:104-- Cleared thread-bound request context: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class="line">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class="line">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class="line">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br></pre></td></tr></table></figure></p>
<p>但是，这个环节去干什么了呢？源代码日志很少，看不出来呀！难道是分布式session问题，发现springboot分布式session我们内部事用redis实现的，后经一顿排查，发现上面日志中已经包含了redis的操作，但是是在慢的那个环节之后呀（不过提了个醒，以后redis要是抽风，这也是个风险点呢）。<br>k、现在知道问题就出在org.apache.catalina.connector.CoyoteAdapter这个类日志中显示的慢的那个环节了，但他究竟干了什么？貌似只是简单的一些操作啊，代码层次很深，今天也疲惫了，就没往深处看，为什么本地测试不出现问题？带着这些疑问，今天收班了。<br>l、今天没来是周六，但问题没解决，心有不甘呀，而且都能重现问题了，要是不定位到，好可惜。于是背着包来到了公司，反正今日无安排！来到公司，经过作为和今早放松了大脑，有准备整装待发了。本地不出问题，难道是打包环节不一样？两个私服不一致?于是我把测试环境的jar包拷了下来，java XXX -jar启动，咦，本地重现问题了！真是私服问题，包版本不一致？我又把本地项目用另一个私服打了jar包java XXX -jar启动，咦，问题也重现了，哦！原来是idea启动时候和java -jar有些区别，也许是classpath加载的区别吧，此处没深究，但很庆幸，本地重现问题，离问题定位再进一步<br>m、既然本地都重现问题了，虽然不能用idea断点测试，但我改改源码加加日志吧。ok！源码日志已加号，这下日志详细了吧，java XXX -jar启动，测试，啊！原来是这慢，还以为只是简单的map呢，被类没迷惑了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion start............................</span><br><span class="line">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion end............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI start............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI end............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion start............................</span><br><span class="line">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion end............................</span><br><span class="line">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts start............................&#123;&#125;false</span><br><span class="line">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts end............................&#123;&#125;localhost</span><br><span class="line">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu start............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu end............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start1............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start4............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start5............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start6............................&#123;&#125;</span><br><span class="line">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start7............................&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// This will map the the latest version by default</span><br><span class="line">            connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class="line">                    version, request.getMappingData());</span><br></pre></td></tr></table></figure></p>
<p>此时内心激动，问题似乎更清晰了，打开idea，断点测试，往里面跟，发现了一个gateway页面，咦，这时我们定义的页面，全项目搜索一下，它干啥了！<br>源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// Rule 1 -- Exact Match</span><br><span class="line">       MappedWrapper[] exactWrappers = contextVersion.exactWrappers;</span><br><span class="line">       internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">       // Rule 2 -- Prefix Match</span><br><span class="line">       boolean checkJspWelcomeFiles = false;</span><br><span class="line">       MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;</span><br><span class="line">       if (mappingData.wrapper == null) &#123;</span><br><span class="line">           internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,</span><br><span class="line">                                      path, mappingData);</span><br></pre></td></tr></table></figure></p>
<p>包含gateway的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class StargateConfigration &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public ServletRegistrationBean dispatcherRegistration(StargateDispachServlet stargateDispachServlet) &#123;</span><br><span class="line">	    ServletRegistrationBean registration = new ServletRegistrationBean(</span><br><span class="line">	    		stargateDispachServlet);</span><br><span class="line">	    registration.addUrlMappings(&quot;/gateway&quot;);</span><br><span class="line">	    return registration;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>咦，servlet，我顿时想起以前好像我们的spring-boot专门做了堆jsp的支持，于是来到我们的tomcat-staters，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Bean(name = &quot;yijiEmbeddedServletContainerCustomizer&quot;)</span><br><span class="line">public EmbeddedServletContainerCustomizer embeddedServletContainerCustomizer() &#123;</span><br><span class="line">	</span><br><span class="line">	return container -&gt; &#123;</span><br><span class="line">		//1. disable jsp if possible</span><br><span class="line">		if (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class="line">			JspServlet jspServlet = new JspServlet();</span><br><span class="line">			jspServlet.setRegistered(false);</span><br><span class="line">			container.setJspServlet(jspServlet);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>难道是M系统启用了yiji.tomcat.jsp.enable=true？通过线上系统变量搜索，发现，确实，M启用了，其他系统没有，恍然大悟，这就是为什么M有问题而其他系统没问题的原因吧！于是我java -Dyiji.tomcat.jsp.enable=false -jar M，测试，果然，不慢了。。。问题终于定位到，spring-boot本身不推荐jsp，但提供了支持，这说明本身支持的方式就存在性能问题！<br>n、嗯，接下来，下掉jsp吧，本来这就是遗留问题，传统项目采用jsp，切换springboot后强行支持了jsp，但却有性能问题！还有安全漏洞！</p>
<p>下面说说spring-boot如何支持jsp吧。其实就是多注册一个JspServlet!<br>1、添加依赖<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>2、配置文件中指定jsp文件存放路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#路径,在webapp文件夹下新建文件夹WEB-INF,在往下建文件夹jsp</span><br><span class="line">spring.mvc.view.prefix=/WEB-INF/jsp/</span><br><span class="line">#文件名的后缀,例如:index.jsp,放在jsp文件夹下</span><br><span class="line">spring.mvc.view.suffix=.jsp</span><br></pre></td></tr></table></figure></p>
<p><img src="\images\pasted-91.png" alt="upload successful"><br>3、作为框架，我们默认不支持jsp，因为有性能损耗<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class="line">				JspServlet jspServlet = new JspServlet();</span><br><span class="line">				jspServlet.setRegistered(false);</span><br><span class="line">				container.setJspServlet(jspServlet);</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure></p>
<p>4、业务系统根据自身情况决定是否启动jsp支持，启用，意味着接受性能损耗！</p>
<p>心得：<br>  本地问题分析历史2天半（中途很多时间在处理其他事情），心理感受颇多，分析线上类似问题一定要思路清晰，先网路再应用，另外一定要有主线，如果能本地重现问题，那可是天大的耗时，源码跟踪，源码添加日志可有效帮我们分析问题，总之，分析跨系统、跨部门、框架级问题时，心态很重要！</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/06/05/ava-lang-NoClassDefFoundError-Could-not-initialize-class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/05/ava-lang-NoClassDefFoundError-Could-not-initialize-class/" class="post-title-link" itemprop="url">java.lang.NoClassDefFoundError: Could not initialize class</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-05 20:42:00 / 修改时间：20:45:39" itemprop="dateCreated datePublished" datetime="2019-06-05T20:42:00+08:00">2019-06-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/爱学爱问/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>问题描述：项目启动没问题，运行也没有问题，但是当运行到某个静态工具类的时候，出问题了，且没有异常， 抛出的是NoClassDefFoundError</p>
<p>经分析：原因为静态类第一次被使用，尚未加载到虚拟机，使用时加载并编译，但static块中代码有异常，导致类加载失败，从而抛出此Error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class LogTool &#123;</span><br><span class="line">	</span><br><span class="line">	public static boolean isPrint = true;</span><br><span class="line">	static &#123;</span><br><span class="line">		if (System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;local&quot;)</span><br><span class="line">			|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;pdev&quot;)</span><br><span class="line">			|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;sdev&quot;)) &#123;</span><br><span class="line">			isPrint = true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/05/16/HttpURLConnection-关于HttpRequestMethodNotSupportedException异常/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/16/HttpURLConnection-关于HttpRequestMethodNotSupportedException异常/" class="post-title-link" itemprop="url">HttpURLConnection-关于HttpRequestMethodNotSupportedException异常</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-16 21:37:00 / 修改时间：21:47:36" itemprop="dateCreated datePublished" datetime="2019-05-16T21:37:00+08:00">2019-05-16</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/爱学爱问/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>背景：提供场景化业务监控能力时，需要通过捕获到的异常流水gid直接跳转到apm进行链路信息查询。</p>
<p>方案：调用apm提供的gid翻译为traceId方法，该能力是基于spring mvc提供，并且是https协议。godeye中利用HttpURLConnection封装post及get方法进行调用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">URL realUrl = new URL(url);</span><br><span class="line">            HttpURLConnection conn = (HttpURLConnection )realUrl.openConnection();</span><br><span class="line">            conn.setRequestProperty(&quot;accept&quot;, &quot;*/*&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;);</span><br><span class="line">            conn.setRequestMethod(&quot;POST&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;Accept-Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">            conn.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(param.length()));</span><br><span class="line"></span><br><span class="line">            conn.setDoOutput(true);</span><br><span class="line">            conn.setDoInput(true);</span><br><span class="line">            out = new OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class="line">            out.write(param);</span><br><span class="line">            out.flush();</span><br><span class="line">            read = new BufferedReader(new InputStreamReader(conn.getInputStream(),DEFAULT_UNICODE));</span><br><span class="line">            String line;</span><br><span class="line">            while ((line = read.readLine()) != null) &#123;</span><br><span class="line">                result += line;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>问题：完成功能后测试时发现出现结果如下：{“timestamp”:”2019-05-16 21:36:11”,”status”:200,”error”:”OK”,”exception”:”org.springframework.web.HttpRequestMethodNotSupportedException”,”message”:”Request method ‘POST’ not supported”,”path”:”/gidQuery”}</p>
<p>百思不得其解，度娘了相关错误，指出了很多可能引起该问题的原因。</p>
<p>后发现问题出现在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、conn.setRequestMethod(&quot;POST&quot;);及</span><br><span class="line">2、conn.setDoOutput(true);</span><br><span class="line">            conn.setDoInput(true);</span><br><span class="line">            out = new 3、OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class="line">            out.write(param);</span><br><span class="line">            out.flush();</span><br></pre></td></tr></table></figure></p>
<p>删除2、3这几行代码后，同时1改为conn.setRequestMethod(“GET”)，执行正常。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/05/06/围绕dubbo底层原理漫谈微服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/06/围绕dubbo底层原理漫谈微服务/" class="post-title-link" itemprop="url">围绕dubbo底层原理漫谈微服务</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-06 17:56:00 / 修改时间：18:04:20" itemprop="dateCreated datePublished" datetime="2019-05-06T17:56:00+08:00">2019-05-06</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/专题研讨/" itemprop="url" rel="index"><span itemprop="name">专题研讨</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="说在前面"><a href="#说在前面" class="headerlink" title="说在前面"></a>说在前面</h2><p>&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li><a href="#partI">XXX</a></li>
<li><a href="#partII">XXX</a></li>
<li><a href="#partIII">XXX</a></li>
<li><a href="#partIV">XXX</a></li>
</ul>
<hr>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/28/git-本地commit、push、show、reset操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/git-本地commit、push、show、reset操作/" class="post-title-link" itemprop="url">git-本地commit、push、show、reset操作</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-28 11:06:00 / 修改时间：11:49:18" itemprop="dateCreated datePublished" datetime="2019-04-28T11:06:00+08:00">2019-04-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/爱学爱问/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>问题：<br>使用git commit代码时，git commit完成<br>后续执行git push origin master:master 提示“Everything up-to-date”<br>使用git show查询，确实能看到提交的内容</p>
<p>原因：<br>尝试提交到master，但本地对应的其实是一个分支</p>
<p>解决：<br>切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支</p>
<p>使用git reflog返回如下<br>fb3e1b1 (HEAD -&gt; master) HEAD@{0}: reset: moving to fb3e1b1<br>2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master<br>fb3e1b1 (HEAD -&gt; master) HEAD@{2}: commit: 场景化业务监控模型搭建<br>2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0<br>2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎<br>6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测<br>b28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量<br>ad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中<br>dd0138f HEAD@{10}: commit: hera配置更改<br>29764a1 HEAD@{11}: commit: README<br>75debd5 HEAD@{12}: clone: from <a href="http://gitlab.yiji/yangxi/godeye.git" target="_blank" rel="noopener">http://gitlab.yiji/yangxi/godeye.git</a></p>
<p>再次使用git reset –hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳</p>
<p>$ git reset –hard fb3e1b1<br>HEAD is now at fb3e1b1 场景化业务监控模型搭建</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/11/图片压缩-ImageIO-read-inputStream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/11/图片压缩-ImageIO-read-inputStream/" class="post-title-link" itemprop="url">图片压缩-ImageIO.read(inputStream)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-11 18:36:00" itemprop="dateCreated datePublished" datetime="2019-04-11T18:36:00+08:00">2019-04-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-19 17:32:20" itemprop="dateModified" datetime="2019-04-19T17:32:20+08:00">2019-04-19</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/这些年，那些坑/" itemprop="url" rel="index"><span itemprop="name">这些年，那些坑</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文可结合链接中的文章从GC层面辅助分析！<br><a href="https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/" target="_blank" rel="noopener">https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/</a></p>
<p>背景：由于目前手机像素越来越富裕，导致用户上传图片时过大3-4M甚至以上，且像素较高，如3024*4032，因此，图片压缩功能就势在必行了。</p>
<p>选型：优先考虑前端压缩，但由于个人对前端无甚兴趣，因此提供了基于java的压缩解决方案。</p>
<p>目前市面上成熟的压缩工具大致为thumbnailator及simpleimage<br>1、thumbnailator<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;net.coobird&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;thumbnailator&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.4.8&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage bufferedImage = Thumbnails.of(input).scale(scale).outputQuality(quality).asBufferedImage();</span><br></pre></td></tr></table></figure>
<p>  经过使用发现有背景色变红的问题，未着手解决,同时，内存消耗较大</p>
<p>2、simpleimage<br>参见git<br><a href="https://github.com/alibaba/simpleimage" target="_blank" rel="noopener">https://github.com/alibaba/simpleimage</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.sun.media&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;jai-codec&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;javax.media&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;jai-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;simpleimage&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">File in = new File(&quot;d://04092.jpg&quot;);      //原图片</span><br><span class="line">            ImageWrapper imageWrapper = ImageReadHelper.read(new FileInputStream(in));</span><br><span class="line">            int witdh = imageWrapper.getWidth();</span><br><span class="line">            int height = imageWrapper.getHeight();</span><br><span class="line">            File out = new File(&quot;d://04092-after.jpg&quot;);       //目的图片</span><br><span class="line">            ScaleParameter scaleParam = new ScaleParameter(Float.valueOf(witdh * 0.5f).intValue()</span><br><span class="line">                    , Float.valueOf(height * 0.5f).intValue());</span><br><span class="line">            WriteParameter writeParam = new WriteParameter();</span><br><span class="line"></span><br><span class="line">            FileInputStream inStream = null;</span><br><span class="line">            FileOutputStream outStream = null;</span><br><span class="line">            ImageRender wr = null;</span><br><span class="line">            inStream = new FileInputStream(in);</span><br><span class="line">            outStream = new FileOutputStream(out);</span><br><span class="line">            ImageRender rr = new ReadRender(inStream);</span><br><span class="line">            ImageRender sr = new ScaleRender(rr, scaleParam);</span><br><span class="line">            wr = new WriteRender(sr, outStream, ImageFormat.JPEG, writeParam);</span><br><span class="line"></span><br><span class="line">            wr.render();                            //触发图像处理</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">WriteRender.render()源码：</span><br><span class="line"> @Override</span><br><span class="line">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (image == null) &#123;</span><br><span class="line">                image = imageRender.render();//此处读取原文件，大对象</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ImageWriteHelper.write(image, stream, outputFormat, param);//写文件，数据缓冲区分段初始化，一个按压缩后图片像素大小生产，外加若干512*512及1024*1024的缓冲区，因此需要更多的内存</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SimpleImageException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ReadRender.render源码， WriteRender中需要首先依赖此类读取原文件</span><br><span class="line">@Override</span><br><span class="line">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ImageWrapper imgWrapper;</span><br><span class="line">            if (inStream == null) &#123;</span><br><span class="line">                throw new SimpleImageException(&quot;No input set&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            imgWrapper = ImageReadHelper.read(inStream);</span><br><span class="line"></span><br><span class="line">            if (tosRGBColorSpace) &#123;</span><br><span class="line">                for (int i = 0; i &lt; imgWrapper.getNumOfImages(); i++) &#123;</span><br><span class="line">                    PlanarImage img = ImageColorConvertHelper.convert2sRGB(imgWrapper</span><br><span class="line">                            .getAsPlanarImage(i));</span><br><span class="line">                    imgWrapper.setImage(i, img);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return imgWrapper;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SimpleImageException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ImageReadHelper.read(inStream)：</span><br><span class="line">    public static ImageWrapper read(InputStream input)</span><br><span class="line">            throws SimpleImageException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            input = ImageUtils.createMemoryStream(input);//流拷贝，增加了内存使用</span><br><span class="line"></span><br><span class="line">            if (ImageUtils.isJPEG(input)) &#123;</span><br><span class="line">                return readJPEG(input);//此处耗内存</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ImageUtils.isGIF(input)) &#123;</span><br><span class="line">                return readGIF(input);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return readGeneral(input);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SimpleImageException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由于simpleimage在read及write阶段做了额外操作，使得单次开辟的大对象比方案1的小，但，多次开辟缓冲区，总内存大小反而需要的更多，结合G1内存分配机制，在内存方面与方案1存在相同问题。</p>
<p>3、由于上述2个方案存在的问题及本身需求只是缩放图片而且，也用不上它们提供的水印之类的方法，因此，自定义了一个仅支持图片压缩能力的工具包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public final static ByteArrayOutputStream scale(InputStream srcImageStream, float scale) throws IOException &#123;</span><br><span class="line">        ByteArrayOutputStream desImageStream = new ByteArrayOutputStream();</span><br><span class="line">        BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br><span class="line">        int width = Float.valueOf(scale * originalImage.getWidth()).intValue();</span><br><span class="line">        int height = Float.valueOf(scale * originalImage.getHeight()).intValue();</span><br><span class="line">        BufferedImage newImage = new BufferedImage(width, height, originalImage.getType());</span><br><span class="line">        Graphics g = newImage.getGraphics();</span><br><span class="line">        g.drawImage(originalImage, 0, 0, width, height, null);</span><br><span class="line">        g.dispose();</span><br><span class="line">        ImageIO.write(newImage, &quot;jpeg&quot;, desImageStream);</span><br><span class="line">        return desImageStream;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>   该方案能在压缩质量得到保证的前提的快速完成压缩，约1s，thumbnailator使用时，约2s。<br>    问题来了：功能上去后，发现内存占用率偶尔超过90%，但垃圾回收后又能绝大数回收，（采用G1回收，只额外配置了暂停时间50ms，堆最大值1536M）因此排除内存泄漏的可能，但功能上去之前未曾出现，初步猜测是图片压缩功能引起的（方案1、3都存在问题，推测2也存在），后经本地java visualVM调试发现， 执行一个大小3M多，像素3024*4032的图片压缩时，会有35M多的老年代被直接使用。因此分析问题在于出现了大对象，大对象会直接分配在老年代，于是通过断点测试结合 java visualVM监控，定位到问题在于：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br></pre></td></tr></table></figure></p>
<pre><code>此方法创建BufferedImage时，会基于ComponentSampleModel类首先创建数据缓冲区（dataBuffer），而缓冲区大小算法为：
</code></pre>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">private int getBufferSize() &#123;</span><br><span class="line">      int maxBandOff=bandOffsets[0];//jpeg图片，此数组为&#123;2，1，0&#125;</span><br><span class="line">      for (int i=1; i&lt;bandOffsets.length; i++) &#123;</span><br><span class="line">          maxBandOff = Math.max(maxBandOff,bandOffsets[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      if (maxBandOff &lt; 0 || maxBandOff &gt; (Integer.MAX_VALUE - 1)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid band offset&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (pixelStride &lt; 0 || pixelStride &gt; (Integer.MAX_VALUE / width)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (scanlineStride &lt; 0 || scanlineStride &gt; (Integer.MAX_VALUE / height)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid scanline stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      int size = maxBandOff + 1;</span><br><span class="line">      int val = pixelStride * (width - 1);//pixelStride jpeg图片时，默认为3</span><br><span class="line">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      size += val;</span><br><span class="line">      val = scanlineStride * (height - 1);//scanlineStride jpeg图片时，默认为12096</span><br><span class="line">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid scan stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      size += val;</span><br><span class="line">      return size;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> 因此大小为(2+1)+3*(width-1)+12096*(height-1)  god，这是多大的一个内存呀</span><br><span class="line"> public DataBufferByte(int size, int numBanks) &#123;</span><br><span class="line">     super(STABLE, TYPE_BYTE, size, numBanks);</span><br><span class="line">     bankdata = new byte[numBanks][];</span><br><span class="line">     for (int i= 0; i &lt; numBanks; i++) &#123;</span><br><span class="line">         bankdata[i] = new byte[size];</span><br><span class="line">     &#125;</span><br><span class="line">     data = bankdata[0];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>如果整个逻辑处理时间是1s， 那么，可以算一下1s并发量多大，需要配置多大的内存了 ！！！</p>
<p>附：测试数据<br>方案1：<br><img src="\images\pasted-62.png" alt="upload successful"><br><img src="\images\pasted-63.png" alt="upload successful"><br><img src="\images\pasted-64.png" alt="upload successful"></p>
<p>方案2：<br><img src="\images\pasted-68.png" alt="upload successful"><br><img src="\images\pasted-69.png" alt="upload successful"><br><img src="\images\pasted-70.png" alt="upload successful"><br><img src="\images\pasted-71.png" alt="upload successful"><br><img src="\images\pasted-72.png" alt="upload successful"><br><img src="\images\pasted-73.png" alt="upload successful"><br>方案3：<br><img src="\images\pasted-65.png" alt="upload successful"><br><img src="\images\pasted-66.png" alt="upload successful"><br><img src="\images\pasted-67.png" alt="upload successful"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/10/G1-Evacuation-Failure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/10/G1-Evacuation-Failure/" class="post-title-link" itemprop="url">G1-Evacuation Failure</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-10 11:56:00 / 修改时间：14:27:51" itemprop="dateCreated datePublished" datetime="2019-04-10T11:56:00+08:00">2019-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/爱学爱问/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当没有更多的空闲region被提升到老一代或者复制到幸存空间时，并且由于堆已经达到最大值，堆不能扩展，从而发生Evacuation Failure。对于G1 GC，它是非常耗时的。 </p>
<p> a.对于成功复制的对象，G1需要更新引用，并且该region被一直引用。</p>
<p> b.对于未成功复制的对象，G1将自动转发它们，并保留这些region。</p>
<p>解决方案：</p>
<p>①.不要过度加一些jvm参数。比如-Xmn,这个参数会限制G1的参数的自动扩展。可以仅使用-Xms，-Xmx和暂停时间目标-XX：MaxGCPauseMillis，删除任何额外的堆大小，例如-Xmn，-XX：NewSize，-XX：MaxNewSize，-XX：SurvivorRatio等。</p>
<p>②.如果问题仍然存在，则增加JVM堆大小（即-Xmx）。</p>
<p>③.如果您无法增加堆大小，并且您注意到marking cycle没有足够早地开始回收老一代，那么请减少-XX：InitiatingHeapOccupancyPercent。默认值是45％。减小该值将提前开始marking cycle 。另一方面，如果marking cycle 提前开始并且未收回，请将-XX：InitiatingHeapOccupancyPercent阈值增加到默认值以上。</p>
<p>④.如果并发marking cycle准时开始，但需要很长时间才能完成，那么使用属性’-XX：ConcGCThreads’增加并发标记线程数的数量。默认是GC Workers: 1 ，单线程执行。</p>
<p>⑤.如果有大量“空间耗尽（to-space exhausted）”或“空间溢出（to-space overflow）”GC事件，则增加-XX:G1ReservePercent。默认值是Java堆的10％。注意：G1 GC将此值限制在50％以内。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/10/G1-Humongous-Allocation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/10/G1-Humongous-Allocation/" class="post-title-link" itemprop="url">G1-Humongous Allocation</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-10 11:56:00 / 修改时间：14:27:33" itemprop="dateCreated datePublished" datetime="2019-04-10T11:56:00+08:00">2019-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/爱学爱问/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>它是由’G1 Humongous Allocation’造成的。大型对象（Humongous ）是大于G1中region大小50％的对象。频繁大型对象分配会导致性能问题。如果region里面包含大量的大型对象，则该region中最后一个具有巨型对象的区域与区域末端之间的空间将不会使用。如果有多个这样的大型对象，这个未使用的空间可能导致堆碎片化。直到jdk1.8u40之前，这些巨型对象的回收只在full GC期间完成。在较新的JVM中，对这些对象的清理放在了清理阶段。</p>
<p>解决方案：</p>
<p>①.可以加大region的大小，设置-XX:G1HeapRegionSize=n，但是这个参数需要设置为2的幂次方，最小值是1M，最大值是32M。</p>
<p>②.如果可以的话增加JVM堆大小（即-Xmx -Xms）。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/09/G1垃圾回收器-xx-initiatingheapoccupancypercent变量之问/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/09/G1垃圾回收器-xx-initiatingheapoccupancypercent变量之问/" class="post-title-link" itemprop="url">G1- --xx:initiatingheapoccupancypercent变量之问</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-09 22:24:00" itemprop="dateCreated datePublished" datetime="2019-04-09T22:24:00+08:00">2019-04-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-12 13:49:51" itemprop="dateModified" datetime="2019-04-12T13:49:51+08:00">2019-04-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/爱学爱问/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>问题：该变量究竟何意？<br>官方解释<br><img src="\images\pasted-0.png" alt="upload successful"></p>
<p>疑问：整堆占用率，到底是老年代区域占用整堆比率还是所有区域占用整堆比率？<br>个人认为应该是老年代占用区域<br>原因：<br>1、新生代默认比例为5-60%， 新生代的回收是使用殆尽时，那么，本文讨论的这个变量默认时45%，这两个是用一点冲突的<br>2、工作内存调优时发现gc日志，报出占用率超过45%时，此时更像是老年代超过45%<br>3、工作内存调优过程：<br>mpay堆大小 1500多兆，堆内存使用率预警值90%<br>a、最初时候出现预警时 堆内存占用率时 1500<em>60% + ？ = 1500M左右 即，差不多用光了； 时常预警<br>b、后来调成 1500</em>25% + ？=1000M左右； 没有再预警<br>c、再后来调成 1500*45% + ？ = 1350M左右 很少出现<br>【？】处是老年代的占比，  如果用45%来计算，才能符合我们的现象。</p>
<p>a、 最初时候出现预警时 堆内存占用率时 1500<em>60% + 1500</em>45% ；<br>b、后来调成 1500<em>25% + 1500</em>45%=975M ；<br>c、再后来调成 1500<em>45% + 1500</em>45% = 1350M</p>
<p>附：GC日志记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">2019-04-08T22:58:18.594+0800: 45124.782: [GC pause (G1 Evacuation Pause) (young) 45124.783: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 13273, predicted base time: 26.68 ms, remaining time: 23.32 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45124.783: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 664 regions, survivors: 27 regions, predicted young region time: 15.56 ms]</span><br><span class="line"> 45124.783: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 664 regions, survivors: 27 regions, old: 0 regions, predicted pause time: 42.25 ms, target pause time: 50.00 ms]</span><br><span class="line">, 0.0195542 secs]</span><br><span class="line">   [Parallel Time: 9.5 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45124782.9, Avg: 45124783.1, Max: 45124783.3, Diff: 0.4]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 2.7, Avg: 3.0, Max: 4.5, Diff: 1.8, Sum: 24.3]</span><br><span class="line">      [Update RS (ms): Min: 1.6, Avg: 2.8, Max: 3.4, Diff: 1.8, Sum: 22.3]</span><br><span class="line">         [Processed Buffers: Min: 1, Avg: 15.6, Max: 28, Diff: 27, Sum: 125]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 1.5]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [Object Copy (ms): Min: 2.5, Avg: 2.8, Max: 3.0, Diff: 0.4, Sum: 22.0]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.0]</span><br><span class="line">      [GC Worker Total (ms): Min: 8.6, Avg: 8.9, Max: 9.2, Diff: 0.6, Sum: 71.2]</span><br><span class="line">      [GC Worker End (ms): Min: 45124791.9, Avg: 45124792.0, Max: 45124792.1, Diff: 0.2]</span><br><span class="line">   [Code Root Fixup: 0.3 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.8 ms]</span><br><span class="line">   [Other: 9.0 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 6.2 ms]</span><br><span class="line">      [Ref Enq: 0.4 ms]</span><br><span class="line">      [Redirty Cards: 0.3 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.1 ms]</span><br><span class="line">      [Free CSet: 1.0 ms]</span><br><span class="line">   [Eden: 664.0M(664.0M)-&gt;0.0B(678.0M) Survivors: 27.0M-&gt;13.0M Heap: 1008.6M(1536.0M)-&gt;326.5M(1536.0M)]</span><br><span class="line"> [Times: user=0.09 sys=0.00, real=0.02 secs]</span><br><span class="line"> </span><br><span class="line"> 2019-04-08T22:58:48.854+0800: 45155.043: [GC pause (G1 Evacuation Pause) (young) 45155.043: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 12417, predicted base time: 23.87 ms, remaining time: 26.13 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45155.043: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 678 regions, survivors: 13 regions, predicted young region time: 9.44 ms]</span><br><span class="line"> 45155.043: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 678 regions, survivors: 13 regions, old: 0 regions, predicted pause time: 33.31 ms, target pause time: 50.00 ms]</span><br><span class="line">, 0.0211469 secs]</span><br><span class="line">   [Parallel Time: 12.1 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45155043.0, Avg: 45155043.2, Max: 45155043.3, Diff: 0.3]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 2.1, Avg: 2.5, Max: 3.8, Diff: 1.7, Sum: 20.0]</span><br><span class="line">      [Update RS (ms): Min: 1.1, Avg: 2.1, Max: 2.4, Diff: 1.4, Sum: 16.7]</span><br><span class="line">         [Processed Buffers: Min: 9, Avg: 14.8, Max: 27, Diff: 18, Sum: 118]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.3]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [Object Copy (ms): Min: 6.7, Avg: 6.8, Max: 6.9, Diff: 0.2, Sum: 54.8]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.1, Sum: 0.6]</span><br><span class="line">      [GC Worker Total (ms): Min: 11.5, Avg: 11.7, Max: 11.9, Diff: 0.4, Sum: 93.5]</span><br><span class="line">      [GC Worker End (ms): Min: 45155054.8, Avg: 45155054.8, Max: 45155054.9, Diff: 0.1]</span><br><span class="line">   [Code Root Fixup: 0.2 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.6 ms]</span><br><span class="line">   [Other: 8.3 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 5.7 ms]</span><br><span class="line">      [Ref Enq: 0.6 ms]</span><br><span class="line">      [Redirty Cards: 0.4 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.2 ms]</span><br><span class="line">      [Free CSet: 0.7 ms]</span><br><span class="line">   [Eden: 678.0M(678.0M)-&gt;0.0B(660.0M) Survivors: 13.0M-&gt;31.0M Heap: 1260.8M(1536.0M)-&gt;527.7M(1536.0M)]</span><br><span class="line"> [Times: user=0.11 sys=0.00, real=0.03 secs]</span><br><span class="line"> </span><br><span class="line"> 45189.907: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 713031680 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45189.909: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: requested by GC cause, GC cause: G1 Humongous Allocation]</span><br><span class="line"> 45189.909: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested]</span><br><span class="line">2019-04-08T22:59:23.721+0800: 45189.910: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 45189.910: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 17533, predicted base time: 22.62 ms, remaining time: 27.38 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45189.910: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 625 regions, survivors: 31 regions, predicted young region time: 7.83 ms]</span><br><span class="line"> 45189.910: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 625 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 30.45 ms, target pause time: 50.00 ms]</span><br><span class="line">, 0.0292182 secs]</span><br><span class="line">   [Parallel Time: 17.3 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45189910.8, Avg: 45189911.1, Max: 45189911.4, Diff: 0.6]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 4.0, Avg: 4.2, Max: 4.7, Diff: 0.8, Sum: 33.8]</span><br><span class="line">      [Update RS (ms): Min: 3.6, Avg: 3.6, Max: 3.8, Diff: 0.2, Sum: 29.2]</span><br><span class="line">         [Processed Buffers: Min: 9, Avg: 18.8, Max: 26, Diff: 17, Sum: 150]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.4]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [Object Copy (ms): Min: 7.7, Avg: 7.9, Max: 8.1, Diff: 0.4, Sum: 63.3]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.0]</span><br><span class="line">      [GC Worker Total (ms): Min: 15.7, Avg: 16.1, Max: 16.3, Diff: 0.6, Sum: 128.8]</span><br><span class="line">      [GC Worker End (ms): Min: 45189927.2, Avg: 45189927.2, Max: 45189927.4, Diff: 0.2]</span><br><span class="line">   [Code Root Fixup: 0.4 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.7 ms]</span><br><span class="line">   [Other: 10.9 ms]</span><br><span class="line">      [Choose CSet: 0.1 ms]</span><br><span class="line">      [Ref Proc: 7.0 ms]</span><br><span class="line">      [Ref Enq: 0.5 ms]</span><br><span class="line">      [Redirty Cards: 0.5 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.5 ms]</span><br><span class="line">      [Free CSet: 0.9 ms]</span><br><span class="line">   [Eden: 625.0M(660.0M)-&gt;0.0B(660.0M) Survivors: 31.0M-&gt;31.0M Heap: 1319.5M(1536.0M)-&gt;458.2M(1536.0M)]</span><br><span class="line"> [Times: user=0.14 sys=0.01, real=0.03 secs]</span><br><span class="line"> </span><br><span class="line"> 2019-04-08T22:59:23.751+0800: 45189.939: [GC concurrent-root-region-scan-start]</span><br><span class="line">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-root-region-scan-end, 0.0135482 secs]</span><br><span class="line">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-mark-start]</span><br><span class="line">2019-04-08T22:59:24.042+0800: 45190.231: [GC concurrent-mark-end, 0.2778332 secs]</span><br><span class="line">2019-04-08T22:59:24.045+0800: 45190.233: [GC remark 2019-04-08T22:59:24.045+0800: 45190.233: [Finalize Marking, 0.0013681 secs] 2019-04-08T22:59:24.046+0800: 45190.234: [GC ref-proc, 0.0093594 secs] 2019-04-08T22:59:24.056+0800: 45190.244: [Unloading, 0.0237148 secs], 0.0366644 secs]</span><br><span class="line"> [Times: user=0.21 sys=0.01, real=0.04 secs]</span><br><span class="line">2019-04-08T22:59:24.083+0800: 45190.271: [GC cleanup 506M-&gt;506M(1536M), 0.0063516 secs]</span><br><span class="line"> [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line"> 45199.221: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 708837376 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45199.822: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 732954624 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45199.823: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 734003200 bytes, allocation request: 1048592 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45199.824: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 736100352 bytes, allocation request: 680584 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45207.963: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 737148928 bytes, allocation request: 47775760 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45208.497: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 785383424 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45209.189: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 809500672 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45223.797: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 810549248 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45224.628: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 847249408 bytes, allocation request: 17922544 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line">2019-04-08T22:59:58.442+0800: 45224.630: [GC pause (G1 Humongous Allocation) (young) 45224.630: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 18363, predicted base time: 22.47 ms, remaining time: 27.53 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45224.630: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 660 regions, survivors: 31 regions, predicted young region time: 7.16 ms]</span><br><span class="line"> 45224.630: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 660 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 29.63 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45224.660: [G1Ergonomics (Mixed GCs) start mixed GCs, reason: candidate old regions available, candidate old regions: 187 regions, reclaimable: 102606088 bytes (6.37 %), threshold: 5.00 %]</span><br><span class="line">, 0.0300491 secs]</span><br><span class="line">[Parallel Time: 16.3 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45224630.8, Avg: 45224631.1, Max: 45224631.3, Diff: 0.6]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 2.6, Avg: 2.9, Max: 4.3, Diff: 1.7, Sum: 23.6]</span><br><span class="line">      [Update RS (ms): Min: 3.0, Avg: 3.9, Max: 4.2, Diff: 1.1, Sum: 30.8]</span><br><span class="line">         [Processed Buffers: Min: 11, Avg: 18.0, Max: 26, Diff: 15, Sum: 144]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 1.6]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.2]</span><br><span class="line">      [Object Copy (ms): Min: 8.2, Avg: 8.4, Max: 8.6, Diff: 0.4, Sum: 67.5]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.7]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.4]</span><br><span class="line">      [GC Worker Total (ms): Min: 15.3, Avg: 15.6, Max: 15.9, Diff: 0.6, Sum: 124.6]</span><br><span class="line">      [GC Worker End (ms): Min: 45224646.7, Avg: 45224646.7, Max: 45224646.7, Diff: 0.1]</span><br><span class="line">   [Code Root Fixup: 0.3 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.7 ms]</span><br><span class="line">   [Other: 12.8 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 7.7 ms]</span><br><span class="line">      [Ref Enq: 0.6 ms]</span><br><span class="line">      [Redirty Cards: 1.0 ms]</span><br><span class="line">      [Humongous Register: 0.2 ms]</span><br><span class="line">      [Humongous Reclaim: 0.6 ms]</span><br><span class="line">      [Free CSet: 1.7 ms]</span><br><span class="line">   [Eden: 660.0M(660.0M)-&gt;0.0B(45.0M) Survivors: 31.0M-&gt;31.0M Heap: 1479.4M(1536.0M)-&gt;630.5M(1536.0M)]</span><br><span class="line"> [Times: user=0.15 sys=0.01, real=0.03 secs]</span><br><span class="line"> </span><br><span class="line"> 2019-04-08T22:59:59.121+0800: 45225.309: [GC pause (G1 Evacuation Pause) (mixed) 45225.309: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 2204, predicted base time: 18.27 ms, remaining time: 31.73 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45225.309: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 45 regions, survivors: 31 regions, predicted young region time: 0.76 ms]</span><br><span class="line"> 45225.309: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: reclaimable percentage not over threshold, old: 24 regions, max: 154 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class="line"> 45225.309: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 45 regions, survivors: 31 regions, old: 24 regions, predicted pause time: 22.66 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45225.348: [G1Ergonomics (Mixed GCs) do not continue mixed GCs, reason: reclaimable percentage not over threshold, candidate old regions: 163 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class="line">, 0.0391519 secs]</span><br><span class="line">   [Parallel Time: 25.0 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45225309.4, Avg: 45225309.6, Max: 45225309.7, Diff: 0.3]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 3.9, Avg: 4.4, Max: 5.2, Diff: 1.2, Sum: 35.3]</span><br><span class="line">      [Update RS (ms): Min: 0.0, Avg: 0.6, Max: 0.9, Diff: 0.9, Sum: 4.8]</span><br><span class="line">         [Processed Buffers: Min: 0, Avg: 5.4, Max: 19, Diff: 19, Sum: 43]</span><br><span class="line">      [Scan RS (ms): Min: 0.6, Avg: 0.9, Max: 1.0, Diff: 0.4, Sum: 7.1]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.1, Sum: 0.3]</span><br><span class="line">      [Object Copy (ms): Min: 18.4, Avg: 18.5, Max: 18.8, Diff: 0.5, Sum: 148.4]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.6, Max: 3, Diff: 2, Sum: 13]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.3]</span><br><span class="line">      [GC Worker Total (ms): Min: 24.4, Avg: 24.5, Max: 24.7, Diff: 0.3, Sum: 196.2]</span><br><span class="line">      [GC Worker End (ms): Min: 45225334.1, Avg: 45225334.1, Max: 45225334.1, Diff: 0.0]</span><br><span class="line">   [Code Root Fixup: 0.3 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.9 ms]</span><br><span class="line">   [Other: 13.0 ms]</span><br><span class="line">      [Choose CSet: 0.1 ms]</span><br><span class="line">      [Ref Proc: 9.8 ms]</span><br><span class="line">      [Ref Enq: 0.6 ms]</span><br><span class="line">      [Redirty Cards: 0.7 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.7 ms]</span><br><span class="line">      [Free CSet: 0.3 ms]</span><br><span class="line">   [Eden: 45.0M(45.0M)-&gt;0.0B(685.0M) Survivors: 31.0M-&gt;6144.0K Heap: 732.5M(1536.0M)-&gt;342.3M(1536.0M)]</span><br><span class="line"> [Times: user=0.17 sys=0.01, real=0.04 secs]</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/08/谈一谈锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/08/谈一谈锁/" class="post-title-link" itemprop="url">谈一谈锁</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-08 22:11:18" itemprop="dateCreated datePublished" datetime="2019-04-08T22:11:18+08:00">2019-04-08</time>
            

            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Xiang Chuang</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">51</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/realxc" title="GitHub &rarr; https://github.com/realxc" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/709257360@qq.com@gmail.com" title="E-Mail &rarr; 709257360@qq.com@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiang Chuang</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>



  
  



  
  



  
  







  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/three/three.min.js"></script>

  
  <script src="/lib/three/three-waves.min.js"></script>

  
  <script src="/lib/three/canvas_lines.min.js"></script>

  
  <script src="/lib/three/canvas_sphere.min.js"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
