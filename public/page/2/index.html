<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"realxc.githut.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"搜索文章","hits_empty":"未找到相关文章: ${query}","hits_stats":"找到${hits}篇文章，用时${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="博客园-向闯">
<meta property="og:url" content="http://realxc.githut.io/page/2/index.html">
<meta property="og:site_name" content="博客园-向闯">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Xiang Chuang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://realxc.githut.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>博客园-向闯</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">博客园-向闯</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/05/06/%E5%9B%B4%E7%BB%95dubbo%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%BC%AB%E8%B0%88%E5%BE%AE%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/06/%E5%9B%B4%E7%BB%95dubbo%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%BC%AB%E8%B0%88%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">围绕dubbo底层原理漫谈微服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-06 17:56:00" itemprop="dateCreated datePublished" datetime="2019-05-06T17:56:00+08:00">2019-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%93%E9%A2%98%E7%A0%94%E8%AE%A8/" itemprop="url" rel="index"><span itemprop="name">专题研讨</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>168</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说在前面"><a href="#说在前面" class="headerlink" title="说在前面"></a>说在前面</h2><p>&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li><a href="#partI">XXX</a></li>
<li><a href="#partII">XXX</a></li>
<li><a href="#partIII">XXX</a></li>
<li><a href="#partIV">XXX</a></li>
</ul>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/28/git-%E6%9C%AC%E5%9C%B0commit%E3%80%81push%E3%80%81show%E3%80%81reset%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/28/git-%E6%9C%AC%E5%9C%B0commit%E3%80%81push%E3%80%81show%E3%80%81reset%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">git-本地commit、push、show、reset操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-28 11:06:00" itemprop="dateCreated datePublished" datetime="2019-04-28T11:06:00+08:00">2019-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>问题：<br>使用git commit代码时，git commit完成<br>后续执行git push origin master:master 提示“Everything up-to-date”<br>使用git show查询，确实能看到提交的内容</p>
<p>原因：<br>尝试提交到master，但本地对应的其实是一个分支</p>
<p>解决：<br>切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支</p>
<p>使用git reflog返回如下<br>fb3e1b1 (HEAD -&gt; master) HEAD@{0}: reset: moving to fb3e1b1<br>2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master<br>fb3e1b1 (HEAD -&gt; master) HEAD@{2}: commit: 场景化业务监控模型搭建<br>2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0<br>2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎<br>6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测<br>b28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量<br>ad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中<br>dd0138f HEAD@{10}: commit: hera配置更改<br>29764a1 HEAD@{11}: commit: README<br>75debd5 HEAD@{12}: clone: from <a target="_blank" rel="noopener" href="http://gitlab.yiji/yangxi/godeye.git">http://gitlab.yiji/yangxi/godeye.git</a></p>
<p>再次使用git reset –hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳</p>
<p>$ git reset –hard fb3e1b1<br>HEAD is now at fb3e1b1 场景化业务监控模型搭建</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/11/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9-ImageIO-read-inputStream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/11/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9-ImageIO-read-inputStream/" class="post-title-link" itemprop="url">图片压缩-ImageIO.read(inputStream)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-11 18:36:00" itemprop="dateCreated datePublished" datetime="2019-04-11T18:36:00+08:00">2019-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%99%E4%BA%9B%E5%B9%B4%EF%BC%8C%E9%82%A3%E4%BA%9B%E5%9D%91/" itemprop="url" rel="index"><span itemprop="name">这些年，那些坑</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文可结合链接中的文章从GC层面辅助分析！<br><a target="_blank" rel="noopener" href="https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/">https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/</a></p>
<p>背景：由于目前手机像素越来越富裕，导致用户上传图片时过大3-4M甚至以上，且像素较高，如3024*4032，因此，图片压缩功能就势在必行了。</p>
<p>选型：优先考虑前端压缩，但由于个人对前端无甚兴趣，因此提供了基于java的压缩解决方案。</p>
<p>目前市面上成熟的压缩工具大致为thumbnailator及simpleimage<br>1、thumbnailator<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;net.coobird&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;thumbnailator&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.4.8&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage bufferedImage = Thumbnails.of(input).scale(scale).outputQuality(quality).asBufferedImage();</span><br></pre></td></tr></table></figure><br>  经过使用发现有背景色变红的问题，未着手解决,同时，内存消耗较大</p>
<p>2、simpleimage<br>参见git<br><a target="_blank" rel="noopener" href="https://github.com/alibaba/simpleimage">https://github.com/alibaba/simpleimage</a><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.sun.media&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;jai-codec&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;javax.media&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;jai-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;simpleimage&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;            </span><br></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">File in = new File(&quot;d://04092.jpg&quot;);      //原图片</span><br><span class="line">            ImageWrapper imageWrapper = ImageReadHelper.read(new FileInputStream(in));</span><br><span class="line">            int witdh = imageWrapper.getWidth();</span><br><span class="line">            int height = imageWrapper.getHeight();</span><br><span class="line">            File out = new File(&quot;d://04092-after.jpg&quot;);       //目的图片</span><br><span class="line">            ScaleParameter scaleParam = new ScaleParameter(Float.valueOf(witdh * 0.5f).intValue()</span><br><span class="line">                    , Float.valueOf(height * 0.5f).intValue());</span><br><span class="line">            WriteParameter writeParam = new WriteParameter();</span><br><span class="line"></span><br><span class="line">            FileInputStream inStream = null;</span><br><span class="line">            FileOutputStream outStream = null;</span><br><span class="line">            ImageRender wr = null;</span><br><span class="line">            inStream = new FileInputStream(in);</span><br><span class="line">            outStream = new FileOutputStream(out);</span><br><span class="line">            ImageRender rr = new ReadRender(inStream);</span><br><span class="line">            ImageRender sr = new ScaleRender(rr, scaleParam);</span><br><span class="line">            wr = new WriteRender(sr, outStream, ImageFormat.JPEG, writeParam);</span><br><span class="line"></span><br><span class="line">            wr.render();                            //触发图像处理</span><br></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">WriteRender.render()源码：</span><br><span class="line"> @Override</span><br><span class="line">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (image == null) &#123;</span><br><span class="line">                image = imageRender.render();//此处读取原文件，大对象</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ImageWriteHelper.write(image, stream, outputFormat, param);//写文件，数据缓冲区分段初始化，一个按压缩后图片像素大小生产，外加若干512*512及1024*1024的缓冲区，因此需要更多的内存</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SimpleImageException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ReadRender.render源码， WriteRender中需要首先依赖此类读取原文件</span><br><span class="line">@Override</span><br><span class="line">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ImageWrapper imgWrapper;</span><br><span class="line">            if (inStream == null) &#123;</span><br><span class="line">                throw new SimpleImageException(&quot;No input set&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            imgWrapper = ImageReadHelper.read(inStream);</span><br><span class="line"></span><br><span class="line">            if (tosRGBColorSpace) &#123;</span><br><span class="line">                for (int i = 0; i &lt; imgWrapper.getNumOfImages(); i++) &#123;</span><br><span class="line">                    PlanarImage img = ImageColorConvertHelper.convert2sRGB(imgWrapper</span><br><span class="line">                            .getAsPlanarImage(i));</span><br><span class="line">                    imgWrapper.setImage(i, img);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return imgWrapper;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SimpleImageException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ImageReadHelper.read(inStream)：</span><br><span class="line">    public static ImageWrapper read(InputStream input)</span><br><span class="line">            throws SimpleImageException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            input = ImageUtils.createMemoryStream(input);//流拷贝，增加了内存使用</span><br><span class="line"></span><br><span class="line">            if (ImageUtils.isJPEG(input)) &#123;</span><br><span class="line">                return readJPEG(input);//此处耗内存</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ImageUtils.isGIF(input)) &#123;</span><br><span class="line">                return readGIF(input);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return readGeneral(input);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SimpleImageException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>由于simpleimage在read及write阶段做了额外操作，使得单次开辟的大对象比方案1的小，但，多次开辟缓冲区，总内存大小反而需要的更多，结合G1内存分配机制，在内存方面与方案1存在相同问题。</p>
<p>3、由于上述2个方案存在的问题及本身需求只是缩放图片而且，也用不上它们提供的水印之类的方法，因此，自定义了一个仅支持图片压缩能力的工具包<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public final static ByteArrayOutputStream scale(InputStream srcImageStream, float scale) throws IOException &#123;</span><br><span class="line">        ByteArrayOutputStream desImageStream = new ByteArrayOutputStream();</span><br><span class="line">        BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br><span class="line">        int width = Float.valueOf(scale * originalImage.getWidth()).intValue();</span><br><span class="line">        int height = Float.valueOf(scale * originalImage.getHeight()).intValue();</span><br><span class="line">        BufferedImage newImage = new BufferedImage(width, height, originalImage.getType());</span><br><span class="line">        Graphics g = newImage.getGraphics();</span><br><span class="line">        g.drawImage(originalImage, 0, 0, width, height, null);</span><br><span class="line">        g.dispose();</span><br><span class="line">        ImageIO.write(newImage, &quot;jpeg&quot;, desImageStream);</span><br><span class="line">        return desImageStream;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>   该方案能在压缩质量得到保证的前提的快速完成压缩，约1s，thumbnailator使用时，约2s。<br>    问题来了：功能上去后，发现内存占用率偶尔超过90%，但垃圾回收后又能绝大数回收，（采用G1回收，只额外配置了暂停时间50ms，堆最大值1536M）因此排除内存泄漏的可能，但功能上去之前未曾出现，初步猜测是图片压缩功能引起的（方案1、3都存在问题，推测2也存在），后经本地java visualVM调试发现， 执行一个大小3M多，像素3024*4032的图片压缩时，会有35M多的老年代被直接使用。因此分析问题在于出现了大对象，大对象会直接分配在老年代，于是通过断点测试结合 java visualVM监控，定位到问题在于：<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br></pre></td></tr></table></figure><br>    此方法创建BufferedImage时，会基于ComponentSampleModel类首先创建数据缓冲区（dataBuffer），而缓冲区大小算法为：<br>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private int getBufferSize() &#123;</span><br><span class="line">      int maxBandOff=bandOffsets[0];//jpeg图片，此数组为&#123;2，1，0&#125;</span><br><span class="line">      for (int i=1; i&lt;bandOffsets.length; i++) &#123;</span><br><span class="line">          maxBandOff = Math.max(maxBandOff,bandOffsets[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      if (maxBandOff &lt; 0 || maxBandOff &gt; (Integer.MAX_VALUE - 1)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid band offset&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (pixelStride &lt; 0 || pixelStride &gt; (Integer.MAX_VALUE / width)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (scanlineStride &lt; 0 || scanlineStride &gt; (Integer.MAX_VALUE / height)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid scanline stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      int size = maxBandOff + 1;</span><br><span class="line">      int val = pixelStride * (width - 1);//pixelStride jpeg图片时，默认为3</span><br><span class="line">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      size += val;</span><br><span class="line">      val = scanlineStride * (height - 1);//scanlineStride jpeg图片时，默认为12096</span><br><span class="line">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Invalid scan stride&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      size += val;</span><br><span class="line">      return size;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> 因此大小为(2+1)+3*(width-1)+12096*(height-1)  god，这是多大的一个内存呀</span><br><span class="line"> public DataBufferByte(int size, int numBanks) &#123;</span><br><span class="line">     super(STABLE, TYPE_BYTE, size, numBanks);</span><br><span class="line">     bankdata = new byte[numBanks][];</span><br><span class="line">     for (int i= 0; i &lt; numBanks; i++) &#123;</span><br><span class="line">         bankdata[i] = new byte[size];</span><br><span class="line">     &#125;</span><br><span class="line">     data = bankdata[0];</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure></p>
<p>如果整个逻辑处理时间是1s， 那么，可以算一下1s并发量多大，需要配置多大的内存了 ！！！</p>
<p>附：测试数据<br>方案1：<br><img src="\images\pasted-62.png" alt="upload successful"><br><img src="\images\pasted-63.png" alt="upload successful"><br><img src="\images\pasted-64.png" alt="upload successful"></p>
<p>方案2：<br><img src="\images\pasted-68.png" alt="upload successful"><br><img src="\images\pasted-69.png" alt="upload successful"><br><img src="\images\pasted-70.png" alt="upload successful"><br><img src="\images\pasted-71.png" alt="upload successful"><br><img src="\images\pasted-72.png" alt="upload successful"><br><img src="\images\pasted-73.png" alt="upload successful"><br>方案3：<br><img src="\images\pasted-65.png" alt="upload successful"><br><img src="\images\pasted-66.png" alt="upload successful"><br><img src="\images\pasted-67.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/10/G1-Evacuation-Failure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/10/G1-Evacuation-Failure/" class="post-title-link" itemprop="url">G1-Evacuation Failure</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-10 11:56:00" itemprop="dateCreated datePublished" datetime="2019-04-10T11:56:00+08:00">2019-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>742</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>当没有更多的空闲region被提升到老一代或者复制到幸存空间时，并且由于堆已经达到最大值，堆不能扩展，从而发生Evacuation Failure。对于G1 GC，它是非常耗时的。 </p>
<p> a.对于成功复制的对象，G1需要更新引用，并且该region被一直引用。</p>
<p> b.对于未成功复制的对象，G1将自动转发它们，并保留这些region。</p>
<p>解决方案：</p>
<p>①.不要过度加一些jvm参数。比如-Xmn,这个参数会限制G1的参数的自动扩展。可以仅使用-Xms，-Xmx和暂停时间目标-XX：MaxGCPauseMillis，删除任何额外的堆大小，例如-Xmn，-XX：NewSize，-XX：MaxNewSize，-XX：SurvivorRatio等。</p>
<p>②.如果问题仍然存在，则增加JVM堆大小（即-Xmx）。</p>
<p>③.如果您无法增加堆大小，并且您注意到marking cycle没有足够早地开始回收老一代，那么请减少-XX：InitiatingHeapOccupancyPercent。默认值是45％。减小该值将提前开始marking cycle 。另一方面，如果marking cycle 提前开始并且未收回，请将-XX：InitiatingHeapOccupancyPercent阈值增加到默认值以上。</p>
<p>④.如果并发marking cycle准时开始，但需要很长时间才能完成，那么使用属性’-XX：ConcGCThreads’增加并发标记线程数的数量。默认是GC Workers: 1 ，单线程执行。</p>
<p>⑤.如果有大量“空间耗尽（to-space exhausted）”或“空间溢出（to-space overflow）”GC事件，则增加-XX:G1ReservePercent。默认值是Java堆的10％。注意：G1 GC将此值限制在50％以内。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/10/G1-Humongous-Allocation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/10/G1-Humongous-Allocation/" class="post-title-link" itemprop="url">G1-Humongous Allocation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-10 11:56:00" itemprop="dateCreated datePublished" datetime="2019-04-10T11:56:00+08:00">2019-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>337</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>它是由’G1 Humongous Allocation’造成的。大型对象（Humongous ）是大于G1中region大小50％的对象。频繁大型对象分配会导致性能问题。如果region里面包含大量的大型对象，则该region中最后一个具有巨型对象的区域与区域末端之间的空间将不会使用。如果有多个这样的大型对象，这个未使用的空间可能导致堆碎片化。直到jdk1.8u40之前，这些巨型对象的回收只在full GC期间完成。在较新的JVM中，对这些对象的清理放在了清理阶段。</p>
<p>解决方案：</p>
<p>①.可以加大region的大小，设置-XX:G1HeapRegionSize=n，但是这个参数需要设置为2的幂次方，最小值是1M，最大值是32M。</p>
<p>②.如果可以的话增加JVM堆大小（即-Xmx -Xms）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/" class="post-title-link" itemprop="url">G1- --xx:initiatingheapoccupancypercent变量之问</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-09 22:24:00" itemprop="dateCreated datePublished" datetime="2019-04-09T22:24:00+08:00">2019-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>问题：该变量究竟何意？<br>官方解释<br><img src="\images\pasted-0.png" alt="upload successful"></p>
<p>疑问：整堆占用率，到底是老年代区域占用整堆比率还是所有区域占用整堆比率？<br>个人认为应该是老年代占用区域<br>原因：<br>1、新生代默认比例为5-60%， 新生代的回收是使用殆尽时，那么，本文讨论的这个变量默认时45%，这两个是用一点冲突的<br>2、工作内存调优时发现gc日志，报出占用率超过45%时，此时更像是老年代超过45%<br>3、工作内存调优过程：<br>mpay堆大小 1500多兆，堆内存使用率预警值90%<br>a、最初时候出现预警时 堆内存占用率时 1500<em>60% + ？ = 1500M左右 即，差不多用光了； 时常预警<br>b、后来调成 1500</em>25% + ？=1000M左右； 没有再预警<br>c、再后来调成 1500*45% + ？ = 1350M左右 很少出现<br>【？】处是老年代的占比，  如果用45%来计算，才能符合我们的现象。</p>
<p>a、 最初时候出现预警时 堆内存占用率时 1500<em>60% + 1500</em>45% ；<br>b、后来调成 1500<em>25% + 1500</em>45%=975M ；<br>c、再后来调成 1500<em>45% + 1500</em>45% = 1350M</p>
<p>附：GC日志记录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">2019-04-08T22:58:18.594+0800: 45124.782: [GC pause (G1 Evacuation Pause) (young) 45124.783: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 13273, predicted base time: 26.68 ms, remaining time: 23.32 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45124.783: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 664 regions, survivors: 27 regions, predicted young region time: 15.56 ms]</span><br><span class="line"> 45124.783: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 664 regions, survivors: 27 regions, old: 0 regions, predicted pause time: 42.25 ms, target pause time: 50.00 ms]</span><br><span class="line">, 0.0195542 secs]</span><br><span class="line">   [Parallel Time: 9.5 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45124782.9, Avg: 45124783.1, Max: 45124783.3, Diff: 0.4]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 2.7, Avg: 3.0, Max: 4.5, Diff: 1.8, Sum: 24.3]</span><br><span class="line">      [Update RS (ms): Min: 1.6, Avg: 2.8, Max: 3.4, Diff: 1.8, Sum: 22.3]</span><br><span class="line">         [Processed Buffers: Min: 1, Avg: 15.6, Max: 28, Diff: 27, Sum: 125]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 1.5]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [Object Copy (ms): Min: 2.5, Avg: 2.8, Max: 3.0, Diff: 0.4, Sum: 22.0]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.0]</span><br><span class="line">      [GC Worker Total (ms): Min: 8.6, Avg: 8.9, Max: 9.2, Diff: 0.6, Sum: 71.2]</span><br><span class="line">      [GC Worker End (ms): Min: 45124791.9, Avg: 45124792.0, Max: 45124792.1, Diff: 0.2]</span><br><span class="line">   [Code Root Fixup: 0.3 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.8 ms]</span><br><span class="line">   [Other: 9.0 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 6.2 ms]</span><br><span class="line">      [Ref Enq: 0.4 ms]</span><br><span class="line">      [Redirty Cards: 0.3 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.1 ms]</span><br><span class="line">      [Free CSet: 1.0 ms]</span><br><span class="line">   [Eden: 664.0M(664.0M)-&gt;0.0B(678.0M) Survivors: 27.0M-&gt;13.0M Heap: 1008.6M(1536.0M)-&gt;326.5M(1536.0M)]</span><br><span class="line"> [Times: user=0.09 sys=0.00, real=0.02 secs]</span><br><span class="line"> </span><br><span class="line"> 2019-04-08T22:58:48.854+0800: 45155.043: [GC pause (G1 Evacuation Pause) (young) 45155.043: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 12417, predicted base time: 23.87 ms, remaining time: 26.13 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45155.043: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 678 regions, survivors: 13 regions, predicted young region time: 9.44 ms]</span><br><span class="line"> 45155.043: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 678 regions, survivors: 13 regions, old: 0 regions, predicted pause time: 33.31 ms, target pause time: 50.00 ms]</span><br><span class="line">, 0.0211469 secs]</span><br><span class="line">   [Parallel Time: 12.1 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45155043.0, Avg: 45155043.2, Max: 45155043.3, Diff: 0.3]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 2.1, Avg: 2.5, Max: 3.8, Diff: 1.7, Sum: 20.0]</span><br><span class="line">      [Update RS (ms): Min: 1.1, Avg: 2.1, Max: 2.4, Diff: 1.4, Sum: 16.7]</span><br><span class="line">         [Processed Buffers: Min: 9, Avg: 14.8, Max: 27, Diff: 18, Sum: 118]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.3]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [Object Copy (ms): Min: 6.7, Avg: 6.8, Max: 6.9, Diff: 0.2, Sum: 54.8]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.1, Sum: 0.6]</span><br><span class="line">      [GC Worker Total (ms): Min: 11.5, Avg: 11.7, Max: 11.9, Diff: 0.4, Sum: 93.5]</span><br><span class="line">      [GC Worker End (ms): Min: 45155054.8, Avg: 45155054.8, Max: 45155054.9, Diff: 0.1]</span><br><span class="line">   [Code Root Fixup: 0.2 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.6 ms]</span><br><span class="line">   [Other: 8.3 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 5.7 ms]</span><br><span class="line">      [Ref Enq: 0.6 ms]</span><br><span class="line">      [Redirty Cards: 0.4 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.2 ms]</span><br><span class="line">      [Free CSet: 0.7 ms]</span><br><span class="line">   [Eden: 678.0M(678.0M)-&gt;0.0B(660.0M) Survivors: 13.0M-&gt;31.0M Heap: 1260.8M(1536.0M)-&gt;527.7M(1536.0M)]</span><br><span class="line"> [Times: user=0.11 sys=0.00, real=0.03 secs]</span><br><span class="line"> </span><br><span class="line"> 45189.907: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 713031680 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45189.909: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: requested by GC cause, GC cause: G1 Humongous Allocation]</span><br><span class="line"> 45189.909: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested]</span><br><span class="line">2019-04-08T22:59:23.721+0800: 45189.910: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 45189.910: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 17533, predicted base time: 22.62 ms, remaining time: 27.38 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45189.910: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 625 regions, survivors: 31 regions, predicted young region time: 7.83 ms]</span><br><span class="line"> 45189.910: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 625 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 30.45 ms, target pause time: 50.00 ms]</span><br><span class="line">, 0.0292182 secs]</span><br><span class="line">   [Parallel Time: 17.3 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45189910.8, Avg: 45189911.1, Max: 45189911.4, Diff: 0.6]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 4.0, Avg: 4.2, Max: 4.7, Diff: 0.8, Sum: 33.8]</span><br><span class="line">      [Update RS (ms): Min: 3.6, Avg: 3.6, Max: 3.8, Diff: 0.2, Sum: 29.2]</span><br><span class="line">         [Processed Buffers: Min: 9, Avg: 18.8, Max: 26, Diff: 17, Sum: 150]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.4]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [Object Copy (ms): Min: 7.7, Avg: 7.9, Max: 8.1, Diff: 0.4, Sum: 63.3]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.0]</span><br><span class="line">      [GC Worker Total (ms): Min: 15.7, Avg: 16.1, Max: 16.3, Diff: 0.6, Sum: 128.8]</span><br><span class="line">      [GC Worker End (ms): Min: 45189927.2, Avg: 45189927.2, Max: 45189927.4, Diff: 0.2]</span><br><span class="line">   [Code Root Fixup: 0.4 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.7 ms]</span><br><span class="line">   [Other: 10.9 ms]</span><br><span class="line">      [Choose CSet: 0.1 ms]</span><br><span class="line">      [Ref Proc: 7.0 ms]</span><br><span class="line">      [Ref Enq: 0.5 ms]</span><br><span class="line">      [Redirty Cards: 0.5 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.5 ms]</span><br><span class="line">      [Free CSet: 0.9 ms]</span><br><span class="line">   [Eden: 625.0M(660.0M)-&gt;0.0B(660.0M) Survivors: 31.0M-&gt;31.0M Heap: 1319.5M(1536.0M)-&gt;458.2M(1536.0M)]</span><br><span class="line"> [Times: user=0.14 sys=0.01, real=0.03 secs]</span><br><span class="line"> </span><br><span class="line"> 2019-04-08T22:59:23.751+0800: 45189.939: [GC concurrent-root-region-scan-start]</span><br><span class="line">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-root-region-scan-end, 0.0135482 secs]</span><br><span class="line">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-mark-start]</span><br><span class="line">2019-04-08T22:59:24.042+0800: 45190.231: [GC concurrent-mark-end, 0.2778332 secs]</span><br><span class="line">2019-04-08T22:59:24.045+0800: 45190.233: [GC remark 2019-04-08T22:59:24.045+0800: 45190.233: [Finalize Marking, 0.0013681 secs] 2019-04-08T22:59:24.046+0800: 45190.234: [GC ref-proc, 0.0093594 secs] 2019-04-08T22:59:24.056+0800: 45190.244: [Unloading, 0.0237148 secs], 0.0366644 secs]</span><br><span class="line"> [Times: user=0.21 sys=0.01, real=0.04 secs]</span><br><span class="line">2019-04-08T22:59:24.083+0800: 45190.271: [GC cleanup 506M-&gt;506M(1536M), 0.0063516 secs]</span><br><span class="line"> [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line"> 45199.221: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 708837376 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45199.822: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 732954624 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45199.823: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 734003200 bytes, allocation request: 1048592 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45199.824: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 736100352 bytes, allocation request: 680584 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45207.963: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 737148928 bytes, allocation request: 47775760 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45208.497: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 785383424 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45209.189: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 809500672 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45223.797: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 810549248 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line"> 45224.628: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 847249408 bytes, allocation request: 17922544 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class="line">2019-04-08T22:59:58.442+0800: 45224.630: [GC pause (G1 Humongous Allocation) (young) 45224.630: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 18363, predicted base time: 22.47 ms, remaining time: 27.53 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45224.630: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 660 regions, survivors: 31 regions, predicted young region time: 7.16 ms]</span><br><span class="line"> 45224.630: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 660 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 29.63 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45224.660: [G1Ergonomics (Mixed GCs) start mixed GCs, reason: candidate old regions available, candidate old regions: 187 regions, reclaimable: 102606088 bytes (6.37 %), threshold: 5.00 %]</span><br><span class="line">, 0.0300491 secs]</span><br><span class="line">[Parallel Time: 16.3 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45224630.8, Avg: 45224631.1, Max: 45224631.3, Diff: 0.6]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 2.6, Avg: 2.9, Max: 4.3, Diff: 1.7, Sum: 23.6]</span><br><span class="line">      [Update RS (ms): Min: 3.0, Avg: 3.9, Max: 4.2, Diff: 1.1, Sum: 30.8]</span><br><span class="line">         [Processed Buffers: Min: 11, Avg: 18.0, Max: 26, Diff: 15, Sum: 144]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 1.6]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.2]</span><br><span class="line">      [Object Copy (ms): Min: 8.2, Avg: 8.4, Max: 8.6, Diff: 0.4, Sum: 67.5]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.7]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.4]</span><br><span class="line">      [GC Worker Total (ms): Min: 15.3, Avg: 15.6, Max: 15.9, Diff: 0.6, Sum: 124.6]</span><br><span class="line">      [GC Worker End (ms): Min: 45224646.7, Avg: 45224646.7, Max: 45224646.7, Diff: 0.1]</span><br><span class="line">   [Code Root Fixup: 0.3 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.7 ms]</span><br><span class="line">   [Other: 12.8 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 7.7 ms]</span><br><span class="line">      [Ref Enq: 0.6 ms]</span><br><span class="line">      [Redirty Cards: 1.0 ms]</span><br><span class="line">      [Humongous Register: 0.2 ms]</span><br><span class="line">      [Humongous Reclaim: 0.6 ms]</span><br><span class="line">      [Free CSet: 1.7 ms]</span><br><span class="line">   [Eden: 660.0M(660.0M)-&gt;0.0B(45.0M) Survivors: 31.0M-&gt;31.0M Heap: 1479.4M(1536.0M)-&gt;630.5M(1536.0M)]</span><br><span class="line"> [Times: user=0.15 sys=0.01, real=0.03 secs]</span><br><span class="line"> </span><br><span class="line"> 2019-04-08T22:59:59.121+0800: 45225.309: [GC pause (G1 Evacuation Pause) (mixed) 45225.309: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 2204, predicted base time: 18.27 ms, remaining time: 31.73 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45225.309: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 45 regions, survivors: 31 regions, predicted young region time: 0.76 ms]</span><br><span class="line"> 45225.309: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: reclaimable percentage not over threshold, old: 24 regions, max: 154 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class="line"> 45225.309: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 45 regions, survivors: 31 regions, old: 24 regions, predicted pause time: 22.66 ms, target pause time: 50.00 ms]</span><br><span class="line"> 45225.348: [G1Ergonomics (Mixed GCs) do not continue mixed GCs, reason: reclaimable percentage not over threshold, candidate old regions: 163 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class="line">, 0.0391519 secs]</span><br><span class="line">   [Parallel Time: 25.0 ms, GC Workers: 8]</span><br><span class="line">      [GC Worker Start (ms): Min: 45225309.4, Avg: 45225309.6, Max: 45225309.7, Diff: 0.3]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 3.9, Avg: 4.4, Max: 5.2, Diff: 1.2, Sum: 35.3]</span><br><span class="line">      [Update RS (ms): Min: 0.0, Avg: 0.6, Max: 0.9, Diff: 0.9, Sum: 4.8]</span><br><span class="line">         [Processed Buffers: Min: 0, Avg: 5.4, Max: 19, Diff: 19, Sum: 43]</span><br><span class="line">      [Scan RS (ms): Min: 0.6, Avg: 0.9, Max: 1.0, Diff: 0.4, Sum: 7.1]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.1, Sum: 0.3]</span><br><span class="line">      [Object Copy (ms): Min: 18.4, Avg: 18.5, Max: 18.8, Diff: 0.5, Sum: 148.4]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.6, Max: 3, Diff: 2, Sum: 13]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.3]</span><br><span class="line">      [GC Worker Total (ms): Min: 24.4, Avg: 24.5, Max: 24.7, Diff: 0.3, Sum: 196.2]</span><br><span class="line">      [GC Worker End (ms): Min: 45225334.1, Avg: 45225334.1, Max: 45225334.1, Diff: 0.0]</span><br><span class="line">   [Code Root Fixup: 0.3 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.9 ms]</span><br><span class="line">   [Other: 13.0 ms]</span><br><span class="line">      [Choose CSet: 0.1 ms]</span><br><span class="line">      [Ref Proc: 9.8 ms]</span><br><span class="line">      [Ref Enq: 0.6 ms]</span><br><span class="line">      [Redirty Cards: 0.7 ms]</span><br><span class="line">      [Humongous Register: 0.1 ms]</span><br><span class="line">      [Humongous Reclaim: 0.7 ms]</span><br><span class="line">      [Free CSet: 0.3 ms]</span><br><span class="line">   [Eden: 45.0M(45.0M)-&gt;0.0B(685.0M) Survivors: 31.0M-&gt;6144.0K Heap: 732.5M(1536.0M)-&gt;342.3M(1536.0M)]</span><br><span class="line"> [Times: user=0.17 sys=0.01, real=0.04 secs]</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/08/%E8%B0%88%E4%B8%80%E8%B0%88%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/08/%E8%B0%88%E4%B8%80%E8%B0%88%E9%94%81/" class="post-title-link" itemprop="url">谈一谈锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-08 22:11:18" itemprop="dateCreated datePublished" datetime="2019-04-08T22:11:18+08:00">2019-04-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/04/08/%E6%B5%85%E8%B0%88JVM%E4%B9%8B%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/08/%E6%B5%85%E8%B0%88JVM%E4%B9%8B%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="post-title-link" itemprop="url">java对象的诞生与消亡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-08 16:54:00" itemprop="dateCreated datePublished" datetime="2019-04-08T16:54:00+08:00">2019-04-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%93%E9%A2%98%E7%A0%94%E8%AE%A8/" itemprop="url" rel="index"><span itemprop="name">专题研讨</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说在前面"><a href="#说在前面" class="headerlink" title="说在前面"></a>说在前面</h2><p>&emsp;&emsp;本文将从java对象的角度出发，探讨java应用运行过程中“对象”从诞生到消亡的生命历程，结合jvm的相关技术方案简要阐述各个环节的实现细节。需要指出的是，本文旨在阐述清楚“对象”的生命周期，对于jvm（本文基于HotSpot虚拟机）相关技术的深层次原理只会点到为止（能描述清“对象”的生命周期即可），后续将会在其他文章中单独罗列出各个主题进行深入剖析。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li><a href="#partI">java内存区域</a></li>
<li><a href="#partII">java对象</a></li>
<li><a href="#partIII">垃圾回收</a></li>
<li><a href="#partIV">内存调优</a></li>
</ul>
<hr>
<h2 id="java内存区域"><a href="#java内存区域" class="headerlink" title="java内存区域"></a>java内存区域</h2><p>&emsp;&emsp;java对象生存的载体-运行时数据区，虚拟机中数据区大致包含如下图所示的几个区域：<br><img src="\images\pasted-74.png" alt="upload successful"><br>1、程序计数器<br>&emsp;&emsp;当前线程所执行的字节码的行号指示器，标识执行到的节点，这是一块较小的内存空间。由于任何时刻，一个处理器（多核处理器中的某一核）只会执行一个线程中的指令，因此，每个线程都有一个独立、私有的程序计数器。此区域（唯一一个）在java虚拟机规范中没有规定任何OOM的情况。<br>2、虚拟机栈<br>&emsp;&emsp;其生命周期与线程相同，方法在执行时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息，每一个方法的调用就是相应栈帧在虚拟机栈中入栈和出栈的过程。<br>局部变量表：存放编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（指向对象起始地址的引用指针-HotSpot方案、或者指向一个代表对象的句柄或其他与此对象相关的位置）、returnAddress类型（执行一条字节码指令的地址）。其中，除long和double占用2个局部变量空间（Slot）外，其余只占用1个Slot。局部变量表所需内存空间在编译期间完成分配，运行期间不会改变大小，即，进入一个方法时，栈帧中所需分配的局部变量空间是确定的。java虚拟机规范对此区域规定了两类异常情况，1是线程请求的栈深度大于虚拟机所允许的深度时抛出StackOverflowError，2是可动态扩展的虚拟机栈扩展时无法申请到足够的内存时抛出OOM。<br>3、本地方法栈<br>&emsp;&emsp;HotSpot将其与虚拟机栈合二为一。它是为虚拟机所使用到的Native方法服务。它可能抛出的异常与虚拟机栈一致。<br>4、堆<br>&emsp;&emsp;此区域用于存放对象的实例。java虚拟机规范原文：The heap is the runtime data area from which memory for all class instances and arrays is allocated.此区域会抛出OOM异常。由于这个区域存分的是对象实例且是线程共享区域，因此在后续的内容中将以此为核心进行讲述。<br>5、方法区（HotSpot，jdk8之后已由元空间取代）<br>&emsp;&emsp;该区域用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，为了与java堆区分开来，java虚拟机规范为其命了一个别名Non-Heap。该区域会抛出OOM。<br>6、运行时常量池<br>&emsp;&emsp;方法区的一部分，Clas文件中除了由类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译期生产的各种字面量和符号引用。除了编译期间会产生常量，java允许运行期间产生常量并存放到运行时常量池中，如String.intern()。该区域是方法区的一部分，因此申请不到内存时也会抛出OOM。<br>7、直接内存<br>&emsp;&emsp;它不属于虚拟机运行时数据区的一部分，但其也可能出现OOM，且使用频繁（如NIO类，引入了基于通道（Channel）与缓冲区（Buffer）的I/O方式，可使用Native函数直接分配堆外内存，然后通过一个存储在java堆中的DirectByteBuffer对象作为这块内存的引用进行操作，这样避免了在java堆与Native堆中来回复制数据从而提升了性能）。该区域使用超过机器内存等限制时会抛出OOM。<br>8、元空间<br>&emsp;&emsp;如示意图中所述，HotSpot在jdk8（含）之后，已经移除了老年代（方法区），转由元空间（metaspace）实现，即本地内存Native Memory。<br>&emsp;&emsp;至于为什么使用本地内存替换永久代，官网有如此描述：This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.<br>&emsp;&emsp;具体移除细节，官网由如此描述：The proposed implementation will allocate class meta-data in native memory and move interned Strings and class statics to the Java heap.<br>&emsp;&emsp;详细信息参见官网地址<a target="_blank" rel="noopener" href="http://openjdk.java.net/jeps/122">http://openjdk.java.net/jeps/122</a></p>
<hr>
<h2 id="java对象"><a href="#java对象" class="headerlink" title="java对象"></a>java对象</h2><p>&emsp;&emsp;前面聊完java对象身存的载体的具体结构，下面我们聊一聊java对象本身的一些事，需要说明的的是，此处是基于HotSpot探讨java对象在堆空间上实例的创建、布局以及访问。<br>1、对象的创建<br>&emsp;&emsp;从语言层面来讲，java对象的创建就是一个new关键字，当应用运行时，虚拟机遇到一条new指令，将进行如下操作：<br>&emsp;&emsp;##检查类的加载：检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载、解析和初始化。<br>&emsp;&emsp;##分配内存：java堆内存是否规整决定了如何分配内存，规整的内存，采用“指针碰撞”（Bump the Pointer），即从已用内存和空闲内存的指针分界点开始向空闲内存移动与对象大小相等的距离即可；如何内存不规整，则需要维护空闲列表（Free List），分配时从列表中选择足够大的空间划分给对象的实例。java堆是否规整与垃圾采集器是否带有压缩整理功能有关，如使用Serial、ParNew这种带Compact过程的收集器时采用指针碰撞，使用CMS这种基于Mark-Sweep算法的收集器时采用空闲列表。另外一个需要考虑的问题是线程安全，解决这个问题有两种方案，1是采用CAS保证原子性；2是为每个线程在java堆中预先分配一小块，即本地线程分配缓冲（TLAB），只需在分配新的TLAB时进行同步锁定，-XX：+/-UseTLAB。<br>&emsp;&emsp;##初始化为0值：此处不包括对象头，这个操作保证了对象的实例可以不赋初始值即可使用。<br>&emsp;&emsp;##对象头信息设置：对象头中包含如，这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄、锁等信息。<br>&emsp;&emsp;##初始化（执行<init>方法）：一般来说，执行new指令之后会接着执行<init>方法（由字节码中是否跟随invokespecial指令决定），从而，一个真正可以使用的对象诞生。<br>2、对象的内存布局<br>&emsp;&emsp;HotSpot中，对象在内存中存储的布局分为3部分：对象头（Header）、实例数据（Instance Data）以及对齐填充（Padding）。<br>&emsp;&emsp;##对象头：对象头包含两部分，1是用于存储对象自身的运行时数据Mark Work，在32位和64位的虚拟机中分别占32bit、64bit,包含信息如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向锁线程ID、偏向时间戳等。eg：32位未锁定状态的对象，25bit用于存储对象哈希码、4bit用于存储对象分代年龄、2bit用于存储锁标识位，1bit固定为0；2是类型指针，即对象指向它的类元数据的指针；对于数组来说，对象头还需有一块用于记录数组长度的数据从而确定数组的大小。<br>&emsp;&emsp;##实例数据：HotSpot默认的分配策略为longs/doubles、ints、shorts/chars、bytes/boolean、oops（Oddinary Pointers），相同宽度的字段被分配在一起，父类定义的变量位于子类变量之前（如果CompactFields=true，子类较窄的变量也可能插入到父类变量的空隙中）。<br>&emsp;&emsp;##对齐填充：HotSpot要求对象起始地址必须是8字节的整数倍，对象头正好符合，因此对象实例数据可用对齐填充来补全。<br>3、对象的访问定位<br>&emsp;&emsp;java程序需要通过栈上的reference数据来操作堆上的具体对象。<br>&emsp;&emsp;##使用句柄访问：reference中存储的是对象的句柄地址，句柄中包含了对象实例数据与类型数据各自的具体地址，此方式，java堆划分出特定的内存作为句柄池。对象的定位需要两次指针定位，1次找到句柄、另1次找到具体的对象，好处则在于垃圾回收后，对象并移动，不用更改reference中的地址，只需更改句柄池中对应的地址。<br>&emsp;&emsp;##使用直接指针访问：reference中存储的是对象地址。对象的定位一次就能找到，提升了性能，HotSpot采用此方案。<br>4、对象的存活<br>&emsp;&emsp;前一部分提到，java程序通过栈上的reference数据操作堆上的对象，被操作的对象称之为被引用。对象是否存活与其是否尚被引用有关，那么我们首先来谈一谈引用。<br>&emsp;&emsp;引用可分为强引用（Strong Reference）、软引用（Soft Reference）、弱引用（Weak Reference）、虚引用（Phantom Reference）。<br>&emsp;&emsp;##强引用：类似于赋值语句那种，垃圾回收器不会回收被引用对象<br>&emsp;&emsp;##软引用：jdk提供了SoftReference类实现软引用，指一些有用但并非必须的对象，系统OOM之前会回收此类对象<br>&emsp;&emsp;##弱引用：jdk提供了WeakReference类实现弱引用，下一次GC时回收此类对象<br>&emsp;&emsp;##虚引用：jdk提供了PhantomReference类实现虚引用，也称之为幽灵引用，对象是否存在虚引用对其本身无任何影响，且无法通过虚引用获得一个对象实例，因此，为对象设置一个虚引用的唯一目的是该对象被回收时收到一个系统通知<br>&emsp;&emsp;下面来谈谈判断对象是否存活的两类算法：<br>&emsp;&emsp;引用计数算法：给对象添加一个引用计算器，值为0时代表对象可回收，但，对于循环依赖来说，这似乎是个问题<br>&emsp;&emsp;可达性分析算法：以一系列被称为GC Roots的对象（虚拟机栈即栈帧中本地变量表中引用的对象；方法区中类静态属性引用的对象；方法区中常量引用的对象；本地方法栈中JNI引用的对象）为起点进行搜索，判断对象是否有引用链到达GC Roots，如果没有，代表对象可回收。<br>&emsp;&emsp;需要说明的是，利用可达性分析出不可达的对象，并不一定会立即回收，因为进行标记时会做一次筛选（条件是对象是否有必要执行finalize(),如果对象没有覆盖此方法或此方法被执行过一次，则不必要，否则会把此类对象放入一个F-Queue队列中由虚拟机自建一个低优先级的Finalizer线程去执行，为了避免执行缓慢，其并不会等待执行结果）。  </p>
<hr>
<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>&emsp;&emsp;再谈对象创建之内存分配<br>&emsp;&emsp;这是一个及其重要的环节，且，根据垃圾回收机制的不同而有所差别，在聊垃圾回收之前，我想有必要就这点多说几句。<br>&emsp;&emsp;##对象优先分配在Eden区域，即年轻代<br>&emsp;&emsp;##大对象直接分配在老年代，需要说明的是何为大对象，不同收集器定义的不一样，Serial及ParNew收集器采用参数-XX:PretenureSizeThreshold指定，G1则默认为大于区域region大小一半的对象<br>&emsp;&emsp;##长期存活的对象进入老年代，一般默认为熬过15次年轻代回收的对象，该值可以调整，具体参数名根据收集器的约定而定。另外，如果Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于等于该年龄的对象直接进入老年代（针对Serial及ParNew）<br>&emsp;&emsp;##空间分配担保：只要老年代的连续空间大于新生代对象总大小或历次晋升的平局大小则进行MinorGC，否则进行Full GC（针对Serial及ParNew）<br>&emsp;&emsp;前面大概聊了一下虚拟机内存区域以及java对象本身的那点事，这是一个java开发者必备的基础知识，因为你不仅仅应该知道Object obj = new Object（），你更应该清楚java对象究竟是如何诞生的，JVM在这里面做了什么，另一方面，你还应该清楚JVM又是如何替我们清理那些不再被引用的对象。<br>&emsp;&emsp;首先，我们来简单聊聊垃圾收集算法：<br>&emsp;&emsp;标记-清除（Mark-Sweep）算法：顾名思义，它包含两步，一是标记需要回收的对象，二是清除被标记的对象。但有两个明显的问题是，标记和清除两个环节效率都不高，其次，直接清除会导致内存碎片，这将导致大对象无法找到足够大小的连续空间来分配，从而提前下一次GC。<br>&emsp;&emsp;复制（Copying）算法：将内存划分为几块，当一块内存用完后，把存活的对象移动至另一块，再把当前块已使用的空间一性清理掉。但这会导致预留的那部分空间分配时不能用。如HotSpot实现为，将内存分为Eden和两个Survivor，Eden：Survivro为8：1，即预留了10%的空间。需要指出的是，如果对象生命周期长，那么预留的空间也许会出现不够用，这时便需要其他内存进行分配担保（Handle Promotion），这里指的是老年代内存。因为需要额外的空间做担保，那么此算法不适合老年代回收。<br>&emsp;&emsp;标记-整理（Mark-Compact）算法：完成标记后，让所有存活的对象向一端移动，然后直接清理掉端边界之外的内存。<br>&emsp;&emsp;最后要说明的是，当前的商业虚拟机采用分代收集，即区分新生代和老年代，根据其不同特点搭配不通的垃圾收集算法，如年轻代使用复制算法，老年代使用标记-清除算法或标记-整理算法。<br>&emsp;&emsp;HotSpot实现垃圾回收简介：<br>&emsp;&emsp;##进行对象可达性分析时，要考虑一致性问题，因为对象的引用随着应用线程的运行不停的变更着，因此需要STW，由于STW对应用线程影响很大，各种垃圾回收器中对此做了通盘的考虑，但即使如CMS这种号称不会STW的收集器也无法避免枚举根节点时的GC停顿。另外，HotSpot设计了基于OopMap的数据结构来记录对象的引用以提升效率。<br>&emsp;&emsp;安全点：为指令生产OopMap需要大量额外的空间，因此，HotSpot设计中并没为每条指令生成OopMap，只是在一些成为安全点的特定位置记录这些信息，即，只有当线程进入到安全点时才能暂停下来开始GC。安全点的选定是有讲究的，不可过多也不可过少，所以基本考虑在长时间执行的部分设置安全点，如方法调用、循环跳转、异常跳转等。对于线程在安全点如何停下来的问题，有两种手段，一是抢先式中断、二是主动式中断。HotSpot选择后者，即，GC设置中断标识，用户线程主动轮询是否需要中断，轮询标志的地方和安全点重合。<br>&emsp;&emsp;安全区域：对于某些暂时未分配到CUP时间的线程，如其处于Sleep或Blocked状态，JVM不可能瞎等其得到CPU时间后跑到安全点，因此提供了安全区域解决该问题。安全区域中，引用关系不会发生变化，线程进去安全区域时会标识自己已进入，离开时，需要判断系统是否已经完成了根节点枚举或者整个GC过程，没有完成时需等待接收可以离开的信号。<br>&emsp;&emsp;接下来我们来聊聊HotSpot定义的垃圾回收器，这是一个重要的话题，也是日常开发中我们最直接面对的课题，先上一个总图（这里代表的是jdk11之前的垃圾回收器，因为在jdk11中，oracle推出了号称很强大很强大的ZGC，支持TB级的内存回收及单次GC暂停时间低于10ms，目前未使用到该版本的jdk，也尚未对此回收器做研究）<br><img src="\images\pasted-80.png" alt="upload successful"><br>&emsp;&emsp;##Serial收集器：单线程收集器，进行垃圾回收时需暂停其他所有线程，直到收集结束。比较老的收集器了，适用于Client模式的应用。采用复制算法<br><img src="\images\pasted-82.png" alt="upload successful"><br>&emsp;&emsp;##ParNew收集器：Serial的多线程版本，默认开启的收集线程数与CPU的数量相同，可通过参数-XX:ParallelGCThreads控制。采用复制算法<br><img src="\images\pasted-84.png" alt="upload successful"><br>&emsp;&emsp;##Serial Old收集器：其可作为Serial、ParNew及Parallel Scavenge的老年代收集器，同时，当CMS收集发生Concurrent Model Failure时，会使用Serail Old进行Full GC。采用标记-整理算法<br><img src="\images\pasted-82.png" alt="upload successful"><br>&emsp;&emsp;##Parallel Scavenge收集器：更加关注吞吐量，即追求最大吞吐量，适用于那些需要大量计算的应用。使用参数-XX:MaxGCPauseMillis控制停顿时间，参数-XX:GCTimeRatio控制吞吐量（如默认99，即1/（1+99）为GC占CPU时间），开关参数-XX:UseAdaptiveSizePolicy打开后即开启了GC自适应调节策略，无需指定年轻代大小、Survivor大小或晋升老年代对象大小。采用复制算法<br><img src="\images\pasted-85.png" alt="upload successful"><br>&emsp;&emsp;##Parallel Old收集器：于jdk1.6开始提供，作为Parallel Scavenge的老年代收集器。采用标记-整理算法<br><img src="\images\pasted-85.png" alt="upload successful"><br>&emsp;&emsp;##CMS收集器：更加关注暂停时间，即追求最短暂停时间。其大概包含4个步骤，初始标记、并发标记、重新标记、并发清除，其中，初始标记主要是标记GC Roots能直接关联到的对象，这是一个很快的过程，需要STW，并发标记根据初始标记结果遍历上述对象所引用的对象，这个过程耗时较长但能与用户线程并行执行，重新标记则是修正并发标记过程中用户线程导致的变动，相对并发标记来说耗时是比较短的，需要STW，最后，并发清除也能与用户线程并行执行。需要指出的是，CMS存在一定的缺点，1是其对CPU资源很敏感，比如其并发阶段是占用了CPU资源（即用户线程占用CPU时间会减少），默认线程数为（CPU数量+3）/4；2是其无法处理浮动垃圾（Floating Garbage），导致会出现Concurrent Mode Failure，从而引起Full GC，引起的原因在于并发清理阶段用户线程的运行会产生新的垃圾需下一次GC才可处理，因此CMS开始回收的阈值为默认92%，避免浮动垃圾导致内存不够用而引起Full GC（这时会临时启用Serial Old回收老年代）；3是其基于标记-清除算法，意味着存在内存碎片，那么碎片过多会导致大对象无法分配而导致Full GC，因此有一个开关参数-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理（这是很耗时的）。采用标记-清除算法<br><img src="\images\pasted-86.png" alt="upload successful"><br>&emsp;&emsp;##G1收集器：在暂停时间于吞吐量中权衡。采用G1回收器意味着java堆内存布局与其他回收器将有很大的不同，其将堆分成多个（默认2048个）大小相等的region区域（1M-32M）。注意，超过区域大小一半的对象被视为巨型对象直接分配在老年代。同时，G1维护了一个优先列表用于标识回收各区域的价值大小，从而做到了可预测停顿。同时为了避免全堆扫描对象引用，G1提供了Remembered Set用以维护对象的引用。G1回收大致包含如下4个步骤，初始标记、并发标记、最终标记及筛选回收，各步骤的大致功能与CMS类似。整体来看采用标记-整理算法，局部（region之间）来看采用了复制算法。<br><img src="\images\pasted-87.png" alt="upload successful"></p>
<hr>
<h2 id="内存调优"><a href="#内存调优" class="headerlink" title="内存调优"></a>内存调优</h2><p>&emsp;&emsp;前面已经讲述了对象的诞生与消亡，在实际的工作中，我们日常开发或许并没有过多关注于这些细节，但有一项是我们时常直接接触到的，即，在应用内存使用不正常、应用运行慢时，我们往往会想到是否存在内存使用上的问题，并想办法进行内存调优。内存调优，它没有一个统一的解决方案，只能说其有相同的调优原则，再结合应用的实际情况针对性的优化，因此，要谈内存调优，更好的方式是从案例入手，在案例中阐述问题分析的过程，如何定位到内存上的问题，又如何进行针对性的调优。本博客中有相关案例，可参考<a target="_blank" rel="noopener" href="https://realxc.github.io/tags/JVM/">https://realxc.github.io/tags/JVM/</a><br>&emsp;&emsp;作为本篇文章的结尾，下面简单介绍一下我们常用的ParNew、CMS、G1回收器的常用且重要的参数配置：<br>ParNew：<br>&emsp;&emsp;-XX:SurvivorRatio=8(默认)中年代占比1：8 sur：eden<br>&emsp;&emsp;-XX:PretenureSizeThreshold 直接晋升到老年代的对象大小<br>&emsp;&emsp;-XX:NewRatio=4(默认) 年轻代和老年代比例<br>CMS<br>&emsp;&emsp;-XX:CMSInitiatinOccupancyFraction=92 老年代达到92%时回收<br>&emsp;&emsp;-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理<br>&emsp;&emsp;-XX:UseConcMarkSweepGC<br>G1<br>&emsp;&emsp;-XX:+UseG1GC<br>&emsp;&emsp;-XX:MaxGCPauseMillis=n 单次GC暂停时间，默认200ms<br>&emsp;&emsp;-XX:InitiatingHeapOccupancyPercent=n mix gc触发时间，老年代已使用空间占用整堆内存比例，默认45（很多人理解为整堆已使用空间占整堆比例，这是错误的）<br>&emsp;&emsp;-XX:MaxTenuringThreshold=n 年轻代最大年龄，默认15<br>&emsp;&emsp;-XX:G1ReservePercent=n 预留空间大小，避免空间被使用完而导致Full GC<br>&emsp;&emsp;-XX:G1HeapRegionSize=n 区域大小，1-32（M）<br>&emsp;&emsp;-XX:G1NewSizePercent=5 默认为5，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75<br>&emsp;&emsp;-XX:G1MaxNewSizePercent=60 默认为60，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75</p>
<hr>
<p>参考参数（jdk8）：<br>(G1): -XX:+UseG1GC -XX:MaxGCPauseMillis=50（自定义） -Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:LargePageSizeInBytes=128m（自定义） -XX:+ParallelRefProcEnabled -XX:+PrintAdaptiveSizePolicy -XX:+UseFastAccessorMethods -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000  -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof</p>
<hr>
<p>(CMS):-Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:SurvivorRatio=8（自定义） -XX:NewRatio=4（自定义） -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m（自定义） -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70（自定义） -XX:+UseParNewGC -XX:MaxTenuringThreshold=5（自定义） -XX:+CMSClassUnloadingEnabled -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000 -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof</p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a><br><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock">https://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock</a></p>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/03/07/dubbo-%E5%9F%BA%E4%BA%8Ezookeeper%E7%9A%84%E6%B3%A8%E5%86%8C%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/07/dubbo-%E5%9F%BA%E4%BA%8Ezookeeper%E7%9A%84%E6%B3%A8%E5%86%8C%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">dubbo-基于zookeeper的注册结构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-07 15:25:00" itemprop="dateCreated datePublished" datetime="2019-03-07T15:25:00+08:00">2019-03-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%88%B1%E5%AD%A6%E7%88%B1%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">爱学爱问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="\images\pasted-49.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://realxc.githut.io/2019/01/18/druid%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%88%9B%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiang Chuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客园-向闯">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/18/druid%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%88%9B%E5%BB%BA/" class="post-title-link" itemprop="url">druid连接的获取与创建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-18 19:49:00" itemprop="dateCreated datePublished" datetime="2019-01-18T19:49:00+08:00">2019-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-30 15:34:10" itemprop="dateModified" datetime="2019-09-30T15:34:10+08:00">2019-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%99%E4%BA%9B%E5%B9%B4%EF%BC%8C%E9%82%A3%E4%BA%9B%E5%9D%91/" itemprop="url" rel="index"><span itemprop="name">这些年，那些坑</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>326</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>背景：服务器闪断时，druid连接池获取异常，且重试时间较长<br>经分析原因如下：<br>1、应用申请连接时，传入允许等待时间为10S<br>2、由于服务器闪断，瞬时出现部分线程A申请连接时，连接池中无空闲连接，因此A发出创建请求并等待（创建完成及返回连接，否则等待10s后返回失败）<br>3、线程A触发创建连接的线程，开始创建连接，此时可能创建失败，会30S后重新尝试创建<br>4、线程A同时会触发守护线程等待的信号量，守护线程接收到创建连接的信号量，也会开始创建连接，此时可能创建失败，会30S后重新尝试创建</p>
<p>影响：<br>如果业务量不大，创建连接慢（或者创建失败），会引起部分线程执行慢<br>如果业务量过大，且创建连接慢（或者创建失败），会导致线程积压从而导致内存消耗殆尽引起应用假死</p>
<p><img src="\images\pasted-75.png" alt="upload successful"></p>
<p>别人画的图：</p>
<p><img src="\images\pasted-76.png" alt="upload successful"><br><img src="\images\pasted-77.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xiang Chuang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/realxc/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;realxc&#x2F;" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiang Chuang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">119k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:48</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
