{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/local-search.js","path":"js/local-search.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/anime.min.js","path":"lib/anime.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":1,"renderable":1},{"_id":"source/images/pasted-0.png","path":"images/pasted-0.png","modified":1,"renderable":0},{"_id":"source/images/pasted-1.png","path":"images/pasted-1.png","modified":1,"renderable":0},{"_id":"source/images/pasted-10.png","path":"images/pasted-10.png","modified":1,"renderable":0},{"_id":"source/images/pasted-100.png","path":"images/pasted-100.png","modified":1,"renderable":0},{"_id":"source/images/pasted-101.png","path":"images/pasted-101.png","modified":1,"renderable":0},{"_id":"source/images/pasted-102.png","path":"images/pasted-102.png","modified":1,"renderable":0},{"_id":"source/images/pasted-103.png","path":"images/pasted-103.png","modified":1,"renderable":0},{"_id":"source/images/pasted-104.png","path":"images/pasted-104.png","modified":1,"renderable":0},{"_id":"source/images/pasted-105.png","path":"images/pasted-105.png","modified":1,"renderable":0},{"_id":"source/images/pasted-106.png","path":"images/pasted-106.png","modified":1,"renderable":0},{"_id":"source/images/pasted-107.png","path":"images/pasted-107.png","modified":1,"renderable":0},{"_id":"source/images/pasted-11.png","path":"images/pasted-11.png","modified":1,"renderable":0},{"_id":"source/images/pasted-12.png","path":"images/pasted-12.png","modified":1,"renderable":0},{"_id":"source/images/pasted-13.png","path":"images/pasted-13.png","modified":1,"renderable":0},{"_id":"source/images/pasted-14.png","path":"images/pasted-14.png","modified":1,"renderable":0},{"_id":"source/images/pasted-15.png","path":"images/pasted-15.png","modified":1,"renderable":0},{"_id":"source/images/pasted-16.png","path":"images/pasted-16.png","modified":1,"renderable":0},{"_id":"source/images/pasted-17.png","path":"images/pasted-17.png","modified":1,"renderable":0},{"_id":"source/images/pasted-18.png","path":"images/pasted-18.png","modified":1,"renderable":0},{"_id":"source/images/pasted-19.png","path":"images/pasted-19.png","modified":1,"renderable":0},{"_id":"source/images/pasted-2.png","path":"images/pasted-2.png","modified":1,"renderable":0},{"_id":"source/images/pasted-20.png","path":"images/pasted-20.png","modified":1,"renderable":0},{"_id":"source/images/pasted-21.png","path":"images/pasted-21.png","modified":1,"renderable":0},{"_id":"source/images/pasted-22.png","path":"images/pasted-22.png","modified":1,"renderable":0},{"_id":"source/images/pasted-23.png","path":"images/pasted-23.png","modified":1,"renderable":0},{"_id":"source/images/pasted-24.png","path":"images/pasted-24.png","modified":1,"renderable":0},{"_id":"source/images/pasted-25.png","path":"images/pasted-25.png","modified":1,"renderable":0},{"_id":"source/images/pasted-26.png","path":"images/pasted-26.png","modified":1,"renderable":0},{"_id":"source/images/pasted-27.png","path":"images/pasted-27.png","modified":1,"renderable":0},{"_id":"source/images/pasted-28.png","path":"images/pasted-28.png","modified":1,"renderable":0},{"_id":"source/images/pasted-29.png","path":"images/pasted-29.png","modified":1,"renderable":0},{"_id":"source/images/pasted-3.png","path":"images/pasted-3.png","modified":1,"renderable":0},{"_id":"source/images/pasted-30.png","path":"images/pasted-30.png","modified":1,"renderable":0},{"_id":"source/images/pasted-31.png","path":"images/pasted-31.png","modified":1,"renderable":0},{"_id":"source/images/pasted-32.png","path":"images/pasted-32.png","modified":1,"renderable":0},{"_id":"source/images/pasted-33.png","path":"images/pasted-33.png","modified":1,"renderable":0},{"_id":"source/images/pasted-34.png","path":"images/pasted-34.png","modified":1,"renderable":0},{"_id":"source/images/pasted-35.png","path":"images/pasted-35.png","modified":1,"renderable":0},{"_id":"source/images/pasted-36.png","path":"images/pasted-36.png","modified":1,"renderable":0},{"_id":"source/images/pasted-37.png","path":"images/pasted-37.png","modified":1,"renderable":0},{"_id":"source/images/pasted-38.png","path":"images/pasted-38.png","modified":1,"renderable":0},{"_id":"source/images/pasted-39.png","path":"images/pasted-39.png","modified":1,"renderable":0},{"_id":"source/images/pasted-4.png","path":"images/pasted-4.png","modified":1,"renderable":0},{"_id":"source/images/pasted-40.png","path":"images/pasted-40.png","modified":1,"renderable":0},{"_id":"source/images/pasted-41.png","path":"images/pasted-41.png","modified":1,"renderable":0},{"_id":"source/images/pasted-42.png","path":"images/pasted-42.png","modified":1,"renderable":0},{"_id":"source/images/pasted-43.png","path":"images/pasted-43.png","modified":1,"renderable":0},{"_id":"source/images/pasted-44.png","path":"images/pasted-44.png","modified":1,"renderable":0},{"_id":"source/images/pasted-45.png","path":"images/pasted-45.png","modified":1,"renderable":0},{"_id":"source/images/pasted-46.png","path":"images/pasted-46.png","modified":1,"renderable":0},{"_id":"source/images/pasted-47.png","path":"images/pasted-47.png","modified":1,"renderable":0},{"_id":"source/images/pasted-48.png","path":"images/pasted-48.png","modified":1,"renderable":0},{"_id":"source/images/pasted-49.png","path":"images/pasted-49.png","modified":1,"renderable":0},{"_id":"source/images/pasted-5.png","path":"images/pasted-5.png","modified":1,"renderable":0},{"_id":"source/images/pasted-50.png","path":"images/pasted-50.png","modified":1,"renderable":0},{"_id":"source/images/pasted-51.png","path":"images/pasted-51.png","modified":1,"renderable":0},{"_id":"source/images/pasted-52.png","path":"images/pasted-52.png","modified":1,"renderable":0},{"_id":"source/images/pasted-53.png","path":"images/pasted-53.png","modified":1,"renderable":0},{"_id":"source/images/pasted-54.png","path":"images/pasted-54.png","modified":1,"renderable":0},{"_id":"source/images/pasted-55.png","path":"images/pasted-55.png","modified":1,"renderable":0},{"_id":"source/images/pasted-56.png","path":"images/pasted-56.png","modified":1,"renderable":0},{"_id":"source/images/pasted-57.png","path":"images/pasted-57.png","modified":1,"renderable":0},{"_id":"source/images/pasted-58.png","path":"images/pasted-58.png","modified":1,"renderable":0},{"_id":"source/images/pasted-59.png","path":"images/pasted-59.png","modified":1,"renderable":0},{"_id":"source/images/pasted-6.png","path":"images/pasted-6.png","modified":1,"renderable":0},{"_id":"source/images/pasted-60.png","path":"images/pasted-60.png","modified":1,"renderable":0},{"_id":"source/images/pasted-61.png","path":"images/pasted-61.png","modified":1,"renderable":0},{"_id":"source/images/pasted-62.png","path":"images/pasted-62.png","modified":1,"renderable":0},{"_id":"source/images/pasted-63.png","path":"images/pasted-63.png","modified":1,"renderable":0},{"_id":"source/images/pasted-64.png","path":"images/pasted-64.png","modified":1,"renderable":0},{"_id":"source/images/pasted-65.png","path":"images/pasted-65.png","modified":1,"renderable":0},{"_id":"source/images/pasted-66.png","path":"images/pasted-66.png","modified":1,"renderable":0},{"_id":"source/images/pasted-67.png","path":"images/pasted-67.png","modified":1,"renderable":0},{"_id":"source/images/pasted-68.png","path":"images/pasted-68.png","modified":1,"renderable":0},{"_id":"source/images/pasted-69.png","path":"images/pasted-69.png","modified":1,"renderable":0},{"_id":"source/images/pasted-7.png","path":"images/pasted-7.png","modified":1,"renderable":0},{"_id":"source/images/pasted-70.png","path":"images/pasted-70.png","modified":1,"renderable":0},{"_id":"source/images/pasted-71.png","path":"images/pasted-71.png","modified":1,"renderable":0},{"_id":"source/images/pasted-72.png","path":"images/pasted-72.png","modified":1,"renderable":0},{"_id":"source/images/pasted-73.png","path":"images/pasted-73.png","modified":1,"renderable":0},{"_id":"source/images/pasted-74.png","path":"images/pasted-74.png","modified":1,"renderable":0},{"_id":"source/images/pasted-75.png","path":"images/pasted-75.png","modified":1,"renderable":0},{"_id":"source/images/pasted-76.png","path":"images/pasted-76.png","modified":1,"renderable":0},{"_id":"source/images/pasted-77.png","path":"images/pasted-77.png","modified":1,"renderable":0},{"_id":"source/images/pasted-78.png","path":"images/pasted-78.png","modified":1,"renderable":0},{"_id":"source/images/pasted-79.png","path":"images/pasted-79.png","modified":1,"renderable":0},{"_id":"source/images/pasted-8.png","path":"images/pasted-8.png","modified":1,"renderable":0},{"_id":"source/images/pasted-80.png","path":"images/pasted-80.png","modified":1,"renderable":0},{"_id":"source/images/pasted-81.png","path":"images/pasted-81.png","modified":1,"renderable":0},{"_id":"source/images/pasted-82.png","path":"images/pasted-82.png","modified":1,"renderable":0},{"_id":"source/images/pasted-83.png","path":"images/pasted-83.png","modified":1,"renderable":0},{"_id":"source/images/pasted-84.png","path":"images/pasted-84.png","modified":1,"renderable":0},{"_id":"source/images/pasted-85.png","path":"images/pasted-85.png","modified":1,"renderable":0},{"_id":"source/images/pasted-86.png","path":"images/pasted-86.png","modified":1,"renderable":0},{"_id":"source/images/pasted-87.png","path":"images/pasted-87.png","modified":1,"renderable":0},{"_id":"source/images/pasted-88.png","path":"images/pasted-88.png","modified":1,"renderable":0},{"_id":"source/images/pasted-89.png","path":"images/pasted-89.png","modified":1,"renderable":0},{"_id":"source/images/pasted-9.png","path":"images/pasted-9.png","modified":1,"renderable":0},{"_id":"source/images/pasted-90.png","path":"images/pasted-90.png","modified":1,"renderable":0},{"_id":"source/images/pasted-91.png","path":"images/pasted-91.png","modified":1,"renderable":0},{"_id":"source/images/pasted-92.png","path":"images/pasted-92.png","modified":1,"renderable":0},{"_id":"source/images/pasted-93.png","path":"images/pasted-93.png","modified":1,"renderable":0},{"_id":"source/images/pasted-94.png","path":"images/pasted-94.png","modified":1,"renderable":0},{"_id":"source/images/pasted-95.png","path":"images/pasted-95.png","modified":1,"renderable":0},{"_id":"source/images/pasted-96.png","path":"images/pasted-96.png","modified":1,"renderable":0},{"_id":"source/images/pasted-97.png","path":"images/pasted-97.png","modified":1,"renderable":0},{"_id":"source/images/pasted-98.png","path":"images/pasted-98.png","modified":1,"renderable":0},{"_id":"source/images/pasted-99.png","path":"images/pasted-99.png","modified":1,"renderable":0}],"Cache":[{"_id":"source/404.html","hash":"307d6eb3e9efdab8b88191bc919aa0df354a5f0c","modified":1569828850835},{"_id":"source/_discarded/hah.md","hash":"784c62256388914bb1c584920a566cbb0967d932","modified":1569829749268},{"_id":"source/_posts/Class及javaagent装载简述.md","hash":"b7ba8425baee66053769b0dbd7253da6c35303d5","modified":1569828850835},{"_id":"source/_posts/G1-Evacuation-Failure.md","hash":"1d931491834a8681eaeebeb861e7708967321f78","modified":1569828850836},{"_id":"source/_posts/G1垃圾回收器-xx-initiatingheapoccupancypercent变量之问.md","hash":"83b5c634a59dea37d31e6221b54652924e46a57a","modified":1569828850836},{"_id":"source/_posts/G1-Humongous-Allocation.md","hash":"cb245082c6edbff4aa551e19a0ac7d35f6059b9b","modified":1569828850836},{"_id":"source/_posts/HttpURLConnection-关于HttpRequestMethodNotSupportedException异常.md","hash":"572f9e24abf90d993487b277deb8c3054121208a","modified":1569828850836},{"_id":"source/.DS_Store","hash":"de916286b17b5e14f7687ca945c7d8a7e58a1198","modified":1632674472109},{"_id":"source/_posts/JVM-类加载.md","hash":"b4927adcac6992a247c2fc606b0bfabb0ad23d18","modified":1569828850836},{"_id":"source/_posts/ava-lang-NoClassDefFoundError-Could-not-initialize-class.md","hash":"9b8b206dcfabdbe7ce61f753e31b92c77c92ea79","modified":1569828850836},{"_id":"source/_posts/druid-filter.md","hash":"6b0d6481132c83c0a72fd20a50647e3d48d1c26f","modified":1569828850836},{"_id":"source/_posts/disruptor为什么那么快.md","hash":"21fcc8b095f0d5e72ea62c53039abcc597d5df5c","modified":1569828850836},{"_id":"source/_posts/druid连接的获取与创建.md","hash":"7285d2c1b340935bee4243158afe6aa2608b0327","modified":1569828850836},{"_id":"source/_posts/dubbo-反序列化问题.md","hash":"757eef208ccd4e868dac7eaa89be842c3c52b462","modified":1569828850836},{"_id":"source/_posts/dubbo-基于zookeeper的注册结构.md","hash":"18c802e916c0cd9012d3dcbaccc34d07480b6225","modified":1569828850837},{"_id":"source/_posts/dubbo-（反）序列化.md","hash":"01911d6b23711948c112cfd2992293c6e1b50e4e","modified":1569828850837},{"_id":"source/_posts/elasticsearch-集群.md","hash":"339dfae286a531ac9ce4a7228d6172741b421631","modified":1569828850837},{"_id":"source/_posts/git-本地commit、push、show、reset操作.md","hash":"1a75cad760f7093cbc72d4906a47db8719e3d702","modified":1569828850837},{"_id":"source/_posts/fastdfs异常分析.md","hash":"1e965c864665b5971c171414fb868aece08f6e2e","modified":1633661515826},{"_id":"source/_posts/java-对象使用问题案例.md","hash":"1705e9c71017950f096ab52ab4671aacaaa31c90","modified":1569828850837},{"_id":"source/_posts/hexo迁移（升级）常见问题.md","hash":"83dba983219de258a2f346eb5da57d7945f527f2","modified":1632802002202},{"_id":"source/_posts/jdk8-dump异常.md","hash":"d6ebe5f36a671655f896b0f646abea69e2db26a5","modified":1569828850837},{"_id":"source/_posts/javaagent-bytebuddy.md","hash":"09bf7b5f1375f2880c402a7cc8d48a8ed1bef313","modified":1569828850837},{"_id":"source/_posts/linux-tail命令不生效.md","hash":"f9957c652ccd62f6982c4078207ae2032e35d669","modified":1569828850837},{"_id":"source/_posts/grafana安装及使用.md","hash":"047e4549ee527472c067d7e2531c5524e059fa02","modified":1574669900812},{"_id":"source/_posts/maven-No-plugin-found-for-prefix-tomcat7.md","hash":"4c2a20da8aef760e9d435222c51b579b3f763c3a","modified":1569828850838},{"_id":"source/_posts/maven-Failed-to-execute-goal-org-apache-maven-plugins-maven-enforcer-plugin.md","hash":"2d35e3b8be61cc5873e2b4d292dffca7781decaa","modified":1569828850837},{"_id":"source/_posts/maven-Plugin-execution-not-covered-by-lifecycle-configuration.md","hash":"e35c49158d22279f17998d40362672cddd41dc3d","modified":1569828850838},{"_id":"source/_posts/maven-默认jdk版本.md","hash":"7827026d45aa1f3e68bcffc4583fd1446a5c4f21","modified":1569828850838},{"_id":"source/_posts/mongo-查询报no-property-found-on.md","hash":"e0f345c7cc165d0b391cc1aad44a1d5d098ec09d","modified":1569828850838},{"_id":"source/_posts/mysql-TIMESTAMP.md","hash":"90714951f99b642e7a8298a8180fd6835931ae17","modified":1569828850838},{"_id":"source/_posts/rabbitmq-报not-equivalent错.md","hash":"3fcb6b1c02f6301bd17601a2e27eb077f7cb50ca","modified":1569828850838},{"_id":"source/_posts/spring-boot1-3-5支持jsp导致浏览器访问应用偶尔慢.md","hash":"140acdbabbc1af7cf936485943078f5432f99967","modified":1569828850838},{"_id":"source/_posts/mysql数据库wait-timeout问题.md","hash":"568bb8fa926cc10ad2222bfa098400998bc3a26f","modified":1569828850838},{"_id":"source/_posts/springboot-spring-boot-starter-actuator.md","hash":"b9e910d86661b0476cbab31fd8705fa7c0ab50f9","modified":1569828850838},{"_id":"source/_posts/struts2-no-action-in-maven.md","hash":"d4a738e0a88577b7e140578a89ea9e0d0f7dc165","modified":1569828850838},{"_id":"source/_posts/rocketmq异常分析.md","hash":"8dfd93a63eb364a174f48f62bb445a0db1a7f174","modified":1595335424980},{"_id":"source/_posts/内存泄漏案例分析.md","hash":"1cf2ad46a2a6f2aa722809f2d5d28351bb64384f","modified":1569828850839},{"_id":"source/_posts/围绕dubbo底层原理漫谈微服务.md","hash":"bd99cf541ba1307ebdc525976af1276d63376e04","modified":1569828850839},{"_id":"source/_posts/应用停机-优雅停机问题.md","hash":"23dd5934d9d567c25051fe142b0197330adab8a7","modified":1569828850839},{"_id":"source/_posts/图片压缩-ImageIO-read-inputStream.md","hash":"dc493f08360168fcd5a665bd7843c81f14aea775","modified":1569828850839},{"_id":"source/_posts/数据库-kill服务进程引发的血案.md","hash":"f0931ce0092b8914aa74da8369534ad559d78caa","modified":1569828850839},{"_id":"source/_posts/浅谈JVM之垃圾回收.md","hash":"3d0cf332596c89ae30ec7730b020e3e337cdece3","modified":1569828850840},{"_id":"source/_posts/数据库-重启引发的主键问题.md","hash":"a576f453170be29410ad339bd4757669c13f3911","modified":1569828850839},{"_id":"source/_posts/浏览器-资源加载.md","hash":"fcbbad9287afa2a0178e5d37a80ecf314cc721d1","modified":1569828850840},{"_id":"source/_posts/淘宝架构-进化.md","hash":"64562b0edf5938f3675967ff96cc04d9d4b8c938","modified":1569828850840},{"_id":"source/_posts/谈一谈锁.md","hash":"2a3efdcc40f95a1b0702dab94b2002a0196f83d1","modified":1569828850840},{"_id":"source/_posts/剥开源码看java.md","hash":"6d3ff538ba9329e5cc32d784b4e6d446bce7f3ec","modified":1578645443456},{"_id":"source/about/index.md","hash":"c8afd495383970b99566197b729c5ca773c7d16b","modified":1569828850840},{"_id":"source/categories/index.md","hash":"a459d69045449ba9ab3680cd2d1f64fbfbe36eb7","modified":1569828850840},{"_id":"source/tags/index.md","hash":"495f8f399569d1316511028c892c45e991bb4cd4","modified":1569828850890},{"_id":"source/images/pasted-0.png","hash":"3c5bebef8fcf19a8f2c98a88495866b25e28c288","modified":1569828850840},{"_id":"source/schedule/index.md","hash":"b8ee3cfc22a6b456ab1ef31dbbfd60de0ace22a6","modified":1569828850890},{"_id":"source/images/pasted-10.png","hash":"7c63f1cc32c191cff49ec5bee0634ffebb4d0f41","modified":1569828850841},{"_id":"source/_posts/zookeeper-反复重连问题.md","hash":"9f98046a00b8758259c245947048fc20c2026f35","modified":1569828850839},{"_id":"source/images/pasted-103.png","hash":"254100ad1df6d24ff16a7dfc170ed17227cb0e92","modified":1578645377734},{"_id":"source/images/pasted-104.png","hash":"cd95ccb31d43d2543a68c040a6f7f3a1f8cf1381","modified":1595334943883},{"_id":"source/images/pasted-105.png","hash":"6b2e3a2cf1fc97849907b3a5ea397ff2148215b8","modified":1595334994301},{"_id":"source/images/pasted-11.png","hash":"0da5839c58d93b98b577b40374630992516397c9","modified":1569828850841},{"_id":"source/images/pasted-14.png","hash":"7d7fa913eef8c753d25b24cd610297be8e979e79","modified":1569828850843},{"_id":"source/images/pasted-19.png","hash":"1f045eed6f9ebad8ee4981bb2ac7e571400fa789","modified":1569828850845},{"_id":"source/images/pasted-18.png","hash":"895e9a3d62baa7c9da9af873b11cf74377ac99a4","modified":1569828850845},{"_id":"source/images/pasted-2.png","hash":"572b64658cfaa1bf0b752a9408821f4133331a5e","modified":1569828850845},{"_id":"source/images/pasted-24.png","hash":"12d854af02c4101e329dcdecd1a3aba33a030f60","modified":1569828850852},{"_id":"source/images/pasted-25.png","hash":"4b73f1a98581612d407594370e5c5397a5c80d1e","modified":1569828850852},{"_id":"source/images/pasted-26.png","hash":"5b5fe3fba7c5b2691e4aca04216d02dabc66cea5","modified":1569828850852},{"_id":"source/images/pasted-27.png","hash":"76ebe1be5de9bc77ba3bded99b0e421a67554dfc","modified":1569828850853},{"_id":"source/images/pasted-28.png","hash":"a334565cd08774738f05af99cd25449b40afeecd","modified":1569828850853},{"_id":"source/images/pasted-29.png","hash":"a334565cd08774738f05af99cd25449b40afeecd","modified":1569828850853},{"_id":"source/images/pasted-32.png","hash":"5da3568c83cdc7f1665806c152f922bd3a260fb5","modified":1569828850855},{"_id":"source/images/pasted-33.png","hash":"0e1a4784aec0a0d49f2cef37b9ced85eae0f19d1","modified":1569828850855},{"_id":"source/images/pasted-34.png","hash":"b6883d450159369476845b3304599b33d55bc25b","modified":1569828850855},{"_id":"source/images/pasted-36.png","hash":"e1d15b97163e3f49aa6fca964e36bfaec20505d7","modified":1569828850855},{"_id":"source/images/pasted-37.png","hash":"a647f6b5f4af9c97b0345064c2e03bed433fb7e5","modified":1569828850856},{"_id":"source/images/pasted-38.png","hash":"97f34628fd7816d9daa1e799fcc756bbbca82ad9","modified":1569828850856},{"_id":"source/images/pasted-39.png","hash":"8015ae73c4b94397bf2b04bfb833472f89244532","modified":1569828850856},{"_id":"source/images/pasted-40.png","hash":"efc5da95b15c817fd34471f30d13ec7780521514","modified":1569828850857},{"_id":"source/images/pasted-41.png","hash":"8cfaf01339aae2e46dbf5ce7863086caaeb32b3f","modified":1569828850857},{"_id":"source/images/pasted-42.png","hash":"1b63b44b25fe9690c2a4bff85a2b164ddc191e44","modified":1569828850857},{"_id":"source/images/pasted-43.png","hash":"58ede5e6d6feff9b62ae537856c96f87d269aa01","modified":1569828850858},{"_id":"source/images/pasted-44.png","hash":"ac34c1452a07347421b6cbf52c8f768d3084fa75","modified":1569828850858},{"_id":"source/images/pasted-47.png","hash":"39f267579a50d5fefc1a29ed0383718433ad685a","modified":1569828850859},{"_id":"source/images/pasted-48.png","hash":"0afe35569b77ebb8ad4c198203c3dc6937942ad4","modified":1569828850859},{"_id":"source/images/pasted-45.png","hash":"540bcd2ecf51702fcf7cfa8aa41eac361e742f2a","modified":1569828850858},{"_id":"source/images/pasted-53.png","hash":"9af4c8c80a9f1316559b9f7e20879443daaf564f","modified":1569828850863},{"_id":"source/images/pasted-54.png","hash":"3e3fece4e90e123648dafc121d8222d70fead0bf","modified":1569828850863},{"_id":"source/images/pasted-56.png","hash":"1deba22e9e40e5868dc4477130cd8092968209fb","modified":1569828850863},{"_id":"source/images/pasted-55.png","hash":"fdde17b659e2a2a594638d9b9612ac39d5251f10","modified":1569828850863},{"_id":"source/images/pasted-7.png","hash":"18d586673d7d12e0b4cb6b0ec7679b995b8d57ae","modified":1569828850873},{"_id":"source/images/pasted-74.png","hash":"3bdade1953defd13b321d950a50ca5c86c43158e","modified":1569828850877},{"_id":"source/images/pasted-78.png","hash":"2b11a4e1ff18042805be90368313d1fc2836c077","modified":1569828850881},{"_id":"source/images/pasted-79.png","hash":"35cd3e00659da093f91b67dcdca1254e170265a0","modified":1569828850881},{"_id":"source/images/pasted-8.png","hash":"553fb1dd618d381332e5e33b0ddcdb9e65e3e8c8","modified":1569828850881},{"_id":"source/images/pasted-88.png","hash":"f8809fa8c8a8031757fada066764cec3f80f30b7","modified":1569828850886},{"_id":"source/images/pasted-91.png","hash":"7315a6d51e9005f02022ccfb5bfec68ff79f068a","modified":1569828850887},{"_id":"source/images/pasted-90.png","hash":"94c35ffe97aa6bc51b7b9c32e9f2cc7f6ed5ae1e","modified":1569828850887},{"_id":"source/images/pasted-1.png","hash":"2fa5474ed957c6db8a1706c0dd6f7ebe246fe8ce","modified":1569828850841},{"_id":"source/images/pasted-15.png","hash":"982268d3cc54f70beae137f40c0e829ecc79e267","modified":1569828850843},{"_id":"source/images/pasted-16.png","hash":"4bd7bdf4bb0e335166ca6b73d2519ecde5186c13","modified":1569828850844},{"_id":"source/images/pasted-22.png","hash":"c559fed4f04798d54344a2be9eb426aed2d090cd","modified":1569828850850},{"_id":"source/images/pasted-3.png","hash":"542656a87c61559ba6b9de7d898959ce5b66bf26","modified":1569828850853},{"_id":"source/images/pasted-31.png","hash":"34d16af5e5c08ed5d21e4dba6a9f824a38ffdf95","modified":1569828850854},{"_id":"source/images/pasted-35.png","hash":"5cdd93179bbd33c52c5e882e1794c22c2b1ac83e","modified":1569828850855},{"_id":"source/images/pasted-30.png","hash":"c14c8dc37a7346d34faeec058c2433e2fe6b230d","modified":1569828850854},{"_id":"source/images/pasted-4.png","hash":"f08def5db40d8ced9cdf23d5d0261ecbb0d245c5","modified":1569828850857},{"_id":"source/images/pasted-46.png","hash":"0750ae34c5cd71f65471af8135d2ab204fa189cc","modified":1569828850859},{"_id":"source/images/pasted-49.png","hash":"5fe72327894be154937213278bb11b1518b55a09","modified":1569828850859},{"_id":"source/images/pasted-52.png","hash":"51a45ad8a44ebfab8ca80997109a0fb5b48636b2","modified":1569828850862},{"_id":"source/images/pasted-6.png","hash":"aa86792c3bd66a7ebd57dcf17ab6bdae6fb225f1","modified":1569828850865},{"_id":"source/images/pasted-72.png","hash":"df875e0200cbb1b602927008f8c38780d282137d","modified":1569828850875},{"_id":"source/images/pasted-80.png","hash":"5a9d6133fd4bfe9d3a13dc6113f304e57b994e61","modified":1569828850882},{"_id":"source/images/pasted-82.png","hash":"5726b4f909889a8e4f623d0be3d2d12b17d4843d","modified":1569828850883},{"_id":"source/images/pasted-81.png","hash":"5a9d6133fd4bfe9d3a13dc6113f304e57b994e61","modified":1569828850883},{"_id":"source/images/pasted-83.png","hash":"5726b4f909889a8e4f623d0be3d2d12b17d4843d","modified":1569828850884},{"_id":"source/images/pasted-84.png","hash":"229c81eac1c42191213104127e651373e07fa448","modified":1569828850884},{"_id":"source/images/pasted-85.png","hash":"fe2ba5308626a0bf3e5eeda6bf02b89cd64be246","modified":1569828850884},{"_id":"source/images/pasted-87.png","hash":"8bb6eea25f41a4fd090f27afa10dfc1a8fc80b2a","modified":1569828850886},{"_id":"source/images/pasted-86.png","hash":"2e1b172082acca1196b060c6b5f6ddee61be6115","modified":1569828850885},{"_id":"source/images/pasted-89.png","hash":"9b941fd9660b9e8e4ad2eda5f26b6df8d335dfb8","modified":1569828850886},{"_id":"source/images/pasted-99.png","hash":"112c1cc3c9f78f862deaef66b2d44e77afbef64c","modified":1578625097157},{"_id":"source/images/pasted-12.png","hash":"2b99b4381ba748311a8dd92588cf491a4059b9bc","modified":1569828850842},{"_id":"source/images/pasted-13.png","hash":"2b99b4381ba748311a8dd92588cf491a4059b9bc","modified":1569828850843},{"_id":"source/images/pasted-17.png","hash":"bbcd99aad0b7a56282018978f9557c8aa1c7cfc6","modified":1569828850844},{"_id":"source/images/pasted-51.png","hash":"3cfc16acb4552defa33fc0d75fcfc7d6ad8bf991","modified":1569828850862},{"_id":"source/images/pasted-62.png","hash":"4e72259755fba0a8b1d9f9ce99605d6e195ad6a8","modified":1569828850867},{"_id":"source/images/pasted-63.png","hash":"a826b0f8a6429ec65457d870d1dac716809350a1","modified":1569828850868},{"_id":"source/images/pasted-64.png","hash":"6660e84279f054a10a2ecebef0fc96050c59518c","modified":1569828850869},{"_id":"source/images/pasted-65.png","hash":"2f813950fc8b41ddf92089e9635a34e78d3683b7","modified":1569828850870},{"_id":"source/images/pasted-66.png","hash":"11d50c0829aa49841290a327bdb07fa93c5f4d0c","modified":1569828850871},{"_id":"source/images/pasted-71.png","hash":"63976f2ebfb713cf2a7f2a7e6ad938184257a76d","modified":1569828850875},{"_id":"source/images/pasted-70.png","hash":"7e20959399a3a2c3d542146497ba2a9e9c835a46","modified":1569828850874},{"_id":"source/images/pasted-75.png","hash":"cf8886ec72d78f57821f0d790246cf3b5e47e90e","modified":1569828850878},{"_id":"source/images/pasted-9.png","hash":"92fb7b9ed14256063d814aeb1c64417999d12529","modified":1569828850887},{"_id":"source/images/pasted-101.png","hash":"4df8edd360d3470b515a6c10741488bf354a4b08","modified":1578628326345},{"_id":"source/images/pasted-68.png","hash":"eef4a8b3e8ee56f95c8b8ff89ff56cdda316006c","modified":1569828850872},{"_id":"source/images/pasted-95.png","hash":"24de01c15750fcc463d3456581b94bf1bf9d90d2","modified":1574669094969},{"_id":"source/images/pasted-106.png","hash":"e77b6cdcbc9f829618d663c8a5cd53afb5fedd48","modified":1595335146190},{"_id":"source/images/pasted-57.png","hash":"4579bebdf9fff7ce70063012a5042d45d657e0c3","modified":1569828850864},{"_id":"source/images/pasted-59.png","hash":"0362818f13459539382e17dbeb4c89a5436aa2c1","modified":1569828850865},{"_id":"source/images/pasted-61.png","hash":"d0c99730ed8a3d141fcb016e5dea7509584497a7","modified":1569828850867},{"_id":"source/images/pasted-67.png","hash":"e81bad45392314c20c8d3685e35d8043f4bc890f","modified":1569828850871},{"_id":"source/images/pasted-69.png","hash":"6eae5d2deb562a15c884ea950175f6e9e114745a","modified":1569828850873},{"_id":"source/images/pasted-50.png","hash":"69eedb93a41e66286f300eb3e330b7ad54c7be63","modified":1569828850861},{"_id":"source/images/pasted-58.png","hash":"e83295ea073c15b6e07d66f853bbea4a0d679222","modified":1569828850864},{"_id":"source/images/pasted-5.png","hash":"f3b4cea1946a8308ebd0a158fba6badd50b8e061","modified":1569828850860},{"_id":"source/images/pasted-60.png","hash":"df2d739232ca94f0aadb66dcb0ee00c1354bdbdd","modified":1569828850866},{"_id":"source/images/pasted-77.png","hash":"0161351bf707e06c019ed2f5d26569fa45e21d40","modified":1569828850880},{"_id":"source/images/pasted-100.png","hash":"ef2a64357dea69bf05d6cde0c489f42d6a7c61c7","modified":1578628183820},{"_id":"source/images/pasted-102.png","hash":"5fb7802d8a9aef34ab4ba25bf59fa5d8b8439ab6","modified":1578628834196},{"_id":"source/images/pasted-76.png","hash":"60a5a8afca8ee12c8716d099cfa7dd246dda493d","modified":1569828850879},{"_id":"source/images/pasted-94.png","hash":"590e8bd643395978cafd5d8295b86fdfabac0902","modified":1569828850890},{"_id":"source/images/pasted-20.png","hash":"6853b316e1e526f9bb5805b3bdd2f0260d4f9fe3","modified":1569828850847},{"_id":"source/images/pasted-23.png","hash":"9c01c23fd815ffbd134add353fab53e9855254df","modified":1569828850852},{"_id":"source/images/pasted-73.png","hash":"ab091793d0efc9d6799db339265e4f08e63c18e7","modified":1569828850877},{"_id":"source/images/pasted-92.png","hash":"1497f41fb87303ac21a3be744345517e4533c32b","modified":1569828850888},{"_id":"source/images/pasted-21.png","hash":"e31d7b92b0c58faeecdd44c8ad00eeb9a3783e53","modified":1569828850849},{"_id":"source/images/pasted-97.png","hash":"2ec29984a0c8091ca630922f72543db3d0651ef0","modified":1574669165186},{"_id":"source/images/pasted-98.png","hash":"7a5754fcfd22013551d8297df7928d4c049cdf62","modified":1574669198316},{"_id":"themes/next/.gitignore","hash":"56f3470755c20311ddd30d421b377697a6e5e68b","modified":1632815299116},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1632815299109},{"_id":"themes/next/.gitattributes","hash":"a54f902957d49356376b59287b894b1a3d7a003f","modified":1632815299132},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1632815299133},{"_id":"themes/next/README.md","hash":"9b4b7d66aca47f9c65d6321b14eef48d95c4dff1","modified":1632815299116},{"_id":"themes/next/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1632815299023},{"_id":"themes/next/.eslintrc.json","hash":"cc5f297f0322672fe3f684f823bc4659e4a54c41","modified":1632815299158},{"_id":"themes/next/.travis.yml","hash":"ecca3b919a5b15886e3eca58aa84aafc395590da","modified":1632815299158},{"_id":"themes/next/package.json","hash":"62fad6de02adbbba9fb096cbe2dcc15fe25f2435","modified":1632815299117},{"_id":"themes/next/gulpfile.js","hash":"1b4fc262b89948937b9e3794de812a7c1f2f3592","modified":1632815299132},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"aa4cb7aff595ca628cb58160ee1eee117989ec4e","modified":1632815299129},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"e554931b98f251fd49ff1d2443006d9ea2c20461","modified":1632815299130},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"1a435c20ae8fa183d49bbf96ac956f7c6c25c8af","modified":1632815299129},{"_id":"themes/next/.github/config.yml","hash":"1d3f4e8794986817c0fead095c74f756d45f91ed","modified":1632815299130},{"_id":"themes/next/.github/issue-close-app.yml","hash":"7cba457eec47dbfcfd4086acd1c69eaafca2f0cd","modified":1632815299132},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1632815299110},{"_id":"themes/next/_config.yml","hash":"85af715e259c14f57c7e1a3736acdf25ffbcdbbe","modified":1632818868854},{"_id":"themes/next/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1632815299131},{"_id":"themes/next/.github/lock.yml","hash":"61173b9522ebac13db2c544e138808295624f7fd","modified":1632815299132},{"_id":"themes/next/.github/mergeable.yml","hash":"0ee56e23bbc71e1e76427d2bd255a9879bd36e22","modified":1632815299129},{"_id":"themes/next/.github/release-drafter.yml","hash":"3cc10ce75ecc03a5ce86b00363e2a17eb65d15ea","modified":1632815299129},{"_id":"themes/next/.github/stale.yml","hash":"fdf82de9284f8bc8e0b0712b4cc1cb081a94de59","modified":1632815299129},{"_id":"themes/next/.github/support.yml","hash":"d75db6ffa7b4ca3b865a925f9de9aef3fc51925c","modified":1632815299131},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"c7a994b9542040317d8f99affa1405c143a94a38","modified":1632815299103},{"_id":"themes/next/docs/AUTHORS.md","hash":"10135a2f78ac40e9f46b3add3e360c025400752f","modified":1632815299102},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1632815299105},{"_id":"themes/next/docs/DATA-FILES.md","hash":"cddbdc91ee9e65c37a50bec12194f93d36161616","modified":1632815299102},{"_id":"themes/next/docs/INSTALLATION.md","hash":"af88bcce035780aaa061261ed9d0d6c697678618","modified":1632815299109},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"94dc3404ccb0e5f663af2aa883c1af1d6eae553d","modified":1632815299108},{"_id":"themes/next/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1632815299108},{"_id":"themes/next/docs/MATH.md","hash":"d645b025ec7fb9fbf799b9bb76af33b9f5b9ed93","modified":1632815299104},{"_id":"themes/next/languages/ar.yml","hash":"9815e84e53d750c8bcbd9193c2d44d8d910e3444","modified":1632815299115},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"8b6e4b2c9cfcb969833092bdeaed78534082e3e6","modified":1632815299102},{"_id":"themes/next/languages/de.yml","hash":"74c59f2744217003b717b59d96e275b54635abf5","modified":1632815299112},{"_id":"themes/next/languages/default.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1632815299113},{"_id":"themes/next/languages/en.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1632815299113},{"_id":"themes/next/languages/es.yml","hash":"c64cf05f356096f1464b4b1439da3c6c9b941062","modified":1632815299111},{"_id":"themes/next/languages/fa.yml","hash":"3676b32fda37e122f3c1a655085a1868fb6ad66b","modified":1632815299113},{"_id":"themes/next/languages/fr.yml","hash":"752bf309f46a2cd43890b82300b342d7218d625f","modified":1632815299114},{"_id":"themes/next/languages/hu.yml","hash":"b1ebb77a5fd101195b79f94de293bcf9001d996f","modified":1632815299112},{"_id":"themes/next/languages/id.yml","hash":"572ed855d47aafe26f58c73b1394530754881ec2","modified":1632815299112},{"_id":"themes/next/languages/it.yml","hash":"44759f779ce9c260b895532de1d209ad4bd144bf","modified":1632815299113},{"_id":"themes/next/languages/ja.yml","hash":"0cf0baa663d530f22ff380a051881216d6adcdd8","modified":1632815299113},{"_id":"themes/next/languages/ko.yml","hash":"0feea9e43cd399f3610b94d755a39fff1d371e97","modified":1632815299111},{"_id":"themes/next/languages/nl.yml","hash":"5af3473d9f22897204afabc08bb984b247493330","modified":1632815299116},{"_id":"themes/next/languages/pt-BR.yml","hash":"67555b1ba31a0242b12fc6ce3add28531160e35b","modified":1632815299111},{"_id":"themes/next/languages/pt.yml","hash":"718d131f42f214842337776e1eaddd1e9a584054","modified":1632815299112},{"_id":"themes/next/languages/ru.yml","hash":"e993d5ca072f7f6887e30fc0c19b4da791ca7a88","modified":1632815299114},{"_id":"themes/next/languages/tr.yml","hash":"2b041eeb8bd096f549464f191cfc1ea0181daca4","modified":1632815299115},{"_id":"themes/next/languages/uk.yml","hash":"3a6d635b1035423b22fc86d9455dba9003724de9","modified":1632815299110},{"_id":"themes/next/languages/vi.yml","hash":"93393b01df148dcbf0863f6eee8e404e2d94ef9e","modified":1632815299115},{"_id":"themes/next/languages/zh-CN.yml","hash":"a1f15571ee7e1e84e3cc0985c3ec4ba1a113f6f8","modified":1632815299115},{"_id":"themes/next/languages/zh-HK.yml","hash":"3789f94010f948e9f23e21235ef422a191753c65","modified":1632815299114},{"_id":"themes/next/languages/zh-TW.yml","hash":"8c09da7c4ec3fca2c6ee897b2eea260596a2baa1","modified":1632815299114},{"_id":"themes/next/layout/_layout.swig","hash":"6a6e92a4664cdb981890a27ac11fd057f44de1d5","modified":1632815299026},{"_id":"themes/next/layout/index.swig","hash":"7f403a18a68e6d662ae3e154b2c1d3bbe0801a23","modified":1632815299033},{"_id":"themes/next/layout/archive.swig","hash":"e4e31317a8df68f23156cfc49e9b1aa9a12ad2ed","modified":1632815299043},{"_id":"themes/next/layout/category.swig","hash":"1bde61cf4d2d171647311a0ac2c5c7933f6a53b0","modified":1632815299026},{"_id":"themes/next/scripts/renderer.js","hash":"49a65df2028a1bc24814dc72fa50d52231ca4f05","modified":1632815299122},{"_id":"themes/next/layout/page.swig","hash":"db581bdeac5c75fabb0f17d7c5e746e47f2a9168","modified":1632815299033},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"c3e6b8196c983c40fd140bdeca012d03e6e86967","modified":1632815299131},{"_id":"themes/next/layout/post.swig","hash":"2f6d992ced7e067521fdce05ffe4fd75481f41c5","modified":1632815299032},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"12d99fb8b62bd9e34d9672f306c9ae4ace7e053e","modified":1632815299130},{"_id":"themes/next/layout/tag.swig","hash":"0dfb653bd5de980426d55a0606d1ab122bd8c017","modified":1632815299025},{"_id":"themes/next/.github/ISSUE_TEMPLATE/other.md","hash":"d3efc0df0275c98440e69476f733097916a2d579","modified":1632815299131},{"_id":"themes/next/.github/ISSUE_TEMPLATE/question.md","hash":"53df7d537e26aaf062d70d86835c5fd8f81412f3","modified":1632815299131},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"0bd2d696f62a997a11a7d84fec0130122234174e","modified":1632815299104},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"9c4fe2873123bf9ceacab5c50d17d8a0f1baef27","modified":1632815299104},{"_id":"themes/next/docs/ru/README.md","hash":"85dd68ed1250897a8e4a444a53a68c1d49eb7e11","modified":1632815299104},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"5237a368ab99123749d724b6c379415f2c142a96","modified":1632815299103},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"34b88784ec120dfdc20fa82aadeb5f64ef614d14","modified":1632815299107},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"fb23b85db6f7d8279d73ae1f41631f92f64fc864","modified":1632815299106},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"d3f03be036b75dc71cf3c366cd75aee7c127c874","modified":1632815299108},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"ca1030efdfca5e20f9db2e7a428998e66a24c0d0","modified":1632815299106},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"579c7bd8341873fb8be4732476d412814f1a3df7","modified":1632815299108},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"8b18f84503a361fc712b0fe4d4568e2f086ca97d","modified":1632815299107},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"b92585d251f1f9ebe401abb5d932cb920f9b8b10","modified":1632815299107},{"_id":"themes/next/docs/zh-CN/README.md","hash":"c038629ff8f3f24e8593c4c8ecf0bef3a35c750d","modified":1632815299107},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"d9ce7331c1236bbe0a551d56cef2405e47e65325","modified":1632815299106},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"9c8dc0b8170679cdc1ee9ee8dbcbaebf3f42897b","modified":1632815299056},{"_id":"themes/next/layout/_partials/comments.swig","hash":"db6ab5421b5f4b7cb32ac73ad0e053fdf065f83e","modified":1632815299041},{"_id":"themes/next/layout/_partials/footer.swig","hash":"4369b313cbbeae742cb35f86d23d99d4285f7359","modified":1632815299041},{"_id":"themes/next/layout/_macro/post.swig","hash":"090b5a9b6fca8e968178004cbd6cff205b7eba57","modified":1632815299055},{"_id":"themes/next/layout/_partials/languages.swig","hash":"ba9e272f1065b8f0e8848648caa7dea3f02c6be1","modified":1632815299041},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"71655ca21907e9061b6e8ac52d0d8fbf54d0062b","modified":1632815299055},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1632815299038},{"_id":"themes/next/layout/_partials/widgets.swig","hash":"83a40ce83dfd5cada417444fb2d6f5470aae6bb0","modified":1632815299039},{"_id":"themes/next/layout/_scripts/index.swig","hash":"cea942b450bcb0f352da78d76dc6d6f1d23d5029","modified":1632815299031},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"d1f2bfde6f1da51a2b35a7ab9e7e8eb6eefd1c6b","modified":1632815299030},{"_id":"themes/next/layout/_scripts/pjax.swig","hash":"4d2c93c66e069852bb0e3ea2e268d213d07bfa3f","modified":1632815299030},{"_id":"themes/next/layout/_scripts/three.swig","hash":"a4f42f2301866bd25a784a2281069d8b66836d0b","modified":1632815299032},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"ef38c213679e7b6d2a4116f56c9e55d678446069","modified":1632815299031},{"_id":"themes/next/layout/_third-party/baidu-push.swig","hash":"b782eb2e34c0c15440837040b5d65b093ab6ec04","modified":1632815299053},{"_id":"themes/next/scripts/events/index.js","hash":"5743cde07f3d2aa11532a168a652e52ec28514fd","modified":1632815299125},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"aec50ed57b9d5d3faf2db3c88374f107203617e0","modified":1632815299122},{"_id":"themes/next/scripts/filters/front-matter.js","hash":"703bdd142a671b4b67d3d9dfb4a19d1dd7e7e8f7","modified":1632815299122},{"_id":"themes/next/layout/_third-party/index.swig","hash":"70c3c01dd181de81270c57f3d99b6d8f4c723404","modified":1632815299049},{"_id":"themes/next/scripts/filters/locals.js","hash":"b193a936ee63451f09f8886343dcfdca577c0141","modified":1632815299122},{"_id":"themes/next/scripts/filters/minify.js","hash":"19985723b9f677ff775f3b17dcebf314819a76ac","modified":1632815299121},{"_id":"themes/next/scripts/filters/post.js","hash":"44ba9b1c0bdda57590b53141306bb90adf0678db","modified":1632815299121},{"_id":"themes/next/scripts/helpers/engine.js","hash":"bdb424c3cc0d145bd0c6015bb1d2443c8a9c6cda","modified":1632815299127},{"_id":"themes/next/scripts/helpers/font.js","hash":"40cf00e9f2b7aa6e5f33d412e03ed10304b15fd7","modified":1632815299127},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"5e11f30ddb5093a88a687446617a46b048fa02e5","modified":1632815299128},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"958e86b2bd24e4fdfcbf9ce73e998efe3491a71f","modified":1632815299127},{"_id":"themes/next/scripts/tags/button.js","hash":"8c6b45f36e324820c919a822674703769e6da32c","modified":1632815299124},{"_id":"themes/next/layout/_third-party/quicklink.swig","hash":"311e5eceec9e949f1ea8d623b083cec0b8700ff2","modified":1632815299048},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1632815299053},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"94e0bbc7999b359baa42fa3731bdcf89c79ae2b3","modified":1632815299124},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"f1826ade2d135e2f60e2d95cb035383685b3370c","modified":1632815299123},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"d902fd313e8d35c3cc36f237607c2a0536c9edf1","modified":1632815299125},{"_id":"themes/next/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1632815299125},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1632815299123},{"_id":"themes/next/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1632815299124},{"_id":"themes/next/scripts/tags/pdf.js","hash":"8c613b39e7bff735473e35244b5629d02ee20618","modified":1632815299123},{"_id":"themes/next/scripts/tags/tabs.js","hash":"93d8a734a3035c1d3f04933167b500517557ba3e","modified":1632815299123},{"_id":"themes/next/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1632815299124},{"_id":"themes/next/source/css/_colors.styl","hash":"a8442520f719d3d7a19811cb3b85bcfd4a596e1f","modified":1632815299082},{"_id":"themes/next/source/css/_mixins.styl","hash":"e31a557f8879c2f4d8d5567ee1800b3e03f91f6e","modified":1632815299082},{"_id":"themes/next/source/css/main.styl","hash":"a3a3bbb5a973052f0186b3523911cb2539ff7b88","modified":1632815299083},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1632815299091},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1632815299090},{"_id":"themes/next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1632815299089},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1632815299092},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1632815299090},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1632815299090},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1632815299089},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1632815299091},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1632815299090},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1632815299091},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1632815299091},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1632815299091},{"_id":"themes/next/source/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1632815299094},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1632815299092},{"_id":"themes/next/source/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1632815299094},{"_id":"themes/next/source/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1632815299095},{"_id":"themes/next/source/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1632815299095},{"_id":"themes/next/source/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1632815299094},{"_id":"themes/next/source/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1632815299095},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"000bad572d76ee95d9c0a78f9ccdc8d97cc7d4b4","modified":1632815299040},{"_id":"themes/next/source/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1632815299096},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"810d544019e4a8651b756dd23e5592ee851eda71","modified":1632815299041},{"_id":"themes/next/layout/_partials/header/index.swig","hash":"7dbe93b8297b746afb89700b4d29289556e85267","modified":1632815299043},{"_id":"themes/next/layout/_partials/header/brand.swig","hash":"c70f8e71e026e878a4e9d5ab3bbbf9b0b23c240c","modified":1632815299043},{"_id":"themes/next/layout/_partials/header/menu-item.swig","hash":"9440d8a3a181698b80e1fa47f5104f4565d8cdf3","modified":1632815299043},{"_id":"themes/next/layout/_partials/header/sub-menu.swig","hash":"ae2261bea836581918a1c2b0d1028a78718434e0","modified":1632815299042},{"_id":"themes/next/layout/_partials/header/menu.swig","hash":"d31f896680a6c2f2c3f5128b4d4dd46c87ce2130","modified":1632815299042},{"_id":"themes/next/layout/_partials/page/breadcrumb.swig","hash":"c851717497ca64789f2176c9ecd1dedab237b752","modified":1632815299036},{"_id":"themes/next/layout/_partials/page/page-header.swig","hash":"9b7a66791d7822c52117fe167612265356512477","modified":1632815299036},{"_id":"themes/next/layout/_partials/post/post-followme.swig","hash":"ceba16b9bd3a0c5c8811af7e7e49d0f9dcb2f41e","modified":1632815299038},{"_id":"themes/next/layout/_partials/post/post-copyright.swig","hash":"954ad71536b6eb08bd1f30ac6e2f5493b69d1c04","modified":1632815299038},{"_id":"themes/next/layout/_partials/post/post-footer.swig","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1632815299037},{"_id":"themes/next/layout/_partials/post/post-related.swig","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1632815299037},{"_id":"themes/next/layout/_partials/post/post-reward.swig","hash":"2b1a73556595c37951e39574df5a3f20b2edeaef","modified":1632815299037},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"f48a6a8eba04eb962470ce76dd731e13074d4c45","modified":1632815299039},{"_id":"themes/next/layout/_partials/search/algolia-search.swig","hash":"48430bd03b8f19c9b8cdb2642005ed67d56c6e0b","modified":1632815299040},{"_id":"themes/next/layout/_partials/search/index.swig","hash":"2be50f9bfb1c56b85b3b6910a7df27f51143632c","modified":1632815299039},{"_id":"themes/next/layout/_scripts/pages/schedule.swig","hash":"077b5d66f6309f2e7dcf08645058ff2e03143e6c","modified":1632815299032},{"_id":"themes/next/layout/_partials/sidebar/site-overview.swig","hash":"c46849e0af8f8fb78baccd40d2af14df04a074af","modified":1632815299034},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1632815299029},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1632815299030},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1632815299029},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1632815299054},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1632815299029},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"2fa2b51d56bfac6a1ea76d651c93b9c20b01c09b","modified":1632815299054},{"_id":"themes/next/layout/_third-party/analytics/growingio.swig","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1632815299055},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"1472cabb0181f60a6a0b7fec8899a4d03dfb2040","modified":1632815299054},{"_id":"themes/next/layout/_third-party/chat/tidio.swig","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1632815299049},{"_id":"themes/next/layout/_third-party/chat/chatra.swig","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1632815299049},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b14908644225d78c864cd0a9b60c52407de56183","modified":1632815299046},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"f39a5bf3ce9ee9adad282501235e0c588e4356ec","modified":1632815299048},{"_id":"themes/next/layout/_third-party/comments/gitalk.swig","hash":"d6ceb70648555338a80ae5724b778c8c58d7060d","modified":1632815299047},{"_id":"themes/next/layout/_third-party/comments/disqusjs.swig","hash":"82f5b6822aa5ec958aa987b101ef860494c6cf1f","modified":1632815299047},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"be0a8eccf1f6dc21154af297fc79555343031277","modified":1632815299047},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"f7a9eca599a682479e8ca863db59be7c9c7508c8","modified":1632815299048},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"6c5976621efd5db5f7c4c6b4f11bc79d6554885f","modified":1632815299050},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"ecf751321e799f0fb3bf94d049e535130e2547aa","modified":1632815299050},{"_id":"themes/next/layout/_third-party/search/swiftype.swig","hash":"ba0dbc06b9d244073a1c681ff7a722dcbf920b51","modified":1632815299052},{"_id":"themes/next/layout/_third-party/search/algolia-search.swig","hash":"d35a999d67f4c302f76fdf13744ceef3c6506481","modified":1632815299052},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"4791c977a730f29c846efcf6c9c15131b9400ead","modified":1632815299050},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1632815299052},{"_id":"themes/next/layout/_third-party/statistics/cnzz-analytics.swig","hash":"a17ace37876822327a2f9306a472974442c9005d","modified":1632815299046},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.swig","hash":"4b1986e43d6abce13450d2b41a736dd6a5620a10","modified":1632815299045},{"_id":"themes/next/layout/_third-party/statistics/firestore.swig","hash":"b26ac2bfbe91dd88267f8b96aee6bb222b265b7a","modified":1632815299045},{"_id":"themes/next/layout/_third-party/statistics/index.swig","hash":"5f6a966c509680dbfa70433f9d658cee59c304d7","modified":1632815299045},{"_id":"themes/next/scripts/events/lib/config.js","hash":"d34c6040b13649714939f59be5175e137de65ede","modified":1632815299126},{"_id":"themes/next/scripts/events/lib/injects-point.js","hash":"6661c1c91c7cbdefc6a5e6a034b443b8811235a1","modified":1632815299126},{"_id":"themes/next/layout/_third-party/tags/mermaid.swig","hash":"f3c43664a071ff3c0b28bd7e59b5523446829576","modified":1632815299051},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.swig","hash":"d56d5af427cdfecc33a0f62ee62c056b4e33d095","modified":1632815299045},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"f233d8d0103ae7f9b861344aa65c1a3c1de8a845","modified":1632815299126},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"a54708fd9309b4357c423a3730eb67f395344a5e","modified":1632815299120},{"_id":"themes/next/layout/_third-party/tags/pdf.swig","hash":"d30b0e255a8092043bac46441243f943ed6fb09b","modified":1632815299051},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1632815299121},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"4c0c99c7e0f00849003dfce02a131104fb671137","modified":1632815299119},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"7f2d93af012c1e14b8596fecbfc7febb43d9b7f5","modified":1632815299121},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"7f8b92913d21070b489457fa5ed996d2a55f2c32","modified":1632815299120},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"e51dc3072c1ba0ea3008f09ecae8b46242ec6021","modified":1632815299120},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"d5fefc31fba4ab0188305b1af1feb61da49fdeb0","modified":1632815299119},{"_id":"themes/next/scripts/filters/comment/valine.js","hash":"6cbd85f9433c06bae22225ccf75ac55e04f2d106","modified":1632815299120},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"f4e694e5db81e57442c7e34505a416d818b3044a","modified":1632815299081},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"62df49459d552bbf73841753da8011a1f5e875c8","modified":1632815299082},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"f70be8e229da7e1715c11dd0e975a2e71e453ac8","modified":1632815299081},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"612ec843372dae709acb17112c1145a53450cc59","modified":1632815299082},{"_id":"themes/next/source/css/_variables/base.styl","hash":"818508748b7a62e02035e87fe58e75b603ed56dc","modified":1632815299081},{"_id":"themes/next/source/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1632815299093},{"_id":"themes/next/source/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1632815299093},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1632815299097},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"ca5e70662dcfb261c25191cc5db5084dcf661c76","modified":1632815299070},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1632815299097},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"a47725574e1bee3bc3b63b0ff2039cc982b17eff","modified":1632815299071},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"8e7b57a72e757cf95278239641726bb2d5b869d1","modified":1632815299066},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"2e3bf7baf383c9073ec5e67f157d3cb3823c0957","modified":1632815299070},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"681d33e3bc85bdca407d93b134c089264837378c","modified":1632815299077},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"a1690e035b505d28bdef2b4424c13fc6312ab049","modified":1632815299077},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"0b2c4b78eead410020d7c4ded59c75592a648df8","modified":1632815299061},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a2e9e00962e43e98ec2614d6d248ef1773bb9b78","modified":1632815299060},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"b1f0fab7344a20ed6748b04065b141ad423cf4d9","modified":1632815299061},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"8f58570a1bbc34c4989a47a1b7d42a8030f38b06","modified":1632815299061},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1632815299064},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1632815299065},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"18ce72d90459c9aa66910ac64eae115f2dde3767","modified":1632815299064},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"179e33b8ac7f4d8a8e76736a7e4f965fe9ab8b42","modified":1632815299058},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"f6516d0f7d89dc7b6c6e143a5af54b926f585d82","modified":1632815299088},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"bb7ace23345364eb14983e860a7172e1683a4c94","modified":1632815299087},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"6136da4bbb7e70cec99f5c7ae8c7e74f5e7c261a","modified":1632815299087},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"7104b9cef90ca3b140d7a7afcf15540a250218fc","modified":1632815299088},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"a717969829fa6ef88225095737df3f8ee86c286b","modified":1632815299088},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"7785bd756e0c4acede3a47fec1ed7b55988385a5","modified":1632815299085},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"f0131db6275ceaecae7e1a6a3798b8f89f6c850d","modified":1632815299084},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"4d1c17345d2d39ef7698f7acf82dfc0f59308c34","modified":1632815299083},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"93db5dafe9294542a6b5f647643cb9deaced8e06","modified":1632815299084},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"2b2e7b5cea7783c9c8bb92655e26a67c266886f0","modified":1632815299084},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1632815299084},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1632815299083},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"e282df938bd029f391c466168d0e68389978f120","modified":1632815299086},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"70a4324b70501132855b5e59029acfc5d3da1ebd","modified":1632815299085},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"44f47c88c06d89d06f220f102649057118715828","modified":1632815299086},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"e740deadcfc4f29c5cb01e40f9df6277262ba4e3","modified":1632815299086},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"85da2f3006f4bef9a2199416ecfab4d288f848c4","modified":1632815299087},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1632815299086},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1632815299099},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"fafc96c86926b22afba8bb9418c05e6afbc05a57","modified":1632815299073},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"2bd0eb1512415325653b26d62a4463e6de83c5ac","modified":1632815299073},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1632815299073},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"e771dcb0b4673e063c0f3e2d73e7336ac05bcd57","modified":1632815299073},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"d21d4ac1982c13d02f125a67c065412085a92ff2","modified":1632815299073},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1632815299098},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f49ca072b5a800f735e8f01fc3518f885951dd8e","modified":1632815299068},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"e75693f33dbc92afc55489438267869ae2f3db54","modified":1632815299069},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"902569a9dea90548bec21a823dd3efd94ff7c133","modified":1632815299069},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"ded41fd9d20a5e8db66aaff7cc50f105f5ef2952","modified":1632815299069},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"1e4190c10c9e0c9ce92653b0dbcec21754b0b69d","modified":1632815299070},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"72d495a88f7d6515af425c12cbc67308a57d88ea","modified":1632815299068},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"65cb6edb69e94e70e3291e9132408361148d41d5","modified":1632815299067},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"d114b2a531129e739a27ba6271cfe6857aa9a865","modified":1632815299067},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"6a97bcfa635d637dc59005be3b931109e0d1ead5","modified":1632815299068},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"f5c2788a78790aca1a2f37f7149d6058afb539e0","modified":1632815299067},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"99e12c9ce3d14d4837e3d3f12fc867ba9c565317","modified":1632815299068},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1632815299069},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"8a7fc03a568b95be8d3337195e38bc7ec5ba2b23","modified":1632815299071},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"a760ee83ba6216871a9f14c5e56dc9bd0d9e2103","modified":1632815299067},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"b49e9fbd3c182b8fc066b8c2caf248e3eb748619","modified":1632815299072},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"e2992846b39bf3857b5104675af02ba73e72eed5","modified":1632815299072},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"9f0b93d109c9aec79450c8a0cf4a4eab717d674d","modified":1632815299071},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9a878d0119785a2316f42aebcceaa05a120b9a7a","modified":1632815299072},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e2d606f1ac343e9be4f15dbbaf3464bc4df8bf81","modified":1632815299079},{"_id":"themes/next/source/css/_common/outline/footer/footer.styl","hash":"454a4aebfabb4469b92a8cbb49f46c49ac9bf165","modified":1632815299077},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"e7a9fdb6478b8674b1cdf94de4f8052843fb71d9","modified":1632815299078},{"_id":"themes/next/source/css/_common/outline/header/header.styl","hash":"a793cfff86ad4af818faef04c18013077873f8f0","modified":1632815299079},{"_id":"themes/next/source/css/_common/outline/header/headerband.styl","hash":"0caf32492692ba8e854da43697a2ec8a41612194","modified":1632815299079},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"5f432a6ed9ca80a413c68b00e93d4a411abf280a","modified":1632815299078},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"45a239edca44acecf971d99b04f30a1aafbf6906","modified":1632815299078},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"b2fc519828fe89a1f8f03ff7b809ad68cd46f3d7","modified":1632815299079},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"2cb1876e9e0c9ac32160888af27b1178dbcb0616","modified":1632815299074},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"fa0222197b5eee47e18ac864cdc6eac75678b8fe","modified":1632815299076},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"44487d9ab290dc97871fa8dd4487016deb56e123","modified":1632815299075},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"1f0e7fbe80956f47087c2458ea880acf7a83078b","modified":1632815299076},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"9b479c2f9a9bfed77885e5093b8245cc5d768ec7","modified":1632815299075},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"a960a2dd587b15d3b3fe1b59525d6fa971c6a6ec","modified":1632815299075},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"a05a4031e799bc864a4536f9ef61fe643cd421af","modified":1632815299076},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar.styl","hash":"a9cd93c36bae5af9223e7804963096274e8a4f03","modified":1632815299076},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"b3220db827e1adbca7880c2bb23e78fa7cbe95cb","modified":1632815299076},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"2a47f8a6bb589c2fb635e6c1e4a2563c7f63c407","modified":1632815299075},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"f71a3e86c05ea668b008cf05a81f67d92b6d65e4","modified":1632815299059},{"_id":"themes/next/source/css/_common/scaffolding/highlight/diff.styl","hash":"d3f73688bb7423e3ab0de1efdf6db46db5e34f80","modified":1632815299060},{"_id":"themes/next/source/css/_common/scaffolding/highlight/highlight.styl","hash":"35c871a809afa8306c8cde13651010e282548bc6","modified":1632815299060},{"_id":"themes/next/source/css/_common/scaffolding/highlight/theme.styl","hash":"3b3acc5caa0b95a2598bef4eeacb21bab21bea56","modified":1632815299060},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"1d2778ca5aeeeafaa690dc2766b01b352ab76a02","modified":1632815299064},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"709d10f763e357e1472d6471f8be384ec9e2d983","modified":1632815299063},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"d7fce4b51b5f4b7c31d93a9edb6c6ce740aa0d6b","modified":1632815299063},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"e4d9a77ffe98e851c1202676940097ba28253313","modified":1632815299064},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1632815299062},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"f23670f1d8e749f3e83766d446790d8fd9620278","modified":1632815299062},{"_id":"themes/next/source/css/_common/scaffolding/tags/tags.styl","hash":"9e4c0653cfd3cc6908fa0d97581bcf80861fb1e7","modified":1632815299063},{"_id":"source/images/pasted-93.png","hash":"1497f41fb87303ac21a3be744345517e4533c32b","modified":1569828850889},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1632815299100},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1632815299100},{"_id":"source/images/pasted-96.png","hash":"3aaa0e5edaaec676ae377d989ec29641e62e3369","modified":1574669130102},{"_id":"source/images/pasted-107.png","hash":"40689da5551d863c31ad55603aa7de4408d38eb1","modified":1632801222570},{"_id":"public/404.html","hash":"4a731b3cbc178d5bec5727f783ad51124b2849dd","modified":1633661839315},{"_id":"public/about/index.html","hash":"de083f21b68a0f915d19eb0c6ff1d1a30ac618e2","modified":1633661839315},{"_id":"public/categories/index.html","hash":"ec70206c86496b69eb1c9d07a4e8cb93fa5df5f0","modified":1633661839315},{"_id":"public/schedule/index.html","hash":"4875840b63c76ea3d06f8cf9583ffaba5fe0fb89","modified":1633661839315},{"_id":"public/tags/index.html","hash":"fad1f6203b139b1ccac61cf5a54abd003c57b43c","modified":1633661839315},{"_id":"public/2021/09/28/hexo迁移（升级）常见问题/index.html","hash":"61b426b4b0d6037b2e9e493042b6daf777ae396d","modified":1633661839315},{"_id":"public/2019/04/08/谈一谈锁/index.html","hash":"2fb7f6707b5e66e431a2e99056d3bb7888e51cb6","modified":1633661839315},{"_id":"public/2019/03/07/dubbo-基于zookeeper的注册结构/index.html","hash":"3aac10f6230a6a093f7e3397ad52c05c12266907","modified":1633661839315},{"_id":"public/2018/07/12/druid-filter/index.html","hash":"44ea5b2b97bf1f8898cd5b6f997aed8279b4c949","modified":1633661839315},{"_id":"public/2018/05/28/JVM-类加载/index.html","hash":"da83007fd88f3301282a2be0b2f84c6fa432fee8","modified":1633661839315},{"_id":"public/2017/07/20/linux-tail命令不生效/index.html","hash":"edd2527198d38b9da9009e29941bac3604d62013","modified":1633661839315},{"_id":"public/2017/07/20/maven-Failed-to-execute-goal-org-apache-maven-plugins-maven-enforcer-plugin/index.html","hash":"0bfe54ad4801f5daa3b8e40ef7a7368202a87446","modified":1633661839315},{"_id":"public/2017/07/20/maven-No-plugin-found-for-prefix-tomcat7/index.html","hash":"681b52f1f6077d92da8b979288b974c7e3d95d5b","modified":1633661839315},{"_id":"public/2017/07/20/mysql-TIMESTAMP/index.html","hash":"a333870233c6efd6fd543a51e1c88b4a03d54cbd","modified":1633661839315},{"_id":"public/2017/07/20/浏览器-资源加载/index.html","hash":"10dfe8d07bb82f7686efccd7ec18575c831d0740","modified":1633661839315},{"_id":"public/archives/page/5/index.html","hash":"b63b7f5bb0b27ad61ec7eec672925c65de8228d9","modified":1633661839315},{"_id":"public/archives/2017/07/index.html","hash":"7a8bf469c31f17714ef7f335a701079afcaed36e","modified":1633661839315},{"_id":"public/archives/2017/09/index.html","hash":"d0ee34cf1a0f163c14189147bc5b3bee00c1e49e","modified":1633661839315},{"_id":"public/archives/2018/page/2/index.html","hash":"652e4a6df071c989d1e760be9967a1d443c2b970","modified":1633661839315},{"_id":"public/archives/2018/05/index.html","hash":"1f4913128c918b525adb7484a3e2e28129ccc925","modified":1633661839315},{"_id":"public/archives/2018/06/index.html","hash":"2f36db286d546f50a96eb90f3098e430a35b3b7e","modified":1633661839315},{"_id":"public/archives/2018/07/index.html","hash":"ef79d7b0d9e4c29e758a45844c7e285755b8a84d","modified":1633661839315},{"_id":"public/archives/2018/08/index.html","hash":"e909866fc399fc0bce1eacc47708e777fa827fbf","modified":1633661839315},{"_id":"public/archives/2018/09/index.html","hash":"fdf109e935d07649210896be54b0bade7a52dc6c","modified":1633661839315},{"_id":"public/archives/2018/10/index.html","hash":"daa82c1758204ba66ee27d97ace84f75963c9f5e","modified":1633661839315},{"_id":"public/archives/2018/11/index.html","hash":"b2ee8d67e5097912fe719c8f20dcf583c2fb6eab","modified":1633661839315},{"_id":"public/archives/2018/12/index.html","hash":"9efd27cffc802b1bb1a848591d6919c5800a2950","modified":1633661839315},{"_id":"public/archives/2019/page/2/index.html","hash":"d4baa358af44759ae725598c0866da8ad3902624","modified":1633661839315},{"_id":"public/archives/2019/01/index.html","hash":"f0335d09bfe9f9bf7f8b156faffc30a18ce3e3aa","modified":1633661839315},{"_id":"public/archives/2019/03/index.html","hash":"79088c7696cd98c16b18f1a4456cdc8e3e714473","modified":1633661839315},{"_id":"public/archives/2019/04/index.html","hash":"aea227771348c0e0b0c32010e5648b629ccf7f9a","modified":1633661839315},{"_id":"public/archives/2019/05/index.html","hash":"867636d1f99be93d57bf4718b92eeaf26fc7b7e6","modified":1633661839315},{"_id":"public/archives/2019/06/index.html","hash":"d8d93c608bbf4e77d979292ddff9d0726187644a","modified":1633661839315},{"_id":"public/archives/2019/07/index.html","hash":"097e264efd9de93413446527e6d88e4b740f8bc6","modified":1633661839315},{"_id":"public/archives/2019/11/index.html","hash":"ab2d674375f536e4b6782196d23617103f9eff23","modified":1633661839315},{"_id":"public/archives/2020/index.html","hash":"622582a29caacb5f10479e0cb7861fa724edb106","modified":1633661839315},{"_id":"public/archives/2020/01/index.html","hash":"6864760385b5f01682802163e5a9eed0a1fcc450","modified":1633661839315},{"_id":"public/archives/2020/07/index.html","hash":"91b1f5425549dc1ec6f1d6a43a4625345cfeca2c","modified":1633661839315},{"_id":"public/archives/2021/index.html","hash":"8b80697ce58b370c0a1cda9f12feb51a1080df2b","modified":1633661839315},{"_id":"public/archives/2021/09/index.html","hash":"39751afadc2167a1ea5f0985daced0687317d7bd","modified":1633661839315},{"_id":"public/archives/2021/10/index.html","hash":"aef3835154a2fd2b383d3e5a44c16a3ed48e0529","modified":1633661839315},{"_id":"public/categories/爱学爱问/page/3/index.html","hash":"c4ac77014d72ae018b00bdfd39fd3dddfb6edcd8","modified":1633661839315},{"_id":"public/categories/这些年，那些坑/page/2/index.html","hash":"a73e1cca46d954a23b219023187c054f9b5d9b1e","modified":1633661839315},{"_id":"public/categories/hexo安装/index.html","hash":"e53ac30b74695741f0528ade327bccfc17fa3253","modified":1633661839315},{"_id":"public/categories/专题研讨/index.html","hash":"15e2d0708a52e5433915d3f5626f5cd2bbcd4f46","modified":1633661839315},{"_id":"public/categories/外部引用/index.html","hash":"18ad3105742a01ca530bf934e435d9e471c67f12","modified":1633661839315},{"_id":"public/categories/你好，源码/index.html","hash":"0a0fd96f96f26b1037af62af95839246004dbb35","modified":1633661839315},{"_id":"public/tags/类加载/index.html","hash":"dcf0bc54d1013fe38122623f96ca9081d3435901","modified":1633661839315},{"_id":"public/tags/javaagent/index.html","hash":"2917b1889bab8bd7d27f57f6266405ba8b3c72a8","modified":1633661839315},{"_id":"public/tags/GC-G1/index.html","hash":"5c2b26b47aa430d12cbd202775b636729de8fa20","modified":1633661839315},{"_id":"public/tags/JVM/index.html","hash":"4924fdab1d683c6d3b04248f4d1c5b0a61358eb3","modified":1633661839315},{"_id":"public/tags/GC/index.html","hash":"2538834f48693e4cefe18d59e69aa2d1a0a7c1ef","modified":1633661839315},{"_id":"public/tags/HttpURLConnection/index.html","hash":"f9d18f175be763fee774114246c3b03bd8985f17","modified":1633661839315},{"_id":"public/tags/HttpRequestMethodNotSupportedException/index.html","hash":"43aa0715825dd35e9a6166f9777cdcebabede2a4","modified":1633661839315},{"_id":"public/tags/post-get请求/index.html","hash":"debf68e806e0b1529274c85c69c2b66b5f3beaab","modified":1633661839315},{"_id":"public/tags/NoClassDefFoundError/index.html","hash":"ea009b03d275dbc4b888773de37a03b217d0bcdd","modified":1633661839315},{"_id":"public/tags/类加载异常/index.html","hash":"f7024d07946431231ba82be381b88da0c16d5ff3","modified":1633661839315},{"_id":"public/tags/disruptor/index.html","hash":"7a1c3d065f20898f9919e2f3c27edc913cdd87d4","modified":1633661839315},{"_id":"public/tags/数据库连接池/index.html","hash":"a6f7e7dae238112cd90a9ae9dfc75aeb8b645e45","modified":1633661839315},{"_id":"public/tags/db/index.html","hash":"90597bb1bbc690ba67c8c32dc716906435904aa6","modified":1633661839315},{"_id":"public/tags/druid/index.html","hash":"05566e711b144d9ba53a7522c11016ccdac6fdae","modified":1633661839315},{"_id":"public/tags/连接池/index.html","hash":"ae7c1327192a78975b637a3757206ee5be625b00","modified":1633661839315},{"_id":"public/tags/dubbo/index.html","hash":"1634c3f1bab05a6af22bc37237db4b9f31c13ea2","modified":1633661839315},{"_id":"public/tags/序列化/index.html","hash":"4af52f5f96c738492137573de2b8ebf209c6bba2","modified":1633661839315},{"_id":"public/tags/hessian/index.html","hash":"b08029efc7e0e201a69c9efd67a80cf61010cca6","modified":1633661839315},{"_id":"public/tags/zookeeper/index.html","hash":"acced564ba48cf644f3a5d67c043348070b6373a","modified":1633661839315},{"_id":"public/tags/elk/index.html","hash":"99d0711044863e36c4ed6314e55d28ab4022aaa3","modified":1633661839315},{"_id":"public/tags/集群/index.html","hash":"271f2b68e05b6cda1e9543c3290a771271167882","modified":1633661839315},{"_id":"public/tags/git/index.html","hash":"05429661bc2f1da7de75b9ee09844faf749c7d55","modified":1633661839315},{"_id":"public/tags/版本控制/index.html","hash":"fa572ea0e5879f4e43f6386fee2ed3cdb3f451d0","modified":1633661839315},{"_id":"public/tags/grafana/index.html","hash":"ce9314f3846153507e34c2c62b35a36829f12688","modified":1633661839315},{"_id":"public/tags/hexo/index.html","hash":"5c864d4f9056ce85e7de32cdf7791522a83bf5f8","modified":1633661839315},{"_id":"public/tags/java/index.html","hash":"e1de41295efa39701580124071665c137f96dd11","modified":1633661839315},{"_id":"public/tags/java对象/index.html","hash":"9c1c058f8ae2d6a37c7a1ae84308bb18a2c20246","modified":1633661839315},{"_id":"public/tags/jdk8/index.html","hash":"e508c89b93e6adb63b650d05621aaa500990c756","modified":1633661839315},{"_id":"public/tags/dump/index.html","hash":"97701c762a94403a45025efc54b44acb3a2c2c3a","modified":1633661839315},{"_id":"public/tags/linux/index.html","hash":"24d0dc0024b0041cfe4ad91b5c832c3b81f434ba","modified":1633661839315},{"_id":"public/tags/tail/index.html","hash":"935774f0d6a2541ecfe32ca4769823aea4f7d0db","modified":1633661839315},{"_id":"public/tags/maven/index.html","hash":"5d2701181a4aaadcf336557a851a736280886240","modified":1633661839315},{"_id":"public/tags/jdk/index.html","hash":"8e262c7cf6c73a5ae7c87e12446d71e1d76305a4","modified":1633661839315},{"_id":"public/tags/mysql/index.html","hash":"5c2fe6c5a1d237d757e3dbeb1b4f54488b407361","modified":1633661839315},{"_id":"public/tags/mongo/index.html","hash":"bd14256fe748eb7abf92a85da96da3b181295ede","modified":1633661839315},{"_id":"public/tags/rabbitmq/index.html","hash":"16cdb861294be37b605c19b4ef972990605b8759","modified":1633661839315},{"_id":"public/tags/消息队列/index.html","hash":"66c42182cb88b371620504db88999da3b0a8c070","modified":1633661839315},{"_id":"public/tags/spring/index.html","hash":"00acd078098fee3b51201f3c348dc7f456be5501","modified":1633661839315},{"_id":"public/tags/springboot/index.html","hash":"fa2b9980a7a61536ca4924115114f565df051aca","modified":1633661839315},{"_id":"public/tags/应用监控检查/index.html","hash":"bf1aa2835f9548383a0d46e17aa3d1e61db79637","modified":1633661839315},{"_id":"public/tags/struts2/index.html","hash":"4423af1590d617b7b248aa9ff5d1975b03bc3713","modified":1633661839315},{"_id":"public/tags/内存泄漏/index.html","hash":"e9381e1489e635c36f986f524f520bc835f63ece","modified":1633661839315},{"_id":"public/tags/mat/index.html","hash":"31e57e06c3b7d7104263f9410a13b9666e99f92f","modified":1633661839315},{"_id":"public/tags/微服务/index.html","hash":"c1a9dd0decc9f9d484987f96672291f6e4b9101b","modified":1633661839315},{"_id":"public/tags/图片压缩/index.html","hash":"940d6ea71cf68553914838864366f0863a1fcb0f","modified":1633661839315},{"_id":"public/tags/ImageIO/index.html","hash":"c1a635e498515d393f9dd19e645fa27a9582a077","modified":1633661839315},{"_id":"public/tags/优雅停机/index.html","hash":"86d025590ed768c572c1d39b1ea5ee6b29760e46","modified":1633661839315},{"_id":"public/tags/浏览器/index.html","hash":"0ce270a0af76f55444b08ecf992e335b631c0354","modified":1633661839315},{"_id":"public/tags/架构/index.html","hash":"8522a0b0cc4dac1e4dce5c9af857fcd5aa559087","modified":1633661839315},{"_id":"public/tags/bytebuddy/index.html","hash":"e17f64f3df835fec2afd55e75680f9bb410adbe5","modified":1633661839315},{"_id":"public/tags/spring-boot/index.html","hash":"f98e94ff2ebc795684a16ad05f9e3a58ef398c91","modified":1633661839315},{"_id":"public/tags/jsp/index.html","hash":"255999c90f0affe2a5b687078ae90d4e4c0e5f6f","modified":1633661839315},{"_id":"public/tags/内存调优/index.html","hash":"b3d5ef74dab08baa2e1330726255e0d9cb2bdda7","modified":1633661839315},{"_id":"public/tags/垃圾回收/index.html","hash":"af540da5838baffbe7f3598653aa42340d47dfa8","modified":1633661839315},{"_id":"public/2021/10/08/fastdfs异常分析/index.html","hash":"b850d35ce207471115460a694867b3ee1c17e0e7","modified":1633661839315},{"_id":"public/2020/07/21/rocketmq异常分析/index.html","hash":"aea1d1a735315127821cb739ee6080432ee5753f","modified":1633661839315},{"_id":"public/2020/01/10/剥开源码看java/index.html","hash":"bfdc4ac2b591f85dec5336443d07bd4f4665df5f","modified":1633661839315},{"_id":"public/2019/11/25/grafana安装及使用/index.html","hash":"550a2e077f67d55c6c917b306f646fa4714f66ca","modified":1633661839315},{"_id":"public/2019/07/11/mysql数据库wait-timeout问题/index.html","hash":"6c2de8d28412c8e3fc36bbbca8cf423291b70385","modified":1633661839315},{"_id":"public/2019/07/08/spring-boot1-3-5支持jsp导致浏览器访问应用偶尔慢/index.html","hash":"88d06cff28dace040f2f1296a7f2cd8c2b6952bc","modified":1633661839315},{"_id":"public/2019/06/05/ava-lang-NoClassDefFoundError-Could-not-initialize-class/index.html","hash":"a8c44764ccac0cdccac31e3f240e65423afc4d5e","modified":1633661839315},{"_id":"public/2019/05/16/HttpURLConnection-关于HttpRequestMethodNotSupportedException异常/index.html","hash":"2b8c5da2944c4ec810e55bc2c471ce10e3391a63","modified":1633661839315},{"_id":"public/2019/05/06/围绕dubbo底层原理漫谈微服务/index.html","hash":"0fdafa33636be75b9b905c22d5834f7d8f5e64ee","modified":1633661839315},{"_id":"public/2019/04/28/git-本地commit、push、show、reset操作/index.html","hash":"037e3051763837091634c5c33df97bee175663d2","modified":1633661839315},{"_id":"public/2019/04/11/图片压缩-ImageIO-read-inputStream/index.html","hash":"a4c586d167273888283010b71f8987d728d15570","modified":1633661839315},{"_id":"public/2019/04/10/G1-Evacuation-Failure/index.html","hash":"7a01a7ca8b81751c75d8c37e17698fa2872e01e9","modified":1633661839315},{"_id":"public/2019/04/10/G1-Humongous-Allocation/index.html","hash":"32067e30560ee196a96f386df8beb38531c16d41","modified":1633661839315},{"_id":"public/2019/04/09/G1垃圾回收器-xx-initiatingheapoccupancypercent变量之问/index.html","hash":"9518ae74c8b02bfd7b8936e06ca60fe1a4722814","modified":1633661839315},{"_id":"public/2019/04/08/浅谈JVM之垃圾回收/index.html","hash":"2bd4923dc5960902c9e5b9711f7d14592522c3d8","modified":1633661839315},{"_id":"public/2019/01/18/druid连接的获取与创建/index.html","hash":"c7b8acc1c7e84b19a70607de3d9caf02a824ca45","modified":1633661839315},{"_id":"public/2018/12/07/mongo-查询报no-property-found-on/index.html","hash":"5bd426c8c2deb68e28e381a452dbc73161d73578","modified":1633661839315},{"_id":"public/2018/11/13/disruptor为什么那么快/index.html","hash":"fbe4f35a3db6431eeb7225cf740ff1e0408fe825","modified":1633661839315},{"_id":"public/2018/11/01/Class及javaagent装载简述/index.html","hash":"981507ac9229bff0ee344421956a3bca92e316a5","modified":1633661839315},{"_id":"public/2018/10/31/javaagent-bytebuddy/index.html","hash":"a4ad83ec67b266cc6ff33b5ca5c18887cfcfa7a0","modified":1633661839315},{"_id":"public/2018/09/10/zookeeper-反复重连问题/index.html","hash":"96b67cda36d02efc1a8ddfb890797929136fdfd1","modified":1633661839315},{"_id":"public/2018/09/10/jdk8-dump异常/index.html","hash":"df801b412f1b4b11cab38e75c47e159304ef4896","modified":1633661839315},{"_id":"public/2018/08/06/java-对象使用问题案例/index.html","hash":"ca1d1c721b87dd2f09d92718884aec3b4873281b","modified":1633661839315},{"_id":"public/2018/07/30/数据库-kill服务进程引发的血案/index.html","hash":"a5dba6798aaa60a8bd5f191a12211a3c871b1cd2","modified":1633661839315},{"_id":"public/2018/07/22/数据库-重启引发的主键问题/index.html","hash":"fa20594ab928188e5386d2cf6d9e5dd9de8803c0","modified":1633661839315},{"_id":"public/2018/07/19/rabbitmq-报not-equivalent错/index.html","hash":"769fabf387b594d7c3ee228283d4e1944d32d181","modified":1633661839315},{"_id":"public/2018/07/17/应用停机-优雅停机问题/index.html","hash":"d7b5f0fe9fcb58d6bec3a3b56a5517667f799445","modified":1633661839315},{"_id":"public/2018/07/12/springboot-spring-boot-starter-actuator/index.html","hash":"1b40f048a0478404141d1d79c5e3f185ed87024d","modified":1633661839315},{"_id":"public/2018/07/09/内存泄漏案例分析/index.html","hash":"c59742504faf9c34a59bc4c1770d655e19699e6c","modified":1633661839315},{"_id":"public/2018/06/28/dubbo-反序列化问题/index.html","hash":"a6487e547b47d07a59022dbdaff937441ee419c9","modified":1633661839315},{"_id":"public/2018/06/12/dubbo-（反）序列化/index.html","hash":"ace652fe76202f9690f4de3c202e0f8a260eaa6b","modified":1633661839315},{"_id":"public/2017/09/27/elasticsearch-集群/index.html","hash":"cb08b352e96690f836a22e78454749f67e6af5cc","modified":1633661839315},{"_id":"public/2017/07/20/maven-Plugin-execution-not-covered-by-lifecycle-configuration/index.html","hash":"722ab1028c68cd7ec04c1a004cc08bd72c134fe0","modified":1633661839315},{"_id":"public/2017/07/20/maven-默认jdk版本/index.html","hash":"6ab17c85e45fd3f2919e3c448dde63bc1955460c","modified":1633661839315},{"_id":"public/2017/07/20/struts2-no-action-in-maven/index.html","hash":"ffb57c67d98d5e442fc5fe1869bf5f97dc1e1a19","modified":1633661839315},{"_id":"public/2017/07/20/淘宝架构-进化/index.html","hash":"f3cc682f59da03359adfdb8d9b76371b9a458e0a","modified":1633661839315},{"_id":"public/archives/index.html","hash":"a221c1a769b6a0c5db34e4ea8bf861c71b776740","modified":1633661839315},{"_id":"public/archives/page/2/index.html","hash":"022577f4c9fc09f9aa79a8b78d1350cc5a5e5df6","modified":1633661839315},{"_id":"public/archives/page/3/index.html","hash":"2d9fb6104a65e4640ae283ca6035be36ae74893e","modified":1633661839315},{"_id":"public/archives/page/4/index.html","hash":"d4b2c86e8790e1b0ed04d455ed0e40474a2e9493","modified":1633661839315},{"_id":"public/archives/2017/index.html","hash":"88d3545ae505f61b931327b72cfb8344956bfb5a","modified":1633661839315},{"_id":"public/archives/2018/index.html","hash":"c5c87db52105ba2653ad3b3d25da6d280aaa2838","modified":1633661839315},{"_id":"public/archives/2019/index.html","hash":"475929b5c67c8686f36c7a0f165c06a43eebe6fe","modified":1633661839315},{"_id":"public/categories/爱学爱问/index.html","hash":"b06f83bc707fcf8c0ce4b62914c3f5aaf5dfa539","modified":1633661839315},{"_id":"public/categories/爱学爱问/page/2/index.html","hash":"58de7b85cdb21b53b109940b350ad38a3013c223","modified":1633661839315},{"_id":"public/categories/这些年，那些坑/index.html","hash":"bc15b3c279c4cc20ff450ac8d358da11efd3f6ea","modified":1633661839315},{"_id":"public/index.html","hash":"c39402e13f9a9e5168894cad72d7b1494b67eece","modified":1633661839315},{"_id":"public/page/2/index.html","hash":"71a77cb46d0821597282a3b9d90ba6daf2888649","modified":1633661839315},{"_id":"public/page/3/index.html","hash":"3c1f670c03cbf36155bf29756e304b09d464512f","modified":1633661839315},{"_id":"public/page/4/index.html","hash":"8ca25174e8b27dbe9ddcfa1a6b5a12eb5d62b2a6","modified":1633661839315},{"_id":"public/page/5/index.html","hash":"936d4ab94f27ad8c20c7f3ed6f79cf6d6cc62fb6","modified":1633661839315},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1633661839315},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1633661839315},{"_id":"public/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1633661839315},{"_id":"public/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1633661839315},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1633661839315},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1633661839315},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1633661839315},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1633661839315},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1633661839315},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1633661839315},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1633661839315},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1633661839315},{"_id":"public/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1633661839315},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1633661839315},{"_id":"public/images/pasted-0.png","hash":"3c5bebef8fcf19a8f2c98a88495866b25e28c288","modified":1633661839315},{"_id":"public/images/pasted-10.png","hash":"7c63f1cc32c191cff49ec5bee0634ffebb4d0f41","modified":1633661839315},{"_id":"public/images/pasted-105.png","hash":"6b2e3a2cf1fc97849907b3a5ea397ff2148215b8","modified":1633661839315},{"_id":"public/images/pasted-104.png","hash":"cd95ccb31d43d2543a68c040a6f7f3a1f8cf1381","modified":1633661839315},{"_id":"public/images/pasted-103.png","hash":"254100ad1df6d24ff16a7dfc170ed17227cb0e92","modified":1633661839315},{"_id":"public/images/pasted-11.png","hash":"0da5839c58d93b98b577b40374630992516397c9","modified":1633661839315},{"_id":"public/images/pasted-14.png","hash":"7d7fa913eef8c753d25b24cd610297be8e979e79","modified":1633661839315},{"_id":"public/images/pasted-19.png","hash":"1f045eed6f9ebad8ee4981bb2ac7e571400fa789","modified":1633661839315},{"_id":"public/images/pasted-18.png","hash":"895e9a3d62baa7c9da9af873b11cf74377ac99a4","modified":1633661839315},{"_id":"public/images/pasted-2.png","hash":"572b64658cfaa1bf0b752a9408821f4133331a5e","modified":1633661839315},{"_id":"public/images/pasted-24.png","hash":"12d854af02c4101e329dcdecd1a3aba33a030f60","modified":1633661839315},{"_id":"public/images/pasted-26.png","hash":"5b5fe3fba7c5b2691e4aca04216d02dabc66cea5","modified":1633661839315},{"_id":"public/images/pasted-27.png","hash":"76ebe1be5de9bc77ba3bded99b0e421a67554dfc","modified":1633661839315},{"_id":"public/images/pasted-28.png","hash":"a334565cd08774738f05af99cd25449b40afeecd","modified":1633661839315},{"_id":"public/images/pasted-29.png","hash":"a334565cd08774738f05af99cd25449b40afeecd","modified":1633661839315},{"_id":"public/images/pasted-32.png","hash":"5da3568c83cdc7f1665806c152f922bd3a260fb5","modified":1633661839315},{"_id":"public/images/pasted-33.png","hash":"0e1a4784aec0a0d49f2cef37b9ced85eae0f19d1","modified":1633661839315},{"_id":"public/images/pasted-34.png","hash":"b6883d450159369476845b3304599b33d55bc25b","modified":1633661839315},{"_id":"public/images/pasted-36.png","hash":"e1d15b97163e3f49aa6fca964e36bfaec20505d7","modified":1633661839315},{"_id":"public/images/pasted-39.png","hash":"8015ae73c4b94397bf2b04bfb833472f89244532","modified":1633661839315},{"_id":"public/images/pasted-40.png","hash":"efc5da95b15c817fd34471f30d13ec7780521514","modified":1633661839315},{"_id":"public/images/pasted-37.png","hash":"a647f6b5f4af9c97b0345064c2e03bed433fb7e5","modified":1633661839315},{"_id":"public/images/pasted-38.png","hash":"97f34628fd7816d9daa1e799fcc756bbbca82ad9","modified":1633661839315},{"_id":"public/images/pasted-41.png","hash":"8cfaf01339aae2e46dbf5ce7863086caaeb32b3f","modified":1633661839315},{"_id":"public/images/pasted-44.png","hash":"ac34c1452a07347421b6cbf52c8f768d3084fa75","modified":1633661839315},{"_id":"public/images/pasted-43.png","hash":"58ede5e6d6feff9b62ae537856c96f87d269aa01","modified":1633661839315},{"_id":"public/images/pasted-42.png","hash":"1b63b44b25fe9690c2a4bff85a2b164ddc191e44","modified":1633661839315},{"_id":"public/images/pasted-48.png","hash":"0afe35569b77ebb8ad4c198203c3dc6937942ad4","modified":1633661839315},{"_id":"public/images/pasted-47.png","hash":"39f267579a50d5fefc1a29ed0383718433ad685a","modified":1633661839315},{"_id":"public/images/pasted-45.png","hash":"540bcd2ecf51702fcf7cfa8aa41eac361e742f2a","modified":1633661839315},{"_id":"public/images/pasted-55.png","hash":"fdde17b659e2a2a594638d9b9612ac39d5251f10","modified":1633661839315},{"_id":"public/images/pasted-53.png","hash":"9af4c8c80a9f1316559b9f7e20879443daaf564f","modified":1633661839315},{"_id":"public/images/pasted-54.png","hash":"3e3fece4e90e123648dafc121d8222d70fead0bf","modified":1633661839315},{"_id":"public/images/pasted-56.png","hash":"1deba22e9e40e5868dc4477130cd8092968209fb","modified":1633661839315},{"_id":"public/images/pasted-7.png","hash":"18d586673d7d12e0b4cb6b0ec7679b995b8d57ae","modified":1633661839315},{"_id":"public/images/pasted-74.png","hash":"3bdade1953defd13b321d950a50ca5c86c43158e","modified":1633661839315},{"_id":"public/images/pasted-78.png","hash":"2b11a4e1ff18042805be90368313d1fc2836c077","modified":1633661839315},{"_id":"public/images/pasted-79.png","hash":"35cd3e00659da093f91b67dcdca1254e170265a0","modified":1633661839315},{"_id":"public/images/pasted-8.png","hash":"553fb1dd618d381332e5e33b0ddcdb9e65e3e8c8","modified":1633661839315},{"_id":"public/images/pasted-88.png","hash":"f8809fa8c8a8031757fada066764cec3f80f30b7","modified":1633661839315},{"_id":"public/images/pasted-90.png","hash":"94c35ffe97aa6bc51b7b9c32e9f2cc7f6ed5ae1e","modified":1633661839315},{"_id":"public/images/pasted-91.png","hash":"7315a6d51e9005f02022ccfb5bfec68ff79f068a","modified":1633661839315},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1633661839315},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1633661839315},{"_id":"public/images/pasted-1.png","hash":"2fa5474ed957c6db8a1706c0dd6f7ebe246fe8ce","modified":1633661839315},{"_id":"public/images/pasted-15.png","hash":"982268d3cc54f70beae137f40c0e829ecc79e267","modified":1633661839315},{"_id":"public/images/pasted-16.png","hash":"4bd7bdf4bb0e335166ca6b73d2519ecde5186c13","modified":1633661839315},{"_id":"public/images/pasted-25.png","hash":"4b73f1a98581612d407594370e5c5397a5c80d1e","modified":1633661839315},{"_id":"public/images/pasted-22.png","hash":"c559fed4f04798d54344a2be9eb426aed2d090cd","modified":1633661839315},{"_id":"public/images/pasted-3.png","hash":"542656a87c61559ba6b9de7d898959ce5b66bf26","modified":1633661839315},{"_id":"public/images/pasted-30.png","hash":"c14c8dc37a7346d34faeec058c2433e2fe6b230d","modified":1633661839315},{"_id":"public/images/pasted-31.png","hash":"34d16af5e5c08ed5d21e4dba6a9f824a38ffdf95","modified":1633661839315},{"_id":"public/images/pasted-35.png","hash":"5cdd93179bbd33c52c5e882e1794c22c2b1ac83e","modified":1633661839315},{"_id":"public/images/pasted-4.png","hash":"f08def5db40d8ced9cdf23d5d0261ecbb0d245c5","modified":1633661839315},{"_id":"public/images/pasted-46.png","hash":"0750ae34c5cd71f65471af8135d2ab204fa189cc","modified":1633661839315},{"_id":"public/images/pasted-52.png","hash":"51a45ad8a44ebfab8ca80997109a0fb5b48636b2","modified":1633661839315},{"_id":"public/images/pasted-6.png","hash":"aa86792c3bd66a7ebd57dcf17ab6bdae6fb225f1","modified":1633661839315},{"_id":"public/images/pasted-81.png","hash":"5a9d6133fd4bfe9d3a13dc6113f304e57b994e61","modified":1633661839315},{"_id":"public/images/pasted-80.png","hash":"5a9d6133fd4bfe9d3a13dc6113f304e57b994e61","modified":1633661839315},{"_id":"public/images/pasted-83.png","hash":"5726b4f909889a8e4f623d0be3d2d12b17d4843d","modified":1633661839315},{"_id":"public/images/pasted-82.png","hash":"5726b4f909889a8e4f623d0be3d2d12b17d4843d","modified":1633661839315},{"_id":"public/images/pasted-84.png","hash":"229c81eac1c42191213104127e651373e07fa448","modified":1633661839315},{"_id":"public/images/pasted-86.png","hash":"2e1b172082acca1196b060c6b5f6ddee61be6115","modified":1633661839315},{"_id":"public/images/pasted-85.png","hash":"fe2ba5308626a0bf3e5eeda6bf02b89cd64be246","modified":1633661839315},{"_id":"public/images/pasted-87.png","hash":"8bb6eea25f41a4fd090f27afa10dfc1a8fc80b2a","modified":1633661839315},{"_id":"public/images/pasted-89.png","hash":"9b941fd9660b9e8e4ad2eda5f26b6df8d335dfb8","modified":1633661839315},{"_id":"public/images/pasted-99.png","hash":"112c1cc3c9f78f862deaef66b2d44e77afbef64c","modified":1633661839315},{"_id":"public/images/pasted-12.png","hash":"2b99b4381ba748311a8dd92588cf491a4059b9bc","modified":1633661839315},{"_id":"public/images/pasted-13.png","hash":"2b99b4381ba748311a8dd92588cf491a4059b9bc","modified":1633661839315},{"_id":"public/images/pasted-17.png","hash":"bbcd99aad0b7a56282018978f9557c8aa1c7cfc6","modified":1633661839315},{"_id":"public/images/pasted-49.png","hash":"5fe72327894be154937213278bb11b1518b55a09","modified":1633661839315},{"_id":"public/images/pasted-63.png","hash":"a826b0f8a6429ec65457d870d1dac716809350a1","modified":1633661839315},{"_id":"public/images/pasted-66.png","hash":"11d50c0829aa49841290a327bdb07fa93c5f4d0c","modified":1633661839315},{"_id":"public/images/pasted-67.png","hash":"e81bad45392314c20c8d3685e35d8043f4bc890f","modified":1633661839315},{"_id":"public/images/pasted-70.png","hash":"7e20959399a3a2c3d542146497ba2a9e9c835a46","modified":1633661839315},{"_id":"public/images/pasted-71.png","hash":"63976f2ebfb713cf2a7f2a7e6ad938184257a76d","modified":1633661839315},{"_id":"public/images/pasted-72.png","hash":"df875e0200cbb1b602927008f8c38780d282137d","modified":1633661839315},{"_id":"public/images/pasted-75.png","hash":"cf8886ec72d78f57821f0d790246cf3b5e47e90e","modified":1633661839315},{"_id":"public/images/pasted-9.png","hash":"92fb7b9ed14256063d814aeb1c64417999d12529","modified":1633661839315},{"_id":"public/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1633661839315},{"_id":"public/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1633661839315},{"_id":"public/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1633661839315},{"_id":"public/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1633661839315},{"_id":"public/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1633661839315},{"_id":"public/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1633661839315},{"_id":"public/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1633661839315},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1633661839315},{"_id":"public/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1633661839315},{"_id":"public/css/main.css","hash":"aeb18e55c83c508f46573a22d9909927e50103ba","modified":1633661839315},{"_id":"public/images/pasted-101.png","hash":"4df8edd360d3470b515a6c10741488bf354a4b08","modified":1633661839315},{"_id":"public/images/pasted-51.png","hash":"3cfc16acb4552defa33fc0d75fcfc7d6ad8bf991","modified":1633661839315},{"_id":"public/images/pasted-62.png","hash":"4e72259755fba0a8b1d9f9ce99605d6e195ad6a8","modified":1633661839315},{"_id":"public/images/pasted-64.png","hash":"6660e84279f054a10a2ecebef0fc96050c59518c","modified":1633661839315},{"_id":"public/images/pasted-65.png","hash":"2f813950fc8b41ddf92089e9635a34e78d3683b7","modified":1633661839315},{"_id":"public/images/pasted-68.png","hash":"eef4a8b3e8ee56f95c8b8ff89ff56cdda316006c","modified":1633661839315},{"_id":"public/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1633661839315},{"_id":"public/images/pasted-5.png","hash":"f3b4cea1946a8308ebd0a158fba6badd50b8e061","modified":1633661839315},{"_id":"public/images/pasted-60.png","hash":"df2d739232ca94f0aadb66dcb0ee00c1354bdbdd","modified":1633661839315},{"_id":"public/images/pasted-69.png","hash":"6eae5d2deb562a15c884ea950175f6e9e114745a","modified":1633661839315},{"_id":"public/images/pasted-95.png","hash":"24de01c15750fcc463d3456581b94bf1bf9d90d2","modified":1633661839315},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1633661839315},{"_id":"public/images/pasted-106.png","hash":"e77b6cdcbc9f829618d663c8a5cd53afb5fedd48","modified":1633661839315},{"_id":"public/images/pasted-50.png","hash":"69eedb93a41e66286f300eb3e330b7ad54c7be63","modified":1633661839315},{"_id":"public/images/pasted-57.png","hash":"4579bebdf9fff7ce70063012a5042d45d657e0c3","modified":1633661839315},{"_id":"public/images/pasted-59.png","hash":"0362818f13459539382e17dbeb4c89a5436aa2c1","modified":1633661839315},{"_id":"public/images/pasted-77.png","hash":"0161351bf707e06c019ed2f5d26569fa45e21d40","modified":1633661839315},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1633661839315},{"_id":"public/images/pasted-100.png","hash":"ef2a64357dea69bf05d6cde0c489f42d6a7c61c7","modified":1633661839315},{"_id":"public/images/pasted-61.png","hash":"d0c99730ed8a3d141fcb016e5dea7509584497a7","modified":1633661839315},{"_id":"public/images/pasted-94.png","hash":"590e8bd643395978cafd5d8295b86fdfabac0902","modified":1633661839315},{"_id":"public/images/pasted-58.png","hash":"e83295ea073c15b6e07d66f853bbea4a0d679222","modified":1633661839315},{"_id":"public/images/pasted-102.png","hash":"5fb7802d8a9aef34ab4ba25bf59fa5d8b8439ab6","modified":1633661839315},{"_id":"public/images/pasted-21.png","hash":"e31d7b92b0c58faeecdd44c8ad00eeb9a3783e53","modified":1633661839315},{"_id":"public/images/pasted-23.png","hash":"9c01c23fd815ffbd134add353fab53e9855254df","modified":1633661839315},{"_id":"public/images/pasted-73.png","hash":"ab091793d0efc9d6799db339265e4f08e63c18e7","modified":1633661839315},{"_id":"public/images/pasted-93.png","hash":"1497f41fb87303ac21a3be744345517e4533c32b","modified":1633661839315},{"_id":"public/images/pasted-76.png","hash":"60a5a8afca8ee12c8716d099cfa7dd246dda493d","modified":1633661839315},{"_id":"public/images/pasted-92.png","hash":"1497f41fb87303ac21a3be744345517e4533c32b","modified":1633661839315},{"_id":"public/images/pasted-20.png","hash":"6853b316e1e526f9bb5805b3bdd2f0260d4f9fe3","modified":1633661839315},{"_id":"public/images/pasted-97.png","hash":"2ec29984a0c8091ca630922f72543db3d0651ef0","modified":1633661839315},{"_id":"public/images/pasted-98.png","hash":"7a5754fcfd22013551d8297df7928d4c049cdf62","modified":1633661839315},{"_id":"public/images/pasted-96.png","hash":"3aaa0e5edaaec676ae377d989ec29641e62e3369","modified":1633661839315},{"_id":"public/images/pasted-107.png","hash":"40689da5551d863c31ad55603aa7de4408d38eb1","modified":1633661839315}],"Category":[{"name":"爱学爱问","_id":"ckuhs2vb10004wy665u7ehhiy"},{"name":"这些年，那些坑","_id":"ckuhs2vbf000uwy660nub1mfb"},{"name":"hexo安装","_id":"ckuhs2vbn001jwy664pb5d105"},{"name":"专题研讨","_id":"ckuhs2vc10030wy663c0qe15n"},{"name":"外部引用","_id":"ckuhs2vcs006mwy66f3giadvp"},{"name":"你好，源码","_id":"ckuhs2vcu006swy66elc39vzc"}],"Data":[],"Page":[{"_content":"<!DOCTYPE HTML>\n<html>\n<head>\n  <meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\"/>\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n  <meta name=\"robots\" content=\"all\" />\n  <meta name=\"robots\" content=\"index,follow\"/>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\">\n</head>\n<body>\n  <script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\"\n          charset=\"utf-8\" homePageUrl=\"/\"\n          homePageName=\"回到首页\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script>\n</body>\n</html>","source":"404.html","raw":"<!DOCTYPE HTML>\n<html>\n<head>\n  <meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\"/>\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n  <meta name=\"robots\" content=\"all\" />\n  <meta name=\"robots\" content=\"index,follow\"/>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\">\n</head>\n<body>\n  <script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\"\n          charset=\"utf-8\" homePageUrl=\"/\"\n          homePageName=\"回到首页\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script>\n</body>\n</html>","date":"2021-09-28T02:37:43.881Z","updated":"2019-09-30T07:34:10.835Z","path":"404.html","title":"","comments":1,"layout":"page","_id":"ckuhs2vau0000wy66dhw8cfwz","content":"<!DOCTYPE HTML>\n<html>\n<head>\n  <meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\"/>\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n  <meta name=\"robots\" content=\"all\" />\n  <meta name=\"robots\" content=\"index,follow\"/>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\">\n</head>\n<body>\n  <script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\"\n          charset=\"utf-8\" homePageUrl=\"/\"\n          homePageName=\"回到首页\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script>\n</body>\n</html>","site":{"data":{}},"length":0,"excerpt":"","more":"<!DOCTYPE HTML>\n<html>\n<head>\n  <meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\"/>\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n  <meta name=\"robots\" content=\"all\" />\n  <meta name=\"robots\" content=\"index,follow\"/>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\">\n</head>\n<body>\n  <script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\"\n          charset=\"utf-8\" homePageUrl=\"/\"\n          homePageName=\"回到首页\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script>\n</body>\n</html>"},{"title":"about","date":"2019-04-10T06:21:37.000Z","type":"about","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2019-04-10 14:21:37\ntype: \"about\"\n---\n","updated":"2019-09-30T07:34:10.840Z","path":"about/index.html","comments":1,"layout":"page","_id":"ckuhs2vb00002wy66a5c52ghj","content":"","site":{"data":{}},"length":0,"excerpt":"","more":""},{"title":"categories","date":"2019-04-08T09:39:57.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2019-04-08 17:39:57\ntype: \"categories\"\n---\n","updated":"2019-09-30T07:34:10.840Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckuhs2vb30006wy666g6o0zej","content":"","site":{"data":{}},"length":0,"excerpt":"","more":""},{"title":"schedule","date":"2019-04-10T06:22:00.000Z","type":"schedule","_content":"","source":"schedule/index.md","raw":"---\ntitle: schedule\ndate: 2019-04-10 14:22:00\ntype: \"schedule\"\n---\n","updated":"2019-09-30T07:34:10.890Z","path":"schedule/index.html","comments":1,"layout":"page","_id":"ckuhs2vb40008wy6668y1c8mx","content":"","site":{"data":{}},"length":0,"excerpt":"","more":""},{"title":"tags","date":"2019-04-10T05:52:42.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2019-04-10 13:52:42\ntype: \"tags\"\n---\n","updated":"2019-09-30T07:34:10.890Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckuhs2vb5000awy66gcfe7vrq","content":"","site":{"data":{}},"length":0,"excerpt":"","more":""}],"Post":[{"title":"class及javaagent装载简述","author":"Xiang Chuang","date":"2018-11-01T09:18:00.000Z","_content":"场景：有些时候我们想做一个通用的事情，这关系到各个应用系统，如采集应用系统产生的数据，当然，我们不想代码倾入到应用系统中，“偷偷摸摸、神不知鬼不觉”地干这些事，那么，你可以考虑考虑借鉴javaagent的思想在Class类加载期间干点事。\n\n![upload successful](\\images\\pasted-79.png)\n\njavaagent装载阶段预置了transformer\nclass装载阶段读取transformer信息并进行制定的处理\n\n因此，你可以在javaagent中自定义transformer以做你想做的事，如使用bytebuddy代理类（这个代理性能不错，学习成本低，当然如果你熟悉字节码，可以直接asm）\n","source":"_posts/Class及javaagent装载简述.md","raw":"title: class及javaagent装载简述\nauthor: Xiang Chuang\ntags:\n  - 类加载\n  - javaagent\ncategories:\n  - 爱学爱问\ndate: 2018-11-01 17:18:00\n---\n场景：有些时候我们想做一个通用的事情，这关系到各个应用系统，如采集应用系统产生的数据，当然，我们不想代码倾入到应用系统中，“偷偷摸摸、神不知鬼不觉”地干这些事，那么，你可以考虑考虑借鉴javaagent的思想在Class类加载期间干点事。\n\n![upload successful](\\images\\pasted-79.png)\n\njavaagent装载阶段预置了transformer\nclass装载阶段读取transformer信息并进行制定的处理\n\n因此，你可以在javaagent中自定义transformer以做你想做的事，如使用bytebuddy代理类（这个代理性能不错，学习成本低，当然如果你熟悉字节码，可以直接asm）\n","slug":"Class及javaagent装载简述","published":1,"updated":"2019-09-30T07:34:10.835Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vay0001wy66b8zvbniv","content":"<p>场景：有些时候我们想做一个通用的事情，这关系到各个应用系统，如采集应用系统产生的数据，当然，我们不想代码倾入到应用系统中，“偷偷摸摸、神不知鬼不觉”地干这些事，那么，你可以考虑考虑借鉴javaagent的思想在Class类加载期间干点事。</p>\n<p><img src=\"\\images\\pasted-79.png\" alt=\"upload successful\"></p>\n<p>javaagent装载阶段预置了transformer<br>class装载阶段读取transformer信息并进行制定的处理</p>\n<p>因此，你可以在javaagent中自定义transformer以做你想做的事，如使用bytebuddy代理类（这个代理性能不错，学习成本低，当然如果你熟悉字节码，可以直接asm）</p>\n","site":{"data":{}},"length":267,"excerpt":"","more":"<p>场景：有些时候我们想做一个通用的事情，这关系到各个应用系统，如采集应用系统产生的数据，当然，我们不想代码倾入到应用系统中，“偷偷摸摸、神不知鬼不觉”地干这些事，那么，你可以考虑考虑借鉴javaagent的思想在Class类加载期间干点事。</p>\n<p><img src=\"\\images\\pasted-79.png\" alt=\"upload successful\"></p>\n<p>javaagent装载阶段预置了transformer<br>class装载阶段读取transformer信息并进行制定的处理</p>\n<p>因此，你可以在javaagent中自定义transformer以做你想做的事，如使用bytebuddy代理类（这个代理性能不错，学习成本低，当然如果你熟悉字节码，可以直接asm）</p>\n"},{"title":"G1-Evacuation Failure","author":"Xiang Chuang","date":"2019-04-10T03:56:00.000Z","_content":"当没有更多的空闲region被提升到老一代或者复制到幸存空间时，并且由于堆已经达到最大值，堆不能扩展，从而发生Evacuation Failure。对于G1 GC，它是非常耗时的。 \n\n a.对于成功复制的对象，G1需要更新引用，并且该region被一直引用。\n\n b.对于未成功复制的对象，G1将自动转发它们，并保留这些region。\n\n解决方案：\n\n①.不要过度加一些jvm参数。比如-Xmn,这个参数会限制G1的参数的自动扩展。可以仅使用-Xms，-Xmx和暂停时间目标-XX：MaxGCPauseMillis，删除任何额外的堆大小，例如-Xmn，-XX：NewSize，-XX：MaxNewSize，-XX：SurvivorRatio等。\n\n②.如果问题仍然存在，则增加JVM堆大小（即-Xmx）。\n\n③.如果您无法增加堆大小，并且您注意到marking cycle没有足够早地开始回收老一代，那么请减少-XX：InitiatingHeapOccupancyPercent。默认值是45％。减小该值将提前开始marking cycle 。另一方面，如果marking cycle 提前开始并且未收回，请将-XX：InitiatingHeapOccupancyPercent阈值增加到默认值以上。\n\n④.如果并发marking cycle准时开始，但需要很长时间才能完成，那么使用属性'-XX：ConcGCThreads'增加并发标记线程数的数量。默认是GC Workers: 1 ，单线程执行。\n\n⑤.如果有大量“空间耗尽（to-space exhausted）”或“空间溢出（to-space overflow）”GC事件，则增加-XX:G1ReservePercent。默认值是Java堆的10％。注意：G1 GC将此值限制在50％以内。","source":"_posts/G1-Evacuation-Failure.md","raw":"title: G1-Evacuation Failure\nauthor: Xiang Chuang\ntags:\n  - GC-G1\n  - JVM\n  - GC\ncategories:\n  - 爱学爱问\ndate: 2019-04-10 11:56:00\n---\n当没有更多的空闲region被提升到老一代或者复制到幸存空间时，并且由于堆已经达到最大值，堆不能扩展，从而发生Evacuation Failure。对于G1 GC，它是非常耗时的。 \n\n a.对于成功复制的对象，G1需要更新引用，并且该region被一直引用。\n\n b.对于未成功复制的对象，G1将自动转发它们，并保留这些region。\n\n解决方案：\n\n①.不要过度加一些jvm参数。比如-Xmn,这个参数会限制G1的参数的自动扩展。可以仅使用-Xms，-Xmx和暂停时间目标-XX：MaxGCPauseMillis，删除任何额外的堆大小，例如-Xmn，-XX：NewSize，-XX：MaxNewSize，-XX：SurvivorRatio等。\n\n②.如果问题仍然存在，则增加JVM堆大小（即-Xmx）。\n\n③.如果您无法增加堆大小，并且您注意到marking cycle没有足够早地开始回收老一代，那么请减少-XX：InitiatingHeapOccupancyPercent。默认值是45％。减小该值将提前开始marking cycle 。另一方面，如果marking cycle 提前开始并且未收回，请将-XX：InitiatingHeapOccupancyPercent阈值增加到默认值以上。\n\n④.如果并发marking cycle准时开始，但需要很长时间才能完成，那么使用属性'-XX：ConcGCThreads'增加并发标记线程数的数量。默认是GC Workers: 1 ，单线程执行。\n\n⑤.如果有大量“空间耗尽（to-space exhausted）”或“空间溢出（to-space overflow）”GC事件，则增加-XX:G1ReservePercent。默认值是Java堆的10％。注意：G1 GC将此值限制在50％以内。","slug":"G1-Evacuation-Failure","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vb00003wy669ky2156z","content":"<p>当没有更多的空闲region被提升到老一代或者复制到幸存空间时，并且由于堆已经达到最大值，堆不能扩展，从而发生Evacuation Failure。对于G1 GC，它是非常耗时的。 </p>\n<p> a.对于成功复制的对象，G1需要更新引用，并且该region被一直引用。</p>\n<p> b.对于未成功复制的对象，G1将自动转发它们，并保留这些region。</p>\n<p>解决方案：</p>\n<p>①.不要过度加一些jvm参数。比如-Xmn,这个参数会限制G1的参数的自动扩展。可以仅使用-Xms，-Xmx和暂停时间目标-XX：MaxGCPauseMillis，删除任何额外的堆大小，例如-Xmn，-XX：NewSize，-XX：MaxNewSize，-XX：SurvivorRatio等。</p>\n<p>②.如果问题仍然存在，则增加JVM堆大小（即-Xmx）。</p>\n<p>③.如果您无法增加堆大小，并且您注意到marking cycle没有足够早地开始回收老一代，那么请减少-XX：InitiatingHeapOccupancyPercent。默认值是45％。减小该值将提前开始marking cycle 。另一方面，如果marking cycle 提前开始并且未收回，请将-XX：InitiatingHeapOccupancyPercent阈值增加到默认值以上。</p>\n<p>④.如果并发marking cycle准时开始，但需要很长时间才能完成，那么使用属性’-XX：ConcGCThreads’增加并发标记线程数的数量。默认是GC Workers: 1 ，单线程执行。</p>\n<p>⑤.如果有大量“空间耗尽（to-space exhausted）”或“空间溢出（to-space overflow）”GC事件，则增加-XX:G1ReservePercent。默认值是Java堆的10％。注意：G1 GC将此值限制在50％以内。</p>\n","site":{"data":{}},"length":742,"excerpt":"","more":"<p>当没有更多的空闲region被提升到老一代或者复制到幸存空间时，并且由于堆已经达到最大值，堆不能扩展，从而发生Evacuation Failure。对于G1 GC，它是非常耗时的。 </p>\n<p> a.对于成功复制的对象，G1需要更新引用，并且该region被一直引用。</p>\n<p> b.对于未成功复制的对象，G1将自动转发它们，并保留这些region。</p>\n<p>解决方案：</p>\n<p>①.不要过度加一些jvm参数。比如-Xmn,这个参数会限制G1的参数的自动扩展。可以仅使用-Xms，-Xmx和暂停时间目标-XX：MaxGCPauseMillis，删除任何额外的堆大小，例如-Xmn，-XX：NewSize，-XX：MaxNewSize，-XX：SurvivorRatio等。</p>\n<p>②.如果问题仍然存在，则增加JVM堆大小（即-Xmx）。</p>\n<p>③.如果您无法增加堆大小，并且您注意到marking cycle没有足够早地开始回收老一代，那么请减少-XX：InitiatingHeapOccupancyPercent。默认值是45％。减小该值将提前开始marking cycle 。另一方面，如果marking cycle 提前开始并且未收回，请将-XX：InitiatingHeapOccupancyPercent阈值增加到默认值以上。</p>\n<p>④.如果并发marking cycle准时开始，但需要很长时间才能完成，那么使用属性’-XX：ConcGCThreads’增加并发标记线程数的数量。默认是GC Workers: 1 ，单线程执行。</p>\n<p>⑤.如果有大量“空间耗尽（to-space exhausted）”或“空间溢出（to-space overflow）”GC事件，则增加-XX:G1ReservePercent。默认值是Java堆的10％。注意：G1 GC将此值限制在50％以内。</p>\n"},{"title":"G1- --xx:initiatingheapoccupancypercent变量之问","author":"Xiang Chuang","date":"2019-04-09T14:24:00.000Z","_content":"问题：该变量究竟何意？\n官方解释\n![upload successful](\\images\\pasted-0.png)\n\n疑问：整堆占用率，到底是老年代区域占用整堆比率还是所有区域占用整堆比率？\n个人认为应该是老年代占用区域\n原因：\n1、新生代默认比例为5-60%， 新生代的回收是使用殆尽时，那么，本文讨论的这个变量默认时45%，这两个是用一点冲突的\n2、工作内存调优时发现gc日志，报出占用率超过45%时，此时更像是老年代超过45%\n3、工作内存调优过程：\nmpay堆大小 1500多兆，堆内存使用率预警值90%  \na、最初时候出现预警时 堆内存占用率时 1500*60% + ？ = 1500M左右 即，差不多用光了； 时常预警\nb、后来调成 1500*25% + ？=1000M左右； 没有再预警\nc、再后来调成 1500*45% + ？ = 1350M左右 很少出现\n【？】处是老年代的占比，  如果用45%来计算，才能符合我们的现象。\n\na、 最初时候出现预警时 堆内存占用率时 1500*60% + 1500*45% ；\nb、后来调成 1500*25% + 1500*45%=975M ；\nc、再后来调成 1500*45% + 1500*45% = 1350M\n\n附：GC日志记录\n```\n2019-04-08T22:58:18.594+0800: 45124.782: [GC pause (G1 Evacuation Pause) (young) 45124.783: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 13273, predicted base time: 26.68 ms, remaining time: 23.32 ms, target pause time: 50.00 ms]\n 45124.783: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 664 regions, survivors: 27 regions, predicted young region time: 15.56 ms]\n 45124.783: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 664 regions, survivors: 27 regions, old: 0 regions, predicted pause time: 42.25 ms, target pause time: 50.00 ms]\n, 0.0195542 secs]\n   [Parallel Time: 9.5 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45124782.9, Avg: 45124783.1, Max: 45124783.3, Diff: 0.4]\n      [Ext Root Scanning (ms): Min: 2.7, Avg: 3.0, Max: 4.5, Diff: 1.8, Sum: 24.3]\n      [Update RS (ms): Min: 1.6, Avg: 2.8, Max: 3.4, Diff: 1.8, Sum: 22.3]\n         [Processed Buffers: Min: 1, Avg: 15.6, Max: 28, Diff: 27, Sum: 125]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 1.5]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n      [Object Copy (ms): Min: 2.5, Avg: 2.8, Max: 3.0, Diff: 0.4, Sum: 22.0]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.0]\n      [GC Worker Total (ms): Min: 8.6, Avg: 8.9, Max: 9.2, Diff: 0.6, Sum: 71.2]\n      [GC Worker End (ms): Min: 45124791.9, Avg: 45124792.0, Max: 45124792.1, Diff: 0.2]\n   [Code Root Fixup: 0.3 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.8 ms]\n   [Other: 9.0 ms]\n      [Choose CSet: 0.0 ms]\n      [Ref Proc: 6.2 ms]\n      [Ref Enq: 0.4 ms]\n      [Redirty Cards: 0.3 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.1 ms]\n      [Free CSet: 1.0 ms]\n   [Eden: 664.0M(664.0M)->0.0B(678.0M) Survivors: 27.0M->13.0M Heap: 1008.6M(1536.0M)->326.5M(1536.0M)]\n [Times: user=0.09 sys=0.00, real=0.02 secs]\n \n 2019-04-08T22:58:48.854+0800: 45155.043: [GC pause (G1 Evacuation Pause) (young) 45155.043: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 12417, predicted base time: 23.87 ms, remaining time: 26.13 ms, target pause time: 50.00 ms]\n 45155.043: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 678 regions, survivors: 13 regions, predicted young region time: 9.44 ms]\n 45155.043: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 678 regions, survivors: 13 regions, old: 0 regions, predicted pause time: 33.31 ms, target pause time: 50.00 ms]\n, 0.0211469 secs]\n   [Parallel Time: 12.1 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45155043.0, Avg: 45155043.2, Max: 45155043.3, Diff: 0.3]\n      [Ext Root Scanning (ms): Min: 2.1, Avg: 2.5, Max: 3.8, Diff: 1.7, Sum: 20.0]\n      [Update RS (ms): Min: 1.1, Avg: 2.1, Max: 2.4, Diff: 1.4, Sum: 16.7]\n         [Processed Buffers: Min: 9, Avg: 14.8, Max: 27, Diff: 18, Sum: 118]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.3]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n      [Object Copy (ms): Min: 6.7, Avg: 6.8, Max: 6.9, Diff: 0.2, Sum: 54.8]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.1, Sum: 0.6]\n      [GC Worker Total (ms): Min: 11.5, Avg: 11.7, Max: 11.9, Diff: 0.4, Sum: 93.5]\n      [GC Worker End (ms): Min: 45155054.8, Avg: 45155054.8, Max: 45155054.9, Diff: 0.1]\n   [Code Root Fixup: 0.2 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.6 ms]\n   [Other: 8.3 ms]\n      [Choose CSet: 0.0 ms]\n      [Ref Proc: 5.7 ms]\n      [Ref Enq: 0.6 ms]\n      [Redirty Cards: 0.4 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.2 ms]\n      [Free CSet: 0.7 ms]\n   [Eden: 678.0M(678.0M)->0.0B(660.0M) Survivors: 13.0M->31.0M Heap: 1260.8M(1536.0M)->527.7M(1536.0M)]\n [Times: user=0.11 sys=0.00, real=0.03 secs]\n \n 45189.907: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 713031680 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45189.909: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: requested by GC cause, GC cause: G1 Humongous Allocation]\n 45189.909: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested]\n2019-04-08T22:59:23.721+0800: 45189.910: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 45189.910: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 17533, predicted base time: 22.62 ms, remaining time: 27.38 ms, target pause time: 50.00 ms]\n 45189.910: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 625 regions, survivors: 31 regions, predicted young region time: 7.83 ms]\n 45189.910: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 625 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 30.45 ms, target pause time: 50.00 ms]\n, 0.0292182 secs]\n   [Parallel Time: 17.3 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45189910.8, Avg: 45189911.1, Max: 45189911.4, Diff: 0.6]\n      [Ext Root Scanning (ms): Min: 4.0, Avg: 4.2, Max: 4.7, Diff: 0.8, Sum: 33.8]\n      [Update RS (ms): Min: 3.6, Avg: 3.6, Max: 3.8, Diff: 0.2, Sum: 29.2]\n         [Processed Buffers: Min: 9, Avg: 18.8, Max: 26, Diff: 17, Sum: 150]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.4]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n      [Object Copy (ms): Min: 7.7, Avg: 7.9, Max: 8.1, Diff: 0.4, Sum: 63.3]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.0]\n      [GC Worker Total (ms): Min: 15.7, Avg: 16.1, Max: 16.3, Diff: 0.6, Sum: 128.8]\n      [GC Worker End (ms): Min: 45189927.2, Avg: 45189927.2, Max: 45189927.4, Diff: 0.2]\n   [Code Root Fixup: 0.4 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.7 ms]\n   [Other: 10.9 ms]\n      [Choose CSet: 0.1 ms]\n      [Ref Proc: 7.0 ms]\n      [Ref Enq: 0.5 ms]\n      [Redirty Cards: 0.5 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.5 ms]\n      [Free CSet: 0.9 ms]\n   [Eden: 625.0M(660.0M)->0.0B(660.0M) Survivors: 31.0M->31.0M Heap: 1319.5M(1536.0M)->458.2M(1536.0M)]\n [Times: user=0.14 sys=0.01, real=0.03 secs]\n \n 2019-04-08T22:59:23.751+0800: 45189.939: [GC concurrent-root-region-scan-start]\n2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-root-region-scan-end, 0.0135482 secs]\n2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-mark-start]\n2019-04-08T22:59:24.042+0800: 45190.231: [GC concurrent-mark-end, 0.2778332 secs]\n2019-04-08T22:59:24.045+0800: 45190.233: [GC remark 2019-04-08T22:59:24.045+0800: 45190.233: [Finalize Marking, 0.0013681 secs] 2019-04-08T22:59:24.046+0800: 45190.234: [GC ref-proc, 0.0093594 secs] 2019-04-08T22:59:24.056+0800: 45190.244: [Unloading, 0.0237148 secs], 0.0366644 secs]\n [Times: user=0.21 sys=0.01, real=0.04 secs]\n2019-04-08T22:59:24.083+0800: 45190.271: [GC cleanup 506M->506M(1536M), 0.0063516 secs]\n [Times: user=0.01 sys=0.00, real=0.00 secs]\n 45199.221: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 708837376 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45199.822: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 732954624 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45199.823: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 734003200 bytes, allocation request: 1048592 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45199.824: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 736100352 bytes, allocation request: 680584 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45207.963: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 737148928 bytes, allocation request: 47775760 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45208.497: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 785383424 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45209.189: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 809500672 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45223.797: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 810549248 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45224.628: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 847249408 bytes, allocation request: 17922544 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n2019-04-08T22:59:58.442+0800: 45224.630: [GC pause (G1 Humongous Allocation) (young) 45224.630: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 18363, predicted base time: 22.47 ms, remaining time: 27.53 ms, target pause time: 50.00 ms]\n 45224.630: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 660 regions, survivors: 31 regions, predicted young region time: 7.16 ms]\n 45224.630: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 660 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 29.63 ms, target pause time: 50.00 ms]\n 45224.660: [G1Ergonomics (Mixed GCs) start mixed GCs, reason: candidate old regions available, candidate old regions: 187 regions, reclaimable: 102606088 bytes (6.37 %), threshold: 5.00 %]\n, 0.0300491 secs]\n[Parallel Time: 16.3 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45224630.8, Avg: 45224631.1, Max: 45224631.3, Diff: 0.6]\n      [Ext Root Scanning (ms): Min: 2.6, Avg: 2.9, Max: 4.3, Diff: 1.7, Sum: 23.6]\n      [Update RS (ms): Min: 3.0, Avg: 3.9, Max: 4.2, Diff: 1.1, Sum: 30.8]\n         [Processed Buffers: Min: 11, Avg: 18.0, Max: 26, Diff: 15, Sum: 144]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 1.6]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.2]\n      [Object Copy (ms): Min: 8.2, Avg: 8.4, Max: 8.6, Diff: 0.4, Sum: 67.5]\n      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.7]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.4]\n      [GC Worker Total (ms): Min: 15.3, Avg: 15.6, Max: 15.9, Diff: 0.6, Sum: 124.6]\n      [GC Worker End (ms): Min: 45224646.7, Avg: 45224646.7, Max: 45224646.7, Diff: 0.1]\n   [Code Root Fixup: 0.3 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.7 ms]\n   [Other: 12.8 ms]\n      [Choose CSet: 0.0 ms]\n      [Ref Proc: 7.7 ms]\n      [Ref Enq: 0.6 ms]\n      [Redirty Cards: 1.0 ms]\n      [Humongous Register: 0.2 ms]\n      [Humongous Reclaim: 0.6 ms]\n      [Free CSet: 1.7 ms]\n   [Eden: 660.0M(660.0M)->0.0B(45.0M) Survivors: 31.0M->31.0M Heap: 1479.4M(1536.0M)->630.5M(1536.0M)]\n [Times: user=0.15 sys=0.01, real=0.03 secs]\n \n 2019-04-08T22:59:59.121+0800: 45225.309: [GC pause (G1 Evacuation Pause) (mixed) 45225.309: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 2204, predicted base time: 18.27 ms, remaining time: 31.73 ms, target pause time: 50.00 ms]\n 45225.309: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 45 regions, survivors: 31 regions, predicted young region time: 0.76 ms]\n 45225.309: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: reclaimable percentage not over threshold, old: 24 regions, max: 154 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]\n 45225.309: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 45 regions, survivors: 31 regions, old: 24 regions, predicted pause time: 22.66 ms, target pause time: 50.00 ms]\n 45225.348: [G1Ergonomics (Mixed GCs) do not continue mixed GCs, reason: reclaimable percentage not over threshold, candidate old regions: 163 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]\n, 0.0391519 secs]\n   [Parallel Time: 25.0 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45225309.4, Avg: 45225309.6, Max: 45225309.7, Diff: 0.3]\n      [Ext Root Scanning (ms): Min: 3.9, Avg: 4.4, Max: 5.2, Diff: 1.2, Sum: 35.3]\n      [Update RS (ms): Min: 0.0, Avg: 0.6, Max: 0.9, Diff: 0.9, Sum: 4.8]\n         [Processed Buffers: Min: 0, Avg: 5.4, Max: 19, Diff: 19, Sum: 43]\n      [Scan RS (ms): Min: 0.6, Avg: 0.9, Max: 1.0, Diff: 0.4, Sum: 7.1]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.1, Sum: 0.3]\n      [Object Copy (ms): Min: 18.4, Avg: 18.5, Max: 18.8, Diff: 0.5, Sum: 148.4]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n         [Termination Attempts: Min: 1, Avg: 1.6, Max: 3, Diff: 2, Sum: 13]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.3]\n      [GC Worker Total (ms): Min: 24.4, Avg: 24.5, Max: 24.7, Diff: 0.3, Sum: 196.2]\n      [GC Worker End (ms): Min: 45225334.1, Avg: 45225334.1, Max: 45225334.1, Diff: 0.0]\n   [Code Root Fixup: 0.3 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.9 ms]\n   [Other: 13.0 ms]\n      [Choose CSet: 0.1 ms]\n      [Ref Proc: 9.8 ms]\n      [Ref Enq: 0.6 ms]\n      [Redirty Cards: 0.7 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.7 ms]\n      [Free CSet: 0.3 ms]\n   [Eden: 45.0M(45.0M)->0.0B(685.0M) Survivors: 31.0M->6144.0K Heap: 732.5M(1536.0M)->342.3M(1536.0M)]\n [Times: user=0.17 sys=0.01, real=0.04 secs]\n```","source":"_posts/G1垃圾回收器-xx-initiatingheapoccupancypercent变量之问.md","raw":"title: 'G1- --xx:initiatingheapoccupancypercent变量之问'\nauthor: Xiang Chuang\ncategories:\n  - 爱学爱问\ntags:\n  - GC-G1\n  - JVM\n  - GC\ndate: 2019-04-09 22:24:00\n---\n问题：该变量究竟何意？\n官方解释\n![upload successful](\\images\\pasted-0.png)\n\n疑问：整堆占用率，到底是老年代区域占用整堆比率还是所有区域占用整堆比率？\n个人认为应该是老年代占用区域\n原因：\n1、新生代默认比例为5-60%， 新生代的回收是使用殆尽时，那么，本文讨论的这个变量默认时45%，这两个是用一点冲突的\n2、工作内存调优时发现gc日志，报出占用率超过45%时，此时更像是老年代超过45%\n3、工作内存调优过程：\nmpay堆大小 1500多兆，堆内存使用率预警值90%  \na、最初时候出现预警时 堆内存占用率时 1500*60% + ？ = 1500M左右 即，差不多用光了； 时常预警\nb、后来调成 1500*25% + ？=1000M左右； 没有再预警\nc、再后来调成 1500*45% + ？ = 1350M左右 很少出现\n【？】处是老年代的占比，  如果用45%来计算，才能符合我们的现象。\n\na、 最初时候出现预警时 堆内存占用率时 1500*60% + 1500*45% ；\nb、后来调成 1500*25% + 1500*45%=975M ；\nc、再后来调成 1500*45% + 1500*45% = 1350M\n\n附：GC日志记录\n```\n2019-04-08T22:58:18.594+0800: 45124.782: [GC pause (G1 Evacuation Pause) (young) 45124.783: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 13273, predicted base time: 26.68 ms, remaining time: 23.32 ms, target pause time: 50.00 ms]\n 45124.783: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 664 regions, survivors: 27 regions, predicted young region time: 15.56 ms]\n 45124.783: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 664 regions, survivors: 27 regions, old: 0 regions, predicted pause time: 42.25 ms, target pause time: 50.00 ms]\n, 0.0195542 secs]\n   [Parallel Time: 9.5 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45124782.9, Avg: 45124783.1, Max: 45124783.3, Diff: 0.4]\n      [Ext Root Scanning (ms): Min: 2.7, Avg: 3.0, Max: 4.5, Diff: 1.8, Sum: 24.3]\n      [Update RS (ms): Min: 1.6, Avg: 2.8, Max: 3.4, Diff: 1.8, Sum: 22.3]\n         [Processed Buffers: Min: 1, Avg: 15.6, Max: 28, Diff: 27, Sum: 125]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 1.5]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n      [Object Copy (ms): Min: 2.5, Avg: 2.8, Max: 3.0, Diff: 0.4, Sum: 22.0]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.0]\n      [GC Worker Total (ms): Min: 8.6, Avg: 8.9, Max: 9.2, Diff: 0.6, Sum: 71.2]\n      [GC Worker End (ms): Min: 45124791.9, Avg: 45124792.0, Max: 45124792.1, Diff: 0.2]\n   [Code Root Fixup: 0.3 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.8 ms]\n   [Other: 9.0 ms]\n      [Choose CSet: 0.0 ms]\n      [Ref Proc: 6.2 ms]\n      [Ref Enq: 0.4 ms]\n      [Redirty Cards: 0.3 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.1 ms]\n      [Free CSet: 1.0 ms]\n   [Eden: 664.0M(664.0M)->0.0B(678.0M) Survivors: 27.0M->13.0M Heap: 1008.6M(1536.0M)->326.5M(1536.0M)]\n [Times: user=0.09 sys=0.00, real=0.02 secs]\n \n 2019-04-08T22:58:48.854+0800: 45155.043: [GC pause (G1 Evacuation Pause) (young) 45155.043: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 12417, predicted base time: 23.87 ms, remaining time: 26.13 ms, target pause time: 50.00 ms]\n 45155.043: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 678 regions, survivors: 13 regions, predicted young region time: 9.44 ms]\n 45155.043: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 678 regions, survivors: 13 regions, old: 0 regions, predicted pause time: 33.31 ms, target pause time: 50.00 ms]\n, 0.0211469 secs]\n   [Parallel Time: 12.1 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45155043.0, Avg: 45155043.2, Max: 45155043.3, Diff: 0.3]\n      [Ext Root Scanning (ms): Min: 2.1, Avg: 2.5, Max: 3.8, Diff: 1.7, Sum: 20.0]\n      [Update RS (ms): Min: 1.1, Avg: 2.1, Max: 2.4, Diff: 1.4, Sum: 16.7]\n         [Processed Buffers: Min: 9, Avg: 14.8, Max: 27, Diff: 18, Sum: 118]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.3]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n      [Object Copy (ms): Min: 6.7, Avg: 6.8, Max: 6.9, Diff: 0.2, Sum: 54.8]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.1, Sum: 0.6]\n      [GC Worker Total (ms): Min: 11.5, Avg: 11.7, Max: 11.9, Diff: 0.4, Sum: 93.5]\n      [GC Worker End (ms): Min: 45155054.8, Avg: 45155054.8, Max: 45155054.9, Diff: 0.1]\n   [Code Root Fixup: 0.2 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.6 ms]\n   [Other: 8.3 ms]\n      [Choose CSet: 0.0 ms]\n      [Ref Proc: 5.7 ms]\n      [Ref Enq: 0.6 ms]\n      [Redirty Cards: 0.4 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.2 ms]\n      [Free CSet: 0.7 ms]\n   [Eden: 678.0M(678.0M)->0.0B(660.0M) Survivors: 13.0M->31.0M Heap: 1260.8M(1536.0M)->527.7M(1536.0M)]\n [Times: user=0.11 sys=0.00, real=0.03 secs]\n \n 45189.907: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 713031680 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45189.909: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: requested by GC cause, GC cause: G1 Humongous Allocation]\n 45189.909: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested]\n2019-04-08T22:59:23.721+0800: 45189.910: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 45189.910: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 17533, predicted base time: 22.62 ms, remaining time: 27.38 ms, target pause time: 50.00 ms]\n 45189.910: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 625 regions, survivors: 31 regions, predicted young region time: 7.83 ms]\n 45189.910: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 625 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 30.45 ms, target pause time: 50.00 ms]\n, 0.0292182 secs]\n   [Parallel Time: 17.3 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45189910.8, Avg: 45189911.1, Max: 45189911.4, Diff: 0.6]\n      [Ext Root Scanning (ms): Min: 4.0, Avg: 4.2, Max: 4.7, Diff: 0.8, Sum: 33.8]\n      [Update RS (ms): Min: 3.6, Avg: 3.6, Max: 3.8, Diff: 0.2, Sum: 29.2]\n         [Processed Buffers: Min: 9, Avg: 18.8, Max: 26, Diff: 17, Sum: 150]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.4]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n      [Object Copy (ms): Min: 7.7, Avg: 7.9, Max: 8.1, Diff: 0.4, Sum: 63.3]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.0]\n      [GC Worker Total (ms): Min: 15.7, Avg: 16.1, Max: 16.3, Diff: 0.6, Sum: 128.8]\n      [GC Worker End (ms): Min: 45189927.2, Avg: 45189927.2, Max: 45189927.4, Diff: 0.2]\n   [Code Root Fixup: 0.4 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.7 ms]\n   [Other: 10.9 ms]\n      [Choose CSet: 0.1 ms]\n      [Ref Proc: 7.0 ms]\n      [Ref Enq: 0.5 ms]\n      [Redirty Cards: 0.5 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.5 ms]\n      [Free CSet: 0.9 ms]\n   [Eden: 625.0M(660.0M)->0.0B(660.0M) Survivors: 31.0M->31.0M Heap: 1319.5M(1536.0M)->458.2M(1536.0M)]\n [Times: user=0.14 sys=0.01, real=0.03 secs]\n \n 2019-04-08T22:59:23.751+0800: 45189.939: [GC concurrent-root-region-scan-start]\n2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-root-region-scan-end, 0.0135482 secs]\n2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-mark-start]\n2019-04-08T22:59:24.042+0800: 45190.231: [GC concurrent-mark-end, 0.2778332 secs]\n2019-04-08T22:59:24.045+0800: 45190.233: [GC remark 2019-04-08T22:59:24.045+0800: 45190.233: [Finalize Marking, 0.0013681 secs] 2019-04-08T22:59:24.046+0800: 45190.234: [GC ref-proc, 0.0093594 secs] 2019-04-08T22:59:24.056+0800: 45190.244: [Unloading, 0.0237148 secs], 0.0366644 secs]\n [Times: user=0.21 sys=0.01, real=0.04 secs]\n2019-04-08T22:59:24.083+0800: 45190.271: [GC cleanup 506M->506M(1536M), 0.0063516 secs]\n [Times: user=0.01 sys=0.00, real=0.00 secs]\n 45199.221: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 708837376 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45199.822: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 732954624 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45199.823: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 734003200 bytes, allocation request: 1048592 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45199.824: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 736100352 bytes, allocation request: 680584 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45207.963: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 737148928 bytes, allocation request: 47775760 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45208.497: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 785383424 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45209.189: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 809500672 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45223.797: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 810549248 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n 45224.628: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 847249408 bytes, allocation request: 17922544 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]\n2019-04-08T22:59:58.442+0800: 45224.630: [GC pause (G1 Humongous Allocation) (young) 45224.630: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 18363, predicted base time: 22.47 ms, remaining time: 27.53 ms, target pause time: 50.00 ms]\n 45224.630: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 660 regions, survivors: 31 regions, predicted young region time: 7.16 ms]\n 45224.630: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 660 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 29.63 ms, target pause time: 50.00 ms]\n 45224.660: [G1Ergonomics (Mixed GCs) start mixed GCs, reason: candidate old regions available, candidate old regions: 187 regions, reclaimable: 102606088 bytes (6.37 %), threshold: 5.00 %]\n, 0.0300491 secs]\n[Parallel Time: 16.3 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45224630.8, Avg: 45224631.1, Max: 45224631.3, Diff: 0.6]\n      [Ext Root Scanning (ms): Min: 2.6, Avg: 2.9, Max: 4.3, Diff: 1.7, Sum: 23.6]\n      [Update RS (ms): Min: 3.0, Avg: 3.9, Max: 4.2, Diff: 1.1, Sum: 30.8]\n         [Processed Buffers: Min: 11, Avg: 18.0, Max: 26, Diff: 15, Sum: 144]\n      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 1.6]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.2]\n      [Object Copy (ms): Min: 8.2, Avg: 8.4, Max: 8.6, Diff: 0.4, Sum: 67.5]\n      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.7]\n         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.4]\n      [GC Worker Total (ms): Min: 15.3, Avg: 15.6, Max: 15.9, Diff: 0.6, Sum: 124.6]\n      [GC Worker End (ms): Min: 45224646.7, Avg: 45224646.7, Max: 45224646.7, Diff: 0.1]\n   [Code Root Fixup: 0.3 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.7 ms]\n   [Other: 12.8 ms]\n      [Choose CSet: 0.0 ms]\n      [Ref Proc: 7.7 ms]\n      [Ref Enq: 0.6 ms]\n      [Redirty Cards: 1.0 ms]\n      [Humongous Register: 0.2 ms]\n      [Humongous Reclaim: 0.6 ms]\n      [Free CSet: 1.7 ms]\n   [Eden: 660.0M(660.0M)->0.0B(45.0M) Survivors: 31.0M->31.0M Heap: 1479.4M(1536.0M)->630.5M(1536.0M)]\n [Times: user=0.15 sys=0.01, real=0.03 secs]\n \n 2019-04-08T22:59:59.121+0800: 45225.309: [GC pause (G1 Evacuation Pause) (mixed) 45225.309: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 2204, predicted base time: 18.27 ms, remaining time: 31.73 ms, target pause time: 50.00 ms]\n 45225.309: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 45 regions, survivors: 31 regions, predicted young region time: 0.76 ms]\n 45225.309: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: reclaimable percentage not over threshold, old: 24 regions, max: 154 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]\n 45225.309: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 45 regions, survivors: 31 regions, old: 24 regions, predicted pause time: 22.66 ms, target pause time: 50.00 ms]\n 45225.348: [G1Ergonomics (Mixed GCs) do not continue mixed GCs, reason: reclaimable percentage not over threshold, candidate old regions: 163 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]\n, 0.0391519 secs]\n   [Parallel Time: 25.0 ms, GC Workers: 8]\n      [GC Worker Start (ms): Min: 45225309.4, Avg: 45225309.6, Max: 45225309.7, Diff: 0.3]\n      [Ext Root Scanning (ms): Min: 3.9, Avg: 4.4, Max: 5.2, Diff: 1.2, Sum: 35.3]\n      [Update RS (ms): Min: 0.0, Avg: 0.6, Max: 0.9, Diff: 0.9, Sum: 4.8]\n         [Processed Buffers: Min: 0, Avg: 5.4, Max: 19, Diff: 19, Sum: 43]\n      [Scan RS (ms): Min: 0.6, Avg: 0.9, Max: 1.0, Diff: 0.4, Sum: 7.1]\n      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.1, Sum: 0.3]\n      [Object Copy (ms): Min: 18.4, Avg: 18.5, Max: 18.8, Diff: 0.5, Sum: 148.4]\n      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]\n         [Termination Attempts: Min: 1, Avg: 1.6, Max: 3, Diff: 2, Sum: 13]\n      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.3]\n      [GC Worker Total (ms): Min: 24.4, Avg: 24.5, Max: 24.7, Diff: 0.3, Sum: 196.2]\n      [GC Worker End (ms): Min: 45225334.1, Avg: 45225334.1, Max: 45225334.1, Diff: 0.0]\n   [Code Root Fixup: 0.3 ms]\n   [Code Root Purge: 0.0 ms]\n   [Clear CT: 0.9 ms]\n   [Other: 13.0 ms]\n      [Choose CSet: 0.1 ms]\n      [Ref Proc: 9.8 ms]\n      [Ref Enq: 0.6 ms]\n      [Redirty Cards: 0.7 ms]\n      [Humongous Register: 0.1 ms]\n      [Humongous Reclaim: 0.7 ms]\n      [Free CSet: 0.3 ms]\n   [Eden: 45.0M(45.0M)->0.0B(685.0M) Survivors: 31.0M->6144.0K Heap: 732.5M(1536.0M)->342.3M(1536.0M)]\n [Times: user=0.17 sys=0.01, real=0.04 secs]\n```","slug":"G1垃圾回收器-xx-initiatingheapoccupancypercent变量之问","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vb30007wy660xrfeugb","content":"<p>问题：该变量究竟何意？<br>官方解释<br><img src=\"\\images\\pasted-0.png\" alt=\"upload successful\"></p>\n<p>疑问：整堆占用率，到底是老年代区域占用整堆比率还是所有区域占用整堆比率？<br>个人认为应该是老年代占用区域<br>原因：<br>1、新生代默认比例为5-60%， 新生代的回收是使用殆尽时，那么，本文讨论的这个变量默认时45%，这两个是用一点冲突的<br>2、工作内存调优时发现gc日志，报出占用率超过45%时，此时更像是老年代超过45%<br>3、工作内存调优过程：<br>mpay堆大小 1500多兆，堆内存使用率预警值90%<br>a、最初时候出现预警时 堆内存占用率时 1500<em>60% + ？ = 1500M左右 即，差不多用光了； 时常预警<br>b、后来调成 1500</em>25% + ？=1000M左右； 没有再预警<br>c、再后来调成 1500*45% + ？ = 1350M左右 很少出现<br>【？】处是老年代的占比，  如果用45%来计算，才能符合我们的现象。</p>\n<p>a、 最初时候出现预警时 堆内存占用率时 1500<em>60% + 1500</em>45% ；<br>b、后来调成 1500<em>25% + 1500</em>45%=975M ；<br>c、再后来调成 1500<em>45% + 1500</em>45% = 1350M</p>\n<p>附：GC日志记录<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-04-08T22:58:18.594+0800: 45124.782: [GC pause (G1 Evacuation Pause) (young) 45124.783: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 13273, predicted base time: 26.68 ms, remaining time: 23.32 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45124.783: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 664 regions, survivors: 27 regions, predicted young region time: 15.56 ms]</span><br><span class=\"line\"> 45124.783: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 664 regions, survivors: 27 regions, old: 0 regions, predicted pause time: 42.25 ms, target pause time: 50.00 ms]</span><br><span class=\"line\">, 0.0195542 secs]</span><br><span class=\"line\">   [Parallel Time: 9.5 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45124782.9, Avg: 45124783.1, Max: 45124783.3, Diff: 0.4]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 2.7, Avg: 3.0, Max: 4.5, Diff: 1.8, Sum: 24.3]</span><br><span class=\"line\">      [Update RS (ms): Min: 1.6, Avg: 2.8, Max: 3.4, Diff: 1.8, Sum: 22.3]</span><br><span class=\"line\">         [Processed Buffers: Min: 1, Avg: 15.6, Max: 28, Diff: 27, Sum: 125]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 1.5]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">      [Object Copy (ms): Min: 2.5, Avg: 2.8, Max: 3.0, Diff: 0.4, Sum: 22.0]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.0]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 8.6, Avg: 8.9, Max: 9.2, Diff: 0.6, Sum: 71.2]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45124791.9, Avg: 45124792.0, Max: 45124792.1, Diff: 0.2]</span><br><span class=\"line\">   [Code Root Fixup: 0.3 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.8 ms]</span><br><span class=\"line\">   [Other: 9.0 ms]</span><br><span class=\"line\">      [Choose CSet: 0.0 ms]</span><br><span class=\"line\">      [Ref Proc: 6.2 ms]</span><br><span class=\"line\">      [Ref Enq: 0.4 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.3 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.1 ms]</span><br><span class=\"line\">      [Free CSet: 1.0 ms]</span><br><span class=\"line\">   [Eden: 664.0M(664.0M)-&gt;0.0B(678.0M) Survivors: 27.0M-&gt;13.0M Heap: 1008.6M(1536.0M)-&gt;326.5M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.09 sys=0.00, real=0.02 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 2019-04-08T22:58:48.854+0800: 45155.043: [GC pause (G1 Evacuation Pause) (young) 45155.043: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 12417, predicted base time: 23.87 ms, remaining time: 26.13 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45155.043: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 678 regions, survivors: 13 regions, predicted young region time: 9.44 ms]</span><br><span class=\"line\"> 45155.043: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 678 regions, survivors: 13 regions, old: 0 regions, predicted pause time: 33.31 ms, target pause time: 50.00 ms]</span><br><span class=\"line\">, 0.0211469 secs]</span><br><span class=\"line\">   [Parallel Time: 12.1 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45155043.0, Avg: 45155043.2, Max: 45155043.3, Diff: 0.3]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 2.1, Avg: 2.5, Max: 3.8, Diff: 1.7, Sum: 20.0]</span><br><span class=\"line\">      [Update RS (ms): Min: 1.1, Avg: 2.1, Max: 2.4, Diff: 1.4, Sum: 16.7]</span><br><span class=\"line\">         [Processed Buffers: Min: 9, Avg: 14.8, Max: 27, Diff: 18, Sum: 118]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.3]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">      [Object Copy (ms): Min: 6.7, Avg: 6.8, Max: 6.9, Diff: 0.2, Sum: 54.8]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.1, Sum: 0.6]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 11.5, Avg: 11.7, Max: 11.9, Diff: 0.4, Sum: 93.5]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45155054.8, Avg: 45155054.8, Max: 45155054.9, Diff: 0.1]</span><br><span class=\"line\">   [Code Root Fixup: 0.2 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.6 ms]</span><br><span class=\"line\">   [Other: 8.3 ms]</span><br><span class=\"line\">      [Choose CSet: 0.0 ms]</span><br><span class=\"line\">      [Ref Proc: 5.7 ms]</span><br><span class=\"line\">      [Ref Enq: 0.6 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.4 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.2 ms]</span><br><span class=\"line\">      [Free CSet: 0.7 ms]</span><br><span class=\"line\">   [Eden: 678.0M(678.0M)-&gt;0.0B(660.0M) Survivors: 13.0M-&gt;31.0M Heap: 1260.8M(1536.0M)-&gt;527.7M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.11 sys=0.00, real=0.03 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 45189.907: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 713031680 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45189.909: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: requested by GC cause, GC cause: G1 Humongous Allocation]</span><br><span class=\"line\"> 45189.909: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested]</span><br><span class=\"line\">2019-04-08T22:59:23.721+0800: 45189.910: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 45189.910: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 17533, predicted base time: 22.62 ms, remaining time: 27.38 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45189.910: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 625 regions, survivors: 31 regions, predicted young region time: 7.83 ms]</span><br><span class=\"line\"> 45189.910: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 625 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 30.45 ms, target pause time: 50.00 ms]</span><br><span class=\"line\">, 0.0292182 secs]</span><br><span class=\"line\">   [Parallel Time: 17.3 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45189910.8, Avg: 45189911.1, Max: 45189911.4, Diff: 0.6]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 4.0, Avg: 4.2, Max: 4.7, Diff: 0.8, Sum: 33.8]</span><br><span class=\"line\">      [Update RS (ms): Min: 3.6, Avg: 3.6, Max: 3.8, Diff: 0.2, Sum: 29.2]</span><br><span class=\"line\">         [Processed Buffers: Min: 9, Avg: 18.8, Max: 26, Diff: 17, Sum: 150]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.4]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">      [Object Copy (ms): Min: 7.7, Avg: 7.9, Max: 8.1, Diff: 0.4, Sum: 63.3]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.0]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 15.7, Avg: 16.1, Max: 16.3, Diff: 0.6, Sum: 128.8]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45189927.2, Avg: 45189927.2, Max: 45189927.4, Diff: 0.2]</span><br><span class=\"line\">   [Code Root Fixup: 0.4 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.7 ms]</span><br><span class=\"line\">   [Other: 10.9 ms]</span><br><span class=\"line\">      [Choose CSet: 0.1 ms]</span><br><span class=\"line\">      [Ref Proc: 7.0 ms]</span><br><span class=\"line\">      [Ref Enq: 0.5 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.5 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.5 ms]</span><br><span class=\"line\">      [Free CSet: 0.9 ms]</span><br><span class=\"line\">   [Eden: 625.0M(660.0M)-&gt;0.0B(660.0M) Survivors: 31.0M-&gt;31.0M Heap: 1319.5M(1536.0M)-&gt;458.2M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.14 sys=0.01, real=0.03 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 2019-04-08T22:59:23.751+0800: 45189.939: [GC concurrent-root-region-scan-start]</span><br><span class=\"line\">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-root-region-scan-end, 0.0135482 secs]</span><br><span class=\"line\">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-mark-start]</span><br><span class=\"line\">2019-04-08T22:59:24.042+0800: 45190.231: [GC concurrent-mark-end, 0.2778332 secs]</span><br><span class=\"line\">2019-04-08T22:59:24.045+0800: 45190.233: [GC remark 2019-04-08T22:59:24.045+0800: 45190.233: [Finalize Marking, 0.0013681 secs] 2019-04-08T22:59:24.046+0800: 45190.234: [GC ref-proc, 0.0093594 secs] 2019-04-08T22:59:24.056+0800: 45190.244: [Unloading, 0.0237148 secs], 0.0366644 secs]</span><br><span class=\"line\"> [Times: user=0.21 sys=0.01, real=0.04 secs]</span><br><span class=\"line\">2019-04-08T22:59:24.083+0800: 45190.271: [GC cleanup 506M-&gt;506M(1536M), 0.0063516 secs]</span><br><span class=\"line\"> [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class=\"line\"> 45199.221: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 708837376 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45199.822: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 732954624 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45199.823: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 734003200 bytes, allocation request: 1048592 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45199.824: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 736100352 bytes, allocation request: 680584 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45207.963: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 737148928 bytes, allocation request: 47775760 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45208.497: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 785383424 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45209.189: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 809500672 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45223.797: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 810549248 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45224.628: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 847249408 bytes, allocation request: 17922544 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\">2019-04-08T22:59:58.442+0800: 45224.630: [GC pause (G1 Humongous Allocation) (young) 45224.630: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 18363, predicted base time: 22.47 ms, remaining time: 27.53 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45224.630: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 660 regions, survivors: 31 regions, predicted young region time: 7.16 ms]</span><br><span class=\"line\"> 45224.630: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 660 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 29.63 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45224.660: [G1Ergonomics (Mixed GCs) start mixed GCs, reason: candidate old regions available, candidate old regions: 187 regions, reclaimable: 102606088 bytes (6.37 %), threshold: 5.00 %]</span><br><span class=\"line\">, 0.0300491 secs]</span><br><span class=\"line\">[Parallel Time: 16.3 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45224630.8, Avg: 45224631.1, Max: 45224631.3, Diff: 0.6]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 2.6, Avg: 2.9, Max: 4.3, Diff: 1.7, Sum: 23.6]</span><br><span class=\"line\">      [Update RS (ms): Min: 3.0, Avg: 3.9, Max: 4.2, Diff: 1.1, Sum: 30.8]</span><br><span class=\"line\">         [Processed Buffers: Min: 11, Avg: 18.0, Max: 26, Diff: 15, Sum: 144]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 1.6]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.2]</span><br><span class=\"line\">      [Object Copy (ms): Min: 8.2, Avg: 8.4, Max: 8.6, Diff: 0.4, Sum: 67.5]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.7]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.4]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 15.3, Avg: 15.6, Max: 15.9, Diff: 0.6, Sum: 124.6]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45224646.7, Avg: 45224646.7, Max: 45224646.7, Diff: 0.1]</span><br><span class=\"line\">   [Code Root Fixup: 0.3 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.7 ms]</span><br><span class=\"line\">   [Other: 12.8 ms]</span><br><span class=\"line\">      [Choose CSet: 0.0 ms]</span><br><span class=\"line\">      [Ref Proc: 7.7 ms]</span><br><span class=\"line\">      [Ref Enq: 0.6 ms]</span><br><span class=\"line\">      [Redirty Cards: 1.0 ms]</span><br><span class=\"line\">      [Humongous Register: 0.2 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.6 ms]</span><br><span class=\"line\">      [Free CSet: 1.7 ms]</span><br><span class=\"line\">   [Eden: 660.0M(660.0M)-&gt;0.0B(45.0M) Survivors: 31.0M-&gt;31.0M Heap: 1479.4M(1536.0M)-&gt;630.5M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.15 sys=0.01, real=0.03 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 2019-04-08T22:59:59.121+0800: 45225.309: [GC pause (G1 Evacuation Pause) (mixed) 45225.309: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 2204, predicted base time: 18.27 ms, remaining time: 31.73 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45225.309: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 45 regions, survivors: 31 regions, predicted young region time: 0.76 ms]</span><br><span class=\"line\"> 45225.309: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: reclaimable percentage not over threshold, old: 24 regions, max: 154 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class=\"line\"> 45225.309: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 45 regions, survivors: 31 regions, old: 24 regions, predicted pause time: 22.66 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45225.348: [G1Ergonomics (Mixed GCs) do not continue mixed GCs, reason: reclaimable percentage not over threshold, candidate old regions: 163 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class=\"line\">, 0.0391519 secs]</span><br><span class=\"line\">   [Parallel Time: 25.0 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45225309.4, Avg: 45225309.6, Max: 45225309.7, Diff: 0.3]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 3.9, Avg: 4.4, Max: 5.2, Diff: 1.2, Sum: 35.3]</span><br><span class=\"line\">      [Update RS (ms): Min: 0.0, Avg: 0.6, Max: 0.9, Diff: 0.9, Sum: 4.8]</span><br><span class=\"line\">         [Processed Buffers: Min: 0, Avg: 5.4, Max: 19, Diff: 19, Sum: 43]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.6, Avg: 0.9, Max: 1.0, Diff: 0.4, Sum: 7.1]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.1, Sum: 0.3]</span><br><span class=\"line\">      [Object Copy (ms): Min: 18.4, Avg: 18.5, Max: 18.8, Diff: 0.5, Sum: 148.4]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.6, Max: 3, Diff: 2, Sum: 13]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.3]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 24.4, Avg: 24.5, Max: 24.7, Diff: 0.3, Sum: 196.2]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45225334.1, Avg: 45225334.1, Max: 45225334.1, Diff: 0.0]</span><br><span class=\"line\">   [Code Root Fixup: 0.3 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.9 ms]</span><br><span class=\"line\">   [Other: 13.0 ms]</span><br><span class=\"line\">      [Choose CSet: 0.1 ms]</span><br><span class=\"line\">      [Ref Proc: 9.8 ms]</span><br><span class=\"line\">      [Ref Enq: 0.6 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.7 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.7 ms]</span><br><span class=\"line\">      [Free CSet: 0.3 ms]</span><br><span class=\"line\">   [Eden: 45.0M(45.0M)-&gt;0.0B(685.0M) Survivors: 31.0M-&gt;6144.0K Heap: 732.5M(1536.0M)-&gt;342.3M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.17 sys=0.01, real=0.04 secs]</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":12968,"excerpt":"","more":"<p>问题：该变量究竟何意？<br>官方解释<br><img src=\"\\images\\pasted-0.png\" alt=\"upload successful\"></p>\n<p>疑问：整堆占用率，到底是老年代区域占用整堆比率还是所有区域占用整堆比率？<br>个人认为应该是老年代占用区域<br>原因：<br>1、新生代默认比例为5-60%， 新生代的回收是使用殆尽时，那么，本文讨论的这个变量默认时45%，这两个是用一点冲突的<br>2、工作内存调优时发现gc日志，报出占用率超过45%时，此时更像是老年代超过45%<br>3、工作内存调优过程：<br>mpay堆大小 1500多兆，堆内存使用率预警值90%<br>a、最初时候出现预警时 堆内存占用率时 1500<em>60% + ？ = 1500M左右 即，差不多用光了； 时常预警<br>b、后来调成 1500</em>25% + ？=1000M左右； 没有再预警<br>c、再后来调成 1500*45% + ？ = 1350M左右 很少出现<br>【？】处是老年代的占比，  如果用45%来计算，才能符合我们的现象。</p>\n<p>a、 最初时候出现预警时 堆内存占用率时 1500<em>60% + 1500</em>45% ；<br>b、后来调成 1500<em>25% + 1500</em>45%=975M ；<br>c、再后来调成 1500<em>45% + 1500</em>45% = 1350M</p>\n<p>附：GC日志记录<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-04-08T22:58:18.594+0800: 45124.782: [GC pause (G1 Evacuation Pause) (young) 45124.783: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 13273, predicted base time: 26.68 ms, remaining time: 23.32 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45124.783: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 664 regions, survivors: 27 regions, predicted young region time: 15.56 ms]</span><br><span class=\"line\"> 45124.783: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 664 regions, survivors: 27 regions, old: 0 regions, predicted pause time: 42.25 ms, target pause time: 50.00 ms]</span><br><span class=\"line\">, 0.0195542 secs]</span><br><span class=\"line\">   [Parallel Time: 9.5 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45124782.9, Avg: 45124783.1, Max: 45124783.3, Diff: 0.4]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 2.7, Avg: 3.0, Max: 4.5, Diff: 1.8, Sum: 24.3]</span><br><span class=\"line\">      [Update RS (ms): Min: 1.6, Avg: 2.8, Max: 3.4, Diff: 1.8, Sum: 22.3]</span><br><span class=\"line\">         [Processed Buffers: Min: 1, Avg: 15.6, Max: 28, Diff: 27, Sum: 125]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 1.5]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">      [Object Copy (ms): Min: 2.5, Avg: 2.8, Max: 3.0, Diff: 0.4, Sum: 22.0]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.0]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 8.6, Avg: 8.9, Max: 9.2, Diff: 0.6, Sum: 71.2]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45124791.9, Avg: 45124792.0, Max: 45124792.1, Diff: 0.2]</span><br><span class=\"line\">   [Code Root Fixup: 0.3 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.8 ms]</span><br><span class=\"line\">   [Other: 9.0 ms]</span><br><span class=\"line\">      [Choose CSet: 0.0 ms]</span><br><span class=\"line\">      [Ref Proc: 6.2 ms]</span><br><span class=\"line\">      [Ref Enq: 0.4 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.3 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.1 ms]</span><br><span class=\"line\">      [Free CSet: 1.0 ms]</span><br><span class=\"line\">   [Eden: 664.0M(664.0M)-&gt;0.0B(678.0M) Survivors: 27.0M-&gt;13.0M Heap: 1008.6M(1536.0M)-&gt;326.5M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.09 sys=0.00, real=0.02 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 2019-04-08T22:58:48.854+0800: 45155.043: [GC pause (G1 Evacuation Pause) (young) 45155.043: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 12417, predicted base time: 23.87 ms, remaining time: 26.13 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45155.043: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 678 regions, survivors: 13 regions, predicted young region time: 9.44 ms]</span><br><span class=\"line\"> 45155.043: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 678 regions, survivors: 13 regions, old: 0 regions, predicted pause time: 33.31 ms, target pause time: 50.00 ms]</span><br><span class=\"line\">, 0.0211469 secs]</span><br><span class=\"line\">   [Parallel Time: 12.1 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45155043.0, Avg: 45155043.2, Max: 45155043.3, Diff: 0.3]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 2.1, Avg: 2.5, Max: 3.8, Diff: 1.7, Sum: 20.0]</span><br><span class=\"line\">      [Update RS (ms): Min: 1.1, Avg: 2.1, Max: 2.4, Diff: 1.4, Sum: 16.7]</span><br><span class=\"line\">         [Processed Buffers: Min: 9, Avg: 14.8, Max: 27, Diff: 18, Sum: 118]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.3]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">      [Object Copy (ms): Min: 6.7, Avg: 6.8, Max: 6.9, Diff: 0.2, Sum: 54.8]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.1, Sum: 0.6]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 11.5, Avg: 11.7, Max: 11.9, Diff: 0.4, Sum: 93.5]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45155054.8, Avg: 45155054.8, Max: 45155054.9, Diff: 0.1]</span><br><span class=\"line\">   [Code Root Fixup: 0.2 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.6 ms]</span><br><span class=\"line\">   [Other: 8.3 ms]</span><br><span class=\"line\">      [Choose CSet: 0.0 ms]</span><br><span class=\"line\">      [Ref Proc: 5.7 ms]</span><br><span class=\"line\">      [Ref Enq: 0.6 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.4 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.2 ms]</span><br><span class=\"line\">      [Free CSet: 0.7 ms]</span><br><span class=\"line\">   [Eden: 678.0M(678.0M)-&gt;0.0B(660.0M) Survivors: 13.0M-&gt;31.0M Heap: 1260.8M(1536.0M)-&gt;527.7M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.11 sys=0.00, real=0.03 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 45189.907: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 713031680 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45189.909: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: requested by GC cause, GC cause: G1 Humongous Allocation]</span><br><span class=\"line\"> 45189.909: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested]</span><br><span class=\"line\">2019-04-08T22:59:23.721+0800: 45189.910: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 45189.910: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 17533, predicted base time: 22.62 ms, remaining time: 27.38 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45189.910: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 625 regions, survivors: 31 regions, predicted young region time: 7.83 ms]</span><br><span class=\"line\"> 45189.910: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 625 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 30.45 ms, target pause time: 50.00 ms]</span><br><span class=\"line\">, 0.0292182 secs]</span><br><span class=\"line\">   [Parallel Time: 17.3 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45189910.8, Avg: 45189911.1, Max: 45189911.4, Diff: 0.6]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 4.0, Avg: 4.2, Max: 4.7, Diff: 0.8, Sum: 33.8]</span><br><span class=\"line\">      [Update RS (ms): Min: 3.6, Avg: 3.6, Max: 3.8, Diff: 0.2, Sum: 29.2]</span><br><span class=\"line\">         [Processed Buffers: Min: 9, Avg: 18.8, Max: 26, Diff: 17, Sum: 150]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.2, Diff: 0.2, Sum: 1.4]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">      [Object Copy (ms): Min: 7.7, Avg: 7.9, Max: 8.1, Diff: 0.4, Sum: 63.3]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.0]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 15.7, Avg: 16.1, Max: 16.3, Diff: 0.6, Sum: 128.8]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45189927.2, Avg: 45189927.2, Max: 45189927.4, Diff: 0.2]</span><br><span class=\"line\">   [Code Root Fixup: 0.4 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.7 ms]</span><br><span class=\"line\">   [Other: 10.9 ms]</span><br><span class=\"line\">      [Choose CSet: 0.1 ms]</span><br><span class=\"line\">      [Ref Proc: 7.0 ms]</span><br><span class=\"line\">      [Ref Enq: 0.5 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.5 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.5 ms]</span><br><span class=\"line\">      [Free CSet: 0.9 ms]</span><br><span class=\"line\">   [Eden: 625.0M(660.0M)-&gt;0.0B(660.0M) Survivors: 31.0M-&gt;31.0M Heap: 1319.5M(1536.0M)-&gt;458.2M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.14 sys=0.01, real=0.03 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 2019-04-08T22:59:23.751+0800: 45189.939: [GC concurrent-root-region-scan-start]</span><br><span class=\"line\">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-root-region-scan-end, 0.0135482 secs]</span><br><span class=\"line\">2019-04-08T22:59:23.765+0800: 45189.953: [GC concurrent-mark-start]</span><br><span class=\"line\">2019-04-08T22:59:24.042+0800: 45190.231: [GC concurrent-mark-end, 0.2778332 secs]</span><br><span class=\"line\">2019-04-08T22:59:24.045+0800: 45190.233: [GC remark 2019-04-08T22:59:24.045+0800: 45190.233: [Finalize Marking, 0.0013681 secs] 2019-04-08T22:59:24.046+0800: 45190.234: [GC ref-proc, 0.0093594 secs] 2019-04-08T22:59:24.056+0800: 45190.244: [Unloading, 0.0237148 secs], 0.0366644 secs]</span><br><span class=\"line\"> [Times: user=0.21 sys=0.01, real=0.04 secs]</span><br><span class=\"line\">2019-04-08T22:59:24.083+0800: 45190.271: [GC cleanup 506M-&gt;506M(1536M), 0.0063516 secs]</span><br><span class=\"line\"> [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class=\"line\"> 45199.221: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 708837376 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45199.822: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 732954624 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45199.823: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 734003200 bytes, allocation request: 1048592 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45199.824: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 736100352 bytes, allocation request: 680584 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45207.963: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 737148928 bytes, allocation request: 47775760 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45208.497: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 785383424 bytes, allocation request: 23411104 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45209.189: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 809500672 bytes, allocation request: 524304 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45223.797: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 810549248 bytes, allocation request: 36578320 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\"> 45224.628: [G1Ergonomics (Concurrent Cycles) do not request concurrent cycle initiation, reason: still doing mixed collections, occupancy: 847249408 bytes, allocation request: 17922544 bytes, threshold: 724775715 bytes (45.00 %), source: concurrent humongous allocation]</span><br><span class=\"line\">2019-04-08T22:59:58.442+0800: 45224.630: [GC pause (G1 Humongous Allocation) (young) 45224.630: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 18363, predicted base time: 22.47 ms, remaining time: 27.53 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45224.630: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 660 regions, survivors: 31 regions, predicted young region time: 7.16 ms]</span><br><span class=\"line\"> 45224.630: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 660 regions, survivors: 31 regions, old: 0 regions, predicted pause time: 29.63 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45224.660: [G1Ergonomics (Mixed GCs) start mixed GCs, reason: candidate old regions available, candidate old regions: 187 regions, reclaimable: 102606088 bytes (6.37 %), threshold: 5.00 %]</span><br><span class=\"line\">, 0.0300491 secs]</span><br><span class=\"line\">[Parallel Time: 16.3 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45224630.8, Avg: 45224631.1, Max: 45224631.3, Diff: 0.6]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 2.6, Avg: 2.9, Max: 4.3, Diff: 1.7, Sum: 23.6]</span><br><span class=\"line\">      [Update RS (ms): Min: 3.0, Avg: 3.9, Max: 4.2, Diff: 1.1, Sum: 30.8]</span><br><span class=\"line\">         [Processed Buffers: Min: 11, Avg: 18.0, Max: 26, Diff: 15, Sum: 144]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 1.6]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.2]</span><br><span class=\"line\">      [Object Copy (ms): Min: 8.2, Avg: 8.4, Max: 8.6, Diff: 0.4, Sum: 67.5]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.7]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 8]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.4]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 15.3, Avg: 15.6, Max: 15.9, Diff: 0.6, Sum: 124.6]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45224646.7, Avg: 45224646.7, Max: 45224646.7, Diff: 0.1]</span><br><span class=\"line\">   [Code Root Fixup: 0.3 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.7 ms]</span><br><span class=\"line\">   [Other: 12.8 ms]</span><br><span class=\"line\">      [Choose CSet: 0.0 ms]</span><br><span class=\"line\">      [Ref Proc: 7.7 ms]</span><br><span class=\"line\">      [Ref Enq: 0.6 ms]</span><br><span class=\"line\">      [Redirty Cards: 1.0 ms]</span><br><span class=\"line\">      [Humongous Register: 0.2 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.6 ms]</span><br><span class=\"line\">      [Free CSet: 1.7 ms]</span><br><span class=\"line\">   [Eden: 660.0M(660.0M)-&gt;0.0B(45.0M) Survivors: 31.0M-&gt;31.0M Heap: 1479.4M(1536.0M)-&gt;630.5M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.15 sys=0.01, real=0.03 secs]</span><br><span class=\"line\"> </span><br><span class=\"line\"> 2019-04-08T22:59:59.121+0800: 45225.309: [GC pause (G1 Evacuation Pause) (mixed) 45225.309: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 2204, predicted base time: 18.27 ms, remaining time: 31.73 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45225.309: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 45 regions, survivors: 31 regions, predicted young region time: 0.76 ms]</span><br><span class=\"line\"> 45225.309: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: reclaimable percentage not over threshold, old: 24 regions, max: 154 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class=\"line\"> 45225.309: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 45 regions, survivors: 31 regions, old: 24 regions, predicted pause time: 22.66 ms, target pause time: 50.00 ms]</span><br><span class=\"line\"> 45225.348: [G1Ergonomics (Mixed GCs) do not continue mixed GCs, reason: reclaimable percentage not over threshold, candidate old regions: 163 regions, reclaimable: 80229208 bytes (4.98 %), threshold: 5.00 %]</span><br><span class=\"line\">, 0.0391519 secs]</span><br><span class=\"line\">   [Parallel Time: 25.0 ms, GC Workers: 8]</span><br><span class=\"line\">      [GC Worker Start (ms): Min: 45225309.4, Avg: 45225309.6, Max: 45225309.7, Diff: 0.3]</span><br><span class=\"line\">      [Ext Root Scanning (ms): Min: 3.9, Avg: 4.4, Max: 5.2, Diff: 1.2, Sum: 35.3]</span><br><span class=\"line\">      [Update RS (ms): Min: 0.0, Avg: 0.6, Max: 0.9, Diff: 0.9, Sum: 4.8]</span><br><span class=\"line\">         [Processed Buffers: Min: 0, Avg: 5.4, Max: 19, Diff: 19, Sum: 43]</span><br><span class=\"line\">      [Scan RS (ms): Min: 0.6, Avg: 0.9, Max: 1.0, Diff: 0.4, Sum: 7.1]</span><br><span class=\"line\">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.1, Sum: 0.3]</span><br><span class=\"line\">      [Object Copy (ms): Min: 18.4, Avg: 18.5, Max: 18.8, Diff: 0.5, Sum: 148.4]</span><br><span class=\"line\">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class=\"line\">         [Termination Attempts: Min: 1, Avg: 1.6, Max: 3, Diff: 2, Sum: 13]</span><br><span class=\"line\">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.1, Diff: 0.0, Sum: 0.3]</span><br><span class=\"line\">      [GC Worker Total (ms): Min: 24.4, Avg: 24.5, Max: 24.7, Diff: 0.3, Sum: 196.2]</span><br><span class=\"line\">      [GC Worker End (ms): Min: 45225334.1, Avg: 45225334.1, Max: 45225334.1, Diff: 0.0]</span><br><span class=\"line\">   [Code Root Fixup: 0.3 ms]</span><br><span class=\"line\">   [Code Root Purge: 0.0 ms]</span><br><span class=\"line\">   [Clear CT: 0.9 ms]</span><br><span class=\"line\">   [Other: 13.0 ms]</span><br><span class=\"line\">      [Choose CSet: 0.1 ms]</span><br><span class=\"line\">      [Ref Proc: 9.8 ms]</span><br><span class=\"line\">      [Ref Enq: 0.6 ms]</span><br><span class=\"line\">      [Redirty Cards: 0.7 ms]</span><br><span class=\"line\">      [Humongous Register: 0.1 ms]</span><br><span class=\"line\">      [Humongous Reclaim: 0.7 ms]</span><br><span class=\"line\">      [Free CSet: 0.3 ms]</span><br><span class=\"line\">   [Eden: 45.0M(45.0M)-&gt;0.0B(685.0M) Survivors: 31.0M-&gt;6144.0K Heap: 732.5M(1536.0M)-&gt;342.3M(1536.0M)]</span><br><span class=\"line\"> [Times: user=0.17 sys=0.01, real=0.04 secs]</span><br></pre></td></tr></table></figure></p>\n"},{"title":"G1-Humongous Allocation","author":"Xiang Chuang","date":"2019-04-10T03:56:00.000Z","_content":"它是由'G1 Humongous Allocation'造成的。大型对象（Humongous ）是大于G1中region大小50％的对象。频繁大型对象分配会导致性能问题。如果region里面包含大量的大型对象，则该region中最后一个具有巨型对象的区域与区域末端之间的空间将不会使用。如果有多个这样的大型对象，这个未使用的空间可能导致堆碎片化。直到jdk1.8u40之前，这些巨型对象的回收只在full GC期间完成。在较新的JVM中，对这些对象的清理放在了清理阶段。\n\n解决方案：\n\n①.可以加大region的大小，设置-XX:G1HeapRegionSize=n，但是这个参数需要设置为2的幂次方，最小值是1M，最大值是32M。\n\n②.如果可以的话增加JVM堆大小（即-Xmx -Xms）。","source":"_posts/G1-Humongous-Allocation.md","raw":"title: G1-Humongous Allocation\nauthor: Xiang Chuang\ntags:\n  - GC-G1\n  - JVM\n  - GC\ncategories:\n  - 爱学爱问\ndate: 2019-04-10 11:56:00\n---\n它是由'G1 Humongous Allocation'造成的。大型对象（Humongous ）是大于G1中region大小50％的对象。频繁大型对象分配会导致性能问题。如果region里面包含大量的大型对象，则该region中最后一个具有巨型对象的区域与区域末端之间的空间将不会使用。如果有多个这样的大型对象，这个未使用的空间可能导致堆碎片化。直到jdk1.8u40之前，这些巨型对象的回收只在full GC期间完成。在较新的JVM中，对这些对象的清理放在了清理阶段。\n\n解决方案：\n\n①.可以加大region的大小，设置-XX:G1HeapRegionSize=n，但是这个参数需要设置为2的幂次方，最小值是1M，最大值是32M。\n\n②.如果可以的话增加JVM堆大小（即-Xmx -Xms）。","slug":"G1-Humongous-Allocation","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vb40009wy66fz6o3rrk","content":"<p>它是由’G1 Humongous Allocation’造成的。大型对象（Humongous ）是大于G1中region大小50％的对象。频繁大型对象分配会导致性能问题。如果region里面包含大量的大型对象，则该region中最后一个具有巨型对象的区域与区域末端之间的空间将不会使用。如果有多个这样的大型对象，这个未使用的空间可能导致堆碎片化。直到jdk1.8u40之前，这些巨型对象的回收只在full GC期间完成。在较新的JVM中，对这些对象的清理放在了清理阶段。</p>\n<p>解决方案：</p>\n<p>①.可以加大region的大小，设置-XX:G1HeapRegionSize=n，但是这个参数需要设置为2的幂次方，最小值是1M，最大值是32M。</p>\n<p>②.如果可以的话增加JVM堆大小（即-Xmx -Xms）。</p>\n","site":{"data":{}},"length":337,"excerpt":"","more":"<p>它是由’G1 Humongous Allocation’造成的。大型对象（Humongous ）是大于G1中region大小50％的对象。频繁大型对象分配会导致性能问题。如果region里面包含大量的大型对象，则该region中最后一个具有巨型对象的区域与区域末端之间的空间将不会使用。如果有多个这样的大型对象，这个未使用的空间可能导致堆碎片化。直到jdk1.8u40之前，这些巨型对象的回收只在full GC期间完成。在较新的JVM中，对这些对象的清理放在了清理阶段。</p>\n<p>解决方案：</p>\n<p>①.可以加大region的大小，设置-XX:G1HeapRegionSize=n，但是这个参数需要设置为2的幂次方，最小值是1M，最大值是32M。</p>\n<p>②.如果可以的话增加JVM堆大小（即-Xmx -Xms）。</p>\n"},{"title":"HttpURLConnection-关于HttpRequestMethodNotSupportedException异常","author":"Xiang Chuang","date":"2019-05-16T13:37:00.000Z","_content":"背景：提供场景化业务监控能力时，需要通过捕获到的异常流水gid直接跳转到apm进行链路信息查询。\n\n方案：调用apm提供的gid翻译为traceId方法，该能力是基于spring mvc提供，并且是https协议。godeye中利用HttpURLConnection封装post及get方法进行调用：\n```\nURL realUrl = new URL(url);\n            HttpURLConnection conn = (HttpURLConnection )realUrl.openConnection();\n            conn.setRequestProperty(\"accept\", \"*/*\");\n            conn.setRequestProperty(\"connection\", \"Keep-Alive\");\n            conn.setRequestProperty(\"user-agent\", \"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)\");\n            conn.setRequestMethod(\"POST\");\n            conn.setRequestProperty(\"Accept-Charset\", \"UTF-8\");\n            conn.setRequestProperty(\"Content-Type\", \"application/json;charset=UTF-8\");\n            conn.setRequestProperty(\"Content-Length\", String.valueOf(param.length()));\n\n            conn.setDoOutput(true);\n            conn.setDoInput(true);\n            out = new OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);\n            out.write(param);\n            out.flush();\n            read = new BufferedReader(new InputStreamReader(conn.getInputStream(),DEFAULT_UNICODE));\n            String line;\n            while ((line = read.readLine()) != null) {\n                result += line;\n            }\n            ```\n问题：完成功能后测试时发现出现结果如下：{\"timestamp\":\"2019-05-16 21:36:11\",\"status\":200,\"error\":\"OK\",\"exception\":\"org.springframework.web.HttpRequestMethodNotSupportedException\",\"message\":\"Request method 'POST' not supported\",\"path\":\"/gidQuery\"}\n\n百思不得其解，度娘了相关错误，指出了很多可能引起该问题的原因。\n\n后发现问题出现在：\n```\n1、conn.setRequestMethod(\"POST\");及\n2、conn.setDoOutput(true);\n            conn.setDoInput(true);\n            out = new 3、OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);\n            out.write(param);\n            out.flush();\n```\n删除2、3这几行代码后，同时1改为conn.setRequestMethod(\"GET\")，执行正常。\n","source":"_posts/HttpURLConnection-关于HttpRequestMethodNotSupportedException异常.md","raw":"title: HttpURLConnection-关于HttpRequestMethodNotSupportedException异常\nauthor: Xiang Chuang\ntags:\n  - HttpURLConnection\n  - HttpRequestMethodNotSupportedException\n  - post/get请求\ncategories:\n  - 爱学爱问\ndate: 2019-05-16 21:37:00\n---\n背景：提供场景化业务监控能力时，需要通过捕获到的异常流水gid直接跳转到apm进行链路信息查询。\n\n方案：调用apm提供的gid翻译为traceId方法，该能力是基于spring mvc提供，并且是https协议。godeye中利用HttpURLConnection封装post及get方法进行调用：\n```\nURL realUrl = new URL(url);\n            HttpURLConnection conn = (HttpURLConnection )realUrl.openConnection();\n            conn.setRequestProperty(\"accept\", \"*/*\");\n            conn.setRequestProperty(\"connection\", \"Keep-Alive\");\n            conn.setRequestProperty(\"user-agent\", \"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)\");\n            conn.setRequestMethod(\"POST\");\n            conn.setRequestProperty(\"Accept-Charset\", \"UTF-8\");\n            conn.setRequestProperty(\"Content-Type\", \"application/json;charset=UTF-8\");\n            conn.setRequestProperty(\"Content-Length\", String.valueOf(param.length()));\n\n            conn.setDoOutput(true);\n            conn.setDoInput(true);\n            out = new OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);\n            out.write(param);\n            out.flush();\n            read = new BufferedReader(new InputStreamReader(conn.getInputStream(),DEFAULT_UNICODE));\n            String line;\n            while ((line = read.readLine()) != null) {\n                result += line;\n            }\n            ```\n问题：完成功能后测试时发现出现结果如下：{\"timestamp\":\"2019-05-16 21:36:11\",\"status\":200,\"error\":\"OK\",\"exception\":\"org.springframework.web.HttpRequestMethodNotSupportedException\",\"message\":\"Request method 'POST' not supported\",\"path\":\"/gidQuery\"}\n\n百思不得其解，度娘了相关错误，指出了很多可能引起该问题的原因。\n\n后发现问题出现在：\n```\n1、conn.setRequestMethod(\"POST\");及\n2、conn.setDoOutput(true);\n            conn.setDoInput(true);\n            out = new 3、OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);\n            out.write(param);\n            out.flush();\n```\n删除2、3这几行代码后，同时1改为conn.setRequestMethod(\"GET\")，执行正常。\n","slug":"HttpURLConnection-关于HttpRequestMethodNotSupportedException异常","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vb5000bwy66ehnrbk49","content":"<p>背景：提供场景化业务监控能力时，需要通过捕获到的异常流水gid直接跳转到apm进行链路信息查询。</p>\n<p>方案：调用apm提供的gid翻译为traceId方法，该能力是基于spring mvc提供，并且是https协议。godeye中利用HttpURLConnection封装post及get方法进行调用：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">URL realUrl = new URL(url);</span><br><span class=\"line\">            HttpURLConnection conn = (HttpURLConnection )realUrl.openConnection();</span><br><span class=\"line\">            conn.setRequestProperty(&quot;accept&quot;, &quot;*/*&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;);</span><br><span class=\"line\">            conn.setRequestMethod(&quot;POST&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;Accept-Charset&quot;, &quot;UTF-8&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(param.length()));</span><br><span class=\"line\"></span><br><span class=\"line\">            conn.setDoOutput(true);</span><br><span class=\"line\">            conn.setDoInput(true);</span><br><span class=\"line\">            out = new OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class=\"line\">            out.write(param);</span><br><span class=\"line\">            out.flush();</span><br><span class=\"line\">            read = new BufferedReader(new InputStreamReader(conn.getInputStream(),DEFAULT_UNICODE));</span><br><span class=\"line\">            String line;</span><br><span class=\"line\">            while ((line = read.readLine()) != null) &#123;</span><br><span class=\"line\">                result += line;</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure><br>问题：完成功能后测试时发现出现结果如下：{“timestamp”:”2019-05-16 21:36:11”,”status”:200,”error”:”OK”,”exception”:”org.springframework.web.HttpRequestMethodNotSupportedException”,”message”:”Request method ‘POST’ not supported”,”path”:”/gidQuery”}</p>\n<p>百思不得其解，度娘了相关错误，指出了很多可能引起该问题的原因。</p>\n<p>后发现问题出现在：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、conn.setRequestMethod(&quot;POST&quot;);及</span><br><span class=\"line\">2、conn.setDoOutput(true);</span><br><span class=\"line\">            conn.setDoInput(true);</span><br><span class=\"line\">            out = new 3、OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class=\"line\">            out.write(param);</span><br><span class=\"line\">            out.flush();</span><br></pre></td></tr></table></figure><br>删除2、3这几行代码后，同时1改为conn.setRequestMethod(“GET”)，执行正常。</p>\n","site":{"data":{}},"length":1592,"excerpt":"","more":"<p>背景：提供场景化业务监控能力时，需要通过捕获到的异常流水gid直接跳转到apm进行链路信息查询。</p>\n<p>方案：调用apm提供的gid翻译为traceId方法，该能力是基于spring mvc提供，并且是https协议。godeye中利用HttpURLConnection封装post及get方法进行调用：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">URL realUrl = new URL(url);</span><br><span class=\"line\">            HttpURLConnection conn = (HttpURLConnection )realUrl.openConnection();</span><br><span class=\"line\">            conn.setRequestProperty(&quot;accept&quot;, &quot;*/*&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;);</span><br><span class=\"line\">            conn.setRequestMethod(&quot;POST&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;Accept-Charset&quot;, &quot;UTF-8&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class=\"line\">            conn.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(param.length()));</span><br><span class=\"line\"></span><br><span class=\"line\">            conn.setDoOutput(true);</span><br><span class=\"line\">            conn.setDoInput(true);</span><br><span class=\"line\">            out = new OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class=\"line\">            out.write(param);</span><br><span class=\"line\">            out.flush();</span><br><span class=\"line\">            read = new BufferedReader(new InputStreamReader(conn.getInputStream(),DEFAULT_UNICODE));</span><br><span class=\"line\">            String line;</span><br><span class=\"line\">            while ((line = read.readLine()) != null) &#123;</span><br><span class=\"line\">                result += line;</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure><br>问题：完成功能后测试时发现出现结果如下：{“timestamp”:”2019-05-16 21:36:11”,”status”:200,”error”:”OK”,”exception”:”org.springframework.web.HttpRequestMethodNotSupportedException”,”message”:”Request method ‘POST’ not supported”,”path”:”/gidQuery”}</p>\n<p>百思不得其解，度娘了相关错误，指出了很多可能引起该问题的原因。</p>\n<p>后发现问题出现在：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、conn.setRequestMethod(&quot;POST&quot;);及</span><br><span class=\"line\">2、conn.setDoOutput(true);</span><br><span class=\"line\">            conn.setDoInput(true);</span><br><span class=\"line\">            out = new 3、OutputStreamWriter(conn.getOutputStream(),DEFAULT_UNICODE);</span><br><span class=\"line\">            out.write(param);</span><br><span class=\"line\">            out.flush();</span><br></pre></td></tr></table></figure><br>删除2、3这几行代码后，同时1改为conn.setRequestMethod(“GET”)，执行正常。</p>\n"},{"title":"JVM-类加载","author":"Xiang Chuang","date":"2018-05-28T02:08:00.000Z","_content":"![upload successful](\\images\\pasted-50.png)\n\n\n![upload successful](\\images\\pasted-51.png)\n\n![upload successful](\\images\\pasted-52.png)\n\n![upload successful](\\images\\pasted-53.png)","source":"_posts/JVM-类加载.md","raw":"title: JVM-类加载\nauthor: Xiang Chuang\ntags:\n  - JVM\n  - 类加载\ncategories:\n  - 爱学爱问\ndate: 2018-05-28 10:08:00\n---\n![upload successful](\\images\\pasted-50.png)\n\n\n![upload successful](\\images\\pasted-51.png)\n\n![upload successful](\\images\\pasted-52.png)\n\n![upload successful](\\images\\pasted-53.png)","slug":"JVM-类加载","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vb8000ewy6614uh0b3v","content":"<p><img src=\"\\images\\pasted-50.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-51.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-52.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-53.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":0,"excerpt":"","more":"<p><img src=\"\\images\\pasted-50.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-51.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-52.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-53.png\" alt=\"upload successful\"></p>\n"},{"title":"java.lang.NoClassDefFoundError: Could not initialize class","author":"Xiang Chuang","date":"2019-06-05T12:42:00.000Z","_content":"问题描述：项目启动没问题，运行也没有问题，但是当运行到某个静态工具类的时候，出问题了，且没有异常， 抛出的是NoClassDefFoundError\n\n经分析：原因为静态类第一次被使用，尚未加载到虚拟机，使用时加载并编译，但static块中代码有异常，导致类加载失败，从而抛出此Error\n\n```\npublic class LogTool {\n\t\n\tpublic static boolean isPrint = true;\n\tstatic {\n\t\tif (System.getProperty(\"spring.profiles.active\").equals(\"local\")\n\t\t\t|| System.getProperty(\"spring.profiles.active\").equals(\"pdev\")\n\t\t\t|| System.getProperty(\"spring.profiles.active\").equals(\"sdev\")) {\n\t\t\tisPrint = true;\n\t\t}\n\t}\n```","source":"_posts/ava-lang-NoClassDefFoundError-Could-not-initialize-class.md","raw":"title: 'java.lang.NoClassDefFoundError: Could not initialize class'\nauthor: Xiang Chuang\ntags:\n  - NoClassDefFoundError\n  - 类加载异常\ncategories:\n  - 爱学爱问\ndate: 2019-06-05 20:42:00\n---\n问题描述：项目启动没问题，运行也没有问题，但是当运行到某个静态工具类的时候，出问题了，且没有异常， 抛出的是NoClassDefFoundError\n\n经分析：原因为静态类第一次被使用，尚未加载到虚拟机，使用时加载并编译，但static块中代码有异常，导致类加载失败，从而抛出此Error\n\n```\npublic class LogTool {\n\t\n\tpublic static boolean isPrint = true;\n\tstatic {\n\t\tif (System.getProperty(\"spring.profiles.active\").equals(\"local\")\n\t\t\t|| System.getProperty(\"spring.profiles.active\").equals(\"pdev\")\n\t\t\t|| System.getProperty(\"spring.profiles.active\").equals(\"sdev\")) {\n\t\t\tisPrint = true;\n\t\t}\n\t}\n```","slug":"ava-lang-NoClassDefFoundError-Could-not-initialize-class","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vb9000fwy661czu9e0l","content":"<p>问题描述：项目启动没问题，运行也没有问题，但是当运行到某个静态工具类的时候，出问题了，且没有异常， 抛出的是NoClassDefFoundError</p>\n<p>经分析：原因为静态类第一次被使用，尚未加载到虚拟机，使用时加载并编译，但static块中代码有异常，导致类加载失败，从而抛出此Error</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class LogTool &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic static boolean isPrint = true;</span><br><span class=\"line\">\tstatic &#123;</span><br><span class=\"line\">\t\tif (System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;local&quot;)</span><br><span class=\"line\">\t\t\t|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;pdev&quot;)</span><br><span class=\"line\">\t\t\t|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;sdev&quot;)) &#123;</span><br><span class=\"line\">\t\t\tisPrint = true;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"length":497,"excerpt":"","more":"<p>问题描述：项目启动没问题，运行也没有问题，但是当运行到某个静态工具类的时候，出问题了，且没有异常， 抛出的是NoClassDefFoundError</p>\n<p>经分析：原因为静态类第一次被使用，尚未加载到虚拟机，使用时加载并编译，但static块中代码有异常，导致类加载失败，从而抛出此Error</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class LogTool &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic static boolean isPrint = true;</span><br><span class=\"line\">\tstatic &#123;</span><br><span class=\"line\">\t\tif (System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;local&quot;)</span><br><span class=\"line\">\t\t\t|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;pdev&quot;)</span><br><span class=\"line\">\t\t\t|| System.getProperty(&quot;spring.profiles.active&quot;).equals(&quot;sdev&quot;)) &#123;</span><br><span class=\"line\">\t\t\tisPrint = true;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>"},{"title":"disruptor为什么那么快","author":"Xiang Chuang","date":"2018-11-13T09:05:00.000Z","_content":"disruptor可用于线程间数据交互\n详细参考文章http://ifeve.com/disruptor/\n\n概述一下为什么那么快（这将有利于你借鉴思想）\n1、私有序列号，它是AtomicLong类型的，基于CAS（cpu级指令），因此没有锁\n2、缓存行填充，避免伪共享（一个缓存行64字节，对应8个long）\n   伪共享：多个线程修改相互独立的变量时，如果它们位于同一个缓存行，则         会影响性能\n    java8：@Contended（自动填充缓存行），\n        但需要jvm参数-XX:RestrictContended\n   注意，缓存行的填充是以存储换性能。。。\n3、内存屏障 volatile   \n   \n","source":"_posts/disruptor为什么那么快.md","raw":"title: disruptor为什么那么快\nauthor: Xiang Chuang\ntags:\n  - disruptor\ncategories:\n  - 爱学爱问\ndate: 2018-11-13 17:05:00\n---\ndisruptor可用于线程间数据交互\n详细参考文章http://ifeve.com/disruptor/\n\n概述一下为什么那么快（这将有利于你借鉴思想）\n1、私有序列号，它是AtomicLong类型的，基于CAS（cpu级指令），因此没有锁\n2、缓存行填充，避免伪共享（一个缓存行64字节，对应8个long）\n   伪共享：多个线程修改相互独立的变量时，如果它们位于同一个缓存行，则         会影响性能\n    java8：@Contended（自动填充缓存行），\n        但需要jvm参数-XX:RestrictContended\n   注意，缓存行的填充是以存储换性能。。。\n3、内存屏障 volatile   \n   \n","slug":"disruptor为什么那么快","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbb000jwy66607f0jdt","content":"<p>disruptor可用于线程间数据交互<br>详细参考文章<a href=\"http://ifeve.com/disruptor/\">http://ifeve.com/disruptor/</a></p>\n<p>概述一下为什么那么快（这将有利于你借鉴思想）<br>1、私有序列号，它是AtomicLong类型的，基于CAS（cpu级指令），因此没有锁<br>2、缓存行填充，避免伪共享（一个缓存行64字节，对应8个long）<br>   伪共享：多个线程修改相互独立的变量时，如果它们位于同一个缓存行，则         会影响性能<br>    java8：@Contended（自动填充缓存行），<br>        但需要jvm参数-XX:RestrictContended<br>   注意，缓存行的填充是以存储换性能。。。<br>3、内存屏障 volatile   </p>\n","site":{"data":{}},"length":276,"excerpt":"","more":"<p>disruptor可用于线程间数据交互<br>详细参考文章<a href=\"http://ifeve.com/disruptor/\">http://ifeve.com/disruptor/</a></p>\n<p>概述一下为什么那么快（这将有利于你借鉴思想）<br>1、私有序列号，它是AtomicLong类型的，基于CAS（cpu级指令），因此没有锁<br>2、缓存行填充，避免伪共享（一个缓存行64字节，对应8个long）<br>   伪共享：多个线程修改相互独立的变量时，如果它们位于同一个缓存行，则         会影响性能<br>    java8：@Contended（自动填充缓存行），<br>        但需要jvm参数-XX:RestrictContended<br>   注意，缓存行的填充是以存储换性能。。。<br>3、内存屏障 volatile   </p>\n"},{"title":"druid-filter","author":"Xiang Chuang","date":"2018-07-12T06:02:00.000Z","_content":"com.alibaba.druid.filter.Filter\n过滤器，对数据库操作做切面代理\n\norg.apache.ibatis.session.SqlSession\norg.mybatis.spring.SqlSessionTemplate#sqlSessionProxy\ncom.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@3fadc0bd(DataSourceUtils.getConnection(this.dataSource);)\ncom.alibaba.druid.pool.DruidPooledPreparedStatement（createChain().preparedStatement_execute(this);）       \ncom.alibaba.druid.filter.FilterEventAdapter\ncom.yiji.common.ds.druid.YijiStatFilter（易极付实现）","source":"_posts/druid-filter.md","raw":"title: druid-filter\nauthor: Xiang Chuang\ntags:\n  - 数据库连接池\n  - db\n  - druid\ncategories:\n  - 爱学爱问\ndate: 2018-07-12 14:02:00\n---\ncom.alibaba.druid.filter.Filter\n过滤器，对数据库操作做切面代理\n\norg.apache.ibatis.session.SqlSession\norg.mybatis.spring.SqlSessionTemplate#sqlSessionProxy\ncom.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@3fadc0bd(DataSourceUtils.getConnection(this.dataSource);)\ncom.alibaba.druid.pool.DruidPooledPreparedStatement（createChain().preparedStatement_execute(this);）       \ncom.alibaba.druid.filter.FilterEventAdapter\ncom.yiji.common.ds.druid.YijiStatFilter（易极付实现）","slug":"druid-filter","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbc000mwy669o22duru","content":"<p>com.alibaba.druid.filter.Filter<br>过滤器，对数据库操作做切面代理</p>\n<p>org.apache.ibatis.session.SqlSession<br>org.mybatis.spring.SqlSessionTemplate#sqlSessionProxy<br>com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@3fadc0bd(DataSourceUtils.getConnection(this.dataSource);)<br>com.alibaba.druid.pool.DruidPooledPreparedStatement（createChain().preparedStatement_execute(this);）<br>com.alibaba.druid.filter.FilterEventAdapter<br>com.yiji.common.ds.druid.YijiStatFilter（易极付实现）</p>\n","site":{"data":{}},"length":429,"excerpt":"","more":"<p>com.alibaba.druid.filter.Filter<br>过滤器，对数据库操作做切面代理</p>\n<p>org.apache.ibatis.session.SqlSession<br>org.mybatis.spring.SqlSessionTemplate#sqlSessionProxy<br>com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@3fadc0bd(DataSourceUtils.getConnection(this.dataSource);)<br>com.alibaba.druid.pool.DruidPooledPreparedStatement（createChain().preparedStatement_execute(this);）<br>com.alibaba.druid.filter.FilterEventAdapter<br>com.yiji.common.ds.druid.YijiStatFilter（易极付实现）</p>\n"},{"title":"druid连接的获取与创建","author":"Xiang Chuang","date":"2019-01-18T11:49:00.000Z","_content":"背景：服务器闪断时，druid连接池获取异常，且重试时间较长\n经分析原因如下：\n1、应用申请连接时，传入允许等待时间为10S\n2、由于服务器闪断，瞬时出现部分线程A申请连接时，连接池中无空闲连接，因此A发出创建请求并等待（创建完成及返回连接，否则等待10s后返回失败）\n3、线程A触发创建连接的线程，开始创建连接，此时可能创建失败，会30S后重新尝试创建\n4、线程A同时会触发守护线程等待的信号量，守护线程接收到创建连接的信号量，也会开始创建连接，此时可能创建失败，会30S后重新尝试创建\n    \n影响：\n如果业务量不大，创建连接慢（或者创建失败），会引起部分线程执行慢\n如果业务量过大，且创建连接慢（或者创建失败），会导致线程积压从而导致内存消耗殆尽引起应用假死\n\n\n![upload successful](\\images\\pasted-75.png)\n\n别人画的图：\n\n![upload successful](\\images\\pasted-76.png)\n![upload successful](\\images\\pasted-77.png)","source":"_posts/druid连接的获取与创建.md","raw":"title: druid连接的获取与创建\nauthor: Xiang Chuang\ntags:\n  - druid\n  - 连接池\ncategories:\n  - 这些年，那些坑\ndate: 2019-01-18 19:49:00\n---\n背景：服务器闪断时，druid连接池获取异常，且重试时间较长\n经分析原因如下：\n1、应用申请连接时，传入允许等待时间为10S\n2、由于服务器闪断，瞬时出现部分线程A申请连接时，连接池中无空闲连接，因此A发出创建请求并等待（创建完成及返回连接，否则等待10s后返回失败）\n3、线程A触发创建连接的线程，开始创建连接，此时可能创建失败，会30S后重新尝试创建\n4、线程A同时会触发守护线程等待的信号量，守护线程接收到创建连接的信号量，也会开始创建连接，此时可能创建失败，会30S后重新尝试创建\n    \n影响：\n如果业务量不大，创建连接慢（或者创建失败），会引起部分线程执行慢\n如果业务量过大，且创建连接慢（或者创建失败），会导致线程积压从而导致内存消耗殆尽引起应用假死\n\n\n![upload successful](\\images\\pasted-75.png)\n\n别人画的图：\n\n![upload successful](\\images\\pasted-76.png)\n![upload successful](\\images\\pasted-77.png)","slug":"druid连接的获取与创建","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbd000qwy66dg5c1s4e","content":"<p>背景：服务器闪断时，druid连接池获取异常，且重试时间较长<br>经分析原因如下：<br>1、应用申请连接时，传入允许等待时间为10S<br>2、由于服务器闪断，瞬时出现部分线程A申请连接时，连接池中无空闲连接，因此A发出创建请求并等待（创建完成及返回连接，否则等待10s后返回失败）<br>3、线程A触发创建连接的线程，开始创建连接，此时可能创建失败，会30S后重新尝试创建<br>4、线程A同时会触发守护线程等待的信号量，守护线程接收到创建连接的信号量，也会开始创建连接，此时可能创建失败，会30S后重新尝试创建</p>\n<p>影响：<br>如果业务量不大，创建连接慢（或者创建失败），会引起部分线程执行慢<br>如果业务量过大，且创建连接慢（或者创建失败），会导致线程积压从而导致内存消耗殆尽引起应用假死</p>\n<p><img src=\"\\images\\pasted-75.png\" alt=\"upload successful\"></p>\n<p>别人画的图：</p>\n<p><img src=\"\\images\\pasted-76.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-77.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":326,"excerpt":"","more":"<p>背景：服务器闪断时，druid连接池获取异常，且重试时间较长<br>经分析原因如下：<br>1、应用申请连接时，传入允许等待时间为10S<br>2、由于服务器闪断，瞬时出现部分线程A申请连接时，连接池中无空闲连接，因此A发出创建请求并等待（创建完成及返回连接，否则等待10s后返回失败）<br>3、线程A触发创建连接的线程，开始创建连接，此时可能创建失败，会30S后重新尝试创建<br>4、线程A同时会触发守护线程等待的信号量，守护线程接收到创建连接的信号量，也会开始创建连接，此时可能创建失败，会30S后重新尝试创建</p>\n<p>影响：<br>如果业务量不大，创建连接慢（或者创建失败），会引起部分线程执行慢<br>如果业务量过大，且创建连接慢（或者创建失败），会导致线程积压从而导致内存消耗殆尽引起应用假死</p>\n<p><img src=\"\\images\\pasted-75.png\" alt=\"upload successful\"></p>\n<p>别人画的图：</p>\n<p><img src=\"\\images\\pasted-76.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-77.png\" alt=\"upload successful\"></p>\n"},{"title":"dubbo-反序列化问题","author":"Xiang Chuang","date":"2018-06-28T04:14:00.000Z","_content":"问题：网银充值，支付引擎调用清算调用网关，网关响应清算，清算响应支付引擎（支付引擎解析时出现反序列化异常）\n\n原因分析：清算配置了yiji.dubbo.provider.serialization=hessian3，即传输时使用hessian3序列化、反序列化\n，但是支付引擎使用的hessian2.  使用hessian2反序列化hessian3序列化出了问题\n\n但是清算反序列化网关为什么没有问题，  3反序列化2做了兼容？还是说，本身就是用的2反序列化2.  如果时2反序列化2，那么即使支付引擎配置成3，那岂不又成了2反序列化3？   所以应该是兼容吧！！！！","source":"_posts/dubbo-反序列化问题.md","raw":"title: dubbo-反序列化问题\nauthor: Xiang Chuang\ntags:\n  - dubbo\n  - 序列化\n  - hessian\ncategories:\n  - 这些年，那些坑\ndate: 2018-06-28 12:14:00\n---\n问题：网银充值，支付引擎调用清算调用网关，网关响应清算，清算响应支付引擎（支付引擎解析时出现反序列化异常）\n\n原因分析：清算配置了yiji.dubbo.provider.serialization=hessian3，即传输时使用hessian3序列化、反序列化\n，但是支付引擎使用的hessian2.  使用hessian2反序列化hessian3序列化出了问题\n\n但是清算反序列化网关为什么没有问题，  3反序列化2做了兼容？还是说，本身就是用的2反序列化2.  如果时2反序列化2，那么即使支付引擎配置成3，那岂不又成了2反序列化3？   所以应该是兼容吧！！！！","slug":"dubbo-反序列化问题","published":1,"updated":"2019-09-30T07:34:10.836Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbe000swy66c0cr08ee","content":"<p>问题：网银充值，支付引擎调用清算调用网关，网关响应清算，清算响应支付引擎（支付引擎解析时出现反序列化异常）</p>\n<p>原因分析：清算配置了yiji.dubbo.provider.serialization=hessian3，即传输时使用hessian3序列化、反序列化<br>，但是支付引擎使用的hessian2.  使用hessian2反序列化hessian3序列化出了问题</p>\n<p>但是清算反序列化网关为什么没有问题，  3反序列化2做了兼容？还是说，本身就是用的2反序列化2.  如果时2反序列化2，那么即使支付引擎配置成3，那岂不又成了2反序列化3？   所以应该是兼容吧！！！！</p>\n","site":{"data":{}},"length":270,"excerpt":"","more":"<p>问题：网银充值，支付引擎调用清算调用网关，网关响应清算，清算响应支付引擎（支付引擎解析时出现反序列化异常）</p>\n<p>原因分析：清算配置了yiji.dubbo.provider.serialization=hessian3，即传输时使用hessian3序列化、反序列化<br>，但是支付引擎使用的hessian2.  使用hessian2反序列化hessian3序列化出了问题</p>\n<p>但是清算反序列化网关为什么没有问题，  3反序列化2做了兼容？还是说，本身就是用的2反序列化2.  如果时2反序列化2，那么即使支付引擎配置成3，那岂不又成了2反序列化3？   所以应该是兼容吧！！！！</p>\n"},{"title":"dubbo-基于zookeeper的注册结构","author":"Xiang Chuang","date":"2019-03-07T07:25:00.000Z","_content":"\n![upload successful](\\images\\pasted-49.png)","source":"_posts/dubbo-基于zookeeper的注册结构.md","raw":"title: dubbo-基于zookeeper的注册结构\nauthor: Xiang Chuang\ntags:\n  - dubbo\n  - zookeeper\ncategories:\n  - 爱学爱问\ndate: 2019-03-07 15:25:00\n---\n\n![upload successful](\\images\\pasted-49.png)","slug":"dubbo-基于zookeeper的注册结构","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbf000wwy66bgdt0i4c","content":"<p><img src=\"\\images\\pasted-49.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":0,"excerpt":"","more":"<p><img src=\"\\images\\pasted-49.png\" alt=\"upload successful\"></p>\n"},{"title":"dubbo-（反）序列化","author":"Xiang Chuang","date":"2018-06-12T10:24:00.000Z","_content":"dubbo枚举（反）序列化使用的是：com.alibaba.com.caucho.hessian.io.EnumDeserializer\n根据枚举的name进行处理Enum.valueOf(Class, enumName);\n使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常\n\n注：\n1、rabbit mq序列化默认使用com.esotericsoftware.kryo.serializers.DefaultSerializers.EnumSerializer\nkyro按顺序处理\n使用时，必须保证序列化和反序列化时，枚举值的顺序是一致的，否则拿到错误的枚举值，同时可能出现下标越界\n\n2、com.alibaba.fastjson.JSON.parseObject.parseJSON使用com.alibaba.fastjson.parser.deserializer.EnumDeserializer\n根据枚举的name进行处理Enum.valueOf(Class, enumName);\n使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常","source":"_posts/dubbo-（反）序列化.md","raw":"title: dubbo-（反）序列化\nauthor: Xiang Chuang\ntags:\n  - dubbo\n  - 序列化\ncategories:\n  - 这些年，那些坑\ndate: 2018-06-12 18:24:00\n---\ndubbo枚举（反）序列化使用的是：com.alibaba.com.caucho.hessian.io.EnumDeserializer\n根据枚举的name进行处理Enum.valueOf(Class, enumName);\n使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常\n\n注：\n1、rabbit mq序列化默认使用com.esotericsoftware.kryo.serializers.DefaultSerializers.EnumSerializer\nkyro按顺序处理\n使用时，必须保证序列化和反序列化时，枚举值的顺序是一致的，否则拿到错误的枚举值，同时可能出现下标越界\n\n2、com.alibaba.fastjson.JSON.parseObject.parseJSON使用com.alibaba.fastjson.parser.deserializer.EnumDeserializer\n根据枚举的name进行处理Enum.valueOf(Class, enumName);\n使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常","slug":"dubbo-（反）序列化","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbg000ywy668qju50s9","content":"<p>dubbo枚举（反）序列化使用的是：com.alibaba.com.caucho.hessian.io.EnumDeserializer<br>根据枚举的name进行处理Enum.valueOf(Class, enumName);<br>使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常</p>\n<p>注：<br>1、rabbit mq序列化默认使用com.esotericsoftware.kryo.serializers.DefaultSerializers.EnumSerializer<br>kyro按顺序处理<br>使用时，必须保证序列化和反序列化时，枚举值的顺序是一致的，否则拿到错误的枚举值，同时可能出现下标越界</p>\n<p>2、com.alibaba.fastjson.JSON.parseObject.parseJSON使用com.alibaba.fastjson.parser.deserializer.EnumDeserializer<br>根据枚举的name进行处理Enum.valueOf(Class, enumName);<br>使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常</p>\n","site":{"data":{}},"length":477,"excerpt":"","more":"<p>dubbo枚举（反）序列化使用的是：com.alibaba.com.caucho.hessian.io.EnumDeserializer<br>根据枚举的name进行处理Enum.valueOf(Class, enumName);<br>使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常</p>\n<p>注：<br>1、rabbit mq序列化默认使用com.esotericsoftware.kryo.serializers.DefaultSerializers.EnumSerializer<br>kyro按顺序处理<br>使用时，必须保证序列化和反序列化时，枚举值的顺序是一致的，否则拿到错误的枚举值，同时可能出现下标越界</p>\n<p>2、com.alibaba.fastjson.JSON.parseObject.parseJSON使用com.alibaba.fastjson.parser.deserializer.EnumDeserializer<br>根据枚举的name进行处理Enum.valueOf(Class, enumName);<br>使用时，只要保证当前应用有对应name的枚举值就能拿到，没有则抛异常</p>\n"},{"title":"elasticsearch-集群","author":"Xiang Chuang","date":"2017-09-27T08:02:00.000Z","_content":"ElasticSearch 的主旨是随时可用和按需扩容。 \n1、通过购买性能更强大（ 垂直扩容 ，或 纵向扩容） 扩容能力有限   \n2、数量更多的服务器（ 水平扩容 ，或 横向扩容 ） （elasticsearch天生分布式）     \n\n一个运行中的 Elasticsearch 实例称为一个 节点，而集群是由一个或者多个拥有相同 cluster.name 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。\n\n主 节点： 负责管理集群范围内的所有变更（如增加、删除索引，或者增加、删除节点等），不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。用户可以将请求发送到 集群中的任何节点 ，包括主节点。 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 Elasticsearch 对这一切的管理都是透明的。\n\n查询集群健康：GET /_cluster/health\nstatus\ngreen  所有的主分片和副本分片都正常运行。 \nyellow  所有的主分片都正常运行，但不是所有的副本分片都正常运行。 \nred  有主分片没能正常运行。\n\n索引实际上是指向一个或者多个物理 分片（仅保存了 全部数据中的一部分，一个分片是一个 Lucene 的实例） 的 逻辑命名空间 。\n初始化索引的分片（默认5个主分片）\nPUT /blogs\n{\n   \"settings\" : {\n      \"number_of_shards\" : 3,\n      \"number_of_replicas\" : 1\n   }\n}\n调整副分片大小\nPUT /blogs/_settings\n{\n   \"number_of_replicas\" : 2\n}","source":"_posts/elasticsearch-集群.md","raw":"title: elasticsearch-集群\nauthor: Xiang Chuang\ntags:\n  - elk\n  - 集群\ncategories:\n  - 爱学爱问\ndate: 2017-09-27 16:02:00\n---\nElasticSearch 的主旨是随时可用和按需扩容。 \n1、通过购买性能更强大（ 垂直扩容 ，或 纵向扩容） 扩容能力有限   \n2、数量更多的服务器（ 水平扩容 ，或 横向扩容 ） （elasticsearch天生分布式）     \n\n一个运行中的 Elasticsearch 实例称为一个 节点，而集群是由一个或者多个拥有相同 cluster.name 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。\n\n主 节点： 负责管理集群范围内的所有变更（如增加、删除索引，或者增加、删除节点等），不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。用户可以将请求发送到 集群中的任何节点 ，包括主节点。 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 Elasticsearch 对这一切的管理都是透明的。\n\n查询集群健康：GET /_cluster/health\nstatus\ngreen  所有的主分片和副本分片都正常运行。 \nyellow  所有的主分片都正常运行，但不是所有的副本分片都正常运行。 \nred  有主分片没能正常运行。\n\n索引实际上是指向一个或者多个物理 分片（仅保存了 全部数据中的一部分，一个分片是一个 Lucene 的实例） 的 逻辑命名空间 。\n初始化索引的分片（默认5个主分片）\nPUT /blogs\n{\n   \"settings\" : {\n      \"number_of_shards\" : 3,\n      \"number_of_replicas\" : 1\n   }\n}\n调整副分片大小\nPUT /blogs/_settings\n{\n   \"number_of_replicas\" : 2\n}","slug":"elasticsearch-集群","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbh0010wy66c9jhhef4","content":"<p>ElasticSearch 的主旨是随时可用和按需扩容。<br>1、通过购买性能更强大（ 垂直扩容 ，或 纵向扩容） 扩容能力有限<br>2、数量更多的服务器（ 水平扩容 ，或 横向扩容 ） （elasticsearch天生分布式）     </p>\n<p>一个运行中的 Elasticsearch 实例称为一个 节点，而集群是由一个或者多个拥有相同 cluster.name 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。</p>\n<p>主 节点： 负责管理集群范围内的所有变更（如增加、删除索引，或者增加、删除节点等），不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。用户可以将请求发送到 集群中的任何节点 ，包括主节点。 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 Elasticsearch 对这一切的管理都是透明的。</p>\n<p>查询集群健康：GET /_cluster/health<br>status<br>green  所有的主分片和副本分片都正常运行。<br>yellow  所有的主分片都正常运行，但不是所有的副本分片都正常运行。<br>red  有主分片没能正常运行。</p>\n<p>索引实际上是指向一个或者多个物理 分片（仅保存了 全部数据中的一部分，一个分片是一个 Lucene 的实例） 的 逻辑命名空间 。<br>初始化索引的分片（默认5个主分片）<br>PUT /blogs<br>{<br>   “settings” : {<br>      “number_of_shards” : 3,<br>      “number_of_replicas” : 1<br>   }<br>}<br>调整副分片大小<br>PUT /blogs/_settings<br>{<br>   “number_of_replicas” : 2<br>}</p>\n","site":{"data":{}},"length":762,"excerpt":"","more":"<p>ElasticSearch 的主旨是随时可用和按需扩容。<br>1、通过购买性能更强大（ 垂直扩容 ，或 纵向扩容） 扩容能力有限<br>2、数量更多的服务器（ 水平扩容 ，或 横向扩容 ） （elasticsearch天生分布式）     </p>\n<p>一个运行中的 Elasticsearch 实例称为一个 节点，而集群是由一个或者多个拥有相同 cluster.name 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。</p>\n<p>主 节点： 负责管理集群范围内的所有变更（如增加、删除索引，或者增加、删除节点等），不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。用户可以将请求发送到 集群中的任何节点 ，包括主节点。 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 Elasticsearch 对这一切的管理都是透明的。</p>\n<p>查询集群健康：GET /_cluster/health<br>status<br>green  所有的主分片和副本分片都正常运行。<br>yellow  所有的主分片都正常运行，但不是所有的副本分片都正常运行。<br>red  有主分片没能正常运行。</p>\n<p>索引实际上是指向一个或者多个物理 分片（仅保存了 全部数据中的一部分，一个分片是一个 Lucene 的实例） 的 逻辑命名空间 。<br>初始化索引的分片（默认5个主分片）<br>PUT /blogs<br>{<br>   “settings” : {<br>      “number_of_shards” : 3,<br>      “number_of_replicas” : 1<br>   }<br>}<br>调整副分片大小<br>PUT /blogs/_settings<br>{<br>   “number_of_replicas” : 2<br>}</p>\n"},{"title":"fastdfs磁盘空间占满问题处理","author":"Xiang Chuang","date":"2021-10-08T02:32:00.000Z","_content":"问题描述：\n\t应用使用文件中台（基于fastdfs实现）上传文件时，报错：28，错误信息：没有足够的存储空间。\n问题分析：\n\t根据错误描述，初步判断是fastdfs所在服务器磁盘空间不足所致\n问题处理：\n\t1、进入相应服务器排查磁盘空间情况df -h\n    \t排查到磁盘已使用空间为86%（总大小32G），理论上当前服务仍有几个G空间可用，可继续上传文件\n    2、查询fastdfs配置文件tracker.conf，找到配置reserved_storage_space，该配置默认为10%，经查看，本服务器中该配置配置为了20%，因此导致文件无法继续上传。注：配置reserved_storage_space代表预留磁盘空间大小，当服务器磁盘空间小于此大小后，不允许继续上传服务器，如果文件存储挂在到了多个目录，以小的为准【storage.conf中的store_path_count及store_path0，store_path11...支持多个存储空间】\n    3、查询占用磁盘空间较多的目录，du --max-depth=1 -h \n    \t经排查，发现本服务器上rocketmq日志所在存储空间较多\n    4、此处直接删除了rokectmq的相关日志，但再次df -h发现磁盘并未回收，经分析，原因在于删除文件时未结束相关进程，导致磁盘控制未回收，因为在Linux系统中，通过rm或者文件管理器删除文件，系统只是将它会从文件系统的目录结构上解除链接(unlink)，即只删除了文件和系统目录结构的链接，如果文件在删除时是被打开的（如正被某进程访问）状态，那么进程将仍然可以读取该文件，所以磁盘空间也就会一直被占用。  因此，推荐1、结束进程后删除文件，  2、如果进程不能结束，则在线清空文件，1）# echo \" \" > /xxx/xxx.log、2）# cat /dev/null > /xxx/xxx.log、3）# > /xxx/xxx.log\n    5、如果已经在未结束进程的情况的删掉了文件，可采用命令 lsof | grep deleted进行查询，找到对应的目录关联的进程，kill掉相应进程即可\n    6、再次df -h查询磁盘空间，已完成释放","source":"_posts/fastdfs异常分析.md","raw":"title: fastdfs磁盘空间占满问题处理\nauthor: Xiang Chuang\ntags: []\ncategories:\n  - 爱学爱问\ndate: 2021-10-08 10:32:00\n---\n问题描述：\n\t应用使用文件中台（基于fastdfs实现）上传文件时，报错：28，错误信息：没有足够的存储空间。\n问题分析：\n\t根据错误描述，初步判断是fastdfs所在服务器磁盘空间不足所致\n问题处理：\n\t1、进入相应服务器排查磁盘空间情况df -h\n    \t排查到磁盘已使用空间为86%（总大小32G），理论上当前服务仍有几个G空间可用，可继续上传文件\n    2、查询fastdfs配置文件tracker.conf，找到配置reserved_storage_space，该配置默认为10%，经查看，本服务器中该配置配置为了20%，因此导致文件无法继续上传。注：配置reserved_storage_space代表预留磁盘空间大小，当服务器磁盘空间小于此大小后，不允许继续上传服务器，如果文件存储挂在到了多个目录，以小的为准【storage.conf中的store_path_count及store_path0，store_path11...支持多个存储空间】\n    3、查询占用磁盘空间较多的目录，du --max-depth=1 -h \n    \t经排查，发现本服务器上rocketmq日志所在存储空间较多\n    4、此处直接删除了rokectmq的相关日志，但再次df -h发现磁盘并未回收，经分析，原因在于删除文件时未结束相关进程，导致磁盘控制未回收，因为在Linux系统中，通过rm或者文件管理器删除文件，系统只是将它会从文件系统的目录结构上解除链接(unlink)，即只删除了文件和系统目录结构的链接，如果文件在删除时是被打开的（如正被某进程访问）状态，那么进程将仍然可以读取该文件，所以磁盘空间也就会一直被占用。  因此，推荐1、结束进程后删除文件，  2、如果进程不能结束，则在线清空文件，1）# echo \" \" > /xxx/xxx.log、2）# cat /dev/null > /xxx/xxx.log、3）# > /xxx/xxx.log\n    5、如果已经在未结束进程的情况的删掉了文件，可采用命令 lsof | grep deleted进行查询，找到对应的目录关联的进程，kill掉相应进程即可\n    6、再次df -h查询磁盘空间，已完成释放","slug":"fastdfs异常分析","published":1,"updated":"2021-10-08T02:51:55.826Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbi0015wy667eusaz57","content":"<p>问题描述：<br>    应用使用文件中台（基于fastdfs实现）上传文件时，报错：28，错误信息：没有足够的存储空间。<br>问题分析：<br>    根据错误描述，初步判断是fastdfs所在服务器磁盘空间不足所致<br>问题处理：<br>    1、进入相应服务器排查磁盘空间情况df -h<br>        排查到磁盘已使用空间为86%（总大小32G），理论上当前服务仍有几个G空间可用，可继续上传文件<br>    2、查询fastdfs配置文件tracker.conf，找到配置reserved_storage_space，该配置默认为10%，经查看，本服务器中该配置配置为了20%，因此导致文件无法继续上传。注：配置reserved_storage_space代表预留磁盘空间大小，当服务器磁盘空间小于此大小后，不允许继续上传服务器，如果文件存储挂在到了多个目录，以小的为准【storage.conf中的store_path_count及store_path0，store_path11…支持多个存储空间】<br>    3、查询占用磁盘空间较多的目录，du –max-depth=1 -h<br>        经排查，发现本服务器上rocketmq日志所在存储空间较多<br>    4、此处直接删除了rokectmq的相关日志，但再次df -h发现磁盘并未回收，经分析，原因在于删除文件时未结束相关进程，导致磁盘控制未回收，因为在Linux系统中，通过rm或者文件管理器删除文件，系统只是将它会从文件系统的目录结构上解除链接(unlink)，即只删除了文件和系统目录结构的链接，如果文件在删除时是被打开的（如正被某进程访问）状态，那么进程将仍然可以读取该文件，所以磁盘空间也就会一直被占用。  因此，推荐1、结束进程后删除文件，  2、如果进程不能结束，则在线清空文件，1）# echo “ “ &gt; /xxx/xxx.log、2）# cat /dev/null &gt; /xxx/xxx.log、3）# &gt; /xxx/xxx.log<br>    5、如果已经在未结束进程的情况的删掉了文件，可采用命令 lsof | grep deleted进行查询，找到对应的目录关联的进程，kill掉相应进程即可<br>    6、再次df -h查询磁盘空间，已完成释放</p>\n","site":{"data":{}},"length":879,"excerpt":"","more":"<p>问题描述：<br>    应用使用文件中台（基于fastdfs实现）上传文件时，报错：28，错误信息：没有足够的存储空间。<br>问题分析：<br>    根据错误描述，初步判断是fastdfs所在服务器磁盘空间不足所致<br>问题处理：<br>    1、进入相应服务器排查磁盘空间情况df -h<br>        排查到磁盘已使用空间为86%（总大小32G），理论上当前服务仍有几个G空间可用，可继续上传文件<br>    2、查询fastdfs配置文件tracker.conf，找到配置reserved_storage_space，该配置默认为10%，经查看，本服务器中该配置配置为了20%，因此导致文件无法继续上传。注：配置reserved_storage_space代表预留磁盘空间大小，当服务器磁盘空间小于此大小后，不允许继续上传服务器，如果文件存储挂在到了多个目录，以小的为准【storage.conf中的store_path_count及store_path0，store_path11…支持多个存储空间】<br>    3、查询占用磁盘空间较多的目录，du –max-depth=1 -h<br>        经排查，发现本服务器上rocketmq日志所在存储空间较多<br>    4、此处直接删除了rokectmq的相关日志，但再次df -h发现磁盘并未回收，经分析，原因在于删除文件时未结束相关进程，导致磁盘控制未回收，因为在Linux系统中，通过rm或者文件管理器删除文件，系统只是将它会从文件系统的目录结构上解除链接(unlink)，即只删除了文件和系统目录结构的链接，如果文件在删除时是被打开的（如正被某进程访问）状态，那么进程将仍然可以读取该文件，所以磁盘空间也就会一直被占用。  因此，推荐1、结束进程后删除文件，  2、如果进程不能结束，则在线清空文件，1）# echo “ “ &gt; /xxx/xxx.log、2）# cat /dev/null &gt; /xxx/xxx.log、3）# &gt; /xxx/xxx.log<br>    5、如果已经在未结束进程的情况的删掉了文件，可采用命令 lsof | grep deleted进行查询，找到对应的目录关联的进程，kill掉相应进程即可<br>    6、再次df -h查询磁盘空间，已完成释放</p>\n"},{"title":"git-本地commit、push、show、reset操作","author":"Xiang Chuang","date":"2019-04-28T03:06:00.000Z","_content":"问题：\n使用git commit代码时，git commit完成\n后续执行git push origin master:master 提示“Everything up-to-date”\n使用git show查询，确实能看到提交的内容\n\n原因：\n尝试提交到master，但本地对应的其实是一个分支\n\n解决：\n切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支\n\n使用git reflog返回如下\nfb3e1b1 (HEAD -> master) HEAD@{0}: reset: moving to fb3e1b1\n2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master\nfb3e1b1 (HEAD -> master) HEAD@{2}: commit: 场景化业务监控模型搭建\n2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0\n2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎\n6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测\nb28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量\nad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）\n3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）\n6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中\ndd0138f HEAD@{10}: commit: hera配置更改\n29764a1 HEAD@{11}: commit: README\n75debd5 HEAD@{12}: clone: from http://gitlab.yiji/yangxi/godeye.git\n\n再次使用git reset --hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳\n\n$ git reset --hard fb3e1b1\nHEAD is now at fb3e1b1 场景化业务监控模型搭建\n\n\n","source":"_posts/git-本地commit、push、show、reset操作.md","raw":"title: git-本地commit、push、show、reset操作\nauthor: Xiang Chuang\ntags:\n  - git\n  - 版本控制\ncategories:\n  - 爱学爱问\ndate: 2019-04-28 11:06:00\n---\n问题：\n使用git commit代码时，git commit完成\n后续执行git push origin master:master 提示“Everything up-to-date”\n使用git show查询，确实能看到提交的内容\n\n原因：\n尝试提交到master，但本地对应的其实是一个分支\n\n解决：\n切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支\n\n使用git reflog返回如下\nfb3e1b1 (HEAD -> master) HEAD@{0}: reset: moving to fb3e1b1\n2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master\nfb3e1b1 (HEAD -> master) HEAD@{2}: commit: 场景化业务监控模型搭建\n2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0\n2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎\n6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测\nb28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量\nad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）\n3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）\n6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中\ndd0138f HEAD@{10}: commit: hera配置更改\n29764a1 HEAD@{11}: commit: README\n75debd5 HEAD@{12}: clone: from http://gitlab.yiji/yangxi/godeye.git\n\n再次使用git reset --hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳\n\n$ git reset --hard fb3e1b1\nHEAD is now at fb3e1b1 场景化业务监控模型搭建\n\n\n","slug":"git-本地commit、push、show、reset操作","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbj0018wy66brwt6z0d","content":"<p>问题：<br>使用git commit代码时，git commit完成<br>后续执行git push origin master:master 提示“Everything up-to-date”<br>使用git show查询，确实能看到提交的内容</p>\n<p>原因：<br>尝试提交到master，但本地对应的其实是一个分支</p>\n<p>解决：<br>切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支</p>\n<p>使用git reflog返回如下<br>fb3e1b1 (HEAD -&gt; master) HEAD@{0}: reset: moving to fb3e1b1<br>2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master<br>fb3e1b1 (HEAD -&gt; master) HEAD@{2}: commit: 场景化业务监控模型搭建<br>2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0<br>2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎<br>6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测<br>b28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量<br>ad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中<br>dd0138f HEAD@{10}: commit: hera配置更改<br>29764a1 HEAD@{11}: commit: README<br>75debd5 HEAD@{12}: clone: from <a href=\"http://gitlab.yiji/yangxi/godeye.git\">http://gitlab.yiji/yangxi/godeye.git</a></p>\n<p>再次使用git reset –hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳</p>\n<p>$ git reset –hard fb3e1b1<br>HEAD is now at fb3e1b1 场景化业务监控模型搭建</p>\n","site":{"data":{}},"length":1045,"excerpt":"","more":"<p>问题：<br>使用git commit代码时，git commit完成<br>后续执行git push origin master:master 提示“Everything up-to-date”<br>使用git show查询，确实能看到提交的内容</p>\n<p>原因：<br>尝试提交到master，但本地对应的其实是一个分支</p>\n<p>解决：<br>切换分支到主干，此时发现，git show，刚刚提交的内容看不到了，且本地代码中也没有了，说明commit关联到了对应的分支</p>\n<p>使用git reflog返回如下<br>fb3e1b1 (HEAD -&gt; master) HEAD@{0}: reset: moving to fb3e1b1<br>2d7b28e (origin/master, origin/HEAD) HEAD@{1}: checkout: moving from fb3e1b16278856b6108cfe3010f7e4fd8c4e3634 to master<br>fb3e1b1 (HEAD -&gt; master) HEAD@{2}: commit: 场景化业务监控模型搭建<br>2d7b28e (origin/master, origin/HEAD) HEAD@{3}: checkout: moving from master to 2d7b28e3^0<br>2d7b28e (origin/master, origin/HEAD) HEAD@{4}: commit: 引入规则引擎<br>6fe0e4e HEAD@{5}: commit: 基于elk-kafka数据传输通道活性检测<br>b28b71b HEAD@{6}: commit: kafka消费者数量及分组在hera中配置，同时采集入口采用线程池执行以提高吞吐量<br>ad4778d HEAD@{7}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>3d9affa HEAD@{8}: commit: 基于elk-kafka传输通道的数据采集功能实现（需进行性能评估）<br>6508afa HEAD@{9}: commit: 后台管理实现类同步到项目中<br>dd0138f HEAD@{10}: commit: hera配置更改<br>29764a1 HEAD@{11}: commit: README<br>75debd5 HEAD@{12}: clone: from <a href=\"http://gitlab.yiji/yangxi/godeye.git\">http://gitlab.yiji/yangxi/godeye.git</a></p>\n<p>再次使用git reset –hard fb3e1b1，将本地代码还原到了相应的版本，代码终于回来了，吓一跳</p>\n<p>$ git reset –hard fb3e1b1<br>HEAD is now at fb3e1b1 场景化业务监控模型搭建</p>\n"},{"title":"grafana安装及使用","author":"Xiang Chuang","date":"2019-11-25T07:57:00.000Z","_content":"1、官网下载地址：https://grafana.com/grafana/download\n \n centos：wget https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm \nsudo yum localinstall grafana-6.4.4-1.x86_64.rpm \n\nmac：brew update \nbrew install grafana\n\n2、新增用户\n\tgrafana注册用户需要采用邮件服务器进行激活，如果没有邮件服务器，可更改数据库，直接新增用户，步骤如下：\n    1、 ps -ef | grep grafana 找到数据库地址\n\t2、cfg:default.paths.data=数据库地址\n\t3、cd 数据库地址\n\t4、sqlite3 grafana.db\n\t5、select * from user; \n    6、sqlite> select * from  sqlite_master where type=\"table\" and name = \"user\"\n   ...> ;\ntable|user|user|6|CREATE TABLE `user` (\n`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL\n, `version` INTEGER NOT NULL\n, `login` TEXT NOT NULL\n, `email` TEXT NOT NULL\n, `name` TEXT NULL\n, `password` TEXT NULL\n, `salt` TEXT NULL\n, `rands` TEXT NULL\n, `company` TEXT NULL\n, `org_id` INTEGER NOT NULL\n, `is_admin` INTEGER NOT NULL\n, `email_verified` INTEGER NULL\n, `theme` TEXT NULL\n, `created` DATETIME NOT NULL\n, `updated` DATETIME NOT NULL\n    7、复制admin用户的相关信息（login，email等），将权限is_admin改为0\n    eg： insert into user values(2,0,'tech','technology@XXXX','tech','59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6','F3FAxVm33R',null,null,1,0,0,null,'2019-11-06 07:12:14','2019-11-06 07:12:14',0,null,0); --此密码为admin\n    8、访问ip:3000，使用7设置的用户名和管理员admin的密码登录，此时弹出对话框要求重置密码，进行新账户密码重置，此时该账户没有dashbord查询权限\n    9、使用admin管理员登录，\n    invite your team\n![upload successful](\\images\\pasted-95.png)\ninvite\n\n![upload successful](\\images\\pasted-96.png)\n\n![upload successful](\\images\\pasted-97.png)\n\n![upload successful](\\images\\pasted-98.png)\n10、重新使用新账户登录即可看到dashbord","source":"_posts/grafana安装及使用.md","raw":"title: grafana安装及使用\nauthor: Xiang Chuang\ntags:\n  - grafana\ncategories: []\ndate: 2019-11-25 15:57:00\n---\n1、官网下载地址：https://grafana.com/grafana/download\n \n centos：wget https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm \nsudo yum localinstall grafana-6.4.4-1.x86_64.rpm \n\nmac：brew update \nbrew install grafana\n\n2、新增用户\n\tgrafana注册用户需要采用邮件服务器进行激活，如果没有邮件服务器，可更改数据库，直接新增用户，步骤如下：\n    1、 ps -ef | grep grafana 找到数据库地址\n\t2、cfg:default.paths.data=数据库地址\n\t3、cd 数据库地址\n\t4、sqlite3 grafana.db\n\t5、select * from user; \n    6、sqlite> select * from  sqlite_master where type=\"table\" and name = \"user\"\n   ...> ;\ntable|user|user|6|CREATE TABLE `user` (\n`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL\n, `version` INTEGER NOT NULL\n, `login` TEXT NOT NULL\n, `email` TEXT NOT NULL\n, `name` TEXT NULL\n, `password` TEXT NULL\n, `salt` TEXT NULL\n, `rands` TEXT NULL\n, `company` TEXT NULL\n, `org_id` INTEGER NOT NULL\n, `is_admin` INTEGER NOT NULL\n, `email_verified` INTEGER NULL\n, `theme` TEXT NULL\n, `created` DATETIME NOT NULL\n, `updated` DATETIME NOT NULL\n    7、复制admin用户的相关信息（login，email等），将权限is_admin改为0\n    eg： insert into user values(2,0,'tech','technology@XXXX','tech','59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6','F3FAxVm33R',null,null,1,0,0,null,'2019-11-06 07:12:14','2019-11-06 07:12:14',0,null,0); --此密码为admin\n    8、访问ip:3000，使用7设置的用户名和管理员admin的密码登录，此时弹出对话框要求重置密码，进行新账户密码重置，此时该账户没有dashbord查询权限\n    9、使用admin管理员登录，\n    invite your team\n![upload successful](\\images\\pasted-95.png)\ninvite\n\n![upload successful](\\images\\pasted-96.png)\n\n![upload successful](\\images\\pasted-97.png)\n\n![upload successful](\\images\\pasted-98.png)\n10、重新使用新账户登录即可看到dashbord","slug":"grafana安装及使用","published":1,"updated":"2019-11-25T08:18:20.812Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbl001cwy66d5s91q5r","content":"<p>1、官网下载地址：<a href=\"https://grafana.com/grafana/download\">https://grafana.com/grafana/download</a></p>\n<p> centos：wget <a href=\"https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm\">https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm</a><br>sudo yum localinstall grafana-6.4.4-1.x86_64.rpm </p>\n<p>mac：brew update<br>brew install grafana</p>\n<p>2、新增用户<br>    grafana注册用户需要采用邮件服务器进行激活，如果没有邮件服务器，可更改数据库，直接新增用户，步骤如下：<br>    1、 ps -ef | grep grafana 找到数据库地址<br>    2、cfg:default.paths.data=数据库地址<br>    3、cd 数据库地址<br>    4、sqlite3 grafana.db<br>    5、select <em> from user;<br>    6、sqlite&gt; select </em> from  sqlite_master where type=”table” and name = “user”<br>   …&gt; ;<br>table|user|user|6|CREATE TABLE <code>user</code> (<br><code>id</code> INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL<br>, <code>version</code> INTEGER NOT NULL<br>, <code>login</code> TEXT NOT NULL<br>, <code>email</code> TEXT NOT NULL<br>, <code>name</code> TEXT NULL<br>, <code>password</code> TEXT NULL<br>, <code>salt</code> TEXT NULL<br>, <code>rands</code> TEXT NULL<br>, <code>company</code> TEXT NULL<br>, <code>org_id</code> INTEGER NOT NULL<br>, <code>is_admin</code> INTEGER NOT NULL<br>, <code>email_verified</code> INTEGER NULL<br>, <code>theme</code> TEXT NULL<br>, <code>created</code> DATETIME NOT NULL<br>, <code>updated</code> DATETIME NOT NULL<br>    7、复制admin用户的相关信息（login，email等），将权限is_admin改为0<br>    eg： insert into user values(2,0,’tech’,‘technology@XXXX’,’tech’,’59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6’,’F3FAxVm33R’,null,null,1,0,0,null,’2019-11-06 07:12:14’,’2019-11-06 07:12:14’,0,null,0); –此密码为admin<br>    8、访问ip:3000，使用7设置的用户名和管理员admin的密码登录，此时弹出对话框要求重置密码，进行新账户密码重置，此时该账户没有dashbord查询权限<br>    9、使用admin管理员登录，<br>    invite your team<br><img src=\"\\images\\pasted-95.png\" alt=\"upload successful\"><br>invite</p>\n<p><img src=\"\\images\\pasted-96.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-97.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-98.png\" alt=\"upload successful\"><br>10、重新使用新账户登录即可看到dashbord</p>\n","site":{"data":{}},"length":1201,"excerpt":"","more":"<p>1、官网下载地址：<a href=\"https://grafana.com/grafana/download\">https://grafana.com/grafana/download</a></p>\n<p> centos：wget <a href=\"https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm\">https://dl.grafana.com/oss/release/grafana-6.4.4-1.x86_64.rpm</a><br>sudo yum localinstall grafana-6.4.4-1.x86_64.rpm </p>\n<p>mac：brew update<br>brew install grafana</p>\n<p>2、新增用户<br>    grafana注册用户需要采用邮件服务器进行激活，如果没有邮件服务器，可更改数据库，直接新增用户，步骤如下：<br>    1、 ps -ef | grep grafana 找到数据库地址<br>    2、cfg:default.paths.data=数据库地址<br>    3、cd 数据库地址<br>    4、sqlite3 grafana.db<br>    5、select <em> from user;<br>    6、sqlite&gt; select </em> from  sqlite_master where type=”table” and name = “user”<br>   …&gt; ;<br>table|user|user|6|CREATE TABLE <code>user</code> (<br><code>id</code> INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL<br>, <code>version</code> INTEGER NOT NULL<br>, <code>login</code> TEXT NOT NULL<br>, <code>email</code> TEXT NOT NULL<br>, <code>name</code> TEXT NULL<br>, <code>password</code> TEXT NULL<br>, <code>salt</code> TEXT NULL<br>, <code>rands</code> TEXT NULL<br>, <code>company</code> TEXT NULL<br>, <code>org_id</code> INTEGER NOT NULL<br>, <code>is_admin</code> INTEGER NOT NULL<br>, <code>email_verified</code> INTEGER NULL<br>, <code>theme</code> TEXT NULL<br>, <code>created</code> DATETIME NOT NULL<br>, <code>updated</code> DATETIME NOT NULL<br>    7、复制admin用户的相关信息（login，email等），将权限is_admin改为0<br>    eg： insert into user values(2,0,’tech’,‘technology@XXXX’,’tech’,’59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6’,’F3FAxVm33R’,null,null,1,0,0,null,’2019-11-06 07:12:14’,’2019-11-06 07:12:14’,0,null,0); –此密码为admin<br>    8、访问ip:3000，使用7设置的用户名和管理员admin的密码登录，此时弹出对话框要求重置密码，进行新账户密码重置，此时该账户没有dashbord查询权限<br>    9、使用admin管理员登录，<br>    invite your team<br><img src=\"\\images\\pasted-95.png\" alt=\"upload successful\"><br>invite</p>\n<p><img src=\"\\images\\pasted-96.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-97.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-98.png\" alt=\"upload successful\"><br>10、重新使用新账户登录即可看到dashbord</p>\n"},{"title":"hexo迁移（升级）常见问题","author":"Xiang Chuang","date":"2021-09-28T03:49:00.000Z","_content":"hexo迁移或升级遇到的问题\n\nhexo的使用问题常见于版本不兼容导致，因此，可从hexo、npm、node版本是否匹配入手分析\n\n1、hexo deploy时，The “mode“ argument must be integer. Received an instance of Object\n排查步骤参考：\na、hexo -v 查看hexo相关依赖的版本\n\n![upload successful](/images/pasted-107.png)\n根据当前hexo及node版本在hexo官网核对版本是否匹配\n\nhexo的升级\nnpm uninstall hexo先卸载当前版本\nnpm install hexo@\n\nnode版本更换","source":"_posts/hexo迁移（升级）常见问题.md","raw":"title: hexo迁移（升级）常见问题\nauthor: Xiang Chuang\ntags:\n  - hexo\ncategories:\n  - hexo安装\ndate: 2021-09-28 11:49:00\n---\nhexo迁移或升级遇到的问题\n\nhexo的使用问题常见于版本不兼容导致，因此，可从hexo、npm、node版本是否匹配入手分析\n\n1、hexo deploy时，The “mode“ argument must be integer. Received an instance of Object\n排查步骤参考：\na、hexo -v 查看hexo相关依赖的版本\n\n![upload successful](/images/pasted-107.png)\n根据当前hexo及node版本在hexo官网核对版本是否匹配\n\nhexo的升级\nnpm uninstall hexo先卸载当前版本\nnpm install hexo@\n\nnode版本更换","slug":"hexo迁移（升级）常见问题","published":1,"updated":"2021-09-28T04:06:42.202Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbm001ewy663icf48xl","content":"<p>hexo迁移或升级遇到的问题</p>\n<p>hexo的使用问题常见于版本不兼容导致，因此，可从hexo、npm、node版本是否匹配入手分析</p>\n<p>1、hexo deploy时，The “mode“ argument must be integer. Received an instance of Object<br>排查步骤参考：<br>a、hexo -v 查看hexo相关依赖的版本</p>\n<p><img src=\"/images/pasted-107.png\" alt=\"upload successful\"><br>根据当前hexo及node版本在hexo官网核对版本是否匹配</p>\n<p>hexo的升级<br>npm uninstall hexo先卸载当前版本<br>npm install hexo@</p>\n<p>node版本更换</p>\n","site":{"data":{}},"length":244,"excerpt":"","more":"<p>hexo迁移或升级遇到的问题</p>\n<p>hexo的使用问题常见于版本不兼容导致，因此，可从hexo、npm、node版本是否匹配入手分析</p>\n<p>1、hexo deploy时，The “mode“ argument must be integer. Received an instance of Object<br>排查步骤参考：<br>a、hexo -v 查看hexo相关依赖的版本</p>\n<p><img src=\"/images/pasted-107.png\" alt=\"upload successful\"><br>根据当前hexo及node版本在hexo官网核对版本是否匹配</p>\n<p>hexo的升级<br>npm uninstall hexo先卸载当前版本<br>npm install hexo@</p>\n<p>node版本更换</p>\n"},{"title":"java-对象使用问题案例","author":"Xiang Chuang","date":"2018-08-06T09:23:00.000Z","_content":"关于java对象的使用，java编码的一个基本能力，但事实上，业务开发中，往往会有疏忽，下面从易极付支付引擎一个bug再次剖析java对象的使用。\n\n业务场景：支付引擎转账-定时任务批量加载挂起的数据执行转账并异步回执\n                1、批量查询挂起的转账数据，list\n                2、循环遍历list执行转换并回执\n                    2.1、将数据转换到业务上下文中\n                    2.2、执行转账（数据从业务上下文中获取）\n                    2.3、发布转账回执事件（数据从业务上下文中获取）\n                 3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）\n\n上述是简化后的业务流程，下面加以核心代码说明支付引擎的实现逻辑\n                1、批量查询挂起的转账数据，list \n              \n![upload successful](\\images\\pasted-24.png)\n\n![upload successful](\\images\\pasted-25.png)\n 2、循环遍历list执行转换并回执\n     2.1、将数据转换到业务上下文中\n     \n![upload successful](\\images\\pasted-26.png)\n\n![upload successful](\\images\\pasted-27.png)\n\n![upload successful](\\images\\pasted-28.png)\n这儿调用的是易极付common-util中提供的对象转换方法，源码如下：\n\n![upload successful](\\images\\pasted-30.png)\n\n![upload successful](\\images\\pasted-31.png)\n\n 2.2、执行转账（数据从业务上下文中获取）\n![upload successful](\\images\\pasted-32.png)\n\n2.3、发布转账回执事件（数据从业务上下文中获取）\n![upload successful](\\images\\pasted-33.png)\n\n![upload successful](\\images\\pasted-34.png)\n\n![upload successful](\\images\\pasted-35.png)\n\n![upload successful](\\images\\pasted-36.png)\n\n![upload successful](\\images\\pasted-37.png)\n\n3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）\n![upload successful](\\images\\pasted-38.png)\n\n上述逻辑，经过实际测试，存在严重问题，问题如下：\n异步回执时，拿到的数据并不是实际预期的数据，而被篡改了，可以看见的是，执行异步回执时，拿到了list循环遍历后续的数据。\n\n分析问题，很明显，我们看到了2.1这么一行代码：\n![upload successful](\\images\\pasted-39.png)\n那么，当前2.2转账完成后，发出2.3异步回执事件，3执行回执是异步的（并行的），此时下一次循环完全可能已经再次执行了2.1这行代码，那么就有问题！！！  为什么？\n\n上述判断只是初次分析，但经过进一步分析，我们发现其实3中的数据已经在2.3中将数据封装好，3只是从封装好的数据中取出相应的数据而已，2.3是同步执行过程，那么，下一次2.1执行时，一定是在上一次2.3执行完成之后！\n\n但是，经测试，这儿确实是有问题的，\n于是，再次分析：\n2.1进行数据转换时，通过源码分析，我们得出，此处只是将数据的值一个一个的set到业务上下文的数据对象中，那么意味着什么？  业务上下午serviceContext是一个全局对象，进入执行逻辑前已经初始化完成，那么，其内存已经开辟完成，意味着该对象中数据对象的内存也已开辟完成。那么，set值只是为那一块内存进行了赋值操作\n2.3通过getEntityObject将数据赋给新的对象I，那么，此时I和业务上下午中的数据对象都是指向同一块内存区域\n3/2.1 此时3和下一个2.1并行执行，3中获取数据对象的值，而1.2给上下文数据对象赋予新的值， 那么，3是从这块内存区域取值，1.2是给这块内存区域赋值，一旦1.2执行在前，那么3拿到的当然是重新赋予的值。\n\n通过上述分析，我们知道了问题根源，那么，如何改造？\n很简单\n修改2.1的代码为\n![upload successful](\\images\\pasted-40.png)\n\n![upload successful](\\images\\pasted-41.png)\n很显然，同样是给业务上下午数据对象赋值，与上面的方案区别在于，此处是将上下午数据对象指向的新的内存地址。\n那么执行2.3时，通过getEntityObject将数据赋给新的对象I，其所指向的内存地址也是这块新的地址\n执行3/2.1时，3依旧从这块内存地址取值，而2.1则是将上下午数据对象指向另一块内存地址，毫不冲突，更谈不上数据篡改。\n\n下面图示的方式给与说明：\n![upload successful](\\images\\pasted-42.png)\n","source":"_posts/java-对象使用问题案例.md","raw":"title: java-对象使用问题案例\nauthor: Xiang Chuang\ntags:\n  - java\n  - java对象\ncategories:\n  - 这些年，那些坑\ndate: 2018-08-06 17:23:00\n---\n关于java对象的使用，java编码的一个基本能力，但事实上，业务开发中，往往会有疏忽，下面从易极付支付引擎一个bug再次剖析java对象的使用。\n\n业务场景：支付引擎转账-定时任务批量加载挂起的数据执行转账并异步回执\n                1、批量查询挂起的转账数据，list\n                2、循环遍历list执行转换并回执\n                    2.1、将数据转换到业务上下文中\n                    2.2、执行转账（数据从业务上下文中获取）\n                    2.3、发布转账回执事件（数据从业务上下文中获取）\n                 3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）\n\n上述是简化后的业务流程，下面加以核心代码说明支付引擎的实现逻辑\n                1、批量查询挂起的转账数据，list \n              \n![upload successful](\\images\\pasted-24.png)\n\n![upload successful](\\images\\pasted-25.png)\n 2、循环遍历list执行转换并回执\n     2.1、将数据转换到业务上下文中\n     \n![upload successful](\\images\\pasted-26.png)\n\n![upload successful](\\images\\pasted-27.png)\n\n![upload successful](\\images\\pasted-28.png)\n这儿调用的是易极付common-util中提供的对象转换方法，源码如下：\n\n![upload successful](\\images\\pasted-30.png)\n\n![upload successful](\\images\\pasted-31.png)\n\n 2.2、执行转账（数据从业务上下文中获取）\n![upload successful](\\images\\pasted-32.png)\n\n2.3、发布转账回执事件（数据从业务上下文中获取）\n![upload successful](\\images\\pasted-33.png)\n\n![upload successful](\\images\\pasted-34.png)\n\n![upload successful](\\images\\pasted-35.png)\n\n![upload successful](\\images\\pasted-36.png)\n\n![upload successful](\\images\\pasted-37.png)\n\n3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）\n![upload successful](\\images\\pasted-38.png)\n\n上述逻辑，经过实际测试，存在严重问题，问题如下：\n异步回执时，拿到的数据并不是实际预期的数据，而被篡改了，可以看见的是，执行异步回执时，拿到了list循环遍历后续的数据。\n\n分析问题，很明显，我们看到了2.1这么一行代码：\n![upload successful](\\images\\pasted-39.png)\n那么，当前2.2转账完成后，发出2.3异步回执事件，3执行回执是异步的（并行的），此时下一次循环完全可能已经再次执行了2.1这行代码，那么就有问题！！！  为什么？\n\n上述判断只是初次分析，但经过进一步分析，我们发现其实3中的数据已经在2.3中将数据封装好，3只是从封装好的数据中取出相应的数据而已，2.3是同步执行过程，那么，下一次2.1执行时，一定是在上一次2.3执行完成之后！\n\n但是，经测试，这儿确实是有问题的，\n于是，再次分析：\n2.1进行数据转换时，通过源码分析，我们得出，此处只是将数据的值一个一个的set到业务上下文的数据对象中，那么意味着什么？  业务上下午serviceContext是一个全局对象，进入执行逻辑前已经初始化完成，那么，其内存已经开辟完成，意味着该对象中数据对象的内存也已开辟完成。那么，set值只是为那一块内存进行了赋值操作\n2.3通过getEntityObject将数据赋给新的对象I，那么，此时I和业务上下午中的数据对象都是指向同一块内存区域\n3/2.1 此时3和下一个2.1并行执行，3中获取数据对象的值，而1.2给上下文数据对象赋予新的值， 那么，3是从这块内存区域取值，1.2是给这块内存区域赋值，一旦1.2执行在前，那么3拿到的当然是重新赋予的值。\n\n通过上述分析，我们知道了问题根源，那么，如何改造？\n很简单\n修改2.1的代码为\n![upload successful](\\images\\pasted-40.png)\n\n![upload successful](\\images\\pasted-41.png)\n很显然，同样是给业务上下午数据对象赋值，与上面的方案区别在于，此处是将上下午数据对象指向的新的内存地址。\n那么执行2.3时，通过getEntityObject将数据赋给新的对象I，其所指向的内存地址也是这块新的地址\n执行3/2.1时，3依旧从这块内存地址取值，而2.1则是将上下午数据对象指向另一块内存地址，毫不冲突，更谈不上数据篡改。\n\n下面图示的方式给与说明：\n![upload successful](\\images\\pasted-42.png)\n","slug":"java-对象使用问题案例","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbn001hwy662y0xdlxp","content":"<p>关于java对象的使用，java编码的一个基本能力，但事实上，业务开发中，往往会有疏忽，下面从易极付支付引擎一个bug再次剖析java对象的使用。</p>\n<p>业务场景：支付引擎转账-定时任务批量加载挂起的数据执行转账并异步回执<br>                1、批量查询挂起的转账数据，list<br>                2、循环遍历list执行转换并回执<br>                    2.1、将数据转换到业务上下文中<br>                    2.2、执行转账（数据从业务上下文中获取）<br>                    2.3、发布转账回执事件（数据从业务上下文中获取）<br>                 3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）</p>\n<p>上述是简化后的业务流程，下面加以核心代码说明支付引擎的实现逻辑<br>                1、批量查询挂起的转账数据，list </p>\n<p><img src=\"\\images\\pasted-24.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-25.png\" alt=\"upload successful\"><br> 2、循环遍历list执行转换并回执<br>     2.1、将数据转换到业务上下文中</p>\n<p><img src=\"\\images\\pasted-26.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-27.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-28.png\" alt=\"upload successful\"><br>这儿调用的是易极付common-util中提供的对象转换方法，源码如下：</p>\n<p><img src=\"\\images\\pasted-30.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-31.png\" alt=\"upload successful\"></p>\n<p> 2.2、执行转账（数据从业务上下文中获取）<br><img src=\"\\images\\pasted-32.png\" alt=\"upload successful\"></p>\n<p>2.3、发布转账回执事件（数据从业务上下文中获取）<br><img src=\"\\images\\pasted-33.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-34.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-35.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-36.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-37.png\" alt=\"upload successful\"></p>\n<p>3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）<br><img src=\"\\images\\pasted-38.png\" alt=\"upload successful\"></p>\n<p>上述逻辑，经过实际测试，存在严重问题，问题如下：<br>异步回执时，拿到的数据并不是实际预期的数据，而被篡改了，可以看见的是，执行异步回执时，拿到了list循环遍历后续的数据。</p>\n<p>分析问题，很明显，我们看到了2.1这么一行代码：<br><img src=\"\\images\\pasted-39.png\" alt=\"upload successful\"><br>那么，当前2.2转账完成后，发出2.3异步回执事件，3执行回执是异步的（并行的），此时下一次循环完全可能已经再次执行了2.1这行代码，那么就有问题！！！  为什么？</p>\n<p>上述判断只是初次分析，但经过进一步分析，我们发现其实3中的数据已经在2.3中将数据封装好，3只是从封装好的数据中取出相应的数据而已，2.3是同步执行过程，那么，下一次2.1执行时，一定是在上一次2.3执行完成之后！</p>\n<p>但是，经测试，这儿确实是有问题的，<br>于是，再次分析：<br>2.1进行数据转换时，通过源码分析，我们得出，此处只是将数据的值一个一个的set到业务上下文的数据对象中，那么意味着什么？  业务上下午serviceContext是一个全局对象，进入执行逻辑前已经初始化完成，那么，其内存已经开辟完成，意味着该对象中数据对象的内存也已开辟完成。那么，set值只是为那一块内存进行了赋值操作<br>2.3通过getEntityObject将数据赋给新的对象I，那么，此时I和业务上下午中的数据对象都是指向同一块内存区域<br>3/2.1 此时3和下一个2.1并行执行，3中获取数据对象的值，而1.2给上下文数据对象赋予新的值， 那么，3是从这块内存区域取值，1.2是给这块内存区域赋值，一旦1.2执行在前，那么3拿到的当然是重新赋予的值。</p>\n<p>通过上述分析，我们知道了问题根源，那么，如何改造？<br>很简单<br>修改2.1的代码为<br><img src=\"\\images\\pasted-40.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-41.png\" alt=\"upload successful\"><br>很显然，同样是给业务上下午数据对象赋值，与上面的方案区别在于，此处是将上下午数据对象指向的新的内存地址。<br>那么执行2.3时，通过getEntityObject将数据赋给新的对象I，其所指向的内存地址也是这块新的地址<br>执行3/2.1时，3依旧从这块内存地址取值，而2.1则是将上下午数据对象指向另一块内存地址，毫不冲突，更谈不上数据篡改。</p>\n<p>下面图示的方式给与说明：<br><img src=\"\\images\\pasted-42.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":1292,"excerpt":"","more":"<p>关于java对象的使用，java编码的一个基本能力，但事实上，业务开发中，往往会有疏忽，下面从易极付支付引擎一个bug再次剖析java对象的使用。</p>\n<p>业务场景：支付引擎转账-定时任务批量加载挂起的数据执行转账并异步回执<br>                1、批量查询挂起的转账数据，list<br>                2、循环遍历list执行转换并回执<br>                    2.1、将数据转换到业务上下文中<br>                    2.2、执行转账（数据从业务上下文中获取）<br>                    2.3、发布转账回执事件（数据从业务上下文中获取）<br>                 3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）</p>\n<p>上述是简化后的业务流程，下面加以核心代码说明支付引擎的实现逻辑<br>                1、批量查询挂起的转账数据，list </p>\n<p><img src=\"\\images\\pasted-24.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-25.png\" alt=\"upload successful\"><br> 2、循环遍历list执行转换并回执<br>     2.1、将数据转换到业务上下文中</p>\n<p><img src=\"\\images\\pasted-26.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-27.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-28.png\" alt=\"upload successful\"><br>这儿调用的是易极付common-util中提供的对象转换方法，源码如下：</p>\n<p><img src=\"\\images\\pasted-30.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-31.png\" alt=\"upload successful\"></p>\n<p> 2.2、执行转账（数据从业务上下文中获取）<br><img src=\"\\images\\pasted-32.png\" alt=\"upload successful\"></p>\n<p>2.3、发布转账回执事件（数据从业务上下文中获取）<br><img src=\"\\images\\pasted-33.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-34.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-35.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-36.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-37.png\" alt=\"upload successful\"></p>\n<p>3、在新线程中异步回执（订阅到2.3发布的回执事件后与2并行执行）<br><img src=\"\\images\\pasted-38.png\" alt=\"upload successful\"></p>\n<p>上述逻辑，经过实际测试，存在严重问题，问题如下：<br>异步回执时，拿到的数据并不是实际预期的数据，而被篡改了，可以看见的是，执行异步回执时，拿到了list循环遍历后续的数据。</p>\n<p>分析问题，很明显，我们看到了2.1这么一行代码：<br><img src=\"\\images\\pasted-39.png\" alt=\"upload successful\"><br>那么，当前2.2转账完成后，发出2.3异步回执事件，3执行回执是异步的（并行的），此时下一次循环完全可能已经再次执行了2.1这行代码，那么就有问题！！！  为什么？</p>\n<p>上述判断只是初次分析，但经过进一步分析，我们发现其实3中的数据已经在2.3中将数据封装好，3只是从封装好的数据中取出相应的数据而已，2.3是同步执行过程，那么，下一次2.1执行时，一定是在上一次2.3执行完成之后！</p>\n<p>但是，经测试，这儿确实是有问题的，<br>于是，再次分析：<br>2.1进行数据转换时，通过源码分析，我们得出，此处只是将数据的值一个一个的set到业务上下文的数据对象中，那么意味着什么？  业务上下午serviceContext是一个全局对象，进入执行逻辑前已经初始化完成，那么，其内存已经开辟完成，意味着该对象中数据对象的内存也已开辟完成。那么，set值只是为那一块内存进行了赋值操作<br>2.3通过getEntityObject将数据赋给新的对象I，那么，此时I和业务上下午中的数据对象都是指向同一块内存区域<br>3/2.1 此时3和下一个2.1并行执行，3中获取数据对象的值，而1.2给上下文数据对象赋予新的值， 那么，3是从这块内存区域取值，1.2是给这块内存区域赋值，一旦1.2执行在前，那么3拿到的当然是重新赋予的值。</p>\n<p>通过上述分析，我们知道了问题根源，那么，如何改造？<br>很简单<br>修改2.1的代码为<br><img src=\"\\images\\pasted-40.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-41.png\" alt=\"upload successful\"><br>很显然，同样是给业务上下午数据对象赋值，与上面的方案区别在于，此处是将上下午数据对象指向的新的内存地址。<br>那么执行2.3时，通过getEntityObject将数据赋给新的对象I，其所指向的内存地址也是这块新的地址<br>执行3/2.1时，3依旧从这块内存地址取值，而2.1则是将上下午数据对象指向另一块内存地址，毫不冲突，更谈不上数据篡改。</p>\n<p>下面图示的方式给与说明：<br><img src=\"\\images\\pasted-42.png\" alt=\"upload successful\"></p>\n"},{"title":"jdk8-dump异常","author":"Xiang Chuang","date":"2018-09-10T02:36:00.000Z","_content":"![upload successful](\\images\\pasted-1.png)\n易极付代扣应用疑似存在内存泄漏，因此，尝试进行dump分析，后发现dump一直失败，报错如上，dump命令为：\n jmap -F -dump:format=b,file=盘符:/XXX.hprof <pid>\n\n原因分析：\nhttps://bugs.java.com/view_bug.do?bug_id=8044416\n\n\n\n解决方案： \n1、jmap -dump:format=b,file=盘符:/XXX.hprof <pid>，同时应用启动时，jvm参数-XX:+StartAttachListener\n    use flag -XX:+StartAttachListener in target java process and make sure you run jmap within the same user as main java process\n\n2、升级jdk版本到1.8.0_60以上8u60(Fixed)9b64(Fixed) ","source":"_posts/jdk8-dump异常.md","raw":"title: jdk8-dump异常\nauthor: Xiang Chuang\ntags:\n  - java\n  - jdk8\n  - dump\ncategories:\n  - 这些年，那些坑\ndate: 2018-09-10 10:36:00\n---\n![upload successful](\\images\\pasted-1.png)\n易极付代扣应用疑似存在内存泄漏，因此，尝试进行dump分析，后发现dump一直失败，报错如上，dump命令为：\n jmap -F -dump:format=b,file=盘符:/XXX.hprof <pid>\n\n原因分析：\nhttps://bugs.java.com/view_bug.do?bug_id=8044416\n\n\n\n解决方案： \n1、jmap -dump:format=b,file=盘符:/XXX.hprof <pid>，同时应用启动时，jvm参数-XX:+StartAttachListener\n    use flag -XX:+StartAttachListener in target java process and make sure you run jmap within the same user as main java process\n\n2、升级jdk版本到1.8.0_60以上8u60(Fixed)9b64(Fixed) ","slug":"jdk8-dump异常","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbo001kwy669ja09riq","content":"<p><img src=\"\\images\\pasted-1.png\" alt=\"upload successful\"><br>易极付代扣应用疑似存在内存泄漏，因此，尝试进行dump分析，后发现dump一直失败，报错如上，dump命令为：<br> jmap -F -dump:format=b,file=盘符:/XXX.hprof <pid></p>\n<p>原因分析：<br><a href=\"https://bugs.java.com/view_bug.do?bug_id=8044416\">https://bugs.java.com/view_bug.do?bug_id=8044416</a></p>\n<p>解决方案：<br>1、jmap -dump:format=b,file=盘符:/XXX.hprof <pid>，同时应用启动时，jvm参数-XX:+StartAttachListener<br>    use flag -XX:+StartAttachListener in target java process and make sure you run jmap within the same user as main java process</p>\n<p>2、升级jdk版本到1.8.0_60以上8u60(Fixed)9b64(Fixed) </p>\n","site":{"data":{}},"length":376,"excerpt":"","more":"<p><img src=\"\\images\\pasted-1.png\" alt=\"upload successful\"><br>易极付代扣应用疑似存在内存泄漏，因此，尝试进行dump分析，后发现dump一直失败，报错如上，dump命令为：<br> jmap -F -dump:format=b,file=盘符:/XXX.hprof <pid></p>\n<p>原因分析：<br><a href=\"https://bugs.java.com/view_bug.do?bug_id=8044416\">https://bugs.java.com/view_bug.do?bug_id=8044416</a></p>\n<p>解决方案：<br>1、jmap -dump:format=b,file=盘符:/XXX.hprof <pid>，同时应用启动时，jvm参数-XX:+StartAttachListener<br>    use flag -XX:+StartAttachListener in target java process and make sure you run jmap within the same user as main java process</p>\n<p>2、升级jdk版本到1.8.0_60以上8u60(Fixed)9b64(Fixed) </p>\n"},{"title":"linux-tail命令不生效","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"tail: option used in invalid context -- 1\n\n遇到此类命令使用不合法的警告时，可以which tail或者whereis tail 看看命令是否被使用了别名","source":"_posts/linux-tail命令不生效.md","raw":"title: linux-tail命令不生效\nauthor: Xiang Chuang\ntags:\n  - linux\n  - tail\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\ntail: option used in invalid context -- 1\n\n遇到此类命令使用不合法的警告时，可以which tail或者whereis tail 看看命令是否被使用了别名","slug":"linux-tail命令不生效","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbp001owy66hpg1hz01","content":"<p>tail: option used in invalid context – 1</p>\n<p>遇到此类命令使用不合法的警告时，可以which tail或者whereis tail 看看命令是否被使用了别名</p>\n","site":{"data":{}},"length":85,"excerpt":"","more":"<p>tail: option used in invalid context – 1</p>\n<p>遇到此类命令使用不合法的警告时，可以which tail或者whereis tail 看看命令是否被使用了别名</p>\n"},{"title":"maven-Failed to execute goal org.apache.maven.plugins:maven-enforcer-plugin:","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"maven带的强制或者自定义得强制，导致打包不过。\n\ninfo：\n\nutil:jar:2.2.20150520\nFound Banned Dependency: org.slf4j:slf4j-log4j12:jar:1.7.10\nUse 'mvn dependency:tree' to locate the source of the banned dependencies.\n\n\n禁止依赖org.slf4j:slf4j-log4j12:jar，因此打包不过，需要排除依赖","source":"_posts/maven-Failed-to-execute-goal-org-apache-maven-plugins-maven-enforcer-plugin.md","raw":"title: 'maven-Failed to execute goal org.apache.maven.plugins:maven-enforcer-plugin:'\nauthor: Xiang Chuang\ntags:\n  - maven\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\nmaven带的强制或者自定义得强制，导致打包不过。\n\ninfo：\n\nutil:jar:2.2.20150520\nFound Banned Dependency: org.slf4j:slf4j-log4j12:jar:1.7.10\nUse 'mvn dependency:tree' to locate the source of the banned dependencies.\n\n\n禁止依赖org.slf4j:slf4j-log4j12:jar，因此打包不过，需要排除依赖","slug":"maven-Failed-to-execute-goal-org-apache-maven-plugins-maven-enforcer-plugin","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbq001rwy66c1vq5wjg","content":"<p>maven带的强制或者自定义得强制，导致打包不过。</p>\n<p>info：</p>\n<p>util:jar:2.2.20150520<br>Found Banned Dependency: org.slf4j:slf4j-log4j12:jar:1.7.10<br>Use ‘mvn dependency:tree’ to locate the source of the banned dependencies.</p>\n<p>禁止依赖org.slf4j:slf4j-log4j12:jar，因此打包不过，需要排除依赖</p>\n","site":{"data":{}},"length":216,"excerpt":"","more":"<p>maven带的强制或者自定义得强制，导致打包不过。</p>\n<p>info：</p>\n<p>util:jar:2.2.20150520<br>Found Banned Dependency: org.slf4j:slf4j-log4j12:jar:1.7.10<br>Use ‘mvn dependency:tree’ to locate the source of the banned dependencies.</p>\n<p>禁止依赖org.slf4j:slf4j-log4j12:jar，因此打包不过，需要排除依赖</p>\n"},{"title":"maven-No plugin found for prefix 'tomcat7'","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"没有tomcat7插件\n解决：在parent中\n\n <plugin>\n         <groupId>org.apache.tomcat.maven</groupId>\n         <artifactId>tomcat7-maven-plugin</artifactId>\n         <version>2.2</version>\n         <configuration>\n             <port>8091</port>\n             <uriEncoding>UTF-8</uriEncoding>\n             <path>/</path>\n         </configuration>\n       </plugin>","source":"_posts/maven-No-plugin-found-for-prefix-tomcat7.md","raw":"title: maven-No plugin found for prefix 'tomcat7'\nauthor: Xiang Chuang\ntags:\n  - maven\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\n没有tomcat7插件\n解决：在parent中\n\n <plugin>\n         <groupId>org.apache.tomcat.maven</groupId>\n         <artifactId>tomcat7-maven-plugin</artifactId>\n         <version>2.2</version>\n         <configuration>\n             <port>8091</port>\n             <uriEncoding>UTF-8</uriEncoding>\n             <path>/</path>\n         </configuration>\n       </plugin>","slug":"maven-No-plugin-found-for-prefix-tomcat7","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbr001vwy666z7k95kz","content":"<p>没有tomcat7插件<br>解决：在parent中</p>\n <plugin><br>         <groupId>org.apache.tomcat.maven</groupId><br>         <artifactId>tomcat7-maven-plugin</artifactId><br>         <version>2.2</version><br>         <configuration><br>             <port>8091</port><br>             <uriEncoding>UTF-8</uriEncoding><br>             <path>/</path><br>         </configuration><br>       </plugin>","site":{"data":{}},"length":78,"excerpt":"","more":"<p>没有tomcat7插件<br>解决：在parent中</p>\n <plugin><br>         <groupId>org.apache.tomcat.maven</groupId><br>         <artifactId>tomcat7-maven-plugin</artifactId><br>         <version>2.2</version><br>         <configuration><br>             <port>8091</port><br>             <uriEncoding>UTF-8</uriEncoding><br>             <path>/</path><br>         </configuration><br>       </plugin>"},{"title":"maven-Plugin execution not covered by lifecycle configuration","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"description:Project build lifecycle mapping can be configured in a project’s pom.xml, contributed by Eclipse plugins, or defaulted to the commonly used Maven plugins shipped with m2e. We call these “lifecycle mapping metadata sources”. m2e will create error marker like below for all plugin executions that do not have lifecycle mapping in any of the mapping metadata sources.\n\nM2Eclipse matches plugin executions to actions using combination of plugin groupId, artifactId, version range and goal. There are three basic actions that M2Eclipse can be instructed to do with a plugin execution – ignore, execute and delegate to a project configurator(recommended).","source":"_posts/maven-Plugin-execution-not-covered-by-lifecycle-configuration.md","raw":"title: maven-Plugin execution not covered by lifecycle configuration\nauthor: Xiang Chuang\ntags:\n  - maven\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\ndescription:Project build lifecycle mapping can be configured in a project’s pom.xml, contributed by Eclipse plugins, or defaulted to the commonly used Maven plugins shipped with m2e. We call these “lifecycle mapping metadata sources”. m2e will create error marker like below for all plugin executions that do not have lifecycle mapping in any of the mapping metadata sources.\n\nM2Eclipse matches plugin executions to actions using combination of plugin groupId, artifactId, version range and goal. There are three basic actions that M2Eclipse can be instructed to do with a plugin execution – ignore, execute and delegate to a project configurator(recommended).","slug":"maven-Plugin-execution-not-covered-by-lifecycle-configuration","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbr001xwy660vt7hyl8","content":"<p>description:Project build lifecycle mapping can be configured in a project’s pom.xml, contributed by Eclipse plugins, or defaulted to the commonly used Maven plugins shipped with m2e. We call these “lifecycle mapping metadata sources”. m2e will create error marker like below for all plugin executions that do not have lifecycle mapping in any of the mapping metadata sources.</p>\n<p>M2Eclipse matches plugin executions to actions using combination of plugin groupId, artifactId, version range and goal. There are three basic actions that M2Eclipse can be instructed to do with a plugin execution – ignore, execute and delegate to a project configurator(recommended).</p>\n","site":{"data":{}},"length":563,"excerpt":"","more":"<p>description:Project build lifecycle mapping can be configured in a project’s pom.xml, contributed by Eclipse plugins, or defaulted to the commonly used Maven plugins shipped with m2e. We call these “lifecycle mapping metadata sources”. m2e will create error marker like below for all plugin executions that do not have lifecycle mapping in any of the mapping metadata sources.</p>\n<p>M2Eclipse matches plugin executions to actions using combination of plugin groupId, artifactId, version range and goal. There are three basic actions that M2Eclipse can be instructed to do with a plugin execution – ignore, execute and delegate to a project configurator(recommended).</p>\n"},{"title":"maven-默认jdk版本","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"修改maven默认的jdk版本，想改彻底需要在maven的全局配文件（settings.xml）增加以下信息：\n\n在profiles 节点下增加：\n\n![upload successful](\\images\\pasted-55.png)\n<profile>\n    <id>jdk-1.6</id>\n    <activation>\n        <activeByDefault>true</activeByDefault>\n        <jdk>1.6</jdk>\n    </activation>\n    <properties>\n        <maven.compiler.source>1.6</maven.compiler.source>\n        <maven.compiler.target>1.6</maven.compiler.target>\n        <maven.compiler.compilerVersion>1.6</maven.compiler.compilerVersion>\n    </properties>\n</profile> ","source":"_posts/maven-默认jdk版本.md","raw":"title: maven-默认jdk版本\nauthor: Xiang Chuang\ntags:\n  - maven\n  - jdk\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\n修改maven默认的jdk版本，想改彻底需要在maven的全局配文件（settings.xml）增加以下信息：\n\n在profiles 节点下增加：\n\n![upload successful](\\images\\pasted-55.png)\n<profile>\n    <id>jdk-1.6</id>\n    <activation>\n        <activeByDefault>true</activeByDefault>\n        <jdk>1.6</jdk>\n    </activation>\n    <properties>\n        <maven.compiler.source>1.6</maven.compiler.source>\n        <maven.compiler.target>1.6</maven.compiler.target>\n        <maven.compiler.compilerVersion>1.6</maven.compiler.compilerVersion>\n    </properties>\n</profile> ","slug":"maven-默认jdk版本","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbs0020wy665zzr9grz","content":"<p>修改maven默认的jdk版本，想改彻底需要在maven的全局配文件（settings.xml）增加以下信息：</p>\n<p>在profiles 节点下增加：</p>\n<p><img src=\"\\images\\pasted-55.png\" alt=\"upload successful\"></p>\n<profile><br>    <id>jdk-1.6</id><br>    <activation><br>        <activeByDefault>true</activeByDefault><br>        <jdk>1.6</jdk><br>    </activation><br>    <properties><br>        &lt;maven.compiler.source&gt;1.6&lt;/maven.compiler.source&gt;<br>        &lt;maven.compiler.target&gt;1.6&lt;/maven.compiler.target&gt;<br>        &lt;maven.compiler.compilerVersion&gt;1.6&lt;/maven.compiler.compilerVersion&gt;<br>    </properties><br></profile> ","site":{"data":{}},"length":288,"excerpt":"","more":"<p>修改maven默认的jdk版本，想改彻底需要在maven的全局配文件（settings.xml）增加以下信息：</p>\n<p>在profiles 节点下增加：</p>\n<p><img src=\"\\images\\pasted-55.png\" alt=\"upload successful\"></p>\n<profile><br>    <id>jdk-1.6</id><br>    <activation><br>        <activeByDefault>true</activeByDefault><br>        <jdk>1.6</jdk><br>    </activation><br>    <properties><br>        &lt;maven.compiler.source&gt;1.6&lt;/maven.compiler.source&gt;<br>        &lt;maven.compiler.target&gt;1.6&lt;/maven.compiler.target&gt;<br>        &lt;maven.compiler.compilerVersion&gt;1.6&lt;/maven.compiler.compilerVersion&gt;<br>    </properties><br></profile> "},{"title":"mongo-查询报no property found on","author":"Xiang Chuang","date":"2018-12-07T07:11:00.000Z","_content":"No property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!\n\n现象：线上和本地都没问题，同样的应用同样的数据，就测试环境有问题\n\n\n如果有自定义转换器走这，没得 就会默认\n\n![upload successful](\\images\\pasted-6.png)\n\n![upload successful](\\images\\pasted-7.png)\n加载构造函数，这里是通过java8新特性，直接获取到了构造函数的入参名称，然后以此为key获取mongo集合对应的值\n![upload successful](\\images\\pasted-8.png)\n\n![upload successful](\\images\\pasted-9.png)\n\n![upload successful](\\images\\pasted-10.png)\n\n![upload successful](\\images\\pasted-11.png)\n根据构造函数的入参获取mongo查出来的值，问题出在constructor.getParameters()获取入参时候， 取得了一个null\n\n![upload successful](\\images\\pasted-12.png)\n\nNo property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!\n\n问题在于：\n测试环境apm启动时，使用了javaagent代理，代理本身就是apm的，里面也有com.yiji.dtrace.core.SpanId，因此出现了冲突！！！！！\n\njava8通过以下类提供了反射获取方法参数名成的能力\n\n![upload successful](\\images\\pasted-14.png)\n\n![upload successful](\\images\\pasted-15.png)","source":"_posts/mongo-查询报no-property-found-on.md","raw":"title: mongo-查询报no property found on\nauthor: Xiang Chuang\ntags:\n  - db\n  - mongo\ncategories:\n  - 这些年，那些坑\ndate: 2018-12-07 15:11:00\n---\nNo property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!\n\n现象：线上和本地都没问题，同样的应用同样的数据，就测试环境有问题\n\n\n如果有自定义转换器走这，没得 就会默认\n\n![upload successful](\\images\\pasted-6.png)\n\n![upload successful](\\images\\pasted-7.png)\n加载构造函数，这里是通过java8新特性，直接获取到了构造函数的入参名称，然后以此为key获取mongo集合对应的值\n![upload successful](\\images\\pasted-8.png)\n\n![upload successful](\\images\\pasted-9.png)\n\n![upload successful](\\images\\pasted-10.png)\n\n![upload successful](\\images\\pasted-11.png)\n根据构造函数的入参获取mongo查出来的值，问题出在constructor.getParameters()获取入参时候， 取得了一个null\n\n![upload successful](\\images\\pasted-12.png)\n\nNo property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!\n\n问题在于：\n测试环境apm启动时，使用了javaagent代理，代理本身就是apm的，里面也有com.yiji.dtrace.core.SpanId，因此出现了冲突！！！！！\n\njava8通过以下类提供了反射获取方法参数名成的能力\n\n![upload successful](\\images\\pasted-14.png)\n\n![upload successful](\\images\\pasted-15.png)","slug":"mongo-查询报no-property-found-on","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbt0022wy66g3tdb61x","content":"<p>No property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!</p>\n<p>现象：线上和本地都没问题，同样的应用同样的数据，就测试环境有问题</p>\n<p>如果有自定义转换器走这，没得 就会默认</p>\n<p><img src=\"\\images\\pasted-6.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-7.png\" alt=\"upload successful\"><br>加载构造函数，这里是通过java8新特性，直接获取到了构造函数的入参名称，然后以此为key获取mongo集合对应的值<br><img src=\"\\images\\pasted-8.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-9.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-10.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-11.png\" alt=\"upload successful\"><br>根据构造函数的入参获取mongo查出来的值，问题出在constructor.getParameters()获取入参时候， 取得了一个null</p>\n<p><img src=\"\\images\\pasted-12.png\" alt=\"upload successful\"></p>\n<p>No property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!</p>\n<p>问题在于：<br>测试环境apm启动时，使用了javaagent代理，代理本身就是apm的，里面也有com.yiji.dtrace.core.SpanId，因此出现了冲突！！！！！</p>\n<p>java8通过以下类提供了反射获取方法参数名成的能力</p>\n<p><img src=\"\\images\\pasted-14.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-15.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":455,"excerpt":"","more":"<p>No property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!</p>\n<p>现象：线上和本地都没问题，同样的应用同样的数据，就测试环境有问题</p>\n<p>如果有自定义转换器走这，没得 就会默认</p>\n<p><img src=\"\\images\\pasted-6.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-7.png\" alt=\"upload successful\"><br>加载构造函数，这里是通过java8新特性，直接获取到了构造函数的入参名称，然后以此为key获取mongo集合对应的值<br><img src=\"\\images\\pasted-8.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-9.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-10.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-11.png\" alt=\"upload successful\"><br>根据构造函数的入参获取mongo查出来的值，问题出在constructor.getParameters()获取入参时候， 取得了一个null</p>\n<p><img src=\"\\images\\pasted-12.png\" alt=\"upload successful\"></p>\n<p>No property null found on entity com.yiji.dtrace.core.SpanId to bind constructor parameter to!</p>\n<p>问题在于：<br>测试环境apm启动时，使用了javaagent代理，代理本身就是apm的，里面也有com.yiji.dtrace.core.SpanId，因此出现了冲突！！！！！</p>\n<p>java8通过以下类提供了反射获取方法参数名成的能力</p>\n<p><img src=\"\\images\\pasted-14.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-15.png\" alt=\"upload successful\"></p>\n"},{"title":"mysql -TIMESTAMP","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"The TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of '1970-01-01 00:00:01' UTC to '2038-01-19 03:14:07' UTCThe TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of '1970-01-01 00:00:01' UTC to '2038-01-19 03:14:07' UTC\n\n\nUTC+8: 2038-01-19 11:14:07","source":"_posts/mysql-TIMESTAMP.md","raw":"title: mysql -TIMESTAMP\nauthor: Xiang Chuang\ntags:\n  - mysql\n  - db\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\nThe TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of '1970-01-01 00:00:01' UTC to '2038-01-19 03:14:07' UTCThe TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of '1970-01-01 00:00:01' UTC to '2038-01-19 03:14:07' UTC\n\n\nUTC+8: 2038-01-19 11:14:07","slug":"mysql-TIMESTAMP","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbu0026wy66asjwh3gv","content":"<p>The TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of ‘1970-01-01 00:00:01’ UTC to ‘2038-01-19 03:14:07’ UTCThe TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of ‘1970-01-01 00:00:01’ UTC to ‘2038-01-19 03:14:07’ UTC</p>\n<p>UTC+8: 2038-01-19 11:14:07</p>\n","site":{"data":{}},"length":294,"excerpt":"","more":"<p>The TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of ‘1970-01-01 00:00:01’ UTC to ‘2038-01-19 03:14:07’ UTCThe TIMESTAMP data type is used for values that contain both date and time parts. TIMESTAMP has a range of ‘1970-01-01 00:00:01’ UTC to ‘2038-01-19 03:14:07’ UTC</p>\n<p>UTC+8: 2038-01-19 11:14:07</p>\n"},{"title":"mysql数据库wait_timeout问题","author":"Xiang Chuang","date":"2019-07-11T06:59:00.000Z","_content":"背景：近日与猪方合作一项目，项目交付后，对方反馈测试环境老是出现数据库异常（下面给出堆栈日志），并且对方的其他应用没有问题。但交付前，此项目在我们的环境（代码、数据库等都是我们的）中测试并无问题。\n\n问题现象：\n```\nat java.lang.Thread.run(Thread.java:748)\nCaused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure\n\nThe last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag\no.\n        at sun.reflect.GeneratedConstructorAccessor47.newInstance(Unknown Source)\n        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n        at java.lang.reflect.Constructor.newInstance(Constructor.java:423)\n        at com.mysql.jdbc.Util.handleNewInstance(Util.java:404)\n        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:981)\n        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3465)\n        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3365)\n        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3805)\n        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2478)\n        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2625)\n        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2547)\n        at com.mysql.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:4874)\n        at com.alibaba.druid.pool.DruidPooledConnection.setAutoCommit(DruidPooledConnection.java:712)\n        at org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(DataSourceTransactionManager.java:225)\n        ... 45 common frames omitted\nCaused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.\n        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2957)\n        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3375)\n        ... 53 common frames omitted\n2019-07-11 13:41:00.311 [TxId:test_1562754979799^1562754982427^117,SpanId:2404734433174193776] [INFO ] c.z.c.p.b.a.i.w.WithdrawTransImpl:116 - 查询交易结\n束TradeQueryResult [sucAmount=0, transDate=null]\n2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:52 - realtime monitor request end, api server return message : LOOP\n2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:49 - realtime monitor request begin, url -> http://api.config.zhubajie\n.la/realtime/pull\n2019-07-11 13:44:00.415 [TxId:192.168.25.11.1015^1561538402946^21456,Span\n```\n看到这段日志，我注意到“Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag\no.”， 56397毫秒，这个数字很扎眼！！！ 因为我们使用的druid连接池，最小生存时间和需要关闭的空闲连接时间都是60s，说明了一个问题，所拿到的连接未超过60s，所以仍在连接池中，但是该连接貌似是失效了。分析到这儿，我猜测猪方mysql数据库的wait_timeout估计是进行了修改且小于56.397秒（默认是8小时，我们工时使用默认值），于是来到猪方的数据库，\n```\nshow global variables like '%timeout';\nconnect_timeout\t10\ndelayed_insert_timeout\t300\nhave_statement_timeout\tYES\ninnodb_flush_log_at_timeout\t1\ninnodb_lock_wait_timeout\t120\ninnodb_rollback_on_timeout\tOFF\ninteractive_timeout\t30\nlock_wait_timeout\t31536000\nnet_read_timeout\t5\nnet_write_timeout\t5\nrpl_semi_sync_master_timeout\t10000\nrpl_stop_slave_timeout\t31536000\nslave_net_timeout\t60\nthread_pool_idle_timeout\t60\ntokudb_last_lock_timeout\t\ntokudb_lock_timeout\t4000\nwait_timeout\t30\n```\n好吧，猜想正确，他们讲wait_timeout设置成了30s。\n\n同时他们自己的连接池配置是\n```\n dataSource.setTimeBetweenEvictionRunsMillis(5000);\n dataSource.setMinEvictableIdleTimeMillis(30000);\n```\n而我们的连接池配置是\n```\n dataSource.setTimeBetweenEvictionRunsMillis(60000);\n dataSource.setMinEvictableIdleTimeMillis(60000);\n```\n\n问题解决！！！\n\n关于wait_timeout，这个参数到底要不要重新设置值没有固定的标准，保障数据库的可用性和性能即可，但应用层必须根据wait_timeout的实际情况进行相应的配置：\n1、最大空闲时间不能大于wait_timeout\n2、可以尝试在数据库连接中增加autoReconnect=true\n3、testWhileIdle=\"true\" timeBetweenEvictionRunsMillis=\"10000\" validationQuery=\"select 1\"\n\n猪方连接池：\n![upload successful](\\images\\pasted-92.png)\n我方连接池：\n\n![upload successful](\\images\\pasted-94.png)","source":"_posts/mysql数据库wait-timeout问题.md","raw":"title: mysql数据库wait_timeout问题\nauthor: Xiang Chuang\ntags:\n  - mysql\n  - 连接池\ncategories:\n  - 这些年，那些坑\ndate: 2019-07-11 14:59:00\n---\n背景：近日与猪方合作一项目，项目交付后，对方反馈测试环境老是出现数据库异常（下面给出堆栈日志），并且对方的其他应用没有问题。但交付前，此项目在我们的环境（代码、数据库等都是我们的）中测试并无问题。\n\n问题现象：\n```\nat java.lang.Thread.run(Thread.java:748)\nCaused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure\n\nThe last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag\no.\n        at sun.reflect.GeneratedConstructorAccessor47.newInstance(Unknown Source)\n        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n        at java.lang.reflect.Constructor.newInstance(Constructor.java:423)\n        at com.mysql.jdbc.Util.handleNewInstance(Util.java:404)\n        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:981)\n        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3465)\n        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3365)\n        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3805)\n        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2478)\n        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2625)\n        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2547)\n        at com.mysql.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:4874)\n        at com.alibaba.druid.pool.DruidPooledConnection.setAutoCommit(DruidPooledConnection.java:712)\n        at org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(DataSourceTransactionManager.java:225)\n        ... 45 common frames omitted\nCaused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.\n        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2957)\n        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3375)\n        ... 53 common frames omitted\n2019-07-11 13:41:00.311 [TxId:test_1562754979799^1562754982427^117,SpanId:2404734433174193776] [INFO ] c.z.c.p.b.a.i.w.WithdrawTransImpl:116 - 查询交易结\n束TradeQueryResult [sucAmount=0, transDate=null]\n2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:52 - realtime monitor request end, api server return message : LOOP\n2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:49 - realtime monitor request begin, url -> http://api.config.zhubajie\n.la/realtime/pull\n2019-07-11 13:44:00.415 [TxId:192.168.25.11.1015^1561538402946^21456,Span\n```\n看到这段日志，我注意到“Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag\no.”， 56397毫秒，这个数字很扎眼！！！ 因为我们使用的druid连接池，最小生存时间和需要关闭的空闲连接时间都是60s，说明了一个问题，所拿到的连接未超过60s，所以仍在连接池中，但是该连接貌似是失效了。分析到这儿，我猜测猪方mysql数据库的wait_timeout估计是进行了修改且小于56.397秒（默认是8小时，我们工时使用默认值），于是来到猪方的数据库，\n```\nshow global variables like '%timeout';\nconnect_timeout\t10\ndelayed_insert_timeout\t300\nhave_statement_timeout\tYES\ninnodb_flush_log_at_timeout\t1\ninnodb_lock_wait_timeout\t120\ninnodb_rollback_on_timeout\tOFF\ninteractive_timeout\t30\nlock_wait_timeout\t31536000\nnet_read_timeout\t5\nnet_write_timeout\t5\nrpl_semi_sync_master_timeout\t10000\nrpl_stop_slave_timeout\t31536000\nslave_net_timeout\t60\nthread_pool_idle_timeout\t60\ntokudb_last_lock_timeout\t\ntokudb_lock_timeout\t4000\nwait_timeout\t30\n```\n好吧，猜想正确，他们讲wait_timeout设置成了30s。\n\n同时他们自己的连接池配置是\n```\n dataSource.setTimeBetweenEvictionRunsMillis(5000);\n dataSource.setMinEvictableIdleTimeMillis(30000);\n```\n而我们的连接池配置是\n```\n dataSource.setTimeBetweenEvictionRunsMillis(60000);\n dataSource.setMinEvictableIdleTimeMillis(60000);\n```\n\n问题解决！！！\n\n关于wait_timeout，这个参数到底要不要重新设置值没有固定的标准，保障数据库的可用性和性能即可，但应用层必须根据wait_timeout的实际情况进行相应的配置：\n1、最大空闲时间不能大于wait_timeout\n2、可以尝试在数据库连接中增加autoReconnect=true\n3、testWhileIdle=\"true\" timeBetweenEvictionRunsMillis=\"10000\" validationQuery=\"select 1\"\n\n猪方连接池：\n![upload successful](\\images\\pasted-92.png)\n我方连接池：\n\n![upload successful](\\images\\pasted-94.png)","slug":"mysql数据库wait-timeout问题","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbu0029wy66g7li159i","content":"<p>背景：近日与猪方合作一项目，项目交付后，对方反馈测试环境老是出现数据库异常（下面给出堆栈日志），并且对方的其他应用没有问题。但交付前，此项目在我们的环境（代码、数据库等都是我们的）中测试并无问题。</p>\n<p>问题现象：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">at java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\">Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure</span><br><span class=\"line\"></span><br><span class=\"line\">The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag</span><br><span class=\"line\">o.</span><br><span class=\"line\">        at sun.reflect.GeneratedConstructorAccessor47.newInstance(Unknown Source)</span><br><span class=\"line\">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class=\"line\">        at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class=\"line\">        at com.mysql.jdbc.Util.handleNewInstance(Util.java:404)</span><br><span class=\"line\">        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:981)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3465)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3365)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3805)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2478)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2625)</span><br><span class=\"line\">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2547)</span><br><span class=\"line\">        at com.mysql.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:4874)</span><br><span class=\"line\">        at com.alibaba.druid.pool.DruidPooledConnection.setAutoCommit(DruidPooledConnection.java:712)</span><br><span class=\"line\">        at org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(DataSourceTransactionManager.java:225)</span><br><span class=\"line\">        ... 45 common frames omitted</span><br><span class=\"line\">Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2957)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3375)</span><br><span class=\"line\">        ... 53 common frames omitted</span><br><span class=\"line\">2019-07-11 13:41:00.311 [TxId:test_1562754979799^1562754982427^117,SpanId:2404734433174193776] [INFO ] c.z.c.p.b.a.i.w.WithdrawTransImpl:116 - 查询交易结</span><br><span class=\"line\">束TradeQueryResult [sucAmount=0, transDate=null]</span><br><span class=\"line\">2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:52 - realtime monitor request end, api server return message : LOOP</span><br><span class=\"line\">2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:49 - realtime monitor request begin, url -&gt; http://api.config.zhubajie</span><br><span class=\"line\">.la/realtime/pull</span><br><span class=\"line\">2019-07-11 13:44:00.415 [TxId:192.168.25.11.1015^1561538402946^21456,Span</span><br></pre></td></tr></table></figure><br>看到这段日志，我注意到“Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag<br>o.”， 56397毫秒，这个数字很扎眼！！！ 因为我们使用的druid连接池，最小生存时间和需要关闭的空闲连接时间都是60s，说明了一个问题，所拿到的连接未超过60s，所以仍在连接池中，但是该连接貌似是失效了。分析到这儿，我猜测猪方mysql数据库的wait_timeout估计是进行了修改且小于56.397秒（默认是8小时，我们工时使用默认值），于是来到猪方的数据库，<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show global variables like &#x27;%timeout&#x27;;</span><br><span class=\"line\">connect_timeout\t10</span><br><span class=\"line\">delayed_insert_timeout\t300</span><br><span class=\"line\">have_statement_timeout\tYES</span><br><span class=\"line\">innodb_flush_log_at_timeout\t1</span><br><span class=\"line\">innodb_lock_wait_timeout\t120</span><br><span class=\"line\">innodb_rollback_on_timeout\tOFF</span><br><span class=\"line\">interactive_timeout\t30</span><br><span class=\"line\">lock_wait_timeout\t31536000</span><br><span class=\"line\">net_read_timeout\t5</span><br><span class=\"line\">net_write_timeout\t5</span><br><span class=\"line\">rpl_semi_sync_master_timeout\t10000</span><br><span class=\"line\">rpl_stop_slave_timeout\t31536000</span><br><span class=\"line\">slave_net_timeout\t60</span><br><span class=\"line\">thread_pool_idle_timeout\t60</span><br><span class=\"line\">tokudb_last_lock_timeout\t</span><br><span class=\"line\">tokudb_lock_timeout\t4000</span><br><span class=\"line\">wait_timeout\t30</span><br></pre></td></tr></table></figure><br>好吧，猜想正确，他们讲wait_timeout设置成了30s。</p>\n<p>同时他们自己的连接池配置是<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dataSource.setTimeBetweenEvictionRunsMillis(5000);</span><br><span class=\"line\">dataSource.setMinEvictableIdleTimeMillis(30000);</span><br></pre></td></tr></table></figure><br>而我们的连接池配置是<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br><span class=\"line\">dataSource.setMinEvictableIdleTimeMillis(60000);</span><br></pre></td></tr></table></figure></p>\n<p>问题解决！！！</p>\n<p>关于wait_timeout，这个参数到底要不要重新设置值没有固定的标准，保障数据库的可用性和性能即可，但应用层必须根据wait_timeout的实际情况进行相应的配置：<br>1、最大空闲时间不能大于wait_timeout<br>2、可以尝试在数据库连接中增加autoReconnect=true<br>3、testWhileIdle=”true” timeBetweenEvictionRunsMillis=”10000” validationQuery=”select 1”</p>\n<p>猪方连接池：<br><img src=\"\\images\\pasted-92.png\" alt=\"upload successful\"><br>我方连接池：</p>\n<p><img src=\"\\images\\pasted-94.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":3645,"excerpt":"","more":"<p>背景：近日与猪方合作一项目，项目交付后，对方反馈测试环境老是出现数据库异常（下面给出堆栈日志），并且对方的其他应用没有问题。但交付前，此项目在我们的环境（代码、数据库等都是我们的）中测试并无问题。</p>\n<p>问题现象：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">at java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\">Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure</span><br><span class=\"line\"></span><br><span class=\"line\">The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag</span><br><span class=\"line\">o.</span><br><span class=\"line\">        at sun.reflect.GeneratedConstructorAccessor47.newInstance(Unknown Source)</span><br><span class=\"line\">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class=\"line\">        at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class=\"line\">        at com.mysql.jdbc.Util.handleNewInstance(Util.java:404)</span><br><span class=\"line\">        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:981)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3465)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3365)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3805)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2478)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2625)</span><br><span class=\"line\">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2547)</span><br><span class=\"line\">        at com.mysql.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:4874)</span><br><span class=\"line\">        at com.alibaba.druid.pool.DruidPooledConnection.setAutoCommit(DruidPooledConnection.java:712)</span><br><span class=\"line\">        at org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(DataSourceTransactionManager.java:225)</span><br><span class=\"line\">        ... 45 common frames omitted</span><br><span class=\"line\">Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2957)</span><br><span class=\"line\">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3375)</span><br><span class=\"line\">        ... 53 common frames omitted</span><br><span class=\"line\">2019-07-11 13:41:00.311 [TxId:test_1562754979799^1562754982427^117,SpanId:2404734433174193776] [INFO ] c.z.c.p.b.a.i.w.WithdrawTransImpl:116 - 查询交易结</span><br><span class=\"line\">束TradeQueryResult [sucAmount=0, transDate=null]</span><br><span class=\"line\">2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:52 - realtime monitor request end, api server return message : LOOP</span><br><span class=\"line\">2019-07-11 13:42:47.097 [TxId:,SpanId:] [INFO ] c.z.c.c.a.r.DefaultRealtimeMonitor:49 - realtime monitor request begin, url -&gt; http://api.config.zhubajie</span><br><span class=\"line\">.la/realtime/pull</span><br><span class=\"line\">2019-07-11 13:44:00.415 [TxId:192.168.25.11.1015^1561538402946^21456,Span</span><br></pre></td></tr></table></figure><br>看到这段日志，我注意到“Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet successfully received from the server was 56,397 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ag<br>o.”， 56397毫秒，这个数字很扎眼！！！ 因为我们使用的druid连接池，最小生存时间和需要关闭的空闲连接时间都是60s，说明了一个问题，所拿到的连接未超过60s，所以仍在连接池中，但是该连接貌似是失效了。分析到这儿，我猜测猪方mysql数据库的wait_timeout估计是进行了修改且小于56.397秒（默认是8小时，我们工时使用默认值），于是来到猪方的数据库，<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show global variables like &#x27;%timeout&#x27;;</span><br><span class=\"line\">connect_timeout\t10</span><br><span class=\"line\">delayed_insert_timeout\t300</span><br><span class=\"line\">have_statement_timeout\tYES</span><br><span class=\"line\">innodb_flush_log_at_timeout\t1</span><br><span class=\"line\">innodb_lock_wait_timeout\t120</span><br><span class=\"line\">innodb_rollback_on_timeout\tOFF</span><br><span class=\"line\">interactive_timeout\t30</span><br><span class=\"line\">lock_wait_timeout\t31536000</span><br><span class=\"line\">net_read_timeout\t5</span><br><span class=\"line\">net_write_timeout\t5</span><br><span class=\"line\">rpl_semi_sync_master_timeout\t10000</span><br><span class=\"line\">rpl_stop_slave_timeout\t31536000</span><br><span class=\"line\">slave_net_timeout\t60</span><br><span class=\"line\">thread_pool_idle_timeout\t60</span><br><span class=\"line\">tokudb_last_lock_timeout\t</span><br><span class=\"line\">tokudb_lock_timeout\t4000</span><br><span class=\"line\">wait_timeout\t30</span><br></pre></td></tr></table></figure><br>好吧，猜想正确，他们讲wait_timeout设置成了30s。</p>\n<p>同时他们自己的连接池配置是<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dataSource.setTimeBetweenEvictionRunsMillis(5000);</span><br><span class=\"line\">dataSource.setMinEvictableIdleTimeMillis(30000);</span><br></pre></td></tr></table></figure><br>而我们的连接池配置是<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br><span class=\"line\">dataSource.setMinEvictableIdleTimeMillis(60000);</span><br></pre></td></tr></table></figure></p>\n<p>问题解决！！！</p>\n<p>关于wait_timeout，这个参数到底要不要重新设置值没有固定的标准，保障数据库的可用性和性能即可，但应用层必须根据wait_timeout的实际情况进行相应的配置：<br>1、最大空闲时间不能大于wait_timeout<br>2、可以尝试在数据库连接中增加autoReconnect=true<br>3、testWhileIdle=”true” timeBetweenEvictionRunsMillis=”10000” validationQuery=”select 1”</p>\n<p>猪方连接池：<br><img src=\"\\images\\pasted-92.png\" alt=\"upload successful\"><br>我方连接池：</p>\n<p><img src=\"\\images\\pasted-94.png\" alt=\"upload successful\"></p>\n"},{"title":"rabbitmq-报not equivalent错","author":"Xiang Chuang","date":"2018-07-19T09:28:00.000Z","_content":"问题：\n支付引擎往monitor发送监控mq消息时，报错：\n2018-07-19 15:54:35.423 ERROR [AMQP Connection 10.21.30.153:5672] CachingConnectionFactory-- Channel shutdown: channel error; protocol method: #method<channel.close>(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue 'queue.monitor.logmsg' in vhost '/' not equivalent, class-id=50, method-id=10)\nCaused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method<channel.close>(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue 'queue.monitor.logmsg' in vhost '/' not equivalent, class-id=50, method-id=10)\n\n原因：\n支付引擎使用monitor客户端发送mq消息，由如下逻辑：\n![upload successful](\\images\\pasted-43.png)\n\n![upload successful](\\images\\pasted-44.png)\n\n![upload successful](\\images\\pasted-45.png)\n\n![upload successful](\\images\\pasted-46.png)\n问题出在：new Queue(XXX);\n我们来看看参数：true、false、false。  但是mq服务器上当前的队列是monitor系统通过spring集成创建的，参数为：\nfalse、false、true  同样的队列名，参数不一致，mq会报上述错误\n![upload successful](\\images\\pasted-47.png)\n\n![upload successful](\\images\\pasted-48.png)\n解决方案：\n合理的方案：保持参数一致\n临时方案：停止monitor，这是队列自动删除了，启动支付引擎，创建队列，再启动monitor，因为monitor是采用spring方式创建队列，不会尝试重新创建","source":"_posts/rabbitmq-报not-equivalent错.md","raw":"title: rabbitmq-报not equivalent错\nauthor: Xiang Chuang\ntags:\n  - rabbitmq\n  - 消息队列\ncategories:\n  - 这些年，那些坑\ndate: 2018-07-19 17:28:00\n---\n问题：\n支付引擎往monitor发送监控mq消息时，报错：\n2018-07-19 15:54:35.423 ERROR [AMQP Connection 10.21.30.153:5672] CachingConnectionFactory-- Channel shutdown: channel error; protocol method: #method<channel.close>(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue 'queue.monitor.logmsg' in vhost '/' not equivalent, class-id=50, method-id=10)\nCaused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method<channel.close>(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue 'queue.monitor.logmsg' in vhost '/' not equivalent, class-id=50, method-id=10)\n\n原因：\n支付引擎使用monitor客户端发送mq消息，由如下逻辑：\n![upload successful](\\images\\pasted-43.png)\n\n![upload successful](\\images\\pasted-44.png)\n\n![upload successful](\\images\\pasted-45.png)\n\n![upload successful](\\images\\pasted-46.png)\n问题出在：new Queue(XXX);\n我们来看看参数：true、false、false。  但是mq服务器上当前的队列是monitor系统通过spring集成创建的，参数为：\nfalse、false、true  同样的队列名，参数不一致，mq会报上述错误\n![upload successful](\\images\\pasted-47.png)\n\n![upload successful](\\images\\pasted-48.png)\n解决方案：\n合理的方案：保持参数一致\n临时方案：停止monitor，这是队列自动删除了，启动支付引擎，创建队列，再启动monitor，因为monitor是采用spring方式创建队列，不会尝试重新创建","slug":"rabbitmq-报not-equivalent错","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbv002dwy662kl38xcm","content":"<p>问题：<br>支付引擎往monitor发送监控mq消息时，报错：<br>2018-07-19 15:54:35.423 ERROR [AMQP Connection 10.21.30.153:5672] CachingConnectionFactory– Channel shutdown: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue ‘queue.monitor.logmsg’ in vhost ‘/‘ not equivalent, class-id=50, method-id=10)<br>Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue ‘queue.monitor.logmsg’ in vhost ‘/‘ not equivalent, class-id=50, method-id=10)</p>\n<p>原因：<br>支付引擎使用monitor客户端发送mq消息，由如下逻辑：<br><img src=\"\\images\\pasted-43.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-44.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-45.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-46.png\" alt=\"upload successful\"><br>问题出在：new Queue(XXX);<br>我们来看看参数：true、false、false。  但是mq服务器上当前的队列是monitor系统通过spring集成创建的，参数为：<br>false、false、true  同样的队列名，参数不一致，mq会报上述错误<br><img src=\"\\images\\pasted-47.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-48.png\" alt=\"upload successful\"><br>解决方案：<br>合理的方案：保持参数一致<br>临时方案：停止monitor，这是队列自动删除了，启动支付引擎，创建队列，再启动monitor，因为monitor是采用spring方式创建队列，不会尝试重新创建</p>\n","site":{"data":{}},"length":818,"excerpt":"","more":"<p>问题：<br>支付引擎往monitor发送监控mq消息时，报错：<br>2018-07-19 15:54:35.423 ERROR [AMQP Connection 10.21.30.153:5672] CachingConnectionFactory– Channel shutdown: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue ‘queue.monitor.logmsg’ in vhost ‘/‘ not equivalent, class-id=50, method-id=10)<br>Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - parameters for queue ‘queue.monitor.logmsg’ in vhost ‘/‘ not equivalent, class-id=50, method-id=10)</p>\n<p>原因：<br>支付引擎使用monitor客户端发送mq消息，由如下逻辑：<br><img src=\"\\images\\pasted-43.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-44.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-45.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-46.png\" alt=\"upload successful\"><br>问题出在：new Queue(XXX);<br>我们来看看参数：true、false、false。  但是mq服务器上当前的队列是monitor系统通过spring集成创建的，参数为：<br>false、false、true  同样的队列名，参数不一致，mq会报上述错误<br><img src=\"\\images\\pasted-47.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-48.png\" alt=\"upload successful\"><br>解决方案：<br>合理的方案：保持参数一致<br>临时方案：停止monitor，这是队列自动删除了，启动支付引擎，创建队列，再启动monitor，因为monitor是采用spring方式创建队列，不会尝试重新创建</p>\n"},{"title":"rocketmq异常分析","author":"Xiang Chuang","date":"2020-07-21T12:32:13.000Z","_content":"1、背景\n公司系统中，业务系统与中台系统基于rocketmq进行异步事件交互，基本信息如下：\n分组信息，公司rocketmq组件直接使用系统名及环境变量作为groupName\ntopic信息，目前存在两个topic，XXX及YYY\ntag信息，每个topic存在多个tag\n2、问题现象\n在开发环境测试时（单机），一切运行正常，能收到mq消息\n将分支发布到测试服务器后，出现了部分消息收不到\n通过console查询到部分消息trackType如下\n![upload successful](/images/pasted-105.png)\n说明分组A下确实存在未消费的消息\n3、问题排查\n通过查询rocket日志发现，默认日志路径为${user.home}/logs/rocketmqlogs/rocketmq_client.log\n\n![upload successful](/images/pasted-106.png)\n发现该错误，疑似说明消费者没有消费指定的topic\n\n后继续查询console发现同一分组存在两个两个消费者（应用系统两个分支、相同环境变量分别发布在两个服务器），由此分析到，另一个分支中并未消费相应的topic\n4、结论\nrocketmq按照分组划分消费者，同一分组会根据负载均衡策略消费不同broker分片的消息，如果同一分组下的消费者订阅的topic不一致，将导致部分分片下的消息无法被消费。问题规避，保证同一分组下消费者订阅的topic一致，理论上在测试环境多分支并行开发时易出现该问题","source":"_posts/rocketmq异常分析.md","raw":"title: rocketmq异常分析\nauthor: Xiang Chuang\ndate: 2020-07-21 20:32:13\ntags:\n---\n1、背景\n公司系统中，业务系统与中台系统基于rocketmq进行异步事件交互，基本信息如下：\n分组信息，公司rocketmq组件直接使用系统名及环境变量作为groupName\ntopic信息，目前存在两个topic，XXX及YYY\ntag信息，每个topic存在多个tag\n2、问题现象\n在开发环境测试时（单机），一切运行正常，能收到mq消息\n将分支发布到测试服务器后，出现了部分消息收不到\n通过console查询到部分消息trackType如下\n![upload successful](/images/pasted-105.png)\n说明分组A下确实存在未消费的消息\n3、问题排查\n通过查询rocket日志发现，默认日志路径为${user.home}/logs/rocketmqlogs/rocketmq_client.log\n\n![upload successful](/images/pasted-106.png)\n发现该错误，疑似说明消费者没有消费指定的topic\n\n后继续查询console发现同一分组存在两个两个消费者（应用系统两个分支、相同环境变量分别发布在两个服务器），由此分析到，另一个分支中并未消费相应的topic\n4、结论\nrocketmq按照分组划分消费者，同一分组会根据负载均衡策略消费不同broker分片的消息，如果同一分组下的消费者订阅的topic不一致，将导致部分分片下的消息无法被消费。问题规避，保证同一分组下消费者订阅的topic一致，理论上在测试环境多分支并行开发时易出现该问题","slug":"rocketmq异常分析","published":1,"updated":"2020-07-21T12:43:44.980Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbw002fwy6656ww9jvo","content":"<p>1、背景<br>公司系统中，业务系统与中台系统基于rocketmq进行异步事件交互，基本信息如下：<br>分组信息，公司rocketmq组件直接使用系统名及环境变量作为groupName<br>topic信息，目前存在两个topic，XXX及YYY<br>tag信息，每个topic存在多个tag<br>2、问题现象<br>在开发环境测试时（单机），一切运行正常，能收到mq消息<br>将分支发布到测试服务器后，出现了部分消息收不到<br>通过console查询到部分消息trackType如下<br><img src=\"/images/pasted-105.png\" alt=\"upload successful\"><br>说明分组A下确实存在未消费的消息<br>3、问题排查<br>通过查询rocket日志发现，默认日志路径为${user.home}/logs/rocketmqlogs/rocketmq_client.log</p>\n<p><img src=\"/images/pasted-106.png\" alt=\"upload successful\"><br>发现该错误，疑似说明消费者没有消费指定的topic</p>\n<p>后继续查询console发现同一分组存在两个两个消费者（应用系统两个分支、相同环境变量分别发布在两个服务器），由此分析到，另一个分支中并未消费相应的topic<br>4、结论<br>rocketmq按照分组划分消费者，同一分组会根据负载均衡策略消费不同broker分片的消息，如果同一分组下的消费者订阅的topic不一致，将导致部分分片下的消息无法被消费。问题规避，保证同一分组下消费者订阅的topic一致，理论上在测试环境多分支并行开发时易出现该问题</p>\n","site":{"data":{}},"length":552,"excerpt":"","more":"<p>1、背景<br>公司系统中，业务系统与中台系统基于rocketmq进行异步事件交互，基本信息如下：<br>分组信息，公司rocketmq组件直接使用系统名及环境变量作为groupName<br>topic信息，目前存在两个topic，XXX及YYY<br>tag信息，每个topic存在多个tag<br>2、问题现象<br>在开发环境测试时（单机），一切运行正常，能收到mq消息<br>将分支发布到测试服务器后，出现了部分消息收不到<br>通过console查询到部分消息trackType如下<br><img src=\"/images/pasted-105.png\" alt=\"upload successful\"><br>说明分组A下确实存在未消费的消息<br>3、问题排查<br>通过查询rocket日志发现，默认日志路径为${user.home}/logs/rocketmqlogs/rocketmq_client.log</p>\n<p><img src=\"/images/pasted-106.png\" alt=\"upload successful\"><br>发现该错误，疑似说明消费者没有消费指定的topic</p>\n<p>后继续查询console发现同一分组存在两个两个消费者（应用系统两个分支、相同环境变量分别发布在两个服务器），由此分析到，另一个分支中并未消费相应的topic<br>4、结论<br>rocketmq按照分组划分消费者，同一分组会根据负载均衡策略消费不同broker分片的消息，如果同一分组下的消费者订阅的topic不一致，将导致部分分片下的消息无法被消费。问题规避，保证同一分组下消费者订阅的topic一致，理论上在测试环境多分支并行开发时易出现该问题</p>\n"},{"title":"springboot-spring-boot-starter-actuator","author":"Xiang Chuang","date":"2018-07-12T08:03:00.000Z","_content":"应用监控管理\n自定义健康检测器，实现org.springframework.boot.actuate.health.AbstractHealthIndicator\n充分利用java.lang.management.ManagementFactory，获取系统资源情况\n\n易极付：\n基于spring-boot的应用健康监控：\ndubboHealthIndicator      dubbo健康检查\ndeadlockedThreadsHealthIndicator  死锁线程检查\nthreadsCountHealthIndicator 线程数量检查，阈值2000\nsystemLoadHealthIndicator cpu负载检查，阈值1/3\nrabbitHealthIndicator rabbitmq可用性检查\nsessionYedisHealthIndicator  sessionRedis可用性检查\ntomcatHealthIndicator 线程占用数量 阈值1半，   tomcat默认最大线程400\nyedisHealthIndicator redis可用性检查\ndiskSpaceHealthIndicator 硬盘空间检查 阈值management.health.diskspace.threshold=524288000\ndataSourceHealthIndicator  使用select 1检查连接 （spring-boot提供）\n\n![upload successful](\\images\\pasted-17.png)","source":"_posts/springboot-spring-boot-starter-actuator.md","raw":"title: springboot-spring-boot-starter-actuator\nauthor: Xiang Chuang\ntags:\n  - spring\n  - springboot\n  - 应用监控检查\ncategories:\n  - 爱学爱问\ndate: 2018-07-12 16:03:00\n---\n应用监控管理\n自定义健康检测器，实现org.springframework.boot.actuate.health.AbstractHealthIndicator\n充分利用java.lang.management.ManagementFactory，获取系统资源情况\n\n易极付：\n基于spring-boot的应用健康监控：\ndubboHealthIndicator      dubbo健康检查\ndeadlockedThreadsHealthIndicator  死锁线程检查\nthreadsCountHealthIndicator 线程数量检查，阈值2000\nsystemLoadHealthIndicator cpu负载检查，阈值1/3\nrabbitHealthIndicator rabbitmq可用性检查\nsessionYedisHealthIndicator  sessionRedis可用性检查\ntomcatHealthIndicator 线程占用数量 阈值1半，   tomcat默认最大线程400\nyedisHealthIndicator redis可用性检查\ndiskSpaceHealthIndicator 硬盘空间检查 阈值management.health.diskspace.threshold=524288000\ndataSourceHealthIndicator  使用select 1检查连接 （spring-boot提供）\n\n![upload successful](\\images\\pasted-17.png)","slug":"springboot-spring-boot-starter-actuator","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbx002iwy661mcb4va8","content":"<p>应用监控管理<br>自定义健康检测器，实现org.springframework.boot.actuate.health.AbstractHealthIndicator<br>充分利用java.lang.management.ManagementFactory，获取系统资源情况</p>\n<p>易极付：<br>基于spring-boot的应用健康监控：<br>dubboHealthIndicator      dubbo健康检查<br>deadlockedThreadsHealthIndicator  死锁线程检查<br>threadsCountHealthIndicator 线程数量检查，阈值2000<br>systemLoadHealthIndicator cpu负载检查，阈值1/3<br>rabbitHealthIndicator rabbitmq可用性检查<br>sessionYedisHealthIndicator  sessionRedis可用性检查<br>tomcatHealthIndicator 线程占用数量 阈值1半，   tomcat默认最大线程400<br>yedisHealthIndicator redis可用性检查<br>diskSpaceHealthIndicator 硬盘空间检查 阈值management.health.diskspace.threshold=524288000<br>dataSourceHealthIndicator  使用select 1检查连接 （spring-boot提供）</p>\n<p><img src=\"\\images\\pasted-17.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":588,"excerpt":"","more":"<p>应用监控管理<br>自定义健康检测器，实现org.springframework.boot.actuate.health.AbstractHealthIndicator<br>充分利用java.lang.management.ManagementFactory，获取系统资源情况</p>\n<p>易极付：<br>基于spring-boot的应用健康监控：<br>dubboHealthIndicator      dubbo健康检查<br>deadlockedThreadsHealthIndicator  死锁线程检查<br>threadsCountHealthIndicator 线程数量检查，阈值2000<br>systemLoadHealthIndicator cpu负载检查，阈值1/3<br>rabbitHealthIndicator rabbitmq可用性检查<br>sessionYedisHealthIndicator  sessionRedis可用性检查<br>tomcatHealthIndicator 线程占用数量 阈值1半，   tomcat默认最大线程400<br>yedisHealthIndicator redis可用性检查<br>diskSpaceHealthIndicator 硬盘空间检查 阈值management.health.diskspace.threshold=524288000<br>dataSourceHealthIndicator  使用select 1检查连接 （spring-boot提供）</p>\n<p><img src=\"\\images\\pasted-17.png\" alt=\"upload successful\"></p>\n"},{"title":"struts2-no action in maven","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"原因：convention插件默认不扫描jar中的action\n 解决方案：http://struts.apache.org/release/2.3.x/docs/convention-plugin.html#ConventionPlugin-Actionsinjarfiles(struts2convention插件说明)\n    <!-- the jar URL can contain a path to the jar file and a trailing \"!/\" -->\n    <constant name=\"struts.convention.action.includeJars\" value=\".*?/Imanage\\w*.*?jar(!/)?\"/>  匹配 前缀为Imanage的所有jar\n    \n![upload successful](\\images\\pasted-56.png)","source":"_posts/struts2-no-action-in-maven.md","raw":"title: struts2-no action in maven\nauthor: Xiang Chuang\ntags:\n  - struts2\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\n原因：convention插件默认不扫描jar中的action\n 解决方案：http://struts.apache.org/release/2.3.x/docs/convention-plugin.html#ConventionPlugin-Actionsinjarfiles(struts2convention插件说明)\n    <!-- the jar URL can contain a path to the jar file and a trailing \"!/\" -->\n    <constant name=\"struts.convention.action.includeJars\" value=\".*?/Imanage\\w*.*?jar(!/)?\"/>  匹配 前缀为Imanage的所有jar\n    \n![upload successful](\\images\\pasted-56.png)","slug":"struts2-no-action-in-maven","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbx002kwy6697983oh7","content":"<p>原因：convention插件默认不扫描jar中的action<br> 解决方案：<a href=\"http://struts.apache.org/release/2.3.x/docs/convention-plugin.html#ConventionPlugin-Actionsinjarfiles(struts2convention插件说明)\">http://struts.apache.org/release/2.3.x/docs/convention-plugin.html#ConventionPlugin-Actionsinjarfiles(struts2convention插件说明)</a><br>    <!-- the jar URL can contain a path to the jar file and a trailing \"!/\" --><br>    <constant name=\"struts.convention.action.includeJars\" value=\".*?/Imanage\\w*.*?jar(!/)?\"/>  匹配 前缀为Imanage的所有jar</p>\n<p><img src=\"\\images\\pasted-56.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":178,"excerpt":"","more":"<p>原因：convention插件默认不扫描jar中的action<br> 解决方案：<a href=\"http://struts.apache.org/release/2.3.x/docs/convention-plugin.html#ConventionPlugin-Actionsinjarfiles(struts2convention插件说明)\">http://struts.apache.org/release/2.3.x/docs/convention-plugin.html#ConventionPlugin-Actionsinjarfiles(struts2convention插件说明)</a><br>    <!-- the jar URL can contain a path to the jar file and a trailing \"!/\" --><br>    <constant name=\"struts.convention.action.includeJars\" value=\".*?/Imanage\\w*.*?jar(!/)?\"/>  匹配 前缀为Imanage的所有jar</p>\n<p><img src=\"\\images\\pasted-56.png\" alt=\"upload successful\"></p>\n"},{"title":"zookeeper-反复重连问题","author":"Xiang Chuang","date":"2018-09-10T10:09:00.000Z","_content":"现象，zk后台日志发现频繁刷如下日志\nRefusing session request for client /192.168.46.4:48551 as it has seen zxid 0x3cdf3127 our last zxid is 0x5bba6c client must try another server\n\n大量刷日志导致zk性能下降，最终导致依赖于zk的服务不可用\n\n经分析：\n日志来源代码为 org.apache.zookeeper.server.ZooKeeperServer\n\n![upload successful](\\images\\pasted-18.png)\nlastProcessedZxid在zk中用于记录版本信息，即客户端与服务端版本控制\n\n后经反馈得知，18.09.07由于snet环境zk日志量大，曾情况过zk数据目录数据，当时导致各应用zk不可用，要求各应用重启，后续大部分应用重启完成后业务正常使用，但并没有核对所有系统是否都重启\n\n因此，部分没有重启的应用本地的版本信息还是老的信息，拿此信息与zk服务端交互，由于版本信息不对，导致zk拒绝连接，从而客户端又频繁发起重连尝试。。。\n\n解决，一旦发起过zk数据目录删除，或者迁移，请务必确保所有应用全部重启以获取最新的版本信息","source":"_posts/zookeeper-反复重连问题.md","raw":"title: zookeeper-反复重连问题\nauthor: Xiang Chuang\ntags:\n  - zookeeper\ncategories:\n  - 这些年，那些坑\ndate: 2018-09-10 18:09:00\n---\n现象，zk后台日志发现频繁刷如下日志\nRefusing session request for client /192.168.46.4:48551 as it has seen zxid 0x3cdf3127 our last zxid is 0x5bba6c client must try another server\n\n大量刷日志导致zk性能下降，最终导致依赖于zk的服务不可用\n\n经分析：\n日志来源代码为 org.apache.zookeeper.server.ZooKeeperServer\n\n![upload successful](\\images\\pasted-18.png)\nlastProcessedZxid在zk中用于记录版本信息，即客户端与服务端版本控制\n\n后经反馈得知，18.09.07由于snet环境zk日志量大，曾情况过zk数据目录数据，当时导致各应用zk不可用，要求各应用重启，后续大部分应用重启完成后业务正常使用，但并没有核对所有系统是否都重启\n\n因此，部分没有重启的应用本地的版本信息还是老的信息，拿此信息与zk服务端交互，由于版本信息不对，导致zk拒绝连接，从而客户端又频繁发起重连尝试。。。\n\n解决，一旦发起过zk数据目录删除，或者迁移，请务必确保所有应用全部重启以获取最新的版本信息","slug":"zookeeper-反复重连问题","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vby002nwy668ya96jf8","content":"<p>现象，zk后台日志发现频繁刷如下日志<br>Refusing session request for client /192.168.46.4:48551 as it has seen zxid 0x3cdf3127 our last zxid is 0x5bba6c client must try another server</p>\n<p>大量刷日志导致zk性能下降，最终导致依赖于zk的服务不可用</p>\n<p>经分析：<br>日志来源代码为 org.apache.zookeeper.server.ZooKeeperServer</p>\n<p><img src=\"\\images\\pasted-18.png\" alt=\"upload successful\"><br>lastProcessedZxid在zk中用于记录版本信息，即客户端与服务端版本控制</p>\n<p>后经反馈得知，18.09.07由于snet环境zk日志量大，曾情况过zk数据目录数据，当时导致各应用zk不可用，要求各应用重启，后续大部分应用重启完成后业务正常使用，但并没有核对所有系统是否都重启</p>\n<p>因此，部分没有重启的应用本地的版本信息还是老的信息，拿此信息与zk服务端交互，由于版本信息不对，导致zk拒绝连接，从而客户端又频繁发起重连尝试。。。</p>\n<p>解决，一旦发起过zk数据目录删除，或者迁移，请务必确保所有应用全部重启以获取最新的版本信息</p>\n","site":{"data":{}},"length":482,"excerpt":"","more":"<p>现象，zk后台日志发现频繁刷如下日志<br>Refusing session request for client /192.168.46.4:48551 as it has seen zxid 0x3cdf3127 our last zxid is 0x5bba6c client must try another server</p>\n<p>大量刷日志导致zk性能下降，最终导致依赖于zk的服务不可用</p>\n<p>经分析：<br>日志来源代码为 org.apache.zookeeper.server.ZooKeeperServer</p>\n<p><img src=\"\\images\\pasted-18.png\" alt=\"upload successful\"><br>lastProcessedZxid在zk中用于记录版本信息，即客户端与服务端版本控制</p>\n<p>后经反馈得知，18.09.07由于snet环境zk日志量大，曾情况过zk数据目录数据，当时导致各应用zk不可用，要求各应用重启，后续大部分应用重启完成后业务正常使用，但并没有核对所有系统是否都重启</p>\n<p>因此，部分没有重启的应用本地的版本信息还是老的信息，拿此信息与zk服务端交互，由于版本信息不对，导致zk拒绝连接，从而客户端又频繁发起重连尝试。。。</p>\n<p>解决，一旦发起过zk数据目录删除，或者迁移，请务必确保所有应用全部重启以获取最新的版本信息</p>\n"},{"title":"内存泄漏-案例分析","author":"Xiang Chuang","date":"2018-07-09T06:24:00.000Z","_content":"问题描述：代扣网关启动一段时间后，监控发现系统随着运行时间越长越缓慢（第一时间考虑是否内存泄漏）\n\n现象：1、一个很简单的代码块执行耗时很长，甚至长达30S以上\n          2、老年代频繁进行内存回收，但是回收后却仍旧占用了很多内存，且随着时间推移，占用的越来越多，只到系统                       down掉 \n          3、青年代内存频繁回收（该原因是青年代内存分配不合理，可考虑青年代占总堆内存3：8，但是不能太大，如果太                   大，当青年代回收时，如果需要晋升到老年代的对象占内容大于老年代可用空间的一般，将会导致Full GC）\n\n原因推测：\n            上述现象第一反应是疑似出现内存泄漏\n处理过程：1、系统挂掉（重启）前，dump内存镜像文件，  jmap -dump:format=b,file=盘符:/XXX.hprof <pid>\n                 2、使用mat工具分析dump文件\n                 3、找出引起内存泄漏的对象\n                 4、分析解决方案\n           \n\n附：\n1、执行缓慢的代码日志：下面是一段for循环代码块，每次循环先校验再入库，逻辑简单，但发现异常的慢！\n2018-07-04 08:39:06.511 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:06.539 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2018-07-04 08:39:06.596 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:06.613 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2018-07-04 08:39:06.673 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:06.696 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2018-07-04 08:39:39.615 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:39.618 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2、GC日志：老年代CMS策略垃圾回收日志，反复回收，但依旧回收不了内存，内存消耗的原来越多\n2018-07-09T14:24:21.701+0800: 337412.009: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4302687K(5183936K)] 4971300K(6106880K), 0.0621324 secs] [Times: user=0.73 sys=0.00, real=0.07 secs] \n2018-07-09T14:24:21.764+0800: 337412.072: [CMS-concurrent-mark-start]\n2018-07-09T14:24:22.900+0800: 337413.208: [GC (Allocation Failure) 337413.208: [ParNew: 760830K->17436K(922944K), 0.0174147 secs] 5063517K->4320664K(6106880K), 0.0180025 secs] [Times: user=0.11 sys=0.01, real=0.02 secs] \n2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-mark: 3.607/3.760 secs] [Times: user=16.27 sys=0.18, real=3.75 secs] \n2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-preclean-start]\n2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-preclean: 0.045/0.047 secs] [Times: user=0.07 sys=0.01, real=0.05 secs] \n2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-abortable-preclean-start]\n CMS: abort preclean due to time 2018-07-09T14:24:30.647+0800: 337420.955: [CMS-concurrent-abortable-preclean: 3.287/5.076 secs] [Times: user=4.95 sys=0.24, real=5.08 secs] \n2018-07-09T14:24:30.658+0800: 337420.966: [GC (CMS Final Remark) [YG occupancy: 617178 K (922944 K)]337420.966: [Rescan (parallel) , 0.0603228 secs]337421.027: [weak refs processing, 0.0000841 secs]337421.027: [class unloading, 0.1254411 secs]337421.152: [scrub symbol table, 0.0445538 secs]337421.197: [scrub string table, 0.0066675 secs][1 CMS-remark: 4303227K(5183936K)] 4920406K(6106880K), 0.2439490 secs] [Times: user=0.90 sys=0.01, real=0.24 secs] \n2018-07-09T14:24:30.903+0800: 337421.211: [CMS-concurrent-sweep-start]\n2018-07-09T14:24:31.941+0800: 337422.249: [GC (Allocation Failure) 337422.249: [ParNew: 755804K->24447K(922944K), 0.0350291 secs] 5059025K->4328220K(6106880K), 0.0357587 secs] [Times: user=0.18 sys=0.00, real=0.04 secs] \n2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-sweep: 2.815/2.958 secs] [Times: user=4.72 sys=0.24, real=2.96 secs] \n2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-reset-start]\n2018-07-09T14:24:33.877+0800: 337424.185: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] \n2018-07-09T14:24:35.886+0800: 337426.194: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4303632K(5183936K)] 4520863K(6106880K), 0.0222239 secs] [Times: user=0.21 sys=0.00, real=0.02 secs] \n2018-07-09T14:24:35.910+0800: 337426.218: [CMS-concurrent-mark-start]\n2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-mark: 3.449/3.463 secs] [Times: user=14.73 sys=0.10, real=3.46 secs] \n2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-preclean-start]\n2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-preclean: 0.023/0.023 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] \n2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-abortable-preclean-start]\n CMS: abort preclean due to time 2018-07-09T14:24:44.405+0800: 337434.713: [CMS-concurrent-abortable-preclean: 3.247/5.009 secs] [Times: user=3.97 sys=0.16, real=5.01 secs] \n2018-07-09T14:24:44.415+0800: 337434.723: [GC (CMS Final Remark) [YG occupancy: 553150 K (922944 K)]337434.723: [Rescan (parallel) , 0.0524846 secs]337434.776: [weak refs processing, 0.0000721 secs]337434.776: [class unloading, 0.1203949 secs]337434.896: [scrub symbol table, 0.0454455 secs]337434.942: [scrub string table, 0.0063738 secs][1 CMS-remark: 4303632K(5183936K)] 4856783K(6106880K), 0.2322675 secs] [Times: user=0.83 sys=0.00, real=0.23 secs] \n2018-07-09T14:24:44.648+0800: 337434.956: [CMS-concurrent-sweep-start]\n2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-sweep: 2.492/2.501 secs] [Times: user=2.85 sys=0.03, real=2.50 secs] \n2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-reset-start]\n2018-07-09T14:24:47.165+0800: 337437.473: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] \n3、mat分析情况：\n\n![upload successful](\\images\\pasted-2.png)\n\n![upload successful](\\images\\pasted-3.png)\n\n![upload successful](\\images\\pasted-4.png)\n\n![upload successful](\\images\\pasted-5.png)","source":"_posts/内存泄漏案例分析.md","raw":"title: 内存泄漏-案例分析\nauthor: Xiang Chuang\ntags:\n  - java\n  - 内存泄漏\n  - mat\ncategories:\n  - 这些年，那些坑\ndate: 2018-07-09 14:24:00\n---\n问题描述：代扣网关启动一段时间后，监控发现系统随着运行时间越长越缓慢（第一时间考虑是否内存泄漏）\n\n现象：1、一个很简单的代码块执行耗时很长，甚至长达30S以上\n          2、老年代频繁进行内存回收，但是回收后却仍旧占用了很多内存，且随着时间推移，占用的越来越多，只到系统                       down掉 \n          3、青年代内存频繁回收（该原因是青年代内存分配不合理，可考虑青年代占总堆内存3：8，但是不能太大，如果太                   大，当青年代回收时，如果需要晋升到老年代的对象占内容大于老年代可用空间的一般，将会导致Full GC）\n\n原因推测：\n            上述现象第一反应是疑似出现内存泄漏\n处理过程：1、系统挂掉（重启）前，dump内存镜像文件，  jmap -dump:format=b,file=盘符:/XXX.hprof <pid>\n                 2、使用mat工具分析dump文件\n                 3、找出引起内存泄漏的对象\n                 4、分析解决方案\n           \n\n附：\n1、执行缓慢的代码日志：下面是一段for循环代码块，每次循环先校验再入库，逻辑简单，但发现异常的慢！\n2018-07-04 08:39:06.511 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:06.539 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2018-07-04 08:39:06.596 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:06.613 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2018-07-04 08:39:06.673 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:06.696 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2018-07-04 08:39:39.615 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验\n2018-07-04 08:39:39.618 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表 \n2、GC日志：老年代CMS策略垃圾回收日志，反复回收，但依旧回收不了内存，内存消耗的原来越多\n2018-07-09T14:24:21.701+0800: 337412.009: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4302687K(5183936K)] 4971300K(6106880K), 0.0621324 secs] [Times: user=0.73 sys=0.00, real=0.07 secs] \n2018-07-09T14:24:21.764+0800: 337412.072: [CMS-concurrent-mark-start]\n2018-07-09T14:24:22.900+0800: 337413.208: [GC (Allocation Failure) 337413.208: [ParNew: 760830K->17436K(922944K), 0.0174147 secs] 5063517K->4320664K(6106880K), 0.0180025 secs] [Times: user=0.11 sys=0.01, real=0.02 secs] \n2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-mark: 3.607/3.760 secs] [Times: user=16.27 sys=0.18, real=3.75 secs] \n2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-preclean-start]\n2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-preclean: 0.045/0.047 secs] [Times: user=0.07 sys=0.01, real=0.05 secs] \n2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-abortable-preclean-start]\n CMS: abort preclean due to time 2018-07-09T14:24:30.647+0800: 337420.955: [CMS-concurrent-abortable-preclean: 3.287/5.076 secs] [Times: user=4.95 sys=0.24, real=5.08 secs] \n2018-07-09T14:24:30.658+0800: 337420.966: [GC (CMS Final Remark) [YG occupancy: 617178 K (922944 K)]337420.966: [Rescan (parallel) , 0.0603228 secs]337421.027: [weak refs processing, 0.0000841 secs]337421.027: [class unloading, 0.1254411 secs]337421.152: [scrub symbol table, 0.0445538 secs]337421.197: [scrub string table, 0.0066675 secs][1 CMS-remark: 4303227K(5183936K)] 4920406K(6106880K), 0.2439490 secs] [Times: user=0.90 sys=0.01, real=0.24 secs] \n2018-07-09T14:24:30.903+0800: 337421.211: [CMS-concurrent-sweep-start]\n2018-07-09T14:24:31.941+0800: 337422.249: [GC (Allocation Failure) 337422.249: [ParNew: 755804K->24447K(922944K), 0.0350291 secs] 5059025K->4328220K(6106880K), 0.0357587 secs] [Times: user=0.18 sys=0.00, real=0.04 secs] \n2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-sweep: 2.815/2.958 secs] [Times: user=4.72 sys=0.24, real=2.96 secs] \n2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-reset-start]\n2018-07-09T14:24:33.877+0800: 337424.185: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] \n2018-07-09T14:24:35.886+0800: 337426.194: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4303632K(5183936K)] 4520863K(6106880K), 0.0222239 secs] [Times: user=0.21 sys=0.00, real=0.02 secs] \n2018-07-09T14:24:35.910+0800: 337426.218: [CMS-concurrent-mark-start]\n2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-mark: 3.449/3.463 secs] [Times: user=14.73 sys=0.10, real=3.46 secs] \n2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-preclean-start]\n2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-preclean: 0.023/0.023 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] \n2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-abortable-preclean-start]\n CMS: abort preclean due to time 2018-07-09T14:24:44.405+0800: 337434.713: [CMS-concurrent-abortable-preclean: 3.247/5.009 secs] [Times: user=3.97 sys=0.16, real=5.01 secs] \n2018-07-09T14:24:44.415+0800: 337434.723: [GC (CMS Final Remark) [YG occupancy: 553150 K (922944 K)]337434.723: [Rescan (parallel) , 0.0524846 secs]337434.776: [weak refs processing, 0.0000721 secs]337434.776: [class unloading, 0.1203949 secs]337434.896: [scrub symbol table, 0.0454455 secs]337434.942: [scrub string table, 0.0063738 secs][1 CMS-remark: 4303632K(5183936K)] 4856783K(6106880K), 0.2322675 secs] [Times: user=0.83 sys=0.00, real=0.23 secs] \n2018-07-09T14:24:44.648+0800: 337434.956: [CMS-concurrent-sweep-start]\n2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-sweep: 2.492/2.501 secs] [Times: user=2.85 sys=0.03, real=2.50 secs] \n2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-reset-start]\n2018-07-09T14:24:47.165+0800: 337437.473: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] \n3、mat分析情况：\n\n![upload successful](\\images\\pasted-2.png)\n\n![upload successful](\\images\\pasted-3.png)\n\n![upload successful](\\images\\pasted-4.png)\n\n![upload successful](\\images\\pasted-5.png)","slug":"内存泄漏案例分析","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vbz002qwy665fajg9vh","content":"<p>问题描述：代扣网关启动一段时间后，监控发现系统随着运行时间越长越缓慢（第一时间考虑是否内存泄漏）</p>\n<p>现象：1、一个很简单的代码块执行耗时很长，甚至长达30S以上<br>          2、老年代频繁进行内存回收，但是回收后却仍旧占用了很多内存，且随着时间推移，占用的越来越多，只到系统                       down掉<br>          3、青年代内存频繁回收（该原因是青年代内存分配不合理，可考虑青年代占总堆内存3：8，但是不能太大，如果太                   大，当青年代回收时，如果需要晋升到老年代的对象占内容大于老年代可用空间的一般，将会导致Full GC）</p>\n<p>原因推测：<br>            上述现象第一反应是疑似出现内存泄漏<br>处理过程：1、系统挂掉（重启）前，dump内存镜像文件，  jmap -dump:format=b,file=盘符:/XXX.hprof <pid><br>                 2、使用mat工具分析dump文件<br>                 3、找出引起内存泄漏的对象<br>                 4、分析解决方案</p>\n<p>附：<br>1、执行缓慢的代码日志：下面是一段for循环代码块，每次循环先校验再入库，逻辑简单，但发现异常的慢！<br>2018-07-04 08:39:06.511 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:06.539 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2018-07-04 08:39:06.596 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:06.613 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2018-07-04 08:39:06.673 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:06.696 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2018-07-04 08:39:39.615 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:39.618 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2、GC日志：老年代CMS策略垃圾回收日志，反复回收，但依旧回收不了内存，内存消耗的原来越多<br>2018-07-09T14:24:21.701+0800: 337412.009: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4302687K(5183936K)] 4971300K(6106880K), 0.0621324 secs] [Times: user=0.73 sys=0.00, real=0.07 secs]<br>2018-07-09T14:24:21.764+0800: 337412.072: [CMS-concurrent-mark-start]<br>2018-07-09T14:24:22.900+0800: 337413.208: [GC (Allocation Failure) 337413.208: [ParNew: 760830K-&gt;17436K(922944K), 0.0174147 secs] 5063517K-&gt;4320664K(6106880K), 0.0180025 secs] [Times: user=0.11 sys=0.01, real=0.02 secs]<br>2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-mark: 3.607/3.760 secs] [Times: user=16.27 sys=0.18, real=3.75 secs]<br>2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-preclean-start]<br>2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-preclean: 0.045/0.047 secs] [Times: user=0.07 sys=0.01, real=0.05 secs]<br>2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-abortable-preclean-start]<br> CMS: abort preclean due to time 2018-07-09T14:24:30.647+0800: 337420.955: [CMS-concurrent-abortable-preclean: 3.287/5.076 secs] [Times: user=4.95 sys=0.24, real=5.08 secs]<br>2018-07-09T14:24:30.658+0800: 337420.966: [GC (CMS Final Remark) [YG occupancy: 617178 K (922944 K)]337420.966: [Rescan (parallel) , 0.0603228 secs]337421.027: [weak refs processing, 0.0000841 secs]337421.027: [class unloading, 0.1254411 secs]337421.152: [scrub symbol table, 0.0445538 secs]337421.197: [scrub string table, 0.0066675 secs][1 CMS-remark: 4303227K(5183936K)] 4920406K(6106880K), 0.2439490 secs] [Times: user=0.90 sys=0.01, real=0.24 secs]<br>2018-07-09T14:24:30.903+0800: 337421.211: [CMS-concurrent-sweep-start]<br>2018-07-09T14:24:31.941+0800: 337422.249: [GC (Allocation Failure) 337422.249: [ParNew: 755804K-&gt;24447K(922944K), 0.0350291 secs] 5059025K-&gt;4328220K(6106880K), 0.0357587 secs] [Times: user=0.18 sys=0.00, real=0.04 secs]<br>2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-sweep: 2.815/2.958 secs] [Times: user=4.72 sys=0.24, real=2.96 secs]<br>2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-reset-start]<br>2018-07-09T14:24:33.877+0800: 337424.185: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.02 sys=0.00, real=0.02 secs]<br>2018-07-09T14:24:35.886+0800: 337426.194: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4303632K(5183936K)] 4520863K(6106880K), 0.0222239 secs] [Times: user=0.21 sys=0.00, real=0.02 secs]<br>2018-07-09T14:24:35.910+0800: 337426.218: [CMS-concurrent-mark-start]<br>2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-mark: 3.449/3.463 secs] [Times: user=14.73 sys=0.10, real=3.46 secs]<br>2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-preclean-start]<br>2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-preclean: 0.023/0.023 secs] [Times: user=0.02 sys=0.00, real=0.02 secs]<br>2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-abortable-preclean-start]<br> CMS: abort preclean due to time 2018-07-09T14:24:44.405+0800: 337434.713: [CMS-concurrent-abortable-preclean: 3.247/5.009 secs] [Times: user=3.97 sys=0.16, real=5.01 secs]<br>2018-07-09T14:24:44.415+0800: 337434.723: [GC (CMS Final Remark) [YG occupancy: 553150 K (922944 K)]337434.723: [Rescan (parallel) , 0.0524846 secs]337434.776: [weak refs processing, 0.0000721 secs]337434.776: [class unloading, 0.1203949 secs]337434.896: [scrub symbol table, 0.0454455 secs]337434.942: [scrub string table, 0.0063738 secs][1 CMS-remark: 4303632K(5183936K)] 4856783K(6106880K), 0.2322675 secs] [Times: user=0.83 sys=0.00, real=0.23 secs]<br>2018-07-09T14:24:44.648+0800: 337434.956: [CMS-concurrent-sweep-start]<br>2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-sweep: 2.492/2.501 secs] [Times: user=2.85 sys=0.03, real=2.50 secs]<br>2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-reset-start]<br>2018-07-09T14:24:47.165+0800: 337437.473: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]<br>3、mat分析情况：</p>\n<p><img src=\"\\images\\pasted-2.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-3.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-4.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-5.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":5094,"excerpt":"","more":"<p>问题描述：代扣网关启动一段时间后，监控发现系统随着运行时间越长越缓慢（第一时间考虑是否内存泄漏）</p>\n<p>现象：1、一个很简单的代码块执行耗时很长，甚至长达30S以上<br>          2、老年代频繁进行内存回收，但是回收后却仍旧占用了很多内存，且随着时间推移，占用的越来越多，只到系统                       down掉<br>          3、青年代内存频繁回收（该原因是青年代内存分配不合理，可考虑青年代占总堆内存3：8，但是不能太大，如果太                   大，当青年代回收时，如果需要晋升到老年代的对象占内容大于老年代可用空间的一般，将会导致Full GC）</p>\n<p>原因推测：<br>            上述现象第一反应是疑似出现内存泄漏<br>处理过程：1、系统挂掉（重启）前，dump内存镜像文件，  jmap -dump:format=b,file=盘符:/XXX.hprof <pid><br>                 2、使用mat工具分析dump文件<br>                 3、找出引起内存泄漏的对象<br>                 4、分析解决方案</p>\n<p>附：<br>1、执行缓慢的代码日志：下面是一段for循环代码块，每次循环先校验再入库，逻辑简单，但发现异常的慢！<br>2018-07-04 08:39:06.511 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:06.539 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2018-07-04 08:39:06.596 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:06.613 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2018-07-04 08:39:06.673 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:06.696 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2018-07-04 08:39:39.615 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 代扣请求校验<br>2018-07-04 08:39:39.618 INFO  [DubboServerHandler-172.20.30.60:20939-99] BatchDeductCheckNode-00060000030000000001807040838510002- 插入流水信息到代扣流水表和流水附表<br>2、GC日志：老年代CMS策略垃圾回收日志，反复回收，但依旧回收不了内存，内存消耗的原来越多<br>2018-07-09T14:24:21.701+0800: 337412.009: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4302687K(5183936K)] 4971300K(6106880K), 0.0621324 secs] [Times: user=0.73 sys=0.00, real=0.07 secs]<br>2018-07-09T14:24:21.764+0800: 337412.072: [CMS-concurrent-mark-start]<br>2018-07-09T14:24:22.900+0800: 337413.208: [GC (Allocation Failure) 337413.208: [ParNew: 760830K-&gt;17436K(922944K), 0.0174147 secs] 5063517K-&gt;4320664K(6106880K), 0.0180025 secs] [Times: user=0.11 sys=0.01, real=0.02 secs]<br>2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-mark: 3.607/3.760 secs] [Times: user=16.27 sys=0.18, real=3.75 secs]<br>2018-07-09T14:24:25.524+0800: 337415.832: [CMS-concurrent-preclean-start]<br>2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-preclean: 0.045/0.047 secs] [Times: user=0.07 sys=0.01, real=0.05 secs]<br>2018-07-09T14:24:25.571+0800: 337415.879: [CMS-concurrent-abortable-preclean-start]<br> CMS: abort preclean due to time 2018-07-09T14:24:30.647+0800: 337420.955: [CMS-concurrent-abortable-preclean: 3.287/5.076 secs] [Times: user=4.95 sys=0.24, real=5.08 secs]<br>2018-07-09T14:24:30.658+0800: 337420.966: [GC (CMS Final Remark) [YG occupancy: 617178 K (922944 K)]337420.966: [Rescan (parallel) , 0.0603228 secs]337421.027: [weak refs processing, 0.0000841 secs]337421.027: [class unloading, 0.1254411 secs]337421.152: [scrub symbol table, 0.0445538 secs]337421.197: [scrub string table, 0.0066675 secs][1 CMS-remark: 4303227K(5183936K)] 4920406K(6106880K), 0.2439490 secs] [Times: user=0.90 sys=0.01, real=0.24 secs]<br>2018-07-09T14:24:30.903+0800: 337421.211: [CMS-concurrent-sweep-start]<br>2018-07-09T14:24:31.941+0800: 337422.249: [GC (Allocation Failure) 337422.249: [ParNew: 755804K-&gt;24447K(922944K), 0.0350291 secs] 5059025K-&gt;4328220K(6106880K), 0.0357587 secs] [Times: user=0.18 sys=0.00, real=0.04 secs]<br>2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-sweep: 2.815/2.958 secs] [Times: user=4.72 sys=0.24, real=2.96 secs]<br>2018-07-09T14:24:33.862+0800: 337424.170: [CMS-concurrent-reset-start]<br>2018-07-09T14:24:33.877+0800: 337424.185: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.02 sys=0.00, real=0.02 secs]<br>2018-07-09T14:24:35.886+0800: 337426.194: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4303632K(5183936K)] 4520863K(6106880K), 0.0222239 secs] [Times: user=0.21 sys=0.00, real=0.02 secs]<br>2018-07-09T14:24:35.910+0800: 337426.218: [CMS-concurrent-mark-start]<br>2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-mark: 3.449/3.463 secs] [Times: user=14.73 sys=0.10, real=3.46 secs]<br>2018-07-09T14:24:39.373+0800: 337429.681: [CMS-concurrent-preclean-start]<br>2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-preclean: 0.023/0.023 secs] [Times: user=0.02 sys=0.00, real=0.02 secs]<br>2018-07-09T14:24:39.396+0800: 337429.704: [CMS-concurrent-abortable-preclean-start]<br> CMS: abort preclean due to time 2018-07-09T14:24:44.405+0800: 337434.713: [CMS-concurrent-abortable-preclean: 3.247/5.009 secs] [Times: user=3.97 sys=0.16, real=5.01 secs]<br>2018-07-09T14:24:44.415+0800: 337434.723: [GC (CMS Final Remark) [YG occupancy: 553150 K (922944 K)]337434.723: [Rescan (parallel) , 0.0524846 secs]337434.776: [weak refs processing, 0.0000721 secs]337434.776: [class unloading, 0.1203949 secs]337434.896: [scrub symbol table, 0.0454455 secs]337434.942: [scrub string table, 0.0063738 secs][1 CMS-remark: 4303632K(5183936K)] 4856783K(6106880K), 0.2322675 secs] [Times: user=0.83 sys=0.00, real=0.23 secs]<br>2018-07-09T14:24:44.648+0800: 337434.956: [CMS-concurrent-sweep-start]<br>2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-sweep: 2.492/2.501 secs] [Times: user=2.85 sys=0.03, real=2.50 secs]<br>2018-07-09T14:24:47.150+0800: 337437.458: [CMS-concurrent-reset-start]<br>2018-07-09T14:24:47.165+0800: 337437.473: [CMS-concurrent-reset: 0.015/0.015 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]<br>3、mat分析情况：</p>\n<p><img src=\"\\images\\pasted-2.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-3.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-4.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-5.png\" alt=\"upload successful\"></p>\n"},{"title":"围绕dubbo底层原理漫谈微服务","author":"Xiang Chuang","date":"2019-05-06T09:56:00.000Z","_content":"## 说在前面\n&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。\n\n## 概述\n+ [XXX](#partI)\n+ [XXX](#partII)\n+ [XXX](#partIII)\n+ [XXX](#partIV)\n\n----------------------------------","source":"_posts/围绕dubbo底层原理漫谈微服务.md","raw":"title: 围绕dubbo底层原理漫谈微服务\nauthor: Xiang Chuang\ntags:\n  - dubbo\n  - 微服务\ncategories:\n  - 专题研讨\ndate: 2019-05-06 17:56:00\n---\n## 说在前面\n&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。\n\n## 概述\n+ [XXX](#partI)\n+ [XXX](#partII)\n+ [XXX](#partIII)\n+ [XXX](#partIV)\n\n----------------------------------","slug":"围绕dubbo底层原理漫谈微服务","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc0002uwy66hsl5drwq","content":"<h2 id=\"说在前面\"><a href=\"#说在前面\" class=\"headerlink\" title=\"说在前面\"></a>说在前面</h2><p>&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。</p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><ul>\n<li><a href=\"#partI\">XXX</a></li>\n<li><a href=\"#partII\">XXX</a></li>\n<li><a href=\"#partIII\">XXX</a></li>\n<li><a href=\"#partIV\">XXX</a></li>\n</ul>\n<hr>\n","site":{"data":{}},"length":168,"excerpt":"","more":"<h2 id=\"说在前面\"><a href=\"#说在前面\" class=\"headerlink\" title=\"说在前面\"></a>说在前面</h2><p>&emsp;&emsp;本文将从dubbo底层原理的角度深入探讨dubbo实现机制，同时，聊一聊当下为什么流行微服务架构，并介绍基于dubbo进行微服务架构的特点。需要说明的是，本文的出发点为dubbo，最终引申到微服务架构，后续会有专门的文章以微服务架构为出发点，详细探讨如何进行企业级微服务架构。</p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><ul>\n<li><a href=\"#partI\">XXX</a></li>\n<li><a href=\"#partII\">XXX</a></li>\n<li><a href=\"#partIII\">XXX</a></li>\n<li><a href=\"#partIV\">XXX</a></li>\n</ul>\n<hr>\n"},{"title":"图片压缩-ImageIO.read(inputStream)","author":"Xiang Chuang","date":"2019-04-11T10:36:00.000Z","_content":"本文可结合链接中的文章从GC层面辅助分析！\nhttps://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/\n\n背景：由于目前手机像素越来越富裕，导致用户上传图片时过大3-4M甚至以上，且像素较高，如3024*4032，因此，图片压缩功能就势在必行了。\n\n选型：优先考虑前端压缩，但由于个人对前端无甚兴趣，因此提供了基于java的压缩解决方案。\n\n目前市面上成熟的压缩工具大致为thumbnailator及simpleimage\n1、thumbnailator\n```\n\t<dependency>\n\t\t\t<groupId>net.coobird</groupId>\n\t\t\t<artifactId>thumbnailator</artifactId>\n\t\t\t<version>0.4.8</version>\n  </dependency>\n  ```\n  ```\n  BufferedImage bufferedImage = Thumbnails.of(input).scale(scale).outputQuality(quality).asBufferedImage();\n  ```\n  经过使用发现有背景色变红的问题，未着手解决,同时，内存消耗较大\n  \n2、simpleimage\n参见git\nhttps://github.com/alibaba/simpleimage\n```\n<dependency>\n\t\t\t<groupId>com.sun.media</groupId>\n\t\t\t<artifactId>jai-codec</artifactId>\n\t\t\t<version>1.1.3</version>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>javax.media</groupId>\n\t\t\t<artifactId>jai-core</artifactId>\n\t\t\t<version>1.1.3</version>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>com.alibaba</groupId>\n\t\t\t<artifactId>simpleimage</artifactId>\n\t\t\t<version>1.2.3</version>\n</dependency>            \n```\n```\nFile in = new File(\"d://04092.jpg\");      //原图片\n            ImageWrapper imageWrapper = ImageReadHelper.read(new FileInputStream(in));\n            int witdh = imageWrapper.getWidth();\n            int height = imageWrapper.getHeight();\n            File out = new File(\"d://04092-after.jpg\");       //目的图片\n            ScaleParameter scaleParam = new ScaleParameter(Float.valueOf(witdh * 0.5f).intValue()\n                    , Float.valueOf(height * 0.5f).intValue());\n            WriteParameter writeParam = new WriteParameter();\n\n            FileInputStream inStream = null;\n            FileOutputStream outStream = null;\n            ImageRender wr = null;\n            inStream = new FileInputStream(in);\n            outStream = new FileOutputStream(out);\n            ImageRender rr = new ReadRender(inStream);\n            ImageRender sr = new ScaleRender(rr, scaleParam);\n            wr = new WriteRender(sr, outStream, ImageFormat.JPEG, writeParam);\n\n            wr.render();                            //触发图像处理\n```\n```\nWriteRender.render()源码：\n @Override\n    public ImageWrapper render() throws SimpleImageException {\n        try {\n            if (image == null) {\n                image = imageRender.render();//此处读取原文件，大对象\n            }\n\n            ImageWriteHelper.write(image, stream, outputFormat, param);//写文件，数据缓冲区分段初始化，一个按压缩后图片像素大小生产，外加若干512*512及1024*1024的缓冲区，因此需要更多的内存\n        } catch (Exception e) {\n            throw new SimpleImageException(e);\n        }\n\n        return null;\n    }\n```\n```\nReadRender.render源码， WriteRender中需要首先依赖此类读取原文件\n@Override\n    public ImageWrapper render() throws SimpleImageException {\n        try {\n            ImageWrapper imgWrapper;\n            if (inStream == null) {\n                throw new SimpleImageException(\"No input set\");\n            }\n\n            imgWrapper = ImageReadHelper.read(inStream);\n\n            if (tosRGBColorSpace) {\n                for (int i = 0; i < imgWrapper.getNumOfImages(); i++) {\n                    PlanarImage img = ImageColorConvertHelper.convert2sRGB(imgWrapper\n                            .getAsPlanarImage(i));\n                    imgWrapper.setImage(i, img);\n                }\n            }\n\n            return imgWrapper;\n        } catch (Exception e) {\n            throw new SimpleImageException(e);\n        }\n    }\n    \n    ImageReadHelper.read(inStream)：\n    public static ImageWrapper read(InputStream input)\n            throws SimpleImageException {\n        try {\n            input = ImageUtils.createMemoryStream(input);//流拷贝，增加了内存使用\n\n            if (ImageUtils.isJPEG(input)) {\n                return readJPEG(input);//此处耗内存\n            }\n\n            if (ImageUtils.isGIF(input)) {\n                return readGIF(input);\n            }\n\n            return readGeneral(input);\n        } catch (Exception e) {\n            throw new SimpleImageException(e);\n        }\n    }\n```\n由于simpleimage在read及write阶段做了额外操作，使得单次开辟的大对象比方案1的小，但，多次开辟缓冲区，总内存大小反而需要的更多，结合G1内存分配机制，在内存方面与方案1存在相同问题。\n\n3、由于上述2个方案存在的问题及本身需求只是缩放图片而且，也用不上它们提供的水印之类的方法，因此，自定义了一个仅支持图片压缩能力的工具包\n```\npublic final static ByteArrayOutputStream scale(InputStream srcImageStream, float scale) throws IOException {\n        ByteArrayOutputStream desImageStream = new ByteArrayOutputStream();\n        BufferedImage originalImage = ImageIO.read(srcImageStream);\n        int width = Float.valueOf(scale * originalImage.getWidth()).intValue();\n        int height = Float.valueOf(scale * originalImage.getHeight()).intValue();\n        BufferedImage newImage = new BufferedImage(width, height, originalImage.getType());\n        Graphics g = newImage.getGraphics();\n        g.drawImage(originalImage, 0, 0, width, height, null);\n        g.dispose();\n        ImageIO.write(newImage, \"jpeg\", desImageStream);\n        return desImageStream;\n    }\n ```\n   该方案能在压缩质量得到保证的前提的快速完成压缩，约1s，thumbnailator使用时，约2s。\n    问题来了：功能上去后，发现内存占用率偶尔超过90%，但垃圾回收后又能绝大数回收，（采用G1回收，只额外配置了暂停时间50ms，堆最大值1536M）因此排除内存泄漏的可能，但功能上去之前未曾出现，初步猜测是图片压缩功能引起的（方案1、3都存在问题，推测2也存在），后经本地java visualVM调试发现， 执行一个大小3M多，像素3024*4032的图片压缩时，会有35M多的老年代被直接使用。因此分析问题在于出现了大对象，大对象会直接分配在老年代，于是通过断点测试结合 java visualVM监控，定位到问题在于：\n    ```\n  BufferedImage originalImage = ImageIO.read(srcImageStream);\n    ```\n    此方法创建BufferedImage时，会基于ComponentSampleModel类首先创建数据缓冲区（dataBuffer），而缓冲区大小算法为：\n   ```\n   private int getBufferSize() {\n         int maxBandOff=bandOffsets[0];//jpeg图片，此数组为{2，1，0}\n         for (int i=1; i<bandOffsets.length; i++) {\n             maxBandOff = Math.max(maxBandOff,bandOffsets[i]);\n         }\n         if (maxBandOff < 0 || maxBandOff > (Integer.MAX_VALUE - 1)) {\n             throw new IllegalArgumentException(\"Invalid band offset\");\n         }\n         if (pixelStride < 0 || pixelStride > (Integer.MAX_VALUE / width)) {\n             throw new IllegalArgumentException(\"Invalid pixel stride\");\n         }\n         if (scanlineStride < 0 || scanlineStride > (Integer.MAX_VALUE / height)) {\n             throw new IllegalArgumentException(\"Invalid scanline stride\");\n         }\n         int size = maxBandOff + 1;\n         int val = pixelStride * (width - 1);//pixelStride jpeg图片时，默认为3\n         if (val > (Integer.MAX_VALUE - size)) {\n             throw new IllegalArgumentException(\"Invalid pixel stride\");\n         }\n         size += val;\n         val = scanlineStride * (height - 1);//scanlineStride jpeg图片时，默认为12096\n         if (val > (Integer.MAX_VALUE - size)) {\n             throw new IllegalArgumentException(\"Invalid scan stride\");\n         }\n         size += val;\n         return size;\n     }\n    \n    因此大小为(2+1)+3*(width-1)+12096*(height-1)  god，这是多大的一个内存呀\n    public DataBufferByte(int size, int numBanks) {\n        super(STABLE, TYPE_BYTE, size, numBanks);\n        bankdata = new byte[numBanks][];\n        for (int i= 0; i < numBanks; i++) {\n            bankdata[i] = new byte[size];\n        }\n        data = bankdata[0];\n    }\n    \n    ```\n\n如果整个逻辑处理时间是1s， 那么，可以算一下1s并发量多大，需要配置多大的内存了 ！！！\n\n附：测试数据\n方案1：\n![upload successful](\\images\\pasted-62.png)\n![upload successful](\\images\\pasted-63.png)\n![upload successful](\\images\\pasted-64.png)\n\n方案2：\n![upload successful](\\images\\pasted-68.png)\n![upload successful](\\images\\pasted-69.png)\n![upload successful](\\images\\pasted-70.png)\n![upload successful](\\images\\pasted-71.png)\n![upload successful](\\images\\pasted-72.png)\n![upload successful](\\images\\pasted-73.png)\n方案3：\n![upload successful](\\images\\pasted-65.png)\n![upload successful](\\images\\pasted-66.png)\n![upload successful](\\images\\pasted-67.png)\n","source":"_posts/图片压缩-ImageIO-read-inputStream.md","raw":"title: 图片压缩-ImageIO.read(inputStream)\nauthor: Xiang Chuang\ntags:\n  - 图片压缩\n  - ImageIO\ncategories:\n  - 这些年，那些坑\ndate: 2019-04-11 18:36:00\n---\n本文可结合链接中的文章从GC层面辅助分析！\nhttps://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/\n\n背景：由于目前手机像素越来越富裕，导致用户上传图片时过大3-4M甚至以上，且像素较高，如3024*4032，因此，图片压缩功能就势在必行了。\n\n选型：优先考虑前端压缩，但由于个人对前端无甚兴趣，因此提供了基于java的压缩解决方案。\n\n目前市面上成熟的压缩工具大致为thumbnailator及simpleimage\n1、thumbnailator\n```\n\t<dependency>\n\t\t\t<groupId>net.coobird</groupId>\n\t\t\t<artifactId>thumbnailator</artifactId>\n\t\t\t<version>0.4.8</version>\n  </dependency>\n  ```\n  ```\n  BufferedImage bufferedImage = Thumbnails.of(input).scale(scale).outputQuality(quality).asBufferedImage();\n  ```\n  经过使用发现有背景色变红的问题，未着手解决,同时，内存消耗较大\n  \n2、simpleimage\n参见git\nhttps://github.com/alibaba/simpleimage\n```\n<dependency>\n\t\t\t<groupId>com.sun.media</groupId>\n\t\t\t<artifactId>jai-codec</artifactId>\n\t\t\t<version>1.1.3</version>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>javax.media</groupId>\n\t\t\t<artifactId>jai-core</artifactId>\n\t\t\t<version>1.1.3</version>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>com.alibaba</groupId>\n\t\t\t<artifactId>simpleimage</artifactId>\n\t\t\t<version>1.2.3</version>\n</dependency>            \n```\n```\nFile in = new File(\"d://04092.jpg\");      //原图片\n            ImageWrapper imageWrapper = ImageReadHelper.read(new FileInputStream(in));\n            int witdh = imageWrapper.getWidth();\n            int height = imageWrapper.getHeight();\n            File out = new File(\"d://04092-after.jpg\");       //目的图片\n            ScaleParameter scaleParam = new ScaleParameter(Float.valueOf(witdh * 0.5f).intValue()\n                    , Float.valueOf(height * 0.5f).intValue());\n            WriteParameter writeParam = new WriteParameter();\n\n            FileInputStream inStream = null;\n            FileOutputStream outStream = null;\n            ImageRender wr = null;\n            inStream = new FileInputStream(in);\n            outStream = new FileOutputStream(out);\n            ImageRender rr = new ReadRender(inStream);\n            ImageRender sr = new ScaleRender(rr, scaleParam);\n            wr = new WriteRender(sr, outStream, ImageFormat.JPEG, writeParam);\n\n            wr.render();                            //触发图像处理\n```\n```\nWriteRender.render()源码：\n @Override\n    public ImageWrapper render() throws SimpleImageException {\n        try {\n            if (image == null) {\n                image = imageRender.render();//此处读取原文件，大对象\n            }\n\n            ImageWriteHelper.write(image, stream, outputFormat, param);//写文件，数据缓冲区分段初始化，一个按压缩后图片像素大小生产，外加若干512*512及1024*1024的缓冲区，因此需要更多的内存\n        } catch (Exception e) {\n            throw new SimpleImageException(e);\n        }\n\n        return null;\n    }\n```\n```\nReadRender.render源码， WriteRender中需要首先依赖此类读取原文件\n@Override\n    public ImageWrapper render() throws SimpleImageException {\n        try {\n            ImageWrapper imgWrapper;\n            if (inStream == null) {\n                throw new SimpleImageException(\"No input set\");\n            }\n\n            imgWrapper = ImageReadHelper.read(inStream);\n\n            if (tosRGBColorSpace) {\n                for (int i = 0; i < imgWrapper.getNumOfImages(); i++) {\n                    PlanarImage img = ImageColorConvertHelper.convert2sRGB(imgWrapper\n                            .getAsPlanarImage(i));\n                    imgWrapper.setImage(i, img);\n                }\n            }\n\n            return imgWrapper;\n        } catch (Exception e) {\n            throw new SimpleImageException(e);\n        }\n    }\n    \n    ImageReadHelper.read(inStream)：\n    public static ImageWrapper read(InputStream input)\n            throws SimpleImageException {\n        try {\n            input = ImageUtils.createMemoryStream(input);//流拷贝，增加了内存使用\n\n            if (ImageUtils.isJPEG(input)) {\n                return readJPEG(input);//此处耗内存\n            }\n\n            if (ImageUtils.isGIF(input)) {\n                return readGIF(input);\n            }\n\n            return readGeneral(input);\n        } catch (Exception e) {\n            throw new SimpleImageException(e);\n        }\n    }\n```\n由于simpleimage在read及write阶段做了额外操作，使得单次开辟的大对象比方案1的小，但，多次开辟缓冲区，总内存大小反而需要的更多，结合G1内存分配机制，在内存方面与方案1存在相同问题。\n\n3、由于上述2个方案存在的问题及本身需求只是缩放图片而且，也用不上它们提供的水印之类的方法，因此，自定义了一个仅支持图片压缩能力的工具包\n```\npublic final static ByteArrayOutputStream scale(InputStream srcImageStream, float scale) throws IOException {\n        ByteArrayOutputStream desImageStream = new ByteArrayOutputStream();\n        BufferedImage originalImage = ImageIO.read(srcImageStream);\n        int width = Float.valueOf(scale * originalImage.getWidth()).intValue();\n        int height = Float.valueOf(scale * originalImage.getHeight()).intValue();\n        BufferedImage newImage = new BufferedImage(width, height, originalImage.getType());\n        Graphics g = newImage.getGraphics();\n        g.drawImage(originalImage, 0, 0, width, height, null);\n        g.dispose();\n        ImageIO.write(newImage, \"jpeg\", desImageStream);\n        return desImageStream;\n    }\n ```\n   该方案能在压缩质量得到保证的前提的快速完成压缩，约1s，thumbnailator使用时，约2s。\n    问题来了：功能上去后，发现内存占用率偶尔超过90%，但垃圾回收后又能绝大数回收，（采用G1回收，只额外配置了暂停时间50ms，堆最大值1536M）因此排除内存泄漏的可能，但功能上去之前未曾出现，初步猜测是图片压缩功能引起的（方案1、3都存在问题，推测2也存在），后经本地java visualVM调试发现， 执行一个大小3M多，像素3024*4032的图片压缩时，会有35M多的老年代被直接使用。因此分析问题在于出现了大对象，大对象会直接分配在老年代，于是通过断点测试结合 java visualVM监控，定位到问题在于：\n    ```\n  BufferedImage originalImage = ImageIO.read(srcImageStream);\n    ```\n    此方法创建BufferedImage时，会基于ComponentSampleModel类首先创建数据缓冲区（dataBuffer），而缓冲区大小算法为：\n   ```\n   private int getBufferSize() {\n         int maxBandOff=bandOffsets[0];//jpeg图片，此数组为{2，1，0}\n         for (int i=1; i<bandOffsets.length; i++) {\n             maxBandOff = Math.max(maxBandOff,bandOffsets[i]);\n         }\n         if (maxBandOff < 0 || maxBandOff > (Integer.MAX_VALUE - 1)) {\n             throw new IllegalArgumentException(\"Invalid band offset\");\n         }\n         if (pixelStride < 0 || pixelStride > (Integer.MAX_VALUE / width)) {\n             throw new IllegalArgumentException(\"Invalid pixel stride\");\n         }\n         if (scanlineStride < 0 || scanlineStride > (Integer.MAX_VALUE / height)) {\n             throw new IllegalArgumentException(\"Invalid scanline stride\");\n         }\n         int size = maxBandOff + 1;\n         int val = pixelStride * (width - 1);//pixelStride jpeg图片时，默认为3\n         if (val > (Integer.MAX_VALUE - size)) {\n             throw new IllegalArgumentException(\"Invalid pixel stride\");\n         }\n         size += val;\n         val = scanlineStride * (height - 1);//scanlineStride jpeg图片时，默认为12096\n         if (val > (Integer.MAX_VALUE - size)) {\n             throw new IllegalArgumentException(\"Invalid scan stride\");\n         }\n         size += val;\n         return size;\n     }\n    \n    因此大小为(2+1)+3*(width-1)+12096*(height-1)  god，这是多大的一个内存呀\n    public DataBufferByte(int size, int numBanks) {\n        super(STABLE, TYPE_BYTE, size, numBanks);\n        bankdata = new byte[numBanks][];\n        for (int i= 0; i < numBanks; i++) {\n            bankdata[i] = new byte[size];\n        }\n        data = bankdata[0];\n    }\n    \n    ```\n\n如果整个逻辑处理时间是1s， 那么，可以算一下1s并发量多大，需要配置多大的内存了 ！！！\n\n附：测试数据\n方案1：\n![upload successful](\\images\\pasted-62.png)\n![upload successful](\\images\\pasted-63.png)\n![upload successful](\\images\\pasted-64.png)\n\n方案2：\n![upload successful](\\images\\pasted-68.png)\n![upload successful](\\images\\pasted-69.png)\n![upload successful](\\images\\pasted-70.png)\n![upload successful](\\images\\pasted-71.png)\n![upload successful](\\images\\pasted-72.png)\n![upload successful](\\images\\pasted-73.png)\n方案3：\n![upload successful](\\images\\pasted-65.png)\n![upload successful](\\images\\pasted-66.png)\n![upload successful](\\images\\pasted-67.png)\n","slug":"图片压缩-ImageIO-read-inputStream","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc0002xwy66eij320sg","content":"<p>本文可结合链接中的文章从GC层面辅助分析！<br><a href=\"https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/\">https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/</a></p>\n<p>背景：由于目前手机像素越来越富裕，导致用户上传图片时过大3-4M甚至以上，且像素较高，如3024*4032，因此，图片压缩功能就势在必行了。</p>\n<p>选型：优先考虑前端压缩，但由于个人对前端无甚兴趣，因此提供了基于java的压缩解决方案。</p>\n<p>目前市面上成熟的压缩工具大致为thumbnailator及simpleimage<br>1、thumbnailator<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">\t\t&lt;groupId&gt;net.coobird&lt;/groupId&gt;</span><br><span class=\"line\">\t\t&lt;artifactId&gt;thumbnailator&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t&lt;version&gt;0.4.8&lt;/version&gt;</span><br><span class=\"line\"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BufferedImage bufferedImage = Thumbnails.of(input).scale(scale).outputQuality(quality).asBufferedImage();</span><br></pre></td></tr></table></figure><br>  经过使用发现有背景色变红的问题，未着手解决,同时，内存消耗较大</p>\n<p>2、simpleimage<br>参见git<br><a href=\"https://github.com/alibaba/simpleimage\">https://github.com/alibaba/simpleimage</a><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;com.sun.media&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;jai-codec&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;javax.media&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;jai-core&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;simpleimage&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;1.2.3&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;            </span><br></pre></td></tr></table></figure><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">File in = new File(&quot;d://04092.jpg&quot;);      //原图片</span><br><span class=\"line\">            ImageWrapper imageWrapper = ImageReadHelper.read(new FileInputStream(in));</span><br><span class=\"line\">            int witdh = imageWrapper.getWidth();</span><br><span class=\"line\">            int height = imageWrapper.getHeight();</span><br><span class=\"line\">            File out = new File(&quot;d://04092-after.jpg&quot;);       //目的图片</span><br><span class=\"line\">            ScaleParameter scaleParam = new ScaleParameter(Float.valueOf(witdh * 0.5f).intValue()</span><br><span class=\"line\">                    , Float.valueOf(height * 0.5f).intValue());</span><br><span class=\"line\">            WriteParameter writeParam = new WriteParameter();</span><br><span class=\"line\"></span><br><span class=\"line\">            FileInputStream inStream = null;</span><br><span class=\"line\">            FileOutputStream outStream = null;</span><br><span class=\"line\">            ImageRender wr = null;</span><br><span class=\"line\">            inStream = new FileInputStream(in);</span><br><span class=\"line\">            outStream = new FileOutputStream(out);</span><br><span class=\"line\">            ImageRender rr = new ReadRender(inStream);</span><br><span class=\"line\">            ImageRender sr = new ScaleRender(rr, scaleParam);</span><br><span class=\"line\">            wr = new WriteRender(sr, outStream, ImageFormat.JPEG, writeParam);</span><br><span class=\"line\"></span><br><span class=\"line\">            wr.render();                            //触发图像处理</span><br></pre></td></tr></table></figure><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WriteRender.render()源码：</span><br><span class=\"line\"> @Override</span><br><span class=\"line\">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            if (image == null) &#123;</span><br><span class=\"line\">                image = imageRender.render();//此处读取原文件，大对象</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            ImageWriteHelper.write(image, stream, outputFormat, param);//写文件，数据缓冲区分段初始化，一个按压缩后图片像素大小生产，外加若干512*512及1024*1024的缓冲区，因此需要更多的内存</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            throw new SimpleImageException(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        return null;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ReadRender.render源码， WriteRender中需要首先依赖此类读取原文件</span><br><span class=\"line\">@Override</span><br><span class=\"line\">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            ImageWrapper imgWrapper;</span><br><span class=\"line\">            if (inStream == null) &#123;</span><br><span class=\"line\">                throw new SimpleImageException(&quot;No input set&quot;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            imgWrapper = ImageReadHelper.read(inStream);</span><br><span class=\"line\"></span><br><span class=\"line\">            if (tosRGBColorSpace) &#123;</span><br><span class=\"line\">                for (int i = 0; i &lt; imgWrapper.getNumOfImages(); i++) &#123;</span><br><span class=\"line\">                    PlanarImage img = ImageColorConvertHelper.convert2sRGB(imgWrapper</span><br><span class=\"line\">                            .getAsPlanarImage(i));</span><br><span class=\"line\">                    imgWrapper.setImage(i, img);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            return imgWrapper;</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            throw new SimpleImageException(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    ImageReadHelper.read(inStream)：</span><br><span class=\"line\">    public static ImageWrapper read(InputStream input)</span><br><span class=\"line\">            throws SimpleImageException &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            input = ImageUtils.createMemoryStream(input);//流拷贝，增加了内存使用</span><br><span class=\"line\"></span><br><span class=\"line\">            if (ImageUtils.isJPEG(input)) &#123;</span><br><span class=\"line\">                return readJPEG(input);//此处耗内存</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            if (ImageUtils.isGIF(input)) &#123;</span><br><span class=\"line\">                return readGIF(input);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            return readGeneral(input);</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            throw new SimpleImageException(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br>由于simpleimage在read及write阶段做了额外操作，使得单次开辟的大对象比方案1的小，但，多次开辟缓冲区，总内存大小反而需要的更多，结合G1内存分配机制，在内存方面与方案1存在相同问题。</p>\n<p>3、由于上述2个方案存在的问题及本身需求只是缩放图片而且，也用不上它们提供的水印之类的方法，因此，自定义了一个仅支持图片压缩能力的工具包<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public final static ByteArrayOutputStream scale(InputStream srcImageStream, float scale) throws IOException &#123;</span><br><span class=\"line\">        ByteArrayOutputStream desImageStream = new ByteArrayOutputStream();</span><br><span class=\"line\">        BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br><span class=\"line\">        int width = Float.valueOf(scale * originalImage.getWidth()).intValue();</span><br><span class=\"line\">        int height = Float.valueOf(scale * originalImage.getHeight()).intValue();</span><br><span class=\"line\">        BufferedImage newImage = new BufferedImage(width, height, originalImage.getType());</span><br><span class=\"line\">        Graphics g = newImage.getGraphics();</span><br><span class=\"line\">        g.drawImage(originalImage, 0, 0, width, height, null);</span><br><span class=\"line\">        g.dispose();</span><br><span class=\"line\">        ImageIO.write(newImage, &quot;jpeg&quot;, desImageStream);</span><br><span class=\"line\">        return desImageStream;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br>   该方案能在压缩质量得到保证的前提的快速完成压缩，约1s，thumbnailator使用时，约2s。<br>    问题来了：功能上去后，发现内存占用率偶尔超过90%，但垃圾回收后又能绝大数回收，（采用G1回收，只额外配置了暂停时间50ms，堆最大值1536M）因此排除内存泄漏的可能，但功能上去之前未曾出现，初步猜测是图片压缩功能引起的（方案1、3都存在问题，推测2也存在），后经本地java visualVM调试发现， 执行一个大小3M多，像素3024*4032的图片压缩时，会有35M多的老年代被直接使用。因此分析问题在于出现了大对象，大对象会直接分配在老年代，于是通过断点测试结合 java visualVM监控，定位到问题在于：<br>    <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br></pre></td></tr></table></figure><br>    此方法创建BufferedImage时，会基于ComponentSampleModel类首先创建数据缓冲区（dataBuffer），而缓冲区大小算法为：<br>   <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private int getBufferSize() &#123;</span><br><span class=\"line\">      int maxBandOff=bandOffsets[0];//jpeg图片，此数组为&#123;2，1，0&#125;</span><br><span class=\"line\">      for (int i=1; i&lt;bandOffsets.length; i++) &#123;</span><br><span class=\"line\">          maxBandOff = Math.max(maxBandOff,bandOffsets[i]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (maxBandOff &lt; 0 || maxBandOff &gt; (Integer.MAX_VALUE - 1)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid band offset&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (pixelStride &lt; 0 || pixelStride &gt; (Integer.MAX_VALUE / width)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (scanlineStride &lt; 0 || scanlineStride &gt; (Integer.MAX_VALUE / height)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid scanline stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      int size = maxBandOff + 1;</span><br><span class=\"line\">      int val = pixelStride * (width - 1);//pixelStride jpeg图片时，默认为3</span><br><span class=\"line\">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      size += val;</span><br><span class=\"line\">      val = scanlineStride * (height - 1);//scanlineStride jpeg图片时，默认为12096</span><br><span class=\"line\">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid scan stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      size += val;</span><br><span class=\"line\">      return size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> 因此大小为(2+1)+3*(width-1)+12096*(height-1)  god，这是多大的一个内存呀</span><br><span class=\"line\"> public DataBufferByte(int size, int numBanks) &#123;</span><br><span class=\"line\">     super(STABLE, TYPE_BYTE, size, numBanks);</span><br><span class=\"line\">     bankdata = new byte[numBanks][];</span><br><span class=\"line\">     for (int i= 0; i &lt; numBanks; i++) &#123;</span><br><span class=\"line\">         bankdata[i] = new byte[size];</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     data = bankdata[0];</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure></p>\n<p>如果整个逻辑处理时间是1s， 那么，可以算一下1s并发量多大，需要配置多大的内存了 ！！！</p>\n<p>附：测试数据<br>方案1：<br><img src=\"\\images\\pasted-62.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-63.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-64.png\" alt=\"upload successful\"></p>\n<p>方案2：<br><img src=\"\\images\\pasted-68.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-69.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-70.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-71.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-72.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-73.png\" alt=\"upload successful\"><br>方案3：<br><img src=\"\\images\\pasted-65.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-66.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-67.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":6011,"excerpt":"","more":"<p>本文可结合链接中的文章从GC层面辅助分析！<br><a href=\"https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/\">https://realxc.github.io/2019/04/09/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8-xx-initiatingheapoccupancypercent%E5%8F%98%E9%87%8F%E4%B9%8B%E9%97%AE/</a></p>\n<p>背景：由于目前手机像素越来越富裕，导致用户上传图片时过大3-4M甚至以上，且像素较高，如3024*4032，因此，图片压缩功能就势在必行了。</p>\n<p>选型：优先考虑前端压缩，但由于个人对前端无甚兴趣，因此提供了基于java的压缩解决方案。</p>\n<p>目前市面上成熟的压缩工具大致为thumbnailator及simpleimage<br>1、thumbnailator<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">\t\t&lt;groupId&gt;net.coobird&lt;/groupId&gt;</span><br><span class=\"line\">\t\t&lt;artifactId&gt;thumbnailator&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t&lt;version&gt;0.4.8&lt;/version&gt;</span><br><span class=\"line\"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BufferedImage bufferedImage = Thumbnails.of(input).scale(scale).outputQuality(quality).asBufferedImage();</span><br></pre></td></tr></table></figure><br>  经过使用发现有背景色变红的问题，未着手解决,同时，内存消耗较大</p>\n<p>2、simpleimage<br>参见git<br><a href=\"https://github.com/alibaba/simpleimage\">https://github.com/alibaba/simpleimage</a><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;com.sun.media&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;jai-codec&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;javax.media&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;jai-core&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;1.1.3&lt;/version&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;simpleimage&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;1.2.3&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;            </span><br></pre></td></tr></table></figure><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">File in = new File(&quot;d://04092.jpg&quot;);      //原图片</span><br><span class=\"line\">            ImageWrapper imageWrapper = ImageReadHelper.read(new FileInputStream(in));</span><br><span class=\"line\">            int witdh = imageWrapper.getWidth();</span><br><span class=\"line\">            int height = imageWrapper.getHeight();</span><br><span class=\"line\">            File out = new File(&quot;d://04092-after.jpg&quot;);       //目的图片</span><br><span class=\"line\">            ScaleParameter scaleParam = new ScaleParameter(Float.valueOf(witdh * 0.5f).intValue()</span><br><span class=\"line\">                    , Float.valueOf(height * 0.5f).intValue());</span><br><span class=\"line\">            WriteParameter writeParam = new WriteParameter();</span><br><span class=\"line\"></span><br><span class=\"line\">            FileInputStream inStream = null;</span><br><span class=\"line\">            FileOutputStream outStream = null;</span><br><span class=\"line\">            ImageRender wr = null;</span><br><span class=\"line\">            inStream = new FileInputStream(in);</span><br><span class=\"line\">            outStream = new FileOutputStream(out);</span><br><span class=\"line\">            ImageRender rr = new ReadRender(inStream);</span><br><span class=\"line\">            ImageRender sr = new ScaleRender(rr, scaleParam);</span><br><span class=\"line\">            wr = new WriteRender(sr, outStream, ImageFormat.JPEG, writeParam);</span><br><span class=\"line\"></span><br><span class=\"line\">            wr.render();                            //触发图像处理</span><br></pre></td></tr></table></figure><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WriteRender.render()源码：</span><br><span class=\"line\"> @Override</span><br><span class=\"line\">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            if (image == null) &#123;</span><br><span class=\"line\">                image = imageRender.render();//此处读取原文件，大对象</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            ImageWriteHelper.write(image, stream, outputFormat, param);//写文件，数据缓冲区分段初始化，一个按压缩后图片像素大小生产，外加若干512*512及1024*1024的缓冲区，因此需要更多的内存</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            throw new SimpleImageException(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        return null;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ReadRender.render源码， WriteRender中需要首先依赖此类读取原文件</span><br><span class=\"line\">@Override</span><br><span class=\"line\">    public ImageWrapper render() throws SimpleImageException &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            ImageWrapper imgWrapper;</span><br><span class=\"line\">            if (inStream == null) &#123;</span><br><span class=\"line\">                throw new SimpleImageException(&quot;No input set&quot;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            imgWrapper = ImageReadHelper.read(inStream);</span><br><span class=\"line\"></span><br><span class=\"line\">            if (tosRGBColorSpace) &#123;</span><br><span class=\"line\">                for (int i = 0; i &lt; imgWrapper.getNumOfImages(); i++) &#123;</span><br><span class=\"line\">                    PlanarImage img = ImageColorConvertHelper.convert2sRGB(imgWrapper</span><br><span class=\"line\">                            .getAsPlanarImage(i));</span><br><span class=\"line\">                    imgWrapper.setImage(i, img);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            return imgWrapper;</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            throw new SimpleImageException(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    ImageReadHelper.read(inStream)：</span><br><span class=\"line\">    public static ImageWrapper read(InputStream input)</span><br><span class=\"line\">            throws SimpleImageException &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            input = ImageUtils.createMemoryStream(input);//流拷贝，增加了内存使用</span><br><span class=\"line\"></span><br><span class=\"line\">            if (ImageUtils.isJPEG(input)) &#123;</span><br><span class=\"line\">                return readJPEG(input);//此处耗内存</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            if (ImageUtils.isGIF(input)) &#123;</span><br><span class=\"line\">                return readGIF(input);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            return readGeneral(input);</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            throw new SimpleImageException(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br>由于simpleimage在read及write阶段做了额外操作，使得单次开辟的大对象比方案1的小，但，多次开辟缓冲区，总内存大小反而需要的更多，结合G1内存分配机制，在内存方面与方案1存在相同问题。</p>\n<p>3、由于上述2个方案存在的问题及本身需求只是缩放图片而且，也用不上它们提供的水印之类的方法，因此，自定义了一个仅支持图片压缩能力的工具包<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public final static ByteArrayOutputStream scale(InputStream srcImageStream, float scale) throws IOException &#123;</span><br><span class=\"line\">        ByteArrayOutputStream desImageStream = new ByteArrayOutputStream();</span><br><span class=\"line\">        BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br><span class=\"line\">        int width = Float.valueOf(scale * originalImage.getWidth()).intValue();</span><br><span class=\"line\">        int height = Float.valueOf(scale * originalImage.getHeight()).intValue();</span><br><span class=\"line\">        BufferedImage newImage = new BufferedImage(width, height, originalImage.getType());</span><br><span class=\"line\">        Graphics g = newImage.getGraphics();</span><br><span class=\"line\">        g.drawImage(originalImage, 0, 0, width, height, null);</span><br><span class=\"line\">        g.dispose();</span><br><span class=\"line\">        ImageIO.write(newImage, &quot;jpeg&quot;, desImageStream);</span><br><span class=\"line\">        return desImageStream;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br>   该方案能在压缩质量得到保证的前提的快速完成压缩，约1s，thumbnailator使用时，约2s。<br>    问题来了：功能上去后，发现内存占用率偶尔超过90%，但垃圾回收后又能绝大数回收，（采用G1回收，只额外配置了暂停时间50ms，堆最大值1536M）因此排除内存泄漏的可能，但功能上去之前未曾出现，初步猜测是图片压缩功能引起的（方案1、3都存在问题，推测2也存在），后经本地java visualVM调试发现， 执行一个大小3M多，像素3024*4032的图片压缩时，会有35M多的老年代被直接使用。因此分析问题在于出现了大对象，大对象会直接分配在老年代，于是通过断点测试结合 java visualVM监控，定位到问题在于：<br>    <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BufferedImage originalImage = ImageIO.read(srcImageStream);</span><br></pre></td></tr></table></figure><br>    此方法创建BufferedImage时，会基于ComponentSampleModel类首先创建数据缓冲区（dataBuffer），而缓冲区大小算法为：<br>   <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private int getBufferSize() &#123;</span><br><span class=\"line\">      int maxBandOff=bandOffsets[0];//jpeg图片，此数组为&#123;2，1，0&#125;</span><br><span class=\"line\">      for (int i=1; i&lt;bandOffsets.length; i++) &#123;</span><br><span class=\"line\">          maxBandOff = Math.max(maxBandOff,bandOffsets[i]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (maxBandOff &lt; 0 || maxBandOff &gt; (Integer.MAX_VALUE - 1)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid band offset&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (pixelStride &lt; 0 || pixelStride &gt; (Integer.MAX_VALUE / width)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (scanlineStride &lt; 0 || scanlineStride &gt; (Integer.MAX_VALUE / height)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid scanline stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      int size = maxBandOff + 1;</span><br><span class=\"line\">      int val = pixelStride * (width - 1);//pixelStride jpeg图片时，默认为3</span><br><span class=\"line\">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid pixel stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      size += val;</span><br><span class=\"line\">      val = scanlineStride * (height - 1);//scanlineStride jpeg图片时，默认为12096</span><br><span class=\"line\">      if (val &gt; (Integer.MAX_VALUE - size)) &#123;</span><br><span class=\"line\">          throw new IllegalArgumentException(&quot;Invalid scan stride&quot;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      size += val;</span><br><span class=\"line\">      return size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> 因此大小为(2+1)+3*(width-1)+12096*(height-1)  god，这是多大的一个内存呀</span><br><span class=\"line\"> public DataBufferByte(int size, int numBanks) &#123;</span><br><span class=\"line\">     super(STABLE, TYPE_BYTE, size, numBanks);</span><br><span class=\"line\">     bankdata = new byte[numBanks][];</span><br><span class=\"line\">     for (int i= 0; i &lt; numBanks; i++) &#123;</span><br><span class=\"line\">         bankdata[i] = new byte[size];</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     data = bankdata[0];</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure></p>\n<p>如果整个逻辑处理时间是1s， 那么，可以算一下1s并发量多大，需要配置多大的内存了 ！！！</p>\n<p>附：测试数据<br>方案1：<br><img src=\"\\images\\pasted-62.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-63.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-64.png\" alt=\"upload successful\"></p>\n<p>方案2：<br><img src=\"\\images\\pasted-68.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-69.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-70.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-71.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-72.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-73.png\" alt=\"upload successful\"><br>方案3：<br><img src=\"\\images\\pasted-65.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-66.png\" alt=\"upload successful\"><br><img src=\"\\images\\pasted-67.png\" alt=\"upload successful\"></p>\n"},{"title":"应用停机-优雅停机问题","author":"Xiang Chuang","date":"2018-07-17T06:28:00.000Z","_content":"优雅停机问题，new对象的时候，应用classloader可能已经关闭了哦！\n\nTomcatEmbeddedWebappClassLoader\n  context: ROOT\n  delegate: true\n----------> Parent Classloader:\nsun.misc.Launcher$AppClassLoader@14dad5dc\n\n![upload successful](\\images\\pasted-19.png)\n\n![upload successful](\\images\\pasted-20.png)\n\n![upload successful](\\images\\pasted-21.png)\n\n理论分析：\nspring-boot启动：\n1、new SpringApplication(Main.class).run(args);\n     1.1、加载SpringApplicationRunListeners并执行started()\n     1.2、createAndRefreshContext \n            1.2.1、Create and configure the environment\n            1.2.2、Create, load, refresh and run the ApplicationContext                                        【org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext】\n            1.2.3、Add boot specific singleton beans->springApplicationArguments\n            1.2.4、Load the sources->Main方法\n            1.2.5、SpringApplicationRunListeners执行contextLoaded\n            1.2.6、Refresh the context->AbstractApplicationContext\n                        1.2.6.1、Prepare this context for refreshing.\n                        1.2.6.2、Tell the subclass to refresh the internal bean factory.\n                        1.2.6.3、Prepare the bean factory for use in this context.\n                        1.2.6.4、Allows post-processing of the bean factory in context subclasses.\n                   【org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer】\n                        1.2.6.5、Invoke factory processors registered as beans in the context.\n                        1.2.6.6、Register bean processors that intercept bean creation.\n                        1.2.6.7、Initialize message source for this context.\n                        1.2.6.8、Initialize event multicaster for this context.\n                        1.2.6.9、Initialize other special beans in specific context subclasses.\n                        1.2.6.10、Check for listener beans and register them.\n                        1.2.6.11、Instantiate all remaining (non-lazy-init) singletons.\n                        1.2.6.12、Last step: publish corresponding event.\n                        1.2.7、registerShutdownHook（注册jvm关闭钩子，钩子执行AbstractApplicationContext.doClose()）\n        1.3、call finished listener（可以做自己的事哦，yijiboot在这里就注册系统关闭钩子）\n        eg:com.yiji.boot.core.listener.YijiApplicationRunListener \n        new ShutdownThread().register();  ->shutdownApp();\n\nspring-boot关闭： AbstractApplicationContext.doClose()\n    1、Publish shutdown event.\n        earlyApplicationEvents（里面对应的事件，延迟执行）\n        eg：我们配置的dubbo关闭钩子就是同步执行的\n    2、Stop all Lifecycle beans, to avoid delays during individual destruction.\n    3、Destroy all cached singletons in the context's BeanFactory.\n    4、Close the state of this context itself.\n    5、Let subclasses do some final clean-up if they wish...\n    【org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.doClose()】\n![upload successful](\\images\\pasted-22.png)\n18.07.12\n又出问题啦\n自主化发布时，直接替换项目包，项目自动重启了，且，没有消费掉dubbo\n\n经分析：\n账务系统采用的依旧是war包的方式，部署在tomcat容器的。\n\n因此，替换war包后，项目自动重启，首先关闭tomcat容器，calssloader注销，然后注销springbean（这时候就出问题啦，因此某些bean已经不存在，不可使用）\n![upload successful](\\images\\pasted-23.png)","source":"_posts/应用停机-优雅停机问题.md","raw":"title: 应用停机-优雅停机问题\nauthor: Xiang Chuang\ntags:\n  - 优雅停机\ncategories:\n  - 这些年，那些坑\ndate: 2018-07-17 14:28:00\n---\n优雅停机问题，new对象的时候，应用classloader可能已经关闭了哦！\n\nTomcatEmbeddedWebappClassLoader\n  context: ROOT\n  delegate: true\n----------> Parent Classloader:\nsun.misc.Launcher$AppClassLoader@14dad5dc\n\n![upload successful](\\images\\pasted-19.png)\n\n![upload successful](\\images\\pasted-20.png)\n\n![upload successful](\\images\\pasted-21.png)\n\n理论分析：\nspring-boot启动：\n1、new SpringApplication(Main.class).run(args);\n     1.1、加载SpringApplicationRunListeners并执行started()\n     1.2、createAndRefreshContext \n            1.2.1、Create and configure the environment\n            1.2.2、Create, load, refresh and run the ApplicationContext                                        【org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext】\n            1.2.3、Add boot specific singleton beans->springApplicationArguments\n            1.2.4、Load the sources->Main方法\n            1.2.5、SpringApplicationRunListeners执行contextLoaded\n            1.2.6、Refresh the context->AbstractApplicationContext\n                        1.2.6.1、Prepare this context for refreshing.\n                        1.2.6.2、Tell the subclass to refresh the internal bean factory.\n                        1.2.6.3、Prepare the bean factory for use in this context.\n                        1.2.6.4、Allows post-processing of the bean factory in context subclasses.\n                   【org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer】\n                        1.2.6.5、Invoke factory processors registered as beans in the context.\n                        1.2.6.6、Register bean processors that intercept bean creation.\n                        1.2.6.7、Initialize message source for this context.\n                        1.2.6.8、Initialize event multicaster for this context.\n                        1.2.6.9、Initialize other special beans in specific context subclasses.\n                        1.2.6.10、Check for listener beans and register them.\n                        1.2.6.11、Instantiate all remaining (non-lazy-init) singletons.\n                        1.2.6.12、Last step: publish corresponding event.\n                        1.2.7、registerShutdownHook（注册jvm关闭钩子，钩子执行AbstractApplicationContext.doClose()）\n        1.3、call finished listener（可以做自己的事哦，yijiboot在这里就注册系统关闭钩子）\n        eg:com.yiji.boot.core.listener.YijiApplicationRunListener \n        new ShutdownThread().register();  ->shutdownApp();\n\nspring-boot关闭： AbstractApplicationContext.doClose()\n    1、Publish shutdown event.\n        earlyApplicationEvents（里面对应的事件，延迟执行）\n        eg：我们配置的dubbo关闭钩子就是同步执行的\n    2、Stop all Lifecycle beans, to avoid delays during individual destruction.\n    3、Destroy all cached singletons in the context's BeanFactory.\n    4、Close the state of this context itself.\n    5、Let subclasses do some final clean-up if they wish...\n    【org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.doClose()】\n![upload successful](\\images\\pasted-22.png)\n18.07.12\n又出问题啦\n自主化发布时，直接替换项目包，项目自动重启了，且，没有消费掉dubbo\n\n经分析：\n账务系统采用的依旧是war包的方式，部署在tomcat容器的。\n\n因此，替换war包后，项目自动重启，首先关闭tomcat容器，calssloader注销，然后注销springbean（这时候就出问题啦，因此某些bean已经不存在，不可使用）\n![upload successful](\\images\\pasted-23.png)","slug":"应用停机-优雅停机问题","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc10031wy66fmhh9wkt","content":"<p>优雅停机问题，new对象的时候，应用classloader可能已经关闭了哦！</p>\n<p>TomcatEmbeddedWebappClassLoader<br>  context: ROOT<br>  delegate: true<br>———-&gt; Parent Classloader:<br>sun.misc.Launcher$AppClassLoader@14dad5dc</p>\n<p><img src=\"\\images\\pasted-19.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-20.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-21.png\" alt=\"upload successful\"></p>\n<p>理论分析：<br>spring-boot启动：<br>1、new SpringApplication(Main.class).run(args);<br>     1.1、加载SpringApplicationRunListeners并执行started()<br>     1.2、createAndRefreshContext<br>            1.2.1、Create and configure the environment<br>            1.2.2、Create, load, refresh and run the ApplicationContext                                        【org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext】<br>            1.2.3、Add boot specific singleton beans-&gt;springApplicationArguments<br>            1.2.4、Load the sources-&gt;Main方法<br>            1.2.5、SpringApplicationRunListeners执行contextLoaded<br>            1.2.6、Refresh the context-&gt;AbstractApplicationContext<br>                        1.2.6.1、Prepare this context for refreshing.<br>                        1.2.6.2、Tell the subclass to refresh the internal bean factory.<br>                        1.2.6.3、Prepare the bean factory for use in this context.<br>                        1.2.6.4、Allows post-processing of the bean factory in context subclasses.<br>                   【org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer】<br>                        1.2.6.5、Invoke factory processors registered as beans in the context.<br>                        1.2.6.6、Register bean processors that intercept bean creation.<br>                        1.2.6.7、Initialize message source for this context.<br>                        1.2.6.8、Initialize event multicaster for this context.<br>                        1.2.6.9、Initialize other special beans in specific context subclasses.<br>                        1.2.6.10、Check for listener beans and register them.<br>                        1.2.6.11、Instantiate all remaining (non-lazy-init) singletons.<br>                        1.2.6.12、Last step: publish corresponding event.<br>                        1.2.7、registerShutdownHook（注册jvm关闭钩子，钩子执行AbstractApplicationContext.doClose()）<br>        1.3、call finished listener（可以做自己的事哦，yijiboot在这里就注册系统关闭钩子）<br>        eg:com.yiji.boot.core.listener.YijiApplicationRunListener<br>        new ShutdownThread().register();  -&gt;shutdownApp();</p>\n<p>spring-boot关闭： AbstractApplicationContext.doClose()<br>    1、Publish shutdown event.<br>        earlyApplicationEvents（里面对应的事件，延迟执行）<br>        eg：我们配置的dubbo关闭钩子就是同步执行的<br>    2、Stop all Lifecycle beans, to avoid delays during individual destruction.<br>    3、Destroy all cached singletons in the context’s BeanFactory.<br>    4、Close the state of this context itself.<br>    5、Let subclasses do some final clean-up if they wish…<br>    【org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.doClose()】<br><img src=\"\\images\\pasted-22.png\" alt=\"upload successful\"><br>18.07.12<br>又出问题啦<br>自主化发布时，直接替换项目包，项目自动重启了，且，没有消费掉dubbo</p>\n<p>经分析：<br>账务系统采用的依旧是war包的方式，部署在tomcat容器的。</p>\n<p>因此，替换war包后，项目自动重启，首先关闭tomcat容器，calssloader注销，然后注销springbean（这时候就出问题啦，因此某些bean已经不存在，不可使用）<br><img src=\"\\images\\pasted-23.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":2218,"excerpt":"","more":"<p>优雅停机问题，new对象的时候，应用classloader可能已经关闭了哦！</p>\n<p>TomcatEmbeddedWebappClassLoader<br>  context: ROOT<br>  delegate: true<br>———-&gt; Parent Classloader:<br>sun.misc.Launcher$AppClassLoader@14dad5dc</p>\n<p><img src=\"\\images\\pasted-19.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-20.png\" alt=\"upload successful\"></p>\n<p><img src=\"\\images\\pasted-21.png\" alt=\"upload successful\"></p>\n<p>理论分析：<br>spring-boot启动：<br>1、new SpringApplication(Main.class).run(args);<br>     1.1、加载SpringApplicationRunListeners并执行started()<br>     1.2、createAndRefreshContext<br>            1.2.1、Create and configure the environment<br>            1.2.2、Create, load, refresh and run the ApplicationContext                                        【org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext】<br>            1.2.3、Add boot specific singleton beans-&gt;springApplicationArguments<br>            1.2.4、Load the sources-&gt;Main方法<br>            1.2.5、SpringApplicationRunListeners执行contextLoaded<br>            1.2.6、Refresh the context-&gt;AbstractApplicationContext<br>                        1.2.6.1、Prepare this context for refreshing.<br>                        1.2.6.2、Tell the subclass to refresh the internal bean factory.<br>                        1.2.6.3、Prepare the bean factory for use in this context.<br>                        1.2.6.4、Allows post-processing of the bean factory in context subclasses.<br>                   【org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer】<br>                        1.2.6.5、Invoke factory processors registered as beans in the context.<br>                        1.2.6.6、Register bean processors that intercept bean creation.<br>                        1.2.6.7、Initialize message source for this context.<br>                        1.2.6.8、Initialize event multicaster for this context.<br>                        1.2.6.9、Initialize other special beans in specific context subclasses.<br>                        1.2.6.10、Check for listener beans and register them.<br>                        1.2.6.11、Instantiate all remaining (non-lazy-init) singletons.<br>                        1.2.6.12、Last step: publish corresponding event.<br>                        1.2.7、registerShutdownHook（注册jvm关闭钩子，钩子执行AbstractApplicationContext.doClose()）<br>        1.3、call finished listener（可以做自己的事哦，yijiboot在这里就注册系统关闭钩子）<br>        eg:com.yiji.boot.core.listener.YijiApplicationRunListener<br>        new ShutdownThread().register();  -&gt;shutdownApp();</p>\n<p>spring-boot关闭： AbstractApplicationContext.doClose()<br>    1、Publish shutdown event.<br>        earlyApplicationEvents（里面对应的事件，延迟执行）<br>        eg：我们配置的dubbo关闭钩子就是同步执行的<br>    2、Stop all Lifecycle beans, to avoid delays during individual destruction.<br>    3、Destroy all cached singletons in the context’s BeanFactory.<br>    4、Close the state of this context itself.<br>    5、Let subclasses do some final clean-up if they wish…<br>    【org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.doClose()】<br><img src=\"\\images\\pasted-22.png\" alt=\"upload successful\"><br>18.07.12<br>又出问题啦<br>自主化发布时，直接替换项目包，项目自动重启了，且，没有消费掉dubbo</p>\n<p>经分析：<br>账务系统采用的依旧是war包的方式，部署在tomcat容器的。</p>\n<p>因此，替换war包后，项目自动重启，首先关闭tomcat容器，calssloader注销，然后注销springbean（这时候就出问题啦，因此某些bean已经不存在，不可使用）<br><img src=\"\\images\\pasted-23.png\" alt=\"upload successful\"></p>\n"},{"title":"数据库-重启引发的主键问题","author":"Xiang Chuang","date":"2018-07-22T04:04:00.000Z","_content":"问题：cs系统 shut_message  自增主键id变小了。\n\n原因：cs的数据库重启了，但是应用没停止，   mysql重启后，回滚了部分自增id，（亦或者是备库当主库用）\n\n\n业务原因：本以为外网关闭了，定时任务关闭了 不会有交易\n但是，  应用监控检查发邮件了，cs通过mq接收到了请求，连接数据库失败（此时数据库连接不上）。","source":"_posts/数据库-重启引发的主键问题.md","raw":"title: 数据库-重启引发的主键问题\nauthor: Xiang Chuang\ntags:\n  - db\ncategories:\n  - 这些年，那些坑\ndate: 2018-07-22 12:04:00\n---\n问题：cs系统 shut_message  自增主键id变小了。\n\n原因：cs的数据库重启了，但是应用没停止，   mysql重启后，回滚了部分自增id，（亦或者是备库当主库用）\n\n\n业务原因：本以为外网关闭了，定时任务关闭了 不会有交易\n但是，  应用监控检查发邮件了，cs通过mq接收到了请求，连接数据库失败（此时数据库连接不上）。","slug":"数据库-重启引发的主键问题","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc20035wy663n8k62jg","content":"<p>问题：cs系统 shut_message  自增主键id变小了。</p>\n<p>原因：cs的数据库重启了，但是应用没停止，   mysql重启后，回滚了部分自增id，（亦或者是备库当主库用）</p>\n<p>业务原因：本以为外网关闭了，定时任务关闭了 不会有交易<br>但是，  应用监控检查发邮件了，cs通过mq接收到了请求，连接数据库失败（此时数据库连接不上）。</p>\n","site":{"data":{}},"length":153,"excerpt":"","more":"<p>问题：cs系统 shut_message  自增主键id变小了。</p>\n<p>原因：cs的数据库重启了，但是应用没停止，   mysql重启后，回滚了部分自增id，（亦或者是备库当主库用）</p>\n<p>业务原因：本以为外网关闭了，定时任务关闭了 不会有交易<br>但是，  应用监控检查发邮件了，cs通过mq接收到了请求，连接数据库失败（此时数据库连接不上）。</p>\n"},{"title":"浏览器-资源加载","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"浏览器在同一个域名下并发加载资源（js，图片，css等）数是有限的，ie8（6个），谷歌（4-6个），\n解决：将资源尽可能分布在不同的域名下。","source":"_posts/浏览器-资源加载.md","raw":"title: 浏览器-资源加载\nauthor: Xiang Chuang\ntags:\n  - 浏览器\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\n浏览器在同一个域名下并发加载资源（js，图片，css等）数是有限的，ie8（6个），谷歌（4-6个），\n解决：将资源尽可能分布在不同的域名下。","slug":"浏览器-资源加载","published":1,"updated":"2019-09-30T07:34:10.840Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc30037wy66hzw35uig","content":"<p>浏览器在同一个域名下并发加载资源（js，图片，css等）数是有限的，ie8（6个），谷歌（4-6个），<br>解决：将资源尽可能分布在不同的域名下。</p>\n","site":{"data":{}},"length":70,"excerpt":"","more":"<p>浏览器在同一个域名下并发加载资源（js，图片，css等）数是有限的，ie8（6个），谷歌（4-6个），<br>解决：将资源尽可能分布在不同的域名下。</p>\n"},{"title":"淘宝架构-进化","author":"Xiang Chuang","date":"2017-07-20T04:30:00.000Z","_content":"V1.0：LAMP（Linux，Apache，MySQL，PHP） 2003年5月—2004年1月\n           注：一个主库（读写），两个从库（读） ，数据同步死锁 \n![upload successful](\\images\\pasted-57.png)\n\nV1.1：LAOP（Linux，Apache，Oracle，PHP）2004年1月—2004年5月\n            注：php访问数据库的方式很直接，短连接。 Oracle需要用到连接池、长连接才体现出其优势，但php没有很好的连接池           \n![upload successful](\\images\\pasted-58.png)\n\nV2.0：php切换为java IOE。2004年2月—2005年3月\n![upload successful](\\images\\pasted-59.png)\n\nV2.1:加入缓存，缓存只读信息，CDN  2004年10月—2007年1月\n![upload successful](\\images\\pasted-60.png)\n\nV2.2：kv缓存，tfs   模式类似于hadoop\n![upload successful](\\images\\pasted-61.png)\n","source":"_posts/淘宝架构-进化.md","raw":"title: 淘宝架构-进化\nauthor: Xiang Chuang\ntags:\n  - 架构\ncategories:\n  - 爱学爱问\ndate: 2017-07-20 12:30:00\n---\nV1.0：LAMP（Linux，Apache，MySQL，PHP） 2003年5月—2004年1月\n           注：一个主库（读写），两个从库（读） ，数据同步死锁 \n![upload successful](\\images\\pasted-57.png)\n\nV1.1：LAOP（Linux，Apache，Oracle，PHP）2004年1月—2004年5月\n            注：php访问数据库的方式很直接，短连接。 Oracle需要用到连接池、长连接才体现出其优势，但php没有很好的连接池           \n![upload successful](\\images\\pasted-58.png)\n\nV2.0：php切换为java IOE。2004年2月—2005年3月\n![upload successful](\\images\\pasted-59.png)\n\nV2.1:加入缓存，缓存只读信息，CDN  2004年10月—2007年1月\n![upload successful](\\images\\pasted-60.png)\n\nV2.2：kv缓存，tfs   模式类似于hadoop\n![upload successful](\\images\\pasted-61.png)\n","slug":"淘宝架构-进化","published":1,"updated":"2019-09-30T07:34:10.840Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc3003awy664b7c5e8y","content":"<p>V1.0：LAMP（Linux，Apache，MySQL，PHP） 2003年5月—2004年1月<br>           注：一个主库（读写），两个从库（读） ，数据同步死锁<br><img src=\"\\images\\pasted-57.png\" alt=\"upload successful\"></p>\n<p>V1.1：LAOP（Linux，Apache，Oracle，PHP）2004年1月—2004年5月<br>            注：php访问数据库的方式很直接，短连接。 Oracle需要用到连接池、长连接才体现出其优势，但php没有很好的连接池<br><img src=\"\\images\\pasted-58.png\" alt=\"upload successful\"></p>\n<p>V2.0：php切换为java IOE。2004年2月—2005年3月<br><img src=\"\\images\\pasted-59.png\" alt=\"upload successful\"></p>\n<p>V2.1:加入缓存，缓存只读信息，CDN  2004年10月—2007年1月<br><img src=\"\\images\\pasted-60.png\" alt=\"upload successful\"></p>\n<p>V2.2：kv缓存，tfs   模式类似于hadoop<br><img src=\"\\images\\pasted-61.png\" alt=\"upload successful\"></p>\n","site":{"data":{}},"length":274,"excerpt":"","more":"<p>V1.0：LAMP（Linux，Apache，MySQL，PHP） 2003年5月—2004年1月<br>           注：一个主库（读写），两个从库（读） ，数据同步死锁<br><img src=\"\\images\\pasted-57.png\" alt=\"upload successful\"></p>\n<p>V1.1：LAOP（Linux，Apache，Oracle，PHP）2004年1月—2004年5月<br>            注：php访问数据库的方式很直接，短连接。 Oracle需要用到连接池、长连接才体现出其优势，但php没有很好的连接池<br><img src=\"\\images\\pasted-58.png\" alt=\"upload successful\"></p>\n<p>V2.0：php切换为java IOE。2004年2月—2005年3月<br><img src=\"\\images\\pasted-59.png\" alt=\"upload successful\"></p>\n<p>V2.1:加入缓存，缓存只读信息，CDN  2004年10月—2007年1月<br><img src=\"\\images\\pasted-60.png\" alt=\"upload successful\"></p>\n<p>V2.2：kv缓存，tfs   模式类似于hadoop<br><img src=\"\\images\\pasted-61.png\" alt=\"upload successful\"></p>\n"},{"title":"谈一谈锁","date":"2019-04-08T14:11:18.000Z","_content":"","source":"_posts/谈一谈锁.md","raw":"---\ntitle: 谈一谈锁\ndate: 2019-04-08 22:11:18\ntags:\ncategories:\n---\n","slug":"谈一谈锁","published":1,"updated":"2019-09-30T07:34:10.840Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vc4003dwy66659m7wfc","content":"","site":{"data":{}},"length":0,"excerpt":"","more":""},{"title":"javaagent-bytebuddy","author":"Xiang Chuang","date":"2018-10-31T09:01:00.000Z","_content":"Java agent是在另外一个Java应用（“目标”应用）启动之前要执行的Java程序，这样agent就有机会修改目标应用或者应用所运行的环境。在本文中，我们将会从基础内容开始，逐渐增强其功能，借助字节码操作工具Byte Buddy，使其成为高级的agent实现。\n\n在最基本的用例中，Java agent会用来设置应用属性或者配置特定的环境状态，agent能够作为可重用和可插入的组件。如下的样例描述了这样的一个agent，它设置了一个系统属性，在实际的程序中就可以使用该属性了：\n\npublic class Agent {  public static void premain(String arg) {    System.setProperty(\"my-property\", “foo”);  }}\n\n如上面的代码所述，Java agent的定义与其他的Java程序类似，只不过它使用premain方法替代main方法作为入口点。顾名思义，这个方法能够在目标应用的main方法之前执行。相对于其他的Java程序，编写agent并没有特定的规则。有一个很小的区别在于，Java agent接受一个可选的参数，而不是包含零个或更多参数的数组。\n\n如果要使用这个agent，必须要将agent类和资源打包到jar中，并且在jar的manifest中要将Agent-Class属性设置为包含premain方法的agent类。（agent必须要打包到jar文件中，它不能通过拆解的格式进行指定。）接下来，我们需要启动应用程序，并且在命令行中通过javaagent参数来引用jar文件的位置：\n\njava -javaagent:myAgent.jar -jar myProgram.jar\n\n我们还可以在位置路径上设置可选的agent参数。在下面的命令中会启动一个Java程序并且添加给定的agent，将值myOptions作为参数提供给premain方法：\n\njava -javaagent:myAgent.jar=myOptions -jar myProgram.jar\n\n通过重复使用javaagent命令，能够添加多个agent。\n\n但是，Java agent的功能并不局限于修改应用程序环境的状态，Java agent能够访问Java instrumentation API，这样的话，agent就能修改目标应用程序的代码。Java虚拟机中这个鲜为人知的特性提供了一个强大的工具，有助于实现面向切面的编程。\n\n如果要对Java程序进行这种修改，我们需要在agent的premain方法上添加类型为Instrumentation的第二个参数。Instrumentation参数可以用来执行一系列的任务，比如确定对象以字节为单位的精确大小以及通过注册ClassFileTransformers实际修改类的实现。ClassFileTransformers注册之后，当类加载器（class loader）加载类的时候都会调用它。当它被调用时，在类文件所代表的类加载之前，类文件transformer有机会改变或完全替换这个类文件。按照这种方式，在类使用之前，我们能够增强或修改类的行为，如下面的样例所示：\n\npublic class Agent { public static void premain(String argument, Instrumentation inst) {   inst.addTransformer(new ClassFileTransformer() {     @Override     public byte[] transform(       ClassLoader loader,       String className,       Class<?> classBeingRedefined, // 如果类之前没有加载的话，值为null       ProtectionDomain protectionDomain,       byte[] classFileBuffer) {       // 返回改变后的类文件。     }   }); }}\n\n通过使用Instrumentation实例注册上述的ClassFileTransformer之后，每个类加载的时候，都会调用这个transformer。为了实现这一点，transformer会接受一个二进制和类加载器的引用，分别代表了类文件以及试图加载类的类加载器。\n\nJava agent也可以在Java应用的运行期注册，如果是在这种场景下，instrumentation API允许重新定义已加载的类，这个特性被称之为“HotSwap”。不过，重新定义类仅限于替换方法体。在重新定义类的时候，不能新增或移除类成员，并且类型和签名也不能进行修改。当类第一次加载的时候，并没有这种限制，如果是在这样的场景下，那classBeingRedefined会被设置为null。\n\nJava字节码与类文件格式\n\n类文件代表了Java类编译之后的状态。类文件中会包含字节码，这些字节码代表了Java源码中最初的程序指令。Java字节码可以视为Java虚拟机的语言。实际上，JVM并不会将Java视为编程语言，它只能处理字节码。因为它采用二进制的表现形式，所以相对于程序的源码，它占用的空间更少。除此之外，将程序以字节码的形式进行表现能够更容易地编译Java以外的其他语言，如Scala或Clojure，从而让它们运行在JVM上。如果没有字节码作为中间语言的话，那么其他的程序在运行之前，可能还需要将其转换为Java源码。\n\n但是，在代码处理的时候，这种抽象却带来了一定的成本。如果要将ClassFileTransformer应用到某个类上，那我们不能将该类按照Java源码的形式进行处理，甚至不能假设被转换的代码最初是由Java编写而成的。更糟糕的是，探查类成员或注解的反射API也是禁止使用的，这是因为类加载之前，我们无法访问这些API，而在转换进程完成之前，是无法进行加载的。\n\n所幸的是，Java字节码相对来讲是一个比较简单的抽象形式，它包含了很少量的操作，稍微花点功夫我们就能大致将其掌握起来。Java虚拟机执行程序的时候，会以基于栈的方式来处理值。字节码指令一般会告知虚拟机，需要从操作数栈（operand stack）上弹出值，执行一些操作，然后再将结果压到栈中。\n\n让我们考虑一个简单的样例：将数字1和2进行相加操作。JVM首先会将这两个数字压到栈中，这是通过 iconst_1和iconst_2这两个字节指令实现的。iconst_1是个单字节的便捷运算符（operator），它会将数字1压到栈中。与之类似，iconst_2会将数字2压到栈中。然后，会执行iadd指令，它会将栈中最新的两个值弹出，将它们求和计算的结果重新压到栈中。在类文件中，每个指令并不是以其易于记忆的名称进行存储的，而是以一个字节的形式进行存储，这个字节能够唯一地标记特定的指令，这也是bytecode这个术语的来历。上文所述的字节码指令及其对操作数栈的影响，通过下面的图片进行了可视化。\n\n![upload successful](\\images\\pasted-54.png)\n\n对于人类用户来讲，会更喜欢源码而不是字节码，不过幸运的是Java社区创建了多个库，能够解析类文件并将紧凑的字节码暴露为具有名称的指令流。例如，流行的ASM库提供了一个简单的visitor API，它能够将类文件剖析为成员和方法指令，其操作方式类似于阅读XML文件时的SAX解析器。如果使用ASM的话，那上述样例中的字节码可以按照如下的代码来进行实现（在这里，ASM方式的指令是visitIns，能够提供修正的方法实现）：\n\nMethodVisitor methodVisitor = ...methodVisitor.visitIns(Opcodes.ICONST_1);methodVisitor.visitIns(Opcodes.ICONST_2);methodVisitor.visitIns(Opcodes.IADD);\n\n需要注意的是，字节码规范只不过是一种比喻的说法（metaphor），因为Java虚拟机允许将程序转换为优化后的机器码（machine code），只要程序的输出能够保证是正确的即可。因为字节码的简洁性，所以在已有的类中取代和修改指令是很简单直接的。因此，使用ASM及其底层的Java字节码基础就足以实现类转换的Java agent，这需要注册一个ClassFileTransformer，它会使用这个库来处理其参数。\n\n克服字节码的不足\n\n对于实际的应用来讲，解析原始的类文件依然意味着有很多的手动工作。Java程序员通常感兴趣的是类型层级结构中的类。例如，某个Java agent可能需要修改所有实现给定接口的类。如果要确定某个类的超类，那只靠解析ClassFileTransformer所给定的类文件就不够了，类文件中只包含了直接超类和接口的名字。为了解析可能的超类型关联关系，程序员依然需要定位这些类型的类文件。\n\n在项目中直接使用ASM的另外一个困难在于，团队中需要有开发人员学习Java字节码的基础知识。在实践中，这往往会导致很多的开发人员不敢再去修改字节码操作相关的代码。如果这样的话，实现Java agent很容易为项目的长期维护带来风险。\n\n为了克服这些问题，我们最好使用较高层级的抽象来实现Java agent，而不是直接操作Java字节码。Byte Buddy是开源的、基于Apache 2.0许可证的库，它致力于解决字节码操作和instrumentation API的复杂性。Byte Buddy所声称的目标是将显式的字节码操作隐藏在一个类型安全的领域特定语言背后。通过使用Byte Buddy，任何熟悉Java编程语言的人都有望非常容易地进行字节码操作。\n\nByte Buddy简介\n\nByte Buddy的目的并不仅仅是为了生成Java agent。它提供了一个API用于生成任意的Java类，基于这个生成类的API，Byte Buddy提供了额外的API来生成Java agent。\n\n作为Byte Buddy的简介，如下的样例展现了如何生成一个简单的类，这个类是Object的子类，并且重写了toString方法，用来返回“Hello World!”。与原始的ASM类似，“intercept”会告诉Byte Buddy为拦截到的指令提供方法实现：\n\nClass<?> dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(\"toString\"))  .intercept(FixedValue.value(\"Hello World!\"))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();\n\n从上面的代码中，我们可以看到Byte Buddy要实现一个方法分为两步。首先，编程人员需要指定一个ElementMatcher，它负责识别一个或多个需要实现的方法。Byte Buddy提供了功能丰富的预定义拦截器（interceptor），它们暴露在ElementMatchers类中。在上述的例子中，toString方法完全精确匹配了名称，但是，我们也可以匹配更为复杂的代码结构，如类型或注解。\n\n当Byte Buddy生成类的时候，它会分析所生成类型的类层级结构。在上述的例子中，Byte Buddy能够确定所生成的类要继承其超类Object的名为toString的方法，指定的匹配器会要求Byte Buddy重写该方法，这是通过随后的 Implementation 实例实现的，在我们的样例中，这个实例也就是FixedValue。\n\n当创建子类的时候，Byte Buddy始终会拦截（intercept）一个匹配的方法，在生成的类中重写该方法。但是，我们在本文稍后将会看到Byte Buddy还能够重新定义已有的类，而不必通过子类的方式来实现。在这种情况下，Byte Buddy会将已有的代码替换为生成的代码，而将原有的代码复制到另外一个合成的（synthetic）方法中。\n\n在我们上面的代码样例中，匹配的方法进行了重写，在实现里面，返回了固定的值“Hello World!”。intercept方法接受Implementation类型的参数，Byte Buddy自带了多个预先定义的实现，如上文所使用的FixedValue类。但是，如果需要的话，可以使用前文所述的ASM API将某个方法实现为自定义的字节码，Byte Buddy本身也是基于ASM API实现的。\n\n定义完类的属性之后，就能通过make方法来进行生成。在样例应用中，因为用户没有指定类名，所以生成的类会给定一个任意的名称。最终，生成的类将会使用ClassLoadingStrategy来进行加载。通过使用上述的默认 WRAPPER策略，类将会使用一个新的类加载器进行加载，这个类加载器会使用环境类加载器作为父加载器。\n\n类加载之后，使用Java反射API就可以访问它了。如果没有指定其他构造器的话，Byte Buddy将会生成类似于父类的构造器，因此生成的类可以使用默认的构造器。这样，我们就可以检验生成的类重写了 toString方法，如下面的代码所示：\n\nassertThat(dynamicType.newInstance().toString(),            is(\"Hello World!\"));\n\n当然，这个生成的类并没有太大的用处。对于实际的应用来讲，大多数方法的返回值是在运行时计算的，这个计算过程要依赖于方法的参数和对象的状态。\n\n通过委托实现Instrumentation\n\n要实现某个方法，有一种更为灵活的方式，那就是使用Byte Buddy的MethodDelegation。通过使用方法委托，在生成重写的实现时，我们就有可能调用给定类和实例的其他方法。按照这种方式，我们可以使用如下的委托器（delegator）重新编写上述的样例：\n\nclass ToStringInterceptor {  static String intercept() {    return “Hello World!”;  }}\n\n借助上面的POJO拦截器，我们就可以将之前的FixedValue实现替换为MethodDelegation.to(ToStringInterceptor.class)：\n\nClass<?> dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(\"toString\"))  .intercept(MethodDelegation.to(ToStringInterceptor.class))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();\n\n使用上述的委托器，Byte Buddy会在to方法所给定的拦截目标中，确定最优的调用方法。就ToStringInterceptor.class来讲，选择过程只是非常简单地解析这个类型的唯一静态方法而已。在本例中，只会考虑一个静态方法，因为委托的目标中指定的是一个类。与之不同的是，我们还可以将其委托给某个类的实例，如果是这样的话，Byte Buddy将会考虑所有的虚方法（virtual method）。如果类或实例上有多个这样的方法，那么Byte Buddy首先会排除掉所有与指定instrumentation不兼容的方法。在剩余的方法中，库将会选择最佳的匹配者，通常来讲这会是参数最多的方法。我们还可以显式地指定目标方法，这需要缩小合法方法的范围，将ElementMatcher传递到MethodDelegation中，就会进行方法的过滤。例如，通过添加如下的filter，Byte Buddy只会将名为“intercept”的方法视为委托目标：\n\nMethodDelegation.to(ToStringInterceptor.class)                .filter(ElementMatchers.named(“intercept”))\n\n执行上面的拦截之后，被拦截到的方法依然会打印出“Hello World!”，但是这次的结果是动态计算的，这样的话，我们就可以在拦截器方法上设置断点，所生成的类每次调用toString时，都会触发拦截器的方法。\n\n当我们为拦截器方法设置参数时，就能释放出MethodDelegation的全部威力。这里的参数通常是带有注解的，用来要求Byte Buddy在调用拦截器方法时，注入某个特定的值。例如，通过使用@Origin注解，Byte Buddy提供了添加instrument功能的方法的实例，将其作为Java反射API中类的实例：\n\nclass ContextualToStringInterceptor {  static String intercept(@Origin Method m) {    return “Hello World from ” + m.getName() + “!”;  }}\n\n当拦截toString方法时，对instrument方法的调用将会返回“Hello world from toString!”。\n\n除了@Origin注解以外，Byte Buddy提供了一组功能丰富的注解。例如，通过在类型为Callable的参数上使用@Super注解，Byte Buddy会创建并注入一个代理实例，它能够调用被instrument方法的原始代码。如果对于特定的用户场景，所提供的注解不能满足需求或者不太适合的话，我们甚至能够注册自定义的注解，让这些注解注入用户特定的值。\n\n实现方法级别的安全性\n\n可以看到，我们在运行时可以借助简单的Java代码，使用MethodDelegation来动态重写某个方法。这只是一个简单的样例，但是这项技术可以用到更加实际的应用之中。在本文剩余的内容中，我们将会开发一个样例，它会使用代码生成技术实现一个注解驱动的库，用来限制方法级别的安全性。在我们的第一个迭代中，这个库会通过生成子类的方式来限制安全性。然后，我们将会采取相同的方式来实现Java agent，完成相同的功能。\n\n样例库会使用如下的注解，允许用户指定某个方法需要考虑安全因素：\n\n@interface Secured {  String user();}\n\n例如，假设应用需要使用如下的Service类来执行敏感操作，并且只有用户被认证为管理员才能执行该方法。这是通过为执行这个操作的方法声明Secured注解来指定的：\n\nclass Service {  @Secured(user = “ADMIN”)  void doSensitiveAction() {    // 运行敏感代码...  }}\n\n我们当然可以将安全检查直接编写到方法中。在实际中，硬编码横切关注点往往会导致复制-粘贴的逻辑，使其难以维护。另外，一旦应用需要涉及额外的需求时，如日志、收集调用指标或结果缓存，直接添加这样的代码扩展性不会很好。通过将这样的功能抽取到agent中，方法就能很纯粹地关注其业务逻辑，使得代码库能够更易于阅读、测试和维护。\n\n为了让我们规划的库保持尽可能得简单，按照注解的协议声明，如果当前用户不具备注解的用户属性时，将会抛出IllegalStateException异常。通过使用Byte Buddy，这种行为可以用一个简单的拦截器来实现，如下面样例中的SecurityInterceptor所示，它会通过其静态的user域，跟踪当前用户已经进行了登录：\n\nclass SecurityInterceptor {  static String user = “ANONYMOUS”  static void intercept(@Origin Method method) {    if (!method.getAnnotation(Secured.class).user().equals(user)) {      throw new IllegalStateException(“Wrong user”);    }  }}\n\n通过上面的代码，我们可以看到，即便给定用户授予了访问权限，拦截器也没有调用原始的方法。为了解决这个问题，Byte Buddy有很多预定义的方法可以实现功能的链接。借助MethodDelegation类的andThen方法，上述的安全检查可以放到原始方法的调用之前，如下面的代码所示。如果用户没有进行认证的话，安全检查将会抛出异常并阻止后续的执行，因此原始方法将不会执行。\n\n将这些功能集合在一起，我们就能生成Service的一个子类，所有带有注解方法的都能恰当地进行安全保护。因为所生成的类是Service的子类，所以它能够替代所有类型为Service的变量，并不需要任何的类型转换，如果没有恰当认证的话，调用doSensitiveAction方法就会抛出异常：\n\nnew ByteBuddy()  .subclass(Service.class)  .method(ElementMatchers.isAnnotatedBy(Secured.class))  .intercept(MethodDelegation.to(SecurityInterceptor.class)                             .andThen(SuperMethodCall.INSTANCE)))  .make()  .load(getClass().getClassLoader(),           ClassLoadingStrategy.Default.WRAPPER)  .getLoaded()  .newInstance()  .doSensitiveAction();\n\n不过坏消息是，因为实现instrumentation功能的子类是在运行时创建的，所以除了使用Java反射以外，没有其他办法创建这样的实例。因此，所有instrumentation类的实例都应该通过一个工厂来创建，这个工厂会封装创建instrumentation子类的复杂性。这样造成的结果就是，子类instrumentation通常会用于框架之中，这些框架本身就需要通过工厂来创建实例，例如，像依赖管理的框架Spring或对象-关系映射的框架Hibernate，而对于其他类型的应用来讲，子类instrumentation实现起来通常过于复杂。\n\n实现安全功能的Java agent\n\n通过使用Java agent，上述安全框架的一个替代实现将会修改Service类的原始字节码，而不是重写它。这样做的话，我们就没有必要创建托管的实例了，只需简单地调用\n\nnew Service().doSensitiveAction()\n\n即可，如果对应的用户没有进行认证的话，就会抛出异常。为了支持这种方式，Byte Buddy提供一种称之为rebase某个类的理念。当rebase某个类的时候，不会创建子类，所采用的策略是实现instrumentation功能的代码将会合并到被instrument的类中，从而改变其行为。在添加instrumentation功能之后，在被instrument的类中，其所有方法的原始代码均可进行访问，因此像SuperMethodCall这样的instrumentation，工作方式与创建子类是完全一样的。\n\n创建子类与rebase的行为是非常类似的，所以两种操作的API执行方式是一致的，都会使用相同的DynamicType.Builder接口来描述某个类型。两种形式的instrumentation都可以通过ByteBuddy类来进行访问。为了使Java agent的定义更加便利，Byte Buddy还提供了 AgentBuilder类，它希望能够以一种简洁的方式应对一些通用的用户场景。为了定义Java agent实现方法级别的安全性，将如下的类定义为agent的入口点就足以完成该功能了：\n\nclass SecurityAgent {  public static void premain(String arg, Instrumentation inst) {    new AgentBuilder.Default()    .type(ElementMatchers.any())    .transform((builder, type) -> builder    .method(ElementMatchers.isAnnotatedBy(Secured.class)    .intercept(MethodDelegation.to(SecurityInterceptor.class)               .andThen(SuperMethodCall.INSTANCE))))    .installOn(inst);  }}\n\n如果将这个agent打包为jar文件并在命令行中进行指定，那么所有带有Secured注解的方法将会进行“转换”或重定义，从而实现安全保护。如果不激活这个Java agent的话，应用在运行时就不包含额外的安全检查。当然，这意味着如果对带有注解的代码进行单元测试的话，这些方法的调用并不需要特殊的搭建过程来模拟安全上下文。Java运行时会忽略掉无法在classpath中找到的注解类型，因此在运行带有注解的方法时，我们甚至完全可以在应用中移除掉安全库。\n\n另外一项优势在于，Java agent能够很容易地进行叠加。如果在命令行中指定多个Java agent的话，每个agent都有机会对类进行修改，其顺序就是在命令行中所指定的顺序。例如，我们可以采取这种方式将安全、日志以及监控框架联合在一起，而不需要在这些应用间增添任何形式的集成层。因此，使用Java agent实现横切的关注点提供了一种更为模块化的代码编写方式，而不必针对某个管理实例的中心框架来集成所有的代码。\n\n查看英文原文：Easily Create Java Agents with Byte Buddy\n","source":"_posts/javaagent-bytebuddy.md","raw":"title: javaagent-bytebuddy\nauthor: Xiang Chuang\ntags:\n  - javaagent\n  - bytebuddy\ncategories:\n  - 外部引用\ndate: 2018-10-31 17:01:00\n---\nJava agent是在另外一个Java应用（“目标”应用）启动之前要执行的Java程序，这样agent就有机会修改目标应用或者应用所运行的环境。在本文中，我们将会从基础内容开始，逐渐增强其功能，借助字节码操作工具Byte Buddy，使其成为高级的agent实现。\n\n在最基本的用例中，Java agent会用来设置应用属性或者配置特定的环境状态，agent能够作为可重用和可插入的组件。如下的样例描述了这样的一个agent，它设置了一个系统属性，在实际的程序中就可以使用该属性了：\n\npublic class Agent {  public static void premain(String arg) {    System.setProperty(\"my-property\", “foo”);  }}\n\n如上面的代码所述，Java agent的定义与其他的Java程序类似，只不过它使用premain方法替代main方法作为入口点。顾名思义，这个方法能够在目标应用的main方法之前执行。相对于其他的Java程序，编写agent并没有特定的规则。有一个很小的区别在于，Java agent接受一个可选的参数，而不是包含零个或更多参数的数组。\n\n如果要使用这个agent，必须要将agent类和资源打包到jar中，并且在jar的manifest中要将Agent-Class属性设置为包含premain方法的agent类。（agent必须要打包到jar文件中，它不能通过拆解的格式进行指定。）接下来，我们需要启动应用程序，并且在命令行中通过javaagent参数来引用jar文件的位置：\n\njava -javaagent:myAgent.jar -jar myProgram.jar\n\n我们还可以在位置路径上设置可选的agent参数。在下面的命令中会启动一个Java程序并且添加给定的agent，将值myOptions作为参数提供给premain方法：\n\njava -javaagent:myAgent.jar=myOptions -jar myProgram.jar\n\n通过重复使用javaagent命令，能够添加多个agent。\n\n但是，Java agent的功能并不局限于修改应用程序环境的状态，Java agent能够访问Java instrumentation API，这样的话，agent就能修改目标应用程序的代码。Java虚拟机中这个鲜为人知的特性提供了一个强大的工具，有助于实现面向切面的编程。\n\n如果要对Java程序进行这种修改，我们需要在agent的premain方法上添加类型为Instrumentation的第二个参数。Instrumentation参数可以用来执行一系列的任务，比如确定对象以字节为单位的精确大小以及通过注册ClassFileTransformers实际修改类的实现。ClassFileTransformers注册之后，当类加载器（class loader）加载类的时候都会调用它。当它被调用时，在类文件所代表的类加载之前，类文件transformer有机会改变或完全替换这个类文件。按照这种方式，在类使用之前，我们能够增强或修改类的行为，如下面的样例所示：\n\npublic class Agent { public static void premain(String argument, Instrumentation inst) {   inst.addTransformer(new ClassFileTransformer() {     @Override     public byte[] transform(       ClassLoader loader,       String className,       Class<?> classBeingRedefined, // 如果类之前没有加载的话，值为null       ProtectionDomain protectionDomain,       byte[] classFileBuffer) {       // 返回改变后的类文件。     }   }); }}\n\n通过使用Instrumentation实例注册上述的ClassFileTransformer之后，每个类加载的时候，都会调用这个transformer。为了实现这一点，transformer会接受一个二进制和类加载器的引用，分别代表了类文件以及试图加载类的类加载器。\n\nJava agent也可以在Java应用的运行期注册，如果是在这种场景下，instrumentation API允许重新定义已加载的类，这个特性被称之为“HotSwap”。不过，重新定义类仅限于替换方法体。在重新定义类的时候，不能新增或移除类成员，并且类型和签名也不能进行修改。当类第一次加载的时候，并没有这种限制，如果是在这样的场景下，那classBeingRedefined会被设置为null。\n\nJava字节码与类文件格式\n\n类文件代表了Java类编译之后的状态。类文件中会包含字节码，这些字节码代表了Java源码中最初的程序指令。Java字节码可以视为Java虚拟机的语言。实际上，JVM并不会将Java视为编程语言，它只能处理字节码。因为它采用二进制的表现形式，所以相对于程序的源码，它占用的空间更少。除此之外，将程序以字节码的形式进行表现能够更容易地编译Java以外的其他语言，如Scala或Clojure，从而让它们运行在JVM上。如果没有字节码作为中间语言的话，那么其他的程序在运行之前，可能还需要将其转换为Java源码。\n\n但是，在代码处理的时候，这种抽象却带来了一定的成本。如果要将ClassFileTransformer应用到某个类上，那我们不能将该类按照Java源码的形式进行处理，甚至不能假设被转换的代码最初是由Java编写而成的。更糟糕的是，探查类成员或注解的反射API也是禁止使用的，这是因为类加载之前，我们无法访问这些API，而在转换进程完成之前，是无法进行加载的。\n\n所幸的是，Java字节码相对来讲是一个比较简单的抽象形式，它包含了很少量的操作，稍微花点功夫我们就能大致将其掌握起来。Java虚拟机执行程序的时候，会以基于栈的方式来处理值。字节码指令一般会告知虚拟机，需要从操作数栈（operand stack）上弹出值，执行一些操作，然后再将结果压到栈中。\n\n让我们考虑一个简单的样例：将数字1和2进行相加操作。JVM首先会将这两个数字压到栈中，这是通过 iconst_1和iconst_2这两个字节指令实现的。iconst_1是个单字节的便捷运算符（operator），它会将数字1压到栈中。与之类似，iconst_2会将数字2压到栈中。然后，会执行iadd指令，它会将栈中最新的两个值弹出，将它们求和计算的结果重新压到栈中。在类文件中，每个指令并不是以其易于记忆的名称进行存储的，而是以一个字节的形式进行存储，这个字节能够唯一地标记特定的指令，这也是bytecode这个术语的来历。上文所述的字节码指令及其对操作数栈的影响，通过下面的图片进行了可视化。\n\n![upload successful](\\images\\pasted-54.png)\n\n对于人类用户来讲，会更喜欢源码而不是字节码，不过幸运的是Java社区创建了多个库，能够解析类文件并将紧凑的字节码暴露为具有名称的指令流。例如，流行的ASM库提供了一个简单的visitor API，它能够将类文件剖析为成员和方法指令，其操作方式类似于阅读XML文件时的SAX解析器。如果使用ASM的话，那上述样例中的字节码可以按照如下的代码来进行实现（在这里，ASM方式的指令是visitIns，能够提供修正的方法实现）：\n\nMethodVisitor methodVisitor = ...methodVisitor.visitIns(Opcodes.ICONST_1);methodVisitor.visitIns(Opcodes.ICONST_2);methodVisitor.visitIns(Opcodes.IADD);\n\n需要注意的是，字节码规范只不过是一种比喻的说法（metaphor），因为Java虚拟机允许将程序转换为优化后的机器码（machine code），只要程序的输出能够保证是正确的即可。因为字节码的简洁性，所以在已有的类中取代和修改指令是很简单直接的。因此，使用ASM及其底层的Java字节码基础就足以实现类转换的Java agent，这需要注册一个ClassFileTransformer，它会使用这个库来处理其参数。\n\n克服字节码的不足\n\n对于实际的应用来讲，解析原始的类文件依然意味着有很多的手动工作。Java程序员通常感兴趣的是类型层级结构中的类。例如，某个Java agent可能需要修改所有实现给定接口的类。如果要确定某个类的超类，那只靠解析ClassFileTransformer所给定的类文件就不够了，类文件中只包含了直接超类和接口的名字。为了解析可能的超类型关联关系，程序员依然需要定位这些类型的类文件。\n\n在项目中直接使用ASM的另外一个困难在于，团队中需要有开发人员学习Java字节码的基础知识。在实践中，这往往会导致很多的开发人员不敢再去修改字节码操作相关的代码。如果这样的话，实现Java agent很容易为项目的长期维护带来风险。\n\n为了克服这些问题，我们最好使用较高层级的抽象来实现Java agent，而不是直接操作Java字节码。Byte Buddy是开源的、基于Apache 2.0许可证的库，它致力于解决字节码操作和instrumentation API的复杂性。Byte Buddy所声称的目标是将显式的字节码操作隐藏在一个类型安全的领域特定语言背后。通过使用Byte Buddy，任何熟悉Java编程语言的人都有望非常容易地进行字节码操作。\n\nByte Buddy简介\n\nByte Buddy的目的并不仅仅是为了生成Java agent。它提供了一个API用于生成任意的Java类，基于这个生成类的API，Byte Buddy提供了额外的API来生成Java agent。\n\n作为Byte Buddy的简介，如下的样例展现了如何生成一个简单的类，这个类是Object的子类，并且重写了toString方法，用来返回“Hello World!”。与原始的ASM类似，“intercept”会告诉Byte Buddy为拦截到的指令提供方法实现：\n\nClass<?> dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(\"toString\"))  .intercept(FixedValue.value(\"Hello World!\"))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();\n\n从上面的代码中，我们可以看到Byte Buddy要实现一个方法分为两步。首先，编程人员需要指定一个ElementMatcher，它负责识别一个或多个需要实现的方法。Byte Buddy提供了功能丰富的预定义拦截器（interceptor），它们暴露在ElementMatchers类中。在上述的例子中，toString方法完全精确匹配了名称，但是，我们也可以匹配更为复杂的代码结构，如类型或注解。\n\n当Byte Buddy生成类的时候，它会分析所生成类型的类层级结构。在上述的例子中，Byte Buddy能够确定所生成的类要继承其超类Object的名为toString的方法，指定的匹配器会要求Byte Buddy重写该方法，这是通过随后的 Implementation 实例实现的，在我们的样例中，这个实例也就是FixedValue。\n\n当创建子类的时候，Byte Buddy始终会拦截（intercept）一个匹配的方法，在生成的类中重写该方法。但是，我们在本文稍后将会看到Byte Buddy还能够重新定义已有的类，而不必通过子类的方式来实现。在这种情况下，Byte Buddy会将已有的代码替换为生成的代码，而将原有的代码复制到另外一个合成的（synthetic）方法中。\n\n在我们上面的代码样例中，匹配的方法进行了重写，在实现里面，返回了固定的值“Hello World!”。intercept方法接受Implementation类型的参数，Byte Buddy自带了多个预先定义的实现，如上文所使用的FixedValue类。但是，如果需要的话，可以使用前文所述的ASM API将某个方法实现为自定义的字节码，Byte Buddy本身也是基于ASM API实现的。\n\n定义完类的属性之后，就能通过make方法来进行生成。在样例应用中，因为用户没有指定类名，所以生成的类会给定一个任意的名称。最终，生成的类将会使用ClassLoadingStrategy来进行加载。通过使用上述的默认 WRAPPER策略，类将会使用一个新的类加载器进行加载，这个类加载器会使用环境类加载器作为父加载器。\n\n类加载之后，使用Java反射API就可以访问它了。如果没有指定其他构造器的话，Byte Buddy将会生成类似于父类的构造器，因此生成的类可以使用默认的构造器。这样，我们就可以检验生成的类重写了 toString方法，如下面的代码所示：\n\nassertThat(dynamicType.newInstance().toString(),            is(\"Hello World!\"));\n\n当然，这个生成的类并没有太大的用处。对于实际的应用来讲，大多数方法的返回值是在运行时计算的，这个计算过程要依赖于方法的参数和对象的状态。\n\n通过委托实现Instrumentation\n\n要实现某个方法，有一种更为灵活的方式，那就是使用Byte Buddy的MethodDelegation。通过使用方法委托，在生成重写的实现时，我们就有可能调用给定类和实例的其他方法。按照这种方式，我们可以使用如下的委托器（delegator）重新编写上述的样例：\n\nclass ToStringInterceptor {  static String intercept() {    return “Hello World!”;  }}\n\n借助上面的POJO拦截器，我们就可以将之前的FixedValue实现替换为MethodDelegation.to(ToStringInterceptor.class)：\n\nClass<?> dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(\"toString\"))  .intercept(MethodDelegation.to(ToStringInterceptor.class))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();\n\n使用上述的委托器，Byte Buddy会在to方法所给定的拦截目标中，确定最优的调用方法。就ToStringInterceptor.class来讲，选择过程只是非常简单地解析这个类型的唯一静态方法而已。在本例中，只会考虑一个静态方法，因为委托的目标中指定的是一个类。与之不同的是，我们还可以将其委托给某个类的实例，如果是这样的话，Byte Buddy将会考虑所有的虚方法（virtual method）。如果类或实例上有多个这样的方法，那么Byte Buddy首先会排除掉所有与指定instrumentation不兼容的方法。在剩余的方法中，库将会选择最佳的匹配者，通常来讲这会是参数最多的方法。我们还可以显式地指定目标方法，这需要缩小合法方法的范围，将ElementMatcher传递到MethodDelegation中，就会进行方法的过滤。例如，通过添加如下的filter，Byte Buddy只会将名为“intercept”的方法视为委托目标：\n\nMethodDelegation.to(ToStringInterceptor.class)                .filter(ElementMatchers.named(“intercept”))\n\n执行上面的拦截之后，被拦截到的方法依然会打印出“Hello World!”，但是这次的结果是动态计算的，这样的话，我们就可以在拦截器方法上设置断点，所生成的类每次调用toString时，都会触发拦截器的方法。\n\n当我们为拦截器方法设置参数时，就能释放出MethodDelegation的全部威力。这里的参数通常是带有注解的，用来要求Byte Buddy在调用拦截器方法时，注入某个特定的值。例如，通过使用@Origin注解，Byte Buddy提供了添加instrument功能的方法的实例，将其作为Java反射API中类的实例：\n\nclass ContextualToStringInterceptor {  static String intercept(@Origin Method m) {    return “Hello World from ” + m.getName() + “!”;  }}\n\n当拦截toString方法时，对instrument方法的调用将会返回“Hello world from toString!”。\n\n除了@Origin注解以外，Byte Buddy提供了一组功能丰富的注解。例如，通过在类型为Callable的参数上使用@Super注解，Byte Buddy会创建并注入一个代理实例，它能够调用被instrument方法的原始代码。如果对于特定的用户场景，所提供的注解不能满足需求或者不太适合的话，我们甚至能够注册自定义的注解，让这些注解注入用户特定的值。\n\n实现方法级别的安全性\n\n可以看到，我们在运行时可以借助简单的Java代码，使用MethodDelegation来动态重写某个方法。这只是一个简单的样例，但是这项技术可以用到更加实际的应用之中。在本文剩余的内容中，我们将会开发一个样例，它会使用代码生成技术实现一个注解驱动的库，用来限制方法级别的安全性。在我们的第一个迭代中，这个库会通过生成子类的方式来限制安全性。然后，我们将会采取相同的方式来实现Java agent，完成相同的功能。\n\n样例库会使用如下的注解，允许用户指定某个方法需要考虑安全因素：\n\n@interface Secured {  String user();}\n\n例如，假设应用需要使用如下的Service类来执行敏感操作，并且只有用户被认证为管理员才能执行该方法。这是通过为执行这个操作的方法声明Secured注解来指定的：\n\nclass Service {  @Secured(user = “ADMIN”)  void doSensitiveAction() {    // 运行敏感代码...  }}\n\n我们当然可以将安全检查直接编写到方法中。在实际中，硬编码横切关注点往往会导致复制-粘贴的逻辑，使其难以维护。另外，一旦应用需要涉及额外的需求时，如日志、收集调用指标或结果缓存，直接添加这样的代码扩展性不会很好。通过将这样的功能抽取到agent中，方法就能很纯粹地关注其业务逻辑，使得代码库能够更易于阅读、测试和维护。\n\n为了让我们规划的库保持尽可能得简单，按照注解的协议声明，如果当前用户不具备注解的用户属性时，将会抛出IllegalStateException异常。通过使用Byte Buddy，这种行为可以用一个简单的拦截器来实现，如下面样例中的SecurityInterceptor所示，它会通过其静态的user域，跟踪当前用户已经进行了登录：\n\nclass SecurityInterceptor {  static String user = “ANONYMOUS”  static void intercept(@Origin Method method) {    if (!method.getAnnotation(Secured.class).user().equals(user)) {      throw new IllegalStateException(“Wrong user”);    }  }}\n\n通过上面的代码，我们可以看到，即便给定用户授予了访问权限，拦截器也没有调用原始的方法。为了解决这个问题，Byte Buddy有很多预定义的方法可以实现功能的链接。借助MethodDelegation类的andThen方法，上述的安全检查可以放到原始方法的调用之前，如下面的代码所示。如果用户没有进行认证的话，安全检查将会抛出异常并阻止后续的执行，因此原始方法将不会执行。\n\n将这些功能集合在一起，我们就能生成Service的一个子类，所有带有注解方法的都能恰当地进行安全保护。因为所生成的类是Service的子类，所以它能够替代所有类型为Service的变量，并不需要任何的类型转换，如果没有恰当认证的话，调用doSensitiveAction方法就会抛出异常：\n\nnew ByteBuddy()  .subclass(Service.class)  .method(ElementMatchers.isAnnotatedBy(Secured.class))  .intercept(MethodDelegation.to(SecurityInterceptor.class)                             .andThen(SuperMethodCall.INSTANCE)))  .make()  .load(getClass().getClassLoader(),           ClassLoadingStrategy.Default.WRAPPER)  .getLoaded()  .newInstance()  .doSensitiveAction();\n\n不过坏消息是，因为实现instrumentation功能的子类是在运行时创建的，所以除了使用Java反射以外，没有其他办法创建这样的实例。因此，所有instrumentation类的实例都应该通过一个工厂来创建，这个工厂会封装创建instrumentation子类的复杂性。这样造成的结果就是，子类instrumentation通常会用于框架之中，这些框架本身就需要通过工厂来创建实例，例如，像依赖管理的框架Spring或对象-关系映射的框架Hibernate，而对于其他类型的应用来讲，子类instrumentation实现起来通常过于复杂。\n\n实现安全功能的Java agent\n\n通过使用Java agent，上述安全框架的一个替代实现将会修改Service类的原始字节码，而不是重写它。这样做的话，我们就没有必要创建托管的实例了，只需简单地调用\n\nnew Service().doSensitiveAction()\n\n即可，如果对应的用户没有进行认证的话，就会抛出异常。为了支持这种方式，Byte Buddy提供一种称之为rebase某个类的理念。当rebase某个类的时候，不会创建子类，所采用的策略是实现instrumentation功能的代码将会合并到被instrument的类中，从而改变其行为。在添加instrumentation功能之后，在被instrument的类中，其所有方法的原始代码均可进行访问，因此像SuperMethodCall这样的instrumentation，工作方式与创建子类是完全一样的。\n\n创建子类与rebase的行为是非常类似的，所以两种操作的API执行方式是一致的，都会使用相同的DynamicType.Builder接口来描述某个类型。两种形式的instrumentation都可以通过ByteBuddy类来进行访问。为了使Java agent的定义更加便利，Byte Buddy还提供了 AgentBuilder类，它希望能够以一种简洁的方式应对一些通用的用户场景。为了定义Java agent实现方法级别的安全性，将如下的类定义为agent的入口点就足以完成该功能了：\n\nclass SecurityAgent {  public static void premain(String arg, Instrumentation inst) {    new AgentBuilder.Default()    .type(ElementMatchers.any())    .transform((builder, type) -> builder    .method(ElementMatchers.isAnnotatedBy(Secured.class)    .intercept(MethodDelegation.to(SecurityInterceptor.class)               .andThen(SuperMethodCall.INSTANCE))))    .installOn(inst);  }}\n\n如果将这个agent打包为jar文件并在命令行中进行指定，那么所有带有Secured注解的方法将会进行“转换”或重定义，从而实现安全保护。如果不激活这个Java agent的话，应用在运行时就不包含额外的安全检查。当然，这意味着如果对带有注解的代码进行单元测试的话，这些方法的调用并不需要特殊的搭建过程来模拟安全上下文。Java运行时会忽略掉无法在classpath中找到的注解类型，因此在运行带有注解的方法时，我们甚至完全可以在应用中移除掉安全库。\n\n另外一项优势在于，Java agent能够很容易地进行叠加。如果在命令行中指定多个Java agent的话，每个agent都有机会对类进行修改，其顺序就是在命令行中所指定的顺序。例如，我们可以采取这种方式将安全、日志以及监控框架联合在一起，而不需要在这些应用间增添任何形式的集成层。因此，使用Java agent实现横切的关注点提供了一种更为模块化的代码编写方式，而不必针对某个管理实例的中心框架来集成所有的代码。\n\n查看英文原文：Easily Create Java Agents with Byte Buddy\n","slug":"javaagent-bytebuddy","published":1,"updated":"2019-09-30T07:34:10.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vcr006kwy664zeoc8r5","content":"<p>Java agent是在另外一个Java应用（“目标”应用）启动之前要执行的Java程序，这样agent就有机会修改目标应用或者应用所运行的环境。在本文中，我们将会从基础内容开始，逐渐增强其功能，借助字节码操作工具Byte Buddy，使其成为高级的agent实现。</p>\n<p>在最基本的用例中，Java agent会用来设置应用属性或者配置特定的环境状态，agent能够作为可重用和可插入的组件。如下的样例描述了这样的一个agent，它设置了一个系统属性，在实际的程序中就可以使用该属性了：</p>\n<p>public class Agent {  public static void premain(String arg) {    System.setProperty(“my-property”, “foo”);  }}</p>\n<p>如上面的代码所述，Java agent的定义与其他的Java程序类似，只不过它使用premain方法替代main方法作为入口点。顾名思义，这个方法能够在目标应用的main方法之前执行。相对于其他的Java程序，编写agent并没有特定的规则。有一个很小的区别在于，Java agent接受一个可选的参数，而不是包含零个或更多参数的数组。</p>\n<p>如果要使用这个agent，必须要将agent类和资源打包到jar中，并且在jar的manifest中要将Agent-Class属性设置为包含premain方法的agent类。（agent必须要打包到jar文件中，它不能通过拆解的格式进行指定。）接下来，我们需要启动应用程序，并且在命令行中通过javaagent参数来引用jar文件的位置：</p>\n<p>java -javaagent:myAgent.jar -jar myProgram.jar</p>\n<p>我们还可以在位置路径上设置可选的agent参数。在下面的命令中会启动一个Java程序并且添加给定的agent，将值myOptions作为参数提供给premain方法：</p>\n<p>java -javaagent:myAgent.jar=myOptions -jar myProgram.jar</p>\n<p>通过重复使用javaagent命令，能够添加多个agent。</p>\n<p>但是，Java agent的功能并不局限于修改应用程序环境的状态，Java agent能够访问Java instrumentation API，这样的话，agent就能修改目标应用程序的代码。Java虚拟机中这个鲜为人知的特性提供了一个强大的工具，有助于实现面向切面的编程。</p>\n<p>如果要对Java程序进行这种修改，我们需要在agent的premain方法上添加类型为Instrumentation的第二个参数。Instrumentation参数可以用来执行一系列的任务，比如确定对象以字节为单位的精确大小以及通过注册ClassFileTransformers实际修改类的实现。ClassFileTransformers注册之后，当类加载器（class loader）加载类的时候都会调用它。当它被调用时，在类文件所代表的类加载之前，类文件transformer有机会改变或完全替换这个类文件。按照这种方式，在类使用之前，我们能够增强或修改类的行为，如下面的样例所示：</p>\n<p>public class Agent { public static void premain(String argument, Instrumentation inst) {   inst.addTransformer(new ClassFileTransformer() {     @Override     public byte[] transform(       ClassLoader loader,       String className,       Class&lt;?&gt; classBeingRedefined, // 如果类之前没有加载的话，值为null       ProtectionDomain protectionDomain,       byte[] classFileBuffer) {       // 返回改变后的类文件。     }   }); }}</p>\n<p>通过使用Instrumentation实例注册上述的ClassFileTransformer之后，每个类加载的时候，都会调用这个transformer。为了实现这一点，transformer会接受一个二进制和类加载器的引用，分别代表了类文件以及试图加载类的类加载器。</p>\n<p>Java agent也可以在Java应用的运行期注册，如果是在这种场景下，instrumentation API允许重新定义已加载的类，这个特性被称之为“HotSwap”。不过，重新定义类仅限于替换方法体。在重新定义类的时候，不能新增或移除类成员，并且类型和签名也不能进行修改。当类第一次加载的时候，并没有这种限制，如果是在这样的场景下，那classBeingRedefined会被设置为null。</p>\n<p>Java字节码与类文件格式</p>\n<p>类文件代表了Java类编译之后的状态。类文件中会包含字节码，这些字节码代表了Java源码中最初的程序指令。Java字节码可以视为Java虚拟机的语言。实际上，JVM并不会将Java视为编程语言，它只能处理字节码。因为它采用二进制的表现形式，所以相对于程序的源码，它占用的空间更少。除此之外，将程序以字节码的形式进行表现能够更容易地编译Java以外的其他语言，如Scala或Clojure，从而让它们运行在JVM上。如果没有字节码作为中间语言的话，那么其他的程序在运行之前，可能还需要将其转换为Java源码。</p>\n<p>但是，在代码处理的时候，这种抽象却带来了一定的成本。如果要将ClassFileTransformer应用到某个类上，那我们不能将该类按照Java源码的形式进行处理，甚至不能假设被转换的代码最初是由Java编写而成的。更糟糕的是，探查类成员或注解的反射API也是禁止使用的，这是因为类加载之前，我们无法访问这些API，而在转换进程完成之前，是无法进行加载的。</p>\n<p>所幸的是，Java字节码相对来讲是一个比较简单的抽象形式，它包含了很少量的操作，稍微花点功夫我们就能大致将其掌握起来。Java虚拟机执行程序的时候，会以基于栈的方式来处理值。字节码指令一般会告知虚拟机，需要从操作数栈（operand stack）上弹出值，执行一些操作，然后再将结果压到栈中。</p>\n<p>让我们考虑一个简单的样例：将数字1和2进行相加操作。JVM首先会将这两个数字压到栈中，这是通过 iconst_1和iconst_2这两个字节指令实现的。iconst_1是个单字节的便捷运算符（operator），它会将数字1压到栈中。与之类似，iconst_2会将数字2压到栈中。然后，会执行iadd指令，它会将栈中最新的两个值弹出，将它们求和计算的结果重新压到栈中。在类文件中，每个指令并不是以其易于记忆的名称进行存储的，而是以一个字节的形式进行存储，这个字节能够唯一地标记特定的指令，这也是bytecode这个术语的来历。上文所述的字节码指令及其对操作数栈的影响，通过下面的图片进行了可视化。</p>\n<p><img src=\"\\images\\pasted-54.png\" alt=\"upload successful\"></p>\n<p>对于人类用户来讲，会更喜欢源码而不是字节码，不过幸运的是Java社区创建了多个库，能够解析类文件并将紧凑的字节码暴露为具有名称的指令流。例如，流行的ASM库提供了一个简单的visitor API，它能够将类文件剖析为成员和方法指令，其操作方式类似于阅读XML文件时的SAX解析器。如果使用ASM的话，那上述样例中的字节码可以按照如下的代码来进行实现（在这里，ASM方式的指令是visitIns，能够提供修正的方法实现）：</p>\n<p>MethodVisitor methodVisitor = …methodVisitor.visitIns(Opcodes.ICONST_1);methodVisitor.visitIns(Opcodes.ICONST_2);methodVisitor.visitIns(Opcodes.IADD);</p>\n<p>需要注意的是，字节码规范只不过是一种比喻的说法（metaphor），因为Java虚拟机允许将程序转换为优化后的机器码（machine code），只要程序的输出能够保证是正确的即可。因为字节码的简洁性，所以在已有的类中取代和修改指令是很简单直接的。因此，使用ASM及其底层的Java字节码基础就足以实现类转换的Java agent，这需要注册一个ClassFileTransformer，它会使用这个库来处理其参数。</p>\n<p>克服字节码的不足</p>\n<p>对于实际的应用来讲，解析原始的类文件依然意味着有很多的手动工作。Java程序员通常感兴趣的是类型层级结构中的类。例如，某个Java agent可能需要修改所有实现给定接口的类。如果要确定某个类的超类，那只靠解析ClassFileTransformer所给定的类文件就不够了，类文件中只包含了直接超类和接口的名字。为了解析可能的超类型关联关系，程序员依然需要定位这些类型的类文件。</p>\n<p>在项目中直接使用ASM的另外一个困难在于，团队中需要有开发人员学习Java字节码的基础知识。在实践中，这往往会导致很多的开发人员不敢再去修改字节码操作相关的代码。如果这样的话，实现Java agent很容易为项目的长期维护带来风险。</p>\n<p>为了克服这些问题，我们最好使用较高层级的抽象来实现Java agent，而不是直接操作Java字节码。Byte Buddy是开源的、基于Apache 2.0许可证的库，它致力于解决字节码操作和instrumentation API的复杂性。Byte Buddy所声称的目标是将显式的字节码操作隐藏在一个类型安全的领域特定语言背后。通过使用Byte Buddy，任何熟悉Java编程语言的人都有望非常容易地进行字节码操作。</p>\n<p>Byte Buddy简介</p>\n<p>Byte Buddy的目的并不仅仅是为了生成Java agent。它提供了一个API用于生成任意的Java类，基于这个生成类的API，Byte Buddy提供了额外的API来生成Java agent。</p>\n<p>作为Byte Buddy的简介，如下的样例展现了如何生成一个简单的类，这个类是Object的子类，并且重写了toString方法，用来返回“Hello World!”。与原始的ASM类似，“intercept”会告诉Byte Buddy为拦截到的指令提供方法实现：</p>\n<p>Class&lt;?&gt; dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(“toString”))  .intercept(FixedValue.value(“Hello World!”))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();</p>\n<p>从上面的代码中，我们可以看到Byte Buddy要实现一个方法分为两步。首先，编程人员需要指定一个ElementMatcher，它负责识别一个或多个需要实现的方法。Byte Buddy提供了功能丰富的预定义拦截器（interceptor），它们暴露在ElementMatchers类中。在上述的例子中，toString方法完全精确匹配了名称，但是，我们也可以匹配更为复杂的代码结构，如类型或注解。</p>\n<p>当Byte Buddy生成类的时候，它会分析所生成类型的类层级结构。在上述的例子中，Byte Buddy能够确定所生成的类要继承其超类Object的名为toString的方法，指定的匹配器会要求Byte Buddy重写该方法，这是通过随后的 Implementation 实例实现的，在我们的样例中，这个实例也就是FixedValue。</p>\n<p>当创建子类的时候，Byte Buddy始终会拦截（intercept）一个匹配的方法，在生成的类中重写该方法。但是，我们在本文稍后将会看到Byte Buddy还能够重新定义已有的类，而不必通过子类的方式来实现。在这种情况下，Byte Buddy会将已有的代码替换为生成的代码，而将原有的代码复制到另外一个合成的（synthetic）方法中。</p>\n<p>在我们上面的代码样例中，匹配的方法进行了重写，在实现里面，返回了固定的值“Hello World!”。intercept方法接受Implementation类型的参数，Byte Buddy自带了多个预先定义的实现，如上文所使用的FixedValue类。但是，如果需要的话，可以使用前文所述的ASM API将某个方法实现为自定义的字节码，Byte Buddy本身也是基于ASM API实现的。</p>\n<p>定义完类的属性之后，就能通过make方法来进行生成。在样例应用中，因为用户没有指定类名，所以生成的类会给定一个任意的名称。最终，生成的类将会使用ClassLoadingStrategy来进行加载。通过使用上述的默认 WRAPPER策略，类将会使用一个新的类加载器进行加载，这个类加载器会使用环境类加载器作为父加载器。</p>\n<p>类加载之后，使用Java反射API就可以访问它了。如果没有指定其他构造器的话，Byte Buddy将会生成类似于父类的构造器，因此生成的类可以使用默认的构造器。这样，我们就可以检验生成的类重写了 toString方法，如下面的代码所示：</p>\n<p>assertThat(dynamicType.newInstance().toString(),            is(“Hello World!”));</p>\n<p>当然，这个生成的类并没有太大的用处。对于实际的应用来讲，大多数方法的返回值是在运行时计算的，这个计算过程要依赖于方法的参数和对象的状态。</p>\n<p>通过委托实现Instrumentation</p>\n<p>要实现某个方法，有一种更为灵活的方式，那就是使用Byte Buddy的MethodDelegation。通过使用方法委托，在生成重写的实现时，我们就有可能调用给定类和实例的其他方法。按照这种方式，我们可以使用如下的委托器（delegator）重新编写上述的样例：</p>\n<p>class ToStringInterceptor {  static String intercept() {    return “Hello World!”;  }}</p>\n<p>借助上面的POJO拦截器，我们就可以将之前的FixedValue实现替换为MethodDelegation.to(ToStringInterceptor.class)：</p>\n<p>Class&lt;?&gt; dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(“toString”))  .intercept(MethodDelegation.to(ToStringInterceptor.class))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();</p>\n<p>使用上述的委托器，Byte Buddy会在to方法所给定的拦截目标中，确定最优的调用方法。就ToStringInterceptor.class来讲，选择过程只是非常简单地解析这个类型的唯一静态方法而已。在本例中，只会考虑一个静态方法，因为委托的目标中指定的是一个类。与之不同的是，我们还可以将其委托给某个类的实例，如果是这样的话，Byte Buddy将会考虑所有的虚方法（virtual method）。如果类或实例上有多个这样的方法，那么Byte Buddy首先会排除掉所有与指定instrumentation不兼容的方法。在剩余的方法中，库将会选择最佳的匹配者，通常来讲这会是参数最多的方法。我们还可以显式地指定目标方法，这需要缩小合法方法的范围，将ElementMatcher传递到MethodDelegation中，就会进行方法的过滤。例如，通过添加如下的filter，Byte Buddy只会将名为“intercept”的方法视为委托目标：</p>\n<p>MethodDelegation.to(ToStringInterceptor.class)                .filter(ElementMatchers.named(“intercept”))</p>\n<p>执行上面的拦截之后，被拦截到的方法依然会打印出“Hello World!”，但是这次的结果是动态计算的，这样的话，我们就可以在拦截器方法上设置断点，所生成的类每次调用toString时，都会触发拦截器的方法。</p>\n<p>当我们为拦截器方法设置参数时，就能释放出MethodDelegation的全部威力。这里的参数通常是带有注解的，用来要求Byte Buddy在调用拦截器方法时，注入某个特定的值。例如，通过使用@Origin注解，Byte Buddy提供了添加instrument功能的方法的实例，将其作为Java反射API中类的实例：</p>\n<p>class ContextualToStringInterceptor {  static String intercept(@Origin Method m) {    return “Hello World from ” + m.getName() + “!”;  }}</p>\n<p>当拦截toString方法时，对instrument方法的调用将会返回“Hello world from toString!”。</p>\n<p>除了@Origin注解以外，Byte Buddy提供了一组功能丰富的注解。例如，通过在类型为Callable的参数上使用@Super注解，Byte Buddy会创建并注入一个代理实例，它能够调用被instrument方法的原始代码。如果对于特定的用户场景，所提供的注解不能满足需求或者不太适合的话，我们甚至能够注册自定义的注解，让这些注解注入用户特定的值。</p>\n<p>实现方法级别的安全性</p>\n<p>可以看到，我们在运行时可以借助简单的Java代码，使用MethodDelegation来动态重写某个方法。这只是一个简单的样例，但是这项技术可以用到更加实际的应用之中。在本文剩余的内容中，我们将会开发一个样例，它会使用代码生成技术实现一个注解驱动的库，用来限制方法级别的安全性。在我们的第一个迭代中，这个库会通过生成子类的方式来限制安全性。然后，我们将会采取相同的方式来实现Java agent，完成相同的功能。</p>\n<p>样例库会使用如下的注解，允许用户指定某个方法需要考虑安全因素：</p>\n<p>@interface Secured {  String user();}</p>\n<p>例如，假设应用需要使用如下的Service类来执行敏感操作，并且只有用户被认证为管理员才能执行该方法。这是通过为执行这个操作的方法声明Secured注解来指定的：</p>\n<p>class Service {  @Secured(user = “ADMIN”)  void doSensitiveAction() {    // 运行敏感代码…  }}</p>\n<p>我们当然可以将安全检查直接编写到方法中。在实际中，硬编码横切关注点往往会导致复制-粘贴的逻辑，使其难以维护。另外，一旦应用需要涉及额外的需求时，如日志、收集调用指标或结果缓存，直接添加这样的代码扩展性不会很好。通过将这样的功能抽取到agent中，方法就能很纯粹地关注其业务逻辑，使得代码库能够更易于阅读、测试和维护。</p>\n<p>为了让我们规划的库保持尽可能得简单，按照注解的协议声明，如果当前用户不具备注解的用户属性时，将会抛出IllegalStateException异常。通过使用Byte Buddy，这种行为可以用一个简单的拦截器来实现，如下面样例中的SecurityInterceptor所示，它会通过其静态的user域，跟踪当前用户已经进行了登录：</p>\n<p>class SecurityInterceptor {  static String user = “ANONYMOUS”  static void intercept(@Origin Method method) {    if (!method.getAnnotation(Secured.class).user().equals(user)) {      throw new IllegalStateException(“Wrong user”);    }  }}</p>\n<p>通过上面的代码，我们可以看到，即便给定用户授予了访问权限，拦截器也没有调用原始的方法。为了解决这个问题，Byte Buddy有很多预定义的方法可以实现功能的链接。借助MethodDelegation类的andThen方法，上述的安全检查可以放到原始方法的调用之前，如下面的代码所示。如果用户没有进行认证的话，安全检查将会抛出异常并阻止后续的执行，因此原始方法将不会执行。</p>\n<p>将这些功能集合在一起，我们就能生成Service的一个子类，所有带有注解方法的都能恰当地进行安全保护。因为所生成的类是Service的子类，所以它能够替代所有类型为Service的变量，并不需要任何的类型转换，如果没有恰当认证的话，调用doSensitiveAction方法就会抛出异常：</p>\n<p>new ByteBuddy()  .subclass(Service.class)  .method(ElementMatchers.isAnnotatedBy(Secured.class))  .intercept(MethodDelegation.to(SecurityInterceptor.class)                             .andThen(SuperMethodCall.INSTANCE)))  .make()  .load(getClass().getClassLoader(),           ClassLoadingStrategy.Default.WRAPPER)  .getLoaded()  .newInstance()  .doSensitiveAction();</p>\n<p>不过坏消息是，因为实现instrumentation功能的子类是在运行时创建的，所以除了使用Java反射以外，没有其他办法创建这样的实例。因此，所有instrumentation类的实例都应该通过一个工厂来创建，这个工厂会封装创建instrumentation子类的复杂性。这样造成的结果就是，子类instrumentation通常会用于框架之中，这些框架本身就需要通过工厂来创建实例，例如，像依赖管理的框架Spring或对象-关系映射的框架Hibernate，而对于其他类型的应用来讲，子类instrumentation实现起来通常过于复杂。</p>\n<p>实现安全功能的Java agent</p>\n<p>通过使用Java agent，上述安全框架的一个替代实现将会修改Service类的原始字节码，而不是重写它。这样做的话，我们就没有必要创建托管的实例了，只需简单地调用</p>\n<p>new Service().doSensitiveAction()</p>\n<p>即可，如果对应的用户没有进行认证的话，就会抛出异常。为了支持这种方式，Byte Buddy提供一种称之为rebase某个类的理念。当rebase某个类的时候，不会创建子类，所采用的策略是实现instrumentation功能的代码将会合并到被instrument的类中，从而改变其行为。在添加instrumentation功能之后，在被instrument的类中，其所有方法的原始代码均可进行访问，因此像SuperMethodCall这样的instrumentation，工作方式与创建子类是完全一样的。</p>\n<p>创建子类与rebase的行为是非常类似的，所以两种操作的API执行方式是一致的，都会使用相同的DynamicType.Builder接口来描述某个类型。两种形式的instrumentation都可以通过ByteBuddy类来进行访问。为了使Java agent的定义更加便利，Byte Buddy还提供了 AgentBuilder类，它希望能够以一种简洁的方式应对一些通用的用户场景。为了定义Java agent实现方法级别的安全性，将如下的类定义为agent的入口点就足以完成该功能了：</p>\n<p>class SecurityAgent {  public static void premain(String arg, Instrumentation inst) {    new AgentBuilder.Default()    .type(ElementMatchers.any())    .transform((builder, type) -&gt; builder    .method(ElementMatchers.isAnnotatedBy(Secured.class)    .intercept(MethodDelegation.to(SecurityInterceptor.class)               .andThen(SuperMethodCall.INSTANCE))))    .installOn(inst);  }}</p>\n<p>如果将这个agent打包为jar文件并在命令行中进行指定，那么所有带有Secured注解的方法将会进行“转换”或重定义，从而实现安全保护。如果不激活这个Java agent的话，应用在运行时就不包含额外的安全检查。当然，这意味着如果对带有注解的代码进行单元测试的话，这些方法的调用并不需要特殊的搭建过程来模拟安全上下文。Java运行时会忽略掉无法在classpath中找到的注解类型，因此在运行带有注解的方法时，我们甚至完全可以在应用中移除掉安全库。</p>\n<p>另外一项优势在于，Java agent能够很容易地进行叠加。如果在命令行中指定多个Java agent的话，每个agent都有机会对类进行修改，其顺序就是在命令行中所指定的顺序。例如，我们可以采取这种方式将安全、日志以及监控框架联合在一起，而不需要在这些应用间增添任何形式的集成层。因此，使用Java agent实现横切的关注点提供了一种更为模块化的代码编写方式，而不必针对某个管理实例的中心框架来集成所有的代码。</p>\n<p>查看英文原文：Easily Create Java Agents with Byte Buddy</p>\n","site":{"data":{}},"length":10469,"excerpt":"","more":"<p>Java agent是在另外一个Java应用（“目标”应用）启动之前要执行的Java程序，这样agent就有机会修改目标应用或者应用所运行的环境。在本文中，我们将会从基础内容开始，逐渐增强其功能，借助字节码操作工具Byte Buddy，使其成为高级的agent实现。</p>\n<p>在最基本的用例中，Java agent会用来设置应用属性或者配置特定的环境状态，agent能够作为可重用和可插入的组件。如下的样例描述了这样的一个agent，它设置了一个系统属性，在实际的程序中就可以使用该属性了：</p>\n<p>public class Agent {  public static void premain(String arg) {    System.setProperty(“my-property”, “foo”);  }}</p>\n<p>如上面的代码所述，Java agent的定义与其他的Java程序类似，只不过它使用premain方法替代main方法作为入口点。顾名思义，这个方法能够在目标应用的main方法之前执行。相对于其他的Java程序，编写agent并没有特定的规则。有一个很小的区别在于，Java agent接受一个可选的参数，而不是包含零个或更多参数的数组。</p>\n<p>如果要使用这个agent，必须要将agent类和资源打包到jar中，并且在jar的manifest中要将Agent-Class属性设置为包含premain方法的agent类。（agent必须要打包到jar文件中，它不能通过拆解的格式进行指定。）接下来，我们需要启动应用程序，并且在命令行中通过javaagent参数来引用jar文件的位置：</p>\n<p>java -javaagent:myAgent.jar -jar myProgram.jar</p>\n<p>我们还可以在位置路径上设置可选的agent参数。在下面的命令中会启动一个Java程序并且添加给定的agent，将值myOptions作为参数提供给premain方法：</p>\n<p>java -javaagent:myAgent.jar=myOptions -jar myProgram.jar</p>\n<p>通过重复使用javaagent命令，能够添加多个agent。</p>\n<p>但是，Java agent的功能并不局限于修改应用程序环境的状态，Java agent能够访问Java instrumentation API，这样的话，agent就能修改目标应用程序的代码。Java虚拟机中这个鲜为人知的特性提供了一个强大的工具，有助于实现面向切面的编程。</p>\n<p>如果要对Java程序进行这种修改，我们需要在agent的premain方法上添加类型为Instrumentation的第二个参数。Instrumentation参数可以用来执行一系列的任务，比如确定对象以字节为单位的精确大小以及通过注册ClassFileTransformers实际修改类的实现。ClassFileTransformers注册之后，当类加载器（class loader）加载类的时候都会调用它。当它被调用时，在类文件所代表的类加载之前，类文件transformer有机会改变或完全替换这个类文件。按照这种方式，在类使用之前，我们能够增强或修改类的行为，如下面的样例所示：</p>\n<p>public class Agent { public static void premain(String argument, Instrumentation inst) {   inst.addTransformer(new ClassFileTransformer() {     @Override     public byte[] transform(       ClassLoader loader,       String className,       Class&lt;?&gt; classBeingRedefined, // 如果类之前没有加载的话，值为null       ProtectionDomain protectionDomain,       byte[] classFileBuffer) {       // 返回改变后的类文件。     }   }); }}</p>\n<p>通过使用Instrumentation实例注册上述的ClassFileTransformer之后，每个类加载的时候，都会调用这个transformer。为了实现这一点，transformer会接受一个二进制和类加载器的引用，分别代表了类文件以及试图加载类的类加载器。</p>\n<p>Java agent也可以在Java应用的运行期注册，如果是在这种场景下，instrumentation API允许重新定义已加载的类，这个特性被称之为“HotSwap”。不过，重新定义类仅限于替换方法体。在重新定义类的时候，不能新增或移除类成员，并且类型和签名也不能进行修改。当类第一次加载的时候，并没有这种限制，如果是在这样的场景下，那classBeingRedefined会被设置为null。</p>\n<p>Java字节码与类文件格式</p>\n<p>类文件代表了Java类编译之后的状态。类文件中会包含字节码，这些字节码代表了Java源码中最初的程序指令。Java字节码可以视为Java虚拟机的语言。实际上，JVM并不会将Java视为编程语言，它只能处理字节码。因为它采用二进制的表现形式，所以相对于程序的源码，它占用的空间更少。除此之外，将程序以字节码的形式进行表现能够更容易地编译Java以外的其他语言，如Scala或Clojure，从而让它们运行在JVM上。如果没有字节码作为中间语言的话，那么其他的程序在运行之前，可能还需要将其转换为Java源码。</p>\n<p>但是，在代码处理的时候，这种抽象却带来了一定的成本。如果要将ClassFileTransformer应用到某个类上，那我们不能将该类按照Java源码的形式进行处理，甚至不能假设被转换的代码最初是由Java编写而成的。更糟糕的是，探查类成员或注解的反射API也是禁止使用的，这是因为类加载之前，我们无法访问这些API，而在转换进程完成之前，是无法进行加载的。</p>\n<p>所幸的是，Java字节码相对来讲是一个比较简单的抽象形式，它包含了很少量的操作，稍微花点功夫我们就能大致将其掌握起来。Java虚拟机执行程序的时候，会以基于栈的方式来处理值。字节码指令一般会告知虚拟机，需要从操作数栈（operand stack）上弹出值，执行一些操作，然后再将结果压到栈中。</p>\n<p>让我们考虑一个简单的样例：将数字1和2进行相加操作。JVM首先会将这两个数字压到栈中，这是通过 iconst_1和iconst_2这两个字节指令实现的。iconst_1是个单字节的便捷运算符（operator），它会将数字1压到栈中。与之类似，iconst_2会将数字2压到栈中。然后，会执行iadd指令，它会将栈中最新的两个值弹出，将它们求和计算的结果重新压到栈中。在类文件中，每个指令并不是以其易于记忆的名称进行存储的，而是以一个字节的形式进行存储，这个字节能够唯一地标记特定的指令，这也是bytecode这个术语的来历。上文所述的字节码指令及其对操作数栈的影响，通过下面的图片进行了可视化。</p>\n<p><img src=\"\\images\\pasted-54.png\" alt=\"upload successful\"></p>\n<p>对于人类用户来讲，会更喜欢源码而不是字节码，不过幸运的是Java社区创建了多个库，能够解析类文件并将紧凑的字节码暴露为具有名称的指令流。例如，流行的ASM库提供了一个简单的visitor API，它能够将类文件剖析为成员和方法指令，其操作方式类似于阅读XML文件时的SAX解析器。如果使用ASM的话，那上述样例中的字节码可以按照如下的代码来进行实现（在这里，ASM方式的指令是visitIns，能够提供修正的方法实现）：</p>\n<p>MethodVisitor methodVisitor = …methodVisitor.visitIns(Opcodes.ICONST_1);methodVisitor.visitIns(Opcodes.ICONST_2);methodVisitor.visitIns(Opcodes.IADD);</p>\n<p>需要注意的是，字节码规范只不过是一种比喻的说法（metaphor），因为Java虚拟机允许将程序转换为优化后的机器码（machine code），只要程序的输出能够保证是正确的即可。因为字节码的简洁性，所以在已有的类中取代和修改指令是很简单直接的。因此，使用ASM及其底层的Java字节码基础就足以实现类转换的Java agent，这需要注册一个ClassFileTransformer，它会使用这个库来处理其参数。</p>\n<p>克服字节码的不足</p>\n<p>对于实际的应用来讲，解析原始的类文件依然意味着有很多的手动工作。Java程序员通常感兴趣的是类型层级结构中的类。例如，某个Java agent可能需要修改所有实现给定接口的类。如果要确定某个类的超类，那只靠解析ClassFileTransformer所给定的类文件就不够了，类文件中只包含了直接超类和接口的名字。为了解析可能的超类型关联关系，程序员依然需要定位这些类型的类文件。</p>\n<p>在项目中直接使用ASM的另外一个困难在于，团队中需要有开发人员学习Java字节码的基础知识。在实践中，这往往会导致很多的开发人员不敢再去修改字节码操作相关的代码。如果这样的话，实现Java agent很容易为项目的长期维护带来风险。</p>\n<p>为了克服这些问题，我们最好使用较高层级的抽象来实现Java agent，而不是直接操作Java字节码。Byte Buddy是开源的、基于Apache 2.0许可证的库，它致力于解决字节码操作和instrumentation API的复杂性。Byte Buddy所声称的目标是将显式的字节码操作隐藏在一个类型安全的领域特定语言背后。通过使用Byte Buddy，任何熟悉Java编程语言的人都有望非常容易地进行字节码操作。</p>\n<p>Byte Buddy简介</p>\n<p>Byte Buddy的目的并不仅仅是为了生成Java agent。它提供了一个API用于生成任意的Java类，基于这个生成类的API，Byte Buddy提供了额外的API来生成Java agent。</p>\n<p>作为Byte Buddy的简介，如下的样例展现了如何生成一个简单的类，这个类是Object的子类，并且重写了toString方法，用来返回“Hello World!”。与原始的ASM类似，“intercept”会告诉Byte Buddy为拦截到的指令提供方法实现：</p>\n<p>Class&lt;?&gt; dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(“toString”))  .intercept(FixedValue.value(“Hello World!”))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();</p>\n<p>从上面的代码中，我们可以看到Byte Buddy要实现一个方法分为两步。首先，编程人员需要指定一个ElementMatcher，它负责识别一个或多个需要实现的方法。Byte Buddy提供了功能丰富的预定义拦截器（interceptor），它们暴露在ElementMatchers类中。在上述的例子中，toString方法完全精确匹配了名称，但是，我们也可以匹配更为复杂的代码结构，如类型或注解。</p>\n<p>当Byte Buddy生成类的时候，它会分析所生成类型的类层级结构。在上述的例子中，Byte Buddy能够确定所生成的类要继承其超类Object的名为toString的方法，指定的匹配器会要求Byte Buddy重写该方法，这是通过随后的 Implementation 实例实现的，在我们的样例中，这个实例也就是FixedValue。</p>\n<p>当创建子类的时候，Byte Buddy始终会拦截（intercept）一个匹配的方法，在生成的类中重写该方法。但是，我们在本文稍后将会看到Byte Buddy还能够重新定义已有的类，而不必通过子类的方式来实现。在这种情况下，Byte Buddy会将已有的代码替换为生成的代码，而将原有的代码复制到另外一个合成的（synthetic）方法中。</p>\n<p>在我们上面的代码样例中，匹配的方法进行了重写，在实现里面，返回了固定的值“Hello World!”。intercept方法接受Implementation类型的参数，Byte Buddy自带了多个预先定义的实现，如上文所使用的FixedValue类。但是，如果需要的话，可以使用前文所述的ASM API将某个方法实现为自定义的字节码，Byte Buddy本身也是基于ASM API实现的。</p>\n<p>定义完类的属性之后，就能通过make方法来进行生成。在样例应用中，因为用户没有指定类名，所以生成的类会给定一个任意的名称。最终，生成的类将会使用ClassLoadingStrategy来进行加载。通过使用上述的默认 WRAPPER策略，类将会使用一个新的类加载器进行加载，这个类加载器会使用环境类加载器作为父加载器。</p>\n<p>类加载之后，使用Java反射API就可以访问它了。如果没有指定其他构造器的话，Byte Buddy将会生成类似于父类的构造器，因此生成的类可以使用默认的构造器。这样，我们就可以检验生成的类重写了 toString方法，如下面的代码所示：</p>\n<p>assertThat(dynamicType.newInstance().toString(),            is(“Hello World!”));</p>\n<p>当然，这个生成的类并没有太大的用处。对于实际的应用来讲，大多数方法的返回值是在运行时计算的，这个计算过程要依赖于方法的参数和对象的状态。</p>\n<p>通过委托实现Instrumentation</p>\n<p>要实现某个方法，有一种更为灵活的方式，那就是使用Byte Buddy的MethodDelegation。通过使用方法委托，在生成重写的实现时，我们就有可能调用给定类和实例的其他方法。按照这种方式，我们可以使用如下的委托器（delegator）重新编写上述的样例：</p>\n<p>class ToStringInterceptor {  static String intercept() {    return “Hello World!”;  }}</p>\n<p>借助上面的POJO拦截器，我们就可以将之前的FixedValue实现替换为MethodDelegation.to(ToStringInterceptor.class)：</p>\n<p>Class&lt;?&gt; dynamicType = new ByteBuddy()  .subclass(Object.class)  .method(ElementMatchers.named(“toString”))  .intercept(MethodDelegation.to(ToStringInterceptor.class))  .make()  .load(getClass().getClassLoader(),                  ClassLoadingStrategy.Default.WRAPPER)  .getLoaded();</p>\n<p>使用上述的委托器，Byte Buddy会在to方法所给定的拦截目标中，确定最优的调用方法。就ToStringInterceptor.class来讲，选择过程只是非常简单地解析这个类型的唯一静态方法而已。在本例中，只会考虑一个静态方法，因为委托的目标中指定的是一个类。与之不同的是，我们还可以将其委托给某个类的实例，如果是这样的话，Byte Buddy将会考虑所有的虚方法（virtual method）。如果类或实例上有多个这样的方法，那么Byte Buddy首先会排除掉所有与指定instrumentation不兼容的方法。在剩余的方法中，库将会选择最佳的匹配者，通常来讲这会是参数最多的方法。我们还可以显式地指定目标方法，这需要缩小合法方法的范围，将ElementMatcher传递到MethodDelegation中，就会进行方法的过滤。例如，通过添加如下的filter，Byte Buddy只会将名为“intercept”的方法视为委托目标：</p>\n<p>MethodDelegation.to(ToStringInterceptor.class)                .filter(ElementMatchers.named(“intercept”))</p>\n<p>执行上面的拦截之后，被拦截到的方法依然会打印出“Hello World!”，但是这次的结果是动态计算的，这样的话，我们就可以在拦截器方法上设置断点，所生成的类每次调用toString时，都会触发拦截器的方法。</p>\n<p>当我们为拦截器方法设置参数时，就能释放出MethodDelegation的全部威力。这里的参数通常是带有注解的，用来要求Byte Buddy在调用拦截器方法时，注入某个特定的值。例如，通过使用@Origin注解，Byte Buddy提供了添加instrument功能的方法的实例，将其作为Java反射API中类的实例：</p>\n<p>class ContextualToStringInterceptor {  static String intercept(@Origin Method m) {    return “Hello World from ” + m.getName() + “!”;  }}</p>\n<p>当拦截toString方法时，对instrument方法的调用将会返回“Hello world from toString!”。</p>\n<p>除了@Origin注解以外，Byte Buddy提供了一组功能丰富的注解。例如，通过在类型为Callable的参数上使用@Super注解，Byte Buddy会创建并注入一个代理实例，它能够调用被instrument方法的原始代码。如果对于特定的用户场景，所提供的注解不能满足需求或者不太适合的话，我们甚至能够注册自定义的注解，让这些注解注入用户特定的值。</p>\n<p>实现方法级别的安全性</p>\n<p>可以看到，我们在运行时可以借助简单的Java代码，使用MethodDelegation来动态重写某个方法。这只是一个简单的样例，但是这项技术可以用到更加实际的应用之中。在本文剩余的内容中，我们将会开发一个样例，它会使用代码生成技术实现一个注解驱动的库，用来限制方法级别的安全性。在我们的第一个迭代中，这个库会通过生成子类的方式来限制安全性。然后，我们将会采取相同的方式来实现Java agent，完成相同的功能。</p>\n<p>样例库会使用如下的注解，允许用户指定某个方法需要考虑安全因素：</p>\n<p>@interface Secured {  String user();}</p>\n<p>例如，假设应用需要使用如下的Service类来执行敏感操作，并且只有用户被认证为管理员才能执行该方法。这是通过为执行这个操作的方法声明Secured注解来指定的：</p>\n<p>class Service {  @Secured(user = “ADMIN”)  void doSensitiveAction() {    // 运行敏感代码…  }}</p>\n<p>我们当然可以将安全检查直接编写到方法中。在实际中，硬编码横切关注点往往会导致复制-粘贴的逻辑，使其难以维护。另外，一旦应用需要涉及额外的需求时，如日志、收集调用指标或结果缓存，直接添加这样的代码扩展性不会很好。通过将这样的功能抽取到agent中，方法就能很纯粹地关注其业务逻辑，使得代码库能够更易于阅读、测试和维护。</p>\n<p>为了让我们规划的库保持尽可能得简单，按照注解的协议声明，如果当前用户不具备注解的用户属性时，将会抛出IllegalStateException异常。通过使用Byte Buddy，这种行为可以用一个简单的拦截器来实现，如下面样例中的SecurityInterceptor所示，它会通过其静态的user域，跟踪当前用户已经进行了登录：</p>\n<p>class SecurityInterceptor {  static String user = “ANONYMOUS”  static void intercept(@Origin Method method) {    if (!method.getAnnotation(Secured.class).user().equals(user)) {      throw new IllegalStateException(“Wrong user”);    }  }}</p>\n<p>通过上面的代码，我们可以看到，即便给定用户授予了访问权限，拦截器也没有调用原始的方法。为了解决这个问题，Byte Buddy有很多预定义的方法可以实现功能的链接。借助MethodDelegation类的andThen方法，上述的安全检查可以放到原始方法的调用之前，如下面的代码所示。如果用户没有进行认证的话，安全检查将会抛出异常并阻止后续的执行，因此原始方法将不会执行。</p>\n<p>将这些功能集合在一起，我们就能生成Service的一个子类，所有带有注解方法的都能恰当地进行安全保护。因为所生成的类是Service的子类，所以它能够替代所有类型为Service的变量，并不需要任何的类型转换，如果没有恰当认证的话，调用doSensitiveAction方法就会抛出异常：</p>\n<p>new ByteBuddy()  .subclass(Service.class)  .method(ElementMatchers.isAnnotatedBy(Secured.class))  .intercept(MethodDelegation.to(SecurityInterceptor.class)                             .andThen(SuperMethodCall.INSTANCE)))  .make()  .load(getClass().getClassLoader(),           ClassLoadingStrategy.Default.WRAPPER)  .getLoaded()  .newInstance()  .doSensitiveAction();</p>\n<p>不过坏消息是，因为实现instrumentation功能的子类是在运行时创建的，所以除了使用Java反射以外，没有其他办法创建这样的实例。因此，所有instrumentation类的实例都应该通过一个工厂来创建，这个工厂会封装创建instrumentation子类的复杂性。这样造成的结果就是，子类instrumentation通常会用于框架之中，这些框架本身就需要通过工厂来创建实例，例如，像依赖管理的框架Spring或对象-关系映射的框架Hibernate，而对于其他类型的应用来讲，子类instrumentation实现起来通常过于复杂。</p>\n<p>实现安全功能的Java agent</p>\n<p>通过使用Java agent，上述安全框架的一个替代实现将会修改Service类的原始字节码，而不是重写它。这样做的话，我们就没有必要创建托管的实例了，只需简单地调用</p>\n<p>new Service().doSensitiveAction()</p>\n<p>即可，如果对应的用户没有进行认证的话，就会抛出异常。为了支持这种方式，Byte Buddy提供一种称之为rebase某个类的理念。当rebase某个类的时候，不会创建子类，所采用的策略是实现instrumentation功能的代码将会合并到被instrument的类中，从而改变其行为。在添加instrumentation功能之后，在被instrument的类中，其所有方法的原始代码均可进行访问，因此像SuperMethodCall这样的instrumentation，工作方式与创建子类是完全一样的。</p>\n<p>创建子类与rebase的行为是非常类似的，所以两种操作的API执行方式是一致的，都会使用相同的DynamicType.Builder接口来描述某个类型。两种形式的instrumentation都可以通过ByteBuddy类来进行访问。为了使Java agent的定义更加便利，Byte Buddy还提供了 AgentBuilder类，它希望能够以一种简洁的方式应对一些通用的用户场景。为了定义Java agent实现方法级别的安全性，将如下的类定义为agent的入口点就足以完成该功能了：</p>\n<p>class SecurityAgent {  public static void premain(String arg, Instrumentation inst) {    new AgentBuilder.Default()    .type(ElementMatchers.any())    .transform((builder, type) -&gt; builder    .method(ElementMatchers.isAnnotatedBy(Secured.class)    .intercept(MethodDelegation.to(SecurityInterceptor.class)               .andThen(SuperMethodCall.INSTANCE))))    .installOn(inst);  }}</p>\n<p>如果将这个agent打包为jar文件并在命令行中进行指定，那么所有带有Secured注解的方法将会进行“转换”或重定义，从而实现安全保护。如果不激活这个Java agent的话，应用在运行时就不包含额外的安全检查。当然，这意味着如果对带有注解的代码进行单元测试的话，这些方法的调用并不需要特殊的搭建过程来模拟安全上下文。Java运行时会忽略掉无法在classpath中找到的注解类型，因此在运行带有注解的方法时，我们甚至完全可以在应用中移除掉安全库。</p>\n<p>另外一项优势在于，Java agent能够很容易地进行叠加。如果在命令行中指定多个Java agent的话，每个agent都有机会对类进行修改，其顺序就是在命令行中所指定的顺序。例如，我们可以采取这种方式将安全、日志以及监控框架联合在一起，而不需要在这些应用间增添任何形式的集成层。因此，使用Java agent实现横切的关注点提供了一种更为模块化的代码编写方式，而不必针对某个管理实例的中心框架来集成所有的代码。</p>\n<p>查看英文原文：Easily Create Java Agents with Byte Buddy</p>\n"},{"title":"spring-boot1.3.5支持jsp导致浏览器访问应用偶尔慢","author":"Xiang Chuang","date":"2019-07-08T06:42:00.000Z","_content":"本文将阐述在基于spring-boot1.3.5日常开发中所遇到的一个疑惑的问题，下面将按照问题处理的过程进行行文！！！\n\n一、项目简介：\n\t这儿有一个业务系统，我们称之为M，架构基于springboot1.3.5，同时提供了web能力，前后端分离。线上生产环境中，外部商户的【取现业务】会跳转到本系统的页面上进行操作，实际场景中更多的是手机端进行页面跳转，但也可以PC端网页版跳转，因为M是基于spring-mvc提供的能力（这是对项目的通用认知，但某些关键的细节点并没有包含在里面，以至于在后续问题分析中走了很多弯路，耗时2天半才定位到问题）。\n    \n二、问题现象\n\t业务运行过程中，外部商户吐槽声来了，为什么跳转到你们的页面那么慢，耗时3-4s甚至更久，且频次比较高（后经运维部门同时查看，发现超过10%的请求出现慢的情况）。由于外部商户是移动端app，因此业务跳转耗时3-4s反馈到用户那儿便是点击确认操作后白板3-4s。这确实是一个糟糕的用户体验！另，据相关小伙伴反映，这是一个由来已久的问题，只是以前业务少，而且是自己的前端业务部门使用，有时忍忍就过去了。（这儿提到这一点，因为，如果能证实以前的慢和现在的慢问题一样，那么可以推导出并不是新的改动后其他操作带来的新问题，这对问题定位有指导性意义，但分析问题时总归是仓促的，这些信息极容易被丢掉）。\n    \n三、业务描述\n\t为了阐述问题的分析过程，业务场景必须清晰，下面简介一下该业务场景：\n    \n![upload successful](\\images\\pasted-88.png)\n\n四、问题排查\n\t通过前面的描述，我们知道了业务场景、系统情况及问题现象，接下来，我们开始了问题排查的过程，这过程，是痛苦的！！！\na、首先，我们根据商户提供的流水号进行日志查询，发现商户请求的时间和我们底层系统M实际收到的时间确实相差了3-4s，于是，我们找到了入口系统Api，因为整个业务场景，是由Api进行的页面跳转，会不会是Api做了什么事，导致页面跳转慢了？\nb、通过查询Api的日志，发现收到请求的时间确实和商户时间一致，我们似乎找到问题根源，即Api有问题，但当进一步排查时，发现Api和M的交互只是做了简单的302重定向，并无其他逻辑，且发现Api发起重定向的时间到M“接收”到请求便耗时了3-4s，于是，我们把矛头指向了网络问题，加之跳转过程是用的域名跳转，我们更深信这3-4s花在了网络上！\nc、我们怀疑是否是网络问题，于是找到运维的小伙伴，一通排查，回复我们网络没问题，并给了我们ng日志\n![upload successful](\\images\\pasted-89.png)\nd、这个回复让我们不甘心，因为我们的Api正常的发起了跳转请求，我们的M系统3-4s后才接收到请求，那这耗时一定是在网络上啊，并多次反复追问信息中心域名等相关网络问题，后来，我通过PC页面直接进行测试（因为我也是该产品的用户），当我一顿操作并点击确认按钮后，咦，很快呀，但，接下来我反复的重试、刷新、重试，果不其然偶尔出现了一笔3-4s的耗时，看来这真是偶尔出现呀（偶发问题，那这不应该是应用问题呀！），紧接着我使用谷歌浏览器看了请求情况，发现如下信息：\n![upload successful](\\images\\pasted-90.png)，咦，这耗时花在了TTFB上面呀，然后百度一查，TTFB包含了tcp握手时间及服务端返回第一个字节的时间。哦，那这不正说明了网络问题嘛！同时我发现处理页面偶尔慢，某些纯后台服务或者图片也慢呀，于是又找到了运维同事，这已经大半天过去了（虽然中间处理问题断断续续）\ne、这时，运维同事按照我们的方式测试，也确实出现了偶尔慢，他们抓包分析，发现当前网络正常呀，但有一个现象，慢的请求有三次重复ACK的现象，这是什么鬼？运维同事说这是正常的，TCP包乱序会重复发起ACK嘛，我将信将疑，但问题没说通啊，为什么慢，一小时过去了。这时更多的同事加入到问题分析，运维小伙伴为证明不是网络问题，在线上服务器直接ip访问页面，发现，也会出现慢，于是，我们也选择相信了网络没问题，但问题是什么？\nf、这时我们测试过程中，又发现了某些图片资源404，某些图片资源即使存在但偶尔会慢，咦，是不是因为页面访问了资源而资源慢导致页面慢？这时其实问题的分析稍有偏差了，因为前面d的时候已经出现过类似问题，但没有包含资源的纯后台功能也慢啊！但花了近一天的分析，实在是太困惑，于是我们朝着这个方向去了。\ng、我们把页面扣了出来，并扔到了ng上，既然图片资源慢，我们改动页面，以至于后面仅仅是一个纯文本页面了，确实，访问不慢了（但前面说了，这已经偏离了，因为页面位于ng中，而不是项目中，但这也是分析的必经之地，因为这儿确实也存在问题），我们尝试加上css、js资源，慢又出现了，并且发现都是图标慢，但，这不应该呀，CDN上静态资源应该很快呀，但后面我们发现这些慢的图片并不位于CDN，而是在项目M中，同时也存在访问了CDN上不存在且并不需要依赖的资源。我们把图片映射做了一下ng映射（前面说的这是在ng上的页面），再次访问，正常了。于是结论出来了，至少，前端开发中，动静分离不合规，同时copy代码，无用的资源访问也出现了。这是今天耗时一天的分析结论。但。\nh、第二天，上班后，按照昨日的分析，前端进行了标准化的优化，上线，但问题依旧（毕竟前面图片这个问题是问题，但不是这次问题的根本问题）。这时，大家伙都很无语了，不知道为什么了！运维小伙伴又将纯文本页面扔到M项目中，启动访问，发现，也会慢呀，什么情况！同时，相同页面单独扔到tomcat中启动就正常，哎，见鬼了。似乎无下文了。\ni、这时M系统负责人突然说到，测试环境能重现慢的问题，（我似乎看到了一丝曙光），但本地启动没问题（这个。。。），，难道还是环境问题？我来到测试环境中进行测试，看着业务日志与gc日志，发现几乎每次慢的时候就会做一次gc回收，咦，内存有问题？（实际是因为测试环境内存小，512M堆大小），但我又发现线上gc正常啊，但一点蛛丝马迹都得一试，把线上1.5G堆调成了4G堆，不过，问题依旧啊，似乎还慢的更频繁的样子（还好是基于http访问有硬件负载均衡，正常业务跑不进来）。\nj、心有不甘，但想着能重现问题，应该就能定位到问题，于是我开始了代码分析之路，和其他小伙伴从两个方向并行去分析，都耗时一天半了，心想着，两个思路一起搞，兴许快点。既然测试环境能重现，好吧，我试试本地是不是真重现不了，我打开idea启动M，一顿尝试，好像真不可以呢。但我debug到了请求执行的环节，那，好吧，开启debug日志在测试环境看看，是哪个环节慢了？基于warn日志级别重启测试环境M，然后测试，发现，咦，真是的业务系统自己慢呢，已经收到请求了，在某个环节慢，而且，把页面扔到其他系统进行访问却没问题：\n```\n2019-07-05 19:05:38.955 DEBUG [http-nio-8004-exec-3] InternalNioInputBuffer:180-- Received [GET /creditCard/cardBinInfo.json HTTP/1.1\nHost: 192.168.46.3:8004\nConnection: keep-alive\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Mobile Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Encoding: gzip, deflate, sdch\nAccept-Language: zh-CN,zh;q=0.8\nCookie: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3\n\n]\n2019-07-05 19:05:38.956 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [uriBC] has value [/creditCard/cardBinInfo.json]\n2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [semicolon] has value [-1]\n2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [enc] has value [utf-8]\n2019-07-05 19:05:42.640 DEBUG [http-nio-8004-exec-3] LegacyCookieProcessor:180-- Cookies: Parsing b[]: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3\n2019-07-05 19:05:42.643 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180--  Requested cookie session id is 0714ad72-0e83-43d9-8b87-b002c34a71f3\n2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] RemoteIpValve:180-- Incoming request /creditCard/cardBinInfo.json with originalRemoteAddr '192.168.47.152', originalRemoteHost='192.168.47.152', originalSecure='false', originalScheme='http' will be seen as newRemoteAddr='192.168.47.152', newRemoteHost='192.168.47.152', newScheme='http', newSecure='false'\n2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180-- Security checking request GET /creditCard/cardBinInfo.json\n2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] RealmBase:180--   No applicable constraints defined\n2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180--  Not subject to any constraint\n2019-07-05 19:05:42.653 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:114-- Bound request context to thread: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61\n2019-07-05 19:05:42.654 DEBUG [http-nio-8004-exec-3] DispatcherServlet:863-- DispatcherServlet with name 'dispatcherServlet' processing GET request for [/creditCard/cardBinInfo.json]\n2019-07-05 19:05:42.655 DEBUG [http-nio-8004-exec-3] Parameters:180-- Set encoding to UTF-8\n2019-07-05 19:05:42.660 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json\n2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:311-- Did not find handler method for [/creditCard/cardBinInfo.json]\n2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json\n2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:308-- Returning handler method [public java.lang.Object com.yiji.mobilepay.web.controller.CreditCardWithdrawControler.cardBinInfo(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,javax.servlet.http.HttpSession)]\n2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] DefaultListableBeanFactory:251-- Returning cached instance of singleton bean 'creditCardWithdrawControler'\n2019-07-05 19:05:42.693 DEBUG [http-nio-8004-exec-3] DispatcherServlet:949-- Last-Modified value for [/creditCard/cardBinInfo.json] is: -1\n2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.831 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResources(META-INF/services/com.alibaba.fastjson.serializer.AutowiredObjectSerializer)\n2019-07-05 19:05:42.841 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.842 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.847 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoBeanInfo)\n2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Returning ClassNotFoundException\n2019-07-05 19:05:42.866 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoCustomizer)\n2019-07-05 19:05:42.867 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Returning ClassNotFoundException\n2019-07-05 19:05:42.869 DEBUG [dubbo-remoting-client-heartbeat-thread-1] HeartBeatTask:66--  [DUBBO] Send heartbeat to remote channel /192.168.46.3:20917, cause: The channel has no data-transmission exceeds a heartbeat period: 60000ms\n2019-07-05 19:05:42.870 DEBUG [New I/O client worker #1-3] HeartbeatHandler:82--  [DUBBO] Receive heartbeat response in thread New I/O client worker #1-3\n2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(Object.class)\n2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.875 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(Object.class)\n2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.877 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(String.class)\n2019-07-05 19:05:42.878 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(String.class)\n2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.880 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.881 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(StringBuilder.class)\n2019-07-05 19:05:42.882 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(StringBuilder.class)\n2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.884 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com.class)\n2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.888 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com.class)\n2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.890 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(java/lang/com.class)\n2019-07-05 19:05:42.891 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(java/lang/com.class)\n2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.893 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf.class)\n2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.895 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf.class)\n2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.897 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common.class)\n2019-07-05 19:05:42.898 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common.class)\n2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.900 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common/util.class)\n2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.902 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common/util.class)\n2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.908 DEBUG [http-nio-8004-exec-3] ToString:550-- classloader:TomcatEmbeddedWebappClassLoader\n  context: ROOT\n  delegate: true\n----------> Parent Classloader:\norg.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n\n2019-07-05 19:05:42.910 DEBUG [http-nio-8004-exec-3] RequestResponseBodyMethodProcessor:225-- Written [ViewResultInfo{code=null,data=null,message=请通过网页正常步骤进行访问或者系统已超时,success=false}] as \"application/json;charset=UTF-8\" using [com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter@3220bfbc]\n2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:1036-- Null ModelAndView returned to DispatcherServlet with name 'dispatcherServlet': assuming HandlerAdapter completed request handling\n2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:997-- Successfully completed request\n2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:104-- Cleared thread-bound request context: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61\n2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n```\n但是，这个环节去干什么了呢？源代码日志很少，看不出来呀！难道是分布式session问题，发现springboot分布式session我们内部是用redis实现的，后经一顿排查，发现上面日志中已经包含了redis的操作，但是是在慢的那个环节之后呀（不过提了个醒，以后redis要是抽风，这也是个风险点呢）。\nk、现在知道问题就出在org.apache.catalina.connector.CoyoteAdapter这个类日志中显示的慢的那个环节了，但他究竟干了什么？貌似只是简单的一些操作啊，代码层次很深，今天也疲惫了，就没往深处看，为什么本地测试不出现问题？带着这些疑问，今天收班了。\nl、今天本来是周六，但问题没解决，心有不甘呀，而且都能重现问题了，要是不定位到，好可惜。于是背着包来到了公司，反正今日无安排！来到公司，经过昨晚和今早放松了大脑，又准备整装待发了。本地不出问题，难道是打包环节不一样？两个私服不一致?于是我把测试环境的jar包拷了下来，java XXX -jar启动，咦，本地重现问题了！真是私服问题，包版本不一致？我又把本地项目用另一个私服打了jar包java XXX -jar启动，咦，问题也重现了，哦！原来是idea启动时候和java -jar有些区别（也许是classpath加载的区别吧），此处没深究，但很庆幸，本地重现问题，离问题定位再进一步\nm、既然本地都重现问题了，虽然不能用idea断点测试，但我改改源码加加日志吧。ok！源码日志已加好，这下日志详细了吧，java XXX -jar启动，测试，啊！原来是这慢，还以为只是简单的map呢，被类名迷惑了：\n```\n2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion start............................\n2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion end............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI start............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI end............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion start............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion end............................\n2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts start............................{}false\n2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts end............................{}localhost\n2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu start............................{}\n2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu end............................{}\n2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start1............................{}\n2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start4............................{}\n2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start5............................{}\n2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start6............................{}\n2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start7............................{}\n```\n源码\n```\n// This will map the the latest version by default\n            connector.getService().getMapper().map(serverName, decodedURI,\n                    version, request.getMappingData());\n```\n此时内心激动，问题似乎更清晰了，打开idea，断点调试，往里面跟，发现了一个gateway页面，咦，这是我们自定义的页面，全项目搜索一下，它干啥了！\n源码：\n```\n // Rule 1 -- Exact Match\n        MappedWrapper[] exactWrappers = contextVersion.exactWrappers;\n        internalMapExactWrapper(exactWrappers, path, mappingData);\n\n        // Rule 2 -- Prefix Match\n        boolean checkJspWelcomeFiles = false;\n        MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;\n        if (mappingData.wrapper == null) {\n            internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,\n                                       path, mappingData);                                    \n```\n包含gateway的代码：\n```\n@Configuration\npublic class StargateConfigration {\n\t@Bean\n\tpublic ServletRegistrationBean dispatcherRegistration(StargateDispachServlet stargateDispachServlet) {\n\t    ServletRegistrationBean registration = new ServletRegistrationBean(\n\t    \t\tstargateDispachServlet);\n\t    registration.addUrlMappings(\"/gateway\");\n\t    return registration;\n\t}\n\n```\n咦，servlet，我顿时想起以前好像我们的spring-boot专门做了对jsp的支持，于是来到我们的tomcat-staters，\n```\n\n\t@Bean(name = \"yijiEmbeddedServletContainerCustomizer\")\n\tpublic EmbeddedServletContainerCustomizer embeddedServletContainerCustomizer() {\n\t\t\n\t\treturn container -> {\n\t\t\t//1. disable jsp if possible\n\t\t\tif (!tomcatProperties.getJsp().isEnable()) {\n\t\t\t\tJspServlet jspServlet = new JspServlet();\n\t\t\t\tjspServlet.setRegistered(false);\n\t\t\t\tcontainer.setJspServlet(jspServlet);\n\t\t\t}\n```\n难道是M系统启用了yiji.tomcat.jsp.enable=true？通过线上系统变量搜索，发现，确实，M启用了，其他系统没有，恍然大悟，这就是为什么M有问题而其他系统没问题的原因吧！于是我java -Dyiji.tomcat.jsp.enable=false -jar M，测试，果然，不慢了。。。问题终于定位到，spring-boot本身不推荐jsp，但提供了支持，这说明本身支持的方式就存在性能问题！\nn、嗯，接下来，下掉jsp吧，本来这就是遗留问题，传统项目采用jsp，切换springboot后强行支持了jsp，但却有性能问题！还有安全漏洞！\n\n下面说说spring-boot如何支持jsp吧。其实就是多注册一个JspServlet!\n1、添加依赖\n```\n<dependency>\n            <groupId>org.apache.tomcat.embed</groupId>\n            <artifactId>tomcat-embed-jasper</artifactId>\n            <scope>provided</scope>\n        </dependency>\n        <dependency>\n            <groupId>javax.servlet</groupId>\n            <artifactId>jstl</artifactId>\n        </dependency>\n```\n2、配置文件中指定jsp文件存放路径\n```\n#路径,在webapp文件夹下新建文件夹WEB-INF,在往下建文件夹jsp\nspring.mvc.view.prefix=/WEB-INF/jsp/\n#文件名的后缀,例如:index.jsp,放在jsp文件夹下\nspring.mvc.view.suffix=.jsp\n```\n![upload successful](\\images\\pasted-91.png)\n3、作为框架，我们默认不支持jsp，因为有性能损耗\n```\nif (!tomcatProperties.getJsp().isEnable()) {\n\t\t\t\tJspServlet jspServlet = new JspServlet();\n\t\t\t\tjspServlet.setRegistered(false);\n\t\t\t\tcontainer.setJspServlet(jspServlet);\n\t\t\t}\n```\n4、业务系统根据自身情况决定是否启动jsp支持，启用，意味着接受性能损耗！\n\n心得：\n  本地问题分析历史2天半（中途很多时间在处理其他事情），心理感受颇多，分析线上类似问题一定要思路清晰，类似问题，先网路再应用，另外一定要有主线，如果能本地重现问题，那可是天大的好事，源码跟踪，源码添加日志可有效帮我们分析问题，总之，分析跨系统、跨部门、框架级问题时，协作、心态很重要！","source":"_posts/spring-boot1-3-5支持jsp导致浏览器访问应用偶尔慢.md","raw":"title: spring-boot1.3.5支持jsp导致浏览器访问应用偶尔慢\nauthor: Xiang Chuang\ntags:\n  - spring-boot\n  - jsp\ncategories:\n  - 这些年，那些坑\ndate: 2019-07-08 14:42:00\n---\n本文将阐述在基于spring-boot1.3.5日常开发中所遇到的一个疑惑的问题，下面将按照问题处理的过程进行行文！！！\n\n一、项目简介：\n\t这儿有一个业务系统，我们称之为M，架构基于springboot1.3.5，同时提供了web能力，前后端分离。线上生产环境中，外部商户的【取现业务】会跳转到本系统的页面上进行操作，实际场景中更多的是手机端进行页面跳转，但也可以PC端网页版跳转，因为M是基于spring-mvc提供的能力（这是对项目的通用认知，但某些关键的细节点并没有包含在里面，以至于在后续问题分析中走了很多弯路，耗时2天半才定位到问题）。\n    \n二、问题现象\n\t业务运行过程中，外部商户吐槽声来了，为什么跳转到你们的页面那么慢，耗时3-4s甚至更久，且频次比较高（后经运维部门同时查看，发现超过10%的请求出现慢的情况）。由于外部商户是移动端app，因此业务跳转耗时3-4s反馈到用户那儿便是点击确认操作后白板3-4s。这确实是一个糟糕的用户体验！另，据相关小伙伴反映，这是一个由来已久的问题，只是以前业务少，而且是自己的前端业务部门使用，有时忍忍就过去了。（这儿提到这一点，因为，如果能证实以前的慢和现在的慢问题一样，那么可以推导出并不是新的改动后其他操作带来的新问题，这对问题定位有指导性意义，但分析问题时总归是仓促的，这些信息极容易被丢掉）。\n    \n三、业务描述\n\t为了阐述问题的分析过程，业务场景必须清晰，下面简介一下该业务场景：\n    \n![upload successful](\\images\\pasted-88.png)\n\n四、问题排查\n\t通过前面的描述，我们知道了业务场景、系统情况及问题现象，接下来，我们开始了问题排查的过程，这过程，是痛苦的！！！\na、首先，我们根据商户提供的流水号进行日志查询，发现商户请求的时间和我们底层系统M实际收到的时间确实相差了3-4s，于是，我们找到了入口系统Api，因为整个业务场景，是由Api进行的页面跳转，会不会是Api做了什么事，导致页面跳转慢了？\nb、通过查询Api的日志，发现收到请求的时间确实和商户时间一致，我们似乎找到问题根源，即Api有问题，但当进一步排查时，发现Api和M的交互只是做了简单的302重定向，并无其他逻辑，且发现Api发起重定向的时间到M“接收”到请求便耗时了3-4s，于是，我们把矛头指向了网络问题，加之跳转过程是用的域名跳转，我们更深信这3-4s花在了网络上！\nc、我们怀疑是否是网络问题，于是找到运维的小伙伴，一通排查，回复我们网络没问题，并给了我们ng日志\n![upload successful](\\images\\pasted-89.png)\nd、这个回复让我们不甘心，因为我们的Api正常的发起了跳转请求，我们的M系统3-4s后才接收到请求，那这耗时一定是在网络上啊，并多次反复追问信息中心域名等相关网络问题，后来，我通过PC页面直接进行测试（因为我也是该产品的用户），当我一顿操作并点击确认按钮后，咦，很快呀，但，接下来我反复的重试、刷新、重试，果不其然偶尔出现了一笔3-4s的耗时，看来这真是偶尔出现呀（偶发问题，那这不应该是应用问题呀！），紧接着我使用谷歌浏览器看了请求情况，发现如下信息：\n![upload successful](\\images\\pasted-90.png)，咦，这耗时花在了TTFB上面呀，然后百度一查，TTFB包含了tcp握手时间及服务端返回第一个字节的时间。哦，那这不正说明了网络问题嘛！同时我发现处理页面偶尔慢，某些纯后台服务或者图片也慢呀，于是又找到了运维同事，这已经大半天过去了（虽然中间处理问题断断续续）\ne、这时，运维同事按照我们的方式测试，也确实出现了偶尔慢，他们抓包分析，发现当前网络正常呀，但有一个现象，慢的请求有三次重复ACK的现象，这是什么鬼？运维同事说这是正常的，TCP包乱序会重复发起ACK嘛，我将信将疑，但问题没说通啊，为什么慢，一小时过去了。这时更多的同事加入到问题分析，运维小伙伴为证明不是网络问题，在线上服务器直接ip访问页面，发现，也会出现慢，于是，我们也选择相信了网络没问题，但问题是什么？\nf、这时我们测试过程中，又发现了某些图片资源404，某些图片资源即使存在但偶尔会慢，咦，是不是因为页面访问了资源而资源慢导致页面慢？这时其实问题的分析稍有偏差了，因为前面d的时候已经出现过类似问题，但没有包含资源的纯后台功能也慢啊！但花了近一天的分析，实在是太困惑，于是我们朝着这个方向去了。\ng、我们把页面扣了出来，并扔到了ng上，既然图片资源慢，我们改动页面，以至于后面仅仅是一个纯文本页面了，确实，访问不慢了（但前面说了，这已经偏离了，因为页面位于ng中，而不是项目中，但这也是分析的必经之地，因为这儿确实也存在问题），我们尝试加上css、js资源，慢又出现了，并且发现都是图标慢，但，这不应该呀，CDN上静态资源应该很快呀，但后面我们发现这些慢的图片并不位于CDN，而是在项目M中，同时也存在访问了CDN上不存在且并不需要依赖的资源。我们把图片映射做了一下ng映射（前面说的这是在ng上的页面），再次访问，正常了。于是结论出来了，至少，前端开发中，动静分离不合规，同时copy代码，无用的资源访问也出现了。这是今天耗时一天的分析结论。但。\nh、第二天，上班后，按照昨日的分析，前端进行了标准化的优化，上线，但问题依旧（毕竟前面图片这个问题是问题，但不是这次问题的根本问题）。这时，大家伙都很无语了，不知道为什么了！运维小伙伴又将纯文本页面扔到M项目中，启动访问，发现，也会慢呀，什么情况！同时，相同页面单独扔到tomcat中启动就正常，哎，见鬼了。似乎无下文了。\ni、这时M系统负责人突然说到，测试环境能重现慢的问题，（我似乎看到了一丝曙光），但本地启动没问题（这个。。。），，难道还是环境问题？我来到测试环境中进行测试，看着业务日志与gc日志，发现几乎每次慢的时候就会做一次gc回收，咦，内存有问题？（实际是因为测试环境内存小，512M堆大小），但我又发现线上gc正常啊，但一点蛛丝马迹都得一试，把线上1.5G堆调成了4G堆，不过，问题依旧啊，似乎还慢的更频繁的样子（还好是基于http访问有硬件负载均衡，正常业务跑不进来）。\nj、心有不甘，但想着能重现问题，应该就能定位到问题，于是我开始了代码分析之路，和其他小伙伴从两个方向并行去分析，都耗时一天半了，心想着，两个思路一起搞，兴许快点。既然测试环境能重现，好吧，我试试本地是不是真重现不了，我打开idea启动M，一顿尝试，好像真不可以呢。但我debug到了请求执行的环节，那，好吧，开启debug日志在测试环境看看，是哪个环节慢了？基于warn日志级别重启测试环境M，然后测试，发现，咦，真是的业务系统自己慢呢，已经收到请求了，在某个环节慢，而且，把页面扔到其他系统进行访问却没问题：\n```\n2019-07-05 19:05:38.955 DEBUG [http-nio-8004-exec-3] InternalNioInputBuffer:180-- Received [GET /creditCard/cardBinInfo.json HTTP/1.1\nHost: 192.168.46.3:8004\nConnection: keep-alive\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Mobile Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Encoding: gzip, deflate, sdch\nAccept-Language: zh-CN,zh;q=0.8\nCookie: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3\n\n]\n2019-07-05 19:05:38.956 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [uriBC] has value [/creditCard/cardBinInfo.json]\n2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [semicolon] has value [-1]\n2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [enc] has value [utf-8]\n2019-07-05 19:05:42.640 DEBUG [http-nio-8004-exec-3] LegacyCookieProcessor:180-- Cookies: Parsing b[]: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3\n2019-07-05 19:05:42.643 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180--  Requested cookie session id is 0714ad72-0e83-43d9-8b87-b002c34a71f3\n2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] RemoteIpValve:180-- Incoming request /creditCard/cardBinInfo.json with originalRemoteAddr '192.168.47.152', originalRemoteHost='192.168.47.152', originalSecure='false', originalScheme='http' will be seen as newRemoteAddr='192.168.47.152', newRemoteHost='192.168.47.152', newScheme='http', newSecure='false'\n2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180-- Security checking request GET /creditCard/cardBinInfo.json\n2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] RealmBase:180--   No applicable constraints defined\n2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180--  Not subject to any constraint\n2019-07-05 19:05:42.653 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:114-- Bound request context to thread: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61\n2019-07-05 19:05:42.654 DEBUG [http-nio-8004-exec-3] DispatcherServlet:863-- DispatcherServlet with name 'dispatcherServlet' processing GET request for [/creditCard/cardBinInfo.json]\n2019-07-05 19:05:42.655 DEBUG [http-nio-8004-exec-3] Parameters:180-- Set encoding to UTF-8\n2019-07-05 19:05:42.660 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json\n2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:311-- Did not find handler method for [/creditCard/cardBinInfo.json]\n2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json\n2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:308-- Returning handler method [public java.lang.Object com.yiji.mobilepay.web.controller.CreditCardWithdrawControler.cardBinInfo(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,javax.servlet.http.HttpSession)]\n2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] DefaultListableBeanFactory:251-- Returning cached instance of singleton bean 'creditCardWithdrawControler'\n2019-07-05 19:05:42.693 DEBUG [http-nio-8004-exec-3] DispatcherServlet:949-- Last-Modified value for [/creditCard/cardBinInfo.json] is: -1\n2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.831 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResources(META-INF/services/com.alibaba.fastjson.serializer.AutowiredObjectSerializer)\n2019-07-05 19:05:42.841 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.842 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.847 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoBeanInfo)\n2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Returning ClassNotFoundException\n2019-07-05 19:05:42.866 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoCustomizer)\n2019-07-05 19:05:42.867 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Returning ClassNotFoundException\n2019-07-05 19:05:42.869 DEBUG [dubbo-remoting-client-heartbeat-thread-1] HeartBeatTask:66--  [DUBBO] Send heartbeat to remote channel /192.168.46.3:20917, cause: The channel has no data-transmission exceeds a heartbeat period: 60000ms\n2019-07-05 19:05:42.870 DEBUG [New I/O client worker #1-3] HeartbeatHandler:82--  [DUBBO] Receive heartbeat response in thread New I/O client worker #1-3\n2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(Object.class)\n2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.875 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(Object.class)\n2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.877 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(String.class)\n2019-07-05 19:05:42.878 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(String.class)\n2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.880 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.881 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(StringBuilder.class)\n2019-07-05 19:05:42.882 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(StringBuilder.class)\n2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.884 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com.class)\n2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.888 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com.class)\n2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.890 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(java/lang/com.class)\n2019-07-05 19:05:42.891 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(java/lang/com.class)\n2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.893 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf.class)\n2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.895 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf.class)\n2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.897 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common.class)\n2019-07-05 19:05:42.898 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common.class)\n2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.900 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common/util.class)\n2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n2019-07-05 19:05:42.902 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common/util.class)\n2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --> Resource not found, returning null\n2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --> Resource not found, returning null\n2019-07-05 19:05:42.908 DEBUG [http-nio-8004-exec-3] ToString:550-- classloader:TomcatEmbeddedWebappClassLoader\n  context: ROOT\n  delegate: true\n----------> Parent Classloader:\norg.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8\n\n2019-07-05 19:05:42.910 DEBUG [http-nio-8004-exec-3] RequestResponseBodyMethodProcessor:225-- Written [ViewResultInfo{code=null,data=null,message=请通过网页正常步骤进行访问或者系统已超时,success=false}] as \"application/json;charset=UTF-8\" using [com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter@3220bfbc]\n2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:1036-- Null ModelAndView returned to DispatcherServlet with name 'dispatcherServlet': assuming HandlerAdapter completed request handling\n2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:997-- Successfully completed request\n2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:104-- Cleared thread-bound request context: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61\n2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection\n2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection\n```\n但是，这个环节去干什么了呢？源代码日志很少，看不出来呀！难道是分布式session问题，发现springboot分布式session我们内部是用redis实现的，后经一顿排查，发现上面日志中已经包含了redis的操作，但是是在慢的那个环节之后呀（不过提了个醒，以后redis要是抽风，这也是个风险点呢）。\nk、现在知道问题就出在org.apache.catalina.connector.CoyoteAdapter这个类日志中显示的慢的那个环节了，但他究竟干了什么？貌似只是简单的一些操作啊，代码层次很深，今天也疲惫了，就没往深处看，为什么本地测试不出现问题？带着这些疑问，今天收班了。\nl、今天本来是周六，但问题没解决，心有不甘呀，而且都能重现问题了，要是不定位到，好可惜。于是背着包来到了公司，反正今日无安排！来到公司，经过昨晚和今早放松了大脑，又准备整装待发了。本地不出问题，难道是打包环节不一样？两个私服不一致?于是我把测试环境的jar包拷了下来，java XXX -jar启动，咦，本地重现问题了！真是私服问题，包版本不一致？我又把本地项目用另一个私服打了jar包java XXX -jar启动，咦，问题也重现了，哦！原来是idea启动时候和java -jar有些区别（也许是classpath加载的区别吧），此处没深究，但很庆幸，本地重现问题，离问题定位再进一步\nm、既然本地都重现问题了，虽然不能用idea断点测试，但我改改源码加加日志吧。ok！源码日志已加好，这下日志详细了吧，java XXX -jar启动，测试，啊！原来是这慢，还以为只是简单的map呢，被类名迷惑了：\n```\n2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion start............................\n2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion end............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI start............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI end............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion start............................\n2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion end............................\n2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts start............................{}false\n2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts end............................{}localhost\n2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu start............................{}\n2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu end............................{}\n2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start1............................{}\n2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start4............................{}\n2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start5............................{}\n2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start6............................{}\n2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start7............................{}\n```\n源码\n```\n// This will map the the latest version by default\n            connector.getService().getMapper().map(serverName, decodedURI,\n                    version, request.getMappingData());\n```\n此时内心激动，问题似乎更清晰了，打开idea，断点调试，往里面跟，发现了一个gateway页面，咦，这是我们自定义的页面，全项目搜索一下，它干啥了！\n源码：\n```\n // Rule 1 -- Exact Match\n        MappedWrapper[] exactWrappers = contextVersion.exactWrappers;\n        internalMapExactWrapper(exactWrappers, path, mappingData);\n\n        // Rule 2 -- Prefix Match\n        boolean checkJspWelcomeFiles = false;\n        MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;\n        if (mappingData.wrapper == null) {\n            internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,\n                                       path, mappingData);                                    \n```\n包含gateway的代码：\n```\n@Configuration\npublic class StargateConfigration {\n\t@Bean\n\tpublic ServletRegistrationBean dispatcherRegistration(StargateDispachServlet stargateDispachServlet) {\n\t    ServletRegistrationBean registration = new ServletRegistrationBean(\n\t    \t\tstargateDispachServlet);\n\t    registration.addUrlMappings(\"/gateway\");\n\t    return registration;\n\t}\n\n```\n咦，servlet，我顿时想起以前好像我们的spring-boot专门做了对jsp的支持，于是来到我们的tomcat-staters，\n```\n\n\t@Bean(name = \"yijiEmbeddedServletContainerCustomizer\")\n\tpublic EmbeddedServletContainerCustomizer embeddedServletContainerCustomizer() {\n\t\t\n\t\treturn container -> {\n\t\t\t//1. disable jsp if possible\n\t\t\tif (!tomcatProperties.getJsp().isEnable()) {\n\t\t\t\tJspServlet jspServlet = new JspServlet();\n\t\t\t\tjspServlet.setRegistered(false);\n\t\t\t\tcontainer.setJspServlet(jspServlet);\n\t\t\t}\n```\n难道是M系统启用了yiji.tomcat.jsp.enable=true？通过线上系统变量搜索，发现，确实，M启用了，其他系统没有，恍然大悟，这就是为什么M有问题而其他系统没问题的原因吧！于是我java -Dyiji.tomcat.jsp.enable=false -jar M，测试，果然，不慢了。。。问题终于定位到，spring-boot本身不推荐jsp，但提供了支持，这说明本身支持的方式就存在性能问题！\nn、嗯，接下来，下掉jsp吧，本来这就是遗留问题，传统项目采用jsp，切换springboot后强行支持了jsp，但却有性能问题！还有安全漏洞！\n\n下面说说spring-boot如何支持jsp吧。其实就是多注册一个JspServlet!\n1、添加依赖\n```\n<dependency>\n            <groupId>org.apache.tomcat.embed</groupId>\n            <artifactId>tomcat-embed-jasper</artifactId>\n            <scope>provided</scope>\n        </dependency>\n        <dependency>\n            <groupId>javax.servlet</groupId>\n            <artifactId>jstl</artifactId>\n        </dependency>\n```\n2、配置文件中指定jsp文件存放路径\n```\n#路径,在webapp文件夹下新建文件夹WEB-INF,在往下建文件夹jsp\nspring.mvc.view.prefix=/WEB-INF/jsp/\n#文件名的后缀,例如:index.jsp,放在jsp文件夹下\nspring.mvc.view.suffix=.jsp\n```\n![upload successful](\\images\\pasted-91.png)\n3、作为框架，我们默认不支持jsp，因为有性能损耗\n```\nif (!tomcatProperties.getJsp().isEnable()) {\n\t\t\t\tJspServlet jspServlet = new JspServlet();\n\t\t\t\tjspServlet.setRegistered(false);\n\t\t\t\tcontainer.setJspServlet(jspServlet);\n\t\t\t}\n```\n4、业务系统根据自身情况决定是否启动jsp支持，启用，意味着接受性能损耗！\n\n心得：\n  本地问题分析历史2天半（中途很多时间在处理其他事情），心理感受颇多，分析线上类似问题一定要思路清晰，类似问题，先网路再应用，另外一定要有主线，如果能本地重现问题，那可是天大的好事，源码跟踪，源码添加日志可有效帮我们分析问题，总之，分析跨系统、跨部门、框架级问题时，协作、心态很重要！","slug":"spring-boot1-3-5支持jsp导致浏览器访问应用偶尔慢","published":1,"updated":"2019-09-30T07:34:10.838Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vcr006lwy669p2yfht7","content":"<p>本文将阐述在基于spring-boot1.3.5日常开发中所遇到的一个疑惑的问题，下面将按照问题处理的过程进行行文！！！</p>\n<p>一、项目简介：<br>    这儿有一个业务系统，我们称之为M，架构基于springboot1.3.5，同时提供了web能力，前后端分离。线上生产环境中，外部商户的【取现业务】会跳转到本系统的页面上进行操作，实际场景中更多的是手机端进行页面跳转，但也可以PC端网页版跳转，因为M是基于spring-mvc提供的能力（这是对项目的通用认知，但某些关键的细节点并没有包含在里面，以至于在后续问题分析中走了很多弯路，耗时2天半才定位到问题）。</p>\n<p>二、问题现象<br>    业务运行过程中，外部商户吐槽声来了，为什么跳转到你们的页面那么慢，耗时3-4s甚至更久，且频次比较高（后经运维部门同时查看，发现超过10%的请求出现慢的情况）。由于外部商户是移动端app，因此业务跳转耗时3-4s反馈到用户那儿便是点击确认操作后白板3-4s。这确实是一个糟糕的用户体验！另，据相关小伙伴反映，这是一个由来已久的问题，只是以前业务少，而且是自己的前端业务部门使用，有时忍忍就过去了。（这儿提到这一点，因为，如果能证实以前的慢和现在的慢问题一样，那么可以推导出并不是新的改动后其他操作带来的新问题，这对问题定位有指导性意义，但分析问题时总归是仓促的，这些信息极容易被丢掉）。</p>\n<p>三、业务描述<br>    为了阐述问题的分析过程，业务场景必须清晰，下面简介一下该业务场景：</p>\n<p><img src=\"\\images\\pasted-88.png\" alt=\"upload successful\"></p>\n<p>四、问题排查<br>    通过前面的描述，我们知道了业务场景、系统情况及问题现象，接下来，我们开始了问题排查的过程，这过程，是痛苦的！！！<br>a、首先，我们根据商户提供的流水号进行日志查询，发现商户请求的时间和我们底层系统M实际收到的时间确实相差了3-4s，于是，我们找到了入口系统Api，因为整个业务场景，是由Api进行的页面跳转，会不会是Api做了什么事，导致页面跳转慢了？<br>b、通过查询Api的日志，发现收到请求的时间确实和商户时间一致，我们似乎找到问题根源，即Api有问题，但当进一步排查时，发现Api和M的交互只是做了简单的302重定向，并无其他逻辑，且发现Api发起重定向的时间到M“接收”到请求便耗时了3-4s，于是，我们把矛头指向了网络问题，加之跳转过程是用的域名跳转，我们更深信这3-4s花在了网络上！<br>c、我们怀疑是否是网络问题，于是找到运维的小伙伴，一通排查，回复我们网络没问题，并给了我们ng日志<br><img src=\"\\images\\pasted-89.png\" alt=\"upload successful\"><br>d、这个回复让我们不甘心，因为我们的Api正常的发起了跳转请求，我们的M系统3-4s后才接收到请求，那这耗时一定是在网络上啊，并多次反复追问信息中心域名等相关网络问题，后来，我通过PC页面直接进行测试（因为我也是该产品的用户），当我一顿操作并点击确认按钮后，咦，很快呀，但，接下来我反复的重试、刷新、重试，果不其然偶尔出现了一笔3-4s的耗时，看来这真是偶尔出现呀（偶发问题，那这不应该是应用问题呀！），紧接着我使用谷歌浏览器看了请求情况，发现如下信息：<br><img src=\"\\images\\pasted-90.png\" alt=\"upload successful\">，咦，这耗时花在了TTFB上面呀，然后百度一查，TTFB包含了tcp握手时间及服务端返回第一个字节的时间。哦，那这不正说明了网络问题嘛！同时我发现处理页面偶尔慢，某些纯后台服务或者图片也慢呀，于是又找到了运维同事，这已经大半天过去了（虽然中间处理问题断断续续）<br>e、这时，运维同事按照我们的方式测试，也确实出现了偶尔慢，他们抓包分析，发现当前网络正常呀，但有一个现象，慢的请求有三次重复ACK的现象，这是什么鬼？运维同事说这是正常的，TCP包乱序会重复发起ACK嘛，我将信将疑，但问题没说通啊，为什么慢，一小时过去了。这时更多的同事加入到问题分析，运维小伙伴为证明不是网络问题，在线上服务器直接ip访问页面，发现，也会出现慢，于是，我们也选择相信了网络没问题，但问题是什么？<br>f、这时我们测试过程中，又发现了某些图片资源404，某些图片资源即使存在但偶尔会慢，咦，是不是因为页面访问了资源而资源慢导致页面慢？这时其实问题的分析稍有偏差了，因为前面d的时候已经出现过类似问题，但没有包含资源的纯后台功能也慢啊！但花了近一天的分析，实在是太困惑，于是我们朝着这个方向去了。<br>g、我们把页面扣了出来，并扔到了ng上，既然图片资源慢，我们改动页面，以至于后面仅仅是一个纯文本页面了，确实，访问不慢了（但前面说了，这已经偏离了，因为页面位于ng中，而不是项目中，但这也是分析的必经之地，因为这儿确实也存在问题），我们尝试加上css、js资源，慢又出现了，并且发现都是图标慢，但，这不应该呀，CDN上静态资源应该很快呀，但后面我们发现这些慢的图片并不位于CDN，而是在项目M中，同时也存在访问了CDN上不存在且并不需要依赖的资源。我们把图片映射做了一下ng映射（前面说的这是在ng上的页面），再次访问，正常了。于是结论出来了，至少，前端开发中，动静分离不合规，同时copy代码，无用的资源访问也出现了。这是今天耗时一天的分析结论。但。<br>h、第二天，上班后，按照昨日的分析，前端进行了标准化的优化，上线，但问题依旧（毕竟前面图片这个问题是问题，但不是这次问题的根本问题）。这时，大家伙都很无语了，不知道为什么了！运维小伙伴又将纯文本页面扔到M项目中，启动访问，发现，也会慢呀，什么情况！同时，相同页面单独扔到tomcat中启动就正常，哎，见鬼了。似乎无下文了。<br>i、这时M系统负责人突然说到，测试环境能重现慢的问题，（我似乎看到了一丝曙光），但本地启动没问题（这个。。。），，难道还是环境问题？我来到测试环境中进行测试，看着业务日志与gc日志，发现几乎每次慢的时候就会做一次gc回收，咦，内存有问题？（实际是因为测试环境内存小，512M堆大小），但我又发现线上gc正常啊，但一点蛛丝马迹都得一试，把线上1.5G堆调成了4G堆，不过，问题依旧啊，似乎还慢的更频繁的样子（还好是基于http访问有硬件负载均衡，正常业务跑不进来）。<br>j、心有不甘，但想着能重现问题，应该就能定位到问题，于是我开始了代码分析之路，和其他小伙伴从两个方向并行去分析，都耗时一天半了，心想着，两个思路一起搞，兴许快点。既然测试环境能重现，好吧，我试试本地是不是真重现不了，我打开idea启动M，一顿尝试，好像真不可以呢。但我debug到了请求执行的环节，那，好吧，开启debug日志在测试环境看看，是哪个环节慢了？基于warn日志级别重启测试环境M，然后测试，发现，咦，真是的业务系统自己慢呢，已经收到请求了，在某个环节慢，而且，把页面扔到其他系统进行访问却没问题：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-07-05 19:05:38.955 DEBUG [http-nio-8004-exec-3] InternalNioInputBuffer:180-- Received [GET /creditCard/cardBinInfo.json HTTP/1.1</span><br><span class=\"line\">Host: 192.168.46.3:8004</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Mobile Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Encoding: gzip, deflate, sdch</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8</span><br><span class=\"line\">Cookie: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class=\"line\"></span><br><span class=\"line\">]</span><br><span class=\"line\">2019-07-05 19:05:38.956 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [uriBC] has value [/creditCard/cardBinInfo.json]</span><br><span class=\"line\">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [semicolon] has value [-1]</span><br><span class=\"line\">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [enc] has value [utf-8]</span><br><span class=\"line\">2019-07-05 19:05:42.640 DEBUG [http-nio-8004-exec-3] LegacyCookieProcessor:180-- Cookies: Parsing b[]: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class=\"line\">2019-07-05 19:05:42.643 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180--  Requested cookie session id is 0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class=\"line\">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] RemoteIpValve:180-- Incoming request /creditCard/cardBinInfo.json with originalRemoteAddr &#x27;192.168.47.152&#x27;, originalRemoteHost=&#x27;192.168.47.152&#x27;, originalSecure=&#x27;false&#x27;, originalScheme=&#x27;http&#x27; will be seen as newRemoteAddr=&#x27;192.168.47.152&#x27;, newRemoteHost=&#x27;192.168.47.152&#x27;, newScheme=&#x27;http&#x27;, newSecure=&#x27;false&#x27;</span><br><span class=\"line\">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180-- Security checking request GET /creditCard/cardBinInfo.json</span><br><span class=\"line\">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] RealmBase:180--   No applicable constraints defined</span><br><span class=\"line\">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180--  Not subject to any constraint</span><br><span class=\"line\">2019-07-05 19:05:42.653 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:114-- Bound request context to thread: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class=\"line\">2019-07-05 19:05:42.654 DEBUG [http-nio-8004-exec-3] DispatcherServlet:863-- DispatcherServlet with name &#x27;dispatcherServlet&#x27; processing GET request for [/creditCard/cardBinInfo.json]</span><br><span class=\"line\">2019-07-05 19:05:42.655 DEBUG [http-nio-8004-exec-3] Parameters:180-- Set encoding to UTF-8</span><br><span class=\"line\">2019-07-05 19:05:42.660 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class=\"line\">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:311-- Did not find handler method for [/creditCard/cardBinInfo.json]</span><br><span class=\"line\">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class=\"line\">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:308-- Returning handler method [public java.lang.Object com.yiji.mobilepay.web.controller.CreditCardWithdrawControler.cardBinInfo(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,javax.servlet.http.HttpSession)]</span><br><span class=\"line\">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] DefaultListableBeanFactory:251-- Returning cached instance of singleton bean &#x27;creditCardWithdrawControler&#x27;</span><br><span class=\"line\">2019-07-05 19:05:42.693 DEBUG [http-nio-8004-exec-3] DispatcherServlet:949-- Last-Modified value for [/creditCard/cardBinInfo.json] is: -1</span><br><span class=\"line\">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.831 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResources(META-INF/services/com.alibaba.fastjson.serializer.AutowiredObjectSerializer)</span><br><span class=\"line\">2019-07-05 19:05:42.841 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.842 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.847 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoBeanInfo)</span><br><span class=\"line\">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class=\"line\">2019-07-05 19:05:42.866 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoCustomizer)</span><br><span class=\"line\">2019-07-05 19:05:42.867 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class=\"line\">2019-07-05 19:05:42.869 DEBUG [dubbo-remoting-client-heartbeat-thread-1] HeartBeatTask:66--  [DUBBO] Send heartbeat to remote channel /192.168.46.3:20917, cause: The channel has no data-transmission exceeds a heartbeat period: 60000ms</span><br><span class=\"line\">2019-07-05 19:05:42.870 DEBUG [New I/O client worker #1-3] HeartbeatHandler:82--  [DUBBO] Receive heartbeat response in thread New I/O client worker #1-3</span><br><span class=\"line\">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(Object.class)</span><br><span class=\"line\">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.875 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(Object.class)</span><br><span class=\"line\">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.877 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(String.class)</span><br><span class=\"line\">2019-07-05 19:05:42.878 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(String.class)</span><br><span class=\"line\">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.880 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.881 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(StringBuilder.class)</span><br><span class=\"line\">2019-07-05 19:05:42.882 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(StringBuilder.class)</span><br><span class=\"line\">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.884 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.888 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.890 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(java/lang/com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.891 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(java/lang/com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.893 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf.class)</span><br><span class=\"line\">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.895 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf.class)</span><br><span class=\"line\">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.897 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common.class)</span><br><span class=\"line\">2019-07-05 19:05:42.898 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common.class)</span><br><span class=\"line\">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.900 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common/util.class)</span><br><span class=\"line\">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.902 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common/util.class)</span><br><span class=\"line\">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.908 DEBUG [http-nio-8004-exec-3] ToString:550-- classloader:TomcatEmbeddedWebappClassLoader</span><br><span class=\"line\">  context: ROOT</span><br><span class=\"line\">  delegate: true</span><br><span class=\"line\">----------&gt; Parent Classloader:</span><br><span class=\"line\">org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\"></span><br><span class=\"line\">2019-07-05 19:05:42.910 DEBUG [http-nio-8004-exec-3] RequestResponseBodyMethodProcessor:225-- Written [ViewResultInfo&#123;code=null,data=null,message=请通过网页正常步骤进行访问或者系统已超时,success=false&#125;] as &quot;application/json;charset=UTF-8&quot; using [com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter@3220bfbc]</span><br><span class=\"line\">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:1036-- Null ModelAndView returned to DispatcherServlet with name &#x27;dispatcherServlet&#x27;: assuming HandlerAdapter completed request handling</span><br><span class=\"line\">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:997-- Successfully completed request</span><br><span class=\"line\">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:104-- Cleared thread-bound request context: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class=\"line\">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br></pre></td></tr></table></figure><br>但是，这个环节去干什么了呢？源代码日志很少，看不出来呀！难道是分布式session问题，发现springboot分布式session我们内部是用redis实现的，后经一顿排查，发现上面日志中已经包含了redis的操作，但是是在慢的那个环节之后呀（不过提了个醒，以后redis要是抽风，这也是个风险点呢）。<br>k、现在知道问题就出在org.apache.catalina.connector.CoyoteAdapter这个类日志中显示的慢的那个环节了，但他究竟干了什么？貌似只是简单的一些操作啊，代码层次很深，今天也疲惫了，就没往深处看，为什么本地测试不出现问题？带着这些疑问，今天收班了。<br>l、今天本来是周六，但问题没解决，心有不甘呀，而且都能重现问题了，要是不定位到，好可惜。于是背着包来到了公司，反正今日无安排！来到公司，经过昨晚和今早放松了大脑，又准备整装待发了。本地不出问题，难道是打包环节不一样？两个私服不一致?于是我把测试环境的jar包拷了下来，java XXX -jar启动，咦，本地重现问题了！真是私服问题，包版本不一致？我又把本地项目用另一个私服打了jar包java XXX -jar启动，咦，问题也重现了，哦！原来是idea启动时候和java -jar有些区别（也许是classpath加载的区别吧），此处没深究，但很庆幸，本地重现问题，离问题定位再进一步<br>m、既然本地都重现问题了，虽然不能用idea断点测试，但我改改源码加加日志吧。ok！源码日志已加好，这下日志详细了吧，java XXX -jar启动，测试，啊！原来是这慢，还以为只是简单的map呢，被类名迷惑了：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion start............................</span><br><span class=\"line\">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion end............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI start............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI end............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion start............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion end............................</span><br><span class=\"line\">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts start............................&#123;&#125;false</span><br><span class=\"line\">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts end............................&#123;&#125;localhost</span><br><span class=\"line\">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu start............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu end............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start1............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start4............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start5............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start6............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start7............................&#123;&#125;</span><br></pre></td></tr></table></figure><br>源码<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// This will map the the latest version by default</span><br><span class=\"line\">            connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class=\"line\">                    version, request.getMappingData());</span><br></pre></td></tr></table></figure><br>此时内心激动，问题似乎更清晰了，打开idea，断点调试，往里面跟，发现了一个gateway页面，咦，这是我们自定义的页面，全项目搜索一下，它干啥了！<br>源码：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Rule 1 -- Exact Match</span><br><span class=\"line\">       MappedWrapper[] exactWrappers = contextVersion.exactWrappers;</span><br><span class=\"line\">       internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class=\"line\"></span><br><span class=\"line\">       // Rule 2 -- Prefix Match</span><br><span class=\"line\">       boolean checkJspWelcomeFiles = false;</span><br><span class=\"line\">       MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;</span><br><span class=\"line\">       if (mappingData.wrapper == null) &#123;</span><br><span class=\"line\">           internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,</span><br><span class=\"line\">                                      path, mappingData);                                    </span><br></pre></td></tr></table></figure><br>包含gateway的代码：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">public class StargateConfigration &#123;</span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic ServletRegistrationBean dispatcherRegistration(StargateDispachServlet stargateDispachServlet) &#123;</span><br><span class=\"line\">\t    ServletRegistrationBean registration = new ServletRegistrationBean(</span><br><span class=\"line\">\t    \t\tstargateDispachServlet);</span><br><span class=\"line\">\t    registration.addUrlMappings(&quot;/gateway&quot;);</span><br><span class=\"line\">\t    return registration;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure><br>咦，servlet，我顿时想起以前好像我们的spring-boot专门做了对jsp的支持，于是来到我们的tomcat-staters，<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">@Bean(name = &quot;yijiEmbeddedServletContainerCustomizer&quot;)</span><br><span class=\"line\">public EmbeddedServletContainerCustomizer embeddedServletContainerCustomizer() &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn container -&gt; &#123;</span><br><span class=\"line\">\t\t//1. disable jsp if possible</span><br><span class=\"line\">\t\tif (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class=\"line\">\t\t\tJspServlet jspServlet = new JspServlet();</span><br><span class=\"line\">\t\t\tjspServlet.setRegistered(false);</span><br><span class=\"line\">\t\t\tcontainer.setJspServlet(jspServlet);</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure><br>难道是M系统启用了yiji.tomcat.jsp.enable=true？通过线上系统变量搜索，发现，确实，M启用了，其他系统没有，恍然大悟，这就是为什么M有问题而其他系统没问题的原因吧！于是我java -Dyiji.tomcat.jsp.enable=false -jar M，测试，果然，不慢了。。。问题终于定位到，spring-boot本身不推荐jsp，但提供了支持，这说明本身支持的方式就存在性能问题！<br>n、嗯，接下来，下掉jsp吧，本来这就是遗留问题，传统项目采用jsp，切换springboot后强行支持了jsp，但却有性能问题！还有安全漏洞！</p>\n<p>下面说说spring-boot如何支持jsp吧。其实就是多注册一个JspServlet!<br>1、添加依赖<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br>2、配置文件中指定jsp文件存放路径<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#路径,在webapp文件夹下新建文件夹WEB-INF,在往下建文件夹jsp</span><br><span class=\"line\">spring.mvc.view.prefix=/WEB-INF/jsp/</span><br><span class=\"line\">#文件名的后缀,例如:index.jsp,放在jsp文件夹下</span><br><span class=\"line\">spring.mvc.view.suffix=.jsp</span><br></pre></td></tr></table></figure><br><img src=\"\\images\\pasted-91.png\" alt=\"upload successful\"><br>3、作为框架，我们默认不支持jsp，因为有性能损耗<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class=\"line\">\t\t\t\tJspServlet jspServlet = new JspServlet();</span><br><span class=\"line\">\t\t\t\tjspServlet.setRegistered(false);</span><br><span class=\"line\">\t\t\t\tcontainer.setJspServlet(jspServlet);</span><br><span class=\"line\">\t\t\t&#125;</span><br></pre></td></tr></table></figure><br>4、业务系统根据自身情况决定是否启动jsp支持，启用，意味着接受性能损耗！</p>\n<p>心得：<br>  本地问题分析历史2天半（中途很多时间在处理其他事情），心理感受颇多，分析线上类似问题一定要思路清晰，类似问题，先网路再应用，另外一定要有主线，如果能本地重现问题，那可是天大的好事，源码跟踪，源码添加日志可有效帮我们分析问题，总之，分析跨系统、跨部门、框架级问题时，协作、心态很重要！</p>\n","site":{"data":{}},"length":20334,"excerpt":"","more":"<p>本文将阐述在基于spring-boot1.3.5日常开发中所遇到的一个疑惑的问题，下面将按照问题处理的过程进行行文！！！</p>\n<p>一、项目简介：<br>    这儿有一个业务系统，我们称之为M，架构基于springboot1.3.5，同时提供了web能力，前后端分离。线上生产环境中，外部商户的【取现业务】会跳转到本系统的页面上进行操作，实际场景中更多的是手机端进行页面跳转，但也可以PC端网页版跳转，因为M是基于spring-mvc提供的能力（这是对项目的通用认知，但某些关键的细节点并没有包含在里面，以至于在后续问题分析中走了很多弯路，耗时2天半才定位到问题）。</p>\n<p>二、问题现象<br>    业务运行过程中，外部商户吐槽声来了，为什么跳转到你们的页面那么慢，耗时3-4s甚至更久，且频次比较高（后经运维部门同时查看，发现超过10%的请求出现慢的情况）。由于外部商户是移动端app，因此业务跳转耗时3-4s反馈到用户那儿便是点击确认操作后白板3-4s。这确实是一个糟糕的用户体验！另，据相关小伙伴反映，这是一个由来已久的问题，只是以前业务少，而且是自己的前端业务部门使用，有时忍忍就过去了。（这儿提到这一点，因为，如果能证实以前的慢和现在的慢问题一样，那么可以推导出并不是新的改动后其他操作带来的新问题，这对问题定位有指导性意义，但分析问题时总归是仓促的，这些信息极容易被丢掉）。</p>\n<p>三、业务描述<br>    为了阐述问题的分析过程，业务场景必须清晰，下面简介一下该业务场景：</p>\n<p><img src=\"\\images\\pasted-88.png\" alt=\"upload successful\"></p>\n<p>四、问题排查<br>    通过前面的描述，我们知道了业务场景、系统情况及问题现象，接下来，我们开始了问题排查的过程，这过程，是痛苦的！！！<br>a、首先，我们根据商户提供的流水号进行日志查询，发现商户请求的时间和我们底层系统M实际收到的时间确实相差了3-4s，于是，我们找到了入口系统Api，因为整个业务场景，是由Api进行的页面跳转，会不会是Api做了什么事，导致页面跳转慢了？<br>b、通过查询Api的日志，发现收到请求的时间确实和商户时间一致，我们似乎找到问题根源，即Api有问题，但当进一步排查时，发现Api和M的交互只是做了简单的302重定向，并无其他逻辑，且发现Api发起重定向的时间到M“接收”到请求便耗时了3-4s，于是，我们把矛头指向了网络问题，加之跳转过程是用的域名跳转，我们更深信这3-4s花在了网络上！<br>c、我们怀疑是否是网络问题，于是找到运维的小伙伴，一通排查，回复我们网络没问题，并给了我们ng日志<br><img src=\"\\images\\pasted-89.png\" alt=\"upload successful\"><br>d、这个回复让我们不甘心，因为我们的Api正常的发起了跳转请求，我们的M系统3-4s后才接收到请求，那这耗时一定是在网络上啊，并多次反复追问信息中心域名等相关网络问题，后来，我通过PC页面直接进行测试（因为我也是该产品的用户），当我一顿操作并点击确认按钮后，咦，很快呀，但，接下来我反复的重试、刷新、重试，果不其然偶尔出现了一笔3-4s的耗时，看来这真是偶尔出现呀（偶发问题，那这不应该是应用问题呀！），紧接着我使用谷歌浏览器看了请求情况，发现如下信息：<br><img src=\"\\images\\pasted-90.png\" alt=\"upload successful\">，咦，这耗时花在了TTFB上面呀，然后百度一查，TTFB包含了tcp握手时间及服务端返回第一个字节的时间。哦，那这不正说明了网络问题嘛！同时我发现处理页面偶尔慢，某些纯后台服务或者图片也慢呀，于是又找到了运维同事，这已经大半天过去了（虽然中间处理问题断断续续）<br>e、这时，运维同事按照我们的方式测试，也确实出现了偶尔慢，他们抓包分析，发现当前网络正常呀，但有一个现象，慢的请求有三次重复ACK的现象，这是什么鬼？运维同事说这是正常的，TCP包乱序会重复发起ACK嘛，我将信将疑，但问题没说通啊，为什么慢，一小时过去了。这时更多的同事加入到问题分析，运维小伙伴为证明不是网络问题，在线上服务器直接ip访问页面，发现，也会出现慢，于是，我们也选择相信了网络没问题，但问题是什么？<br>f、这时我们测试过程中，又发现了某些图片资源404，某些图片资源即使存在但偶尔会慢，咦，是不是因为页面访问了资源而资源慢导致页面慢？这时其实问题的分析稍有偏差了，因为前面d的时候已经出现过类似问题，但没有包含资源的纯后台功能也慢啊！但花了近一天的分析，实在是太困惑，于是我们朝着这个方向去了。<br>g、我们把页面扣了出来，并扔到了ng上，既然图片资源慢，我们改动页面，以至于后面仅仅是一个纯文本页面了，确实，访问不慢了（但前面说了，这已经偏离了，因为页面位于ng中，而不是项目中，但这也是分析的必经之地，因为这儿确实也存在问题），我们尝试加上css、js资源，慢又出现了，并且发现都是图标慢，但，这不应该呀，CDN上静态资源应该很快呀，但后面我们发现这些慢的图片并不位于CDN，而是在项目M中，同时也存在访问了CDN上不存在且并不需要依赖的资源。我们把图片映射做了一下ng映射（前面说的这是在ng上的页面），再次访问，正常了。于是结论出来了，至少，前端开发中，动静分离不合规，同时copy代码，无用的资源访问也出现了。这是今天耗时一天的分析结论。但。<br>h、第二天，上班后，按照昨日的分析，前端进行了标准化的优化，上线，但问题依旧（毕竟前面图片这个问题是问题，但不是这次问题的根本问题）。这时，大家伙都很无语了，不知道为什么了！运维小伙伴又将纯文本页面扔到M项目中，启动访问，发现，也会慢呀，什么情况！同时，相同页面单独扔到tomcat中启动就正常，哎，见鬼了。似乎无下文了。<br>i、这时M系统负责人突然说到，测试环境能重现慢的问题，（我似乎看到了一丝曙光），但本地启动没问题（这个。。。），，难道还是环境问题？我来到测试环境中进行测试，看着业务日志与gc日志，发现几乎每次慢的时候就会做一次gc回收，咦，内存有问题？（实际是因为测试环境内存小，512M堆大小），但我又发现线上gc正常啊，但一点蛛丝马迹都得一试，把线上1.5G堆调成了4G堆，不过，问题依旧啊，似乎还慢的更频繁的样子（还好是基于http访问有硬件负载均衡，正常业务跑不进来）。<br>j、心有不甘，但想着能重现问题，应该就能定位到问题，于是我开始了代码分析之路，和其他小伙伴从两个方向并行去分析，都耗时一天半了，心想着，两个思路一起搞，兴许快点。既然测试环境能重现，好吧，我试试本地是不是真重现不了，我打开idea启动M，一顿尝试，好像真不可以呢。但我debug到了请求执行的环节，那，好吧，开启debug日志在测试环境看看，是哪个环节慢了？基于warn日志级别重启测试环境M，然后测试，发现，咦，真是的业务系统自己慢呢，已经收到请求了，在某个环节慢，而且，把页面扔到其他系统进行访问却没问题：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-07-05 19:05:38.955 DEBUG [http-nio-8004-exec-3] InternalNioInputBuffer:180-- Received [GET /creditCard/cardBinInfo.json HTTP/1.1</span><br><span class=\"line\">Host: 192.168.46.3:8004</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Mobile Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Encoding: gzip, deflate, sdch</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8</span><br><span class=\"line\">Cookie: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class=\"line\"></span><br><span class=\"line\">]</span><br><span class=\"line\">2019-07-05 19:05:38.956 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [uriBC] has value [/creditCard/cardBinInfo.json]</span><br><span class=\"line\">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [semicolon] has value [-1]</span><br><span class=\"line\">2019-07-05 19:05:38.957 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180-- The variable [enc] has value [utf-8]</span><br><span class=\"line\">2019-07-05 19:05:42.640 DEBUG [http-nio-8004-exec-3] LegacyCookieProcessor:180-- Cookies: Parsing b[]: _csrf=c25ca56a-799f-4e23-b179-b09abaf7fa0e; cavyboss-session=40c8e4d0-0d09-4952-8812-93a1f44b0068; mpay-session=0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class=\"line\">2019-07-05 19:05:42.643 DEBUG [http-nio-8004-exec-3] CoyoteAdapter:180--  Requested cookie session id is 0714ad72-0e83-43d9-8b87-b002c34a71f3</span><br><span class=\"line\">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] RemoteIpValve:180-- Incoming request /creditCard/cardBinInfo.json with originalRemoteAddr &#x27;192.168.47.152&#x27;, originalRemoteHost=&#x27;192.168.47.152&#x27;, originalSecure=&#x27;false&#x27;, originalScheme=&#x27;http&#x27; will be seen as newRemoteAddr=&#x27;192.168.47.152&#x27;, newRemoteHost=&#x27;192.168.47.152&#x27;, newScheme=&#x27;http&#x27;, newSecure=&#x27;false&#x27;</span><br><span class=\"line\">2019-07-05 19:05:42.645 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180-- Security checking request GET /creditCard/cardBinInfo.json</span><br><span class=\"line\">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] RealmBase:180--   No applicable constraints defined</span><br><span class=\"line\">2019-07-05 19:05:42.646 DEBUG [http-nio-8004-exec-3] AuthenticatorBase:180--  Not subject to any constraint</span><br><span class=\"line\">2019-07-05 19:05:42.653 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:114-- Bound request context to thread: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class=\"line\">2019-07-05 19:05:42.654 DEBUG [http-nio-8004-exec-3] DispatcherServlet:863-- DispatcherServlet with name &#x27;dispatcherServlet&#x27; processing GET request for [/creditCard/cardBinInfo.json]</span><br><span class=\"line\">2019-07-05 19:05:42.655 DEBUG [http-nio-8004-exec-3] Parameters:180-- Set encoding to UTF-8</span><br><span class=\"line\">2019-07-05 19:05:42.660 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.663 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class=\"line\">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] EndpointHandlerMapping:311-- Did not find handler method for [/creditCard/cardBinInfo.json]</span><br><span class=\"line\">2019-07-05 19:05:42.671 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:301-- Looking up handler method for path /creditCard/cardBinInfo.json</span><br><span class=\"line\">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] RequestMappingHandlerMapping:308-- Returning handler method [public java.lang.Object com.yiji.mobilepay.web.controller.CreditCardWithdrawControler.cardBinInfo(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,javax.servlet.http.HttpSession)]</span><br><span class=\"line\">2019-07-05 19:05:42.692 DEBUG [http-nio-8004-exec-3] DefaultListableBeanFactory:251-- Returning cached instance of singleton bean &#x27;creditCardWithdrawControler&#x27;</span><br><span class=\"line\">2019-07-05 19:05:42.693 DEBUG [http-nio-8004-exec-3] DispatcherServlet:949-- Last-Modified value for [/creditCard/cardBinInfo.json] is: -1</span><br><span class=\"line\">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.704 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.831 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResources(META-INF/services/com.alibaba.fastjson.serializer.AutowiredObjectSerializer)</span><br><span class=\"line\">2019-07-05 19:05:42.841 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.842 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.844 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.847 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.848 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.849 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoBeanInfo)</span><br><span class=\"line\">2019-07-05 19:05:42.862 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class=\"line\">2019-07-05 19:05:42.866 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findClass(com.yjf.common.lang.result.ViewResultInfoCustomizer)</span><br><span class=\"line\">2019-07-05 19:05:42.867 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Returning ClassNotFoundException</span><br><span class=\"line\">2019-07-05 19:05:42.869 DEBUG [dubbo-remoting-client-heartbeat-thread-1] HeartBeatTask:66--  [DUBBO] Send heartbeat to remote channel /192.168.46.3:20917, cause: The channel has no data-transmission exceeds a heartbeat period: 60000ms</span><br><span class=\"line\">2019-07-05 19:05:42.870 DEBUG [New I/O client worker #1-3] HeartbeatHandler:82--  [DUBBO] Receive heartbeat response in thread New I/O client worker #1-3</span><br><span class=\"line\">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(Object.class)</span><br><span class=\"line\">2019-07-05 19:05:42.874 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.875 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(Object.class)</span><br><span class=\"line\">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.876 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.877 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(String.class)</span><br><span class=\"line\">2019-07-05 19:05:42.878 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(String.class)</span><br><span class=\"line\">2019-07-05 19:05:42.879 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.880 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.881 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(StringBuilder.class)</span><br><span class=\"line\">2019-07-05 19:05:42.882 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(StringBuilder.class)</span><br><span class=\"line\">2019-07-05 19:05:42.883 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.884 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.887 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.888 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.889 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.890 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(java/lang/com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.891 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(java/lang/com.class)</span><br><span class=\"line\">2019-07-05 19:05:42.892 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.893 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf.class)</span><br><span class=\"line\">2019-07-05 19:05:42.894 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.895 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf.class)</span><br><span class=\"line\">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.896 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.897 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common.class)</span><br><span class=\"line\">2019-07-05 19:05:42.898 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common.class)</span><br><span class=\"line\">2019-07-05 19:05:42.899 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.900 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180-- getResource(com/yjf/common/util.class)</span><br><span class=\"line\">2019-07-05 19:05:42.901 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   Delegating to parent classloader org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\">2019-07-05 19:05:42.902 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     findResource(com/yjf/common/util.class)</span><br><span class=\"line\">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--     --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.903 DEBUG [http-nio-8004-exec-3] WebappClassLoaderBase:180--   --&gt; Resource not found, returning null</span><br><span class=\"line\">2019-07-05 19:05:42.908 DEBUG [http-nio-8004-exec-3] ToString:550-- classloader:TomcatEmbeddedWebappClassLoader</span><br><span class=\"line\">  context: ROOT</span><br><span class=\"line\">  delegate: true</span><br><span class=\"line\">----------&gt; Parent Classloader:</span><br><span class=\"line\">org.springframework.boot.loader.LaunchedURLClassLoader@11a9e7c8</span><br><span class=\"line\"></span><br><span class=\"line\">2019-07-05 19:05:42.910 DEBUG [http-nio-8004-exec-3] RequestResponseBodyMethodProcessor:225-- Written [ViewResultInfo&#123;code=null,data=null,message=请通过网页正常步骤进行访问或者系统已超时,success=false&#125;] as &quot;application/json;charset=UTF-8&quot; using [com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter@3220bfbc]</span><br><span class=\"line\">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:1036-- Null ModelAndView returned to DispatcherServlet with name &#x27;dispatcherServlet&#x27;: assuming HandlerAdapter completed request handling</span><br><span class=\"line\">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] DispatcherServlet:997-- Successfully completed request</span><br><span class=\"line\">2019-07-05 19:05:42.911 DEBUG [http-nio-8004-exec-3] OrderedRequestContextFilter:104-- Cleared thread-bound request context: org.springframework.session.web.http.SessionRepositoryFilter$SessionRepositoryRequestWrapper@5edc7f61</span><br><span class=\"line\">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.912 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br><span class=\"line\">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:125-- Opening RedisConnection</span><br><span class=\"line\">2019-07-05 19:05:42.913 DEBUG [http-nio-8004-exec-3] RedisConnectionUtils:205-- Closing Redis Connection</span><br></pre></td></tr></table></figure><br>但是，这个环节去干什么了呢？源代码日志很少，看不出来呀！难道是分布式session问题，发现springboot分布式session我们内部是用redis实现的，后经一顿排查，发现上面日志中已经包含了redis的操作，但是是在慢的那个环节之后呀（不过提了个醒，以后redis要是抽风，这也是个风险点呢）。<br>k、现在知道问题就出在org.apache.catalina.connector.CoyoteAdapter这个类日志中显示的慢的那个环节了，但他究竟干了什么？貌似只是简单的一些操作啊，代码层次很深，今天也疲惫了，就没往深处看，为什么本地测试不出现问题？带着这些疑问，今天收班了。<br>l、今天本来是周六，但问题没解决，心有不甘呀，而且都能重现问题了，要是不定位到，好可惜。于是背着包来到了公司，反正今日无安排！来到公司，经过昨晚和今早放松了大脑，又准备整装待发了。本地不出问题，难道是打包环节不一样？两个私服不一致?于是我把测试环境的jar包拷了下来，java XXX -jar启动，咦，本地重现问题了！真是私服问题，包版本不一致？我又把本地项目用另一个私服打了jar包java XXX -jar启动，咦，问题也重现了，哦！原来是idea启动时候和java -jar有些区别（也许是classpath加载的区别吧），此处没深究，但很庆幸，本地重现问题，离问题定位再进一步<br>m、既然本地都重现问题了，虽然不能用idea断点测试，但我改改源码加加日志吧。ok！源码日志已加好，这下日志详细了吧，java XXX -jar启动，测试，啊！原来是这慢，还以为只是简单的map呢，被类名迷惑了：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion start............................</span><br><span class=\"line\">2019-07-06 11:44:55.430 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- normaliztion end............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI start............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- decodedURI end............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion start............................</span><br><span class=\"line\">2019-07-06 11:44:55.432 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check normaliztion end............................</span><br><span class=\"line\">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts start............................&#123;&#125;false</span><br><span class=\"line\">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check getUseIPVHosts end............................&#123;&#125;localhost</span><br><span class=\"line\">2019-07-06 11:44:55.433 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu start............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check mapreu end............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start1............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.570 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start4............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start5............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start6............................&#123;&#125;</span><br><span class=\"line\">2019-07-06 11:45:00.571 INFO  [http-nio-8004-exec-13] CoyoteAdapter:180-- check session start7............................&#123;&#125;</span><br></pre></td></tr></table></figure><br>源码<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// This will map the the latest version by default</span><br><span class=\"line\">            connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class=\"line\">                    version, request.getMappingData());</span><br></pre></td></tr></table></figure><br>此时内心激动，问题似乎更清晰了，打开idea，断点调试，往里面跟，发现了一个gateway页面，咦，这是我们自定义的页面，全项目搜索一下，它干啥了！<br>源码：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Rule 1 -- Exact Match</span><br><span class=\"line\">       MappedWrapper[] exactWrappers = contextVersion.exactWrappers;</span><br><span class=\"line\">       internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class=\"line\"></span><br><span class=\"line\">       // Rule 2 -- Prefix Match</span><br><span class=\"line\">       boolean checkJspWelcomeFiles = false;</span><br><span class=\"line\">       MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;</span><br><span class=\"line\">       if (mappingData.wrapper == null) &#123;</span><br><span class=\"line\">           internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,</span><br><span class=\"line\">                                      path, mappingData);                                    </span><br></pre></td></tr></table></figure><br>包含gateway的代码：<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">public class StargateConfigration &#123;</span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic ServletRegistrationBean dispatcherRegistration(StargateDispachServlet stargateDispachServlet) &#123;</span><br><span class=\"line\">\t    ServletRegistrationBean registration = new ServletRegistrationBean(</span><br><span class=\"line\">\t    \t\tstargateDispachServlet);</span><br><span class=\"line\">\t    registration.addUrlMappings(&quot;/gateway&quot;);</span><br><span class=\"line\">\t    return registration;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure><br>咦，servlet，我顿时想起以前好像我们的spring-boot专门做了对jsp的支持，于是来到我们的tomcat-staters，<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">@Bean(name = &quot;yijiEmbeddedServletContainerCustomizer&quot;)</span><br><span class=\"line\">public EmbeddedServletContainerCustomizer embeddedServletContainerCustomizer() &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn container -&gt; &#123;</span><br><span class=\"line\">\t\t//1. disable jsp if possible</span><br><span class=\"line\">\t\tif (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class=\"line\">\t\t\tJspServlet jspServlet = new JspServlet();</span><br><span class=\"line\">\t\t\tjspServlet.setRegistered(false);</span><br><span class=\"line\">\t\t\tcontainer.setJspServlet(jspServlet);</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure><br>难道是M系统启用了yiji.tomcat.jsp.enable=true？通过线上系统变量搜索，发现，确实，M启用了，其他系统没有，恍然大悟，这就是为什么M有问题而其他系统没问题的原因吧！于是我java -Dyiji.tomcat.jsp.enable=false -jar M，测试，果然，不慢了。。。问题终于定位到，spring-boot本身不推荐jsp，但提供了支持，这说明本身支持的方式就存在性能问题！<br>n、嗯，接下来，下掉jsp吧，本来这就是遗留问题，传统项目采用jsp，切换springboot后强行支持了jsp，但却有性能问题！还有安全漏洞！</p>\n<p>下面说说spring-boot如何支持jsp吧。其实就是多注册一个JspServlet!<br>1、添加依赖<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><br>2、配置文件中指定jsp文件存放路径<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#路径,在webapp文件夹下新建文件夹WEB-INF,在往下建文件夹jsp</span><br><span class=\"line\">spring.mvc.view.prefix=/WEB-INF/jsp/</span><br><span class=\"line\">#文件名的后缀,例如:index.jsp,放在jsp文件夹下</span><br><span class=\"line\">spring.mvc.view.suffix=.jsp</span><br></pre></td></tr></table></figure><br><img src=\"\\images\\pasted-91.png\" alt=\"upload successful\"><br>3、作为框架，我们默认不支持jsp，因为有性能损耗<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (!tomcatProperties.getJsp().isEnable()) &#123;</span><br><span class=\"line\">\t\t\t\tJspServlet jspServlet = new JspServlet();</span><br><span class=\"line\">\t\t\t\tjspServlet.setRegistered(false);</span><br><span class=\"line\">\t\t\t\tcontainer.setJspServlet(jspServlet);</span><br><span class=\"line\">\t\t\t&#125;</span><br></pre></td></tr></table></figure><br>4、业务系统根据自身情况决定是否启动jsp支持，启用，意味着接受性能损耗！</p>\n<p>心得：<br>  本地问题分析历史2天半（中途很多时间在处理其他事情），心理感受颇多，分析线上类似问题一定要思路清晰，类似问题，先网路再应用，另外一定要有主线，如果能本地重现问题，那可是天大的好事，源码跟踪，源码添加日志可有效帮我们分析问题，总之，分析跨系统、跨部门、框架级问题时，协作、心态很重要！</p>\n"},{"title":"剥开源码看java-线程池ThreadPoolExecutor","author":"Xiang Chuang","date":"2020-01-10T02:30:00.000Z","_content":"本文从spring对于线程池的实现ThreadPoolTaskExecutor入手阐述，由于该实现是对java的ThreadPoolExecutor进行了一次包装（扩展线程池能力），因此文中更多涉及到的是ThreadPoolExecutor关键实现逻辑的原理分析\n![upload successful](/images/pasted-99.png)\n\n![upload successful](/images/pasted-103.png)\n1、executor = new ThreadPoolTaskExecutor();主要操作：父类CustomizableThreadCreator构造函数初始化，默认threadNamePrefix为实现类名简称-\n2、excutor参数设置并excutor.initialize();（该方法属于ExecutorConfigurationSupport），其中会调用抽象方法initializeExecutor，由ThreadPoolTaskExecutor实现。\n该处除了下面要讨论的corePoolSize，maxPollSize，queueCapacity外，想先说一下keepAliveSeconds这个值，代表允许操作核心线程数部分的线程空闲多长时间（s）后shut down，如果初始化时设置了allowCoreThreadTimeOut（true），那么对核心线程数以内的空闲线程也会shut down，避免资源浪费。\n```\n@Override\n\tprotected ExecutorService initializeExecutor(\n\t\t\tThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) {\n\t\t//1、创建队列：最大容量>0，创建有界阻塞队列LinkedBlockingQueue；否则创建SynchronousQueue，其内部只有包含一个元素，因此，需要线程池足够大，否则，会出现大量拒绝\n\t\tBlockingQueue<Runnable> queue = createQueue(this.queueCapacity);\n\n\t\tThreadPoolExecutor executor;\n\t\tif (this.taskDecorator != null) {\n\t\t\texecutor = new ThreadPoolExecutor(\n\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,\n\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler) {\n\t\t\t\t@Override\n\t\t\t\tpublic void execute(Runnable command) {\n\t\t\t\t\tsuper.execute(taskDecorator.decorate(command));\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\texecutor = new ThreadPoolExecutor(\n\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,\n\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler);\n\n\t\t}\n\n\t\tif (this.allowCoreThreadTimeOut) {\n\t\t\texecutor.allowCoreThreadTimeOut(true);\n\t\t}\n\t\t//2、创建java线程池ThreadPoolExcutor，即，ThreadPoolTaskExetor是对java线程池的包装\n\t\tthis.threadPoolExecutor = executor;\n\t\treturn executor;\n\t}\n```\n3、executor.execute(runnable);\n通过源码分析，线程池中线程的初始化是在执行阶段根据实际情况初始化的，如果活跃线程小于核心线程则新开线程(及时由线程是空闲的)，否则尝试将任务压入队列等待执行，如果队列压满则尝试根据最大线程数控制来新开线程（小于最大线程数时可新开线程）。java也提供了预分配核心线程的方法，支持提前创建核心线程，prestartCoreThread。\n```\npublic void execute(Runnable command) {\nif (command == null)\n            throw new NullPointerException();\n        /*\n         * Proceed in 3 steps:\n         *\n         * 1. If fewer than corePoolSize threads are running, try to\n         * start a new thread with the given command as its first\n         * task.  The call to addWorker atomically checks runState and\n         * workerCount, and so prevents false alarms that would add\n         * threads when it shouldn't, by returning false.\n         *\n         * 2. If a task can be successfully queued, then we still need\n         * to double-check whether we should have added a thread\n         * (because existing ones died since last checking) or that\n         * the pool shut down since entry into this method. So we\n         * recheck state and if necessary roll back the enqueuing if\n         * stopped, or start a new thread if there are none.\n         *\n         * 3. If we cannot queue task, then we try to add a new\n         * thread.  If it fails, we know we are shut down or saturated\n         * and so reject the task.\n         */\n        int c = ctl.get();\n        if (workerCountOf(c) < corePoolSize) {\n            if (addWorker(command, true))\n                return;//1、如果work数量小于核心线程大小，则新增work并把该任务委派给此work\n            c = ctl.get();\n        }\n        //2、如果work数量大于等于核心线程大小，同时活动中的线程小于被shutdown的线程（代表相对空闲），同时队列未满，则把该任务压入队列中\n        if (isRunning(c) && workQueue.offer(command)) {\n            int recheck = ctl.get();\n            if (! isRunning(recheck) && remove(command))\n                reject(command);\n            else if (workerCountOf(recheck) == 0)\n                addWorker(null, false);\n        }\n        //3、如果活动中的线程大于被shutdown的线程（代表相对繁忙）或者队列已满，则新增work并把该任务委派给此work，数量受maxPoolSize控制\n        else if (!addWorker(command, false))\n            reject(command);\n            }\n```\n addWorker(Runnable firstTask, boolean core){};\n 该方法用于创建work并执行初始化任务或者队列中的任务。\n ```\n private boolean addWorker(Runnable firstTask, boolean core) {\n        retry:\n        for (;;) {\n            int c = ctl.get();\n            int rs = runStateOf(c);//\n\n            // Check if queue empty only if necessary.\n            if (rs >= SHUTDOWN &&\n                ! (rs == SHUTDOWN &&\n                   firstTask == null &&\n                   ! workQueue.isEmpty()))\n                return false;\n\n            for (;;) {\n                int wc = workerCountOf(c);\n                if (wc >= CAPACITY ||\n                    wc >= (core ? corePoolSize : maximumPoolSize))\n                    return false;\n                if (compareAndIncrementWorkerCount(c))\n                    break retry;\n                c = ctl.get();  // Re-read ctl\n                if (runStateOf(c) != rs)\n                    continue retry;\n                // else CAS failed due to workerCount change; retry inner loop\n            }\n        }\n\n        boolean workerStarted = false;\n        boolean workerAdded = false;\n        Worker w = null;\n        try {\n            w = new Worker(firstTask);\n            final Thread t = w.thread;\n            if (t != null) {\n                final ReentrantLock mainLock = this.mainLock;\n                mainLock.lock();\n                try {\n                    // Recheck while holding lock.\n                    // Back out on ThreadFactory failure or if\n                    // shut down before lock acquired.\n                    int rs = runStateOf(ctl.get());\n\n                    if (rs < SHUTDOWN ||\n                        (rs == SHUTDOWN && firstTask == null)) {\n                        if (t.isAlive()) // precheck that t is startable\n                            throw new IllegalThreadStateException();\n                        workers.add(w);\n                        int s = workers.size();\n                        if (s > largestPoolSize)\n                            largestPoolSize = s;\n                        workerAdded = true;\n                    }\n                } finally {\n                    mainLock.unlock();\n                }\n                if (workerAdded) {\n                //使用新建的work执行任务\n                    t.start();\n                    workerStarted = true;\n                }\n            }\n        } finally {\n            if (! workerStarted)\n                addWorkerFailed(w);\n        }\n        return workerStarted;\n    }\n    \n    final void runWorker(Worker w) {\n        Thread wt = Thread.currentThread();\n        Runnable task = w.firstTask;\n        w.firstTask = null;\n        w.unlock(); // allow interrupts\n        boolean completedAbruptly = true;\n        try {\n        //执行当前任务或者从队列中获取任务执行\n            while (task != null || (task = getTask()) != null) {\n                w.lock();\n                // If pool is stopping, ensure thread is interrupted;\n                // if not, ensure thread is not interrupted.  This\n                // requires a recheck in second case to deal with\n                // shutdownNow race while clearing interrupt\n                if ((runStateAtLeast(ctl.get(), STOP) ||\n                     (Thread.interrupted() &&\n                      runStateAtLeast(ctl.get(), STOP))) &&\n                    !wt.isInterrupted())\n                    wt.interrupt();\n                try {\n                    beforeExecute(wt, task);\n                    Throwable thrown = null;\n                    try {\n                        task.run();\n                    } catch (RuntimeException x) {\n                        thrown = x; throw x;\n                    } catch (Error x) {\n                        thrown = x; throw x;\n                    } catch (Throwable x) {\n                        thrown = x; throw new Error(x);\n                    } finally {\n                        afterExecute(task, thrown);\n                    }\n                } finally {\n                    task = null;\n                    w.completedTasks++;\n                    w.unlock();\n                }\n            }\n            completedAbruptly = false;\n        } finally {\n            processWorkerExit(w, completedAbruptly);\n        }\n    }\n    \n    /**\n     * Performs blocking or timed wait for a task, depending on\n     * current configuration settings, or returns null if this worker\n     * must exit because of any of:\n     * 1. There are more than maximumPoolSize workers (due to\n     *    a call to setMaximumPoolSize).\n     * 2. The pool is stopped.\n     * 3. The pool is shutdown and the queue is empty.\n     * 4. This worker timed out waiting for a task, and timed-out\n     *    workers are subject to termination (that is,\n     *    {@code allowCoreThreadTimeOut || workerCount > corePoolSize})\n     *    both before and after the timed wait, and if the queue is\n     *    non-empty, this worker is not the last thread in the pool.\n     *\n     * @return task, or null if the worker must exit, in which case\n     *         workerCount is decremented\n     */\n    private Runnable getTask() {\n        boolean timedOut = false; // Did the last poll() time out?\n\n        for (;;) {\n            int c = ctl.get();\n            int rs = runStateOf(c);\n\n            // Check if queue empty only if necessary.\n            if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\n                decrementWorkerCount();\n                return null;\n            }\n\n            int wc = workerCountOf(c);\n\n            // Are workers subject to culling?\n            boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n            if ((wc > maximumPoolSize || (timed && timedOut))\n                && (wc > 1 || workQueue.isEmpty())) {\n                if (compareAndDecrementWorkerCount(c))\n                    return null;\n                continue;\n            }\n\n            try {\n            //poll()为非阻塞方法,如果当前队列为空,超时候，直接返回，超时返回时，返回的为null，此时会在runWorker后续方法中调用processWorkerExit，从而实现了对超过数量（大于核心线程，或者允许核心线程超时后回收）的线程超时后回收\n            //take()为阻塞方法,如果当前队列为空,则阻塞线程,封装线程到AQS的条件变量的条件队列中\n                Runnable r = timed ?\n                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                    workQueue.take();\n                if (r != null)\n                    return r;\n                timedOut = true;\n            } catch (InterruptedException retry) {\n                timedOut = false;\n            }\n        }\n    }\n    \n    private void processWorkerExit(Worker w, boolean completedAbruptly) {\n        if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted\n            decrementWorkerCount();\n\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            completedTaskCount += w.completedTasks;\n            //当前任务及队列中的任务执行完成后，移除当前work\n            workers.remove(w);\n        } finally {\n            mainLock.unlock();\n        }\n\n        tryTerminate();\n\n        int c = ctl.get();\n        if (runStateLessThan(c, STOP)) {\n            if (!completedAbruptly) {\n                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;\n                if (min == 0 && ! workQueue.isEmpty())\n                    min = 1;\n                if (workerCountOf(c) >= min)\n                    return; // replacement not needed\n            }\n            //如果剩余wrok数量小于核心线程大小（注意，如果设置了allowCoreThreadTimeOut，那么线程池不会保持最低核心线程数个线程），新建work\n            addWorker(null, false);\n        }\n    }\n    \n    /**\n     * Transitions to TERMINATED state if either (SHUTDOWN and pool\n     * and queue empty) or (STOP and pool empty).  If otherwise\n     * eligible to terminate but workerCount is nonzero, interrupts an\n     * idle worker to ensure that shutdown signals propagate. This\n     * method must be called following any action that might make\n     * termination possible -- reducing worker count or removing tasks\n     * from the queue during shutdown. The method is non-private to\n     * allow access from ScheduledThreadPoolExecutor.\n     */\n    final void tryTerminate() {\n        for (;;) {\n            int c = ctl.get();\n            if (isRunning(c) ||\n                runStateAtLeast(c, TIDYING) ||\n                (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))\n                return;\n            if (workerCountOf(c) != 0) { // Eligible to terminate\n                interruptIdleWorkers(ONLY_ONE);\n                return;\n            }\n\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {\n                    try {\n                        terminated();\n                    } finally {\n                        ctl.set(ctlOf(TERMINATED, 0));\n                        termination.signalAll();\n                    }\n                    return;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            // else retry on failed CAS\n        }\n    }\n    \n    /**\n     * Interrupts threads that might be waiting for tasks (as\n     * indicated by not being locked) so they can check for\n     * termination or configuration changes. Ignores\n     * SecurityExceptions (in which case some threads may remain\n     * uninterrupted).\n     *\n     * @param onlyOne If true, interrupt at most one worker. This is\n     * called only from tryTerminate when termination is otherwise\n     * enabled but there are still other workers.  In this case, at\n     * most one waiting worker is interrupted to propagate shutdown\n     * signals in case all threads are currently waiting.\n     * Interrupting any arbitrary thread ensures that newly arriving\n     * workers since shutdown began will also eventually exit.\n     * To guarantee eventual termination, it suffices to always\n     * interrupt only one idle worker, but shutdown() interrupts all\n     * idle workers so that redundant workers exit promptly, not\n     * waiting for a straggler task to finish.\n     */\n    private void interruptIdleWorkers(boolean onlyOne) {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (Worker w : workers) {\n                Thread t = w.thread;\n                //中断所有空闲线程，由于在runWorker中，活跃线程上锁了w.lock();，因此此处实现了只会终止空闲线程的效果\n                if (!t.isInterrupted() && w.tryLock()) {\n                    try {\n                        t.interrupt();\n                    } catch (SecurityException ignore) {\n                    } finally {\n                        w.unlock();\n                    }\n                }\n                if (onlyOne)\n                    break;\n            }\n        } finally {\n            mainLock.unlock();\n        }\n    }\n ```\n 4、动态调整线程池大小，由于业务需要，很多场景下，需要在运行时动态调整核心线程或最大线程的大小\n ```\n /**\n     * Sets the core number of threads.  This overrides any value set\n     * in the constructor.  If the new value is smaller than the\n     * current value, excess existing threads will be terminated when\n     * they next become idle.  If larger, new threads will, if needed,\n     * be started to execute any queued tasks.\n     *\n     * @param corePoolSize the new core size\n     * @throws IllegalArgumentException if {@code corePoolSize < 0}\n     * @see #getCorePoolSize\n     */\n    public void setCorePoolSize(int corePoolSize) {\n        if (corePoolSize < 0)\n            throw new IllegalArgumentException();\n        int delta = corePoolSize - this.corePoolSize;\n        this.corePoolSize = corePoolSize;\n        if (workerCountOf(ctl.get()) > corePoolSize)\n        //中断所有空闲线程，由于在runWorker中，活跃线程上锁了，因此此处实现了只会终止空闲线程的效果\n            interruptIdleWorkers();\n        else if (delta > 0) {\n            // We don't really know how many new threads are \"needed\".\n            // As a heuristic, prestart enough new workers (up to new\n            // core size) to handle the current number of tasks in\n            // queue, but stop if queue becomes empty while doing so.\n            int k = Math.min(delta, workQueue.size());\n            while (k-- > 0 && addWorker(null, true)) {\n                if (workQueue.isEmpty())\n                    break;\n            }\n        }\n    }\n ```","source":"_posts/剥开源码看java.md","raw":"title: 剥开源码看java-线程池ThreadPoolExecutor\nauthor: Xiang Chuang\ntags: []\ncategories:\n  - 你好，源码\ndate: 2020-01-10 10:30:00\n---\n本文从spring对于线程池的实现ThreadPoolTaskExecutor入手阐述，由于该实现是对java的ThreadPoolExecutor进行了一次包装（扩展线程池能力），因此文中更多涉及到的是ThreadPoolExecutor关键实现逻辑的原理分析\n![upload successful](/images/pasted-99.png)\n\n![upload successful](/images/pasted-103.png)\n1、executor = new ThreadPoolTaskExecutor();主要操作：父类CustomizableThreadCreator构造函数初始化，默认threadNamePrefix为实现类名简称-\n2、excutor参数设置并excutor.initialize();（该方法属于ExecutorConfigurationSupport），其中会调用抽象方法initializeExecutor，由ThreadPoolTaskExecutor实现。\n该处除了下面要讨论的corePoolSize，maxPollSize，queueCapacity外，想先说一下keepAliveSeconds这个值，代表允许操作核心线程数部分的线程空闲多长时间（s）后shut down，如果初始化时设置了allowCoreThreadTimeOut（true），那么对核心线程数以内的空闲线程也会shut down，避免资源浪费。\n```\n@Override\n\tprotected ExecutorService initializeExecutor(\n\t\t\tThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) {\n\t\t//1、创建队列：最大容量>0，创建有界阻塞队列LinkedBlockingQueue；否则创建SynchronousQueue，其内部只有包含一个元素，因此，需要线程池足够大，否则，会出现大量拒绝\n\t\tBlockingQueue<Runnable> queue = createQueue(this.queueCapacity);\n\n\t\tThreadPoolExecutor executor;\n\t\tif (this.taskDecorator != null) {\n\t\t\texecutor = new ThreadPoolExecutor(\n\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,\n\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler) {\n\t\t\t\t@Override\n\t\t\t\tpublic void execute(Runnable command) {\n\t\t\t\t\tsuper.execute(taskDecorator.decorate(command));\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\texecutor = new ThreadPoolExecutor(\n\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,\n\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler);\n\n\t\t}\n\n\t\tif (this.allowCoreThreadTimeOut) {\n\t\t\texecutor.allowCoreThreadTimeOut(true);\n\t\t}\n\t\t//2、创建java线程池ThreadPoolExcutor，即，ThreadPoolTaskExetor是对java线程池的包装\n\t\tthis.threadPoolExecutor = executor;\n\t\treturn executor;\n\t}\n```\n3、executor.execute(runnable);\n通过源码分析，线程池中线程的初始化是在执行阶段根据实际情况初始化的，如果活跃线程小于核心线程则新开线程(及时由线程是空闲的)，否则尝试将任务压入队列等待执行，如果队列压满则尝试根据最大线程数控制来新开线程（小于最大线程数时可新开线程）。java也提供了预分配核心线程的方法，支持提前创建核心线程，prestartCoreThread。\n```\npublic void execute(Runnable command) {\nif (command == null)\n            throw new NullPointerException();\n        /*\n         * Proceed in 3 steps:\n         *\n         * 1. If fewer than corePoolSize threads are running, try to\n         * start a new thread with the given command as its first\n         * task.  The call to addWorker atomically checks runState and\n         * workerCount, and so prevents false alarms that would add\n         * threads when it shouldn't, by returning false.\n         *\n         * 2. If a task can be successfully queued, then we still need\n         * to double-check whether we should have added a thread\n         * (because existing ones died since last checking) or that\n         * the pool shut down since entry into this method. So we\n         * recheck state and if necessary roll back the enqueuing if\n         * stopped, or start a new thread if there are none.\n         *\n         * 3. If we cannot queue task, then we try to add a new\n         * thread.  If it fails, we know we are shut down or saturated\n         * and so reject the task.\n         */\n        int c = ctl.get();\n        if (workerCountOf(c) < corePoolSize) {\n            if (addWorker(command, true))\n                return;//1、如果work数量小于核心线程大小，则新增work并把该任务委派给此work\n            c = ctl.get();\n        }\n        //2、如果work数量大于等于核心线程大小，同时活动中的线程小于被shutdown的线程（代表相对空闲），同时队列未满，则把该任务压入队列中\n        if (isRunning(c) && workQueue.offer(command)) {\n            int recheck = ctl.get();\n            if (! isRunning(recheck) && remove(command))\n                reject(command);\n            else if (workerCountOf(recheck) == 0)\n                addWorker(null, false);\n        }\n        //3、如果活动中的线程大于被shutdown的线程（代表相对繁忙）或者队列已满，则新增work并把该任务委派给此work，数量受maxPoolSize控制\n        else if (!addWorker(command, false))\n            reject(command);\n            }\n```\n addWorker(Runnable firstTask, boolean core){};\n 该方法用于创建work并执行初始化任务或者队列中的任务。\n ```\n private boolean addWorker(Runnable firstTask, boolean core) {\n        retry:\n        for (;;) {\n            int c = ctl.get();\n            int rs = runStateOf(c);//\n\n            // Check if queue empty only if necessary.\n            if (rs >= SHUTDOWN &&\n                ! (rs == SHUTDOWN &&\n                   firstTask == null &&\n                   ! workQueue.isEmpty()))\n                return false;\n\n            for (;;) {\n                int wc = workerCountOf(c);\n                if (wc >= CAPACITY ||\n                    wc >= (core ? corePoolSize : maximumPoolSize))\n                    return false;\n                if (compareAndIncrementWorkerCount(c))\n                    break retry;\n                c = ctl.get();  // Re-read ctl\n                if (runStateOf(c) != rs)\n                    continue retry;\n                // else CAS failed due to workerCount change; retry inner loop\n            }\n        }\n\n        boolean workerStarted = false;\n        boolean workerAdded = false;\n        Worker w = null;\n        try {\n            w = new Worker(firstTask);\n            final Thread t = w.thread;\n            if (t != null) {\n                final ReentrantLock mainLock = this.mainLock;\n                mainLock.lock();\n                try {\n                    // Recheck while holding lock.\n                    // Back out on ThreadFactory failure or if\n                    // shut down before lock acquired.\n                    int rs = runStateOf(ctl.get());\n\n                    if (rs < SHUTDOWN ||\n                        (rs == SHUTDOWN && firstTask == null)) {\n                        if (t.isAlive()) // precheck that t is startable\n                            throw new IllegalThreadStateException();\n                        workers.add(w);\n                        int s = workers.size();\n                        if (s > largestPoolSize)\n                            largestPoolSize = s;\n                        workerAdded = true;\n                    }\n                } finally {\n                    mainLock.unlock();\n                }\n                if (workerAdded) {\n                //使用新建的work执行任务\n                    t.start();\n                    workerStarted = true;\n                }\n            }\n        } finally {\n            if (! workerStarted)\n                addWorkerFailed(w);\n        }\n        return workerStarted;\n    }\n    \n    final void runWorker(Worker w) {\n        Thread wt = Thread.currentThread();\n        Runnable task = w.firstTask;\n        w.firstTask = null;\n        w.unlock(); // allow interrupts\n        boolean completedAbruptly = true;\n        try {\n        //执行当前任务或者从队列中获取任务执行\n            while (task != null || (task = getTask()) != null) {\n                w.lock();\n                // If pool is stopping, ensure thread is interrupted;\n                // if not, ensure thread is not interrupted.  This\n                // requires a recheck in second case to deal with\n                // shutdownNow race while clearing interrupt\n                if ((runStateAtLeast(ctl.get(), STOP) ||\n                     (Thread.interrupted() &&\n                      runStateAtLeast(ctl.get(), STOP))) &&\n                    !wt.isInterrupted())\n                    wt.interrupt();\n                try {\n                    beforeExecute(wt, task);\n                    Throwable thrown = null;\n                    try {\n                        task.run();\n                    } catch (RuntimeException x) {\n                        thrown = x; throw x;\n                    } catch (Error x) {\n                        thrown = x; throw x;\n                    } catch (Throwable x) {\n                        thrown = x; throw new Error(x);\n                    } finally {\n                        afterExecute(task, thrown);\n                    }\n                } finally {\n                    task = null;\n                    w.completedTasks++;\n                    w.unlock();\n                }\n            }\n            completedAbruptly = false;\n        } finally {\n            processWorkerExit(w, completedAbruptly);\n        }\n    }\n    \n    /**\n     * Performs blocking or timed wait for a task, depending on\n     * current configuration settings, or returns null if this worker\n     * must exit because of any of:\n     * 1. There are more than maximumPoolSize workers (due to\n     *    a call to setMaximumPoolSize).\n     * 2. The pool is stopped.\n     * 3. The pool is shutdown and the queue is empty.\n     * 4. This worker timed out waiting for a task, and timed-out\n     *    workers are subject to termination (that is,\n     *    {@code allowCoreThreadTimeOut || workerCount > corePoolSize})\n     *    both before and after the timed wait, and if the queue is\n     *    non-empty, this worker is not the last thread in the pool.\n     *\n     * @return task, or null if the worker must exit, in which case\n     *         workerCount is decremented\n     */\n    private Runnable getTask() {\n        boolean timedOut = false; // Did the last poll() time out?\n\n        for (;;) {\n            int c = ctl.get();\n            int rs = runStateOf(c);\n\n            // Check if queue empty only if necessary.\n            if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\n                decrementWorkerCount();\n                return null;\n            }\n\n            int wc = workerCountOf(c);\n\n            // Are workers subject to culling?\n            boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n            if ((wc > maximumPoolSize || (timed && timedOut))\n                && (wc > 1 || workQueue.isEmpty())) {\n                if (compareAndDecrementWorkerCount(c))\n                    return null;\n                continue;\n            }\n\n            try {\n            //poll()为非阻塞方法,如果当前队列为空,超时候，直接返回，超时返回时，返回的为null，此时会在runWorker后续方法中调用processWorkerExit，从而实现了对超过数量（大于核心线程，或者允许核心线程超时后回收）的线程超时后回收\n            //take()为阻塞方法,如果当前队列为空,则阻塞线程,封装线程到AQS的条件变量的条件队列中\n                Runnable r = timed ?\n                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                    workQueue.take();\n                if (r != null)\n                    return r;\n                timedOut = true;\n            } catch (InterruptedException retry) {\n                timedOut = false;\n            }\n        }\n    }\n    \n    private void processWorkerExit(Worker w, boolean completedAbruptly) {\n        if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted\n            decrementWorkerCount();\n\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            completedTaskCount += w.completedTasks;\n            //当前任务及队列中的任务执行完成后，移除当前work\n            workers.remove(w);\n        } finally {\n            mainLock.unlock();\n        }\n\n        tryTerminate();\n\n        int c = ctl.get();\n        if (runStateLessThan(c, STOP)) {\n            if (!completedAbruptly) {\n                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;\n                if (min == 0 && ! workQueue.isEmpty())\n                    min = 1;\n                if (workerCountOf(c) >= min)\n                    return; // replacement not needed\n            }\n            //如果剩余wrok数量小于核心线程大小（注意，如果设置了allowCoreThreadTimeOut，那么线程池不会保持最低核心线程数个线程），新建work\n            addWorker(null, false);\n        }\n    }\n    \n    /**\n     * Transitions to TERMINATED state if either (SHUTDOWN and pool\n     * and queue empty) or (STOP and pool empty).  If otherwise\n     * eligible to terminate but workerCount is nonzero, interrupts an\n     * idle worker to ensure that shutdown signals propagate. This\n     * method must be called following any action that might make\n     * termination possible -- reducing worker count or removing tasks\n     * from the queue during shutdown. The method is non-private to\n     * allow access from ScheduledThreadPoolExecutor.\n     */\n    final void tryTerminate() {\n        for (;;) {\n            int c = ctl.get();\n            if (isRunning(c) ||\n                runStateAtLeast(c, TIDYING) ||\n                (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))\n                return;\n            if (workerCountOf(c) != 0) { // Eligible to terminate\n                interruptIdleWorkers(ONLY_ONE);\n                return;\n            }\n\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {\n                    try {\n                        terminated();\n                    } finally {\n                        ctl.set(ctlOf(TERMINATED, 0));\n                        termination.signalAll();\n                    }\n                    return;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            // else retry on failed CAS\n        }\n    }\n    \n    /**\n     * Interrupts threads that might be waiting for tasks (as\n     * indicated by not being locked) so they can check for\n     * termination or configuration changes. Ignores\n     * SecurityExceptions (in which case some threads may remain\n     * uninterrupted).\n     *\n     * @param onlyOne If true, interrupt at most one worker. This is\n     * called only from tryTerminate when termination is otherwise\n     * enabled but there are still other workers.  In this case, at\n     * most one waiting worker is interrupted to propagate shutdown\n     * signals in case all threads are currently waiting.\n     * Interrupting any arbitrary thread ensures that newly arriving\n     * workers since shutdown began will also eventually exit.\n     * To guarantee eventual termination, it suffices to always\n     * interrupt only one idle worker, but shutdown() interrupts all\n     * idle workers so that redundant workers exit promptly, not\n     * waiting for a straggler task to finish.\n     */\n    private void interruptIdleWorkers(boolean onlyOne) {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (Worker w : workers) {\n                Thread t = w.thread;\n                //中断所有空闲线程，由于在runWorker中，活跃线程上锁了w.lock();，因此此处实现了只会终止空闲线程的效果\n                if (!t.isInterrupted() && w.tryLock()) {\n                    try {\n                        t.interrupt();\n                    } catch (SecurityException ignore) {\n                    } finally {\n                        w.unlock();\n                    }\n                }\n                if (onlyOne)\n                    break;\n            }\n        } finally {\n            mainLock.unlock();\n        }\n    }\n ```\n 4、动态调整线程池大小，由于业务需要，很多场景下，需要在运行时动态调整核心线程或最大线程的大小\n ```\n /**\n     * Sets the core number of threads.  This overrides any value set\n     * in the constructor.  If the new value is smaller than the\n     * current value, excess existing threads will be terminated when\n     * they next become idle.  If larger, new threads will, if needed,\n     * be started to execute any queued tasks.\n     *\n     * @param corePoolSize the new core size\n     * @throws IllegalArgumentException if {@code corePoolSize < 0}\n     * @see #getCorePoolSize\n     */\n    public void setCorePoolSize(int corePoolSize) {\n        if (corePoolSize < 0)\n            throw new IllegalArgumentException();\n        int delta = corePoolSize - this.corePoolSize;\n        this.corePoolSize = corePoolSize;\n        if (workerCountOf(ctl.get()) > corePoolSize)\n        //中断所有空闲线程，由于在runWorker中，活跃线程上锁了，因此此处实现了只会终止空闲线程的效果\n            interruptIdleWorkers();\n        else if (delta > 0) {\n            // We don't really know how many new threads are \"needed\".\n            // As a heuristic, prestart enough new workers (up to new\n            // core size) to handle the current number of tasks in\n            // queue, but stop if queue becomes empty while doing so.\n            int k = Math.min(delta, workQueue.size());\n            while (k-- > 0 && addWorker(null, true)) {\n                if (workQueue.isEmpty())\n                    break;\n            }\n        }\n    }\n ```","slug":"剥开源码看java","published":1,"updated":"2020-01-10T08:37:23.456Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vcs006owy66d34k6y99","content":"<p>本文从spring对于线程池的实现ThreadPoolTaskExecutor入手阐述，由于该实现是对java的ThreadPoolExecutor进行了一次包装（扩展线程池能力），因此文中更多涉及到的是ThreadPoolExecutor关键实现逻辑的原理分析<br><img src=\"/images/pasted-99.png\" alt=\"upload successful\"></p>\n<p><img src=\"/images/pasted-103.png\" alt=\"upload successful\"><br>1、executor = new ThreadPoolTaskExecutor();主要操作：父类CustomizableThreadCreator构造函数初始化，默认threadNamePrefix为实现类名简称-<br>2、excutor参数设置并excutor.initialize();（该方法属于ExecutorConfigurationSupport），其中会调用抽象方法initializeExecutor，由ThreadPoolTaskExecutor实现。<br>该处除了下面要讨论的corePoolSize，maxPollSize，queueCapacity外，想先说一下keepAliveSeconds这个值，代表允许操作核心线程数部分的线程空闲多长时间（s）后shut down，如果初始化时设置了allowCoreThreadTimeOut（true），那么对核心线程数以内的空闲线程也会shut down，避免资源浪费。<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Override</span><br><span class=\"line\">\tprotected ExecutorService initializeExecutor(</span><br><span class=\"line\">\t\t\tThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) &#123;</span><br><span class=\"line\">\t\t//1、创建队列：最大容量&gt;0，创建有界阻塞队列LinkedBlockingQueue；否则创建SynchronousQueue，其内部只有包含一个元素，因此，需要线程池足够大，否则，会出现大量拒绝</span><br><span class=\"line\">\t\tBlockingQueue&lt;Runnable&gt; queue = createQueue(this.queueCapacity);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tThreadPoolExecutor executor;</span><br><span class=\"line\">\t\tif (this.taskDecorator != null) &#123;</span><br><span class=\"line\">\t\t\texecutor = new ThreadPoolExecutor(</span><br><span class=\"line\">\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,</span><br><span class=\"line\">\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler) &#123;</span><br><span class=\"line\">\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\tpublic void execute(Runnable command) &#123;</span><br><span class=\"line\">\t\t\t\t\tsuper.execute(taskDecorator.decorate(command));</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\telse &#123;</span><br><span class=\"line\">\t\t\texecutor = new ThreadPoolExecutor(</span><br><span class=\"line\">\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,</span><br><span class=\"line\">\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif (this.allowCoreThreadTimeOut) &#123;</span><br><span class=\"line\">\t\t\texecutor.allowCoreThreadTimeOut(true);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//2、创建java线程池ThreadPoolExcutor，即，ThreadPoolTaskExetor是对java线程池的包装</span><br><span class=\"line\">\t\tthis.threadPoolExecutor = executor;</span><br><span class=\"line\">\t\treturn executor;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure><br>3、executor.execute(runnable);<br>通过源码分析，线程池中线程的初始化是在执行阶段根据实际情况初始化的，如果活跃线程小于核心线程则新开线程(及时由线程是空闲的)，否则尝试将任务压入队列等待执行，如果队列压满则尝试根据最大线程数控制来新开线程（小于最大线程数时可新开线程）。java也提供了预分配核心线程的方法，支持提前创建核心线程，prestartCoreThread。<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void execute(Runnable command) &#123;</span><br><span class=\"line\">if (command == null)</span><br><span class=\"line\">            throw new NullPointerException();</span><br><span class=\"line\">        /*</span><br><span class=\"line\">         * Proceed in 3 steps:</span><br><span class=\"line\">         *</span><br><span class=\"line\">         * 1. If fewer than corePoolSize threads are running, try to</span><br><span class=\"line\">         * start a new thread with the given command as its first</span><br><span class=\"line\">         * task.  The call to addWorker atomically checks runState and</span><br><span class=\"line\">         * workerCount, and so prevents false alarms that would add</span><br><span class=\"line\">         * threads when it shouldn&#x27;t, by returning false.</span><br><span class=\"line\">         *</span><br><span class=\"line\">         * 2. If a task can be successfully queued, then we still need</span><br><span class=\"line\">         * to double-check whether we should have added a thread</span><br><span class=\"line\">         * (because existing ones died since last checking) or that</span><br><span class=\"line\">         * the pool shut down since entry into this method. So we</span><br><span class=\"line\">         * recheck state and if necessary roll back the enqueuing if</span><br><span class=\"line\">         * stopped, or start a new thread if there are none.</span><br><span class=\"line\">         *</span><br><span class=\"line\">         * 3. If we cannot queue task, then we try to add a new</span><br><span class=\"line\">         * thread.  If it fails, we know we are shut down or saturated</span><br><span class=\"line\">         * and so reject the task.</span><br><span class=\"line\">         */</span><br><span class=\"line\">        int c = ctl.get();</span><br><span class=\"line\">        if (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class=\"line\">            if (addWorker(command, true))</span><br><span class=\"line\">                return;//1、如果work数量小于核心线程大小，则新增work并把该任务委派给此work</span><br><span class=\"line\">            c = ctl.get();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //2、如果work数量大于等于核心线程大小，同时活动中的线程小于被shutdown的线程（代表相对空闲），同时队列未满，则把该任务压入队列中</span><br><span class=\"line\">        if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class=\"line\">            int recheck = ctl.get();</span><br><span class=\"line\">            if (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class=\"line\">                reject(command);</span><br><span class=\"line\">            else if (workerCountOf(recheck) == 0)</span><br><span class=\"line\">                addWorker(null, false);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //3、如果活动中的线程大于被shutdown的线程（代表相对繁忙）或者队列已满，则新增work并把该任务委派给此work，数量受maxPoolSize控制</span><br><span class=\"line\">        else if (!addWorker(command, false))</span><br><span class=\"line\">            reject(command);</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure><br> addWorker(Runnable firstTask, boolean core){};<br> 该方法用于创建work并执行初始化任务或者队列中的任务。<br> <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private boolean addWorker(Runnable firstTask, boolean core) &#123;</span><br><span class=\"line\">       retry:</span><br><span class=\"line\">       for (;;) &#123;</span><br><span class=\"line\">           int c = ctl.get();</span><br><span class=\"line\">           int rs = runStateOf(c);//</span><br><span class=\"line\"></span><br><span class=\"line\">           // Check if queue empty only if necessary.</span><br><span class=\"line\">           if (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class=\"line\">               ! (rs == SHUTDOWN &amp;&amp;</span><br><span class=\"line\">                  firstTask == null &amp;&amp;</span><br><span class=\"line\">                  ! workQueue.isEmpty()))</span><br><span class=\"line\">               return false;</span><br><span class=\"line\"></span><br><span class=\"line\">           for (;;) &#123;</span><br><span class=\"line\">               int wc = workerCountOf(c);</span><br><span class=\"line\">               if (wc &gt;= CAPACITY ||</span><br><span class=\"line\">                   wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class=\"line\">                   return false;</span><br><span class=\"line\">               if (compareAndIncrementWorkerCount(c))</span><br><span class=\"line\">                   break retry;</span><br><span class=\"line\">               c = ctl.get();  // Re-read ctl</span><br><span class=\"line\">               if (runStateOf(c) != rs)</span><br><span class=\"line\">                   continue retry;</span><br><span class=\"line\">               // else CAS failed due to workerCount change; retry inner loop</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       boolean workerStarted = false;</span><br><span class=\"line\">       boolean workerAdded = false;</span><br><span class=\"line\">       Worker w = null;</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">           w = new Worker(firstTask);</span><br><span class=\"line\">           final Thread t = w.thread;</span><br><span class=\"line\">           if (t != null) &#123;</span><br><span class=\"line\">               final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">               mainLock.lock();</span><br><span class=\"line\">               try &#123;</span><br><span class=\"line\">                   // Recheck while holding lock.</span><br><span class=\"line\">                   // Back out on ThreadFactory failure or if</span><br><span class=\"line\">                   // shut down before lock acquired.</span><br><span class=\"line\">                   int rs = runStateOf(ctl.get());</span><br><span class=\"line\"></span><br><span class=\"line\">                   if (rs &lt; SHUTDOWN ||</span><br><span class=\"line\">                       (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123;</span><br><span class=\"line\">                       if (t.isAlive()) // precheck that t is startable</span><br><span class=\"line\">                           throw new IllegalThreadStateException();</span><br><span class=\"line\">                       workers.add(w);</span><br><span class=\"line\">                       int s = workers.size();</span><br><span class=\"line\">                       if (s &gt; largestPoolSize)</span><br><span class=\"line\">                           largestPoolSize = s;</span><br><span class=\"line\">                       workerAdded = true;</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125; finally &#123;</span><br><span class=\"line\">                   mainLock.unlock();</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               if (workerAdded) &#123;</span><br><span class=\"line\">               //使用新建的work执行任务</span><br><span class=\"line\">                   t.start();</span><br><span class=\"line\">                   workerStarted = true;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           if (! workerStarted)</span><br><span class=\"line\">               addWorkerFailed(w);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       return workerStarted;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   final void runWorker(Worker w) &#123;</span><br><span class=\"line\">       Thread wt = Thread.currentThread();</span><br><span class=\"line\">       Runnable task = w.firstTask;</span><br><span class=\"line\">       w.firstTask = null;</span><br><span class=\"line\">       w.unlock(); // allow interrupts</span><br><span class=\"line\">       boolean completedAbruptly = true;</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">       //执行当前任务或者从队列中获取任务执行</span><br><span class=\"line\">           while (task != null || (task = getTask()) != null) &#123;</span><br><span class=\"line\">               w.lock();</span><br><span class=\"line\">               // If pool is stopping, ensure thread is interrupted;</span><br><span class=\"line\">               // if not, ensure thread is not interrupted.  This</span><br><span class=\"line\">               // requires a recheck in second case to deal with</span><br><span class=\"line\">               // shutdownNow race while clearing interrupt</span><br><span class=\"line\">               if ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class=\"line\">                    (Thread.interrupted() &amp;&amp;</span><br><span class=\"line\">                     runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class=\"line\">                   !wt.isInterrupted())</span><br><span class=\"line\">                   wt.interrupt();</span><br><span class=\"line\">               try &#123;</span><br><span class=\"line\">                   beforeExecute(wt, task);</span><br><span class=\"line\">                   Throwable thrown = null;</span><br><span class=\"line\">                   try &#123;</span><br><span class=\"line\">                       task.run();</span><br><span class=\"line\">                   &#125; catch (RuntimeException x) &#123;</span><br><span class=\"line\">                       thrown = x; throw x;</span><br><span class=\"line\">                   &#125; catch (Error x) &#123;</span><br><span class=\"line\">                       thrown = x; throw x;</span><br><span class=\"line\">                   &#125; catch (Throwable x) &#123;</span><br><span class=\"line\">                       thrown = x; throw new Error(x);</span><br><span class=\"line\">                   &#125; finally &#123;</span><br><span class=\"line\">                       afterExecute(task, thrown);</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125; finally &#123;</span><br><span class=\"line\">                   task = null;</span><br><span class=\"line\">                   w.completedTasks++;</span><br><span class=\"line\">                   w.unlock();</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           completedAbruptly = false;</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           processWorkerExit(w, completedAbruptly);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   /**</span><br><span class=\"line\">    * Performs blocking or timed wait for a task, depending on</span><br><span class=\"line\">    * current configuration settings, or returns null if this worker</span><br><span class=\"line\">    * must exit because of any of:</span><br><span class=\"line\">    * 1. There are more than maximumPoolSize workers (due to</span><br><span class=\"line\">    *    a call to setMaximumPoolSize).</span><br><span class=\"line\">    * 2. The pool is stopped.</span><br><span class=\"line\">    * 3. The pool is shutdown and the queue is empty.</span><br><span class=\"line\">    * 4. This worker timed out waiting for a task, and timed-out</span><br><span class=\"line\">    *    workers are subject to termination (that is,</span><br><span class=\"line\">    *    &#123;@code allowCoreThreadTimeOut || workerCount &gt; corePoolSize&#125;)</span><br><span class=\"line\">    *    both before and after the timed wait, and if the queue is</span><br><span class=\"line\">    *    non-empty, this worker is not the last thread in the pool.</span><br><span class=\"line\">    *</span><br><span class=\"line\">    * @return task, or null if the worker must exit, in which case</span><br><span class=\"line\">    *         workerCount is decremented</span><br><span class=\"line\">    */</span><br><span class=\"line\">   private Runnable getTask() &#123;</span><br><span class=\"line\">       boolean timedOut = false; // Did the last poll() time out?</span><br><span class=\"line\"></span><br><span class=\"line\">       for (;;) &#123;</span><br><span class=\"line\">           int c = ctl.get();</span><br><span class=\"line\">           int rs = runStateOf(c);</span><br><span class=\"line\"></span><br><span class=\"line\">           // Check if queue empty only if necessary.</span><br><span class=\"line\">           if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class=\"line\">               decrementWorkerCount();</span><br><span class=\"line\">               return null;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           int wc = workerCountOf(c);</span><br><span class=\"line\"></span><br><span class=\"line\">           // Are workers subject to culling?</span><br><span class=\"line\">           boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class=\"line\"></span><br><span class=\"line\">           if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class=\"line\">               &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123;</span><br><span class=\"line\">               if (compareAndDecrementWorkerCount(c))</span><br><span class=\"line\">                   return null;</span><br><span class=\"line\">               continue;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           try &#123;</span><br><span class=\"line\">           //poll()为非阻塞方法,如果当前队列为空,超时候，直接返回，超时返回时，返回的为null，此时会在runWorker后续方法中调用processWorkerExit，从而实现了对超过数量（大于核心线程，或者允许核心线程超时后回收）的线程超时后回收</span><br><span class=\"line\">           //take()为阻塞方法,如果当前队列为空,则阻塞线程,封装线程到AQS的条件变量的条件队列中</span><br><span class=\"line\">               Runnable r = timed ?</span><br><span class=\"line\">                   workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class=\"line\">                   workQueue.take();</span><br><span class=\"line\">               if (r != null)</span><br><span class=\"line\">                   return r;</span><br><span class=\"line\">               timedOut = true;</span><br><span class=\"line\">           &#125; catch (InterruptedException retry) &#123;</span><br><span class=\"line\">               timedOut = false;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   private void processWorkerExit(Worker w, boolean completedAbruptly) &#123;</span><br><span class=\"line\">       if (completedAbruptly) // If abrupt, then workerCount wasn&#x27;t adjusted</span><br><span class=\"line\">           decrementWorkerCount();</span><br><span class=\"line\"></span><br><span class=\"line\">       final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">           completedTaskCount += w.completedTasks;</span><br><span class=\"line\">           //当前任务及队列中的任务执行完成后，移除当前work</span><br><span class=\"line\">           workers.remove(w);</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       tryTerminate();</span><br><span class=\"line\"></span><br><span class=\"line\">       int c = ctl.get();</span><br><span class=\"line\">       if (runStateLessThan(c, STOP)) &#123;</span><br><span class=\"line\">           if (!completedAbruptly) &#123;</span><br><span class=\"line\">               int min = allowCoreThreadTimeOut ? 0 : corePoolSize;</span><br><span class=\"line\">               if (min == 0 &amp;&amp; ! workQueue.isEmpty())</span><br><span class=\"line\">                   min = 1;</span><br><span class=\"line\">               if (workerCountOf(c) &gt;= min)</span><br><span class=\"line\">                   return; // replacement not needed</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           //如果剩余wrok数量小于核心线程大小（注意，如果设置了allowCoreThreadTimeOut，那么线程池不会保持最低核心线程数个线程），新建work</span><br><span class=\"line\">           addWorker(null, false);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   /**</span><br><span class=\"line\">    * Transitions to TERMINATED state if either (SHUTDOWN and pool</span><br><span class=\"line\">    * and queue empty) or (STOP and pool empty).  If otherwise</span><br><span class=\"line\">    * eligible to terminate but workerCount is nonzero, interrupts an</span><br><span class=\"line\">    * idle worker to ensure that shutdown signals propagate. This</span><br><span class=\"line\">    * method must be called following any action that might make</span><br><span class=\"line\">    * termination possible -- reducing worker count or removing tasks</span><br><span class=\"line\">    * from the queue during shutdown. The method is non-private to</span><br><span class=\"line\">    * allow access from ScheduledThreadPoolExecutor.</span><br><span class=\"line\">    */</span><br><span class=\"line\">   final void tryTerminate() &#123;</span><br><span class=\"line\">       for (;;) &#123;</span><br><span class=\"line\">           int c = ctl.get();</span><br><span class=\"line\">           if (isRunning(c) ||</span><br><span class=\"line\">               runStateAtLeast(c, TIDYING) ||</span><br><span class=\"line\">               (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class=\"line\">               return;</span><br><span class=\"line\">           if (workerCountOf(c) != 0) &#123; // Eligible to terminate</span><br><span class=\"line\">               interruptIdleWorkers(ONLY_ONE);</span><br><span class=\"line\">               return;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">           mainLock.lock();</span><br><span class=\"line\">           try &#123;</span><br><span class=\"line\">               if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123;</span><br><span class=\"line\">                   try &#123;</span><br><span class=\"line\">                       terminated();</span><br><span class=\"line\">                   &#125; finally &#123;</span><br><span class=\"line\">                       ctl.set(ctlOf(TERMINATED, 0));</span><br><span class=\"line\">                       termination.signalAll();</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">                   return;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125; finally &#123;</span><br><span class=\"line\">               mainLock.unlock();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           // else retry on failed CAS</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   /**</span><br><span class=\"line\">    * Interrupts threads that might be waiting for tasks (as</span><br><span class=\"line\">    * indicated by not being locked) so they can check for</span><br><span class=\"line\">    * termination or configuration changes. Ignores</span><br><span class=\"line\">    * SecurityExceptions (in which case some threads may remain</span><br><span class=\"line\">    * uninterrupted).</span><br><span class=\"line\">    *</span><br><span class=\"line\">    * @param onlyOne If true, interrupt at most one worker. This is</span><br><span class=\"line\">    * called only from tryTerminate when termination is otherwise</span><br><span class=\"line\">    * enabled but there are still other workers.  In this case, at</span><br><span class=\"line\">    * most one waiting worker is interrupted to propagate shutdown</span><br><span class=\"line\">    * signals in case all threads are currently waiting.</span><br><span class=\"line\">    * Interrupting any arbitrary thread ensures that newly arriving</span><br><span class=\"line\">    * workers since shutdown began will also eventually exit.</span><br><span class=\"line\">    * To guarantee eventual termination, it suffices to always</span><br><span class=\"line\">    * interrupt only one idle worker, but shutdown() interrupts all</span><br><span class=\"line\">    * idle workers so that redundant workers exit promptly, not</span><br><span class=\"line\">    * waiting for a straggler task to finish.</span><br><span class=\"line\">    */</span><br><span class=\"line\">   private void interruptIdleWorkers(boolean onlyOne) &#123;</span><br><span class=\"line\">       final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">           for (Worker w : workers) &#123;</span><br><span class=\"line\">               Thread t = w.thread;</span><br><span class=\"line\">               //中断所有空闲线程，由于在runWorker中，活跃线程上锁了w.lock();，因此此处实现了只会终止空闲线程的效果</span><br><span class=\"line\">               if (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class=\"line\">                   try &#123;</span><br><span class=\"line\">                       t.interrupt();</span><br><span class=\"line\">                   &#125; catch (SecurityException ignore) &#123;</span><br><span class=\"line\">                   &#125; finally &#123;</span><br><span class=\"line\">                       w.unlock();</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               if (onlyOne)</span><br><span class=\"line\">                   break;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure><br> 4、动态调整线程池大小，由于业务需要，很多场景下，需要在运行时动态调整核心线程或最大线程的大小<br> <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/**</span><br><span class=\"line\">    * Sets the core number of threads.  This overrides any value set</span><br><span class=\"line\">    * in the constructor.  If the new value is smaller than the</span><br><span class=\"line\">    * current value, excess existing threads will be terminated when</span><br><span class=\"line\">    * they next become idle.  If larger, new threads will, if needed,</span><br><span class=\"line\">    * be started to execute any queued tasks.</span><br><span class=\"line\">    *</span><br><span class=\"line\">    * @param corePoolSize the new core size</span><br><span class=\"line\">    * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125;</span><br><span class=\"line\">    * @see #getCorePoolSize</span><br><span class=\"line\">    */</span><br><span class=\"line\">   public void setCorePoolSize(int corePoolSize) &#123;</span><br><span class=\"line\">       if (corePoolSize &lt; 0)</span><br><span class=\"line\">           throw new IllegalArgumentException();</span><br><span class=\"line\">       int delta = corePoolSize - this.corePoolSize;</span><br><span class=\"line\">       this.corePoolSize = corePoolSize;</span><br><span class=\"line\">       if (workerCountOf(ctl.get()) &gt; corePoolSize)</span><br><span class=\"line\">       //中断所有空闲线程，由于在runWorker中，活跃线程上锁了，因此此处实现了只会终止空闲线程的效果</span><br><span class=\"line\">           interruptIdleWorkers();</span><br><span class=\"line\">       else if (delta &gt; 0) &#123;</span><br><span class=\"line\">           // We don&#x27;t really know how many new threads are &quot;needed&quot;.</span><br><span class=\"line\">           // As a heuristic, prestart enough new workers (up to new</span><br><span class=\"line\">           // core size) to handle the current number of tasks in</span><br><span class=\"line\">           // queue, but stop if queue becomes empty while doing so.</span><br><span class=\"line\">           int k = Math.min(delta, workQueue.size());</span><br><span class=\"line\">           while (k-- &gt; 0 &amp;&amp; addWorker(null, true)) &#123;</span><br><span class=\"line\">               if (workQueue.isEmpty())</span><br><span class=\"line\">                   break;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":11806,"excerpt":"","more":"<p>本文从spring对于线程池的实现ThreadPoolTaskExecutor入手阐述，由于该实现是对java的ThreadPoolExecutor进行了一次包装（扩展线程池能力），因此文中更多涉及到的是ThreadPoolExecutor关键实现逻辑的原理分析<br><img src=\"/images/pasted-99.png\" alt=\"upload successful\"></p>\n<p><img src=\"/images/pasted-103.png\" alt=\"upload successful\"><br>1、executor = new ThreadPoolTaskExecutor();主要操作：父类CustomizableThreadCreator构造函数初始化，默认threadNamePrefix为实现类名简称-<br>2、excutor参数设置并excutor.initialize();（该方法属于ExecutorConfigurationSupport），其中会调用抽象方法initializeExecutor，由ThreadPoolTaskExecutor实现。<br>该处除了下面要讨论的corePoolSize，maxPollSize，queueCapacity外，想先说一下keepAliveSeconds这个值，代表允许操作核心线程数部分的线程空闲多长时间（s）后shut down，如果初始化时设置了allowCoreThreadTimeOut（true），那么对核心线程数以内的空闲线程也会shut down，避免资源浪费。<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Override</span><br><span class=\"line\">\tprotected ExecutorService initializeExecutor(</span><br><span class=\"line\">\t\t\tThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) &#123;</span><br><span class=\"line\">\t\t//1、创建队列：最大容量&gt;0，创建有界阻塞队列LinkedBlockingQueue；否则创建SynchronousQueue，其内部只有包含一个元素，因此，需要线程池足够大，否则，会出现大量拒绝</span><br><span class=\"line\">\t\tBlockingQueue&lt;Runnable&gt; queue = createQueue(this.queueCapacity);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tThreadPoolExecutor executor;</span><br><span class=\"line\">\t\tif (this.taskDecorator != null) &#123;</span><br><span class=\"line\">\t\t\texecutor = new ThreadPoolExecutor(</span><br><span class=\"line\">\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,</span><br><span class=\"line\">\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler) &#123;</span><br><span class=\"line\">\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\tpublic void execute(Runnable command) &#123;</span><br><span class=\"line\">\t\t\t\t\tsuper.execute(taskDecorator.decorate(command));</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\telse &#123;</span><br><span class=\"line\">\t\t\texecutor = new ThreadPoolExecutor(</span><br><span class=\"line\">\t\t\t\t\tthis.corePoolSize, this.maxPoolSize, this.keepAliveSeconds, TimeUnit.SECONDS,</span><br><span class=\"line\">\t\t\t\t\tqueue, threadFactory, rejectedExecutionHandler);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif (this.allowCoreThreadTimeOut) &#123;</span><br><span class=\"line\">\t\t\texecutor.allowCoreThreadTimeOut(true);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//2、创建java线程池ThreadPoolExcutor，即，ThreadPoolTaskExetor是对java线程池的包装</span><br><span class=\"line\">\t\tthis.threadPoolExecutor = executor;</span><br><span class=\"line\">\t\treturn executor;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure><br>3、executor.execute(runnable);<br>通过源码分析，线程池中线程的初始化是在执行阶段根据实际情况初始化的，如果活跃线程小于核心线程则新开线程(及时由线程是空闲的)，否则尝试将任务压入队列等待执行，如果队列压满则尝试根据最大线程数控制来新开线程（小于最大线程数时可新开线程）。java也提供了预分配核心线程的方法，支持提前创建核心线程，prestartCoreThread。<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void execute(Runnable command) &#123;</span><br><span class=\"line\">if (command == null)</span><br><span class=\"line\">            throw new NullPointerException();</span><br><span class=\"line\">        /*</span><br><span class=\"line\">         * Proceed in 3 steps:</span><br><span class=\"line\">         *</span><br><span class=\"line\">         * 1. If fewer than corePoolSize threads are running, try to</span><br><span class=\"line\">         * start a new thread with the given command as its first</span><br><span class=\"line\">         * task.  The call to addWorker atomically checks runState and</span><br><span class=\"line\">         * workerCount, and so prevents false alarms that would add</span><br><span class=\"line\">         * threads when it shouldn&#x27;t, by returning false.</span><br><span class=\"line\">         *</span><br><span class=\"line\">         * 2. If a task can be successfully queued, then we still need</span><br><span class=\"line\">         * to double-check whether we should have added a thread</span><br><span class=\"line\">         * (because existing ones died since last checking) or that</span><br><span class=\"line\">         * the pool shut down since entry into this method. So we</span><br><span class=\"line\">         * recheck state and if necessary roll back the enqueuing if</span><br><span class=\"line\">         * stopped, or start a new thread if there are none.</span><br><span class=\"line\">         *</span><br><span class=\"line\">         * 3. If we cannot queue task, then we try to add a new</span><br><span class=\"line\">         * thread.  If it fails, we know we are shut down or saturated</span><br><span class=\"line\">         * and so reject the task.</span><br><span class=\"line\">         */</span><br><span class=\"line\">        int c = ctl.get();</span><br><span class=\"line\">        if (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class=\"line\">            if (addWorker(command, true))</span><br><span class=\"line\">                return;//1、如果work数量小于核心线程大小，则新增work并把该任务委派给此work</span><br><span class=\"line\">            c = ctl.get();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //2、如果work数量大于等于核心线程大小，同时活动中的线程小于被shutdown的线程（代表相对空闲），同时队列未满，则把该任务压入队列中</span><br><span class=\"line\">        if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class=\"line\">            int recheck = ctl.get();</span><br><span class=\"line\">            if (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class=\"line\">                reject(command);</span><br><span class=\"line\">            else if (workerCountOf(recheck) == 0)</span><br><span class=\"line\">                addWorker(null, false);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //3、如果活动中的线程大于被shutdown的线程（代表相对繁忙）或者队列已满，则新增work并把该任务委派给此work，数量受maxPoolSize控制</span><br><span class=\"line\">        else if (!addWorker(command, false))</span><br><span class=\"line\">            reject(command);</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure><br> addWorker(Runnable firstTask, boolean core){};<br> 该方法用于创建work并执行初始化任务或者队列中的任务。<br> <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private boolean addWorker(Runnable firstTask, boolean core) &#123;</span><br><span class=\"line\">       retry:</span><br><span class=\"line\">       for (;;) &#123;</span><br><span class=\"line\">           int c = ctl.get();</span><br><span class=\"line\">           int rs = runStateOf(c);//</span><br><span class=\"line\"></span><br><span class=\"line\">           // Check if queue empty only if necessary.</span><br><span class=\"line\">           if (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class=\"line\">               ! (rs == SHUTDOWN &amp;&amp;</span><br><span class=\"line\">                  firstTask == null &amp;&amp;</span><br><span class=\"line\">                  ! workQueue.isEmpty()))</span><br><span class=\"line\">               return false;</span><br><span class=\"line\"></span><br><span class=\"line\">           for (;;) &#123;</span><br><span class=\"line\">               int wc = workerCountOf(c);</span><br><span class=\"line\">               if (wc &gt;= CAPACITY ||</span><br><span class=\"line\">                   wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class=\"line\">                   return false;</span><br><span class=\"line\">               if (compareAndIncrementWorkerCount(c))</span><br><span class=\"line\">                   break retry;</span><br><span class=\"line\">               c = ctl.get();  // Re-read ctl</span><br><span class=\"line\">               if (runStateOf(c) != rs)</span><br><span class=\"line\">                   continue retry;</span><br><span class=\"line\">               // else CAS failed due to workerCount change; retry inner loop</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       boolean workerStarted = false;</span><br><span class=\"line\">       boolean workerAdded = false;</span><br><span class=\"line\">       Worker w = null;</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">           w = new Worker(firstTask);</span><br><span class=\"line\">           final Thread t = w.thread;</span><br><span class=\"line\">           if (t != null) &#123;</span><br><span class=\"line\">               final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">               mainLock.lock();</span><br><span class=\"line\">               try &#123;</span><br><span class=\"line\">                   // Recheck while holding lock.</span><br><span class=\"line\">                   // Back out on ThreadFactory failure or if</span><br><span class=\"line\">                   // shut down before lock acquired.</span><br><span class=\"line\">                   int rs = runStateOf(ctl.get());</span><br><span class=\"line\"></span><br><span class=\"line\">                   if (rs &lt; SHUTDOWN ||</span><br><span class=\"line\">                       (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123;</span><br><span class=\"line\">                       if (t.isAlive()) // precheck that t is startable</span><br><span class=\"line\">                           throw new IllegalThreadStateException();</span><br><span class=\"line\">                       workers.add(w);</span><br><span class=\"line\">                       int s = workers.size();</span><br><span class=\"line\">                       if (s &gt; largestPoolSize)</span><br><span class=\"line\">                           largestPoolSize = s;</span><br><span class=\"line\">                       workerAdded = true;</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125; finally &#123;</span><br><span class=\"line\">                   mainLock.unlock();</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               if (workerAdded) &#123;</span><br><span class=\"line\">               //使用新建的work执行任务</span><br><span class=\"line\">                   t.start();</span><br><span class=\"line\">                   workerStarted = true;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           if (! workerStarted)</span><br><span class=\"line\">               addWorkerFailed(w);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       return workerStarted;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   final void runWorker(Worker w) &#123;</span><br><span class=\"line\">       Thread wt = Thread.currentThread();</span><br><span class=\"line\">       Runnable task = w.firstTask;</span><br><span class=\"line\">       w.firstTask = null;</span><br><span class=\"line\">       w.unlock(); // allow interrupts</span><br><span class=\"line\">       boolean completedAbruptly = true;</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">       //执行当前任务或者从队列中获取任务执行</span><br><span class=\"line\">           while (task != null || (task = getTask()) != null) &#123;</span><br><span class=\"line\">               w.lock();</span><br><span class=\"line\">               // If pool is stopping, ensure thread is interrupted;</span><br><span class=\"line\">               // if not, ensure thread is not interrupted.  This</span><br><span class=\"line\">               // requires a recheck in second case to deal with</span><br><span class=\"line\">               // shutdownNow race while clearing interrupt</span><br><span class=\"line\">               if ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class=\"line\">                    (Thread.interrupted() &amp;&amp;</span><br><span class=\"line\">                     runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class=\"line\">                   !wt.isInterrupted())</span><br><span class=\"line\">                   wt.interrupt();</span><br><span class=\"line\">               try &#123;</span><br><span class=\"line\">                   beforeExecute(wt, task);</span><br><span class=\"line\">                   Throwable thrown = null;</span><br><span class=\"line\">                   try &#123;</span><br><span class=\"line\">                       task.run();</span><br><span class=\"line\">                   &#125; catch (RuntimeException x) &#123;</span><br><span class=\"line\">                       thrown = x; throw x;</span><br><span class=\"line\">                   &#125; catch (Error x) &#123;</span><br><span class=\"line\">                       thrown = x; throw x;</span><br><span class=\"line\">                   &#125; catch (Throwable x) &#123;</span><br><span class=\"line\">                       thrown = x; throw new Error(x);</span><br><span class=\"line\">                   &#125; finally &#123;</span><br><span class=\"line\">                       afterExecute(task, thrown);</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125; finally &#123;</span><br><span class=\"line\">                   task = null;</span><br><span class=\"line\">                   w.completedTasks++;</span><br><span class=\"line\">                   w.unlock();</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           completedAbruptly = false;</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           processWorkerExit(w, completedAbruptly);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   /**</span><br><span class=\"line\">    * Performs blocking or timed wait for a task, depending on</span><br><span class=\"line\">    * current configuration settings, or returns null if this worker</span><br><span class=\"line\">    * must exit because of any of:</span><br><span class=\"line\">    * 1. There are more than maximumPoolSize workers (due to</span><br><span class=\"line\">    *    a call to setMaximumPoolSize).</span><br><span class=\"line\">    * 2. The pool is stopped.</span><br><span class=\"line\">    * 3. The pool is shutdown and the queue is empty.</span><br><span class=\"line\">    * 4. This worker timed out waiting for a task, and timed-out</span><br><span class=\"line\">    *    workers are subject to termination (that is,</span><br><span class=\"line\">    *    &#123;@code allowCoreThreadTimeOut || workerCount &gt; corePoolSize&#125;)</span><br><span class=\"line\">    *    both before and after the timed wait, and if the queue is</span><br><span class=\"line\">    *    non-empty, this worker is not the last thread in the pool.</span><br><span class=\"line\">    *</span><br><span class=\"line\">    * @return task, or null if the worker must exit, in which case</span><br><span class=\"line\">    *         workerCount is decremented</span><br><span class=\"line\">    */</span><br><span class=\"line\">   private Runnable getTask() &#123;</span><br><span class=\"line\">       boolean timedOut = false; // Did the last poll() time out?</span><br><span class=\"line\"></span><br><span class=\"line\">       for (;;) &#123;</span><br><span class=\"line\">           int c = ctl.get();</span><br><span class=\"line\">           int rs = runStateOf(c);</span><br><span class=\"line\"></span><br><span class=\"line\">           // Check if queue empty only if necessary.</span><br><span class=\"line\">           if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class=\"line\">               decrementWorkerCount();</span><br><span class=\"line\">               return null;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           int wc = workerCountOf(c);</span><br><span class=\"line\"></span><br><span class=\"line\">           // Are workers subject to culling?</span><br><span class=\"line\">           boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class=\"line\"></span><br><span class=\"line\">           if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class=\"line\">               &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123;</span><br><span class=\"line\">               if (compareAndDecrementWorkerCount(c))</span><br><span class=\"line\">                   return null;</span><br><span class=\"line\">               continue;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           try &#123;</span><br><span class=\"line\">           //poll()为非阻塞方法,如果当前队列为空,超时候，直接返回，超时返回时，返回的为null，此时会在runWorker后续方法中调用processWorkerExit，从而实现了对超过数量（大于核心线程，或者允许核心线程超时后回收）的线程超时后回收</span><br><span class=\"line\">           //take()为阻塞方法,如果当前队列为空,则阻塞线程,封装线程到AQS的条件变量的条件队列中</span><br><span class=\"line\">               Runnable r = timed ?</span><br><span class=\"line\">                   workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class=\"line\">                   workQueue.take();</span><br><span class=\"line\">               if (r != null)</span><br><span class=\"line\">                   return r;</span><br><span class=\"line\">               timedOut = true;</span><br><span class=\"line\">           &#125; catch (InterruptedException retry) &#123;</span><br><span class=\"line\">               timedOut = false;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   private void processWorkerExit(Worker w, boolean completedAbruptly) &#123;</span><br><span class=\"line\">       if (completedAbruptly) // If abrupt, then workerCount wasn&#x27;t adjusted</span><br><span class=\"line\">           decrementWorkerCount();</span><br><span class=\"line\"></span><br><span class=\"line\">       final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">           completedTaskCount += w.completedTasks;</span><br><span class=\"line\">           //当前任务及队列中的任务执行完成后，移除当前work</span><br><span class=\"line\">           workers.remove(w);</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       tryTerminate();</span><br><span class=\"line\"></span><br><span class=\"line\">       int c = ctl.get();</span><br><span class=\"line\">       if (runStateLessThan(c, STOP)) &#123;</span><br><span class=\"line\">           if (!completedAbruptly) &#123;</span><br><span class=\"line\">               int min = allowCoreThreadTimeOut ? 0 : corePoolSize;</span><br><span class=\"line\">               if (min == 0 &amp;&amp; ! workQueue.isEmpty())</span><br><span class=\"line\">                   min = 1;</span><br><span class=\"line\">               if (workerCountOf(c) &gt;= min)</span><br><span class=\"line\">                   return; // replacement not needed</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           //如果剩余wrok数量小于核心线程大小（注意，如果设置了allowCoreThreadTimeOut，那么线程池不会保持最低核心线程数个线程），新建work</span><br><span class=\"line\">           addWorker(null, false);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   /**</span><br><span class=\"line\">    * Transitions to TERMINATED state if either (SHUTDOWN and pool</span><br><span class=\"line\">    * and queue empty) or (STOP and pool empty).  If otherwise</span><br><span class=\"line\">    * eligible to terminate but workerCount is nonzero, interrupts an</span><br><span class=\"line\">    * idle worker to ensure that shutdown signals propagate. This</span><br><span class=\"line\">    * method must be called following any action that might make</span><br><span class=\"line\">    * termination possible -- reducing worker count or removing tasks</span><br><span class=\"line\">    * from the queue during shutdown. The method is non-private to</span><br><span class=\"line\">    * allow access from ScheduledThreadPoolExecutor.</span><br><span class=\"line\">    */</span><br><span class=\"line\">   final void tryTerminate() &#123;</span><br><span class=\"line\">       for (;;) &#123;</span><br><span class=\"line\">           int c = ctl.get();</span><br><span class=\"line\">           if (isRunning(c) ||</span><br><span class=\"line\">               runStateAtLeast(c, TIDYING) ||</span><br><span class=\"line\">               (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class=\"line\">               return;</span><br><span class=\"line\">           if (workerCountOf(c) != 0) &#123; // Eligible to terminate</span><br><span class=\"line\">               interruptIdleWorkers(ONLY_ONE);</span><br><span class=\"line\">               return;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">           mainLock.lock();</span><br><span class=\"line\">           try &#123;</span><br><span class=\"line\">               if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123;</span><br><span class=\"line\">                   try &#123;</span><br><span class=\"line\">                       terminated();</span><br><span class=\"line\">                   &#125; finally &#123;</span><br><span class=\"line\">                       ctl.set(ctlOf(TERMINATED, 0));</span><br><span class=\"line\">                       termination.signalAll();</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">                   return;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125; finally &#123;</span><br><span class=\"line\">               mainLock.unlock();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           // else retry on failed CAS</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   /**</span><br><span class=\"line\">    * Interrupts threads that might be waiting for tasks (as</span><br><span class=\"line\">    * indicated by not being locked) so they can check for</span><br><span class=\"line\">    * termination or configuration changes. Ignores</span><br><span class=\"line\">    * SecurityExceptions (in which case some threads may remain</span><br><span class=\"line\">    * uninterrupted).</span><br><span class=\"line\">    *</span><br><span class=\"line\">    * @param onlyOne If true, interrupt at most one worker. This is</span><br><span class=\"line\">    * called only from tryTerminate when termination is otherwise</span><br><span class=\"line\">    * enabled but there are still other workers.  In this case, at</span><br><span class=\"line\">    * most one waiting worker is interrupted to propagate shutdown</span><br><span class=\"line\">    * signals in case all threads are currently waiting.</span><br><span class=\"line\">    * Interrupting any arbitrary thread ensures that newly arriving</span><br><span class=\"line\">    * workers since shutdown began will also eventually exit.</span><br><span class=\"line\">    * To guarantee eventual termination, it suffices to always</span><br><span class=\"line\">    * interrupt only one idle worker, but shutdown() interrupts all</span><br><span class=\"line\">    * idle workers so that redundant workers exit promptly, not</span><br><span class=\"line\">    * waiting for a straggler task to finish.</span><br><span class=\"line\">    */</span><br><span class=\"line\">   private void interruptIdleWorkers(boolean onlyOne) &#123;</span><br><span class=\"line\">       final ReentrantLock mainLock = this.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       try &#123;</span><br><span class=\"line\">           for (Worker w : workers) &#123;</span><br><span class=\"line\">               Thread t = w.thread;</span><br><span class=\"line\">               //中断所有空闲线程，由于在runWorker中，活跃线程上锁了w.lock();，因此此处实现了只会终止空闲线程的效果</span><br><span class=\"line\">               if (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class=\"line\">                   try &#123;</span><br><span class=\"line\">                       t.interrupt();</span><br><span class=\"line\">                   &#125; catch (SecurityException ignore) &#123;</span><br><span class=\"line\">                   &#125; finally &#123;</span><br><span class=\"line\">                       w.unlock();</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               if (onlyOne)</span><br><span class=\"line\">                   break;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125; finally &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure><br> 4、动态调整线程池大小，由于业务需要，很多场景下，需要在运行时动态调整核心线程或最大线程的大小<br> <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/**</span><br><span class=\"line\">    * Sets the core number of threads.  This overrides any value set</span><br><span class=\"line\">    * in the constructor.  If the new value is smaller than the</span><br><span class=\"line\">    * current value, excess existing threads will be terminated when</span><br><span class=\"line\">    * they next become idle.  If larger, new threads will, if needed,</span><br><span class=\"line\">    * be started to execute any queued tasks.</span><br><span class=\"line\">    *</span><br><span class=\"line\">    * @param corePoolSize the new core size</span><br><span class=\"line\">    * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125;</span><br><span class=\"line\">    * @see #getCorePoolSize</span><br><span class=\"line\">    */</span><br><span class=\"line\">   public void setCorePoolSize(int corePoolSize) &#123;</span><br><span class=\"line\">       if (corePoolSize &lt; 0)</span><br><span class=\"line\">           throw new IllegalArgumentException();</span><br><span class=\"line\">       int delta = corePoolSize - this.corePoolSize;</span><br><span class=\"line\">       this.corePoolSize = corePoolSize;</span><br><span class=\"line\">       if (workerCountOf(ctl.get()) &gt; corePoolSize)</span><br><span class=\"line\">       //中断所有空闲线程，由于在runWorker中，活跃线程上锁了，因此此处实现了只会终止空闲线程的效果</span><br><span class=\"line\">           interruptIdleWorkers();</span><br><span class=\"line\">       else if (delta &gt; 0) &#123;</span><br><span class=\"line\">           // We don&#x27;t really know how many new threads are &quot;needed&quot;.</span><br><span class=\"line\">           // As a heuristic, prestart enough new workers (up to new</span><br><span class=\"line\">           // core size) to handle the current number of tasks in</span><br><span class=\"line\">           // queue, but stop if queue becomes empty while doing so.</span><br><span class=\"line\">           int k = Math.min(delta, workQueue.size());</span><br><span class=\"line\">           while (k-- &gt; 0 &amp;&amp; addWorker(null, true)) &#123;</span><br><span class=\"line\">               if (workQueue.isEmpty())</span><br><span class=\"line\">                   break;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"数据库-kill服务进程引发的血案","author":"Xiang Chuang","date":"2018-07-30T03:01:00.000Z","_content":"1、问题描述：\n18.07.27， 10：50分dba进行mysql数据库碎片整理，11：04分，发现数据库连接爆满，此时应用已处于down掉的状态，11：22数据库强行kill，11：40分之前发现应用并没有进行新的连接，此时停止应用发现停不下来，不得不kill掉应用进程，重启后恢复。但此时发现，之前入库的记录并没有成功，而mq由于没有收到应用的ack确认消息，消息重新进入队列并重发，加上数据没入库，交易进行了重复的操作！由于是全名抢车业务，导致重复上账，重复充退。\n\n2、问题分析\n由于没有及时的dump保护现场，加上应用down掉后，日志少的可怜，只有一些Broken pipe，以及该getOuptStream()异常，后期只能从代码层面分析。\n\n3、分析\njdbc sockeTimeout时间并没有设置，所以默认使用的mysql的或者操作系统本身的socketTimeout 该问题会引发类似问题\n\n相关文档:\nhttp://www.sohu.com/a/142039227_505885\nhttp://www.sohu.com/a/141155649_539864?qq-pf-to=pcqq.c2c \nhttps://blog.csdn.net/lx348321409/article/details/76095751 \nhttps://segmentfault.com/a/1190000012944562\nhttps://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration\n\n=====================================================\njdbc timeout类别\n\n主要有如下几个类别\n\n![upload successful](\\images\\pasted-16.png)\ntransaction timeout\n设置的是一个事务的执行时间，里头可能包含多个statement\nstatement timeout(也相当于result set fetch timeout)\n设置的是一个statement的执行超时时间，即driver等待statement执行完成，接收到数据的超时时间(注意statement的timeout不是整个查询的timeout，只是statement执行完成并拉取fetchSize数据返回的超时，之后resultSet的next在必要的时候还会触发fetch数据，每次fetch的超时时间是单独算的，默认也是以statement设置的timeout为准)\njdbc socket timeout\n设置的是jdbc I/O socket read and write operations的超时时间，防止因网络问题或数据库问题，导致driver一直阻塞等待。(建议比statement timeout的时间长)\nos socket timeout\n这个是操作系统级别的socket设置(如果jdbc socket timeout没有设置，而os级别的socket timeout有设置，则使用系统的socket timeout值)。\n上面的不同级别的timeout越往下优先级越高，也就是说如果下面的配置比上面的配置值小的话，则会优先触发timeout，那么相当于上面的配置值就\"失效\"了。\njdbc socket timeout\n\n这个不同数据的jdbc driver实现不一样\nmysql\n\njdbc:mysql://localhost:3306/ag_admin?useUnicode=true&amp;characterEncoding=UTF8&connectTimeout=60000&socketTimeout=60000\n通过url参数传递即可\npg\n\njdbc:postgresql://localhost/test?user=fred&password=secret&&connectTimeout=60&socketTimeout=60\npg也是通过url传递，不过它的单位与mysql不同，mysql是毫秒，而pg是秒\noracle\n\noracle需要通过oracle.jdbc.ReadTimeout参数来设置，连接超时参数是oracle.net.CONNECT_TIMEOUT\n通过properties设置\n            Class.forName(\"oracle.jdbc.driver.OracleDriver\");\n            Properties props = new Properties() ;\n            props.put( \"user\" , \"test_schema\") ;\n            props.put( \"password\" , \"pwd\") ;\n            props.put( \"oracle.net.CONNECT_TIMEOUT\" , \"10000000\") ;\n            props.put( \"oracle.jdbc.ReadTimeout\" , \"2000\" ) ;\n            Connection conn = DriverManager.getConnection( \"jdbc:oracle:thin:@10.0.1.9:1521:orcl\" , props ) ;\n通过环境变量设置\nString readTimeout = \"10000\"; // ms\nSystem.setProperty(\"oracle.jdbc.ReadTimeout\", readTimeout);\nClass.forName(\"oracle.jdbc.OracleDriver\");\nConnection conn = DriverManager.getConnection(jdbcUrl, user, pwd);\n注意需要在connection连接之前设置环境变量\ntomcat jdbc pool\n一般我们不直接使用jdbc connection，而是使用连接池。由于tomcat jdbc pool是springboot默认使用的数据库连接池，这里就讲述一下如何在tomcat jdbc pool下设置。\nspring.datasource.tomcat.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000\n注意，这里是分号分隔，单位是毫秒，这里可以根据各自的情况配置前缀(tomcat jdbc连接池的话，默认是spring.datasource.tomcat)，可以自定义，比如\n@Bean@Qualifier(\"writeDataSource\")\n    @ConfigurationProperties(prefix = \"spring.datasource.write\")\n    public DataSource writeDataSource() {\n        returnDataSourceBuilder.create().build();\n    }\n假设你这里是自定义了prefix为spring.datasource.write，那么上述配置就变为\nspring.datasource.write.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000\noracle.jdbc.ReadTimeout如果没有设置的话，driver里头默认是0\noracle.jdbc.ReadTimeout\n\ndriver内部将该值设置到oracle.net.READ_TIMEOUT变量上\noracle.net.nt.TcpNTAdapter\n    @Override\n    publicvoid setReadTimeoutIfRequired(final Properties properties) throws IOException, NetException {\n        String s = ((Hashtable<K, String>)properties).get(\"oracle.net.READ_TIMEOUT\");\n        if (s == null) {\n            s = \"0\";\n        }\n        this.setOption(3, s);\n    }\n    \n    publicvoid setOption(int var1, Object var2) throws IOException, NetException {\n        String var3;\n        switch(var1) {\n        case0:\n            var3 = (String)var2;\n            this.socket.setTcpNoDelay(var3.equals(\"YES\"));\n            break;\n        case1:\n            var3 = (String)var2;\n            if(var3.equals(\"YES\")) {\n                this.socket.setKeepAlive(true);\n            }\n        case2:\n        default:\n            break;\n        case3:\n            this.sockTimeout = Integer.parseInt((String)var2);\n            this.socket.setSoTimeout(this.sockTimeout);\n        }\n\n    }\n可用看到最后设置的是socket的soTimeout\n实例\n\n    @Test\n    publicvoid testReadTimeout() throws SQLException {\n        Connection connection = dataSource.getConnection();\n        String sql = \"select * from demo_table\";\n        PreparedStatement pstmt;\n        try {\n            pstmt = (PreparedStatement)connection.prepareStatement(sql);\n            ResultSet rs = pstmt.executeQuery();\n            int col = rs.getMetaData().getColumnCount();\n            System.out.println(\"============================\");\n            while (rs.next()) {\n                for (int i = 1; i <= col; i++) {\n                    System.out.print(rs.getObject(i));\n                }\n                System.out.println(\"\");\n            }\n            System.out.println(\"============================\");\n        } catch (SQLException e) {\n            e.printStackTrace();\n        } finally {\n            //close resources\n        }\n    }\n超时错误输出\n//部分数据输出......\njava.sql.SQLRecoverableException: IO 错误: Socket read timed out\n    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1128)\n    at oracle.jdbc.driver.OracleResultSetImpl.close_or_fetch_from_next(OracleResultSetImpl.java:373)\n    at oracle.jdbc.driver.OracleResultSetImpl.next(OracleResultSetImpl.java:277)\n    at com.example.demo.DemoApplicationTests.testReadTimeout(DemoApplicationTests.java:68)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:497)\n    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n    at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)\n    at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)\n    at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)\n    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\n    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:252)\n    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:94)\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n    at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)\n    at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:191)\n    at org.junit.runner.JUnitCore.run(JUnitCore.java:137)\n    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)\n    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234)\n    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:497)\n    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)\nCaused by: oracle.net.ns.NetException: Socket read timed out\n    at oracle.net.ns.Packet.receive(Packet.java:339)\n    at oracle.net.ns.DataPacket.receive(DataPacket.java:106)\n    at oracle.net.ns.NetInputStream.getNextPacket(NetInputStream.java:315)\n    at oracle.net.ns.NetInputStream.read(NetInputStream.java:260)\n    at oracle.net.ns.NetInputStream.read(NetInputStream.java:185)\n    at oracle.net.ns.NetInputStream.read(NetInputStream.java:102)\n    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.readNextPacket(T4CSocketInputStreamWrapper.java:124)\n    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.read(T4CSocketInputStreamWrapper.java:80)\n    at oracle.jdbc.driver.T4CMAREngine.unmarshalUB1(T4CMAREngine.java:1137)\n    at oracle.jdbc.driver.T4CTTIfun.receive(T4CTTIfun.java:290)\n    at oracle.jdbc.driver.T4CTTIfun.doRPC(T4CTTIfun.java:192)\n    at oracle.jdbc.driver.T4C8Oall.doOALL(T4C8Oall.java:531)\n    at oracle.jdbc.driver.T4CPreparedStatement.doOall8(T4CPreparedStatement.java:207)\n    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1119)\n    ... 35 more\n刚开始会有数据输出，但是到了某个resultSet的next的时候，报了超时(close_or_fetch_from_next)，这个超时指定的是当result.next方法触发新的一批数据的拉取(当一个fetchSize的数据消费完之后，接下来的next会触发新一批数据的fetch)之后在timeout时间返回内没有收到数据库返回的数据。\noracle的jdbc默认的fetchSize为10，也就是每个fetch，如果超过指定时间没接收到数据，则抛出timeout异常。\n小结\n\njdbc的socketTimeout值的设置要非常小心，不同数据库的jdbc driver设置不一样，特别是使用不同连接池的话，设置也可能不尽相同。对于严重依赖数据库操作的服务来说，非常有必要设置这个值，否则万一网络或数据库异常，会导致服务线程一直阻塞在java.net.SocketInputStream.socketRead0。\n如果查询数据多，则会导致该线程持有的data list不能释放，相当于内存泄露，最后导致OOM\n如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504 Gateway Timeout\n=====================================================\n\n附：错误日志\norg.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:393)\n        at org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:426)\n        at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:342)\n        at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:317)\n        at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:110)\n        at org.springframework.session.web.http.OnCommittedResponseWrapper$SaveContextServletOutputStream.flush(OnCommittedResponseWrapper.java:437)\n        at com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter.write(FastJsonHttpMessageConverter.java:216)\n        at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:183)\n        at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:81)\n        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:126)\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:832)\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:743)\n        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:961)\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:120)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yiji.boot.web.common.ResponseHeaderFilter.doFilterInternal(ResponseHeaderFilter.java:62)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yiji.boot.actuator.acl.ActuatorACLFilter.doFilter(ActuatorACLFilter.java:36)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n        at org.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:676)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:522)\n        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1095)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:672)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1502)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1458)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.IOException: Broken pipe\n        at sun.nio.ch.FileDispatcherImpl.write0(Native Method)\n        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)\n        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)\n        at sun.nio.ch.IOUtil.write(IOUtil.java:65)\n        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:471)\n        at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:124)\n        at org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)\n        at org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:172)\n        at org.apache.coyote.http11.InternalNioOutputBuffer.writeToSocket(InternalNioOutputBuffer.java:139)\n        at org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:197)\n        at org.apache.coyote.http11.InternalNioOutputBuffer.access$000(InternalNioOutputBuffer.java:41)\n        at org.apache.coyote.http11.InternalNioOutputBuffer$SocketOutputBuffer.doWrite(InternalNioOutputBuffer.java:320)\n        at org.apache.coyote.http11.filters.ChunkedOutputFilter.doWrite(ChunkedOutputFilter.java:116)\n        at org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:256)\n        at org.apache.coyote.Response.doWrite(Response.java:501)\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:388)\n        ... 63 common frames omitted\n\n\n\n2018-07-27 11:04:24.377 ERROR [http-nio-8313-exec-12] [dispatcherServlet]-- Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: getOutputStream() has already been called for this response] with root cause\njava.lang.IllegalStateException: getOutputStream() has already been called for this response\n        at org.apache.catalina.connector.Response.getWriter(Response.java:564)\n        at org.apache.catalina.connector.ResponseFacade.getWriter(ResponseFacade.java:212)\n        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)\n        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)\n        at org.springframework.session.web.http.OnCommittedResponseWrapper.getWriter(OnCommittedResponseWrapper.java:133)\n        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)\n        at org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration$SpelView.render(ErrorMvcAutoConfiguration.java:195)\n        at org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1246)\n        at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1029)\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:973)\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:92)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)","source":"_posts/数据库-kill服务进程引发的血案.md","raw":"title: 数据库-kill服务进程引发的血案\nauthor: Xiang Chuang\ntags:\n  - db\ncategories:\n  - 这些年，那些坑\ndate: 2018-07-30 11:01:00\n---\n1、问题描述：\n18.07.27， 10：50分dba进行mysql数据库碎片整理，11：04分，发现数据库连接爆满，此时应用已处于down掉的状态，11：22数据库强行kill，11：40分之前发现应用并没有进行新的连接，此时停止应用发现停不下来，不得不kill掉应用进程，重启后恢复。但此时发现，之前入库的记录并没有成功，而mq由于没有收到应用的ack确认消息，消息重新进入队列并重发，加上数据没入库，交易进行了重复的操作！由于是全名抢车业务，导致重复上账，重复充退。\n\n2、问题分析\n由于没有及时的dump保护现场，加上应用down掉后，日志少的可怜，只有一些Broken pipe，以及该getOuptStream()异常，后期只能从代码层面分析。\n\n3、分析\njdbc sockeTimeout时间并没有设置，所以默认使用的mysql的或者操作系统本身的socketTimeout 该问题会引发类似问题\n\n相关文档:\nhttp://www.sohu.com/a/142039227_505885\nhttp://www.sohu.com/a/141155649_539864?qq-pf-to=pcqq.c2c \nhttps://blog.csdn.net/lx348321409/article/details/76095751 \nhttps://segmentfault.com/a/1190000012944562\nhttps://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration\n\n=====================================================\njdbc timeout类别\n\n主要有如下几个类别\n\n![upload successful](\\images\\pasted-16.png)\ntransaction timeout\n设置的是一个事务的执行时间，里头可能包含多个statement\nstatement timeout(也相当于result set fetch timeout)\n设置的是一个statement的执行超时时间，即driver等待statement执行完成，接收到数据的超时时间(注意statement的timeout不是整个查询的timeout，只是statement执行完成并拉取fetchSize数据返回的超时，之后resultSet的next在必要的时候还会触发fetch数据，每次fetch的超时时间是单独算的，默认也是以statement设置的timeout为准)\njdbc socket timeout\n设置的是jdbc I/O socket read and write operations的超时时间，防止因网络问题或数据库问题，导致driver一直阻塞等待。(建议比statement timeout的时间长)\nos socket timeout\n这个是操作系统级别的socket设置(如果jdbc socket timeout没有设置，而os级别的socket timeout有设置，则使用系统的socket timeout值)。\n上面的不同级别的timeout越往下优先级越高，也就是说如果下面的配置比上面的配置值小的话，则会优先触发timeout，那么相当于上面的配置值就\"失效\"了。\njdbc socket timeout\n\n这个不同数据的jdbc driver实现不一样\nmysql\n\njdbc:mysql://localhost:3306/ag_admin?useUnicode=true&amp;characterEncoding=UTF8&connectTimeout=60000&socketTimeout=60000\n通过url参数传递即可\npg\n\njdbc:postgresql://localhost/test?user=fred&password=secret&&connectTimeout=60&socketTimeout=60\npg也是通过url传递，不过它的单位与mysql不同，mysql是毫秒，而pg是秒\noracle\n\noracle需要通过oracle.jdbc.ReadTimeout参数来设置，连接超时参数是oracle.net.CONNECT_TIMEOUT\n通过properties设置\n            Class.forName(\"oracle.jdbc.driver.OracleDriver\");\n            Properties props = new Properties() ;\n            props.put( \"user\" , \"test_schema\") ;\n            props.put( \"password\" , \"pwd\") ;\n            props.put( \"oracle.net.CONNECT_TIMEOUT\" , \"10000000\") ;\n            props.put( \"oracle.jdbc.ReadTimeout\" , \"2000\" ) ;\n            Connection conn = DriverManager.getConnection( \"jdbc:oracle:thin:@10.0.1.9:1521:orcl\" , props ) ;\n通过环境变量设置\nString readTimeout = \"10000\"; // ms\nSystem.setProperty(\"oracle.jdbc.ReadTimeout\", readTimeout);\nClass.forName(\"oracle.jdbc.OracleDriver\");\nConnection conn = DriverManager.getConnection(jdbcUrl, user, pwd);\n注意需要在connection连接之前设置环境变量\ntomcat jdbc pool\n一般我们不直接使用jdbc connection，而是使用连接池。由于tomcat jdbc pool是springboot默认使用的数据库连接池，这里就讲述一下如何在tomcat jdbc pool下设置。\nspring.datasource.tomcat.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000\n注意，这里是分号分隔，单位是毫秒，这里可以根据各自的情况配置前缀(tomcat jdbc连接池的话，默认是spring.datasource.tomcat)，可以自定义，比如\n@Bean@Qualifier(\"writeDataSource\")\n    @ConfigurationProperties(prefix = \"spring.datasource.write\")\n    public DataSource writeDataSource() {\n        returnDataSourceBuilder.create().build();\n    }\n假设你这里是自定义了prefix为spring.datasource.write，那么上述配置就变为\nspring.datasource.write.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000\noracle.jdbc.ReadTimeout如果没有设置的话，driver里头默认是0\noracle.jdbc.ReadTimeout\n\ndriver内部将该值设置到oracle.net.READ_TIMEOUT变量上\noracle.net.nt.TcpNTAdapter\n    @Override\n    publicvoid setReadTimeoutIfRequired(final Properties properties) throws IOException, NetException {\n        String s = ((Hashtable<K, String>)properties).get(\"oracle.net.READ_TIMEOUT\");\n        if (s == null) {\n            s = \"0\";\n        }\n        this.setOption(3, s);\n    }\n    \n    publicvoid setOption(int var1, Object var2) throws IOException, NetException {\n        String var3;\n        switch(var1) {\n        case0:\n            var3 = (String)var2;\n            this.socket.setTcpNoDelay(var3.equals(\"YES\"));\n            break;\n        case1:\n            var3 = (String)var2;\n            if(var3.equals(\"YES\")) {\n                this.socket.setKeepAlive(true);\n            }\n        case2:\n        default:\n            break;\n        case3:\n            this.sockTimeout = Integer.parseInt((String)var2);\n            this.socket.setSoTimeout(this.sockTimeout);\n        }\n\n    }\n可用看到最后设置的是socket的soTimeout\n实例\n\n    @Test\n    publicvoid testReadTimeout() throws SQLException {\n        Connection connection = dataSource.getConnection();\n        String sql = \"select * from demo_table\";\n        PreparedStatement pstmt;\n        try {\n            pstmt = (PreparedStatement)connection.prepareStatement(sql);\n            ResultSet rs = pstmt.executeQuery();\n            int col = rs.getMetaData().getColumnCount();\n            System.out.println(\"============================\");\n            while (rs.next()) {\n                for (int i = 1; i <= col; i++) {\n                    System.out.print(rs.getObject(i));\n                }\n                System.out.println(\"\");\n            }\n            System.out.println(\"============================\");\n        } catch (SQLException e) {\n            e.printStackTrace();\n        } finally {\n            //close resources\n        }\n    }\n超时错误输出\n//部分数据输出......\njava.sql.SQLRecoverableException: IO 错误: Socket read timed out\n    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1128)\n    at oracle.jdbc.driver.OracleResultSetImpl.close_or_fetch_from_next(OracleResultSetImpl.java:373)\n    at oracle.jdbc.driver.OracleResultSetImpl.next(OracleResultSetImpl.java:277)\n    at com.example.demo.DemoApplicationTests.testReadTimeout(DemoApplicationTests.java:68)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:497)\n    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n    at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)\n    at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)\n    at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)\n    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\n    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:252)\n    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:94)\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n    at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)\n    at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:191)\n    at org.junit.runner.JUnitCore.run(JUnitCore.java:137)\n    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)\n    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234)\n    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:497)\n    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)\nCaused by: oracle.net.ns.NetException: Socket read timed out\n    at oracle.net.ns.Packet.receive(Packet.java:339)\n    at oracle.net.ns.DataPacket.receive(DataPacket.java:106)\n    at oracle.net.ns.NetInputStream.getNextPacket(NetInputStream.java:315)\n    at oracle.net.ns.NetInputStream.read(NetInputStream.java:260)\n    at oracle.net.ns.NetInputStream.read(NetInputStream.java:185)\n    at oracle.net.ns.NetInputStream.read(NetInputStream.java:102)\n    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.readNextPacket(T4CSocketInputStreamWrapper.java:124)\n    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.read(T4CSocketInputStreamWrapper.java:80)\n    at oracle.jdbc.driver.T4CMAREngine.unmarshalUB1(T4CMAREngine.java:1137)\n    at oracle.jdbc.driver.T4CTTIfun.receive(T4CTTIfun.java:290)\n    at oracle.jdbc.driver.T4CTTIfun.doRPC(T4CTTIfun.java:192)\n    at oracle.jdbc.driver.T4C8Oall.doOALL(T4C8Oall.java:531)\n    at oracle.jdbc.driver.T4CPreparedStatement.doOall8(T4CPreparedStatement.java:207)\n    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1119)\n    ... 35 more\n刚开始会有数据输出，但是到了某个resultSet的next的时候，报了超时(close_or_fetch_from_next)，这个超时指定的是当result.next方法触发新的一批数据的拉取(当一个fetchSize的数据消费完之后，接下来的next会触发新一批数据的fetch)之后在timeout时间返回内没有收到数据库返回的数据。\noracle的jdbc默认的fetchSize为10，也就是每个fetch，如果超过指定时间没接收到数据，则抛出timeout异常。\n小结\n\njdbc的socketTimeout值的设置要非常小心，不同数据库的jdbc driver设置不一样，特别是使用不同连接池的话，设置也可能不尽相同。对于严重依赖数据库操作的服务来说，非常有必要设置这个值，否则万一网络或数据库异常，会导致服务线程一直阻塞在java.net.SocketInputStream.socketRead0。\n如果查询数据多，则会导致该线程持有的data list不能释放，相当于内存泄露，最后导致OOM\n如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504 Gateway Timeout\n=====================================================\n\n附：错误日志\norg.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:393)\n        at org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:426)\n        at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:342)\n        at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:317)\n        at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:110)\n        at org.springframework.session.web.http.OnCommittedResponseWrapper$SaveContextServletOutputStream.flush(OnCommittedResponseWrapper.java:437)\n        at com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter.write(FastJsonHttpMessageConverter.java:216)\n        at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:183)\n        at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:81)\n        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:126)\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:832)\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:743)\n        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:961)\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:120)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yiji.boot.web.common.ResponseHeaderFilter.doFilterInternal(ResponseHeaderFilter.java:62)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yiji.boot.actuator.acl.ActuatorACLFilter.doFilter(ActuatorACLFilter.java:36)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n        at org.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:676)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:522)\n        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1095)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:672)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1502)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1458)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.IOException: Broken pipe\n        at sun.nio.ch.FileDispatcherImpl.write0(Native Method)\n        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)\n        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)\n        at sun.nio.ch.IOUtil.write(IOUtil.java:65)\n        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:471)\n        at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:124)\n        at org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)\n        at org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:172)\n        at org.apache.coyote.http11.InternalNioOutputBuffer.writeToSocket(InternalNioOutputBuffer.java:139)\n        at org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:197)\n        at org.apache.coyote.http11.InternalNioOutputBuffer.access$000(InternalNioOutputBuffer.java:41)\n        at org.apache.coyote.http11.InternalNioOutputBuffer$SocketOutputBuffer.doWrite(InternalNioOutputBuffer.java:320)\n        at org.apache.coyote.http11.filters.ChunkedOutputFilter.doWrite(ChunkedOutputFilter.java:116)\n        at org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:256)\n        at org.apache.coyote.Response.doWrite(Response.java:501)\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:388)\n        ... 63 common frames omitted\n\n\n\n2018-07-27 11:04:24.377 ERROR [http-nio-8313-exec-12] [dispatcherServlet]-- Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: getOutputStream() has already been called for this response] with root cause\njava.lang.IllegalStateException: getOutputStream() has already been called for this response\n        at org.apache.catalina.connector.Response.getWriter(Response.java:564)\n        at org.apache.catalina.connector.ResponseFacade.getWriter(ResponseFacade.java:212)\n        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)\n        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)\n        at org.springframework.session.web.http.OnCommittedResponseWrapper.getWriter(OnCommittedResponseWrapper.java:133)\n        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)\n        at org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration$SpelView.render(ErrorMvcAutoConfiguration.java:195)\n        at org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1246)\n        at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1029)\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:973)\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:92)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)","slug":"数据库-kill服务进程引发的血案","published":1,"updated":"2019-09-30T07:34:10.839Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vct006pwy6601zb40cb","content":"<p>1、问题描述：<br>18.07.27， 10：50分dba进行mysql数据库碎片整理，11：04分，发现数据库连接爆满，此时应用已处于down掉的状态，11：22数据库强行kill，11：40分之前发现应用并没有进行新的连接，此时停止应用发现停不下来，不得不kill掉应用进程，重启后恢复。但此时发现，之前入库的记录并没有成功，而mq由于没有收到应用的ack确认消息，消息重新进入队列并重发，加上数据没入库，交易进行了重复的操作！由于是全名抢车业务，导致重复上账，重复充退。</p>\n<p>2、问题分析<br>由于没有及时的dump保护现场，加上应用down掉后，日志少的可怜，只有一些Broken pipe，以及该getOuptStream()异常，后期只能从代码层面分析。</p>\n<p>3、分析<br>jdbc sockeTimeout时间并没有设置，所以默认使用的mysql的或者操作系统本身的socketTimeout 该问题会引发类似问题</p>\n<p>相关文档:<br><a href=\"http://www.sohu.com/a/142039227_505885\">http://www.sohu.com/a/142039227_505885</a><br><a href=\"http://www.sohu.com/a/141155649_539864?qq-pf-to=pcqq.c2c\">http://www.sohu.com/a/141155649_539864?qq-pf-to=pcqq.c2c</a><br><a href=\"https://blog.csdn.net/lx348321409/article/details/76095751\">https://blog.csdn.net/lx348321409/article/details/76095751</a><br><a href=\"https://segmentfault.com/a/1190000012944562\">https://segmentfault.com/a/1190000012944562</a><br><a href=\"https://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration\">https://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration</a></p>\n<p>=====================================================<br>jdbc timeout类别</p>\n<p>主要有如下几个类别</p>\n<p><img src=\"\\images\\pasted-16.png\" alt=\"upload successful\"><br>transaction timeout<br>设置的是一个事务的执行时间，里头可能包含多个statement<br>statement timeout(也相当于result set fetch timeout)<br>设置的是一个statement的执行超时时间，即driver等待statement执行完成，接收到数据的超时时间(注意statement的timeout不是整个查询的timeout，只是statement执行完成并拉取fetchSize数据返回的超时，之后resultSet的next在必要的时候还会触发fetch数据，每次fetch的超时时间是单独算的，默认也是以statement设置的timeout为准)<br>jdbc socket timeout<br>设置的是jdbc I/O socket read and write operations的超时时间，防止因网络问题或数据库问题，导致driver一直阻塞等待。(建议比statement timeout的时间长)<br>os socket timeout<br>这个是操作系统级别的socket设置(如果jdbc socket timeout没有设置，而os级别的socket timeout有设置，则使用系统的socket timeout值)。<br>上面的不同级别的timeout越往下优先级越高，也就是说如果下面的配置比上面的配置值小的话，则会优先触发timeout，那么相当于上面的配置值就”失效”了。<br>jdbc socket timeout</p>\n<p>这个不同数据的jdbc driver实现不一样<br>mysql</p>\n<p>jdbc:mysql://localhost:3306/ag_admin?useUnicode=true&amp;characterEncoding=UTF8&amp;connectTimeout=60000&amp;socketTimeout=60000<br>通过url参数传递即可<br>pg</p>\n<p>jdbc:postgresql://localhost/test?user=fred&amp;password=secret&amp;&amp;connectTimeout=60&amp;socketTimeout=60<br>pg也是通过url传递，不过它的单位与mysql不同，mysql是毫秒，而pg是秒<br>oracle</p>\n<p>oracle需要通过oracle.jdbc.ReadTimeout参数来设置，连接超时参数是oracle.net.CONNECT_TIMEOUT<br>通过properties设置<br>            Class.forName(“oracle.jdbc.driver.OracleDriver”);<br>            Properties props = new Properties() ;<br>            props.put( “user” , “test_schema”) ;<br>            props.put( “password” , “pwd”) ;<br>            props.put( “oracle.net.CONNECT_TIMEOUT” , “10000000”) ;<br>            props.put( “oracle.jdbc.ReadTimeout” , “2000” ) ;<br>            Connection conn = DriverManager.getConnection( “jdbc:oracle:thin:@10.0.1.9:1521:orcl” , props ) ;<br>通过环境变量设置<br>String readTimeout = “10000”; // ms<br>System.setProperty(“oracle.jdbc.ReadTimeout”, readTimeout);<br>Class.forName(“oracle.jdbc.OracleDriver”);<br>Connection conn = DriverManager.getConnection(jdbcUrl, user, pwd);<br>注意需要在connection连接之前设置环境变量<br>tomcat jdbc pool<br>一般我们不直接使用jdbc connection，而是使用连接池。由于tomcat jdbc pool是springboot默认使用的数据库连接池，这里就讲述一下如何在tomcat jdbc pool下设置。<br>spring.datasource.tomcat.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000<br>注意，这里是分号分隔，单位是毫秒，这里可以根据各自的情况配置前缀(tomcat jdbc连接池的话，默认是spring.datasource.tomcat)，可以自定义，比如<br>@Bean@Qualifier(“writeDataSource”)<br>    @ConfigurationProperties(prefix = “spring.datasource.write”)<br>    public DataSource writeDataSource() {<br>        returnDataSourceBuilder.create().build();<br>    }<br>假设你这里是自定义了prefix为spring.datasource.write，那么上述配置就变为<br>spring.datasource.write.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000<br>oracle.jdbc.ReadTimeout如果没有设置的话，driver里头默认是0<br>oracle.jdbc.ReadTimeout</p>\n<p>driver内部将该值设置到oracle.net.READ_TIMEOUT变量上<br>oracle.net.nt.TcpNTAdapter<br>    @Override<br>    publicvoid setReadTimeoutIfRequired(final Properties properties) throws IOException, NetException {<br>        String s = ((Hashtable&lt;K, String&gt;)properties).get(“oracle.net.READ_TIMEOUT”);<br>        if (s == null) {<br>            s = “0”;<br>        }<br>        this.setOption(3, s);<br>    }</p>\n<pre><code>publicvoid setOption(int var1, Object var2) throws IOException, NetException &#123;\n    String var3;\n    switch(var1) &#123;\n    case0:\n        var3 = (String)var2;\n        this.socket.setTcpNoDelay(var3.equals(&quot;YES&quot;));\n        break;\n    case1:\n        var3 = (String)var2;\n        if(var3.equals(&quot;YES&quot;)) &#123;\n            this.socket.setKeepAlive(true);\n        &#125;\n    case2:\n    default:\n        break;\n    case3:\n        this.sockTimeout = Integer.parseInt((String)var2);\n        this.socket.setSoTimeout(this.sockTimeout);\n    &#125;\n\n&#125;\n</code></pre><p>可用看到最后设置的是socket的soTimeout<br>实例</p>\n<pre><code>@Test\npublicvoid testReadTimeout() throws SQLException &#123;\n    Connection connection = dataSource.getConnection();\n    String sql = &quot;select * from demo_table&quot;;\n    PreparedStatement pstmt;\n    try &#123;\n        pstmt = (PreparedStatement)connection.prepareStatement(sql);\n        ResultSet rs = pstmt.executeQuery();\n        int col = rs.getMetaData().getColumnCount();\n        System.out.println(&quot;============================&quot;);\n        while (rs.next()) &#123;\n            for (int i = 1; i &lt;= col; i++) &#123;\n                System.out.print(rs.getObject(i));\n            &#125;\n            System.out.println(&quot;&quot;);\n        &#125;\n        System.out.println(&quot;============================&quot;);\n    &#125; catch (SQLException e) &#123;\n        e.printStackTrace();\n    &#125; finally &#123;\n        //close resources\n    &#125;\n&#125;\n</code></pre><p>超时错误输出<br>//部分数据输出……<br>java.sql.SQLRecoverableException: IO 错误: Socket read timed out<br>    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1128)<br>    at oracle.jdbc.driver.OracleResultSetImpl.close_or_fetch_from_next(OracleResultSetImpl.java:373)<br>    at oracle.jdbc.driver.OracleResultSetImpl.next(OracleResultSetImpl.java:277)<br>    at com.example.demo.DemoApplicationTests.testReadTimeout(DemoApplicationTests.java:68)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:497)<br>    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)<br>    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)<br>    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)<br>    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)<br>    at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)<br>    at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)<br>    at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)<br>    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)<br>    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:252)<br>    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:94)<br>    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)<br>    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)<br>    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)<br>    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)<br>    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)<br>    at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)<br>    at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)<br>    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)<br>    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:191)<br>    at org.junit.runner.JUnitCore.run(JUnitCore.java:137)<br>    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)<br>    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234)<br>    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:497)<br>    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)<br>Caused by: oracle.net.ns.NetException: Socket read timed out<br>    at oracle.net.ns.Packet.receive(Packet.java:339)<br>    at oracle.net.ns.DataPacket.receive(DataPacket.java:106)<br>    at oracle.net.ns.NetInputStream.getNextPacket(NetInputStream.java:315)<br>    at oracle.net.ns.NetInputStream.read(NetInputStream.java:260)<br>    at oracle.net.ns.NetInputStream.read(NetInputStream.java:185)<br>    at oracle.net.ns.NetInputStream.read(NetInputStream.java:102)<br>    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.readNextPacket(T4CSocketInputStreamWrapper.java:124)<br>    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.read(T4CSocketInputStreamWrapper.java:80)<br>    at oracle.jdbc.driver.T4CMAREngine.unmarshalUB1(T4CMAREngine.java:1137)<br>    at oracle.jdbc.driver.T4CTTIfun.receive(T4CTTIfun.java:290)<br>    at oracle.jdbc.driver.T4CTTIfun.doRPC(T4CTTIfun.java:192)<br>    at oracle.jdbc.driver.T4C8Oall.doOALL(T4C8Oall.java:531)<br>    at oracle.jdbc.driver.T4CPreparedStatement.doOall8(T4CPreparedStatement.java:207)<br>    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1119)<br>    … 35 more<br>刚开始会有数据输出，但是到了某个resultSet的next的时候，报了超时(close_or_fetch_from_next)，这个超时指定的是当result.next方法触发新的一批数据的拉取(当一个fetchSize的数据消费完之后，接下来的next会触发新一批数据的fetch)之后在timeout时间返回内没有收到数据库返回的数据。<br>oracle的jdbc默认的fetchSize为10，也就是每个fetch，如果超过指定时间没接收到数据，则抛出timeout异常。<br>小结</p>\n<p>jdbc的socketTimeout值的设置要非常小心，不同数据库的jdbc driver设置不一样，特别是使用不同连接池的话，设置也可能不尽相同。对于严重依赖数据库操作的服务来说，非常有必要设置这个值，否则万一网络或数据库异常，会导致服务线程一直阻塞在java.net.SocketInputStream.socketRead0。<br>如果查询数据多，则会导致该线程持有的data list不能释放，相当于内存泄露，最后导致OOM</p>\n<h1 id=\"如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504-Gateway-Timeout\"><a href=\"#如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504-Gateway-Timeout\" class=\"headerlink\" title=\"如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504 Gateway Timeout\"></a>如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504 Gateway Timeout</h1><p>附：错误日志<br>org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe<br>        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:393)<br>        at org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:426)<br>        at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:342)<br>        at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:317)<br>        at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:110)<br>        at org.springframework.session.web.http.OnCommittedResponseWrapper$SaveContextServletOutputStream.flush(OnCommittedResponseWrapper.java:437)<br>        at com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter.write(FastJsonHttpMessageConverter.java:216)<br>        at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:183)<br>        at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:81)<br>        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:126)<br>        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:832)<br>        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:743)<br>        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)<br>        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:961)<br>        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)<br>        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)<br>        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)<br>        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:120)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yiji.boot.web.common.ResponseHeaderFilter.doFilterInternal(ResponseHeaderFilter.java:62)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yiji.boot.actuator.acl.ActuatorACLFilter.doFilter(ActuatorACLFilter.java:36)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)<br>        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106)<br>        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)<br>        at org.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:676)<br>        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)<br>        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)<br>        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)<br>        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:522)<br>        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1095)<br>        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:672)<br>        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1502)<br>        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1458)<br>        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)<br>        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)<br>        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)<br>        at java.lang.Thread.run(Thread.java:745)<br>Caused by: java.io.IOException: Broken pipe<br>        at sun.nio.ch.FileDispatcherImpl.write0(Native Method)<br>        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)<br>        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)<br>        at sun.nio.ch.IOUtil.write(IOUtil.java:65)<br>        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:471)<br>        at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:124)<br>        at org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)<br>        at org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:172)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer.writeToSocket(InternalNioOutputBuffer.java:139)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:197)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer.access$000(InternalNioOutputBuffer.java:41)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer$SocketOutputBuffer.doWrite(InternalNioOutputBuffer.java:320)<br>        at org.apache.coyote.http11.filters.ChunkedOutputFilter.doWrite(ChunkedOutputFilter.java:116)<br>        at org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:256)<br>        at org.apache.coyote.Response.doWrite(Response.java:501)<br>        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:388)<br>        … 63 common frames omitted</p>\n<p>2018-07-27 11:04:24.377 ERROR [http-nio-8313-exec-12] [dispatcherServlet]– Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: getOutputStream() has already been called for this response] with root cause<br>java.lang.IllegalStateException: getOutputStream() has already been called for this response<br>        at org.apache.catalina.connector.Response.getWriter(Response.java:564)<br>        at org.apache.catalina.connector.ResponseFacade.getWriter(ResponseFacade.java:212)<br>        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)<br>        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)<br>        at org.springframework.session.web.http.OnCommittedResponseWrapper.getWriter(OnCommittedResponseWrapper.java:133)<br>        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)<br>        at org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration$SpelView.render(ErrorMvcAutoConfiguration.java:195)<br>        at org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1246)<br>        at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1029)<br>        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:973)<br>        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)<br>        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)<br>        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)<br>        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:92)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)</p>\n","site":{"data":{}},"length":18574,"excerpt":"","more":"<p>1、问题描述：<br>18.07.27， 10：50分dba进行mysql数据库碎片整理，11：04分，发现数据库连接爆满，此时应用已处于down掉的状态，11：22数据库强行kill，11：40分之前发现应用并没有进行新的连接，此时停止应用发现停不下来，不得不kill掉应用进程，重启后恢复。但此时发现，之前入库的记录并没有成功，而mq由于没有收到应用的ack确认消息，消息重新进入队列并重发，加上数据没入库，交易进行了重复的操作！由于是全名抢车业务，导致重复上账，重复充退。</p>\n<p>2、问题分析<br>由于没有及时的dump保护现场，加上应用down掉后，日志少的可怜，只有一些Broken pipe，以及该getOuptStream()异常，后期只能从代码层面分析。</p>\n<p>3、分析<br>jdbc sockeTimeout时间并没有设置，所以默认使用的mysql的或者操作系统本身的socketTimeout 该问题会引发类似问题</p>\n<p>相关文档:<br><a href=\"http://www.sohu.com/a/142039227_505885\">http://www.sohu.com/a/142039227_505885</a><br><a href=\"http://www.sohu.com/a/141155649_539864?qq-pf-to=pcqq.c2c\">http://www.sohu.com/a/141155649_539864?qq-pf-to=pcqq.c2c</a><br><a href=\"https://blog.csdn.net/lx348321409/article/details/76095751\">https://blog.csdn.net/lx348321409/article/details/76095751</a><br><a href=\"https://segmentfault.com/a/1190000012944562\">https://segmentfault.com/a/1190000012944562</a><br><a href=\"https://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration\">https://www.cubrid.org/blog/understanding-jdbc-internals-and-timeout-configuration</a></p>\n<p>=====================================================<br>jdbc timeout类别</p>\n<p>主要有如下几个类别</p>\n<p><img src=\"\\images\\pasted-16.png\" alt=\"upload successful\"><br>transaction timeout<br>设置的是一个事务的执行时间，里头可能包含多个statement<br>statement timeout(也相当于result set fetch timeout)<br>设置的是一个statement的执行超时时间，即driver等待statement执行完成，接收到数据的超时时间(注意statement的timeout不是整个查询的timeout，只是statement执行完成并拉取fetchSize数据返回的超时，之后resultSet的next在必要的时候还会触发fetch数据，每次fetch的超时时间是单独算的，默认也是以statement设置的timeout为准)<br>jdbc socket timeout<br>设置的是jdbc I/O socket read and write operations的超时时间，防止因网络问题或数据库问题，导致driver一直阻塞等待。(建议比statement timeout的时间长)<br>os socket timeout<br>这个是操作系统级别的socket设置(如果jdbc socket timeout没有设置，而os级别的socket timeout有设置，则使用系统的socket timeout值)。<br>上面的不同级别的timeout越往下优先级越高，也就是说如果下面的配置比上面的配置值小的话，则会优先触发timeout，那么相当于上面的配置值就”失效”了。<br>jdbc socket timeout</p>\n<p>这个不同数据的jdbc driver实现不一样<br>mysql</p>\n<p>jdbc:mysql://localhost:3306/ag_admin?useUnicode=true&amp;characterEncoding=UTF8&amp;connectTimeout=60000&amp;socketTimeout=60000<br>通过url参数传递即可<br>pg</p>\n<p>jdbc:postgresql://localhost/test?user=fred&amp;password=secret&amp;&amp;connectTimeout=60&amp;socketTimeout=60<br>pg也是通过url传递，不过它的单位与mysql不同，mysql是毫秒，而pg是秒<br>oracle</p>\n<p>oracle需要通过oracle.jdbc.ReadTimeout参数来设置，连接超时参数是oracle.net.CONNECT_TIMEOUT<br>通过properties设置<br>            Class.forName(“oracle.jdbc.driver.OracleDriver”);<br>            Properties props = new Properties() ;<br>            props.put( “user” , “test_schema”) ;<br>            props.put( “password” , “pwd”) ;<br>            props.put( “oracle.net.CONNECT_TIMEOUT” , “10000000”) ;<br>            props.put( “oracle.jdbc.ReadTimeout” , “2000” ) ;<br>            Connection conn = DriverManager.getConnection( “jdbc:oracle:thin:@10.0.1.9:1521:orcl” , props ) ;<br>通过环境变量设置<br>String readTimeout = “10000”; // ms<br>System.setProperty(“oracle.jdbc.ReadTimeout”, readTimeout);<br>Class.forName(“oracle.jdbc.OracleDriver”);<br>Connection conn = DriverManager.getConnection(jdbcUrl, user, pwd);<br>注意需要在connection连接之前设置环境变量<br>tomcat jdbc pool<br>一般我们不直接使用jdbc connection，而是使用连接池。由于tomcat jdbc pool是springboot默认使用的数据库连接池，这里就讲述一下如何在tomcat jdbc pool下设置。<br>spring.datasource.tomcat.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000<br>注意，这里是分号分隔，单位是毫秒，这里可以根据各自的情况配置前缀(tomcat jdbc连接池的话，默认是spring.datasource.tomcat)，可以自定义，比如<br>@Bean@Qualifier(“writeDataSource”)<br>    @ConfigurationProperties(prefix = “spring.datasource.write”)<br>    public DataSource writeDataSource() {<br>        returnDataSourceBuilder.create().build();<br>    }<br>假设你这里是自定义了prefix为spring.datasource.write，那么上述配置就变为<br>spring.datasource.write.connectionProperties=oracle.net.CONNECT_TIMEOUT=10000;oracle.jdbc.ReadTimeout=60000<br>oracle.jdbc.ReadTimeout如果没有设置的话，driver里头默认是0<br>oracle.jdbc.ReadTimeout</p>\n<p>driver内部将该值设置到oracle.net.READ_TIMEOUT变量上<br>oracle.net.nt.TcpNTAdapter<br>    @Override<br>    publicvoid setReadTimeoutIfRequired(final Properties properties) throws IOException, NetException {<br>        String s = ((Hashtable&lt;K, String&gt;)properties).get(“oracle.net.READ_TIMEOUT”);<br>        if (s == null) {<br>            s = “0”;<br>        }<br>        this.setOption(3, s);<br>    }</p>\n<pre><code>publicvoid setOption(int var1, Object var2) throws IOException, NetException &#123;\n    String var3;\n    switch(var1) &#123;\n    case0:\n        var3 = (String)var2;\n        this.socket.setTcpNoDelay(var3.equals(&quot;YES&quot;));\n        break;\n    case1:\n        var3 = (String)var2;\n        if(var3.equals(&quot;YES&quot;)) &#123;\n            this.socket.setKeepAlive(true);\n        &#125;\n    case2:\n    default:\n        break;\n    case3:\n        this.sockTimeout = Integer.parseInt((String)var2);\n        this.socket.setSoTimeout(this.sockTimeout);\n    &#125;\n\n&#125;\n</code></pre><p>可用看到最后设置的是socket的soTimeout<br>实例</p>\n<pre><code>@Test\npublicvoid testReadTimeout() throws SQLException &#123;\n    Connection connection = dataSource.getConnection();\n    String sql = &quot;select * from demo_table&quot;;\n    PreparedStatement pstmt;\n    try &#123;\n        pstmt = (PreparedStatement)connection.prepareStatement(sql);\n        ResultSet rs = pstmt.executeQuery();\n        int col = rs.getMetaData().getColumnCount();\n        System.out.println(&quot;============================&quot;);\n        while (rs.next()) &#123;\n            for (int i = 1; i &lt;= col; i++) &#123;\n                System.out.print(rs.getObject(i));\n            &#125;\n            System.out.println(&quot;&quot;);\n        &#125;\n        System.out.println(&quot;============================&quot;);\n    &#125; catch (SQLException e) &#123;\n        e.printStackTrace();\n    &#125; finally &#123;\n        //close resources\n    &#125;\n&#125;\n</code></pre><p>超时错误输出<br>//部分数据输出……<br>java.sql.SQLRecoverableException: IO 错误: Socket read timed out<br>    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1128)<br>    at oracle.jdbc.driver.OracleResultSetImpl.close_or_fetch_from_next(OracleResultSetImpl.java:373)<br>    at oracle.jdbc.driver.OracleResultSetImpl.next(OracleResultSetImpl.java:277)<br>    at com.example.demo.DemoApplicationTests.testReadTimeout(DemoApplicationTests.java:68)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:497)<br>    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)<br>    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)<br>    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)<br>    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)<br>    at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)<br>    at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)<br>    at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)<br>    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)<br>    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:252)<br>    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:94)<br>    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)<br>    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)<br>    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)<br>    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)<br>    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)<br>    at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)<br>    at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)<br>    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)<br>    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:191)<br>    at org.junit.runner.JUnitCore.run(JUnitCore.java:137)<br>    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)<br>    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234)<br>    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:497)<br>    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)<br>Caused by: oracle.net.ns.NetException: Socket read timed out<br>    at oracle.net.ns.Packet.receive(Packet.java:339)<br>    at oracle.net.ns.DataPacket.receive(DataPacket.java:106)<br>    at oracle.net.ns.NetInputStream.getNextPacket(NetInputStream.java:315)<br>    at oracle.net.ns.NetInputStream.read(NetInputStream.java:260)<br>    at oracle.net.ns.NetInputStream.read(NetInputStream.java:185)<br>    at oracle.net.ns.NetInputStream.read(NetInputStream.java:102)<br>    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.readNextPacket(T4CSocketInputStreamWrapper.java:124)<br>    at oracle.jdbc.driver.T4CSocketInputStreamWrapper.read(T4CSocketInputStreamWrapper.java:80)<br>    at oracle.jdbc.driver.T4CMAREngine.unmarshalUB1(T4CMAREngine.java:1137)<br>    at oracle.jdbc.driver.T4CTTIfun.receive(T4CTTIfun.java:290)<br>    at oracle.jdbc.driver.T4CTTIfun.doRPC(T4CTTIfun.java:192)<br>    at oracle.jdbc.driver.T4C8Oall.doOALL(T4C8Oall.java:531)<br>    at oracle.jdbc.driver.T4CPreparedStatement.doOall8(T4CPreparedStatement.java:207)<br>    at oracle.jdbc.driver.T4CPreparedStatement.fetch(T4CPreparedStatement.java:1119)<br>    … 35 more<br>刚开始会有数据输出，但是到了某个resultSet的next的时候，报了超时(close_or_fetch_from_next)，这个超时指定的是当result.next方法触发新的一批数据的拉取(当一个fetchSize的数据消费完之后，接下来的next会触发新一批数据的fetch)之后在timeout时间返回内没有收到数据库返回的数据。<br>oracle的jdbc默认的fetchSize为10，也就是每个fetch，如果超过指定时间没接收到数据，则抛出timeout异常。<br>小结</p>\n<p>jdbc的socketTimeout值的设置要非常小心，不同数据库的jdbc driver设置不一样，特别是使用不同连接池的话，设置也可能不尽相同。对于严重依赖数据库操作的服务来说，非常有必要设置这个值，否则万一网络或数据库异常，会导致服务线程一直阻塞在java.net.SocketInputStream.socketRead0。<br>如果查询数据多，则会导致该线程持有的data list不能释放，相当于内存泄露，最后导致OOM</p>\n<h1 id=\"如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504-Gateway-Timeout\"><a href=\"#如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504-Gateway-Timeout\" class=\"headerlink\" title=\"如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504 Gateway Timeout\"></a>如果请求数据库操作很多且阻塞住了，会导致服务器可用的woker线程变少，严重则会导致服务不可用，nginx报504 Gateway Timeout</h1><p>附：错误日志<br>org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe<br>        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:393)<br>        at org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:426)<br>        at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:342)<br>        at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:317)<br>        at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:110)<br>        at org.springframework.session.web.http.OnCommittedResponseWrapper$SaveContextServletOutputStream.flush(OnCommittedResponseWrapper.java:437)<br>        at com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter.write(FastJsonHttpMessageConverter.java:216)<br>        at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:183)<br>        at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:81)<br>        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:126)<br>        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:832)<br>        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:743)<br>        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)<br>        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:961)<br>        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)<br>        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)<br>        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)<br>        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:120)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yiji.boot.web.common.ResponseHeaderFilter.doFilterInternal(ResponseHeaderFilter.java:62)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yiji.boot.actuator.acl.ActuatorACLFilter.doFilter(ActuatorACLFilter.java:36)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)<br>        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106)<br>        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)<br>        at org.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:676)<br>        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)<br>        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)<br>        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)<br>        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:522)<br>        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1095)<br>        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:672)<br>        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1502)<br>        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1458)<br>        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)<br>        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)<br>        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)<br>        at java.lang.Thread.run(Thread.java:745)<br>Caused by: java.io.IOException: Broken pipe<br>        at sun.nio.ch.FileDispatcherImpl.write0(Native Method)<br>        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)<br>        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)<br>        at sun.nio.ch.IOUtil.write(IOUtil.java:65)<br>        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:471)<br>        at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:124)<br>        at org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)<br>        at org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:172)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer.writeToSocket(InternalNioOutputBuffer.java:139)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:197)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer.access$000(InternalNioOutputBuffer.java:41)<br>        at org.apache.coyote.http11.InternalNioOutputBuffer$SocketOutputBuffer.doWrite(InternalNioOutputBuffer.java:320)<br>        at org.apache.coyote.http11.filters.ChunkedOutputFilter.doWrite(ChunkedOutputFilter.java:116)<br>        at org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:256)<br>        at org.apache.coyote.Response.doWrite(Response.java:501)<br>        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:388)<br>        … 63 common frames omitted</p>\n<p>2018-07-27 11:04:24.377 ERROR [http-nio-8313-exec-12] [dispatcherServlet]– Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: getOutputStream() has already been called for this response] with root cause<br>java.lang.IllegalStateException: getOutputStream() has already been called for this response<br>        at org.apache.catalina.connector.Response.getWriter(Response.java:564)<br>        at org.apache.catalina.connector.ResponseFacade.getWriter(ResponseFacade.java:212)<br>        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)<br>        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)<br>        at org.springframework.session.web.http.OnCommittedResponseWrapper.getWriter(OnCommittedResponseWrapper.java:133)<br>        at javax.servlet.ServletResponseWrapper.getWriter(ServletResponseWrapper.java:152)<br>        at org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration$SpelView.render(ErrorMvcAutoConfiguration.java:195)<br>        at org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1246)<br>        at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1029)<br>        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:973)<br>        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:895)<br>        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:967)<br>        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:858)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)<br>        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:843)<br>        at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at com.yjf.common.web.CrossScriptingFilter.doFilter(CrossScriptingFilter.java:92)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)<br>        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)<br>        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)</p>\n"},{"title":"java对象的诞生与消亡","author":"Xiang Chuang","date":"2019-04-08T08:54:00.000Z","_content":"## 说在前面\n&emsp;&emsp;本文将从java对象的角度出发，探讨java应用运行过程中“对象”从诞生到消亡的生命历程，结合jvm的相关技术方案简要阐述各个环节的实现细节。需要指出的是，本文旨在阐述清楚“对象”的生命周期，对于jvm（本文基于HotSpot虚拟机）相关技术的深层次原理只会点到为止（能描述清“对象”的生命周期即可），后续将会在其他文章中单独罗列出各个主题进行深入剖析。\n\n## 概述\n+ [java内存区域](#partI)\n+ [java对象](#partII)\n+ [垃圾回收](#partIII)\n+ [内存调优](#partIV)\n\n----------------------------------\n\n## java内存区域\n&emsp;&emsp;java对象生存的载体-运行时数据区，虚拟机中数据区大致包含如下图所示的几个区域： \n![upload successful](\\images\\pasted-74.png)\n1、程序计数器\n&emsp;&emsp;当前线程所执行的字节码的行号指示器，标识执行到的节点，这是一块较小的内存空间。由于任何时刻，一个处理器（多核处理器中的某一核）只会执行一个线程中的指令，因此，每个线程都有一个独立、私有的程序计数器。此区域（唯一一个）在java虚拟机规范中没有规定任何OOM的情况。\n2、虚拟机栈\n&emsp;&emsp;其生命周期与线程相同，方法在执行时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息，每一个方法的调用就是相应栈帧在虚拟机栈中入栈和出栈的过程。\n局部变量表：存放编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（指向对象起始地址的引用指针-HotSpot方案、或者指向一个代表对象的句柄或其他与此对象相关的位置）、returnAddress类型（执行一条字节码指令的地址）。其中，除long和double占用2个局部变量空间（Slot）外，其余只占用1个Slot。局部变量表所需内存空间在编译期间完成分配，运行期间不会改变大小，即，进入一个方法时，栈帧中所需分配的局部变量空间是确定的。java虚拟机规范对此区域规定了两类异常情况，1是线程请求的栈深度大于虚拟机所允许的深度时抛出StackOverflowError，2是可动态扩展的虚拟机栈扩展时无法申请到足够的内存时抛出OOM。\n3、本地方法栈\n&emsp;&emsp;HotSpot将其与虚拟机栈合二为一。它是为虚拟机所使用到的Native方法服务。它可能抛出的异常与虚拟机栈一致。\n4、堆\n&emsp;&emsp;此区域用于存放对象的实例。java虚拟机规范原文：The heap is the runtime data area from which memory for all class instances and arrays is allocated.此区域会抛出OOM异常。由于这个区域存分的是对象实例且是线程共享区域，因此在后续的内容中将以此为核心进行讲述。\n5、方法区（HotSpot，jdk8之后已由元空间取代）\n&emsp;&emsp;该区域用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，为了与java堆区分开来，java虚拟机规范为其命了一个别名Non-Heap。该区域会抛出OOM。\n6、运行时常量池\n&emsp;&emsp;方法区的一部分，Clas文件中除了由类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译期生产的各种字面量和符号引用。除了编译期间会产生常量，java允许运行期间产生常量并存放到运行时常量池中，如String.intern()。该区域是方法区的一部分，因此申请不到内存时也会抛出OOM。\n7、直接内存\n&emsp;&emsp;它不属于虚拟机运行时数据区的一部分，但其也可能出现OOM，且使用频繁（如NIO类，引入了基于通道（Channel）与缓冲区（Buffer）的I/O方式，可使用Native函数直接分配堆外内存，然后通过一个存储在java堆中的DirectByteBuffer对象作为这块内存的引用进行操作，这样避免了在java堆与Native堆中来回复制数据从而提升了性能）。该区域使用超过机器内存等限制时会抛出OOM。\n8、元空间\n&emsp;&emsp;如示意图中所述，HotSpot在jdk8（含）之后，已经移除了老年代（方法区），转由元空间（metaspace）实现，即本地内存Native Memory。\n&emsp;&emsp;至于为什么使用本地内存替换永久代，官网有如此描述：This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.\n&emsp;&emsp;具体移除细节，官网由如此描述：The proposed implementation will allocate class meta-data in native memory and move interned Strings and class statics to the Java heap.\n&emsp;&emsp;详细信息参见官网地址http://openjdk.java.net/jeps/122\n\n----------------------------------\n\n## java对象\n \n&emsp;&emsp;前面聊完java对象身存的载体的具体结构，下面我们聊一聊java对象本身的一些事，需要说明的的是，此处是基于HotSpot探讨java对象在堆空间上实例的创建、布局以及访问。\n1、对象的创建\n&emsp;&emsp;从语言层面来讲，java对象的创建就是一个new关键字，当应用运行时，虚拟机遇到一条new指令，将进行如下操作：\n&emsp;&emsp;##检查类的加载：检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载、解析和初始化。\n&emsp;&emsp;##分配内存：java堆内存是否规整决定了如何分配内存，规整的内存，采用“指针碰撞”（Bump the Pointer），即从已用内存和空闲内存的指针分界点开始向空闲内存移动与对象大小相等的距离即可；如何内存不规整，则需要维护空闲列表（Free List），分配时从列表中选择足够大的空间划分给对象的实例。java堆是否规整与垃圾采集器是否带有压缩整理功能有关，如使用Serial、ParNew这种带Compact过程的收集器时采用指针碰撞，使用CMS这种基于Mark-Sweep算法的收集器时采用空闲列表。另外一个需要考虑的问题是线程安全，解决这个问题有两种方案，1是采用CAS保证原子性；2是为每个线程在java堆中预先分配一小块，即本地线程分配缓冲（TLAB），只需在分配新的TLAB时进行同步锁定，-XX：+/-UseTLAB。\n&emsp;&emsp;##初始化为0值：此处不包括对象头，这个操作保证了对象的实例可以不赋初始值即可使用。\n&emsp;&emsp;##对象头信息设置：对象头中包含如，这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄、锁等信息。\n&emsp;&emsp;##初始化（执行<init>方法）：一般来说，执行new指令之后会接着执行<init>方法（由字节码中是否跟随invokespecial指令决定），从而，一个真正可以使用的对象诞生。\n2、对象的内存布局\n&emsp;&emsp;HotSpot中，对象在内存中存储的布局分为3部分：对象头（Header）、实例数据（Instance Data）以及对齐填充（Padding）。\n&emsp;&emsp;##对象头：对象头包含两部分，1是用于存储对象自身的运行时数据Mark Work，在32位和64位的虚拟机中分别占32bit、64bit,包含信息如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向锁线程ID、偏向时间戳等。eg：32位未锁定状态的对象，25bit用于存储对象哈希码、4bit用于存储对象分代年龄、2bit用于存储锁标识位，1bit固定为0；2是类型指针，即对象指向它的类元数据的指针；对于数组来说，对象头还需有一块用于记录数组长度的数据从而确定数组的大小。\n&emsp;&emsp;##实例数据：HotSpot默认的分配策略为longs/doubles、ints、shorts/chars、bytes/boolean、oops（Oddinary Pointers），相同宽度的字段被分配在一起，父类定义的变量位于子类变量之前（如果CompactFields=true，子类较窄的变量也可能插入到父类变量的空隙中）。\n&emsp;&emsp;##对齐填充：HotSpot要求对象起始地址必须是8字节的整数倍，对象头正好符合，因此对象实例数据可用对齐填充来补全。\n3、对象的访问定位\n&emsp;&emsp;java程序需要通过栈上的reference数据来操作堆上的具体对象。\n&emsp;&emsp;##使用句柄访问：reference中存储的是对象的句柄地址，句柄中包含了对象实例数据与类型数据各自的具体地址，此方式，java堆划分出特定的内存作为句柄池。对象的定位需要两次指针定位，1次找到句柄、另1次找到具体的对象，好处则在于垃圾回收后，对象并移动，不用更改reference中的地址，只需更改句柄池中对应的地址。\n&emsp;&emsp;##使用直接指针访问：reference中存储的是对象地址。对象的定位一次就能找到，提升了性能，HotSpot采用此方案。\n4、对象的存活  \n&emsp;&emsp;前一部分提到，java程序通过栈上的reference数据操作堆上的对象，被操作的对象称之为被引用。对象是否存活与其是否尚被引用有关，那么我们首先来谈一谈引用。\n&emsp;&emsp;引用可分为强引用（Strong Reference）、软引用（Soft Reference）、弱引用（Weak Reference）、虚引用（Phantom Reference）。\n&emsp;&emsp;##强引用：类似于赋值语句那种，垃圾回收器不会回收被引用对象\n&emsp;&emsp;##软引用：jdk提供了SoftReference类实现软引用，指一些有用但并非必须的对象，系统OOM之前会回收此类对象\n&emsp;&emsp;##弱引用：jdk提供了WeakReference类实现弱引用，下一次GC时回收此类对象\n&emsp;&emsp;##虚引用：jdk提供了PhantomReference类实现虚引用，也称之为幽灵引用，对象是否存在虚引用对其本身无任何影响，且无法通过虚引用获得一个对象实例，因此，为对象设置一个虚引用的唯一目的是该对象被回收时收到一个系统通知\n&emsp;&emsp;下面来谈谈判断对象是否存活的两类算法：\n&emsp;&emsp;引用计数算法：给对象添加一个引用计算器，值为0时代表对象可回收，但，对于循环依赖来说，这似乎是个问题\n&emsp;&emsp;可达性分析算法：以一系列被称为GC Roots的对象（虚拟机栈即栈帧中本地变量表中引用的对象；方法区中类静态属性引用的对象；方法区中常量引用的对象；本地方法栈中JNI引用的对象）为起点进行搜索，判断对象是否有引用链到达GC Roots，如果没有，代表对象可回收。\n&emsp;&emsp;需要说明的是，利用可达性分析出不可达的对象，并不一定会立即回收，因为进行标记时会做一次筛选（条件是对象是否有必要执行finalize(),如果对象没有覆盖此方法或此方法被执行过一次，则不必要，否则会把此类对象放入一个F-Queue队列中由虚拟机自建一个低优先级的Finalizer线程去执行，为了避免执行缓慢，其并不会等待执行结果）。  \n\n----------------------------------\n\n## 垃圾回收\n \n&emsp;&emsp;再谈对象创建之内存分配\n&emsp;&emsp;这是一个及其重要的环节，且，根据垃圾回收机制的不同而有所差别，在聊垃圾回收之前，我想有必要就这点多说几句。\n&emsp;&emsp;##对象优先分配在Eden区域，即年轻代\n&emsp;&emsp;##大对象直接分配在老年代，需要说明的是何为大对象，不同收集器定义的不一样，Serial及ParNew收集器采用参数-XX:PretenureSizeThreshold指定，G1则默认为大于区域region大小一半的对象\n&emsp;&emsp;##长期存活的对象进入老年代，一般默认为熬过15次年轻代回收的对象，该值可以调整，具体参数名根据收集器的约定而定。另外，如果Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于等于该年龄的对象直接进入老年代（针对Serial及ParNew）\n&emsp;&emsp;##空间分配担保：只要老年代的连续空间大于新生代对象总大小或历次晋升的平局大小则进行MinorGC，否则进行Full GC（针对Serial及ParNew）\n&emsp;&emsp;前面大概聊了一下虚拟机内存区域以及java对象本身的那点事，这是一个java开发者必备的基础知识，因为你不仅仅应该知道Object obj = new Object（），你更应该清楚java对象究竟是如何诞生的，JVM在这里面做了什么，另一方面，你还应该清楚JVM又是如何替我们清理那些不再被引用的对象。\n&emsp;&emsp;首先，我们来简单聊聊垃圾收集算法：\n&emsp;&emsp;标记-清除（Mark-Sweep）算法：顾名思义，它包含两步，一是标记需要回收的对象，二是清除被标记的对象。但有两个明显的问题是，标记和清除两个环节效率都不高，其次，直接清除会导致内存碎片，这将导致大对象无法找到足够大小的连续空间来分配，从而提前下一次GC。\n&emsp;&emsp;复制（Copying）算法：将内存划分为几块，当一块内存用完后，把存活的对象移动至另一块，再把当前块已使用的空间一性清理掉。但这会导致预留的那部分空间分配时不能用。如HotSpot实现为，将内存分为Eden和两个Survivor，Eden：Survivro为8：1，即预留了10%的空间。需要指出的是，如果对象生命周期长，那么预留的空间也许会出现不够用，这时便需要其他内存进行分配担保（Handle Promotion），这里指的是老年代内存。因为需要额外的空间做担保，那么此算法不适合老年代回收。\n&emsp;&emsp;标记-整理（Mark-Compact）算法：完成标记后，让所有存活的对象向一端移动，然后直接清理掉端边界之外的内存。\n&emsp;&emsp;最后要说明的是，当前的商业虚拟机采用分代收集，即区分新生代和老年代，根据其不同特点搭配不通的垃圾收集算法，如年轻代使用复制算法，老年代使用标记-清除算法或标记-整理算法。\n&emsp;&emsp;HotSpot实现垃圾回收简介：\n&emsp;&emsp;##进行对象可达性分析时，要考虑一致性问题，因为对象的引用随着应用线程的运行不停的变更着，因此需要STW，由于STW对应用线程影响很大，各种垃圾回收器中对此做了通盘的考虑，但即使如CMS这种号称不会STW的收集器也无法避免枚举根节点时的GC停顿。另外，HotSpot设计了基于OopMap的数据结构来记录对象的引用以提升效率。\n&emsp;&emsp;安全点：为指令生产OopMap需要大量额外的空间，因此，HotSpot设计中并没为每条指令生成OopMap，只是在一些成为安全点的特定位置记录这些信息，即，只有当线程进入到安全点时才能暂停下来开始GC。安全点的选定是有讲究的，不可过多也不可过少，所以基本考虑在长时间执行的部分设置安全点，如方法调用、循环跳转、异常跳转等。对于线程在安全点如何停下来的问题，有两种手段，一是抢先式中断、二是主动式中断。HotSpot选择后者，即，GC设置中断标识，用户线程主动轮询是否需要中断，轮询标志的地方和安全点重合。\n&emsp;&emsp;安全区域：对于某些暂时未分配到CUP时间的线程，如其处于Sleep或Blocked状态，JVM不可能瞎等其得到CPU时间后跑到安全点，因此提供了安全区域解决该问题。安全区域中，引用关系不会发生变化，线程进去安全区域时会标识自己已进入，离开时，需要判断系统是否已经完成了根节点枚举或者整个GC过程，没有完成时需等待接收可以离开的信号。\n&emsp;&emsp;接下来我们来聊聊HotSpot定义的垃圾回收器，这是一个重要的话题，也是日常开发中我们最直接面对的课题，先上一个总图（这里代表的是jdk11之前的垃圾回收器，因为在jdk11中，oracle推出了号称很强大很强大的ZGC，支持TB级的内存回收及单次GC暂停时间低于10ms，目前未使用到该版本的jdk，也尚未对此回收器做研究）\n![upload successful](\\images\\pasted-80.png)\n&emsp;&emsp;##Serial收集器：单线程收集器，进行垃圾回收时需暂停其他所有线程，直到收集结束。比较老的收集器了，适用于Client模式的应用。采用复制算法\n![upload successful](\\images\\pasted-82.png)\n&emsp;&emsp;##ParNew收集器：Serial的多线程版本，默认开启的收集线程数与CPU的数量相同，可通过参数-XX:ParallelGCThreads控制。采用复制算法\n![upload successful](\\images\\pasted-84.png)\n&emsp;&emsp;##Serial Old收集器：其可作为Serial、ParNew及Parallel Scavenge的老年代收集器，同时，当CMS收集发生Concurrent Model Failure时，会使用Serail Old进行Full GC。采用标记-整理算法\n![upload successful](\\images\\pasted-82.png)\n&emsp;&emsp;##Parallel Scavenge收集器：更加关注吞吐量，即追求最大吞吐量，适用于那些需要大量计算的应用。使用参数-XX:MaxGCPauseMillis控制停顿时间，参数-XX:GCTimeRatio控制吞吐量（如默认99，即1/（1+99）为GC占CPU时间），开关参数-XX:UseAdaptiveSizePolicy打开后即开启了GC自适应调节策略，无需指定年轻代大小、Survivor大小或晋升老年代对象大小。采用复制算法\n![upload successful](\\images\\pasted-85.png)\n&emsp;&emsp;##Parallel Old收集器：于jdk1.6开始提供，作为Parallel Scavenge的老年代收集器。采用标记-整理算法\n![upload successful](\\images\\pasted-85.png)\n&emsp;&emsp;##CMS收集器：更加关注暂停时间，即追求最短暂停时间。其大概包含4个步骤，初始标记、并发标记、重新标记、并发清除，其中，初始标记主要是标记GC Roots能直接关联到的对象，这是一个很快的过程，需要STW，并发标记根据初始标记结果遍历上述对象所引用的对象，这个过程耗时较长但能与用户线程并行执行，重新标记则是修正并发标记过程中用户线程导致的变动，相对并发标记来说耗时是比较短的，需要STW，最后，并发清除也能与用户线程并行执行。需要指出的是，CMS存在一定的缺点，1是其对CPU资源很敏感，比如其并发阶段是占用了CPU资源（即用户线程占用CPU时间会减少），默认线程数为（CPU数量+3）/4；2是其无法处理浮动垃圾（Floating Garbage），导致会出现Concurrent Mode Failure，从而引起Full GC，引起的原因在于并发清理阶段用户线程的运行会产生新的垃圾需下一次GC才可处理，因此CMS开始回收的阈值为默认92%，避免浮动垃圾导致内存不够用而引起Full GC（这时会临时启用Serial Old回收老年代）；3是其基于标记-清除算法，意味着存在内存碎片，那么碎片过多会导致大对象无法分配而导致Full GC，因此有一个开关参数-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理（这是很耗时的）。采用标记-清除算法\n![upload successful](\\images\\pasted-86.png)\n&emsp;&emsp;##G1收集器：在暂停时间于吞吐量中权衡。采用G1回收器意味着java堆内存布局与其他回收器将有很大的不同，其将堆分成多个（默认2048个）大小相等的region区域（1M-32M）。注意，超过区域大小一半的对象被视为巨型对象直接分配在老年代。同时，G1维护了一个优先列表用于标识回收各区域的价值大小，从而做到了可预测停顿。同时为了避免全堆扫描对象引用，G1提供了Remembered Set用以维护对象的引用。G1回收大致包含如下4个步骤，初始标记、并发标记、最终标记及筛选回收，各步骤的大致功能与CMS类似。整体来看采用标记-整理算法，局部（region之间）来看采用了复制算法。\n![upload successful](\\images\\pasted-87.png)\n\n\n----------------------------------\n\n## 内存调优\n \n&emsp;&emsp;前面已经讲述了对象的诞生与消亡，在实际的工作中，我们日常开发或许并没有过多关注于这些细节，但有一项是我们时常直接接触到的，即，在应用内存使用不正常、应用运行慢时，我们往往会想到是否存在内存使用上的问题，并想办法进行内存调优。内存调优，它没有一个统一的解决方案，只能说其有相同的调优原则，再结合应用的实际情况针对性的优化，因此，要谈内存调优，更好的方式是从案例入手，在案例中阐述问题分析的过程，如何定位到内存上的问题，又如何进行针对性的调优。本博客中有相关案例，可参考https://realxc.github.io/tags/JVM/\n&emsp;&emsp;作为本篇文章的结尾，下面简单介绍一下我们常用的ParNew、CMS、G1回收器的常用且重要的参数配置：\nParNew：\n&emsp;&emsp;-XX:SurvivorRatio=8(默认)中年代占比1：8 sur：eden\n&emsp;&emsp;-XX:PretenureSizeThreshold 直接晋升到老年代的对象大小\n&emsp;&emsp;-XX:NewRatio=4(默认) 年轻代和老年代比例\nCMS\n&emsp;&emsp;-XX:CMSInitiatinOccupancyFraction=92 老年代达到92%时回收\n&emsp;&emsp;-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理\n&emsp;&emsp;-XX:UseConcMarkSweepGC\nG1\n&emsp;&emsp;-XX:+UseG1GC\n&emsp;&emsp;-XX:MaxGCPauseMillis=n 单次GC暂停时间，默认200ms\n&emsp;&emsp;-XX:InitiatingHeapOccupancyPercent=n mix gc触发时间，老年代已使用空间占用整堆内存比例，默认45（很多人理解为整堆已使用空间占整堆比例，这是错误的）\n&emsp;&emsp;-XX:MaxTenuringThreshold=n 年轻代最大年龄，默认15\n&emsp;&emsp;-XX:G1ReservePercent=n 预留空间大小，避免空间被使用完而导致Full GC\n&emsp;&emsp;-XX:G1HeapRegionSize=n 区域大小，1-32（M）\n&emsp;&emsp;-XX:G1NewSizePercent=5 默认为5，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75\n&emsp;&emsp;-XX:G1MaxNewSizePercent=60 默认为60，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75\n\n----------------------------------\n参考参数（jdk8）：\n(G1): -XX:+UseG1GC -XX:MaxGCPauseMillis=50（自定义） -Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:LargePageSizeInBytes=128m（自定义） -XX:+ParallelRefProcEnabled -XX:+PrintAdaptiveSizePolicy -XX:+UseFastAccessorMethods -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000  -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof\n\n----------------------------------\n(CMS):-Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:SurvivorRatio=8（自定义） -XX:NewRatio=4（自定义） -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m（自定义） -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70（自定义） -XX:+UseParNewGC -XX:MaxTenuringThreshold=5（自定义） -XX:+CMSClassUnloadingEnabled -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000 -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof\n\nhttps://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html\nhttps://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock\n\t\t\t\n----------------------------------","source":"_posts/浅谈JVM之垃圾回收.md","raw":"title: java对象的诞生与消亡\nauthor: Xiang Chuang\ntags:\n  - JVM\n  - 内存调优\n  - java对象\n  - 垃圾回收\ncategories:\n  - 专题研讨\ndate: 2019-04-08 16:54:00\n---\n## 说在前面\n&emsp;&emsp;本文将从java对象的角度出发，探讨java应用运行过程中“对象”从诞生到消亡的生命历程，结合jvm的相关技术方案简要阐述各个环节的实现细节。需要指出的是，本文旨在阐述清楚“对象”的生命周期，对于jvm（本文基于HotSpot虚拟机）相关技术的深层次原理只会点到为止（能描述清“对象”的生命周期即可），后续将会在其他文章中单独罗列出各个主题进行深入剖析。\n\n## 概述\n+ [java内存区域](#partI)\n+ [java对象](#partII)\n+ [垃圾回收](#partIII)\n+ [内存调优](#partIV)\n\n----------------------------------\n\n## java内存区域\n&emsp;&emsp;java对象生存的载体-运行时数据区，虚拟机中数据区大致包含如下图所示的几个区域： \n![upload successful](\\images\\pasted-74.png)\n1、程序计数器\n&emsp;&emsp;当前线程所执行的字节码的行号指示器，标识执行到的节点，这是一块较小的内存空间。由于任何时刻，一个处理器（多核处理器中的某一核）只会执行一个线程中的指令，因此，每个线程都有一个独立、私有的程序计数器。此区域（唯一一个）在java虚拟机规范中没有规定任何OOM的情况。\n2、虚拟机栈\n&emsp;&emsp;其生命周期与线程相同，方法在执行时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息，每一个方法的调用就是相应栈帧在虚拟机栈中入栈和出栈的过程。\n局部变量表：存放编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（指向对象起始地址的引用指针-HotSpot方案、或者指向一个代表对象的句柄或其他与此对象相关的位置）、returnAddress类型（执行一条字节码指令的地址）。其中，除long和double占用2个局部变量空间（Slot）外，其余只占用1个Slot。局部变量表所需内存空间在编译期间完成分配，运行期间不会改变大小，即，进入一个方法时，栈帧中所需分配的局部变量空间是确定的。java虚拟机规范对此区域规定了两类异常情况，1是线程请求的栈深度大于虚拟机所允许的深度时抛出StackOverflowError，2是可动态扩展的虚拟机栈扩展时无法申请到足够的内存时抛出OOM。\n3、本地方法栈\n&emsp;&emsp;HotSpot将其与虚拟机栈合二为一。它是为虚拟机所使用到的Native方法服务。它可能抛出的异常与虚拟机栈一致。\n4、堆\n&emsp;&emsp;此区域用于存放对象的实例。java虚拟机规范原文：The heap is the runtime data area from which memory for all class instances and arrays is allocated.此区域会抛出OOM异常。由于这个区域存分的是对象实例且是线程共享区域，因此在后续的内容中将以此为核心进行讲述。\n5、方法区（HotSpot，jdk8之后已由元空间取代）\n&emsp;&emsp;该区域用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，为了与java堆区分开来，java虚拟机规范为其命了一个别名Non-Heap。该区域会抛出OOM。\n6、运行时常量池\n&emsp;&emsp;方法区的一部分，Clas文件中除了由类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译期生产的各种字面量和符号引用。除了编译期间会产生常量，java允许运行期间产生常量并存放到运行时常量池中，如String.intern()。该区域是方法区的一部分，因此申请不到内存时也会抛出OOM。\n7、直接内存\n&emsp;&emsp;它不属于虚拟机运行时数据区的一部分，但其也可能出现OOM，且使用频繁（如NIO类，引入了基于通道（Channel）与缓冲区（Buffer）的I/O方式，可使用Native函数直接分配堆外内存，然后通过一个存储在java堆中的DirectByteBuffer对象作为这块内存的引用进行操作，这样避免了在java堆与Native堆中来回复制数据从而提升了性能）。该区域使用超过机器内存等限制时会抛出OOM。\n8、元空间\n&emsp;&emsp;如示意图中所述，HotSpot在jdk8（含）之后，已经移除了老年代（方法区），转由元空间（metaspace）实现，即本地内存Native Memory。\n&emsp;&emsp;至于为什么使用本地内存替换永久代，官网有如此描述：This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.\n&emsp;&emsp;具体移除细节，官网由如此描述：The proposed implementation will allocate class meta-data in native memory and move interned Strings and class statics to the Java heap.\n&emsp;&emsp;详细信息参见官网地址http://openjdk.java.net/jeps/122\n\n----------------------------------\n\n## java对象\n \n&emsp;&emsp;前面聊完java对象身存的载体的具体结构，下面我们聊一聊java对象本身的一些事，需要说明的的是，此处是基于HotSpot探讨java对象在堆空间上实例的创建、布局以及访问。\n1、对象的创建\n&emsp;&emsp;从语言层面来讲，java对象的创建就是一个new关键字，当应用运行时，虚拟机遇到一条new指令，将进行如下操作：\n&emsp;&emsp;##检查类的加载：检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载、解析和初始化。\n&emsp;&emsp;##分配内存：java堆内存是否规整决定了如何分配内存，规整的内存，采用“指针碰撞”（Bump the Pointer），即从已用内存和空闲内存的指针分界点开始向空闲内存移动与对象大小相等的距离即可；如何内存不规整，则需要维护空闲列表（Free List），分配时从列表中选择足够大的空间划分给对象的实例。java堆是否规整与垃圾采集器是否带有压缩整理功能有关，如使用Serial、ParNew这种带Compact过程的收集器时采用指针碰撞，使用CMS这种基于Mark-Sweep算法的收集器时采用空闲列表。另外一个需要考虑的问题是线程安全，解决这个问题有两种方案，1是采用CAS保证原子性；2是为每个线程在java堆中预先分配一小块，即本地线程分配缓冲（TLAB），只需在分配新的TLAB时进行同步锁定，-XX：+/-UseTLAB。\n&emsp;&emsp;##初始化为0值：此处不包括对象头，这个操作保证了对象的实例可以不赋初始值即可使用。\n&emsp;&emsp;##对象头信息设置：对象头中包含如，这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄、锁等信息。\n&emsp;&emsp;##初始化（执行<init>方法）：一般来说，执行new指令之后会接着执行<init>方法（由字节码中是否跟随invokespecial指令决定），从而，一个真正可以使用的对象诞生。\n2、对象的内存布局\n&emsp;&emsp;HotSpot中，对象在内存中存储的布局分为3部分：对象头（Header）、实例数据（Instance Data）以及对齐填充（Padding）。\n&emsp;&emsp;##对象头：对象头包含两部分，1是用于存储对象自身的运行时数据Mark Work，在32位和64位的虚拟机中分别占32bit、64bit,包含信息如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向锁线程ID、偏向时间戳等。eg：32位未锁定状态的对象，25bit用于存储对象哈希码、4bit用于存储对象分代年龄、2bit用于存储锁标识位，1bit固定为0；2是类型指针，即对象指向它的类元数据的指针；对于数组来说，对象头还需有一块用于记录数组长度的数据从而确定数组的大小。\n&emsp;&emsp;##实例数据：HotSpot默认的分配策略为longs/doubles、ints、shorts/chars、bytes/boolean、oops（Oddinary Pointers），相同宽度的字段被分配在一起，父类定义的变量位于子类变量之前（如果CompactFields=true，子类较窄的变量也可能插入到父类变量的空隙中）。\n&emsp;&emsp;##对齐填充：HotSpot要求对象起始地址必须是8字节的整数倍，对象头正好符合，因此对象实例数据可用对齐填充来补全。\n3、对象的访问定位\n&emsp;&emsp;java程序需要通过栈上的reference数据来操作堆上的具体对象。\n&emsp;&emsp;##使用句柄访问：reference中存储的是对象的句柄地址，句柄中包含了对象实例数据与类型数据各自的具体地址，此方式，java堆划分出特定的内存作为句柄池。对象的定位需要两次指针定位，1次找到句柄、另1次找到具体的对象，好处则在于垃圾回收后，对象并移动，不用更改reference中的地址，只需更改句柄池中对应的地址。\n&emsp;&emsp;##使用直接指针访问：reference中存储的是对象地址。对象的定位一次就能找到，提升了性能，HotSpot采用此方案。\n4、对象的存活  \n&emsp;&emsp;前一部分提到，java程序通过栈上的reference数据操作堆上的对象，被操作的对象称之为被引用。对象是否存活与其是否尚被引用有关，那么我们首先来谈一谈引用。\n&emsp;&emsp;引用可分为强引用（Strong Reference）、软引用（Soft Reference）、弱引用（Weak Reference）、虚引用（Phantom Reference）。\n&emsp;&emsp;##强引用：类似于赋值语句那种，垃圾回收器不会回收被引用对象\n&emsp;&emsp;##软引用：jdk提供了SoftReference类实现软引用，指一些有用但并非必须的对象，系统OOM之前会回收此类对象\n&emsp;&emsp;##弱引用：jdk提供了WeakReference类实现弱引用，下一次GC时回收此类对象\n&emsp;&emsp;##虚引用：jdk提供了PhantomReference类实现虚引用，也称之为幽灵引用，对象是否存在虚引用对其本身无任何影响，且无法通过虚引用获得一个对象实例，因此，为对象设置一个虚引用的唯一目的是该对象被回收时收到一个系统通知\n&emsp;&emsp;下面来谈谈判断对象是否存活的两类算法：\n&emsp;&emsp;引用计数算法：给对象添加一个引用计算器，值为0时代表对象可回收，但，对于循环依赖来说，这似乎是个问题\n&emsp;&emsp;可达性分析算法：以一系列被称为GC Roots的对象（虚拟机栈即栈帧中本地变量表中引用的对象；方法区中类静态属性引用的对象；方法区中常量引用的对象；本地方法栈中JNI引用的对象）为起点进行搜索，判断对象是否有引用链到达GC Roots，如果没有，代表对象可回收。\n&emsp;&emsp;需要说明的是，利用可达性分析出不可达的对象，并不一定会立即回收，因为进行标记时会做一次筛选（条件是对象是否有必要执行finalize(),如果对象没有覆盖此方法或此方法被执行过一次，则不必要，否则会把此类对象放入一个F-Queue队列中由虚拟机自建一个低优先级的Finalizer线程去执行，为了避免执行缓慢，其并不会等待执行结果）。  \n\n----------------------------------\n\n## 垃圾回收\n \n&emsp;&emsp;再谈对象创建之内存分配\n&emsp;&emsp;这是一个及其重要的环节，且，根据垃圾回收机制的不同而有所差别，在聊垃圾回收之前，我想有必要就这点多说几句。\n&emsp;&emsp;##对象优先分配在Eden区域，即年轻代\n&emsp;&emsp;##大对象直接分配在老年代，需要说明的是何为大对象，不同收集器定义的不一样，Serial及ParNew收集器采用参数-XX:PretenureSizeThreshold指定，G1则默认为大于区域region大小一半的对象\n&emsp;&emsp;##长期存活的对象进入老年代，一般默认为熬过15次年轻代回收的对象，该值可以调整，具体参数名根据收集器的约定而定。另外，如果Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于等于该年龄的对象直接进入老年代（针对Serial及ParNew）\n&emsp;&emsp;##空间分配担保：只要老年代的连续空间大于新生代对象总大小或历次晋升的平局大小则进行MinorGC，否则进行Full GC（针对Serial及ParNew）\n&emsp;&emsp;前面大概聊了一下虚拟机内存区域以及java对象本身的那点事，这是一个java开发者必备的基础知识，因为你不仅仅应该知道Object obj = new Object（），你更应该清楚java对象究竟是如何诞生的，JVM在这里面做了什么，另一方面，你还应该清楚JVM又是如何替我们清理那些不再被引用的对象。\n&emsp;&emsp;首先，我们来简单聊聊垃圾收集算法：\n&emsp;&emsp;标记-清除（Mark-Sweep）算法：顾名思义，它包含两步，一是标记需要回收的对象，二是清除被标记的对象。但有两个明显的问题是，标记和清除两个环节效率都不高，其次，直接清除会导致内存碎片，这将导致大对象无法找到足够大小的连续空间来分配，从而提前下一次GC。\n&emsp;&emsp;复制（Copying）算法：将内存划分为几块，当一块内存用完后，把存活的对象移动至另一块，再把当前块已使用的空间一性清理掉。但这会导致预留的那部分空间分配时不能用。如HotSpot实现为，将内存分为Eden和两个Survivor，Eden：Survivro为8：1，即预留了10%的空间。需要指出的是，如果对象生命周期长，那么预留的空间也许会出现不够用，这时便需要其他内存进行分配担保（Handle Promotion），这里指的是老年代内存。因为需要额外的空间做担保，那么此算法不适合老年代回收。\n&emsp;&emsp;标记-整理（Mark-Compact）算法：完成标记后，让所有存活的对象向一端移动，然后直接清理掉端边界之外的内存。\n&emsp;&emsp;最后要说明的是，当前的商业虚拟机采用分代收集，即区分新生代和老年代，根据其不同特点搭配不通的垃圾收集算法，如年轻代使用复制算法，老年代使用标记-清除算法或标记-整理算法。\n&emsp;&emsp;HotSpot实现垃圾回收简介：\n&emsp;&emsp;##进行对象可达性分析时，要考虑一致性问题，因为对象的引用随着应用线程的运行不停的变更着，因此需要STW，由于STW对应用线程影响很大，各种垃圾回收器中对此做了通盘的考虑，但即使如CMS这种号称不会STW的收集器也无法避免枚举根节点时的GC停顿。另外，HotSpot设计了基于OopMap的数据结构来记录对象的引用以提升效率。\n&emsp;&emsp;安全点：为指令生产OopMap需要大量额外的空间，因此，HotSpot设计中并没为每条指令生成OopMap，只是在一些成为安全点的特定位置记录这些信息，即，只有当线程进入到安全点时才能暂停下来开始GC。安全点的选定是有讲究的，不可过多也不可过少，所以基本考虑在长时间执行的部分设置安全点，如方法调用、循环跳转、异常跳转等。对于线程在安全点如何停下来的问题，有两种手段，一是抢先式中断、二是主动式中断。HotSpot选择后者，即，GC设置中断标识，用户线程主动轮询是否需要中断，轮询标志的地方和安全点重合。\n&emsp;&emsp;安全区域：对于某些暂时未分配到CUP时间的线程，如其处于Sleep或Blocked状态，JVM不可能瞎等其得到CPU时间后跑到安全点，因此提供了安全区域解决该问题。安全区域中，引用关系不会发生变化，线程进去安全区域时会标识自己已进入，离开时，需要判断系统是否已经完成了根节点枚举或者整个GC过程，没有完成时需等待接收可以离开的信号。\n&emsp;&emsp;接下来我们来聊聊HotSpot定义的垃圾回收器，这是一个重要的话题，也是日常开发中我们最直接面对的课题，先上一个总图（这里代表的是jdk11之前的垃圾回收器，因为在jdk11中，oracle推出了号称很强大很强大的ZGC，支持TB级的内存回收及单次GC暂停时间低于10ms，目前未使用到该版本的jdk，也尚未对此回收器做研究）\n![upload successful](\\images\\pasted-80.png)\n&emsp;&emsp;##Serial收集器：单线程收集器，进行垃圾回收时需暂停其他所有线程，直到收集结束。比较老的收集器了，适用于Client模式的应用。采用复制算法\n![upload successful](\\images\\pasted-82.png)\n&emsp;&emsp;##ParNew收集器：Serial的多线程版本，默认开启的收集线程数与CPU的数量相同，可通过参数-XX:ParallelGCThreads控制。采用复制算法\n![upload successful](\\images\\pasted-84.png)\n&emsp;&emsp;##Serial Old收集器：其可作为Serial、ParNew及Parallel Scavenge的老年代收集器，同时，当CMS收集发生Concurrent Model Failure时，会使用Serail Old进行Full GC。采用标记-整理算法\n![upload successful](\\images\\pasted-82.png)\n&emsp;&emsp;##Parallel Scavenge收集器：更加关注吞吐量，即追求最大吞吐量，适用于那些需要大量计算的应用。使用参数-XX:MaxGCPauseMillis控制停顿时间，参数-XX:GCTimeRatio控制吞吐量（如默认99，即1/（1+99）为GC占CPU时间），开关参数-XX:UseAdaptiveSizePolicy打开后即开启了GC自适应调节策略，无需指定年轻代大小、Survivor大小或晋升老年代对象大小。采用复制算法\n![upload successful](\\images\\pasted-85.png)\n&emsp;&emsp;##Parallel Old收集器：于jdk1.6开始提供，作为Parallel Scavenge的老年代收集器。采用标记-整理算法\n![upload successful](\\images\\pasted-85.png)\n&emsp;&emsp;##CMS收集器：更加关注暂停时间，即追求最短暂停时间。其大概包含4个步骤，初始标记、并发标记、重新标记、并发清除，其中，初始标记主要是标记GC Roots能直接关联到的对象，这是一个很快的过程，需要STW，并发标记根据初始标记结果遍历上述对象所引用的对象，这个过程耗时较长但能与用户线程并行执行，重新标记则是修正并发标记过程中用户线程导致的变动，相对并发标记来说耗时是比较短的，需要STW，最后，并发清除也能与用户线程并行执行。需要指出的是，CMS存在一定的缺点，1是其对CPU资源很敏感，比如其并发阶段是占用了CPU资源（即用户线程占用CPU时间会减少），默认线程数为（CPU数量+3）/4；2是其无法处理浮动垃圾（Floating Garbage），导致会出现Concurrent Mode Failure，从而引起Full GC，引起的原因在于并发清理阶段用户线程的运行会产生新的垃圾需下一次GC才可处理，因此CMS开始回收的阈值为默认92%，避免浮动垃圾导致内存不够用而引起Full GC（这时会临时启用Serial Old回收老年代）；3是其基于标记-清除算法，意味着存在内存碎片，那么碎片过多会导致大对象无法分配而导致Full GC，因此有一个开关参数-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理（这是很耗时的）。采用标记-清除算法\n![upload successful](\\images\\pasted-86.png)\n&emsp;&emsp;##G1收集器：在暂停时间于吞吐量中权衡。采用G1回收器意味着java堆内存布局与其他回收器将有很大的不同，其将堆分成多个（默认2048个）大小相等的region区域（1M-32M）。注意，超过区域大小一半的对象被视为巨型对象直接分配在老年代。同时，G1维护了一个优先列表用于标识回收各区域的价值大小，从而做到了可预测停顿。同时为了避免全堆扫描对象引用，G1提供了Remembered Set用以维护对象的引用。G1回收大致包含如下4个步骤，初始标记、并发标记、最终标记及筛选回收，各步骤的大致功能与CMS类似。整体来看采用标记-整理算法，局部（region之间）来看采用了复制算法。\n![upload successful](\\images\\pasted-87.png)\n\n\n----------------------------------\n\n## 内存调优\n \n&emsp;&emsp;前面已经讲述了对象的诞生与消亡，在实际的工作中，我们日常开发或许并没有过多关注于这些细节，但有一项是我们时常直接接触到的，即，在应用内存使用不正常、应用运行慢时，我们往往会想到是否存在内存使用上的问题，并想办法进行内存调优。内存调优，它没有一个统一的解决方案，只能说其有相同的调优原则，再结合应用的实际情况针对性的优化，因此，要谈内存调优，更好的方式是从案例入手，在案例中阐述问题分析的过程，如何定位到内存上的问题，又如何进行针对性的调优。本博客中有相关案例，可参考https://realxc.github.io/tags/JVM/\n&emsp;&emsp;作为本篇文章的结尾，下面简单介绍一下我们常用的ParNew、CMS、G1回收器的常用且重要的参数配置：\nParNew：\n&emsp;&emsp;-XX:SurvivorRatio=8(默认)中年代占比1：8 sur：eden\n&emsp;&emsp;-XX:PretenureSizeThreshold 直接晋升到老年代的对象大小\n&emsp;&emsp;-XX:NewRatio=4(默认) 年轻代和老年代比例\nCMS\n&emsp;&emsp;-XX:CMSInitiatinOccupancyFraction=92 老年代达到92%时回收\n&emsp;&emsp;-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理\n&emsp;&emsp;-XX:UseConcMarkSweepGC\nG1\n&emsp;&emsp;-XX:+UseG1GC\n&emsp;&emsp;-XX:MaxGCPauseMillis=n 单次GC暂停时间，默认200ms\n&emsp;&emsp;-XX:InitiatingHeapOccupancyPercent=n mix gc触发时间，老年代已使用空间占用整堆内存比例，默认45（很多人理解为整堆已使用空间占整堆比例，这是错误的）\n&emsp;&emsp;-XX:MaxTenuringThreshold=n 年轻代最大年龄，默认15\n&emsp;&emsp;-XX:G1ReservePercent=n 预留空间大小，避免空间被使用完而导致Full GC\n&emsp;&emsp;-XX:G1HeapRegionSize=n 区域大小，1-32（M）\n&emsp;&emsp;-XX:G1NewSizePercent=5 默认为5，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75\n&emsp;&emsp;-XX:G1MaxNewSizePercent=60 默认为60，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75\n\n----------------------------------\n参考参数（jdk8）：\n(G1): -XX:+UseG1GC -XX:MaxGCPauseMillis=50（自定义） -Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:LargePageSizeInBytes=128m（自定义） -XX:+ParallelRefProcEnabled -XX:+PrintAdaptiveSizePolicy -XX:+UseFastAccessorMethods -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000  -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof\n\n----------------------------------\n(CMS):-Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:SurvivorRatio=8（自定义） -XX:NewRatio=4（自定义） -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m（自定义） -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70（自定义） -XX:+UseParNewGC -XX:MaxTenuringThreshold=5（自定义） -XX:+CMSClassUnloadingEnabled -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000 -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof\n\nhttps://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html\nhttps://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock\n\t\t\t\n----------------------------------","slug":"浅谈JVM之垃圾回收","published":1,"updated":"2019-09-30T07:34:10.840Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckuhs2vct006qwy66bask2cd4","content":"<h2 id=\"说在前面\"><a href=\"#说在前面\" class=\"headerlink\" title=\"说在前面\"></a>说在前面</h2><p>&emsp;&emsp;本文将从java对象的角度出发，探讨java应用运行过程中“对象”从诞生到消亡的生命历程，结合jvm的相关技术方案简要阐述各个环节的实现细节。需要指出的是，本文旨在阐述清楚“对象”的生命周期，对于jvm（本文基于HotSpot虚拟机）相关技术的深层次原理只会点到为止（能描述清“对象”的生命周期即可），后续将会在其他文章中单独罗列出各个主题进行深入剖析。</p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><ul>\n<li><a href=\"#partI\">java内存区域</a></li>\n<li><a href=\"#partII\">java对象</a></li>\n<li><a href=\"#partIII\">垃圾回收</a></li>\n<li><a href=\"#partIV\">内存调优</a></li>\n</ul>\n<hr>\n<h2 id=\"java内存区域\"><a href=\"#java内存区域\" class=\"headerlink\" title=\"java内存区域\"></a>java内存区域</h2><p>&emsp;&emsp;java对象生存的载体-运行时数据区，虚拟机中数据区大致包含如下图所示的几个区域：<br><img src=\"\\images\\pasted-74.png\" alt=\"upload successful\"><br>1、程序计数器<br>&emsp;&emsp;当前线程所执行的字节码的行号指示器，标识执行到的节点，这是一块较小的内存空间。由于任何时刻，一个处理器（多核处理器中的某一核）只会执行一个线程中的指令，因此，每个线程都有一个独立、私有的程序计数器。此区域（唯一一个）在java虚拟机规范中没有规定任何OOM的情况。<br>2、虚拟机栈<br>&emsp;&emsp;其生命周期与线程相同，方法在执行时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息，每一个方法的调用就是相应栈帧在虚拟机栈中入栈和出栈的过程。<br>局部变量表：存放编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（指向对象起始地址的引用指针-HotSpot方案、或者指向一个代表对象的句柄或其他与此对象相关的位置）、returnAddress类型（执行一条字节码指令的地址）。其中，除long和double占用2个局部变量空间（Slot）外，其余只占用1个Slot。局部变量表所需内存空间在编译期间完成分配，运行期间不会改变大小，即，进入一个方法时，栈帧中所需分配的局部变量空间是确定的。java虚拟机规范对此区域规定了两类异常情况，1是线程请求的栈深度大于虚拟机所允许的深度时抛出StackOverflowError，2是可动态扩展的虚拟机栈扩展时无法申请到足够的内存时抛出OOM。<br>3、本地方法栈<br>&emsp;&emsp;HotSpot将其与虚拟机栈合二为一。它是为虚拟机所使用到的Native方法服务。它可能抛出的异常与虚拟机栈一致。<br>4、堆<br>&emsp;&emsp;此区域用于存放对象的实例。java虚拟机规范原文：The heap is the runtime data area from which memory for all class instances and arrays is allocated.此区域会抛出OOM异常。由于这个区域存分的是对象实例且是线程共享区域，因此在后续的内容中将以此为核心进行讲述。<br>5、方法区（HotSpot，jdk8之后已由元空间取代）<br>&emsp;&emsp;该区域用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，为了与java堆区分开来，java虚拟机规范为其命了一个别名Non-Heap。该区域会抛出OOM。<br>6、运行时常量池<br>&emsp;&emsp;方法区的一部分，Clas文件中除了由类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译期生产的各种字面量和符号引用。除了编译期间会产生常量，java允许运行期间产生常量并存放到运行时常量池中，如String.intern()。该区域是方法区的一部分，因此申请不到内存时也会抛出OOM。<br>7、直接内存<br>&emsp;&emsp;它不属于虚拟机运行时数据区的一部分，但其也可能出现OOM，且使用频繁（如NIO类，引入了基于通道（Channel）与缓冲区（Buffer）的I/O方式，可使用Native函数直接分配堆外内存，然后通过一个存储在java堆中的DirectByteBuffer对象作为这块内存的引用进行操作，这样避免了在java堆与Native堆中来回复制数据从而提升了性能）。该区域使用超过机器内存等限制时会抛出OOM。<br>8、元空间<br>&emsp;&emsp;如示意图中所述，HotSpot在jdk8（含）之后，已经移除了老年代（方法区），转由元空间（metaspace）实现，即本地内存Native Memory。<br>&emsp;&emsp;至于为什么使用本地内存替换永久代，官网有如此描述：This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.<br>&emsp;&emsp;具体移除细节，官网由如此描述：The proposed implementation will allocate class meta-data in native memory and move interned Strings and class statics to the Java heap.<br>&emsp;&emsp;详细信息参见官网地址<a href=\"http://openjdk.java.net/jeps/122\">http://openjdk.java.net/jeps/122</a></p>\n<hr>\n<h2 id=\"java对象\"><a href=\"#java对象\" class=\"headerlink\" title=\"java对象\"></a>java对象</h2><p>&emsp;&emsp;前面聊完java对象身存的载体的具体结构，下面我们聊一聊java对象本身的一些事，需要说明的的是，此处是基于HotSpot探讨java对象在堆空间上实例的创建、布局以及访问。<br>1、对象的创建<br>&emsp;&emsp;从语言层面来讲，java对象的创建就是一个new关键字，当应用运行时，虚拟机遇到一条new指令，将进行如下操作：<br>&emsp;&emsp;##检查类的加载：检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载、解析和初始化。<br>&emsp;&emsp;##分配内存：java堆内存是否规整决定了如何分配内存，规整的内存，采用“指针碰撞”（Bump the Pointer），即从已用内存和空闲内存的指针分界点开始向空闲内存移动与对象大小相等的距离即可；如何内存不规整，则需要维护空闲列表（Free List），分配时从列表中选择足够大的空间划分给对象的实例。java堆是否规整与垃圾采集器是否带有压缩整理功能有关，如使用Serial、ParNew这种带Compact过程的收集器时采用指针碰撞，使用CMS这种基于Mark-Sweep算法的收集器时采用空闲列表。另外一个需要考虑的问题是线程安全，解决这个问题有两种方案，1是采用CAS保证原子性；2是为每个线程在java堆中预先分配一小块，即本地线程分配缓冲（TLAB），只需在分配新的TLAB时进行同步锁定，-XX：+/-UseTLAB。<br>&emsp;&emsp;##初始化为0值：此处不包括对象头，这个操作保证了对象的实例可以不赋初始值即可使用。<br>&emsp;&emsp;##对象头信息设置：对象头中包含如，这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄、锁等信息。<br>&emsp;&emsp;##初始化（执行<init>方法）：一般来说，执行new指令之后会接着执行<init>方法（由字节码中是否跟随invokespecial指令决定），从而，一个真正可以使用的对象诞生。<br>2、对象的内存布局<br>&emsp;&emsp;HotSpot中，对象在内存中存储的布局分为3部分：对象头（Header）、实例数据（Instance Data）以及对齐填充（Padding）。<br>&emsp;&emsp;##对象头：对象头包含两部分，1是用于存储对象自身的运行时数据Mark Work，在32位和64位的虚拟机中分别占32bit、64bit,包含信息如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向锁线程ID、偏向时间戳等。eg：32位未锁定状态的对象，25bit用于存储对象哈希码、4bit用于存储对象分代年龄、2bit用于存储锁标识位，1bit固定为0；2是类型指针，即对象指向它的类元数据的指针；对于数组来说，对象头还需有一块用于记录数组长度的数据从而确定数组的大小。<br>&emsp;&emsp;##实例数据：HotSpot默认的分配策略为longs/doubles、ints、shorts/chars、bytes/boolean、oops（Oddinary Pointers），相同宽度的字段被分配在一起，父类定义的变量位于子类变量之前（如果CompactFields=true，子类较窄的变量也可能插入到父类变量的空隙中）。<br>&emsp;&emsp;##对齐填充：HotSpot要求对象起始地址必须是8字节的整数倍，对象头正好符合，因此对象实例数据可用对齐填充来补全。<br>3、对象的访问定位<br>&emsp;&emsp;java程序需要通过栈上的reference数据来操作堆上的具体对象。<br>&emsp;&emsp;##使用句柄访问：reference中存储的是对象的句柄地址，句柄中包含了对象实例数据与类型数据各自的具体地址，此方式，java堆划分出特定的内存作为句柄池。对象的定位需要两次指针定位，1次找到句柄、另1次找到具体的对象，好处则在于垃圾回收后，对象并移动，不用更改reference中的地址，只需更改句柄池中对应的地址。<br>&emsp;&emsp;##使用直接指针访问：reference中存储的是对象地址。对象的定位一次就能找到，提升了性能，HotSpot采用此方案。<br>4、对象的存活<br>&emsp;&emsp;前一部分提到，java程序通过栈上的reference数据操作堆上的对象，被操作的对象称之为被引用。对象是否存活与其是否尚被引用有关，那么我们首先来谈一谈引用。<br>&emsp;&emsp;引用可分为强引用（Strong Reference）、软引用（Soft Reference）、弱引用（Weak Reference）、虚引用（Phantom Reference）。<br>&emsp;&emsp;##强引用：类似于赋值语句那种，垃圾回收器不会回收被引用对象<br>&emsp;&emsp;##软引用：jdk提供了SoftReference类实现软引用，指一些有用但并非必须的对象，系统OOM之前会回收此类对象<br>&emsp;&emsp;##弱引用：jdk提供了WeakReference类实现弱引用，下一次GC时回收此类对象<br>&emsp;&emsp;##虚引用：jdk提供了PhantomReference类实现虚引用，也称之为幽灵引用，对象是否存在虚引用对其本身无任何影响，且无法通过虚引用获得一个对象实例，因此，为对象设置一个虚引用的唯一目的是该对象被回收时收到一个系统通知<br>&emsp;&emsp;下面来谈谈判断对象是否存活的两类算法：<br>&emsp;&emsp;引用计数算法：给对象添加一个引用计算器，值为0时代表对象可回收，但，对于循环依赖来说，这似乎是个问题<br>&emsp;&emsp;可达性分析算法：以一系列被称为GC Roots的对象（虚拟机栈即栈帧中本地变量表中引用的对象；方法区中类静态属性引用的对象；方法区中常量引用的对象；本地方法栈中JNI引用的对象）为起点进行搜索，判断对象是否有引用链到达GC Roots，如果没有，代表对象可回收。<br>&emsp;&emsp;需要说明的是，利用可达性分析出不可达的对象，并不一定会立即回收，因为进行标记时会做一次筛选（条件是对象是否有必要执行finalize(),如果对象没有覆盖此方法或此方法被执行过一次，则不必要，否则会把此类对象放入一个F-Queue队列中由虚拟机自建一个低优先级的Finalizer线程去执行，为了避免执行缓慢，其并不会等待执行结果）。  </p>\n<hr>\n<h2 id=\"垃圾回收\"><a href=\"#垃圾回收\" class=\"headerlink\" title=\"垃圾回收\"></a>垃圾回收</h2><p>&emsp;&emsp;再谈对象创建之内存分配<br>&emsp;&emsp;这是一个及其重要的环节，且，根据垃圾回收机制的不同而有所差别，在聊垃圾回收之前，我想有必要就这点多说几句。<br>&emsp;&emsp;##对象优先分配在Eden区域，即年轻代<br>&emsp;&emsp;##大对象直接分配在老年代，需要说明的是何为大对象，不同收集器定义的不一样，Serial及ParNew收集器采用参数-XX:PretenureSizeThreshold指定，G1则默认为大于区域region大小一半的对象<br>&emsp;&emsp;##长期存活的对象进入老年代，一般默认为熬过15次年轻代回收的对象，该值可以调整，具体参数名根据收集器的约定而定。另外，如果Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于等于该年龄的对象直接进入老年代（针对Serial及ParNew）<br>&emsp;&emsp;##空间分配担保：只要老年代的连续空间大于新生代对象总大小或历次晋升的平局大小则进行MinorGC，否则进行Full GC（针对Serial及ParNew）<br>&emsp;&emsp;前面大概聊了一下虚拟机内存区域以及java对象本身的那点事，这是一个java开发者必备的基础知识，因为你不仅仅应该知道Object obj = new Object（），你更应该清楚java对象究竟是如何诞生的，JVM在这里面做了什么，另一方面，你还应该清楚JVM又是如何替我们清理那些不再被引用的对象。<br>&emsp;&emsp;首先，我们来简单聊聊垃圾收集算法：<br>&emsp;&emsp;标记-清除（Mark-Sweep）算法：顾名思义，它包含两步，一是标记需要回收的对象，二是清除被标记的对象。但有两个明显的问题是，标记和清除两个环节效率都不高，其次，直接清除会导致内存碎片，这将导致大对象无法找到足够大小的连续空间来分配，从而提前下一次GC。<br>&emsp;&emsp;复制（Copying）算法：将内存划分为几块，当一块内存用完后，把存活的对象移动至另一块，再把当前块已使用的空间一性清理掉。但这会导致预留的那部分空间分配时不能用。如HotSpot实现为，将内存分为Eden和两个Survivor，Eden：Survivro为8：1，即预留了10%的空间。需要指出的是，如果对象生命周期长，那么预留的空间也许会出现不够用，这时便需要其他内存进行分配担保（Handle Promotion），这里指的是老年代内存。因为需要额外的空间做担保，那么此算法不适合老年代回收。<br>&emsp;&emsp;标记-整理（Mark-Compact）算法：完成标记后，让所有存活的对象向一端移动，然后直接清理掉端边界之外的内存。<br>&emsp;&emsp;最后要说明的是，当前的商业虚拟机采用分代收集，即区分新生代和老年代，根据其不同特点搭配不通的垃圾收集算法，如年轻代使用复制算法，老年代使用标记-清除算法或标记-整理算法。<br>&emsp;&emsp;HotSpot实现垃圾回收简介：<br>&emsp;&emsp;##进行对象可达性分析时，要考虑一致性问题，因为对象的引用随着应用线程的运行不停的变更着，因此需要STW，由于STW对应用线程影响很大，各种垃圾回收器中对此做了通盘的考虑，但即使如CMS这种号称不会STW的收集器也无法避免枚举根节点时的GC停顿。另外，HotSpot设计了基于OopMap的数据结构来记录对象的引用以提升效率。<br>&emsp;&emsp;安全点：为指令生产OopMap需要大量额外的空间，因此，HotSpot设计中并没为每条指令生成OopMap，只是在一些成为安全点的特定位置记录这些信息，即，只有当线程进入到安全点时才能暂停下来开始GC。安全点的选定是有讲究的，不可过多也不可过少，所以基本考虑在长时间执行的部分设置安全点，如方法调用、循环跳转、异常跳转等。对于线程在安全点如何停下来的问题，有两种手段，一是抢先式中断、二是主动式中断。HotSpot选择后者，即，GC设置中断标识，用户线程主动轮询是否需要中断，轮询标志的地方和安全点重合。<br>&emsp;&emsp;安全区域：对于某些暂时未分配到CUP时间的线程，如其处于Sleep或Blocked状态，JVM不可能瞎等其得到CPU时间后跑到安全点，因此提供了安全区域解决该问题。安全区域中，引用关系不会发生变化，线程进去安全区域时会标识自己已进入，离开时，需要判断系统是否已经完成了根节点枚举或者整个GC过程，没有完成时需等待接收可以离开的信号。<br>&emsp;&emsp;接下来我们来聊聊HotSpot定义的垃圾回收器，这是一个重要的话题，也是日常开发中我们最直接面对的课题，先上一个总图（这里代表的是jdk11之前的垃圾回收器，因为在jdk11中，oracle推出了号称很强大很强大的ZGC，支持TB级的内存回收及单次GC暂停时间低于10ms，目前未使用到该版本的jdk，也尚未对此回收器做研究）<br><img src=\"\\images\\pasted-80.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Serial收集器：单线程收集器，进行垃圾回收时需暂停其他所有线程，直到收集结束。比较老的收集器了，适用于Client模式的应用。采用复制算法<br><img src=\"\\images\\pasted-82.png\" alt=\"upload successful\"><br>&emsp;&emsp;##ParNew收集器：Serial的多线程版本，默认开启的收集线程数与CPU的数量相同，可通过参数-XX:ParallelGCThreads控制。采用复制算法<br><img src=\"\\images\\pasted-84.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Serial Old收集器：其可作为Serial、ParNew及Parallel Scavenge的老年代收集器，同时，当CMS收集发生Concurrent Model Failure时，会使用Serail Old进行Full GC。采用标记-整理算法<br><img src=\"\\images\\pasted-82.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Parallel Scavenge收集器：更加关注吞吐量，即追求最大吞吐量，适用于那些需要大量计算的应用。使用参数-XX:MaxGCPauseMillis控制停顿时间，参数-XX:GCTimeRatio控制吞吐量（如默认99，即1/（1+99）为GC占CPU时间），开关参数-XX:UseAdaptiveSizePolicy打开后即开启了GC自适应调节策略，无需指定年轻代大小、Survivor大小或晋升老年代对象大小。采用复制算法<br><img src=\"\\images\\pasted-85.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Parallel Old收集器：于jdk1.6开始提供，作为Parallel Scavenge的老年代收集器。采用标记-整理算法<br><img src=\"\\images\\pasted-85.png\" alt=\"upload successful\"><br>&emsp;&emsp;##CMS收集器：更加关注暂停时间，即追求最短暂停时间。其大概包含4个步骤，初始标记、并发标记、重新标记、并发清除，其中，初始标记主要是标记GC Roots能直接关联到的对象，这是一个很快的过程，需要STW，并发标记根据初始标记结果遍历上述对象所引用的对象，这个过程耗时较长但能与用户线程并行执行，重新标记则是修正并发标记过程中用户线程导致的变动，相对并发标记来说耗时是比较短的，需要STW，最后，并发清除也能与用户线程并行执行。需要指出的是，CMS存在一定的缺点，1是其对CPU资源很敏感，比如其并发阶段是占用了CPU资源（即用户线程占用CPU时间会减少），默认线程数为（CPU数量+3）/4；2是其无法处理浮动垃圾（Floating Garbage），导致会出现Concurrent Mode Failure，从而引起Full GC，引起的原因在于并发清理阶段用户线程的运行会产生新的垃圾需下一次GC才可处理，因此CMS开始回收的阈值为默认92%，避免浮动垃圾导致内存不够用而引起Full GC（这时会临时启用Serial Old回收老年代）；3是其基于标记-清除算法，意味着存在内存碎片，那么碎片过多会导致大对象无法分配而导致Full GC，因此有一个开关参数-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理（这是很耗时的）。采用标记-清除算法<br><img src=\"\\images\\pasted-86.png\" alt=\"upload successful\"><br>&emsp;&emsp;##G1收集器：在暂停时间于吞吐量中权衡。采用G1回收器意味着java堆内存布局与其他回收器将有很大的不同，其将堆分成多个（默认2048个）大小相等的region区域（1M-32M）。注意，超过区域大小一半的对象被视为巨型对象直接分配在老年代。同时，G1维护了一个优先列表用于标识回收各区域的价值大小，从而做到了可预测停顿。同时为了避免全堆扫描对象引用，G1提供了Remembered Set用以维护对象的引用。G1回收大致包含如下4个步骤，初始标记、并发标记、最终标记及筛选回收，各步骤的大致功能与CMS类似。整体来看采用标记-整理算法，局部（region之间）来看采用了复制算法。<br><img src=\"\\images\\pasted-87.png\" alt=\"upload successful\"></p>\n<hr>\n<h2 id=\"内存调优\"><a href=\"#内存调优\" class=\"headerlink\" title=\"内存调优\"></a>内存调优</h2><p>&emsp;&emsp;前面已经讲述了对象的诞生与消亡，在实际的工作中，我们日常开发或许并没有过多关注于这些细节，但有一项是我们时常直接接触到的，即，在应用内存使用不正常、应用运行慢时，我们往往会想到是否存在内存使用上的问题，并想办法进行内存调优。内存调优，它没有一个统一的解决方案，只能说其有相同的调优原则，再结合应用的实际情况针对性的优化，因此，要谈内存调优，更好的方式是从案例入手，在案例中阐述问题分析的过程，如何定位到内存上的问题，又如何进行针对性的调优。本博客中有相关案例，可参考<a href=\"https://realxc.github.io/tags/JVM/\">https://realxc.github.io/tags/JVM/</a><br>&emsp;&emsp;作为本篇文章的结尾，下面简单介绍一下我们常用的ParNew、CMS、G1回收器的常用且重要的参数配置：<br>ParNew：<br>&emsp;&emsp;-XX:SurvivorRatio=8(默认)中年代占比1：8 sur：eden<br>&emsp;&emsp;-XX:PretenureSizeThreshold 直接晋升到老年代的对象大小<br>&emsp;&emsp;-XX:NewRatio=4(默认) 年轻代和老年代比例<br>CMS<br>&emsp;&emsp;-XX:CMSInitiatinOccupancyFraction=92 老年代达到92%时回收<br>&emsp;&emsp;-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理<br>&emsp;&emsp;-XX:UseConcMarkSweepGC<br>G1<br>&emsp;&emsp;-XX:+UseG1GC<br>&emsp;&emsp;-XX:MaxGCPauseMillis=n 单次GC暂停时间，默认200ms<br>&emsp;&emsp;-XX:InitiatingHeapOccupancyPercent=n mix gc触发时间，老年代已使用空间占用整堆内存比例，默认45（很多人理解为整堆已使用空间占整堆比例，这是错误的）<br>&emsp;&emsp;-XX:MaxTenuringThreshold=n 年轻代最大年龄，默认15<br>&emsp;&emsp;-XX:G1ReservePercent=n 预留空间大小，避免空间被使用完而导致Full GC<br>&emsp;&emsp;-XX:G1HeapRegionSize=n 区域大小，1-32（M）<br>&emsp;&emsp;-XX:G1NewSizePercent=5 默认为5，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75<br>&emsp;&emsp;-XX:G1MaxNewSizePercent=60 默认为60，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75</p>\n<hr>\n<p>参考参数（jdk8）：<br>(G1): -XX:+UseG1GC -XX:MaxGCPauseMillis=50（自定义） -Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:LargePageSizeInBytes=128m（自定义） -XX:+ParallelRefProcEnabled -XX:+PrintAdaptiveSizePolicy -XX:+UseFastAccessorMethods -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000  -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof</p>\n<hr>\n<p>(CMS):-Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:SurvivorRatio=8（自定义） -XX:NewRatio=4（自定义） -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m（自定义） -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70（自定义） -XX:+UseParNewGC -XX:MaxTenuringThreshold=5（自定义） -XX:+CMSClassUnloadingEnabled -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000 -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof</p>\n<p><a href=\"https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html\">https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a><br><a href=\"https://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock\">https://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock</a></p>\n<hr>\n","site":{"data":{}},"length":10956,"excerpt":"","more":"<h2 id=\"说在前面\"><a href=\"#说在前面\" class=\"headerlink\" title=\"说在前面\"></a>说在前面</h2><p>&emsp;&emsp;本文将从java对象的角度出发，探讨java应用运行过程中“对象”从诞生到消亡的生命历程，结合jvm的相关技术方案简要阐述各个环节的实现细节。需要指出的是，本文旨在阐述清楚“对象”的生命周期，对于jvm（本文基于HotSpot虚拟机）相关技术的深层次原理只会点到为止（能描述清“对象”的生命周期即可），后续将会在其他文章中单独罗列出各个主题进行深入剖析。</p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><ul>\n<li><a href=\"#partI\">java内存区域</a></li>\n<li><a href=\"#partII\">java对象</a></li>\n<li><a href=\"#partIII\">垃圾回收</a></li>\n<li><a href=\"#partIV\">内存调优</a></li>\n</ul>\n<hr>\n<h2 id=\"java内存区域\"><a href=\"#java内存区域\" class=\"headerlink\" title=\"java内存区域\"></a>java内存区域</h2><p>&emsp;&emsp;java对象生存的载体-运行时数据区，虚拟机中数据区大致包含如下图所示的几个区域：<br><img src=\"\\images\\pasted-74.png\" alt=\"upload successful\"><br>1、程序计数器<br>&emsp;&emsp;当前线程所执行的字节码的行号指示器，标识执行到的节点，这是一块较小的内存空间。由于任何时刻，一个处理器（多核处理器中的某一核）只会执行一个线程中的指令，因此，每个线程都有一个独立、私有的程序计数器。此区域（唯一一个）在java虚拟机规范中没有规定任何OOM的情况。<br>2、虚拟机栈<br>&emsp;&emsp;其生命周期与线程相同，方法在执行时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息，每一个方法的调用就是相应栈帧在虚拟机栈中入栈和出栈的过程。<br>局部变量表：存放编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（指向对象起始地址的引用指针-HotSpot方案、或者指向一个代表对象的句柄或其他与此对象相关的位置）、returnAddress类型（执行一条字节码指令的地址）。其中，除long和double占用2个局部变量空间（Slot）外，其余只占用1个Slot。局部变量表所需内存空间在编译期间完成分配，运行期间不会改变大小，即，进入一个方法时，栈帧中所需分配的局部变量空间是确定的。java虚拟机规范对此区域规定了两类异常情况，1是线程请求的栈深度大于虚拟机所允许的深度时抛出StackOverflowError，2是可动态扩展的虚拟机栈扩展时无法申请到足够的内存时抛出OOM。<br>3、本地方法栈<br>&emsp;&emsp;HotSpot将其与虚拟机栈合二为一。它是为虚拟机所使用到的Native方法服务。它可能抛出的异常与虚拟机栈一致。<br>4、堆<br>&emsp;&emsp;此区域用于存放对象的实例。java虚拟机规范原文：The heap is the runtime data area from which memory for all class instances and arrays is allocated.此区域会抛出OOM异常。由于这个区域存分的是对象实例且是线程共享区域，因此在后续的内容中将以此为核心进行讲述。<br>5、方法区（HotSpot，jdk8之后已由元空间取代）<br>&emsp;&emsp;该区域用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，为了与java堆区分开来，java虚拟机规范为其命了一个别名Non-Heap。该区域会抛出OOM。<br>6、运行时常量池<br>&emsp;&emsp;方法区的一部分，Clas文件中除了由类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译期生产的各种字面量和符号引用。除了编译期间会产生常量，java允许运行期间产生常量并存放到运行时常量池中，如String.intern()。该区域是方法区的一部分，因此申请不到内存时也会抛出OOM。<br>7、直接内存<br>&emsp;&emsp;它不属于虚拟机运行时数据区的一部分，但其也可能出现OOM，且使用频繁（如NIO类，引入了基于通道（Channel）与缓冲区（Buffer）的I/O方式，可使用Native函数直接分配堆外内存，然后通过一个存储在java堆中的DirectByteBuffer对象作为这块内存的引用进行操作，这样避免了在java堆与Native堆中来回复制数据从而提升了性能）。该区域使用超过机器内存等限制时会抛出OOM。<br>8、元空间<br>&emsp;&emsp;如示意图中所述，HotSpot在jdk8（含）之后，已经移除了老年代（方法区），转由元空间（metaspace）实现，即本地内存Native Memory。<br>&emsp;&emsp;至于为什么使用本地内存替换永久代，官网有如此描述：This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.<br>&emsp;&emsp;具体移除细节，官网由如此描述：The proposed implementation will allocate class meta-data in native memory and move interned Strings and class statics to the Java heap.<br>&emsp;&emsp;详细信息参见官网地址<a href=\"http://openjdk.java.net/jeps/122\">http://openjdk.java.net/jeps/122</a></p>\n<hr>\n<h2 id=\"java对象\"><a href=\"#java对象\" class=\"headerlink\" title=\"java对象\"></a>java对象</h2><p>&emsp;&emsp;前面聊完java对象身存的载体的具体结构，下面我们聊一聊java对象本身的一些事，需要说明的的是，此处是基于HotSpot探讨java对象在堆空间上实例的创建、布局以及访问。<br>1、对象的创建<br>&emsp;&emsp;从语言层面来讲，java对象的创建就是一个new关键字，当应用运行时，虚拟机遇到一条new指令，将进行如下操作：<br>&emsp;&emsp;##检查类的加载：检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载、解析和初始化。<br>&emsp;&emsp;##分配内存：java堆内存是否规整决定了如何分配内存，规整的内存，采用“指针碰撞”（Bump the Pointer），即从已用内存和空闲内存的指针分界点开始向空闲内存移动与对象大小相等的距离即可；如何内存不规整，则需要维护空闲列表（Free List），分配时从列表中选择足够大的空间划分给对象的实例。java堆是否规整与垃圾采集器是否带有压缩整理功能有关，如使用Serial、ParNew这种带Compact过程的收集器时采用指针碰撞，使用CMS这种基于Mark-Sweep算法的收集器时采用空闲列表。另外一个需要考虑的问题是线程安全，解决这个问题有两种方案，1是采用CAS保证原子性；2是为每个线程在java堆中预先分配一小块，即本地线程分配缓冲（TLAB），只需在分配新的TLAB时进行同步锁定，-XX：+/-UseTLAB。<br>&emsp;&emsp;##初始化为0值：此处不包括对象头，这个操作保证了对象的实例可以不赋初始值即可使用。<br>&emsp;&emsp;##对象头信息设置：对象头中包含如，这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄、锁等信息。<br>&emsp;&emsp;##初始化（执行<init>方法）：一般来说，执行new指令之后会接着执行<init>方法（由字节码中是否跟随invokespecial指令决定），从而，一个真正可以使用的对象诞生。<br>2、对象的内存布局<br>&emsp;&emsp;HotSpot中，对象在内存中存储的布局分为3部分：对象头（Header）、实例数据（Instance Data）以及对齐填充（Padding）。<br>&emsp;&emsp;##对象头：对象头包含两部分，1是用于存储对象自身的运行时数据Mark Work，在32位和64位的虚拟机中分别占32bit、64bit,包含信息如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向锁线程ID、偏向时间戳等。eg：32位未锁定状态的对象，25bit用于存储对象哈希码、4bit用于存储对象分代年龄、2bit用于存储锁标识位，1bit固定为0；2是类型指针，即对象指向它的类元数据的指针；对于数组来说，对象头还需有一块用于记录数组长度的数据从而确定数组的大小。<br>&emsp;&emsp;##实例数据：HotSpot默认的分配策略为longs/doubles、ints、shorts/chars、bytes/boolean、oops（Oddinary Pointers），相同宽度的字段被分配在一起，父类定义的变量位于子类变量之前（如果CompactFields=true，子类较窄的变量也可能插入到父类变量的空隙中）。<br>&emsp;&emsp;##对齐填充：HotSpot要求对象起始地址必须是8字节的整数倍，对象头正好符合，因此对象实例数据可用对齐填充来补全。<br>3、对象的访问定位<br>&emsp;&emsp;java程序需要通过栈上的reference数据来操作堆上的具体对象。<br>&emsp;&emsp;##使用句柄访问：reference中存储的是对象的句柄地址，句柄中包含了对象实例数据与类型数据各自的具体地址，此方式，java堆划分出特定的内存作为句柄池。对象的定位需要两次指针定位，1次找到句柄、另1次找到具体的对象，好处则在于垃圾回收后，对象并移动，不用更改reference中的地址，只需更改句柄池中对应的地址。<br>&emsp;&emsp;##使用直接指针访问：reference中存储的是对象地址。对象的定位一次就能找到，提升了性能，HotSpot采用此方案。<br>4、对象的存活<br>&emsp;&emsp;前一部分提到，java程序通过栈上的reference数据操作堆上的对象，被操作的对象称之为被引用。对象是否存活与其是否尚被引用有关，那么我们首先来谈一谈引用。<br>&emsp;&emsp;引用可分为强引用（Strong Reference）、软引用（Soft Reference）、弱引用（Weak Reference）、虚引用（Phantom Reference）。<br>&emsp;&emsp;##强引用：类似于赋值语句那种，垃圾回收器不会回收被引用对象<br>&emsp;&emsp;##软引用：jdk提供了SoftReference类实现软引用，指一些有用但并非必须的对象，系统OOM之前会回收此类对象<br>&emsp;&emsp;##弱引用：jdk提供了WeakReference类实现弱引用，下一次GC时回收此类对象<br>&emsp;&emsp;##虚引用：jdk提供了PhantomReference类实现虚引用，也称之为幽灵引用，对象是否存在虚引用对其本身无任何影响，且无法通过虚引用获得一个对象实例，因此，为对象设置一个虚引用的唯一目的是该对象被回收时收到一个系统通知<br>&emsp;&emsp;下面来谈谈判断对象是否存活的两类算法：<br>&emsp;&emsp;引用计数算法：给对象添加一个引用计算器，值为0时代表对象可回收，但，对于循环依赖来说，这似乎是个问题<br>&emsp;&emsp;可达性分析算法：以一系列被称为GC Roots的对象（虚拟机栈即栈帧中本地变量表中引用的对象；方法区中类静态属性引用的对象；方法区中常量引用的对象；本地方法栈中JNI引用的对象）为起点进行搜索，判断对象是否有引用链到达GC Roots，如果没有，代表对象可回收。<br>&emsp;&emsp;需要说明的是，利用可达性分析出不可达的对象，并不一定会立即回收，因为进行标记时会做一次筛选（条件是对象是否有必要执行finalize(),如果对象没有覆盖此方法或此方法被执行过一次，则不必要，否则会把此类对象放入一个F-Queue队列中由虚拟机自建一个低优先级的Finalizer线程去执行，为了避免执行缓慢，其并不会等待执行结果）。  </p>\n<hr>\n<h2 id=\"垃圾回收\"><a href=\"#垃圾回收\" class=\"headerlink\" title=\"垃圾回收\"></a>垃圾回收</h2><p>&emsp;&emsp;再谈对象创建之内存分配<br>&emsp;&emsp;这是一个及其重要的环节，且，根据垃圾回收机制的不同而有所差别，在聊垃圾回收之前，我想有必要就这点多说几句。<br>&emsp;&emsp;##对象优先分配在Eden区域，即年轻代<br>&emsp;&emsp;##大对象直接分配在老年代，需要说明的是何为大对象，不同收集器定义的不一样，Serial及ParNew收集器采用参数-XX:PretenureSizeThreshold指定，G1则默认为大于区域region大小一半的对象<br>&emsp;&emsp;##长期存活的对象进入老年代，一般默认为熬过15次年轻代回收的对象，该值可以调整，具体参数名根据收集器的约定而定。另外，如果Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于等于该年龄的对象直接进入老年代（针对Serial及ParNew）<br>&emsp;&emsp;##空间分配担保：只要老年代的连续空间大于新生代对象总大小或历次晋升的平局大小则进行MinorGC，否则进行Full GC（针对Serial及ParNew）<br>&emsp;&emsp;前面大概聊了一下虚拟机内存区域以及java对象本身的那点事，这是一个java开发者必备的基础知识，因为你不仅仅应该知道Object obj = new Object（），你更应该清楚java对象究竟是如何诞生的，JVM在这里面做了什么，另一方面，你还应该清楚JVM又是如何替我们清理那些不再被引用的对象。<br>&emsp;&emsp;首先，我们来简单聊聊垃圾收集算法：<br>&emsp;&emsp;标记-清除（Mark-Sweep）算法：顾名思义，它包含两步，一是标记需要回收的对象，二是清除被标记的对象。但有两个明显的问题是，标记和清除两个环节效率都不高，其次，直接清除会导致内存碎片，这将导致大对象无法找到足够大小的连续空间来分配，从而提前下一次GC。<br>&emsp;&emsp;复制（Copying）算法：将内存划分为几块，当一块内存用完后，把存活的对象移动至另一块，再把当前块已使用的空间一性清理掉。但这会导致预留的那部分空间分配时不能用。如HotSpot实现为，将内存分为Eden和两个Survivor，Eden：Survivro为8：1，即预留了10%的空间。需要指出的是，如果对象生命周期长，那么预留的空间也许会出现不够用，这时便需要其他内存进行分配担保（Handle Promotion），这里指的是老年代内存。因为需要额外的空间做担保，那么此算法不适合老年代回收。<br>&emsp;&emsp;标记-整理（Mark-Compact）算法：完成标记后，让所有存活的对象向一端移动，然后直接清理掉端边界之外的内存。<br>&emsp;&emsp;最后要说明的是，当前的商业虚拟机采用分代收集，即区分新生代和老年代，根据其不同特点搭配不通的垃圾收集算法，如年轻代使用复制算法，老年代使用标记-清除算法或标记-整理算法。<br>&emsp;&emsp;HotSpot实现垃圾回收简介：<br>&emsp;&emsp;##进行对象可达性分析时，要考虑一致性问题，因为对象的引用随着应用线程的运行不停的变更着，因此需要STW，由于STW对应用线程影响很大，各种垃圾回收器中对此做了通盘的考虑，但即使如CMS这种号称不会STW的收集器也无法避免枚举根节点时的GC停顿。另外，HotSpot设计了基于OopMap的数据结构来记录对象的引用以提升效率。<br>&emsp;&emsp;安全点：为指令生产OopMap需要大量额外的空间，因此，HotSpot设计中并没为每条指令生成OopMap，只是在一些成为安全点的特定位置记录这些信息，即，只有当线程进入到安全点时才能暂停下来开始GC。安全点的选定是有讲究的，不可过多也不可过少，所以基本考虑在长时间执行的部分设置安全点，如方法调用、循环跳转、异常跳转等。对于线程在安全点如何停下来的问题，有两种手段，一是抢先式中断、二是主动式中断。HotSpot选择后者，即，GC设置中断标识，用户线程主动轮询是否需要中断，轮询标志的地方和安全点重合。<br>&emsp;&emsp;安全区域：对于某些暂时未分配到CUP时间的线程，如其处于Sleep或Blocked状态，JVM不可能瞎等其得到CPU时间后跑到安全点，因此提供了安全区域解决该问题。安全区域中，引用关系不会发生变化，线程进去安全区域时会标识自己已进入，离开时，需要判断系统是否已经完成了根节点枚举或者整个GC过程，没有完成时需等待接收可以离开的信号。<br>&emsp;&emsp;接下来我们来聊聊HotSpot定义的垃圾回收器，这是一个重要的话题，也是日常开发中我们最直接面对的课题，先上一个总图（这里代表的是jdk11之前的垃圾回收器，因为在jdk11中，oracle推出了号称很强大很强大的ZGC，支持TB级的内存回收及单次GC暂停时间低于10ms，目前未使用到该版本的jdk，也尚未对此回收器做研究）<br><img src=\"\\images\\pasted-80.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Serial收集器：单线程收集器，进行垃圾回收时需暂停其他所有线程，直到收集结束。比较老的收集器了，适用于Client模式的应用。采用复制算法<br><img src=\"\\images\\pasted-82.png\" alt=\"upload successful\"><br>&emsp;&emsp;##ParNew收集器：Serial的多线程版本，默认开启的收集线程数与CPU的数量相同，可通过参数-XX:ParallelGCThreads控制。采用复制算法<br><img src=\"\\images\\pasted-84.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Serial Old收集器：其可作为Serial、ParNew及Parallel Scavenge的老年代收集器，同时，当CMS收集发生Concurrent Model Failure时，会使用Serail Old进行Full GC。采用标记-整理算法<br><img src=\"\\images\\pasted-82.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Parallel Scavenge收集器：更加关注吞吐量，即追求最大吞吐量，适用于那些需要大量计算的应用。使用参数-XX:MaxGCPauseMillis控制停顿时间，参数-XX:GCTimeRatio控制吞吐量（如默认99，即1/（1+99）为GC占CPU时间），开关参数-XX:UseAdaptiveSizePolicy打开后即开启了GC自适应调节策略，无需指定年轻代大小、Survivor大小或晋升老年代对象大小。采用复制算法<br><img src=\"\\images\\pasted-85.png\" alt=\"upload successful\"><br>&emsp;&emsp;##Parallel Old收集器：于jdk1.6开始提供，作为Parallel Scavenge的老年代收集器。采用标记-整理算法<br><img src=\"\\images\\pasted-85.png\" alt=\"upload successful\"><br>&emsp;&emsp;##CMS收集器：更加关注暂停时间，即追求最短暂停时间。其大概包含4个步骤，初始标记、并发标记、重新标记、并发清除，其中，初始标记主要是标记GC Roots能直接关联到的对象，这是一个很快的过程，需要STW，并发标记根据初始标记结果遍历上述对象所引用的对象，这个过程耗时较长但能与用户线程并行执行，重新标记则是修正并发标记过程中用户线程导致的变动，相对并发标记来说耗时是比较短的，需要STW，最后，并发清除也能与用户线程并行执行。需要指出的是，CMS存在一定的缺点，1是其对CPU资源很敏感，比如其并发阶段是占用了CPU资源（即用户线程占用CPU时间会减少），默认线程数为（CPU数量+3）/4；2是其无法处理浮动垃圾（Floating Garbage），导致会出现Concurrent Mode Failure，从而引起Full GC，引起的原因在于并发清理阶段用户线程的运行会产生新的垃圾需下一次GC才可处理，因此CMS开始回收的阈值为默认92%，避免浮动垃圾导致内存不够用而引起Full GC（这时会临时启用Serial Old回收老年代）；3是其基于标记-清除算法，意味着存在内存碎片，那么碎片过多会导致大对象无法分配而导致Full GC，因此有一个开关参数-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理（这是很耗时的）。采用标记-清除算法<br><img src=\"\\images\\pasted-86.png\" alt=\"upload successful\"><br>&emsp;&emsp;##G1收集器：在暂停时间于吞吐量中权衡。采用G1回收器意味着java堆内存布局与其他回收器将有很大的不同，其将堆分成多个（默认2048个）大小相等的region区域（1M-32M）。注意，超过区域大小一半的对象被视为巨型对象直接分配在老年代。同时，G1维护了一个优先列表用于标识回收各区域的价值大小，从而做到了可预测停顿。同时为了避免全堆扫描对象引用，G1提供了Remembered Set用以维护对象的引用。G1回收大致包含如下4个步骤，初始标记、并发标记、最终标记及筛选回收，各步骤的大致功能与CMS类似。整体来看采用标记-整理算法，局部（region之间）来看采用了复制算法。<br><img src=\"\\images\\pasted-87.png\" alt=\"upload successful\"></p>\n<hr>\n<h2 id=\"内存调优\"><a href=\"#内存调优\" class=\"headerlink\" title=\"内存调优\"></a>内存调优</h2><p>&emsp;&emsp;前面已经讲述了对象的诞生与消亡，在实际的工作中，我们日常开发或许并没有过多关注于这些细节，但有一项是我们时常直接接触到的，即，在应用内存使用不正常、应用运行慢时，我们往往会想到是否存在内存使用上的问题，并想办法进行内存调优。内存调优，它没有一个统一的解决方案，只能说其有相同的调优原则，再结合应用的实际情况针对性的优化，因此，要谈内存调优，更好的方式是从案例入手，在案例中阐述问题分析的过程，如何定位到内存上的问题，又如何进行针对性的调优。本博客中有相关案例，可参考<a href=\"https://realxc.github.io/tags/JVM/\">https://realxc.github.io/tags/JVM/</a><br>&emsp;&emsp;作为本篇文章的结尾，下面简单介绍一下我们常用的ParNew、CMS、G1回收器的常用且重要的参数配置：<br>ParNew：<br>&emsp;&emsp;-XX:SurvivorRatio=8(默认)中年代占比1：8 sur：eden<br>&emsp;&emsp;-XX:PretenureSizeThreshold 直接晋升到老年代的对象大小<br>&emsp;&emsp;-XX:NewRatio=4(默认) 年轻代和老年代比例<br>CMS<br>&emsp;&emsp;-XX:CMSInitiatinOccupancyFraction=92 老年代达到92%时回收<br>&emsp;&emsp;-XX:UseCMSCompactAtFullCollection控制其在准备Full GC时进行内存整理<br>&emsp;&emsp;-XX:UseConcMarkSweepGC<br>G1<br>&emsp;&emsp;-XX:+UseG1GC<br>&emsp;&emsp;-XX:MaxGCPauseMillis=n 单次GC暂停时间，默认200ms<br>&emsp;&emsp;-XX:InitiatingHeapOccupancyPercent=n mix gc触发时间，老年代已使用空间占用整堆内存比例，默认45（很多人理解为整堆已使用空间占整堆比例，这是错误的）<br>&emsp;&emsp;-XX:MaxTenuringThreshold=n 年轻代最大年龄，默认15<br>&emsp;&emsp;-XX:G1ReservePercent=n 预留空间大小，避免空间被使用完而导致Full GC<br>&emsp;&emsp;-XX:G1HeapRegionSize=n 区域大小，1-32（M）<br>&emsp;&emsp;-XX:G1NewSizePercent=5 默认为5，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75<br>&emsp;&emsp;-XX:G1MaxNewSizePercent=60 默认为60，如果要调整，需解锁实验性标志 eg：-XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75</p>\n<hr>\n<p>参考参数（jdk8）：<br>(G1): -XX:+UseG1GC -XX:MaxGCPauseMillis=50（自定义） -Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:LargePageSizeInBytes=128m（自定义） -XX:+ParallelRefProcEnabled -XX:+PrintAdaptiveSizePolicy -XX:+UseFastAccessorMethods -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000  -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof</p>\n<hr>\n<p>(CMS):-Xms4096m（自定义） -Xmx4096m（自定义） -XX:MetaspaceSize=128m（自定义） -XX:MaxMetaspaceSize=512m（自定义） -XX:SurvivorRatio=8（自定义） -XX:NewRatio=4（自定义） -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m（自定义） -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70（自定义） -XX:+UseParNewGC -XX:MaxTenuringThreshold=5（自定义） -XX:+CMSClassUnloadingEnabled -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrent -XX:AutoBoxCacheMax=20000 -verbosegc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/XXX/gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/XXX/oom-XX.hprof</p>\n<p><a href=\"https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html\">https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a><br><a href=\"https://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock\">https://www.oracle.com/technetwork/cn/articles/java/g1gc-1984535-zhs.html#Unlock</a></p>\n<hr>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckuhs2vb40009wy66fz6o3rrk","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vba000gwy66bjeb8ylm"},{"post_id":"ckuhs2vay0001wy66b8zvbniv","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbb000kwy661zfvhbol"},{"post_id":"ckuhs2vb5000bwy66ehnrbk49","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbd000nwy66cfzx0pf8"},{"post_id":"ckuhs2vb8000ewy6614uh0b3v","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbd000rwy663i4o1rkg"},{"post_id":"ckuhs2vb00003wy669ky2156z","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbe000twy663q1x9nnt"},{"post_id":"ckuhs2vb9000fwy661czu9e0l","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbg000xwy660ixl5ond"},{"post_id":"ckuhs2vbb000jwy66607f0jdt","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbh000zwy663eoxg9dj"},{"post_id":"ckuhs2vb30007wy660xrfeugb","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbh0012wy66fo5g4elz"},{"post_id":"ckuhs2vbc000mwy669o22duru","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbi0016wy664lna3ipu"},{"post_id":"ckuhs2vbf000wwy66bgdt0i4c","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbk0019wy660avo370f"},{"post_id":"ckuhs2vbg000ywy668qju50s9","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbl001dwy66bl3pe9r7"},{"post_id":"ckuhs2vbd000qwy66dg5c1s4e","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbm001fwy664jtj6cc9"},{"post_id":"ckuhs2vbh0010wy66c9jhhef4","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbn001iwy66e3pxbdao"},{"post_id":"ckuhs2vbi0015wy667eusaz57","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbo001lwy66fcgccw4s"},{"post_id":"ckuhs2vbe000swy66c0cr08ee","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbp001pwy6644l11ec6"},{"post_id":"ckuhs2vbj0018wy66brwt6z0d","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbq001swy66cmeo2ga2"},{"post_id":"ckuhs2vbn001hwy662y0xdlxp","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbr001wwy6656kz8wan"},{"post_id":"ckuhs2vbo001kwy669ja09riq","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbs001ywy66054z8c87"},{"post_id":"ckuhs2vbp001owy66hpg1hz01","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbt0021wy6685dwbx83"},{"post_id":"ckuhs2vbm001ewy663icf48xl","category_id":"ckuhs2vbn001jwy664pb5d105","_id":"ckuhs2vbt0023wy66febqecli"},{"post_id":"ckuhs2vbq001rwy66c1vq5wjg","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbu0027wy666u994rmj"},{"post_id":"ckuhs2vbr001vwy666z7k95kz","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbv002awy66dblkbabj"},{"post_id":"ckuhs2vbr001xwy660vt7hyl8","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbw002ewy663paw76dc"},{"post_id":"ckuhs2vbs0020wy665zzr9grz","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vbw002gwy665a40di7c"},{"post_id":"ckuhs2vbt0022wy66g3tdb61x","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbx002jwy66ccw96anp"},{"post_id":"ckuhs2vbu0026wy66asjwh3gv","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vby002lwy66c7c8acek"},{"post_id":"ckuhs2vbu0029wy66g7li159i","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vby002owy66f4hw949i"},{"post_id":"ckuhs2vbv002dwy662kl38xcm","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vbz002rwy665azj0sme"},{"post_id":"ckuhs2vbx002iwy661mcb4va8","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vc0002vwy661uii8l56"},{"post_id":"ckuhs2vbx002kwy6697983oh7","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vc1002ywy666o833zoi"},{"post_id":"ckuhs2vby002nwy668ya96jf8","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vc20032wy66exsk77yk"},{"post_id":"ckuhs2vbz002qwy665fajg9vh","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vc20036wy660rtz4q8i"},{"post_id":"ckuhs2vc0002xwy66eij320sg","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vc30038wy669fel8dr5"},{"post_id":"ckuhs2vc10031wy66fmhh9wkt","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vc4003bwy66899j1md4"},{"post_id":"ckuhs2vc20035wy663n8k62jg","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vc5003ewy669om904ls"},{"post_id":"ckuhs2vc0002uwy66hsl5drwq","category_id":"ckuhs2vc10030wy663c0qe15n","_id":"ckuhs2vc5003hwy66ehfo6cbi"},{"post_id":"ckuhs2vc30037wy66hzw35uig","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vc5003jwy661rj8ct8w"},{"post_id":"ckuhs2vc3003awy664b7c5e8y","category_id":"ckuhs2vb10004wy665u7ehhiy","_id":"ckuhs2vc6003lwy66bs7w993c"},{"post_id":"ckuhs2vcr006lwy669p2yfht7","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vcu006rwy665r0bdfzc"},{"post_id":"ckuhs2vct006pwy6601zb40cb","category_id":"ckuhs2vbf000uwy660nub1mfb","_id":"ckuhs2vcu006wwy667v2of3yh"},{"post_id":"ckuhs2vcr006kwy664zeoc8r5","category_id":"ckuhs2vcs006mwy66f3giadvp","_id":"ckuhs2vcv006zwy667b5z1atr"},{"post_id":"ckuhs2vct006qwy66bask2cd4","category_id":"ckuhs2vc10030wy663c0qe15n","_id":"ckuhs2vcv0070wy662rnmfih3"},{"post_id":"ckuhs2vcs006owy66d34k6y99","category_id":"ckuhs2vcu006swy66elc39vzc","_id":"ckuhs2vcv0072wy66g68za3k2"}],"PostTag":[{"post_id":"ckuhs2vay0001wy66b8zvbniv","tag_id":"ckuhs2vb20005wy6607o009iz","_id":"ckuhs2vbb000lwy66c3zzf1rf"},{"post_id":"ckuhs2vay0001wy66b8zvbniv","tag_id":"ckuhs2vb6000dwy665c6i1n5a","_id":"ckuhs2vbd000owy662dmpf18t"},{"post_id":"ckuhs2vb00003wy669ky2156z","tag_id":"ckuhs2vba000iwy669m1k7tzj","_id":"ckuhs2vbi0014wy6623lp6lmy"},{"post_id":"ckuhs2vb00003wy669ky2156z","tag_id":"ckuhs2vbd000pwy66dq65ho7g","_id":"ckuhs2vbj0017wy669us2cxn2"},{"post_id":"ckuhs2vb00003wy669ky2156z","tag_id":"ckuhs2vbf000vwy665hodaypc","_id":"ckuhs2vbl001bwy66328l7kv6"},{"post_id":"ckuhs2vb30007wy660xrfeugb","tag_id":"ckuhs2vba000iwy669m1k7tzj","_id":"ckuhs2vbp001nwy66c61l24da"},{"post_id":"ckuhs2vb30007wy660xrfeugb","tag_id":"ckuhs2vbd000pwy66dq65ho7g","_id":"ckuhs2vbq001qwy66hvj98ymo"},{"post_id":"ckuhs2vb30007wy660xrfeugb","tag_id":"ckuhs2vbf000vwy665hodaypc","_id":"ckuhs2vbr001uwy66g06j81lm"},{"post_id":"ckuhs2vb40009wy66fz6o3rrk","tag_id":"ckuhs2vba000iwy669m1k7tzj","_id":"ckuhs2vbu0025wy665iaiej9f"},{"post_id":"ckuhs2vb40009wy66fz6o3rrk","tag_id":"ckuhs2vbd000pwy66dq65ho7g","_id":"ckuhs2vbu0028wy66aelmaym7"},{"post_id":"ckuhs2vb40009wy66fz6o3rrk","tag_id":"ckuhs2vbf000vwy665hodaypc","_id":"ckuhs2vbv002cwy6670k96c9v"},{"post_id":"ckuhs2vb5000bwy66ehnrbk49","tag_id":"ckuhs2vbt0024wy662uaygggo","_id":"ckuhs2vbz002pwy660zj1g1o6"},{"post_id":"ckuhs2vb5000bwy66ehnrbk49","tag_id":"ckuhs2vbv002bwy661q3jefk8","_id":"ckuhs2vbz002swy66ej4u0viw"},{"post_id":"ckuhs2vb5000bwy66ehnrbk49","tag_id":"ckuhs2vbw002hwy6673u0gkzx","_id":"ckuhs2vc0002wwy66a63kbqnw"},{"post_id":"ckuhs2vb8000ewy6614uh0b3v","tag_id":"ckuhs2vbd000pwy66dq65ho7g","_id":"ckuhs2vc1002zwy663t1o5qw1"},{"post_id":"ckuhs2vb8000ewy6614uh0b3v","tag_id":"ckuhs2vb20005wy6607o009iz","_id":"ckuhs2vc20034wy662elyer4o"},{"post_id":"ckuhs2vb9000fwy661czu9e0l","tag_id":"ckuhs2vbz002twy66d5v8g74q","_id":"ckuhs2vc4003cwy66gtja5h8p"},{"post_id":"ckuhs2vb9000fwy661czu9e0l","tag_id":"ckuhs2vc20033wy662msxfryf","_id":"ckuhs2vc5003fwy662lz64oji"},{"post_id":"ckuhs2vbb000jwy66607f0jdt","tag_id":"ckuhs2vc30039wy66ffwg6l28","_id":"ckuhs2vc5003iwy66fwr75hjb"},{"post_id":"ckuhs2vbc000mwy669o22duru","tag_id":"ckuhs2vc5003gwy66e0n837s4","_id":"ckuhs2vc6003owy660z8uey8s"},{"post_id":"ckuhs2vbc000mwy669o22duru","tag_id":"ckuhs2vc5003kwy6629f61f3b","_id":"ckuhs2vc6003pwy66ft8h07pq"},{"post_id":"ckuhs2vbc000mwy669o22duru","tag_id":"ckuhs2vc6003mwy66fdbo3ez0","_id":"ckuhs2vc7003rwy669fvxel79"},{"post_id":"ckuhs2vbd000qwy66dg5c1s4e","tag_id":"ckuhs2vc6003mwy66fdbo3ez0","_id":"ckuhs2vc7003twy666ofkbffj"},{"post_id":"ckuhs2vbd000qwy66dg5c1s4e","tag_id":"ckuhs2vc6003qwy665byq0far","_id":"ckuhs2vc7003uwy665dz86677"},{"post_id":"ckuhs2vbe000swy66c0cr08ee","tag_id":"ckuhs2vc7003swy66ghljhl1j","_id":"ckuhs2vc8003ywy662dbpf9zw"},{"post_id":"ckuhs2vbe000swy66c0cr08ee","tag_id":"ckuhs2vc7003vwy66cs1ahbsu","_id":"ckuhs2vc8003zwy660nouau4d"},{"post_id":"ckuhs2vbe000swy66c0cr08ee","tag_id":"ckuhs2vc7003wwy66588idk9n","_id":"ckuhs2vc80041wy66h15k1q43"},{"post_id":"ckuhs2vbf000wwy66bgdt0i4c","tag_id":"ckuhs2vc7003swy66ghljhl1j","_id":"ckuhs2vc80043wy66341i3x64"},{"post_id":"ckuhs2vbf000wwy66bgdt0i4c","tag_id":"ckuhs2vc80040wy6690vz5gny","_id":"ckuhs2vc90044wy66gzlsae9k"},{"post_id":"ckuhs2vbg000ywy668qju50s9","tag_id":"ckuhs2vc7003swy66ghljhl1j","_id":"ckuhs2vc90047wy661gyeem4j"},{"post_id":"ckuhs2vbg000ywy668qju50s9","tag_id":"ckuhs2vc7003vwy66cs1ahbsu","_id":"ckuhs2vc90048wy66dfmm3s5t"},{"post_id":"ckuhs2vbh0010wy66c9jhhef4","tag_id":"ckuhs2vc90046wy66bukacpdo","_id":"ckuhs2vca004bwy6686py1xlj"},{"post_id":"ckuhs2vbh0010wy66c9jhhef4","tag_id":"ckuhs2vc90049wy66h3091y83","_id":"ckuhs2vca004cwy661qjseilg"},{"post_id":"ckuhs2vbj0018wy66brwt6z0d","tag_id":"ckuhs2vc9004awy66hbxq4jvg","_id":"ckuhs2vca004fwy669v9h5hs2"},{"post_id":"ckuhs2vbj0018wy66brwt6z0d","tag_id":"ckuhs2vca004dwy662hyo632d","_id":"ckuhs2vca004gwy668gmddthk"},{"post_id":"ckuhs2vbl001cwy66d5s91q5r","tag_id":"ckuhs2vca004ewy668kdz84aj","_id":"ckuhs2vca004iwy660b63hk5x"},{"post_id":"ckuhs2vbm001ewy663icf48xl","tag_id":"ckuhs2vca004hwy6697safucv","_id":"ckuhs2vcb004kwy66bh6h12dp"},{"post_id":"ckuhs2vbn001hwy662y0xdlxp","tag_id":"ckuhs2vca004jwy66h03h9e3h","_id":"ckuhs2vcb004nwy66efdwehfp"},{"post_id":"ckuhs2vbn001hwy662y0xdlxp","tag_id":"ckuhs2vcb004lwy66fyyl5dsm","_id":"ckuhs2vcb004owy661vl11caf"},{"post_id":"ckuhs2vbo001kwy669ja09riq","tag_id":"ckuhs2vca004jwy66h03h9e3h","_id":"ckuhs2vcd004swy6699he16a7"},{"post_id":"ckuhs2vbo001kwy669ja09riq","tag_id":"ckuhs2vcb004pwy665rjnbrct","_id":"ckuhs2vcd004twy66g40g5e8v"},{"post_id":"ckuhs2vbo001kwy669ja09riq","tag_id":"ckuhs2vcc004qwy668eoebvvo","_id":"ckuhs2vcd004vwy662gx16htf"},{"post_id":"ckuhs2vbp001owy66hpg1hz01","tag_id":"ckuhs2vcd004rwy666892077i","_id":"ckuhs2vce004xwy66g57shw23"},{"post_id":"ckuhs2vbp001owy66hpg1hz01","tag_id":"ckuhs2vcd004uwy667hy0cfdc","_id":"ckuhs2vce004ywy66ets8gt47"},{"post_id":"ckuhs2vbq001rwy66c1vq5wjg","tag_id":"ckuhs2vcd004wwy66eb8ua27b","_id":"ckuhs2vce0050wy66hrlz9yd0"},{"post_id":"ckuhs2vbr001vwy666z7k95kz","tag_id":"ckuhs2vcd004wwy66eb8ua27b","_id":"ckuhs2vcf0052wy6612qb10oh"},{"post_id":"ckuhs2vbr001xwy660vt7hyl8","tag_id":"ckuhs2vcd004wwy66eb8ua27b","_id":"ckuhs2vcf0054wy66b1dbh20h"},{"post_id":"ckuhs2vbs0020wy665zzr9grz","tag_id":"ckuhs2vcd004wwy66eb8ua27b","_id":"ckuhs2vcg0057wy66ge5i9ffp"},{"post_id":"ckuhs2vbs0020wy665zzr9grz","tag_id":"ckuhs2vcf0055wy668vyl74oc","_id":"ckuhs2vcg0058wy66b1oiha55"},{"post_id":"ckuhs2vbt0022wy66g3tdb61x","tag_id":"ckuhs2vc5003kwy6629f61f3b","_id":"ckuhs2vcg005bwy66ga4aecid"},{"post_id":"ckuhs2vbt0022wy66g3tdb61x","tag_id":"ckuhs2vcg0059wy660dschg1n","_id":"ckuhs2vcg005cwy66251p9lyy"},{"post_id":"ckuhs2vbu0026wy66asjwh3gv","tag_id":"ckuhs2vcg005awy66cnml9txb","_id":"ckuhs2vch005fwy660ozpa2aw"},{"post_id":"ckuhs2vbu0026wy66asjwh3gv","tag_id":"ckuhs2vc5003kwy6629f61f3b","_id":"ckuhs2vch005gwy66c4pweow0"},{"post_id":"ckuhs2vbu0029wy66g7li159i","tag_id":"ckuhs2vcg005awy66cnml9txb","_id":"ckuhs2vci005jwy6624dpc02a"},{"post_id":"ckuhs2vbu0029wy66g7li159i","tag_id":"ckuhs2vc6003qwy665byq0far","_id":"ckuhs2vci005kwy666ehrccet"},{"post_id":"ckuhs2vbv002dwy662kl38xcm","tag_id":"ckuhs2vch005iwy66fwtqa2a2","_id":"ckuhs2vci005nwy660es5h0m4"},{"post_id":"ckuhs2vbv002dwy662kl38xcm","tag_id":"ckuhs2vci005lwy66125k1o5v","_id":"ckuhs2vci005owy66ga9l9py7"},{"post_id":"ckuhs2vbx002iwy661mcb4va8","tag_id":"ckuhs2vci005mwy664hls1un3","_id":"ckuhs2vcj005swy66e1fldr03"},{"post_id":"ckuhs2vbx002iwy661mcb4va8","tag_id":"ckuhs2vci005pwy66fkbmfv4r","_id":"ckuhs2vcj005twy66h9gy6js5"},{"post_id":"ckuhs2vbx002iwy661mcb4va8","tag_id":"ckuhs2vcj005qwy666hlx009t","_id":"ckuhs2vcj005vwy66ch6kch7p"},{"post_id":"ckuhs2vbx002kwy6697983oh7","tag_id":"ckuhs2vcj005rwy669p77gttz","_id":"ckuhs2vcj005wwy6664jw1fix"},{"post_id":"ckuhs2vby002nwy668ya96jf8","tag_id":"ckuhs2vc80040wy6690vz5gny","_id":"ckuhs2vck005ywy66clg78xh3"},{"post_id":"ckuhs2vbz002qwy665fajg9vh","tag_id":"ckuhs2vca004jwy66h03h9e3h","_id":"ckuhs2vcl0062wy663l2v3uh1"},{"post_id":"ckuhs2vbz002qwy665fajg9vh","tag_id":"ckuhs2vck005zwy66amhp8cvw","_id":"ckuhs2vcl0063wy665vflh7ql"},{"post_id":"ckuhs2vbz002qwy665fajg9vh","tag_id":"ckuhs2vck0060wy66094e22g3","_id":"ckuhs2vcl0065wy66ewmdczj8"},{"post_id":"ckuhs2vc0002uwy66hsl5drwq","tag_id":"ckuhs2vc7003swy66ghljhl1j","_id":"ckuhs2vcl0067wy66chw834jl"},{"post_id":"ckuhs2vc0002uwy66hsl5drwq","tag_id":"ckuhs2vcl0064wy664h5udj4f","_id":"ckuhs2vcl0068wy663wd4060c"},{"post_id":"ckuhs2vc0002xwy66eij320sg","tag_id":"ckuhs2vcl0066wy66982ka9z0","_id":"ckuhs2vcm006bwy66494o5gwl"},{"post_id":"ckuhs2vc0002xwy66eij320sg","tag_id":"ckuhs2vcl0069wy665vqxd4rg","_id":"ckuhs2vcm006cwy669q9vc0dl"},{"post_id":"ckuhs2vc10031wy66fmhh9wkt","tag_id":"ckuhs2vcm006awy664ugjcu4a","_id":"ckuhs2vcm006ewy668tzeam1y"},{"post_id":"ckuhs2vc20035wy663n8k62jg","tag_id":"ckuhs2vc5003kwy6629f61f3b","_id":"ckuhs2vcn006gwy66g1cp0j2h"},{"post_id":"ckuhs2vc30037wy66hzw35uig","tag_id":"ckuhs2vcm006fwy6659md295m","_id":"ckuhs2vcn006iwy66ba997r7t"},{"post_id":"ckuhs2vc3003awy664b7c5e8y","tag_id":"ckuhs2vcn006hwy6647w3eak4","_id":"ckuhs2vcn006jwy66d64e0513"},{"post_id":"ckuhs2vct006pwy6601zb40cb","tag_id":"ckuhs2vc5003kwy6629f61f3b","_id":"ckuhs2vcu006uwy6652ei48fy"},{"post_id":"ckuhs2vcr006kwy664zeoc8r5","tag_id":"ckuhs2vb6000dwy665c6i1n5a","_id":"ckuhs2vcu006vwy6602ll7z8l"},{"post_id":"ckuhs2vcr006kwy664zeoc8r5","tag_id":"ckuhs2vcs006nwy66cacfdprz","_id":"ckuhs2vcu006ywy666q8b96yy"},{"post_id":"ckuhs2vcr006lwy669p2yfht7","tag_id":"ckuhs2vcu006twy66fhcfgs8j","_id":"ckuhs2vcv0073wy66ged036j7"},{"post_id":"ckuhs2vcr006lwy669p2yfht7","tag_id":"ckuhs2vcu006xwy66h81gbakr","_id":"ckuhs2vcv0074wy66cg2n1nge"},{"post_id":"ckuhs2vct006qwy66bask2cd4","tag_id":"ckuhs2vbd000pwy66dq65ho7g","_id":"ckuhs2vcv0076wy66c73u6urc"},{"post_id":"ckuhs2vct006qwy66bask2cd4","tag_id":"ckuhs2vcv0071wy669j0u0lct","_id":"ckuhs2vcv0077wy662grlcd9g"},{"post_id":"ckuhs2vct006qwy66bask2cd4","tag_id":"ckuhs2vcb004lwy66fyyl5dsm","_id":"ckuhs2vcv0078wy66g0pgeydl"},{"post_id":"ckuhs2vct006qwy66bask2cd4","tag_id":"ckuhs2vcv0075wy6672l352se","_id":"ckuhs2vcv0079wy66awvofa9g"}],"Tag":[{"name":"类加载","_id":"ckuhs2vb20005wy6607o009iz"},{"name":"javaagent","_id":"ckuhs2vb6000dwy665c6i1n5a"},{"name":"GC-G1","_id":"ckuhs2vba000iwy669m1k7tzj"},{"name":"JVM","_id":"ckuhs2vbd000pwy66dq65ho7g"},{"name":"GC","_id":"ckuhs2vbf000vwy665hodaypc"},{"name":"HttpURLConnection","_id":"ckuhs2vbt0024wy662uaygggo"},{"name":"HttpRequestMethodNotSupportedException","_id":"ckuhs2vbv002bwy661q3jefk8"},{"name":"post/get请求","_id":"ckuhs2vbw002hwy6673u0gkzx"},{"name":"NoClassDefFoundError","_id":"ckuhs2vbz002twy66d5v8g74q"},{"name":"类加载异常","_id":"ckuhs2vc20033wy662msxfryf"},{"name":"disruptor","_id":"ckuhs2vc30039wy66ffwg6l28"},{"name":"数据库连接池","_id":"ckuhs2vc5003gwy66e0n837s4"},{"name":"db","_id":"ckuhs2vc5003kwy6629f61f3b"},{"name":"druid","_id":"ckuhs2vc6003mwy66fdbo3ez0"},{"name":"连接池","_id":"ckuhs2vc6003qwy665byq0far"},{"name":"dubbo","_id":"ckuhs2vc7003swy66ghljhl1j"},{"name":"序列化","_id":"ckuhs2vc7003vwy66cs1ahbsu"},{"name":"hessian","_id":"ckuhs2vc7003wwy66588idk9n"},{"name":"zookeeper","_id":"ckuhs2vc80040wy6690vz5gny"},{"name":"elk","_id":"ckuhs2vc90046wy66bukacpdo"},{"name":"集群","_id":"ckuhs2vc90049wy66h3091y83"},{"name":"git","_id":"ckuhs2vc9004awy66hbxq4jvg"},{"name":"版本控制","_id":"ckuhs2vca004dwy662hyo632d"},{"name":"grafana","_id":"ckuhs2vca004ewy668kdz84aj"},{"name":"hexo","_id":"ckuhs2vca004hwy6697safucv"},{"name":"java","_id":"ckuhs2vca004jwy66h03h9e3h"},{"name":"java对象","_id":"ckuhs2vcb004lwy66fyyl5dsm"},{"name":"jdk8","_id":"ckuhs2vcb004pwy665rjnbrct"},{"name":"dump","_id":"ckuhs2vcc004qwy668eoebvvo"},{"name":"linux","_id":"ckuhs2vcd004rwy666892077i"},{"name":"tail","_id":"ckuhs2vcd004uwy667hy0cfdc"},{"name":"maven","_id":"ckuhs2vcd004wwy66eb8ua27b"},{"name":"jdk","_id":"ckuhs2vcf0055wy668vyl74oc"},{"name":"mongo","_id":"ckuhs2vcg0059wy660dschg1n"},{"name":"mysql","_id":"ckuhs2vcg005awy66cnml9txb"},{"name":"rabbitmq","_id":"ckuhs2vch005iwy66fwtqa2a2"},{"name":"消息队列","_id":"ckuhs2vci005lwy66125k1o5v"},{"name":"spring","_id":"ckuhs2vci005mwy664hls1un3"},{"name":"springboot","_id":"ckuhs2vci005pwy66fkbmfv4r"},{"name":"应用监控检查","_id":"ckuhs2vcj005qwy666hlx009t"},{"name":"struts2","_id":"ckuhs2vcj005rwy669p77gttz"},{"name":"内存泄漏","_id":"ckuhs2vck005zwy66amhp8cvw"},{"name":"mat","_id":"ckuhs2vck0060wy66094e22g3"},{"name":"微服务","_id":"ckuhs2vcl0064wy664h5udj4f"},{"name":"图片压缩","_id":"ckuhs2vcl0066wy66982ka9z0"},{"name":"ImageIO","_id":"ckuhs2vcl0069wy665vqxd4rg"},{"name":"优雅停机","_id":"ckuhs2vcm006awy664ugjcu4a"},{"name":"浏览器","_id":"ckuhs2vcm006fwy6659md295m"},{"name":"架构","_id":"ckuhs2vcn006hwy6647w3eak4"},{"name":"bytebuddy","_id":"ckuhs2vcs006nwy66cacfdprz"},{"name":"spring-boot","_id":"ckuhs2vcu006twy66fhcfgs8j"},{"name":"jsp","_id":"ckuhs2vcu006xwy66h81gbakr"},{"name":"内存调优","_id":"ckuhs2vcv0071wy669j0u0lct"},{"name":"垃圾回收","_id":"ckuhs2vcv0075wy6672l352se"}]}}